"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Raycast=void 0;const cc_1=require("cc"),intersect_1=__importDefault(require("./geom-utils/intersect")),recycle_pool_1=require("./memop/recycle-pool"),ray=cc_1.geometry.Ray,AABB=cc_1.geometry.AABB,triangle=cc_1.geometry.Triangle,testHitPoint=new cc_1.Vec3,hitPoint=new cc_1.Vec3,worldM4=new cc_1.Mat4,inverseM4=new cc_1.Mat4;class Raycast{get rayResultCanvas(){return resultCanvas}get rayResultModels(){return resultModels}get rayResultAll(){return resultAll}get rayResultSingleModel(){return resultSingleModel}get raycastColliderResults(){return raycastColliderResults}raycastAll(e,t,r=cc_1.Layers.Enum.DEFAULT|cc_1.Layers.Enum.UI_2D|cc_1.Layers.Enum.IGNORE_RAYCAST,a=1/0,l=!1,c){e=this.raycastAllModels(e,t,r,a,l,c),l=this.raycastAllCanvas(t,r,a,c),t=e||l;return resultAll.length=0,t&&(Array.prototype.push.apply(resultAll,resultModels),Array.prototype.push.apply(resultAll,resultCanvas)),t}narrowPhaseStep(t,r,a,l,e=!1){var c=t["transform"],o=e?narrowphaseForSnap:narrowphase;if(t.type===cc_1.renderer.scene.ModelType.DEFAULT){c.getWorldMatrix(worldM4),cc_1.Mat4.invert(m4,c.getWorldMatrix(m4)),cc_1.Vec3.transformMat4(modelRay.o,r.o,m4),cc_1.Vec3.normalize(modelRay.d,cc_1.Vec3.transformMat4Normal(modelRay.d,r.d,m4)),l=1/0;for(let e=0;e<t.subModels.length;++e){var s,n,i,d=t.subModels[e].subMesh;d&&d.geometricInfo&&({positions:i,indices:s,doubleSided:n}=d.geometricInfo,o(i,s,d.primitiveMode,!!n,a,testHitPoint),narrowDis<l)&&(cc_1.Vec3.transformMat4(testHitPoint,testHitPoint,worldM4),(i=cc_1.Vec3.distance(r.o,testHitPoint))<l)&&(l=i,hitPoint.set(testHitPoint))}}return l}raycastAllModels(e,l,t=cc_1.Layers.Enum.DEFAULT,c=1/0,o,r){pool.reset();var a=[];for(const d of e.models){var s=d.transform;e.isCulledByLod(cce.Camera.camera.camera,d)||r&&d.node.layer&r||s&&d.enabled&&d.node.layer&t&&d.worldBounds&&((s=intersect_1.default.ray_aabb(l,d.worldBounds))<=0||c<=s||a.push([d,s]))}a.sort((e,t)=>e[1]-t[1]);let n=Number.MAX_VALUE,i=0;return a.every((e,t)=>{var r,a=e[0],e=e[1];return!(o&&n<=e&&1<i||((e=this.narrowPhaseStep(a,l,c,e,!0))<c&&((r=pool.add()).node=a.node,r.distance=e,r.hitPoint=new cc_1.Vec3(hitPoint),resultModels[pool.length-1]=r,n=e,i+=1),0))}),resultModels.length=pool.length,0<resultModels.length}raycastSingleModel(e,t,r=cc_1.Layers.Enum.DEFAULT,a=1/0,l,c){pool.reset();return!(!(t.transform&&t.enabled&&t.node.layer&r&&t.worldBounds)||c&&c&t.node.layer||(r=intersect_1.default.ray_aabb(e,t.worldBounds))<=0||a<=r)&&((r=this.narrowPhaseStep(t,e,a,r,l))<a&&((c=pool.add()).node=t.node,c.distance=r,c.hitPoint=new cc_1.Vec3(hitPoint),resultSingleModel[pool.length-1]=c),resultSingleModel.length=pool.length,0<resultSingleModel.length)}raycastAllCanvas(t,r=cc_1.Layers.Enum.UI_2D,a=1/0,l){poolUI.reset();var c=cc.director.getScene().getComponentsInChildren(cc.Canvas);if(c&&0<c.length)for(let e=c.length-1;0<=e;e--){var o=c[e].node;o&&o.active&&this._raycastUI2DNodeRecursiveChildren(t,o,r,a,l)}return resultCanvas.length=poolUI.length,0<resultCanvas.length}raycastAllColliders(e,t=cc_1.Layers.Enum.DEFAULT){return!!cc_1.PhysicsSystem.instance.raycast(e,void 0,void 0,!1)&&(raycastColliderResults=cc_1.PhysicsSystem.instance.raycastResults,!0)}_raycastUI2DNode(e,t,r=cc_1.Layers.Enum.UI_2D,a=1/0,l){var c=t._uiProps.uiTransformComp;if(!c||!(t.layer&r)||l&&t.layer&l)return null;c.getComputeAABB(aabbUI);r=intersect_1.default.ray_aabb(e,aabbUI);return!(r<=0)&&r<a?((l=poolUI.add()).node=t,l.distance=r,l):null}_raycastUI2DNodeRecursiveChildren(t,r,a=cc_1.Layers.Enum.UI_2D,l=1/0,c){for(let e=r.children.length-1;0<=e;e--){var o=r.children[e];o&&o.active&&this._raycastUI2DNodeRecursiveChildren(t,o,a,l,c)}var e=this._raycastUI2DNode(t,r,a,l,c);e&&(resultCanvas[poolUI.length-1]=e)}}exports.Raycast=Raycast;const modelRay=ray.create(),v3=new cc_1.Vec3,m4=new cc_1.Mat4;let narrowDis=1/0;const tri=triangle.create(),tempVec3_a=new cc_1.Vec3,tempVec3_b=new cc_1.Vec3,defaultNode=new cc_1.Node,pool=new recycle_pool_1.RecyclePool(()=>({node:defaultNode,distance:1/0,hitPoint:new cc_1.Vec3}),8),resultModels=[],aabbUI=new AABB,poolUI=new recycle_pool_1.RecyclePool(()=>({node:defaultNode,distance:1/0,hitPoint:new cc_1.Vec3}),8),resultCanvas=[],resultAll=[],resultSingleModel=[];let raycastColliderResults=[];const narrowphase=(r,a,e,l,t=1/0,c)=>{if(narrowDis=t,a||(t=r.length/3,a=new Uint32Array([...Array(t).keys()])),e===cc_1.gfx.PrimitiveMode.TRIANGLE_LIST){var o=a.length;for(let e=0;e<o;e+=3){var s=3*a[e],n=3*a[e+1],i=3*a[e+2],s=(cc_1.Vec3.set(tri.a,r[s],r[1+s],r[2+s]),cc_1.Vec3.set(tri.b,r[n],r[1+n],r[2+n]),cc_1.Vec3.set(tri.c,r[i],r[1+i],r[2+i]),intersect_1.default.ray_triangle(modelRay,tri,l,c));s<=0||s>=narrowDis||(narrowDis=s)}}else if(e===cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP){var d=a.length-2;let t=0;for(let e=0;e<d;e+=1){var _=3*a[e-t],u=3*a[e+t+1],y=3*a[e+2],_=(cc_1.Vec3.set(tri.a,r[_],r[1+_],r[2+_]),cc_1.Vec3.set(tri.b,r[u],r[1+u],r[2+u]),cc_1.Vec3.set(tri.c,r[y],r[1+y],r[2+y]),t=~t,intersect_1.default.ray_triangle(modelRay,tri,l,c));_<=0||_>=narrowDis||(narrowDis=_)}}else if(e===cc_1.gfx.PrimitiveMode.TRIANGLE_FAN){var m=a.length-1,t=3*a[0];cc_1.Vec3.set(tri.a,r[t],r[1+t],r[2+t]);for(let e=1;e<m;e+=1){var g=3*a[e],h=3*a[e+1],g=(cc_1.Vec3.set(tri.b,r[g],r[1+g],r[2+g]),cc_1.Vec3.set(tri.c,r[h],r[1+h],r[2+h]),intersect_1.default.ray_triangle(modelRay,tri,l,c));g<=0||g>=narrowDis||(narrowDis=g)}}else if(e===cc_1.gfx.PrimitiveMode.LINE_LIST){var p=a.length;for(let e=0;e<p;e+=2){var f=3*a[e],v=3*a[e+1],f=(cc_1.Vec3.set(tempVec3_a,r[f],r[1+f],r[2+f]),cc_1.Vec3.set(tempVec3_b,r[v],r[1+v],r[2+v]),intersect_1.default.ray_segment(modelRay,tempVec3_a,tempVec3_b,2,c));f<=0||f>=narrowDis||(narrowDis=f)}}},narrowphaseForSnap=(r,a,e,l,t=1/0,c)=>{narrowDis=t,a||(t=r.length/3,a=new Uint32Array([...Array(t).keys()]));let o,s,n;var i=tri.a,d=tri.b,_=tri.c;let u;var y=cc_1.Vec3.fromArray;if(e===cc_1.gfx.PrimitiveMode.TRIANGLE_LIST){var m=a.length,g=3e6<a.length?3*Math.floor(a.length/3e6):3;for(let e=0;e<m;e+=g)o=3*a[e],s=3*a[e+1],n=3*a[e+2],y(i,r,o),y(d,r,s),y(_,r,n),(u=intersect_1.default.ray_triangle(modelRay,tri,l,c))<=0||u>=narrowDis||(narrowDis=u)}else if(e===cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP){var h=a.length-2;let t=0;for(let e=0;e<h;e+=1)o=3*a[e-t],s=3*a[e+t+1],n=3*a[e+2],y(tri.a,r,o),y(tri.b,r,s),y(tri.c,r,n),t=~t,(u=intersect_1.default.ray_triangle(modelRay,tri,l,c))<=0||u>=narrowDis||(narrowDis=u)}else if(e===cc_1.gfx.PrimitiveMode.TRIANGLE_FAN){var p=a.length-1;o=3*a[0],cc_1.Vec3.set(tri.a,r[o],r[o+1],r[o+2]);for(let e=1;e<p;e+=1)s=3*a[e],n=3*a[e+1],y(d,r,s),y(_,r,n),(u=intersect_1.default.ray_triangle(modelRay,tri,l,c))<=0||u>=narrowDis||(narrowDis=u)}else if(e===cc_1.gfx.PrimitiveMode.LINE_LIST){var f=a.length;for(let e=0;e<f;e+=2)o=3*a[e],s=3*a[e+1],y(tempVec3_a,r,o),y(tempVec3_b,r,s),(u=intersect_1.default.ray_segment(modelRay,tempVec3_a,tempVec3_b,2,c))<=0||u>=narrowDis||(narrowDis=u)}};exports.default=new Raycast;