"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.saveDataToImage=exports.flipImage=exports.readPixels=void 0;const cc_1=require("cc"),fs_extra_1=require("fs-extra"),sharp_1=__importDefault(require("sharp")),misc_1=require("./misc");function readPixels(e){var t,r,a,s,i=e.width,n=e.height,i=new Uint8Array(4*i*n),n=e.getGFXTexture();return n?(t=cc_1.gfx.deviceManager.gfxDevice,r=[],a=[],(s=new cc_1.gfx.BufferTextureCopy).texOffset.x=0,s.texOffset.y=0,s.texExtent.width=e.width,s.texExtent.height=e.height,a.push(s),r.push(i),null!=t&&t.copyTextureToBuffers(n,r,a),i):null}function flipImage(r,a,s){if(!r)return null;var i=new Uint8Array(r.length);for(let t=0;t<s;t++)for(let e=0;e<a;e++){var n=4*(a*t+e),u=4*(a*(s-t-1)+e);i[u]=r[n],i[1+u]=r[1+n],i[2+u]=r[2+n],i[3+u]=r[3+n]}return i}async function saveDataToImage(a,s,i,n,u){let o;await new Promise(async(e,t)=>{var r=await Editor.Message.request("asset-db","query-path","db://assets");null!==r&&(r=(0,misc_1.join)(r,n),(0,fs_extra_1.existsSync)(r)||(0,fs_extra_1.mkdirSync)(r),o=(0,misc_1.join)(r,u),(0,sharp_1.default)(a,{raw:{width:s,height:i,channels:4}}).toFile(o).then(async()=>{e()}).catch(e=>{t(e)}))})}exports.readPixels=readPixels,exports.flipImage=flipImage,exports.saveDataToImage=saveDataToImage;