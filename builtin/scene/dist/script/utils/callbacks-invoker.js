"use strict";var __importDefault=this&&this.__importDefault||function(l){return l&&l.__esModule?l:{default:l}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CallbacksInvoker=void 0;const createMap=cc.js.createMap,fastRemoveAt=cc.js.array.fastRemoveAt,pool_1=__importDefault(require("./pool"));function empty(){}class CallbackInfo{constructor(){this.callback=empty,this.target=void 0,this.once=!1}set(l,a,e,c){this.callback=l,this.target=a,this.once=!!e,this.off=c}}const callbackInfoPool=new pool_1.default(()=>new CallbackInfo,32);class CallbackList{constructor(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}removeByCallback(a){for(let l=0;l<this.callbackInfos.length;++l){var e=this.callbackInfos[l];e&&e.callback===a&&(callbackInfoPool.free(e),fastRemoveAt(this.callbackInfos,l),--l)}}removeByTarget(a){for(let l=0;l<this.callbackInfos.length;++l){var e=this.callbackInfos[l];e&&e.target===a&&(callbackInfoPool.free(e),fastRemoveAt(this.callbackInfos,l),--l)}}cancel(l){var a=this.callbackInfos[l];a&&(callbackInfoPool.free(a),this.callbackInfos[l]=null),this.containCanceled=!0}cancelAll(){for(let l=0;l<this.callbackInfos.length;l++){var a=this.callbackInfos[l];a&&(callbackInfoPool.free(a),this.callbackInfos[l]=null)}this.containCanceled=!0}purgeCanceled(){for(let l=this.callbackInfos.length-1;0<=l;--l)this.callbackInfos[l]||fastRemoveAt(this.callbackInfos,l);this.containCanceled=!1}clear(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}const MAX_SIZE=16,callbackListPool=new pool_1.default(()=>new CallbackList,MAX_SIZE);class CallbacksInvoker{constructor(){this._callbackTable=createMap(!0)}on(l,a,e,c){let t=this._callbackTable[l];t=t||(this._callbackTable[l]=callbackListPool.alloc());l=callbackInfoPool.alloc();l.set(a,e,c),t.callbackInfos.push(l)}hasEventListener(l,a,e){l=this._callbackTable[l];if(l){var c=l.callbackInfos;if(!a){if(l.isInvoking){for(const o of c)if(o)return!0;return!1}return 0<c.length}for(let l=0;l<c.length;++l){var t=c[l];if(t&&t.callback===a&&t.target===e)return!0}}return!1}removeAll(a){if("string"==typeof a){var l=this._callbackTable[a];l&&(l.isInvoking?l.cancelAll():(l.clear(),callbackListPool.free(l),delete this._callbackTable[a]))}else if(a)for(const o in this._callbackTable){var e=this._callbackTable[o];if(e.isInvoking){var c=e.callbackInfos;for(let l=0;l<c.length;++l){var t=c[l];t&&t.target===a&&e.cancel(l)}}else e.removeByTarget(a)}}removeAllListeners(){Object.keys(this._callbackTable).forEach(l=>{this.removeAll(l)})}off(l,a,e){var c=this._callbackTable[l];if(c){var t=c.callbackInfos;if(a)for(let l=0;l<t.length;++l){var o=t[l];if(o&&o.callback===a&&o.target===e){c.isInvoking?c.cancel(l):(fastRemoveAt(t,l),callbackInfoPool.free(o));break}}else this.removeAll(l)}}emit(e,...c){var l=this._callbackTable[e];if(l){var a=!l.isInvoking,t=(l.isInvoking=!0,l.callbackInfos);for(let l=0,a=t.length;l<a;++l){var o,s,n=t[l];n&&(o=n.callback,s=n.target,n.once&&this.off(e,o,s),s?o.call(s,...c):o(...c))}a&&(l.isInvoking=!1,l.containCanceled)&&l.purgeCanceled()}}}exports.CallbacksInvoker=CallbacksInvoker;