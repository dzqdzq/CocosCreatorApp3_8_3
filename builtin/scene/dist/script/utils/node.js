"use strict";var ShapeType,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NodeUtils=void 0;const get=require("lodash")["get"],cc_1=require("cc"),aabb_1=__importDefault(require("./aabb")),math_1=__importDefault(require("./math")),vec3_1=require("./math/vec3"),raycast_1=__importDefault(require("./raycast")),window_1=require("./window"),ray=cc_1.geometry.Ray.create(),tempMatrix=cc.mat4(),cmp=(!function(e){e[e.Box=0]="Box",e[e.Circle=1]="Circle",e[e.Cone=2]="Cone",e[e.Sphere=3]="Sphere",e[e.Hemisphere=4]="Hemisphere"}(ShapeType=ShapeType||{}),(e,t)=>e.distance-t.distance),regionTargetClassName=["cc.Camera","cc.DirectionalLight","cc.Terrain","cc.SphereLight","cc.ParticleSystem","cc.SpotLight"];function _disableChildComps(r){for(let e=0,t=r._components.length;e<t;++e){var n=r._components[e];n._enabled&&cc_1.director._compScheduler.disableComp(n)}var o=r._children;for(let e=0,t=o.length;e<t;++e){var c=o[e];c._active&&_disableChildComps(c)}}function invokeOnDestroyRecursively(r){var t=r.components.length;for(let e=0;e<t;++e){var n=r.components[e];if((cc.GAME_VIEW||n.constructor._executeInEditMode)&&n.onDestroy)try{n.onDestroy()}catch(e){cc._throw(e)}}for(let e=0,t=r.children.length;e<t;++e){var o=r.children[e];o.active&&_disableChildComps(o)}}function InRegion(e,t,r,n,o,c){return r<=e&&e<=n&&t<=o&&c<=t}class NodeUtils{getObbFromRect(e,t,r,n,o,c){var a=t.x,i=t.y,s=t.width,t=t.height,l=e.m00*a+e.m04*i+e.m12,a=e.m01*a+e.m05*i+e.m13,i=e.m00*s,s=e.m01*s,d=e.m04*t,e=e.m05*t;return r=r||cc.v2(),n=n||cc.v2(),o=o||cc.v2(),c=c||cc.v2(),n.x=l,n.y=a,o.x=i+l,o.y=s+a,r.x=d+l,r.y=e+a,c.x=i+d+l,c.y=s+e+a,[r,n,o,c]}getWorldBounds(e,t,r){var n=(t=t||cc.size(0,0)).width,o=t.height,c=new cc.Rect(0,0,n,o),a=e.getComponent(cc_1.UITransform);return a&&(n=(t=a.contentSize).width,o=t.height,t=a.anchorPoint,c.x=-t.x*n,c.y=-t.y*o,c.width=n,c.height=o),e.getWorldMatrix(tempMatrix),c.transformMat4(tempMatrix),r?(r.x=c.x,r.y=c.y,r.width=c.width,r.height=c.height,r):c}getWorldOrientedBounds(e,t=null,r=null,n=null,o=null,c=null){e.getWorldMatrix(tempMatrix);var a=e.getComponent(cc_1.MeshRenderer);if(a)return this.getObbFromMeshRenderer(a,tempMatrix);a=e.getComponent(cc_1.UITransform);if(a)return this.getObbFromUITransform(a,tempMatrix);a=(t=t||cc.size(0,0)).width,t=t.height,a=new cc.Rect(0,0,a,t),t=this.getObbFromRect(tempMatrix,a,r,n,o,c);const i=this.getWorldPosition3D(e);return t.map(e=>new cc_1.Vec3(e.x,e.y,i.z))}getObbFromUITransform(e,t){var r=cc.size(0,0),n=r.width,o=r.height,c=new cc.Rect(0,0,n,o),a=new cc_1.Vec2,i=new cc_1.Vec2,s=new cc_1.Vec2,l=new cc_1.Vec2,r=(e&&(n=(r=e.contentSize).width,o=r.height,r=e.anchorPoint,c.x=-r.x*n,c.y=-r.y*o,c.width=n,c.height=o),this.getObbFromRect(tempMatrix,c,a,i,s,l));const d=this.getWorldPosition3D(e.node);return r.map(e=>new cc_1.Vec3(e.x,e.y,d.z))}getObbFromMeshRenderer(e,t){var r;let n=null==(r=e.model)?void 0:r.worldBounds;return n||(n=cc_1.geometry.AABB.create(),(e=null==(r=e.model)?void 0:r.modelBounds)?aabb_1.default.transform(n,e,t):aabb_1.default.transform(n,n,cc_1.Mat4.IDENTITY)),this.getObbFromBound(n)}getObbFromBound(e){var t=cc.v3(),r=cc.v3(),e=(e.getBoundary(t,r),[]);return e.push(t),e.push(cc.v3(r.x,t.y,t.z)),e.push(cc.v3(r.x,r.y,t.z)),e.push(cc.v3(t.x,r.y,t.z)),e.push(r),e.push(cc.v3(t.x,r.y,r.z)),e.push(cc.v3(t.x,t.y,r.z)),e.push(cc.v3(r.x,t.y,r.z)),e}getScenePosition(e){return cc_1.director.getScene()?e.getWorldPosition(cc.v3()):(cc.error("Can not access scenePosition if no running scene"),vec3_1.MVec3.ZERO)}setScenePosition(e,t){cc_1.director.getScene()?e.setWorldPosition(t):cc.error("Can not access scenePosition if no running scene")}getSceneRotation(e){return cc_1.director.getScene()?this.getWorldRotation(e):(cc.error("Can not access sceneRotation if no running scene"),0)}setSceneRotation(e,t){cc_1.director.getScene()?this.setWorldRotation(e,t):cc.error("Can not access sceneRotation if no running scene")}getWorldPosition(e){return e.getWorldPosition()}setWorldPosition(e,t){t instanceof cc.Vec3?e.setWorldPosition(t):cc.error("The new worldPosition must be cc.Vec3")}getWorldRotation(e){return e.getWorldRotation(cc.quat())}setWorldRotation(e,t){t instanceof cc.Quat?e.setWorldRotation(t):cc.error("The new worldPosition must be cc.Vec3")}getWorldScale(e){return e.getWorldScale(cc.v3())}_hasFlagInComponents(e,r){var n=e.components;for(let e=0,t=n.length;e<t;++e)if(n[e].objFlags&r)return!0;return!1}hasComponent(e,r){var n=e.components;for(let e=0,t=n.length;e<t;++e){var o=n[e],c=cc_1.js.getClassName(o);for(const a of r)if(c===a)return!0}return!1}getNodePath(e){let t="";for(;e&&!(e instanceof cc.Scene);)t=t?e.name+"/"+t:e.name,e=e.parent;return t}makeVec3InPrecision(e,t){return e.x=math_1.default.toPrecision(e.x,t),e.y=math_1.default.toPrecision(e.y,t),e.z=math_1.default.toPrecision(e.z,t),e}makeVec2InPrecision(e,t){return e.x=math_1.default.toPrecision(e.x,t),e.y=math_1.default.toPrecision(e.y,t),e}getWorldPosition3D(e,t){return t=t||new cc_1.Vec3,e.getWorldPosition(t)}setWorldPosition3D(e,t,r=3){t=this.makeVec3InPrecision(t,r),e.setWorldPosition(t)}getWorldRotation3D(e,t){return t=t||new cc_1.Quat,e.getWorldRotation(t)}setWorldRotation3D(e,t){e.setWorldRotation(t)}getEulerAngles(e){return e.eulerAngles}setEulerAngles(e,t){e.setRotationFromEuler(t.x,t.y,t.z)}getWorldScale3D(e){return e.getWorldScale()}limitRange(e){return math_1.default.clamp(e,-1e10,1e10)}makeVec3InRange(e,t,r){return e.x=math_1.default.clamp(e.x,t,r),e.y=math_1.default.clamp(e.y,t,r),e.z=math_1.default.clamp(e.z,t,r),e}getCenterWorldPos3D(t){let r=null,n=null,o=null,c=null,a=null,i=null;for(let e=0;e<t.length;++e){var s,l=t[e],d=this.getWorldOrientedBounds(l);for(let e=0;e<d.length;++e)s=d[e],(null===r||s.x<r)&&(r=s.x),(null===c||s.x>c)&&(c=s.x),(null===n||s.y<n)&&(n=s.y),(null===a||s.y>a)&&(a=s.y),(null===o||s.z<o)&&(o=s.z),(null===i||s.z>i)&&(i=s.z)}r=this.limitRange(r),c=this.limitRange(c),n=this.limitRange(n),a=this.limitRange(a),o=this.limitRange(o),i=this.limitRange(i);var e=.5*(r+c),h=.5*(n+a),u=.5*(o+i);return(0,cc_1.v3)(e,h,u)}getMaxRangeOfNode(o){let c=.001;if(o&&!this.isEditorNode(o)){let n=0;0===o.components.length&&(c=1),o.components.forEach(e=>{switch(cc.js.getClassName(e)){case"cc.SphereLight":case"cc.SpotLight":case"cc.PointLight":n=e.range;break;case"cc.LightProbeGroup":var t=(0,cc_1.v3)(e.maxPos).subtract(e.minPos);n=Math.max(Math.abs(t.x/2),Math.abs(t.y/2),Math.abs(t.z/2));break;case"cc.RangedDirectionalLight":case"cc.DirectionalLight":case"cc.Camera":n=3;break;case"cc.MeshRenderer":case"cc.SkinnedMeshRenderer":case"cc.AvatarModelComponent":case"cc.SkinnedMeshBatchRenderer":var t=e.model;if(e.mesh&&t){let e=t.worldBounds;e||(t=t.modelBounds)&&(e=aabb_1.default.create(),aabb_1.default.transform(e,t,o.worldMatrix)),(e=e&&(Number.isNaN(e.halfExtents.x)||Number.isNaN(e.halfExtents.y)||Number.isNaN(e.halfExtents.z))?this.getBoundaryOfMeshNode(o):e)&&(n=Math.max(e.halfExtents.x,e.halfExtents.y,e.halfExtents.z))}break;case"cc.ReflectionProbe":t=e.size;n=Math.max(t.x,t.y,t.z)/2;break;case"cc.UITransform":var t=e,r=t.getBoundingBox();t.node.parent&&(t.node.parent.getWorldMatrix(tempMatrix),r.transformMat4(tempMatrix)),n=Math.max(r.width/2,r.height/2);break;case"cc.BoxCollider":t=e.size;n=Math.max(t.x/2,t.y/2,t.z/2);break;case"cc.SphereCollider":n=e.radius;break;case"cc.CapsuleCollider":n=Math.max(e.height/2,e.radius);break;case"cc.ParticleSystem":n=this._getRangeFromParticleComp(e);break;case cc_1.js.getClassName(cc_1.Terrain):r=e.info;n=Math.max(r.size.width/2,r.size.height/2)}n>c&&(c=n)})}return c=this.limitRange(c)}getMinRangeOfNodes(e){let r=Number.MAX_VALUE;if(e){let t;e.forEach(e=>{(t=this.getMaxRangeOfNode(e))<r&&(r=t)})}return r=this.limitRange(r)}getMaxRangeOfNodes(e){let r=Number.MIN_VALUE;if(e){let t;e.forEach(e=>{(t=this.getMaxRangeOfNode(e))>r&&(r=t),(t=this.getMaxRangeOfNodes(e.children))>r&&(r=t)})}return r}isPartOfNode(e,t){let r=e;for(;r;){if(r===t)return!0;r=r.parent}return!1}isEditorNode(e){let t=e;for(;t;){if(t.objFlags&cc.Object.Flags.HideInHierarchy)return!0;t=t.parent}return!1}_getRangeFromParticleComp(e){let t=0;if(e.shapeModule.enable){var r=e.shapeModule;switch(r.shapeType){case ShapeType.Box:t=Math.max(r.scale.x,r.scale.y,r.scale.z);break;case ShapeType.Sphere:case ShapeType.Circle:case ShapeType.Hemisphere:t=r.radius;break;case ShapeType.Cone:t=Math.max(r.radius,r.length)}}return t}getRaycastResultNodes(e,t,r,n=~cc_1.Layers.Enum.SCENE_GIZMO){var o=(0,window_1.getMainWindowSize)(),t=(e.screenPointToRay(ray,t,o.height-r),null==(e=cc_1.director.getScene())?void 0:e.renderScene),c=[];if(raycast_1.default.raycastAll(t,ray,n)){var a=raycast_1.default.rayResultAll;a.sort(cmp);for(let e=0;e<a.length;e++){var i=a[e].node;i.objFlags&cc.Object.Flags.LockedInEditor||i.objFlags&cc.Object.Flags.HideInHierarchy||c.push(i)}}return c}getRaycastResults(e,t,r,n=~cc_1.Layers.Enum.SCENE_GIZMO){var o=(0,window_1.getMainWindowSize)(),t=(e.screenPointToRay(ray,t,o.height-r),null==(e=cc_1.director.getScene())?void 0:e.renderScene);return raycast_1.default.raycastAll(t,ray,n)?((o=raycast_1.default.rayResultAll).sort(cmp),o):[]}getRaycastResultsForSnap(e,t,r,n=~cc_1.Layers.Enum.SCENE_GIZMO){var o=(0,window_1.getMainWindowSize)(),t=(e.screenPointToRay(ray,t,o.height-r),null==(e=cc_1.director.getScene())?void 0:e.renderScene);return raycast_1.default.raycastAll(t,ray,n,1/0,!0)?((o=raycast_1.default.rayResultAll).sort(cmp),o):[]}_collectNodesForRegion(t=!0){var e;const n={prefabs:[],models:[],nodes:[]},o=this,r=function(e,t){const r={prefab:e,models:[],nodes:[]};e.walk(e=>{var t;null!=(t=e[cc_1.editorExtrasTag])&&t.mountedRoot?c(e,n):c(e,r)}),t.prefabs.push(r)},c=function(t,r){if(o.hasComponent(t,regionTargetClassName))r.nodes.push(t);else if(o.hasComponent(t,["cc.MeshRenderer","cc.SkinnedMeshRenderer"])){let e=t.getComponent("cc.MeshRenderer");!(e=e||t.getComponent("cc.SkinnedMeshRenderer")).model||null!=(t=null==(t=cc_1.director.getScene())?void 0:t.renderScene)&&t.isCulledByLod(cce.Camera.camera.camera,e.model)||r.models.push(e.model)}},a=function(e,t=!1){e._prefab&&(!t||null!=e&&e._prefab.instance)?r(e,n):(c(e,n),e.children.forEach(e=>{a(e)}))};return null!=(e=cc_1.director.getScene())&&e.children.forEach(e=>{"Editor Scene Foreground"===e.name&&t||"Editor Scene Background"!==e.name&&a(e,!0)}),n}isNodeInRegion(e,t,r,n,o,c){var a=new cc_1.Vec3;return t.worldToScreen(a,e.worldPosition),!!InRegion(a.x,a.y,r,n,o,c)}isModelInRegion(e,t,r,n,o,c){if(e.worldBounds){var a=[1,-1],i=e.worldBounds.center,s=new cc_1.Vec3;if(t.worldToScreen(s,i),InRegion(s.x,s.y,r,n,o,c)){var l=e.worldBounds.halfExtents;for(const h of["x","y","z"])for(const u of a){var d=new cc_1.Vec3(i);if(d[h]=d[h]+u*l[h],t.worldToScreen(s,d),!InRegion(s.x,s.y,r,n,o,c))return!1}return!0}}return!1}getRegionNodes(n,o,c,a,i,s=~cc_1.Layers.Enum.SCENE_GIZMO,e=!0){const l=[];e=this._collectNodesForRegion(e);return null!=e&&e.prefabs.forEach(e=>{for(const t of e.nodes)if(this.isNodeInRegion(t,n,o,c,a,i))return void l.push(e.prefab);for(const r of e.models){if(!(r.transform&&r.enabled&&r.node.layer&s&&r.worldBounds))return;if(this.isModelInRegion(r,n,o,c,a,i))return void l.push(e.prefab)}}),null!=e&&e.nodes.forEach(e=>{var t=new cc_1.Vec3;n.worldToScreen(t,e.position),this.isNodeInRegion(e,n,o,c,a,i)&&l.push(e)}),null!=e&&e.models.forEach(e=>{e.transform&&e.enabled&&e.node.layer&s&&e.worldBounds&&this.isModelInRegion(e,n,o,c,a,i)&&l.push(e.node)}),l}getNameDataByPropPath(e,t){var r,t=((t=t.replace(/^__comps__/,"_components"))||"").split(".");let n="",o="";return 1===t.length?o=t[0]:1<t.length&&"_components"===t[0]&&(r=[t[0],t[1]].join("."),(e=get(e,r))&&(n=cc_1.js.getClassName(e.constructor)),t[2])&&(o=t[2]),{compName:n,propName:o}}getBoundaryOfMeshNode(t){if(t){var r,n=t.getComponent(cc_1.MeshRenderer);let e;return n instanceof cc_1.SkinnedMeshRenderer?(null!=(r=n.model)&&r.updateTransform(-1),e=null==(r=null==n?void 0:n.model)?void 0:r.worldBounds):n&&n.mesh&&((e=n.model&&n.model.modelBounds&&n.model.modelBounds.clone())||(r=n.mesh)&&r.minPosition&&r.maxPosition&&(e=cc_1.geometry.AABB.fromPoints(cc_1.geometry.AABB.create(),r.minPosition,r.maxPosition)),e)&&cc_1.geometry.AABB.transform(e,e,t.worldMatrix),e}}getBoundaryOfMeshNodes(e){let r;if(e){let t;e.forEach(e=>{(t=this.getBoundaryOfMeshNode(e))&&(r?cc_1.geometry.AABB.merge(r,r,t):r=t),(t=this.getBoundaryOfMeshNodes(e.children))&&(r?cc_1.geometry.AABB.merge(r,r,t):r=t)})}return r}getMeshVertexAroundMouse(h,u,m,g,f=30){const p=[];return h&&u&&(h.getComponentsInChildren(cc_1.RenderableComponent).forEach(e=>{var t=e.mesh,r=null==(e=null==t?void 0:t.renderingSubMeshes)?void 0:e.length;for(let e=0;e<r;e++){var n=t.renderingSubMeshes[e].geometricInfo;if(n){var o=n.positions,c=new cc_1.Vec3,a=new cc_1.Vec3,i=new cc_1.Vec3,s=h.getWorldMatrix();for(let e=0;e<o.length;e+=3){c.set(o[e],o[e+1],o[e+2]),cc_1.Vec3.transformMat4(a,c,s),u.worldToScreen(i,a);var l=i.x-m,d=i.y-g,l=Math.sqrt(l*l+d*d);l<f&&p.push((new cc_1.Vec4).set(c.x,c.y,c.z,l))}}}}),p.sort((e,t)=>e.w-t.w)),p}}exports.NodeUtils=NodeUtils,exports.default=new NodeUtils;