"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),external_1=__importDefault(require("../utils/external")),engine_1=__importDefault(require("../utils/engine")),controller_utils_1=__importDefault(require("../utils/controller-utils")),controller_shape_1=__importDefault(require("../utils/controller-shape")),controller_shape_2=__importDefault(require("../utils/controller-shape")),editable_1=__importDefault(require("./editable")),EditorCamera=external_1.default.EditorCamera,{getModel,updatePositions,setMeshColor,setNodeOpacity,updateBoundingBox,CullMode}=engine_1.default,axisDirMap=controller_utils_1.default.axisDirectionMap,AxisName=controller_utils_1.default.AxisName,handleNameToFace={y:new cc_1.Vec3(0,1,0),neg_y:new cc_1.Vec3(0,-1,0),x:new cc_1.Vec3(1,0,0),neg_x:new cc_1.Vec3(-1,0,0),z:new cc_1.Vec3(0,0,1),neg_z:new cc_1.Vec3(0,0,-1)};class BoxController extends editable_1.default{constructor(e){super(e),this._center=new cc_1.Vec3,this._size=new cc_1.Vec3(1,1,1),this._deltaSize=new cc_1.Vec3,this._wireFrameBoxNode=null,this._wireFrameBoxMeshRenderer=null,this._cubeNode=null,this._cubeNodeMR=null,this._mouseDeltaPos=new cc_1.Vec2,this._curDistScalar=0,this._editHandleKeys=Object.keys(axisDirMap),this.initShape()}setColor(e){this._wireFrameBoxNode&&(this._color=e,setMeshColor(this._wireFrameBoxNode,e),this.setEditHandlesColor(e))}setOpacity(e){this._wireFrameBoxNode&&setNodeOpacity(this._wireFrameBoxNode,e)}_updateEditHandle(e){var t=this._handleDataMap[e].topNode,i=axisDirMap[e],o=new cc_1.Vec3,i=(cc_1.Vec3.multiply(o,i,this._size),cc_1.Vec3.multiplyScalar(o,o,.5),new cc_1.Vec3(o)),o=(i.add(this._center),this._editHandleScales[e]),e=this.getScale();t.setScale(o/e.x,o/e.y,o/e.z),cc_1.Vec3.multiply(i,i,e),t.setPosition(i)}initShape(){this.createShapeNode("BoxController"),this._wireFrameBoxNode=controller_utils_1.default.wireframeBox(this._center,this._size,this._color,{forwardPipeline:!0,depthTestForTriangles:!0}),this._wireFrameBoxNode.parent=this.shape,this._wireFrameBoxMeshRenderer=getModel(this._wireFrameBoxNode),this._cubeNode=controller_utils_1.default.cube(1,1,1,cc_1.Color.GREEN,cc_1.Vec3.ZERO,{forwardPipeline:!0,depthTestForTriangles:!0,cullMode:CullMode.NONE,effectName:"internal/editor/box-height-light",technique:0}),this._cubeNode.parent=this.shape,setNodeOpacity(this._cubeNode,20),this._cubeNodeMR=getModel(this._cubeNode),this._cubeNode.layer|=cc_1.Layers.BitMask.IGNORE_RAYCAST,this._cubeNode.active=this._edit,this.hide(),EditorCamera.camera.node.on("transform-changed",this.onEditorCameraMoved,this)}updateSize(e,t){var i;this._cubeNodeMR&&this._wireFrameBoxMeshRenderer&&(this._center.set(e),this._size!==t&&updateBoundingBox(this._cubeNodeMR,cc_1.Vec3.multiplyScalar(new cc_1.Vec3,t,-.5),cc_1.Vec3.multiplyScalar(new cc_1.Vec3,t,.5)),this._size=t,i=controller_shape_1.default.calcBoxPoints(this._center,this._size),updatePositions(this._wireFrameBoxMeshRenderer,i),this._edit&&this.updateEditHandles(),updatePositions(this._cubeNodeMR,controller_shape_2.default.calcCubeData(t.x,t.y,t.z,e).positions),this.adjustEditHandlesSize())}onMouseDown(e){this._mouseDeltaPos=cc.v2(0,0),this._curDistScalar=super.getDistScalar(),cc_1.Vec3.set(this._deltaSize,0,0,0),this.onControllerMouseDown&&this.onControllerMouseDown(e)}onMouseMove(e){var t;this._isMouseDown&&(this._mouseDeltaPos.x+=e.moveDeltaX,this._mouseDeltaPos.y+=e.moveDeltaY,t=axisDirMap[e.handleName],t=this.getAlignAxisMoveDistance(this.localToWorldDir(t),this._mouseDeltaPos)*this._curDistScalar,e.handleName===AxisName.x||e.handleName===AxisName.neg_x?this._deltaSize.x=t:e.handleName===AxisName.y||e.handleName===AxisName.neg_y?this._deltaSize.y=t:e.handleName!==AxisName.z&&e.handleName!==AxisName.neg_z||(this._deltaSize.z=t),this.onControllerMouseMove)&&this.onControllerMouseMove(e)}onMouseUp(e){this.onControllerMouseUp&&this.onControllerMouseUp(e)}onMouseLeave(e){this.onMouseUp(e)}onHoverIn(e){this._cubeNodeMR&&this._cubeNodeMR.material&&(this._cubeNodeMR.material.setProperty("selectedFaceForward",handleNameToFace[e.handleName]||cc_1.Vec3.ZERO,0),this.setHandleColor(e.handleName,cc_1.Color.YELLOW))}onHoverOut(){this._cubeNodeMR&&this._cubeNodeMR.material&&(this._cubeNodeMR.material.setProperty("selectedFaceForward",cc_1.Vec3.ZERO),this.resetHandleColor())}getDeltaSize(){return this._deltaSize}showEditHandles(){this._cubeNode&&(super.showEditHandles(),this._cubeNode.active=!0)}hideEditHandles(){this._cubeNode&&(super.hideEditHandles(),this._cubeNode.active=!1)}}exports.default=BoxController;