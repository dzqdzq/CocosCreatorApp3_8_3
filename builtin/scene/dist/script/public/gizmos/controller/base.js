"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),external_1=__importDefault(require("../utils/external")),controller_utils_1=__importDefault(require("../utils/controller-utils")),utils_1=__importDefault(require("../utils")),engine_1=__importDefault(require("../utils/engine")),controller_shape_collider_1=require("../utils/controller-shape-collider"),EditorCamera=external_1.default.EditorCamera,{setNodeOpacity,create3DNode,setMeshColor,getModel,getMeshColor,getNodeOpacity,ProjectionType,getRaycastResultsByNodes}=engine_1.default,tempVec3_a=new cc_1.Vec3,tempVec2_a=new cc_1.Vec2;class ControllerBase{get transformToolData(){return cce.Gizmo.transformToolData}get updated(){return this._updated}get visible(){var e;return null==(e=this.shape)?void 0:e.active}get isMouseDown(){return this._isMouseDown}constructor(e){this.isLock=!1,this._updated=!1,this._scale=new cc_1.Vec3(1,1,1),this._localRot=new cc_1.Quat,this._localPos=new cc_1.Vec3,this._rootNode=null,this._baseDist=600,this._handleDataMap={},this._twoPI=2*Math.PI,this._halfPI=Math.PI/2,this._degreeToRadianFactor=Math.PI/180,this._eventsRegistered=!1,this._isMouseDown=!1,this._color=cc_1.Color.WHITE,this._lockSize=!1,this._onDimensionChanged=null,this._onScale2DChanged=null,this._onCameraFovChanged=null,this._onCameraOrthoHeightChanged=null,this._mouseDownFuncs=new Map,this._mouseMoveFuncs=new Map,this._mouseUpFuncs=new Map,this._mouseLeaveFuncs=new Map,this._hoverInFuncs=new Map,this._hoverOutFuncs=new Map,this._rootNode=e}set lockSize(e){this._lockSize=e}setRoot(e){this._rootNode=e,this.shape&&(this.shape.parent=this._rootNode)}getRoot(){return this._rootNode}createShapeNode(e){this.shape=create3DNode(e),this.shape.parent=this._rootNode}registerEvents(){this._eventsRegistered||(this.registerCameraMovedEvent(),this.registerOrthoHeightChangedEvent(),this.registerCameraFovChangedEvent(),this._onDimensionChanged=this.onDimensionChanged.bind(this),this._onScale2DChanged=this.onScale2DChanged.bind(this),cce.Gizmo.transformToolData.addListener("dimension-changed",this._onDimensionChanged),cce.Gizmo.transformToolData.addListener("scale-2d-changed",this._onScale2DChanged),this._eventsRegistered=!0)}unregisterEvents(){this._eventsRegistered&&(this.unregisterCameraMoveEvent(),this.unregisterOrthoHeightChangedEvent(),this.unregisterCameraFovChangedEvent(),this._onDimensionChanged&&cce.Gizmo.transformToolData.removeListener("dimension-changed",this._onDimensionChanged),this._onScale2DChanged&&cce.Gizmo.transformToolData.removeListener("scale-2d-changed",this._onScale2DChanged),this._eventsRegistered=!1)}registerCameraMovedEvent(){EditorCamera.camera.node.on("transform-changed",this.onEditorCameraMoved,this)}unregisterCameraMoveEvent(){EditorCamera.camera.node.off("transform-changed",this.onEditorCameraMoved,this)}registerCameraFovChangedEvent(){this.onCameraFovChanged&&(null==this._onCameraFovChanged&&(this._onCameraFovChanged=this.onCameraFovChanged.bind(this)),cce.Camera.on("fov-changed",this._onCameraFovChanged))}registerOrthoHeightChangedEvent(){this._onCameraOrthoHeightChanged=this.onCameraOrthoHeightChanged.bind(this),cce.Gizmo.transformToolData.addListener("camera-ortho-height-changed",this._onCameraOrthoHeightChanged)}unregisterCameraFovChangedEvent(){this._onCameraFovChanged&&cce.Camera.off("fov-changed",this._onCameraFovChanged)}unregisterOrthoHeightChangedEvent(){this._onCameraOrthoHeightChanged&&cce.Gizmo.transformToolData.removeListener("camera-ortho-height-changed",this._onCameraOrthoHeightChanged)}onEditorCameraMoved(){this.adjustControllerSize()}initHandle(e,t){var o=this.getRendererNodes(e);const s=[],a=[];o.forEach(e=>{var t=getMeshColor(e);t&&(s.push(new cc.Color(t.r,t.g,t.b)),a.push(getNodeOpacity(e)))});o={name:t,topNode:e,rendererNodes:o,oriColors:s,oriOpacities:a,normalTorusNode:null,indicatorCircle:null,arrowNode:null,normalTorusMR:null,panPlane:null,customData:null};return this.getRayDetectNodes(e).forEach(e=>{this.registerMouseEvents(e,t)}),this._handleDataMap[t]=o}removeHandle(t){var e;this._handleDataMap[t]&&(e=this._handleDataMap[t].topNode,this.getRayDetectNodes(e).forEach(e=>{this.unregisterMouseEvent(e,t)}),delete this._handleDataMap[t])}setHandleColor(e,t,o){e=this._handleDataMap[e].rendererNodes;e&&e.forEach(e=>{null==o&&(o=getNodeOpacity(e)),setMeshColor(e,t),setNodeOpacity(e,o)})}resetHandleColor(){for(const i in this._handleDataMap)if(i){var e=this._handleDataMap[i],t=e.rendererNodes,o=e.oriColors,s=e.oriOpacities;for(let e=0;e<t.length;e++){var a=t[e];setMeshColor(a,o[e]),setNodeOpacity(a,s[e])}}}registerMouseEvents(t,o){this._mouseDownFuncs.set(o,(e=>{e.handleName=o,e.node=t,this._updated=!1,this._isMouseDown=!0,this.onMouseDown&&this.onMouseDown(e)}).bind(this)),t.on("mouseDown",this._mouseDownFuncs.get(o));this._mouseMoveFuncs.set(o,(e=>{this._updated=!0,e.handleName=o,e.node=t,!this.onMouseMove||this.shape&&!this.shape.active||this.onMouseMove(e),utils_1.default.repaintEngine()}).bind(this)),t.on("mouseMove",this._mouseMoveFuncs.get(o));var e=(e=>{e.handleName=o,e.node=t,!this.onMouseUp||this.shape&&!this.shape.active||this.onMouseUp(e),this._updated=!1,this._isMouseDown=!1}).bind(this),e=(this._mouseUpFuncs.set(o,e),t.on("mouseUp",e),(e=>{e.handleName=o,e.node=t,this.onMouseLeave&&this.onMouseLeave(e),this._updated=!1,this._isMouseDown=!1}).bind(this)),e=(this._mouseLeaveFuncs.set(o,e),t.on("mouseLeave",e),(e=>{e.handleName=o,e.node=t,this.onHoverIn&&this.onHoverIn(e),utils_1.default.repaintEngine()}).bind(this)),e=(this._hoverInFuncs.set(o,e),t.on("hoverIn",e),(e=>{e.handleName=o,e.node=t,this.onHoverOut&&this.onHoverOut(e),utils_1.default.repaintEngine()}).bind(this));this._hoverOutFuncs.set(o,e.bind(this)),t.on("hoverOut",e)}unregisterMouseEvent(e,t){e.off("mouseDown",this._mouseDownFuncs.get(t)),e.off("mouseMove",this._mouseMoveFuncs.get(t)),e.off("mouseUp",this._mouseUpFuncs.get(t)),e.off("mouseLeaver",this._mouseLeaveFuncs.get(t)),e.off("hoverIn",this._hoverInFuncs.get(t)),e.off("hoverOut",this._hoverOutFuncs.get(t))}setPosition(e){var t;null!=(t=this.shape)&&t.setPosition(e),this.adjustControllerSize()}getPosition(e){var t;return e=e||new cc_1.Vec3,null!=(t=this.shape)&&t.getPosition(e),e}getWorldPosition(e){return this.getWorldPositionForNode(this.shape,e)}getWorldPositionForNode(e,t){return t=t||new cc_1.Vec3,null!=(e=null!=e?e:this.shape)&&e.getWorldPosition(t),t}setRotation(e){var t;null!=(t=this.shape)&&t.setRotation(e),this.adjustControllerSize()}getRotation(e){var t;return e=e||new cc_1.Quat,null!=(t=this.shape)&&t.getRotation(e),e}getScale(){return this._scale}setScale(e){this._scale=e,this.adjustControllerSize()}updateController(){this.adjustControllerSize()}getCameraDistScalar(e){var t=EditorCamera.camera.node;return controller_utils_1.default.getCameraDistanceFactor(e,t)/this._baseDist}getDistScalarInOrtho(){var e=controller_utils_1.default.getCameraDistanceFactor(this.getWorldPosition(tempVec3_a),EditorCamera.camera.node),t=EditorCamera.camera.fov,t=Math.tan(t/2*Math.PI/180)*e;return e/this._baseDist*(EditorCamera.camera.orthoHeight/t)}isCameraInOrtho(){return EditorCamera.camera.projection===ProjectionType.ORTHO}getDistScalar(e){let t=1;return t=this.transformToolData.is2D?1.5/this.transformToolData.scale2D:this.isCameraInOrtho()?this.getDistScalarInOrtho():this.getCameraDistScalar(this.getWorldPositionForNode(e,tempVec3_a))}adjustControllerSize(){var e;let t=1;this._lockSize&&(t=this.getDistScalar());var o=new cc_1.Vec3(this._scale);o.multiplyScalar(t),null!=(e=this.shape)&&e.setScale(o)}needRender(e){e=e.getComponent(controller_shape_collider_1.ControllerShapeCollider);return!e||!1!==e.isRender}getRendererNodes(t){let o=[];getModel(t)&&this.needRender(t)&&o.push(t);for(let e=0;e<t.children.length;e++){var s=t.children[e];o=o.concat(this.getRendererNodes(s))}return o}getRayDetectNodes(t){let o=[];getModel(t)&&o.push(t);for(let e=0;e<t.children.length;e++){var s=t.children[e];o=o.concat(this.getRayDetectNodes(s))}return o}localToWorldPosition(e){var t,o=cc.mat4(),s=cc.v3();return null!=(t=this.shape)&&t.getWorldMatrix(o),cc_1.Vec3.transformMat4(s,e,o),s}localToWorldDir(e){var t,o=cc.mat4(),s=cc.v3();return null!=(t=this.shape)&&t.getWorldMatrix(o),cc_1.Vec3.transformMat4Normal(s,e,o),cc_1.Vec3.normalize(s,s),s}worldPosToScreenPos(e){var t=EditorCamera.camera.camera,o=cc.v3();return null!=t&&t.worldToScreen(o,e),o}getScreenPos(e){return this.worldPosToScreenPos(this.localToWorldPosition(e))}getAlignAxisMoveDistance(e,t){var e=cc_1.Vec3.add(tempVec3_a,this.getPosition(),e),e=this.worldPosToScreenPos(e),o=this.worldPosToScreenPos(this.getPosition()),o=(cc_1.Vec2.subtract(e,e,o),cc_1.Vec2.normalize(e,e),cc_1.Vec2.dot(t,tempVec2_a.set(e.x,e.y)));return o}getPositionOnPanPlane(e,t,o,s){s=getRaycastResultsByNodes([s],t,o,1/0,!1);return 0<s.length&&(t=s[0],e.set(t.hitPoint),!0)}show(){this.shape&&(this.shape.active=!0),this.onShow&&this.onShow()}hide(){this.shape&&(this.shape.active=!1),this._isMouseDown=!1,this.isLock=!1,this.resetHandleColor(),this.onHide&&this.onHide()}onDimensionChanged(){this.visible&&this.onShow&&this.onShow()}onScale2DChanged(){this.visible&&this.adjustControllerSize()}onCameraOrthoHeightChanged(){this.visible&&this.adjustControllerSize()}}exports.default=ControllerBase;