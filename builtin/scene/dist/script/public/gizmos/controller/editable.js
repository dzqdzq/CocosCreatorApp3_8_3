"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),base_1=__importDefault(require("./base")),controller_utils_1=__importDefault(require("../utils/controller-utils")),engine_1=__importDefault(require("../utils/engine")),external_1=__importDefault(require("../utils/external")),config_1=__importDefault(require("../utils/config")),{create3DNode,setMeshColor}=engine_1.default,EditorCamera=external_1.default.EditorCamera,tempVec3=new cc_1.Vec3,tempQuat_a=new cc_1.Quat;class EditableController extends base_1.default{constructor(e){super(e),this._editable=!1,this._edit=!1,this._editHandlesShape=null,this._defaultEditHandleSize=7,this._hoverColor=cc_1.Color.GREEN,this._editHandleScales={},this._editHandleColor=cc_1.Color.WHITE,this._editHandleKeys=[],EditorCamera.camera.node.on(cc_1.Node.EventType.TRANSFORM_CHANGED,this.onEditorCameraMoved,this)}get editable(){return this._editable}set editable(e){this._editable=e}get edit(){return this._edit}set edit(e){this._editable&&(this._edit=e,!0===this._edit?(this.initEditHandles(),this.showEditHandles()):this.hideEditHandles())}get hoverColor(){return this._hoverColor}set hoverColor(e){this._hoverColor=e}createEditHandleShape(){this._editHandlesShape=create3DNode("EditControllerShape"),this._editHandlesShape.parent=this._rootNode,this._editHandlesShape.setPosition(this.getPosition()),this._editHandlesShape.setRotation(this.getRotation()),this.registerEvents()}setRoot(e){super.setRoot(e),this._editHandlesShape&&(this._editHandlesShape.parent=this._rootNode)}setEditHandlesColor(i){this.editable&&this._editHandlesShape&&this._editHandleKeys.forEach(e=>{e=this._handleDataMap[e];if(e){const t=[];e.rendererNodes.forEach(e=>{setMeshColor(e,i),t.push(i)}),e.oriColors=t}}),this._editHandleColor=i}showEditHandles(){this._editHandlesShape&&(this._editHandlesShape.active=!0)}hideEditHandles(){this._editHandlesShape&&(this._editHandlesShape.active=!1)}createEditHandle(e,t){var i=this._defaultEditHandleSize,i=controller_utils_1.default.quad(new cc_1.Vec3,i,i,new cc_1.Vec3(0,0,1),t,{unlit:!0,priority:255}),t=(i.name=e,i.parent=this._editHandlesShape,this._editHandleScales[e]=1,this.initHandle(i,e));return t}initEditHandles(){var e;this._editHandlesShape||(this.createEditHandleShape(),this._editHandleKeys.forEach(e=>{this.createEditHandle(e,this._editHandleColor),this._updateEditHandle(e)}),null!=(e=this.onInitEditHandles)&&e.call(this))}_updateEditHandle(e){}updateEditHandles(){this._editHandleKeys.forEach(e=>{this._updateEditHandle(e)})}checkEdit(){this.editable&&config_1.default.toolsVisibility3d?this.edit=!0:this.hideEditHandles()}onHoverIn(e){this.setHandleColor(e.handleName,this.hoverColor)}onHoverOut(e){this.resetHandleColor()}onEditorCameraMoved(){this.adjustEditHandlesSize()}adjustControllerSize(){super.adjustControllerSize(),this.adjustEditHandlesSize()}adjustEditHandlesSize(){this.edit&&this._editHandleKeys.forEach(e=>{var t,i=this._handleDataMap[e];i&&((i=i.topNode).getWorldPosition(tempVec3),t=this.getDistScalar(i),i.getPosition(tempVec3),this._editHandleScales[e]=t,i.setWorldScale(t,t,t),e=tempQuat_a,EditorCamera.camera.node.getWorldRotation(e),i.setWorldRotation(e))})}setPosition(e){super.setPosition(e),this._editHandlesShape&&this._editHandlesShape.setPosition(e)}setRotation(e){super.setRotation(e),this._editHandlesShape&&this._editHandlesShape.setRotation(e)}onShow(){this._editHandlesShape&&(this.registerEvents(),this._editHandlesShape.active=!0)}onHide(){this.unregisterEvents(),this._editHandlesShape&&(this._editHandlesShape.active=!1)}}exports.default=EditableController;