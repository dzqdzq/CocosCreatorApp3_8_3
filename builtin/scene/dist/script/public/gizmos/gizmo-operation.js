"use strict";var RegionSelectMode,__createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var n=Object.getOwnPropertyDescriptor(t,o);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,n)}:function(e,t,o,i){e[i=void 0===i?o:i]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),camera_1=__importDefault(require("../../3d/manager/camera")),node_1=__importDefault(require("../../utils/node")),window_1=require("../../utils/window"),operation_1=__importStar(require("../operation")),selection_1=__importDefault(require("../selection")),gizmo_selection_1=__importDefault(require("../selection/gizmo-selection")),index_1=__importDefault(require("./utils/engine/index")),set_util_1=__importStar(require("./utils/set-util")),gizmo_select_1=__importDefault(require("./components/light-probe-group/gizmo-select"));class SceneMouseEvent extends cc_1.Event{constructor(){super(...arguments),this.ctrlKey=!1,this.shiftKey=!1,this.altKey=!1,this.metaKey=!1,this.x=0,this.y=0,this.clientX=0,this.clientY=0,this.deltaX=0,this.deltaY=0,this.wheelDeltaX=0,this.wheelDeltaY=0,this.moveDeltaX=0,this.moveDeltaY=0,this.leftButton=!1,this.middleButton=!1,this.rightButton=!1,this.button=0,this.buttons=0,this.movementX=0,this.movementY=0}}const{getRaycastResults,raycast}=index_1.default,hitPoint=(0,cc_1.v3)(),SceneGizmoLayer=cc_1.Layers.Enum.SCENE_GIZMO;function copyEventKeys(e,t){e.altKey=t.altKey,e.metaKey=t.metaKey,e.ctrlKey=t.ctrlKey,e.shiftKey=t.shiftKey,e.leftButton=t.leftButton,e.middleButton=t.middleButton,e.rightButton=t.rightButton}function adjustY(e){return(0,window_1.getMainWindowSize)().height-e}!function(e){e[e.Node=0]="Node",e[e.Gizmo=1]="Gizmo"}(RegionSelectMode=RegionSelectMode||{});class GizmoOperation{constructor(){this._regionSelecting=!1,this._hoverInNode=null,this._curSelectNode=null,this._gizmoMouseDownEvent=null,this._noGizmoMouseDownEvent=null,this._regionSelectMode=RegionSelectMode.Node,this._anyKeyDown=!1,this._gizmoOperationEventListeners=[],this._gizmoSelection=new gizmo_selection_1.default(this._gizmoOperationEventListeners)}raycastGizmos(e,t){var o;let i=raycast(null==(o=cc_1.director.getScene())?void 0:o.renderScene,cce.Gizmo.sceneGizmoCamera.camera,SceneGizmoLayer,e,t);return i=!i||i.length<=0?getRaycastResults(cce.Gizmo.gizmoRootNode,e,t,1/0,cc_1.Layers.Enum.IGNORE_RAYCAST):i}_emitEventToNode(e,t){t.type&&(e.emit(t.type,t),cce.Engine.repaintInEditMode())}_onNotGizmoMouseDown(t){this._noGizmoMouseDownEvent=t,this._gizmoOperationEventListeners.forEach(e=>e.onNotGizmoMouseDown(t))}_onNotGizmoMouseUp(t){if(this._noGizmoMouseDownEvent=null,t.leftButton){if(this._regionSelecting)this._regionSelecting=!1,cce.Gizmo.hideSelectionRegion(),this._regionSelectMode===RegionSelectMode.Gizmo&&this._gizmoSelection.confirm();else switch(t.y=adjustY(t.y),this._regionSelectMode){case RegionSelectMode.Node:this._select(t);break;case RegionSelectMode.Gizmo:this._gizmoSelection.unselectAll()}this._gizmoOperationEventListeners.forEach(e=>e.onNotGizmoMouseUp(t))}}_onNotGizmoMouseMove(t){var e=this._noGizmoMouseDownEvent;if(t.leftButton&&e){this._regionSelecting=!0;var o=e.x>t.x,i=e.y<t.y,n=(o?t:e).x,s=(o?e:t).x,r=(i?e:t).y,c=(i?t:e).y;switch(this._regionSelectMode){case RegionSelectMode.Node:this._regionSelectNode(n,s,c,r);break;case RegionSelectMode.Gizmo:this._regionSelectGizmo(n,s,c,r,t)}return this._gizmoOperationEventListeners.forEach(e=>e.onNotGizmoMouseMove(t)),!1}}_onGizmoMouseDown(e,t){return!!camera_1.default.controller.isMoving()||!(this._gizmoMouseDownEvent=e).leftButton||(t=t[0],e.hitPoint=t.hitPoint.clone(),this._curSelectNode=t.node,this._emitEventToNode(this._curSelectNode,e),this._regionSelectMode===RegionSelectMode.Gizmo&&(this._selectGizmo([t.node],e),this._gizmoSelection.confirm()),!1)}_onGizmoMouseUp(t){if(this._gizmoMouseDownEvent=null,this._curSelectNode)return this._emitEventToNode(this._curSelectNode,t),this._curSelectNode=null,!1;var{x:e,y:o}=t,i=this.raycastGizmos(e,o);for(let e=0;e<i.length;e++)this._emitEventToNode(i[e].node,t);return!0}_onGizmoMouseMove(e){this._curSelectNode&&this._emitEventToNode(this._curSelectNode,e)}_select(e){var o=node_1.default.getRaycastResultNodes(camera_1.default.getCamera(),e.x,e.y,cc_1.Layers.makeMaskExclude([cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO,cc_1.Layers.Enum.EDITOR,cc_1.Layers.Enum.IGNORE_RAYCAST]));if(0<o.length){let t=null;for(let e=0;e<o.length;e++){var i=o[e];if(!(i._objFlags&cc_1.CCObject.Flags.LockedInEditor)){t=i;break}}if(t){var n=selection_1.default.query();if(e.ctrlKey||e.shiftKey||selection_1.default.clear(),e.ctrlKey)selection_1.default.isSelect(t.uuid)?selection_1.default.unselect(t.uuid):selection_1.default.select(t.uuid);else{var s=n[0];for(let e=0;e<o.length-1;e++)if(o[e]&&s===o[e].uuid){t=o[e+1];break}selection_1.default.select(t.uuid)}}}else!e.leftButton||e.ctrlKey||e.shiftKey||selection_1.default.clear()}_regionSelectNode(e,t,o,i){cce.Gizmo.showSelectionRegion(e,t,o,i);var n=cc_1.Layers.makeMaskExclude([cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO,cc_1.Layers.Enum.EDITOR]),e=node_1.default.getRegionNodes(camera_1.default.getCamera(),e,t,o,i,n),t=selection_1.default.query();const s=new Map;t.forEach(e=>{s.set(e,!0)}),e.forEach(e=>{s.has(e.uuid)||selection_1.default.select(e.uuid),s.set(e.uuid,!1)});for(const r of s.keys())s.get(r)&&selection_1.default.unselect(r)}_selectGizmo(e,t){this._gizmoSelection.processCurrent(e.map(e=>e.uuid),!1,t.metaKey||t.ctrlKey)}_regionSelectGizmo(e,t,o,i,n){cce.Gizmo.showSelectionRegion(e,t,o,i);var s=cc_1.Layers.makeMaskInclude([cc_1.Layers.Enum.GIZMOS]),e=node_1.default.getRegionNodes(camera_1.default.getCamera(),e,t,o,i,s,!1);this._gizmoSelection.processCurrent(e.map(e=>e.uuid),!0,n.metaKey||n.ctrlKey)}init(e){cce.Gizmo=e,operation_1.default.on("mousedown",this.onMouseDown.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("mousemove",this.onMouseMove.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("mouseup",this.onMouseUp.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("mousewheel",this.onMouseWheel.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("keydown",this.onKeyDown.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("keyup",this.onKeyUp.bind(this),operation_1.OperationPriority.Gizmo)}onMouseDown(e){this._anyKeyDown||(this._anyKeyDown=e.altKey||e.ctrlKey||e.shiftKey||e.metaKey);var t=e.x,o=adjustY(e.y),i=new SceneMouseEvent("mouseDown",!0),e=(i.x=t,i.y=o,copyEventKeys(i,e),this.raycastGizmos(t,o));return 0<e.length?this._onGizmoMouseDown(i,e):this._onNotGizmoMouseDown(i)}onMouseUp(e){var t,o,i;return!camera_1.default.controller.isMoving()||this._regionSelecting||this._gizmoMouseDownEvent?(t=e.x,o=adjustY(e.y),(i=new SceneMouseEvent("mouseUp",!0)).x=t,i.y=o,copyEventKeys(i,e),this._gizmoMouseDownEvent?this._onGizmoMouseUp(i):!this._noGizmoMouseDownEvent||this._onNotGizmoMouseUp(i)):!(this._noGizmoMouseDownEvent=null)}onMouseMove(e){var t=e.x,o=adjustY(e.y);let i=new SceneMouseEvent("mouseMove",!0);if(i.x=t,i.y=o,i.moveDeltaX=e.moveDeltaX,i.moveDeltaY=-e.moveDeltaY,copyEventKeys(i,e),this._gizmoMouseDownEvent&&this._gizmoMouseDownEvent.leftButton)return this._onGizmoMouseMove(i),!1;if(this._noGizmoMouseDownEvent)return this._anyKeyDown?!this._regionSelecting&&void 0:this._onNotGizmoMouseMove(i);e=cce.Selection.query();if(e[0]){e=cce.Node.query(e[0]);if(e)if(!1===cce.Gizmo.callAllGizmoFuncOfNode(e,"onVertexSnapMove",i))return}var n=this.raycastGizmos(t,o);if(0<n.length){var s=n.ray;for(let e=0;e<n.length;e++)cc_1.Vec3.multiplyScalar(hitPoint,s.d,n[e].distance),cc_1.Vec3.add(hitPoint,s.o,hitPoint),i.hitPoint=hitPoint,n[e].node.emit(i.type,i);e=n[0].node;e!==this._hoverInNode&&(this._hoverInNode&&(i=new SceneMouseEvent("hoverOut",!0),this._emitEventToNode(this._hoverInNode,i)),this._hoverInNode=e,(i=new SceneMouseEvent("hoverIn",!0)).x=t,i.y=o,this._emitEventToNode(this._hoverInNode,i))}else this._hoverInNode&&(i=new SceneMouseEvent("hoverOut",!0),this._emitEventToNode(this._hoverInNode,i)),this._hoverInNode=null}onMouseWheel(){}clear(){this._gizmoMouseDownEvent=null,this._noGizmoMouseDownEvent=null,this._curSelectNode=null,this._hoverInNode=null}onMouseLeave(){var e=new SceneMouseEvent("mouseLeave",!0);this._curSelectNode&&this._emitEventToNode(this._curSelectNode,e),this.clear()}onKeyDown(e){if(this._regionSelecting)return!1;this._anyKeyDown=!0;var t=cce.Selection.query().map(e=>cce.Node.query(e));let o=!0;return o=t[0]?cce.Gizmo.callAllGizmoFuncOfNode(t[0],"onKeyDown",e):o}onKeyUp(e){this._anyKeyDown=!1;var t=cce.Selection.query().map(e=>cce.Node.query(e));let o=!0;return o=t[0]?cce.Gizmo.callAllGizmoFuncOfNode(t[0],"onKeyUp",e):o}registerGizmoOperationEventListener(e){this._gizmoOperationEventListeners.push(e)}lightProbeEditModeChanged(e){this._regionSelectMode=e?RegionSelectMode.Gizmo:RegionSelectMode.Node,this._gizmoSelection.clear()}boundingBoxEditModeChanged(e){this._regionSelectMode=e?RegionSelectMode.Gizmo:RegionSelectMode.Node,this._gizmoSelection.clear()}selectAllLightProbes(){for(const t of this._gizmoOperationEventListeners){var e;t instanceof gizmo_select_1.default&&t.checkCurrentTargetPointingSelf()&&t.visible()&&(t.selectAll(),e=t.shouldEmitNodes(),this._gizmoSelection.logic.selected.addAll(e))}this._gizmoSelection.confirm()}unselectAllLightProbes(){for(const e of this._gizmoOperationEventListeners)e instanceof gizmo_select_1.default&&(e.unselectAll(),this._gizmoSelection.logic.selected.clear());this._gizmoSelection.confirm()}duplicateCurrentSelectedProbes(){var e=new set_util_1.default;for(const t of this._gizmoOperationEventListeners)t instanceof gizmo_select_1.default&&t.checkCurrentTargetPointingSelf()&&t.visible()&&e.addAll(t.duplicateCurrentSelectedProbes());this._gizmoSelection.processCurrent(e.map(e=>e.uuid)),this._gizmoSelection.confirm()}removeCurrentSelectedProbes(){for(const t of this._gizmoOperationEventListeners){var e;t instanceof gizmo_select_1.default&&t.checkCurrentTargetPointingSelf()&&t.visible()&&(e=t.deleteCurrentSelectedProbes(),this._gizmoSelection.unselect((0,set_util_1.toSet)(e.map(e=>e.uuid))))}this._gizmoSelection.confirm()}}exports.default=new GizmoOperation;