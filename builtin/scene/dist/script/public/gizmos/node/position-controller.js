"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),base_1=__importDefault(require("../controller/base")),controller_utils_1=__importDefault(require("../utils/controller-utils")),external_1=__importDefault(require("../utils/external")),engine_1=__importDefault(require("../utils/engine")),NodeUtils=external_1.default.NodeUtils,EditorCamera=external_1.default.EditorCamera,{getRaycastResultsByNodes,getRaycastResults,setNodeOpacity,panPlaneLayer,create3DNode,getModel}=engine_1.default,axisDirMap=controller_utils_1.default.axisDirectionMap,SnapPlaneName="SnapPlane",TempVec3A=new cc_1.Vec3,TempVec3B=new cc_1.Vec3,TempQuatA=new cc_1.Quat;class PositionController extends base_1.default{constructor(e){super(e),this._deltaPosition=new cc_1.Vec3,this._mouseDownPos=new cc_1.Vec3,this._mouseDownAxis="",this._curDistScalar=0,this._dragPanPlane=null,this._isInPanDrag=!1,this._mouseDownOnPlanePos=new cc_1.Vec3,this.onCameraFovChanged=e=>{cce.Gizmo.is2D||(e=cc_1.Vec3.multiplyScalar(new cc_1.Vec3,PositionController.scale3D,e/45),this.setScale(e))},this._lockSize=!0,this.initShape(),this.onDimensionChanged()}onDimensionChanged(){var e;null!=(e=super.onDimensionChanged)&&e.call(this),this.setScale(cce.Gizmo.is2D?PositionController.scale2D:PositionController.scale3D)}createAxis(e,t,a){t=controller_utils_1.default.arrow(PositionController.baseArrowHeadHeight,PositionController.baseArrowHeadRadius,PositionController.baseArrowBodyHeight,t,{priority:1e3});t.name=e+"Axis",t.parent=this.shape,NodeUtils.setEulerAngles(t,a),this.initHandle(t,e)}createControlPlane(t,e,a){var o=PositionController.planeWidth/2,i=new cc_1.Vec3;for(let e=0;e<t.length;e++){var n=cc.v3();cc_1.Vec3.multiplyScalar(n,axisDirMap[t.charAt(e)],o),i.add(n)}var s=controller_utils_1.default.borderPlane(PositionController.planeWidth,PositionController.planeWidth,e,128),e=(s.name=t+"Plane",s.parent=this.shape,NodeUtils.setEulerAngles(s,a),s.setPosition(i.x,i.y,i.z),controller_utils_1.default.quad(cc.v3(),1e8,1e8,cc.v3(0,0,1),e));e.parent=this._ctrlPlaneGroup,e.name=t+"PanPlane",e.active=!1,e.layer=panPlaneLayer,NodeUtils.setEulerAngles(e,a),setNodeOpacity(e,0),this.initHandle(s,t),this._handleDataMap[t].panPlane=e}createSnapPlane(){this._snapDragPlane=controller_utils_1.default.quad(new cc_1.Vec3(0,0,0),PositionController.planeWidth,PositionController.planeWidth,new cc_1.Vec3(0,0,1),cc_1.Color.WHITE,{unlit:!0}),this._snapDragPlane.parent=this.shape,setNodeOpacity(this._snapDragPlane,80),this._snapDragPlane.active=!1,this.initHandle(this._snapDragPlane,SnapPlaneName)}initShape(){this.createShapeNode("PositionController"),this.registerEvents(),this.createAxis("x",cc.Color.RED,cc.v3(-90,-90,0)),this.createAxis("y",cc.Color.GREEN,cc.v3()),this.createAxis("z",cc.Color.BLUE,cc.v3(90,0,90));var e=create3DNode("ctrlPlaneGroup");e.parent=this._rootNode,this._ctrlPlaneGroup=e,this.createControlPlane("xy",cc.Color.BLUE,cc.v3()),this.createControlPlane("xz",cc.Color.GREEN,cc.v3(-90,-90,0)),this.createControlPlane("yz",cc.Color.RED,cc.v3(0,90,90)),this.createSnapPlane(),this.hide()}getDeltaPositionOfAxis(e,t){null==e&&(e=new cc_1.Vec3);t=axisDirMap[t];return cc_1.Vec3.transformQuat(TempVec3A,t,this.getRotation()),cc_1.Vec3.project(e,this._deltaPosition,TempVec3A)}getDeltaPosition(){return this._deltaPosition}onMouseDown(e){var t;this._deltaPosition.set(0,0,0),this._mouseDownPos=this.getPosition(),this._mouseDownAxis=e.handleName,this._curDistScalar=this.getDistScalar(),this.isSnapping()||(this._dragPanPlane=this.getPanPlane(e.handleName),this._dragPanPlane&&(this._isInPanDrag=!0,this._ctrlPlaneGroup.setPosition(this.getPosition()),this._ctrlPlaneGroup.setRotation(this.getRotation()),this._dragPanPlane.active=!0,null!=(t=getModel(this._dragPanPlane).model)&&t.updateTransform(-1),this.getPositionOnPanPlane(this._mouseDownOnPlanePos,e.x,e.y,this._dragPanPlane)),cc.game.canvas.style.cursor="move"),this.onControllerMouseDown&&this.onControllerMouseDown(e)}getPanPlane(e){let a=null;if(1<e.length)a=this._handleDataMap[e].panPlane;else{var o="xyz".replace(e,"");let t=1e-5;for(let e=0;e<o.length;e++){var i=o.charAt(e),n=axisDirMap[i],s=TempVec3A,n=(cc_1.Vec3.transformQuat(s,n,this.getRotation()),cc_1.Vec3.normalize(s,s),TempVec3B),l=(EditorCamera.camera.node.getWorldPosition(n),cc.v3()),n=(cc_1.Vec3.subtract(l,n,this.getPosition()),cc_1.Vec3.normalize(l,l),Math.abs(cc_1.Vec3.dot(s,l)));n>t&&(s="xyz".replace(i,""),a=this._handleDataMap[s].panPlane,t=n)}}return a}static isXYZ(e){return 1===e.length&&["x","y","z"].includes(e)}static isPlane(e){return 2===e.length&&["xy","yz","xz"].includes(e)}getAlignAxisDeltaPosition(e,t){var e=axisDirMap[e],t=this.getAlignAxisMoveDistance(this.localToWorldDir(e),t),a=cc.v3();return cc_1.Vec3.multiplyScalar(a,e,t*this._curDistScalar),a}getPositionOnPanPlane(e,t,a,o){o=getRaycastResultsByNodes([o],t,a,1/0,this.isSnapping()),t=o.ray;return 0<o.length&&(a=o[0],cc_1.Vec3.multiplyScalar(e,t.d,a.distance),cc_1.Vec3.add(e,t.o,e),!0)}onMouseMove(e){var t;this.isSnapping()?this.onControllerMouseMove&&this.onControllerMouseMove(e):this._isMouseDown&&this._isInPanDrag&&(t=new cc_1.Vec3,this._dragPanPlane&&this.getPositionOnPanPlane(t,e.x,e.y,this._dragPanPlane)&&(this._deltaPosition.set(t),this._deltaPosition.subtract(this._mouseDownOnPlanePos),PositionController.isXYZ(this._mouseDownAxis))&&this.getDeltaPositionOfAxis(this._deltaPosition,this._mouseDownAxis),(t=new cc_1.Vec3(this._mouseDownPos)).add(this._deltaPosition),this.isLock?this.onControllerMouseMove&&this.onControllerMouseMove(e):(this.setPosition(t),this.onControllerMouseMove&&this.onControllerMouseMove(e),this.updateController()))}onMouseUp(e){this.isSnapping()||(this._isInPanDrag&&(this._dragPanPlane&&(this._dragPanPlane.active=!1),this._isInPanDrag=!1),cc.game.canvas.style.cursor="default"),this.onControllerMouseUp&&this.onControllerMouseUp(e)}onMouseLeave(e){this.onMouseUp(e)}onHoverIn(e){this.setHandleColor(e.handleName,cc_1.Color.YELLOW)}onHoverOut(){this.resetHandleColor()}onShow(){this.registerEvents();var e=cce.Camera.getCameraFov();e&&this.onCameraFovChanged(e),this.setScale(cce.Gizmo.is2D?PositionController.scale2D:PositionController.scale3D),this.transformToolData.is2D?(this._handleDataMap.z.topNode.active=!1,this._handleDataMap.xz.topNode.active=!1,this._handleDataMap.yz.topNode.active=!1,this.updateController()):(this._handleDataMap.z.topNode.active=!0,this._handleDataMap.xz.topNode.active=!0,this._handleDataMap.yz.topNode.active=!0)}onHide(){this.unregisterEvents()}isSnapping(){return this._snapDragPlane.active}updateSnapUI(e){(this._snapDragPlane.active=e)?(e=TempQuatA,EditorCamera.camera.node.getWorldRotation(e),this._snapDragPlane.setWorldRotation(e),this._handleDataMap.xy.topNode.active=!1,this._handleDataMap.xz.topNode.active=!1,this._handleDataMap.yz.topNode.active=!1):(this._handleDataMap.xy.topNode.active=!0,this._handleDataMap.xz.topNode.active=!0,this._handleDataMap.yz.topNode.active=!0)}}PositionController.baseArrowHeadHeight=12.5,PositionController.baseArrowHeadRadius=5,PositionController.baseArrowBodyHeight=70,PositionController.planeWidth=12.5,PositionController.scale2D=new cc_1.Vec3(2,2,2),PositionController.scale3D=new cc_1.Vec3(1,1,1),exports.default=PositionController;