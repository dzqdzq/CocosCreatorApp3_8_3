"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),external_1=__importDefault(require("../utils/external")),window_1=require("../../../utils/window"),rect_transform_snapping_1=require("../utils/rect-transform-snapping"),lines_1=__importDefault(require("../controller/lines")),transform_base_1=__importDefault(require("./transform-base")),rectangle_controller_1=require("./rectangle-controller"),NodeUtils=external_1.default.NodeUtils,EditorMath=external_1.default.EditorMath,tempVec2=new cc_1.Vec2,tempVec3=new cc_1.Vec3,tempMat4=new cc_1.Mat4,tempQuat_a=new cc_1.Quat;let _controller,_nodeSnapLinesCtrl,_canvasSnapLinesCtrl,_equalSpacingLinesCtrl;function boundsToRect(e){return new cc_1.Rect(e[1].x,e[1].y,e[3].x-e[1].x,e[3].y-e[1].y)}class RectGizmo extends transform_base_1.default{constructor(){super(...arguments),this._worldPosList=[],this._localPosList=[],this._sizeList=[],this._anchorList=[],this._rectList=[],this._validTarget=[],this._tempRect=new cc_1.Rect,this._editRect=new cc_1.Rect,this._altKey=!1,this._snapDistVec2=new cc_1.Vec2,this._shiftKey=!1}init(){this.createController()}layer(){return"foreground"}isNodePositionLocked(e){return!!e&&e.components.some(e=>e._objFlags&cc_1.CCObject.Flags.IsPositionLocked)}isNodeAnchorLocked(e){return!!e&&e.components.some(e=>e._objFlags&cc_1.CCObject.Flags.IsAnchorLocked)}isNodeContentSizeLocked(e){return!!e&&e.components.some(e=>e._objFlags&cc_1.CCObject.Flags.IsSizeLocked)}onTargetUpdate(){_controller&&((this._controller=_controller).onControllerMouseDown=this.onControllerMouseDown.bind(this),_controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),_controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)),_nodeSnapLinesCtrl&&(this._nodeSnapLinesCtrl=_nodeSnapLinesCtrl),_canvasSnapLinesCtrl&&(this._canvasSnapLinesCtrl=_canvasSnapLinesCtrl),_equalSpacingLinesCtrl&&(this._equalSpacingLinesCtrl=_equalSpacingLinesCtrl),this._controller&&(this._controller.editable=!!this.target),super.onTargetUpdate()}createController(){if(_controller)this._controller=_controller;else{const t=this.getGizmoRoot();var e=new rectangle_controller_1.RectangleController(t,{needAnchor:!0});this._controller=_controller=e}const t=this.getGizmoRoot();this._controller.setColor(new cc_1.Color(0,153,255)),this._controller.setEditHandlesColor(new cc_1.Color(0,153,255)),this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this),this._controller.editable=!!this.target,_nodeSnapLinesCtrl?this._nodeSnapLinesCtrl=_nodeSnapLinesCtrl:this._nodeSnapLinesCtrl=_nodeSnapLinesCtrl=new lines_1.default(t),_canvasSnapLinesCtrl?this._canvasSnapLinesCtrl=_canvasSnapLinesCtrl:this._canvasSnapLinesCtrl=_canvasSnapLinesCtrl=new lines_1.default(t),_equalSpacingLinesCtrl?this._equalSpacingLinesCtrl=_equalSpacingLinesCtrl:this._equalSpacingLinesCtrl=_equalSpacingLinesCtrl=new lines_1.default(t,{dashed:!0})}onControllerMouseDown(){this._controller&&this.nodes.length&&(this._controller.contentSizeLocked=this.nodes.some(e=>this.isNodeContentSizeLocked(e)),this._controller.anchorLocked=this.nodes.some(e=>this.isNodeAnchorLocked(e))),this._worldPosList.length=0,this._localPosList.length=0,this._sizeList.length=0,this._anchorList.length=0,this._rectList.length=0,this._validTarget.length=0;var t=this.nodes;for(let e=0;e<t.length;e++){var n=t[e],i=n.getComponent(cc_1.UITransform);i&&(this._validTarget.push(i),this._worldPosList.push(NodeUtils.getWorldPosition3D(n)),this._localPosList.push(n.getPosition()),this._sizeList.push(i.contentSize.clone()),this._anchorList.push(i.anchorPoint.clone()),this._rectList.push(NodeUtils.getWorldBounds(n)))}var e=this._validTarget.map(e=>e.node),e=this.getBounds(!1,!1,e),e=(this._tempRect=boundsToRect(e),this._controller.transformToolData.scale2D),e=rect_transform_snapping_1.rectTransformSnapping.snapThreshold/e;this._snapDistVec2.x=e,this._snapDistVec2.y=e,rect_transform_snapping_1.rectTransformSnapping.enableSnapping&&(e=this.nodes[0])&&e.parent&&(rect_transform_snapping_1.rectTransformSnapping.calculateNodeSnapGuidelines(e.parent,e),rect_transform_snapping_1.rectTransformSnapping.calculateCanvasSnapGuidelines(),rect_transform_snapping_1.rectTransformSnapping.calculateSpacingSnapGuidelines(e.parent,e))}onControllerMouseMove(){this.updateDataFromController()}onControllerMouseUp(e){var t;if(this._controller.updated)this.onControlEnd("position");else{var n=cce.Selection.query();if(1===n.length){var i=(0,window_1.getMainWindowSize)().height-e.y,r=NodeUtils.getRaycastResultNodes(cce.Camera.getCamera(),e.x,i,cc_1.Layers.makeMaskExclude([cc_1.Layers.BitMask.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO])),o=n[0];for(let e=0;e<r.length;e++)if(r[e]&&o===r[e].uuid){e===r.length-1?(cce.Selection.unselect(o),cce.Selection.select(r[0].uuid)):null!=(t=r[e+1])&&t.uuid&&(cce.Selection.unselect(o),cce.Selection.select(r[e+1].uuid));break}}}this.clearNodeSnappingGuideline(),this.clearCanvasSnappingGuideline(),this.clearEqualSpacingGuideline()}onKeyDown(e){return this._altKey=e.altKey,this._shiftKey=e.shiftKey,super.onKeyDown(e)}onKeyUp(e){var t=this._controller.getCurHandleType(),t=this._controller.isCorner(t)||this._controller.isBorder(t);return this._altKey&&!e.altKey&&t&&this._controller.reset(),this._altKey=e.altKey,this._shiftKey=e.shiftKey,super.onKeyUp(e)}handleAreaMove(n){for(let t=0;t<this._validTarget.length;t++){var i=this._validTarget[t].node;if(!this.isNodePositionLocked(i)){this._localPosList[t];var r=this._worldPosList[t];let e=new cc_1.Vec3;cc_1.Vec3.add(e,r,n),0===t&&rect_transform_snapping_1.rectTransformSnapping.enableSnapping&&(r=this._rectList[t],e=rect_transform_snapping_1.rectTransformSnapping.snapPosToNodeGuidelines(e,r,this._snapDistVec2),this.drawNodeSnappingGuideline(),e=rect_transform_snapping_1.rectTransformSnapping.snapPosToCanvasSnapGuidelines(e,r,this._snapDistVec2),this.drawCanvasSnappingGuideline(),e=rect_transform_snapping_1.rectTransformSnapping.snapPosToEqualSpacing(e,r,this._snapDistVec2),this.drawEqualSpacingGuideline()),e.x=EditorMath.toPrecision(e.x,3),e.y=EditorMath.toPrecision(e.y,3),NodeUtils.setWorldPosition(i,e)}}}handleAnchorMove(e){var t,n,i,r,o;1<this._validTarget.length||(n=(t=this._validTarget[0]).node,i=this._sizeList[0],r=this._anchorList[0],o=this._worldPosList[0],e=e.clone(),NodeUtils.makeVec3InPrecision(e,3),tempVec3.set(o),tempVec3.add(e),n.setWorldPosition(tempVec3),n.getWorldMatrix(tempMat4),cc_1.Mat4.invert(tempMat4,tempMat4),tempMat4.m12=tempMat4.m13=0,cc_1.Vec3.transformMat4(e,e,tempMat4),tempVec2.x=e.x/i.width,tempVec2.y=e.y/i.height,tempVec2.add(r),t.anchorPoint=tempVec2)}getSizePoint(e){var t=new cc_1.Vec2,n=this._rectList[0];return e===rectangle_controller_1.RectHandleType.Right||e===rectangle_controller_1.RectHandleType.TopRight||e===rectangle_controller_1.RectHandleType.BottomRight?t.x=n.x+n.width:t.x=n.x,e===rectangle_controller_1.RectHandleType.BottomLeft||e===rectangle_controller_1.RectHandleType.Bottom||e===rectangle_controller_1.RectHandleType.BottomRight?t.y=n.y:t.y=n.y+n.height,t}modifyPosDeltaWithAnchor(e,t,n,i,r){e===rectangle_controller_1.RectHandleType.Right||e===rectangle_controller_1.RectHandleType.TopRight||e===rectangle_controller_1.RectHandleType.BottomRight?(r&&(n.x/=1-i.x),t.x=n.x*i.x):(r&&(n.x/=i.x),t.x=-n.x*(1-i.x)),e===rectangle_controller_1.RectHandleType.Bottom||e===rectangle_controller_1.RectHandleType.BottomRight||e===rectangle_controller_1.RectHandleType.BottomLeft?(r&&(n.y/=i.y),t.y=-n.y*(1-i.y)):(r&&(n.y/=1-i.y),t.y=n.y*i.y)}formatSizeDelta(e,t){e!==rectangle_controller_1.RectHandleType.Left&&e!==rectangle_controller_1.RectHandleType.TopLeft&&e!==rectangle_controller_1.RectHandleType.BottomLeft||(t.x=-t.x),e!==rectangle_controller_1.RectHandleType.Bottom&&e!==rectangle_controller_1.RectHandleType.BottomRight&&e!==rectangle_controller_1.RectHandleType.BottomLeft||(t.y=-t.y)}handleOneTargetSize(e,t,n,i){var r=this._sizeList[0],o=t.clone();let s=new cc_1.Vec2(t.x,t.y);var t=this._localPosList[0],a=this._validTarget[0],c=a.node,l=this._anchorList[0],l=(rect_transform_snapping_1.rectTransformSnapping.enableSnapping&&(this.formatSizeDelta(e,s),s=rect_transform_snapping_1.rectTransformSnapping.snapSizeToNodeGuidelines(this.getSizePoint(e),s,this._snapDistVec2),this.formatSizeDelta(e,s),this.drawNodeSnappingGuideline()),s.x=EditorMath.toPrecision(s.x,3),s.y=EditorMath.toPrecision(s.y,3),this.modifyPosDeltaWithAnchor(e,o,s,l,n),c.parent&&(c.parent.getWorldMatrix(tempMat4),cc_1.Mat4.invert(tempMat4,tempMat4),tempMat4.m12=tempMat4.m13=0,cc_1.Vec3.transformMat4(o,o,tempMat4)),n||(e=tempQuat_a,c.getRotation(e),cc_1.Vec3.transformQuat(o,o,e),o.z=0,tempVec3.set(t),tempVec3.add(o),c.setPosition(tempVec3)),new cc_1.Vec3);c.getWorldScale(l),s.x=s.x/l.x,s.y=s.y/l.y;let h=r.height,_=r.width;i?s.x?(_=r.width+s.x,h=r.width?_/r.width*r.y:_):s.y&&(h=r.height+s.y,_=r.height?h/r.height*r.x:h):(h=r.height+s.y,_=r.width+s.x),a.contentSize=new cc_1.Size(_,h)}handleMultiTargetSize(e,t,n){var i=this._tempRect,r=new cc_1.Vec2(t.x,t.y),t=t.clone(),o=new cc_1.Vec2(0,0),s=(r.x=EditorMath.toPrecision(r.x,3),r.y=EditorMath.toPrecision(r.y,3),this.modifyPosDeltaWithAnchor(e,t,r,o,!1),i.clone());s.x=i.x+t.x,s.y=i.y+t.y,s.width=i.width+r.x,s.height=i.height+r.y,this._editRect=s;for(let e=0,t=this._validTarget.length;e<t;e++){var a=this._validTarget[e],c=a.node,l=this._worldPosList[e],h=(l.x-i.x)/i.width,_=(l.y-i.y)/i.height,h=new cc_1.Vec3(s.x+h*s.width,s.y+_*s.height,l.z),_=(c.setWorldPosition(h),this._rectList[e]),l=_.width/i.width,h=_.height/i.height,_=this._sizeList[e],p=r.clone(),l=(p.x=p.x*l,p.y=p.y*h,new cc_1.Vec3);c.getWorldScale(l),p.x=p.x/l.x,p.y=p.y/l.y,a.contentSize=new cc_1.Size(_.width+p.x,_.height+p.y)}}getBounds(e,t,n){let i=Number.MAX_VALUE,r=-Number.MAX_VALUE,o=Number.MAX_VALUE,s=-Number.MAX_VALUE;function a(e){e.x>r&&(r=e.x),e.x<i&&(i=e.x),e.y>s&&(s=e.y),e.y<o&&(o=e.y)}n.forEach(e=>{e.getComponent(cc_1.UITransform)&&(a((e=NodeUtils.getWorldOrientedBounds(e))[0]),a(e[1]),a(e[2]),a(e[3]))});let c;return e&&(c=i,i=r,r=c),t&&(c=o,o=s,s=c),[new cc_1.Vec2(i,s),new cc_1.Vec2(i,o),new cc_1.Vec2(r,o),new cc_1.Vec2(r,s)]}updateDataFromController(){var e,t,n,i;this._controller.updated&&(this.onControlUpdate("position"),e=(t=this._controller).getCurHandleType(),t=t.getDeltaSize(),e===rectangle_controller_1.RectHandleType.Area?this.handleAreaMove(t):e===rectangle_controller_1.RectHandleType.Anchor?this.handleAnchorMove(t):(n=this._altKey,i=this._shiftKey,1<this.nodes.length?this.handleMultiTargetSize(e,t,n):this.handleOneTargetSize(e,t,n,i)))}updateControllerTransform(){this._controller.editable=!!this.target,this.updateControllerData()}updateControllerData(){var e,t,n,i,r;this._isInitialized&&this.nodes&&0!==this.nodes.length&&((e=this._controller).checkEdit(),1===this.nodes.length?(n=this.nodes[0],i=NodeUtils.getWorldPosition3D(n),t=tempQuat_a,NodeUtils.getWorldRotation3D(n,t),r=NodeUtils.getWorldScale3D(n),e.setPosition(i),e.setRotation(t),e.setScale(r),(i=n.getComponent(cc_1.UITransform))?(t=i.contentSize,r=i.anchorPoint,(n=new cc_1.Vec3).x=(.5-r.x)*t.width,n.y=(.5-r.y)*t.height,e.updateSize(n,new cc_1.Vec2(t.width,t.height))):e.hide()):(i=boundsToRect(this.getBounds(!1,!1,this.nodes)),r=new cc_1.Vec3(i.x+i.width/2,i.y+i.height/2,0),e.setPosition(r),e.setRotation(cc_1.Quat.IDENTITY),e.setScale(new cc_1.Vec3(1,1,1)),e.updateSize(new cc_1.Vec3,new cc_1.Vec2(i.width,i.height))))}drawNodeGuidelineGroup(e){if(e){e=e.currentGuidelines;if(e&&!(e.length<=0)){var t=rect_transform_snapping_1.rectTransformSnapping.guidelineColor;const s=[];e.forEach(e=>{var t,n,i=e.lineVertices.slice(),r=e.checkNode;function o(n){return function(e,t){return e[n]-t[n]}}r&&(t=(r=rect_transform_snapping_1.rectTransformSnapping.getWorldRectEx(r)).center,n=r.width/2,r=r.height/2,"x"===e.axis?(i.push(new cc_1.Vec3(e.value,t.y+r,t.z)),i.push(new cc_1.Vec3(e.value,t.y-r,t.z)),i.sort(o("y"))):"y"===e.axis&&(i.push(new cc_1.Vec3(t.x+n,e.value,t.z)),i.push(new cc_1.Vec3(t.x-n,e.value,t.z)),i.sort(o("x"))),s.push(i[0]),s.push(i[i.length-1]))}),this.drawGuidelines(this._nodeSnapLinesCtrl,s,t)}}}drawNodeSnappingGuideline(){this.clearNodeSnappingGuideline();var e=rect_transform_snapping_1.rectTransformSnapping.nodeSnapGuidelineGroups;this.drawNodeGuidelineGroup(e[0]),this.drawNodeGuidelineGroup(e[1])}clearNodeSnappingGuideline(){this._nodeSnapLinesCtrl.clearData()}getDrawLineVertices(e){if(!e)return null;e=e.currentGuidelines;if(!e||e.length<=0)return null;const t=[];return e.forEach(e=>{e=e.lineVertices;t.push(e[0]),t.push(e[e.length-1])}),t}drawGuidelineGroup(e,t,n=cc_1.Color.RED){if(e){e=e.currentGuidelines;if(e&&!(e.length<=0)){const i=[],r=(e.forEach(e=>{e=e.lineVertices;i.push(e[0]),i.push(e[e.length-1])}),t.setColor(n),[]);i.forEach((e,t)=>{r.push(t)}),t.updateData(i,r)}}}drawGuidelines(e,t,n=cc_1.Color.RED){e.setColor(n);const i=[];t.forEach((e,t)=>{i.push(t)}),e.updateData(t,i)}drawCanvasSnappingGuideline(){this.clearCanvasSnappingGuideline();var e=rect_transform_snapping_1.rectTransformSnapping.canvasSnapGuidelineGroups,t=rect_transform_snapping_1.rectTransformSnapping.canvasSnapColor,n=[],i=this.getDrawLineVertices(e[0]);i&&n.push(...i),(i=this.getDrawLineVertices(e[1]))&&n.push(...i),this.drawGuidelines(this._canvasSnapLinesCtrl,n,t)}clearCanvasSnappingGuideline(){this._canvasSnapLinesCtrl.clearData()}drawEqualSpacingGuideline(){this.clearEqualSpacingGuideline();var e=rect_transform_snapping_1.rectTransformSnapping.currentMatchMinDistInfos,t=rect_transform_snapping_1.rectTransformSnapping.guidelineColor;const i=[];e.forEach(e=>{var t=e.minDistPosA,n=e.minDistPosB;i.push(t),i.push(n),"x"===e.axis?(i.push(new cc_1.Vec3(t.x,t.y+10)),i.push(new cc_1.Vec3(t.x,t.y-10)),i.push(new cc_1.Vec3(n.x,n.y+10)),i.push(new cc_1.Vec3(n.x,n.y-10))):"y"===e.axis&&(i.push(new cc_1.Vec3(t.x-10,t.y)),i.push(new cc_1.Vec3(t.x+10,t.y)),i.push(new cc_1.Vec3(n.x-10,n.y)),i.push(new cc_1.Vec3(n.x+10,n.y)))}),this.drawGuidelines(this._equalSpacingLinesCtrl,i,t)}clearEqualSpacingGuideline(){this._equalSpacingLinesCtrl.clearData()}}exports.default=RectGizmo;