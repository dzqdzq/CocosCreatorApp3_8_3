"use strict";var SnapMode,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),utils_1=require("../../../3d/manager/camera/utils"),window_1=require("../../../utils/window"),utils_2=__importDefault(require("../utils")),engine_1=__importDefault(require("../utils/engine")),external_1=__importDefault(require("../utils/external")),position_controller_1=__importDefault(require("./position-controller")),transform_base_1=__importDefault(require("./transform-base")),NodeUtils=external_1.default.NodeUtils,EditorCamera=external_1.default.EditorCamera,GizmoUtils=utils_2.default.GizmoUtils,{raycastAllColliders,raycast}=engine_1.default,TempVec3A=new cc_1.Vec3,TempVec3B=new cc_1.Vec3,TempQuatA=new cc_1.Quat,ArrowKeys=Object.keys({arrowleft:1,arrowright:1,arrowdown:1,arrowup:1});!function(e){e[e.Undefined=0]="Undefined",e[e.Grid=1]="Grid",e[e.Surface=2]="Surface",e[e.Vertex=3]="Vertex"}(SnapMode=SnapMode||{});let _controller;class PositionGizmo extends transform_base_1.default{constructor(){super(...arguments),this.disableUndo=!1,this._nodesWorldPosList=[],this._snapMode=SnapMode.Undefined,this._snapMouseDown=!1,this._handler=null,this._event=null,this._mouseDown=!1,this._nodeToSnapVertex=new cc_1.Vec3(0,0,0),this._gizmoMouseEventListeners={}}getFirstLockNode(){return this.nodes.find(e=>this.isNodeLocked(e))}isNodeLocked(e){return!!e&&e.components.some(e=>e._objFlags&cc_1.CCObject.Flags.IsPositionLocked)}init(){this.createController()}layer(){return"foreground"}onTargetUpdate(){_controller&&((this._controller=_controller).onControllerMouseDown=this.onControllerMouseDown.bind(this),_controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),_controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)),super.onTargetUpdate()}createController(){var e;_controller?this._controller=_controller:(e=new position_controller_1.default(this.getGizmoRoot()),this._controller=_controller=e),this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)}get controller(){return _controller}set controller(e){_controller=e}addMouseEventListener(e){var o=(1e6*performance.now()).toString();return this._gizmoMouseEventListeners[o]=e,o}removeMouseEventListener(e){e in this._gizmoMouseEventListeners&&delete this._gizmoMouseEventListeners[e]}checkLock(e){var o,t,n;_controller&&(o=_controller.transformToolData.snapConfigs,t="center"===_controller.transformToolData.pivot,n=this.nodes.some(e=>this.isNodeLocked(e)),e=this.isControlKeyPressed(e)||o.isPositionSnapEnabled,_controller.isLock=t||n||e)}onControllerMouseDown(t){this.checkLock(t),utils_1.CameraUtils.showSnapTip(),this._mouseDown=!0,this._snapMode!==SnapMode.Surface&&this._snapMode!==SnapMode.Vertex||(this._snapMouseDown=!0),this._nodesWorldPosList.length=0;var o=this.nodes;for(let e=0;e<o.length;++e)this._nodesWorldPosList.push(NodeUtils.getWorldPosition3D(o[e]));Object.values(this._gizmoMouseEventListeners).forEach(e=>{var o;return null==(o=e.onControllerMouseDown)?void 0:o.call(e,t)})}onControllerMouseMove(t){this.checkLock(t),this.updateDataFromController(t),this.onVertexSnapMove(t),Object.values(this._gizmoMouseEventListeners).forEach(e=>{var o;return null==(o=e.onControllerMouseMove)?void 0:o.call(e,t)})}onControllerMouseUp(t){utils_1.CameraUtils.hideSnapTip(),this._mouseDown=!1,this._snapMouseDown=!1,_controller.updated&&!this.disableUndo&&this.onControlEnd("position"),this.nodes.every(e=>!this.isNodeLocked(e))&&this.updateControllerTransform(),this._handler&&(clearTimeout(this._handler),this._handler=null),Object.values(this._gizmoMouseEventListeners).forEach(e=>{var o;return null==(o=e.onControllerMouseUp)?void 0:o.call(e,t)})}onKeyDown(e){if(this.nodes.length)return!!(this.onArrowDown(e)&&this.onSurfaceSnapDown(e)&&this.onVertexSnapDown(e))&&super.onKeyDown(e)}onKeyUp(e){return!this.nodes.length||!!this.onArrowUp(e)&&!!this.onSurfaceSnapUp(e)&&!!this.onVertexSnapUp(e)&&super.onKeyUp(e)}applySnapIncrement(e,o,t){if(null!=e||(e=new cc_1.Vec3),position_controller_1.default.isPlane(t)||position_controller_1.default.isXYZ(t)){var n,r=new cc_1.Vec3;for(const s of t)position_controller_1.default.isXYZ(s)&&(n=_controller.getDeltaPositionOfAxis(new cc_1.Vec3,s),r.add(this.applySnapIncrementForAxis(n,n,o,s)));e.set(r)}return e}applySnapIncrementForAxis(e,o,t,n){null==e&&(e=new cc_1.Vec3);var r=o.length();return cc_1.Vec3.normalize(e,o).multiplyScalar(this.getSnappedValue(r,t[n])),e}updateDataFromController(e){if(_controller.updated){this.disableUndo||this.onControlUpdate("position"),this._event=e;let s=this._mouseDown&&"center"===_controller.transformToolData.pivot;this._handler||(this._handler=setTimeout(()=>{var o=_controller.getDeltaPosition(),t=this.nodes,n=TempVec3A,e=(this.updateSnapPosition(o,this._event),o.equals(cc_1.Vec3.ZERO));if(!(this._snapMode===SnapMode.Surface||this._snapMode===SnapMode.Vertex)||!e){for(let e=0;e<this._nodesWorldPosList.length;++e){var r=t[e];n.set(this._nodesWorldPosList[e]),n.add(o),NodeUtils.setWorldPosition3D(r,n),TempVec3B.set(r.position),NodeUtils.makeVec3InPrecision(TempVec3B,3),r.position=TempVec3B}s=!0}s&&this.updateControllerTransform(!0),this._handler=null},16)),s&&this.updateControllerTransform(!0)}}updateControllerTransform(o){var t=null!=(t=this.getFirstLockNode())?t:this.nodes[0];if(t&&(o||!this._mouseDown||this._snapMouseDown)){let e;o=TempQuatA;cc_1.Quat.identity(o),e="center"===_controller.transformToolData.pivot?GizmoUtils.getCenterWorldPos3D(this.nodes):NodeUtils.getWorldPosition3D(t),this._snapMouseDown&&e.add(this._nodeToSnapVertex),"global"!==_controller.transformToolData.coordinate&&NodeUtils.getWorldRotation3D(t,o),_controller.setPosition(e),_controller.setRotation(o)}}onArrowDown(e){var o=e.key.toLowerCase();if(!ArrowKeys.includes(o))return!0;e=e.shiftKey?10:1;const t=(0,cc_1.v3)(),n=("arrowleft"===o?t.x=-e:"arrowright"===o?t.x=e:"arrowup"===o?t.y=e:"arrowdown"===o&&(t.y=-e),this.disableUndo||this.onControlUpdate("position"),(0,cc_1.v3)());return this.nodes.forEach(e=>{e.getPosition(n),n.add(t),e.setPosition(n.x,n.y,n.z)}),utils_2.default.repaintEngine(),!1}onArrowUp(e){e=e.key.toLowerCase();return!ArrowKeys.includes(e)||(this.disableUndo||this.onControlEnd("position"),!1)}onSurfaceSnapDown(e){return!e.shiftKey||!e.ctrlKey||(17===e.keyCode||16===e.keyCode?(this._snapMode=SnapMode.Surface,this.updateSnapUI(!0)):(this._snapMode=SnapMode.Undefined,this.updateSnapUI(!1)),!1)}onSurfaceSnapUp(e){return!!(e.shiftKey&&e.ctrlKey||this._snapMode!==SnapMode.Surface)||(this._snapMode=SnapMode.Undefined,this.updateSnapUI(!1),!1)}onVertexSnapDown(e){var o=e.key.toLowerCase();return e.ctrlKey||e.shiftKey||e.metaKey||e.altKey?(this._snapMode===SnapMode.Vertex&&(this._snapMode=SnapMode.Undefined,this.updateSnapUI(!1)),!0):"v"!==o||(this._snapMode=SnapMode.Vertex,this.updateSnapUI(!0),!1)}onVertexSnapUp(e){var o=e.key.toLowerCase();return!!(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey)||"v"!==o||(this._snapMode=SnapMode.Undefined,this.updateSnapUI(!1),!1)}updateSnapUI(e){e||(this._nodeToSnapVertex.set(0,0,0),this._mouseDown&&!this._snapMouseDown)||this.updateControllerTransform(),_controller.updateSnapUI(e),utils_2.default.repaintEngine()}updateSnapPosition(e,o){var t,n,r=(0,window_1.getMainWindowSize)();this._snapMode===SnapMode.Surface?(e.set(0,0,0),this._snapMouseDown&&(t=raycastAllColliders(EditorCamera.getCamera(),o.x,o.y),(t=this.getNodeExcludeTarget(t))?(t=t.hitPoint,this.calculateDeltaPos(e,t)):(t=o.x,n=r.height-o.y,t=NodeUtils.getRaycastResultsForSnap(EditorCamera.getCamera(),t,n,cc_1.Layers.makeMaskExclude([cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO,cc_1.Layers.Enum.EDITOR])),(n=this.getNodeExcludeTarget(t))&&(t=n.hitPoint,this.calculateDeltaPos(e,t))))):this._snapMode===SnapMode.Vertex?(e.set(0,0,0),this._snapMouseDown&&(n=o.x,t=r.height-o.y,r=NodeUtils.getRaycastResultNodes(EditorCamera.getCamera(),n,t,cc_1.Layers.makeMaskExclude([cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO,cc_1.Layers.Enum.EDITOR])),n=this.getNodeExcludeTarget(r))&&0<(t=NodeUtils.getMeshVertexAroundMouse(n,EditorCamera.getCamera(),o.x,o.y,100)).length&&(r=t[0],t=n.getWorldMatrix(),n=new cc_1.Vec3,cc_1.Vec3.transformMat4(n,new cc_1.Vec3(r.x,r.y,r.z),t),this.calculateDeltaPos(e,n))):(r=_controller.transformToolData.snapConfigs,(this.isControlKeyPressed(o)||r.isPositionSnapEnabled)&&(this.applySnapIncrement(e,r.position,o.handleName),this.updateControllerTransform(!0)))}updateVertexPos(e){var o,t=this.nodes[0],e=NodeUtils.getMeshVertexAroundMouse(t,EditorCamera.getCamera(),e.x,e.y,30);0<e.length&&(e=e[0],o=t.getWorldRS(),this._nodeToSnapVertex=new cc_1.Vec3(e.x,e.y,e.z).transformMat4(o),o=t.getWorldMatrix(),t=new cc_1.Vec3,cc_1.Vec3.transformMat4(t,e,o),this.setGizmoPosition(t))}onVertexSnapMove(e){if(!this._snapMouseDown&&(this._snapMode===SnapMode.Vertex||this._snapMode===SnapMode.Surface))return this.updateVertexPos(e),!1}setGizmoPosition(e){var o;null!=(o=null===_controller||void 0===_controller?void 0:_controller.shape)&&o.setPosition(e),utils_2.default.repaintEngine()}calculateDeltaPos(e,o){var o=new cc_1.Vec3(o),t=this._nodesWorldPosList[0];e.set(o.subtract(this._nodeToSnapVertex).subtract(t))}getNodeExcludeTarget(t){let n=null;if(t)for(let o=0;o<t.length;o++){n=t[o];let e=cc_1.Node.isNode(n)?n:n.node;if(e=e||n.collider.node,!this.nodes.includes(e))break;n=null}return n}drawHitPoint(e){cce.Engine.getGeometryRenderer().removeData("addSphere"),cce.Engine.getGeometryRenderer().addSphere(e,.1,new cc_1.Color(255,0,0))}}exports.default=PositionGizmo;