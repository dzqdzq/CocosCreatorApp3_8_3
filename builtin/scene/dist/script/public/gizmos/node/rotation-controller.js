"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const base_1=__importDefault(require("../controller/base")),controller_shape_1=__importDefault(require("../utils/controller-shape")),controller_utils_1=__importDefault(require("../utils/controller-utils")),engine_1=__importDefault(require("../utils/engine")),utils_1=__importDefault(require("../utils")),external_1=__importDefault(require("../utils/external")),cc_1=require("cc"),{AttributeName,setNodeOpacity,getModel,updateIB,updatePositions,create3DNode,panPlaneLayer,getRaycastResults,setMeshColor}=engine_1.default,NodeUtils=external_1.default.NodeUtils,EditorMath=external_1.default.EditorMath,EditorCamera=external_1.default.EditorCamera,tempVec3_a=new cc_1.Vec3,tempVec3_b=new cc_1.Vec3,tempVec3_c=new cc_1.Vec3,tempVec3_d=new cc_1.Vec3,tempQuat=new cc_1.Quat,tempMat4=new cc_1.Mat4;class RotationController extends base_1.default{get transformAxisDir(){return this._transformAxisDir}get indicatorStartDir(){return this._indicatorStartDir}constructor(t){super(t),this._deltaRotation=new cc_1.Quat(0,0,0,1),this._rotFactor=3,this._baseRadius=100,this._tubeRadius=3,this._circleBorderMR=null,this._cutoffNode=null,this._cutoffMR=null,this._indicator={},this._mouseDownRot=new cc_1.Quat,this._mouseDeltaPos=new cc_1.Vec2(0,0),this._indicatorStartDir=new cc_1.Vec3,this._rotateAlignDir=new cc_1.Vec3,this._transformAxisDir=new cc_1.Vec3,this._axisDir={},this._deltaAngle=0,this._handleAxisDir=new cc_1.Vec3,this._graduationNode=null,this._graduationMR=null,this._axisDir.x=new cc_1.Vec3(1,0,0),this._axisDir.y=new cc_1.Vec3(0,1,0),this._axisDir.z=new cc_1.Vec3(0,0,1),this._axisDir.w=new cc_1.Vec3(0,0,1),this.initShape()}createRotationShape(t,e,a,i,o,s){var r=this._baseRadius,c=this._tubeRadius,n=create3DNode(t+"Rotation"),c=(n.parent=this.shape,controller_utils_1.default.torus(r,c,{arc:Math.abs(o)},s)),c=(c.name=t+"RotationTorus",c.parent=n,setNodeOpacity(c,0),NodeUtils.setEulerAngles(c,e),controller_utils_1.default.arrow(25,10,140,s)),e=(c.name=t+"Axis",c.parent=n,NodeUtils.setEulerAngles(c,a),controller_utils_1.default.arc((0,cc_1.v3)(),this._axisDir[t],i,o,r,s,{noDepthTestForLines:!0})),a=(e.parent=n,e.name=t+"RotationArc",controller_utils_1.default.arc((0,cc_1.v3)(),this._axisDir[t],i,this._twoPI,r,s,{noDepthTestForLines:!0})),o=(a.parent=n,a.active=!1,a.name=t+"IndicatorCircle",this.initHandle(n,t));o&&(o.normalTorusNode=e,o.indicatorCircle=a,o.arrowNode=c,o.arrowNode.active=!1,o.normalTorusMR=getModel(o.normalTorusNode))}createGraduationShape(t,e){this._graduationNode=controller_utils_1.default.lines([new cc_1.Vec3(0,0,0),new cc_1.Vec3(0,0,0)],[0,1],e,{noDepthTestForLines:!0}),this._graduationNode.parent=t,this._graduationMR=getModel(this._graduationNode)}updateGraduation(t,e,a){cc_1.Vec3.normalize(tempVec3_a,e),cc_1.Vec3.normalize(tempVec3_b,t);var i=Math.round(360/a),o=tempQuat,s=(cc_1.Quat.fromAxisAngle(o,tempVec3_b,EditorMath.deg2rad(a)),tempVec3_c),r=this.getPosition(),c=(cc_1.Vec3.multiplyScalar(s,tempVec3_a,this._baseRadius*this.getDistScalar()),tempVec3_d),n=(cc_1.Vec3.multiplyScalar(c,tempVec3_a,(this._baseRadius-15)*this.getDistScalar()),[]),l=[];for(let t=0;t<i;t++)n[t]=r.clone(),l[t]=r.clone(),n[t].add(s),l[t].add(c),cc_1.Vec3.transformQuat(s,s,o),cc_1.Vec3.transformQuat(c,c,o);var h=[],_=[];for(let t=0;t<i;t++)h.push(n[t]),h.push(l[t]),_.push(2*t,2*t+1);this._graduationMR&&(e=controller_shape_1.default.calcLinesData(h,_),updatePositions(this._graduationMR,e.positions),updateIB(this._graduationMR,e.indices||[]))}setGraduation(t){this.updateGraduation(this._transformAxisDir,this._indicatorStartDir,t)}showGraduation(){this._graduationNode&&(this._graduationNode.active=!0)}hideGraduation(){this._graduationNode&&(this._graduationNode.active=!1)}initShape(){this.createShapeNode("RotationController"),this.registerEvents(),this._baseRadius=100,this._tubeRadius=5,this.createRotationShape("x",(0,cc_1.v3)(0,0,90),(0,cc_1.v3)(-90,-90,0),this._axisDir.z,-this._twoPI,cc_1.Color.RED),this.createRotationShape("y",(0,cc_1.v3)(0,0,0),(0,cc_1.v3)(0,0,0),this._axisDir.z,this._twoPI,cc_1.Color.GREEN),this.createRotationShape("z",(0,cc_1.v3)(-90,0,0),(0,cc_1.v3)(90,0,90),this._axisDir.x,this._twoPI,cc_1.Color.BLUE),this.createRotationShape("w",(0,cc_1.v3)(-90,0,0),(0,cc_1.v3)(0,0,-90),this._axisDir.x,this._twoPI,cc_1.Color.BLUE);var t=EditorCamera.camera.node.getWorldRotation(tempQuat),e=(0,cc_1.v3)(),t=(cc_1.Vec3.transformQuat(e,(0,cc_1.v3)(0,0,1),t),controller_utils_1.default.circle((0,cc_1.v3)(),e,this._baseRadius,cc_1.Color.GRAY)),e=(t.name="circleBorder",t.parent=this._rootNode,setNodeOpacity(t,200),this._circleBorderNode=t,this._circleBorderMR=getModel(t),this._circleBorderNode.setWorldPosition(this.getPosition()),controller_utils_1.default.disc((0,cc_1.v3)(),cc_1.Vec3.UNIT_Z,this._baseRadius,cc_1.Color.RED)),t=(setNodeOpacity(e,0),e.name="cutoff",e.parent=this._rootNode,e.layer=panPlaneLayer,this._cutoffNode=e,this._cutoffMR=getModel(e),{});t.sectorNode=controller_utils_1.default.sector((0,cc_1.v3)(),(0,cc_1.v3)(0,1,0),(0,cc_1.v3)(1,0,0),Math.PI,this._baseRadius,cc_1.Color.YELLOW,{unlit:!0}),setNodeOpacity(t.sectorNode,200),t.sectorNode.parent=this._rootNode,t.sectorNode.active=!1,t.meshRenderer=getModel(t.sectorNode),this._indicator=t,this.createGraduationShape(this._rootNode,cc_1.Color.YELLOW),this.hideGraduation(),this.shape.active=!1}isHitOnAxisArrow(e,t){var a=this._handleDataMap[t].arrowNode;for(let t=0;t<a.children.length;t++)if(e===a.children[t])return!0;return!1}isInCutoffBack(t,e,a){t=this._handleDataMap[t].normalTorusNode;if(0<(o=getRaycastResults(this._cutoffNode,e,a)).length){var i=o[0].distance,o=getRaycastResults(t,e,a);if(0<o.length)if(i<o[0].distance)return!0}return!1}onMouseDown(e){var t,a,i,o;!this.transformToolData.is2D&&this.isInCutoffBack(e.handleName,e.x,e.y)?this._isMouseDown=!1:(this._mouseDownRot=cc_1.Quat.clone(this.getRotation()),this._mouseDeltaPos=(0,cc_1.v2)(0,0),t=e.hitPoint,cc_1.Vec3.copy(this._handleAxisDir,this._axisDir[e.handleName]),a=cc_1.Vec3.clone(this._handleAxisDir),i=(0,cc_1.v3)(),o=(0,cc_1.v3)(),this._indicatorStartDir=(0,cc_1.v3)(),this._deltaAngle=0,this.transformToolData.is2D?(this.isHitOnAxisArrow(e.node,e.handleName)?cc_1.Vec3.transformQuat(i,(0,cc_1.v3)(1,0,0),this.getRotation()):cc_1.Vec3.subtract(i,t,this.getPosition()),cc_1.Vec3.transformQuat(this._indicatorStartDir,(0,cc_1.v3)(1,0,0),this.getRotation())):(cc_1.Vec3.subtract(i,t,this.getPosition()),this._indicatorStartDir=i),cc_1.Vec3.normalize(i,i),cc_1.Vec3.transformQuat(a,a,this.getRotation()),cc_1.Vec3.cross(o,i,a),cc_1.Vec3.cross(i,a,o),this._rotateAlignDir=o,this._transformAxisDir=a,this.updateRotationIndicator(this._transformAxisDir,this._indicatorStartDir,0),this._indicator.sectorNode.active=!0,this._handleDataMap[e.handleName].indicatorCircle.active=!0,this._circleBorderNode.active=!1,Object.keys(this._handleDataMap).forEach(t=>{t===e.handleName?(this._handleDataMap[t].normalTorusNode.active=!1,this._handleDataMap[t].arrowNode.active=!0):this._handleDataMap[t].topNode.active=!1}),utils_1.default.requestPointerLock(),this.onControllerMouseDown&&this.onControllerMouseDown(e))}onMouseMove(e){if(this._isMouseDown){var a=EditorMath.clamp(e.moveDeltaX,-10,10),i=EditorMath.clamp(e.moveDeltaY,-10,10);this._mouseDeltaPos.x+=a,this._mouseDeltaPos.y+=i,cc_1.Quat.identity(this._deltaRotation);let t=0;1===e.handleName.length&&(a=this.getAlignAxisMoveDistance(this._rotateAlignDir,this._mouseDeltaPos),this._deltaAngle=-a/this._rotFactor,t=this._deltaAngle*this._degreeToRadianFactor,cc_1.Vec3.copy(this._handleAxisDir,this._axisDir[e.handleName]),cc_1.Quat.fromAxisAngle(this._deltaRotation,this._handleAxisDir,t)),this.updateRotationIndicator(this._transformAxisDir,this._indicatorStartDir,t);i=this.getRotation();cc_1.Quat.multiply(i,this._mouseDownRot,this._deltaRotation),this.isLock?this.onControllerMouseMove&&this.onControllerMouseMove(e):(this.setRotation(i),this.onControllerMouseMove&&this.onControllerMouseMove(e),this.updateController())}}resetAllHandelNodes(){this.transformToolData.is2D?(this._handleDataMap.w.indicatorCircle.active=!1,this._handleDataMap.w.normalTorusNode.active=!0,this._handleDataMap.w.topNode.active=!0):Object.keys(this._handleDataMap).forEach(t=>{"w"!==t&&(this._handleDataMap[t].normalTorusNode.active=!0,this._handleDataMap[t].topNode.active=!0,this._handleDataMap[t].indicatorCircle.active=!1,this._handleDataMap[t].arrowNode.active=!1)})}onMouseUp(t){utils_1.default.exitPointerLock(),this._indicator.sectorNode.active=!1,cc_1.Quat.identity(this._deltaRotation),this.transformToolData.is2D||(this._circleBorderNode.active=!0),this.resetAllHandelNodes(),this.onControllerMouseUp&&this.onControllerMouseUp(t),this._handleAxisDir.set(0,0,0)}onMouseLeave(t){this.onMouseUp(t)}onHoverIn(e){!this.transformToolData.is2D&&this.isInCutoffBack(e.handleName,e.x,e.y)||(this.setHandleColor(e.handleName,cc_1.Color.YELLOW),Object.keys(this._handleDataMap).forEach(t=>{t!==e.handleName&&this.setNodesOpacity(this._handleDataMap[t].rendererNodes,50)}))}onHoverOut(){this.resetHandleColor(),Object.keys(this._handleDataMap).forEach(t=>{this.setNodesOpacity(this._handleDataMap[t].rendererNodes,255)})}setNodesOpacity(t,e){t.forEach(t=>{setNodeOpacity(t,e)})}getDeltaRotation(){return this._deltaRotation}getDeltaAngle(){return this._deltaAngle}getHandleAxisDir(){return this._handleAxisDir}onShow(){this.registerEvents(),this.transformToolData.is2D?(this._handleDataMap.x.topNode.active=!1,this._handleDataMap.y.topNode.active=!1,this._handleDataMap.z.topNode.active=!1,this._handleDataMap.w.topNode.active=!0,this._handleDataMap.w.arrowNode.active=!0,this._circleBorderNode.active=!1,this._cutoffNode.active=!1,this.updateController()):(this._handleDataMap.x.topNode.active=!0,this._handleDataMap.y.topNode.active=!0,this._handleDataMap.z.topNode.active=!0,this._handleDataMap.w.topNode.active=!1,this._handleDataMap.w.arrowNode.active=!1,this._circleBorderNode.active=!0,this._cutoffNode.active=!0)}onHide(){this.unregisterEvents(),utils_1.default.exitPointerLock(),this._indicator.sectorNode.active=!1,this._circleBorderNode.active=!1,this._cutoffNode.active=!1,this.resetAllHandelNodes()}updateRotationIndicator(t,e,a){t=controller_shape_1.default.calcSectorPoints(this.getPosition(),t,e,a,this._baseRadius*this.getDistScalar(),60);updatePositions(this._indicator.meshRenderer,t)}adjustControllerSize(){var t=this.getDistScalar(),e=this.getScale(),a=tempVec3_a;cc_1.Vec3.copy(a,e),a.multiplyScalar(t),this.shape.setScale(a),this._circleBorderNode.setScale(a),this._circleBorderNode.setWorldPosition(this.getPosition());e=EditorCamera.camera.node.getWorldRotation(tempQuat),t=tempVec3_b;cc_1.Vec3.transformQuat(t,cc_1.Vec3.UNIT_Z,e);let i=controller_shape_1.default.calcCirclePoints(cc_1.Vec3.ZERO,t,this._baseRadius);updatePositions(this._circleBorderMR,i),this._cutoffNode.setScale(a),this._cutoffNode.setWorldPosition(this.getPosition()),this._cutoffNode.setWorldRotation(e);const o=tempVec3_b;a=tempMat4;this.shape.getWorldMatrix(a),cc_1.Mat4.invert(a,a),cc_1.Vec3.transformMat4Normal(o,t,a),this.transformToolData.is2D||Object.keys(this._handleDataMap).forEach(t=>{var e,a;"w"!==t&&(e=tempVec3_c,a=this._axisDir[t],cc_1.Vec3.cross(e,a,o),cc_1.Vec3.normalize(e,e),i=controller_shape_1.default.calcArcPoints(cc_1.Vec3.ZERO,a,e,-Math.PI,this._baseRadius),a=this._handleDataMap[t],updatePositions(a.normalTorusMR,i))})}}exports.default=RotationController;