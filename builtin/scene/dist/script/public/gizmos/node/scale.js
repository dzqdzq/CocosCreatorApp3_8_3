"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const utils_1=__importDefault(require("../utils")),external_1=__importDefault(require("../utils/external")),NodeUtils=external_1.default.NodeUtils,GizmoUtils=utils_1.default.GizmoUtils,transform_base_1=__importDefault(require("./transform-base")),scale_controller_1=__importDefault(require("./scale-controller")),cc_1=require("cc"),tempQuat_a=new cc_1.Quat;let _controller;class ScaleGizmo extends transform_base_1.default{constructor(){super(...arguments),this._localScaleList=[],this._offsetList=[],this._center=new cc_1.Vec3}isNodeLocked(t){return!!t&&t.components.some(t=>t._objFlags&cc_1.CCObject.Flags.IsScaleLocked)}init(){this.createController()}layer(){return"foreground"}onTargetUpdate(){_controller&&((this._controller=_controller).onControllerMouseDown=this.onControllerMouseDown.bind(this),_controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),_controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)),super.onTargetUpdate()}createController(){_controller?this._controller=_controller:this._controller=_controller=new scale_controller_1.default(this.getGizmoRoot()),this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)}onControllerMouseDown(){this._controller&&(this._controller.isLock=this.nodes.some(t=>this.isNodeLocked(t))),this._localScaleList=[];var o=this.nodes;for(let t=0;t<o.length;++t){var e=o[t],r=(0,cc_1.v3)();e.getScale(r),this._localScaleList.push(r)}if("center"===this._controller.transformToolData.pivot){this._center=GizmoUtils.getCenterWorldPos3D(this.nodes);for(let t=this._offsetList.length=0;t<o.length;++t){var l=NodeUtils.getWorldPosition3D(o[t]),l=new cc_1.Vec3(l);l.subtract(this._center),this._offsetList.push(l)}}}onControllerMouseMove(t){this.updateDataFromController(t)}onControllerMouseUp(){this._controller.updated&&this.onControlEnd("scale")}onKeyDown(t){if(!this.nodes||0===this.nodes.length)return!0;var o=t.key.toLowerCase();if("arrowleft"!==o&&"arrowright"!==o&&"arrowup"!==o&&"arrowdown"!==o)return super.onKeyUp(t);t=t.shiftKey?1:.1;const e=(0,cc_1.v2)(),r=("arrowleft"===o?e.x=-1*t:"arrowright"===o?e.x=t:"arrowup"===o?e.y=t:"arrowdown"===o&&(e.y=-1*t),this.onControlUpdate("scale"),(0,cc_1.v3)());return this.nodes.forEach(t=>{t.getScale(r),r.x=r.x+e.x,r.y=r.y+e.y,this.setScaleWithPrecision(t,r,3)}),utils_1.default.repaintEngine(),!1}onKeyUp(t){var o;return!this.nodes||("arrowleft"!==(o=t.key.toLowerCase())&&"arrowright"!==o&&"arrowup"!==o&&"arrowdown"!==o?super.onKeyUp(t):(this.onControlEnd("scale"),!1))}setScaleWithPrecision(t,o,e){o=NodeUtils.makeVec3InPrecision(o,e),t.setScale(o.x,o.y,o.z)}checkSnap(o,e){var r=this._controller,l=r.moveAxisName;if(l){let t=0;t="xyz"===l?o.x:o[l],t=this.getSnappedValue(t,e),"xyz"===l?(o.x=t,o.y=t,o.z=t):o[l]=t;e=t*r.scaleFactor;r.onAxisSliderMove(l,e)}}updateDataFromController(o){if(this._controller.updated){this.onControlUpdate("scale");let t;var e,r=this._controller.getDeltaScale(),l=this._controller.transformToolData.snapConfigs,s=((this.isControlKeyPressed(o)||l.isScaleSnapEnabled)&&this.checkSnap(r,l.scale),(0,cc_1.v3)(1+r.x,1+r.y,1+r.z)),n=(0,cc_1.v3)(),i=this.nodes,a=new cc_1.Vec3;for(t=0;t<this._localScaleList.length;++t)n.x=this._localScaleList[t].x*s.x,n.y=this._localScaleList[t].y*s.y,n.z=this._localScaleList[t].z*s.z,this.setScaleWithPrecision(i[t],n,3),"center"===this._controller.transformToolData.pivot&&(e=(0,cc_1.v3)(this._offsetList[t].x*s.x,this._offsetList[t].y*s.y,this._offsetList[t].z*s.z),a.set(this._center),a.add(e),NodeUtils.setWorldPosition3D(i[t],a))}}updateControllerTransform(){var o=this.nodes[0];if(o){let t;var e=tempQuat_a;t="center"===this._controller.transformToolData.pivot?GizmoUtils.getCenterWorldPos3D(this.nodes):NodeUtils.getWorldPosition3D(o),NodeUtils.getWorldRotation3D(o,e),this._controller.setPosition(t),this._controller.setRotation(e)}}}exports.default=ScaleGizmo;