"use strict";var RectHandleType,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.RectHandleType=exports.RectangleController=void 0;const cc_1=require("cc"),editable_1=__importDefault(require("../controller/editable")),controller_shape_1=__importDefault(require("../utils/controller-shape")),controller_utils_1=__importDefault(require("../utils/controller-utils")),engine_1=__importDefault(require("../utils/engine")),external_1=__importDefault(require("../utils/external")),{AttributeName,getModel,updatePositions,setMeshColor,setNodeOpacity,getNodeOpacity,panPlaneLayer,updateBoundingBox}=engine_1.default,EditorCamera=external_1.default.EditorCamera,tempVec3=new cc_1.Vec3,tempQuat_a=new cc_1.Quat;!function(e){e.None="none",e.TopLeft="tl",e.TopRight="tr",e.BottomLeft="bl",e.BottomRight="br",e.Left="neg_x",e.Right="x",e.Top="y",e.Bottom="neg_y",e.Area="area",e.Anchor="anchor"}(RectHandleType=RectHandleType||{}),exports.RectHandleType=RectHandleType;class RectangleController extends editable_1.default{constructor(e,t={}){super(e),this.anchorLocked=!1,this.contentSizeLocked=!1,this._center=new cc_1.Vec3,this._size=new cc_1.Vec2(100,100),this._deltaSize=new cc_1.Vec3,this._curHandleType=RectHandleType.None,this._rectNode=null,this._panPlane=null,this._areaMR=null,this._rectMR=null,this._mouseDownOnPlanePos=new cc_1.Vec3,this._areaColor=cc_1.Color.GREEN,this._areaOpacity=0,this._axisDir={},this._defaultEditHandleSize=10,this._axisDir.x=new cc_1.Vec3(1,0,0),this._axisDir.y=new cc_1.Vec3(0,1,0),this._axisDir[RectHandleType.Left]=new cc_1.Vec3(-1,0,0),this._axisDir[RectHandleType.Bottom]=new cc_1.Vec3(0,-1,0),this._axisDir[RectHandleType.TopLeft]=new cc_1.Vec3(-1,1,0),this._axisDir[RectHandleType.TopRight]=new cc_1.Vec3(1,1,0),this._axisDir[RectHandleType.BottomLeft]=new cc_1.Vec3(-1,-1,0),this._axisDir[RectHandleType.BottomRight]=new cc_1.Vec3(1,-1,0),t.needAnchor&&(this._axisDir[RectHandleType.Anchor]=new cc_1.Vec3),this._editHandleKeys=Object.keys(this._axisDir),this._hoverColor=cc_1.Color.YELLOW,this.initShape()}setColor(e){this._rectNode&&(this._color=e,setMeshColor(this._rectNode,e))}setOpacity(e){this._rectNode&&setNodeOpacity(this._rectNode,e)}setAreaColor(e){this._areaColor=e,this._areaNode&&setMeshColor(this._areaNode,e)}setAreaOpacity(e){this._areaOpacity=e,this._areaNode&&setNodeOpacity(this._areaNode,e)}isBorder(e){return e===RectHandleType.Left||e===RectHandleType.Right||e===RectHandleType.Top||e===RectHandleType.Bottom}isCorner(e){return e===RectHandleType.TopLeft||e===RectHandleType.TopRight||e===RectHandleType.BottomLeft||e===RectHandleType.BottomRight}isAreaOrAnchor(e){return e===RectHandleType.Area||e===RectHandleType.Anchor}onInitEditHandles(){var e=controller_utils_1.default.quad(new cc_1.Vec3,1e5,1e5),e=(e.parent=this._rootNode,e.name="RectPanPlane",e.active=!1,e.layer=panPlaneLayer,setNodeOpacity(e,0),this._panPlane=e,controller_utils_1.default.quad(new cc_1.Vec3,100,100,new cc_1.Vec3(0,0,1),this._areaColor,{unlit:!0}));e.name="RectArea",e.parent=this.shape,e.setPosition(new cc_1.Vec3(0,0,-.1)),setNodeOpacity(e,this._areaOpacity),this._areaNode=e,this._areaMR=getModel(e),this.initHandle(e,RectHandleType.Area)}showEditHandles(){super.showEditHandles(),this._areaNode&&(this._areaNode.active=!0)}hideEditHandles(){super.hideEditHandles(),this._areaNode&&(this._areaNode.active=!1)}_updateEditHandle(e){var t=this._handleDataMap[e].topNode,i=this._axisDir[e],a=this._editHandleScales[e];e===RectHandleType.Anchor?(t.setScale(a/this.getScale().x,a/this.getScale().y,a/this.getScale().z),t.setWorldPosition(this.getPosition())):((e=new cc_1.Vec3).x=i.x*this._size.x/2,e.y=i.y*this._size.y/2,(i=new cc_1.Vec3(e)).add(this._center),t.setScale(a/this.getScale().x,a/this.getScale().y,a/this.getScale().z),cc_1.Vec3.multiply(i,i,this.getScale()),t.setPosition(i.x,i.y,i.z))}initShape(){this.createShapeNode("RectangleController"),this._rectNode=controller_utils_1.default.rectangle(this._center,cc_1.Quat.IDENTITY,this._size,this._color,{unlit:!0}),this._rectNode.parent=this.shape,this._rectMR=getModel(this._rectNode),EditorCamera.camera.node.on("transform-changed",this.onEditorCameraMoved,this)}updateSize(e,t){this._center.set(e),this._size.set(t),this._size.x<0||this._size.y<0?setMeshColor(this._rectNode,cc_1.Color.RED):setMeshColor(this._rectNode,this._color);e=controller_shape_1.default.calcRectanglePoints(this._center,cc_1.Quat.IDENTITY,this._size);updatePositions(this._rectMR,e.vertices),this._edit&&(this.updateEditHandles(),t=controller_shape_1.default.calcQuadData(this._center,this._size.x,this._size.y),updatePositions(this._areaMR,t.positions),updateBoundingBox(this._areaMR,t.minPos,t.maxPos)),this.adjustEditHandlesSize()}onMouseDown(e){this.edit&&(this._curHandleType=e.handleName,cc_1.Vec3.set(this._deltaSize,0,0,0),this._panPlane.active=!0,this._mouseDownOnPlanePos=new cc_1.Vec3,this.getPositionOnPanPlane(this._mouseDownOnPlanePos,e.x,e.y,this._panPlane),this.onControllerMouseDown)&&this.onControllerMouseDown(e)}onMouseMove(t){if(this.edit&&this._isMouseDown){var i=new cc_1.Vec3;if((!this.contentSizeLocked||this.isAreaOrAnchor(t.handleName))&&(!this.anchorLocked||t.handleName!==RectHandleType.Anchor)){if(this.getPositionOnPanPlane(i,t.x,t.y,this._panPlane)){var i=new cc_1.Vec3(i),a=(i.subtract(this._mouseDownOnPlanePos),this._axisDir[t.handleName]);let e=0;this.isBorder(t.handleName)?(cc_1.Vec3.transformQuat(tempVec3,a,this.getRotation()),e=i.dot(tempVec3),this._curHandleType===RectHandleType.Left||this._curHandleType===RectHandleType.Right?this._deltaSize.x=e:this._deltaSize.y=e):this.isCorner(t.handleName)?(tempVec3.x=a.x,tempVec3.y=0,tempVec3.z=0,cc_1.Vec3.transformQuat(tempVec3,tempVec3,this.getRotation()),e=i.dot(tempVec3),this._deltaSize.x=e,tempVec3.x=0,tempVec3.y=a.y,tempVec3.z=0,cc_1.Vec3.transformQuat(tempVec3,tempVec3,this.getRotation()),e=i.dot(tempVec3),this._deltaSize.y=e):this._deltaSize=i}this.onControllerMouseMove&&this.onControllerMouseMove(t)}}}onMouseUp(e){this._curHandleType=RectHandleType.None,this._panPlane.active=!1,this.onControllerMouseUp&&this.onControllerMouseUp(e)}onMouseLeave(e){this.isCorner(this._curHandleType)||this.onMouseUp(e)}onHoverIn(e){var t;this.edit&&(e.handleName!==RectHandleType.Area?this.setHandleColor(e.handleName,this._hoverColor):0<(t=getNodeOpacity(this._areaNode))&&this.setHandleColor(e.handleName,this._hoverColor,t))}onHoverOut(){this.resetHandleColor()}onHide(){super.onHide(),this.anchorLocked=!1,this.contentSizeLocked=!1}getDeltaSize(){return this._deltaSize.z=0,this._deltaSize}getCurHandleType(){return this._curHandleType}reset(){this._curHandleType=RectHandleType.None,this._isMouseDown=!1,this.resetHandleColor()}}(exports.RectangleController=RectangleController).RectHandleType=RectHandleType;