"use strict";var __importDefault=this&&this.__importDefault||function(c){return c&&c.__esModule?c:{default:c}};Object.defineProperty(exports,"__esModule",{value:!0});const engine_1=__importDefault(require("./engine")),cc_1=require("cc"),external_1=__importDefault(require("./external")),PrimitiveMode=engine_1.default["PrimitiveMode"],EditorMath=external_1.default.EditorMath,v3_forward=new cc_1.Vec3(0,0,1),tempVec3=new cc_1.Vec3,tempVec3_a=new cc_1.Vec3,tempVec3_b=new cc_1.Vec3,tempQuat_a=new cc_1.Quat;class ControllerShape{constructor(){this.calcRectanglePoints=function(c,e,t){var n=new cc_1.Vec3(t.x/2,0,0),t=new cc_1.Vec3(0,t.y/2,0),e=(cc_1.Vec3.transformQuat(n,n,e),cc_1.Vec3.transformQuat(t,t,e),[]),a=(e[0]=c.clone(),e[0].add(n),e[0].add(t),e[1]=c.clone(),e[1].add(n),e[1].subtract(t),e[2]=c.clone(),e[2].subtract(n),e[2].subtract(t),e[3]=c.clone(),e[3].subtract(n),e[3].add(t),[]);for(let c=1;c<4;c++)a.push(c-1,c);return a.push(0,3),{vertices:e,indices:a}},this.calcSphereData=function(t,n=.5,c={}){var a=void 0!==c.segments?c.segments:32,r=[],i=[],o=[],s=[],c=new cc_1.Vec3(-n,-n,-n),e=new cc_1.Vec3(n,n,n),l=n;for(let e=0;e<=a;++e){var _=e*Math.PI/a,V=Math.sin(_),m=-Math.cos(_);for(let c=0;c<=a;++c){var u=2*c*Math.PI/a-Math.PI/2,h=Math.sin(u)*V,p=m,u=Math.cos(u)*V,d=c/a,w=e/a;r.push(new cc_1.Vec3(t.x+h*n,t.y+p*n,t.z+u*n)),i.push(new cc_1.Vec3(h,p,u)),o.push(cc.v2(d,w)),e<a&&c<a&&(p=(h=a+1)*e+c,u=h*(e+1)+c,d=h*(e+1)+c+1,w=h*e+c+1,s.push(p,w,u),s.push(w,d,u))}}return{positions:r,indices:s,normals:i,uvs:o,minPos:c,maxPos:e,boundingRadius:l}}}calcCylinderData(_=.5,V=.5,e=2,c={}){const m=.5*e,u=c.radialSegments||16,t=c.heightSegments||1;var n=void 0===c.capped||c.capped;const h=c.arc||2*Math.PI;let a=0,r=(n||(0<_&&a++,0<V&&a++),(u+1)*(t+1)),i=(n&&(r+=(u+1)*a+u*a),u*t*2*3);n&&(i+=u*a*3);const p=new Array(i),d=new Array(r),w=new Array(r),v=new Array(r);var c=Math.max(_,V),o=new cc_1.Vec3(-c,-m,-c),c=new cc_1.Vec3(c,m,c);let f=0,y=0;var s=[],l=(_-V)/e;for(let c=0;c<=t;c++){var P=[],M=c/t,g=M*(_-V)+V;for(let c=0;c<=u;++c){var x=c/u,T=x*h,A=Math.sin(T),T=Math.cos(T);d[f]=new cc_1.Vec3(g*A,M*e-m,g*T),w[f]=new cc_1.Vec3(A,-l,T),w[f].normalize(),v[f]=cc.v2(2*(1-x)%1,M),P.push(f),++f}s.push(P)}for(let e=0;e<t;++e)for(let c=0;c<u;++c){var I=s[e][c],S=s[e+1][c],L=s[e+1][c+1],Q=s[e][c+1];p[y]=I,++y,p[y]=Q,++y,p[y]=S,++y,p[y]=Q,++y,p[y]=L,++y,p[y]=S,++y}function D(e){var t=e?_:V,n=e?1:-1,a=f;for(let c=1;c<=u;++c)d[f]=new cc_1.Vec3(0,m*n,0),w[f]=new cc_1.Vec3(0,n,0),v[f]=cc.v2(.5,.5),++f;var r=f;for(let c=0;c<=u;++c){var i=c/u*h,o=Math.cos(i),i=Math.sin(i);d[f]=new cc_1.Vec3(t*i,m*n,t*o),w[f]=new cc_1.Vec3(0,n,0),v[f]=cc.v2(.5-.5*i*n,.5+.5*o),++f}for(let c=0;c<u;++c){var s=a+c,l=r+c;e?(p[y]=l+1,++y,p[y]=s):(p[y]=s,++y,p[y]=l+1),++y,p[y]=l,++y}}return n&&(0<V&&D(!1),0<_)&&D(!0),{positions:d,normals:w,uvs:v,indices:p,minPos:o,maxPos:c}}calcConeData(c,e,t={}){return this.calcCylinderData(0,c,e,t)}calcPositionData(c,e,t,n=new cc_1.Vec3(0,0,1),a=!0){var e=e/2,t=t/2,r=[],i=tempQuat_a;cc_1.Quat.rotationTo(i,v3_forward,n),r[0]=c.clone(),r[0].add(cc_1.Vec3.transformQuat(tempVec3,new cc_1.Vec3(-e,t,0),i)),r[1]=c.clone(),r[1].add(cc_1.Vec3.transformQuat(tempVec3,new cc_1.Vec3(-e,-t,0),i)),r[2]=c.clone(),r[2].add(cc_1.Vec3.transformQuat(tempVec3,new cc_1.Vec3(e,-t,0),i)),r[3]=c.clone(),r[3].add(cc_1.Vec3.transformQuat(tempVec3,new cc_1.Vec3(e,t,0),i));let o,s;return a&&((o=c.clone()).add(cc_1.Vec3.transformQuat(tempVec3,new cc_1.Vec3(-e,-t,-.01),i)),(s=c.clone()).add(cc_1.Vec3.transformQuat(tempVec3,new cc_1.Vec3(e,t,.01),i))),{positions:r,minPos:o,maxPos:s}}calcQuadData(c,e,t,n=new cc_1.Vec3(0,0,1),a=!0){var r=[cc.v2(0,1),cc.v2(0,0),cc.v2(1,0),cc.v2(1,1)],{positions:c,minPos:e,maxPos:t}=this.calcPositionData(c,e,t,n,a);return{positions:c,normals:Array(4).fill(n),indices:[0,3,1,3,2,1],minPos:e,maxPos:t,uvs:r,doubleSided:!0}}lineWithBoundingBox(c,e=3){return{positions:[new cc_1.Vec3,new cc_1.Vec3(c,0,0)],normals:Array(2).fill(new cc_1.Vec3(0,1,0)),indices:[0,1],minPos:new cc_1.Vec3(0,-e,-e),maxPos:new cc_1.Vec3(c,e,e),primitiveType:PrimitiveMode.LINE_LIST}}calcCubeData(c,e,t,h,n={}){var a=n.widthSegments||1,r=n.heightSegments||1,n=n.lengthSegments||1,c=.5*c,e=.5*e,t=.5*t;const p=[new cc_1.Vec3(-c,-e,t),new cc_1.Vec3(c,-e,t),new cc_1.Vec3(c,e,t),new cc_1.Vec3(-c,e,t),new cc_1.Vec3(c,-e,-t),new cc_1.Vec3(-c,-e,-t),new cc_1.Vec3(-c,e,-t),new cc_1.Vec3(c,e,-t)],d=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],w=[new cc_1.Vec3(0,0,1),new cc_1.Vec3(0,0,-1),new cc_1.Vec3(0,1,0),new cc_1.Vec3(0,-1,0),new cc_1.Vec3(1,0,0),new cc_1.Vec3(-1,0,0)],v=[],f=[],y=[],P=[];var i=new cc_1.Vec3(-c,-e,-t),c=new cc_1.Vec3(c,e,t);function o(c,e,t){let n,a;var r=v.length,i=d[c],o=w[c],s=tempVec3_a,l=tempVec3_b;for(a=0;a<=t;a++)for(n=0;n<=e;n++){_=n/e,V=a/t,cc_1.Vec3.lerp(s,p[i[0]],p[i[1]],_),cc_1.Vec3.lerp(l,p[i[0]],p[i[2]],V),l.subtract(p[i[0]]);var _,V,m=new cc_1.Vec3(s),u=o.clone();m.add(l),f.push(u),h&&cc_1.Vec3.add(m,h,m),v.push(m),y.push(cc.v2(_,V)),n<e&&a<t&&(u=e+1,m=n+a*u,_=n+(a+1)*u,V=n+1+(a+1)*u,u=n+1+a*u,P.push(r+m,r+u,r+_),P.push(r+_,r+u,r+V))}}return o(0,a,r),o(4,n,r),o(1,a,r),o(5,n,r),o(3,a,n),o(2,a,n),{positions:v,indices:P,normals:f,minPos:i,maxPos:c}}torus(t,n,c={}){var a=c.radialSegments||30,r=c.tubularSegments||20,i=c.arc||2*Math.PI,o=[],s=[],l=[],_=[],c=new cc_1.Vec3(-t-n,-n,-t-n),e=new cc_1.Vec3(t+n,n,t+n);for(let e=0;e<=a;e++)for(let c=0;c<=r;c++){var V=c/r,m=e/a,u=V*i,h=m*Math.PI*2,p=(t+n*Math.cos(h))*Math.sin(u),d=n*Math.sin(h),w=(t+n*Math.cos(h))*Math.cos(u),v=Math.sin(u)*Math.cos(h),f=Math.sin(h),u=Math.cos(u)*Math.cos(h);o.push(new cc_1.Vec3(p,d,w)),s.push(new cc_1.Vec3(v,f,u)),l.push(cc.v2(V,m)),c<r&&e<a&&(p=(h=r+1)*e+c,d=h*(e+1)+c,w=h*(e+1)+c+1,v=h*e+c+1,_.push(p,v,d),_.push(v,w,d))}return{positions:o,indices:_,normals:s,uvs:l,minPos:c,maxPos:e}}calcArcPoints(e,c,t,n,a,r=60){cc_1.Vec3.normalize(tempVec3_a,t),cc_1.Vec3.normalize(tempVec3_b,c);var i=tempQuat_a,o=r,s=(cc_1.Quat.fromAxisAngle(i,tempVec3_b,n/(o-1)),tempVec3),l=(cc_1.Vec3.multiplyScalar(s,tempVec3_a,a),[]);for(let c=0;c<o;c++)l[c]=e.clone(),l[c].add(s),cc_1.Vec3.transformQuat(s,s,i);return l}getBiNormalByNormal(c){var e=new cc_1.Vec3;return cc_1.Vec3.cross(e,c,new cc_1.Vec3(0,1,0)),cc_1.Vec3.lengthSqr(e)<.001&&cc_1.Vec3.cross(e,c,new cc_1.Vec3(1,0,0)),e}calcCirclePoints(c,e,t,n=60){var a=this.getBiNormalByNormal(e);return this.calcArcPoints(c,e,a,EditorMath.TWO_PI,t,n)}calcDiscPoints(c,e,t,n=60){var a=this.getBiNormalByNormal(e);return this.calcSectorPoints(c,e,a,EditorMath.TWO_PI,t,n)}calcSectorPoints(c,e,t,n,a,r){let i=[];i.push(c);c=this.calcArcPoints(c,e,t,n,a,r);return i=i.concat(c)}indicesFanToList(e){var t=Array(3*(e.length-2)).fill(0);for(let c=1;c<e.length-1;c++)t[3*(c-1)]=0,t[3*(c-1)+1]=c,t[3*(c-1)+2]=c+1;return t}calcSectorData(c,e,t,n,a,r){return{positions:this.calcSectorPoints(c,e,t,n,a,r),normals:Array(r+1).fill(e.clone()),indices:this.indicesFanToList([...Array(r+1).keys()]),primitiveType:PrimitiveMode.TRIANGLE_LIST}}arcDirectionLine(c,e,t,n,a,r,i){var o=[],s=[],l=this.calcArcPoints(c,e,t,n,a,i),_=new cc_1.Vec3;cc_1.Vec3.multiplyScalar(_,e,r);for(let c=0;c<l.length;c++){var V=new cc_1.Vec3;cc_1.Vec3.add(V,l[c],_),o.push(l[c],V),s.push(2*c,2*c+1)}for(let c=1;c<l.length;c++)o.push(l[c-1]),s.push(o.length-1),o.push(l[c]),s.push(o.length-1);return{positions:o,normals:Array(o.length).fill(new cc_1.Vec3(0,1,1)),indices:s,primitiveType:PrimitiveMode.LINE_LIST}}calcBoxPoints(c,e){var t=new cc_1.Vec3,e=(cc_1.Vec3.multiplyScalar(t,e,.5),[]);return e[0]=new cc_1.Vec3(c),e[0].add(new cc_1.Vec3(-t.x,-t.y,-t.z)),e[1]=new cc_1.Vec3(c),e[1].add(new cc_1.Vec3(-t.x,t.y,-t.z)),e[2]=new cc_1.Vec3(c),e[2].add(new cc_1.Vec3(t.x,t.y,-t.z)),e[3]=new cc_1.Vec3(c),e[3].add(new cc_1.Vec3(t.x,-t.y,-t.z)),e[4]=new cc_1.Vec3(c),e[4].add(new cc_1.Vec3(-t.x,-t.y,t.z)),e[5]=new cc_1.Vec3(c),e[5].add(new cc_1.Vec3(-t.x,t.y,t.z)),e[6]=new cc_1.Vec3(c),e[6].add(new cc_1.Vec3(t.x,t.y,t.z)),e[7]=new cc_1.Vec3(c),e[7].add(new cc_1.Vec3(t.x,-t.y,t.z)),e}wireframeBox(c,e){var c=this.calcBoxPoints(c,e),t=[];for(let c=1;c<4;c++)t.push(c-1,c);t.push(0,3);for(let c=5;c<8;c++)t.push(c-1,c);t.push(4,7);for(let c=0;c<4;c++)t.push(c,c+4);return{positions:c,normals:Array(c.length).fill(new cc_1.Vec3(0,1,0)),indices:t,primitiveType:PrimitiveMode.LINE_LIST}}calcFrustum(c,e,t,n,a,r,i){var o=[],s=[];let l,_,V,m;c?(l=V=e,_=m=l*n):i?(l=Math.tan(EditorMath.deg2rad(t/2))*a,_=l*n,V=Math.tan(EditorMath.deg2rad(t/2))*r,m=V*n):(_=Math.tan(EditorMath.deg2rad(t/2))*a,l=_/n,m=Math.tan(EditorMath.deg2rad(t/2))*r,V=m/n),o[0]=new cc_1.Vec3(-_,-l,-a),o[1]=new cc_1.Vec3(-_,l,-a),o[2]=new cc_1.Vec3(_,l,-a),o[3]=new cc_1.Vec3(_,-l,-a),o[4]=new cc_1.Vec3(-m,-V,-r),o[5]=new cc_1.Vec3(-m,V,-r),o[6]=new cc_1.Vec3(m,V,-r),o[7]=new cc_1.Vec3(m,-V,-r);for(let c=1;c<4;c++)s.push(c-1,c);s.push(0,3);for(let c=5;c<8;c++)s.push(c-1,c);s.push(4,7);for(let c=0;c<4;c++)s.push(c,c+4);return{positions:o,indices:s,normals:Array(o.length).fill(new cc_1.Vec3(0,1,0)),primitiveType:PrimitiveMode.LINE_LIST}}calcRectangleData(c,e,t){c=this.calcRectanglePoints(c,e,t);return{positions:c.vertices,normals:Array(c.vertices.length).fill(new cc_1.Vec3(0,1,0)),indices:c.indices,primitiveType:PrimitiveMode.LINE_LIST}}calcArcData(e,c,t,n,a,r=60){cc_1.Vec3.normalize(tempVec3_a,t),cc_1.Vec3.normalize(tempVec3_b,c);var i=tempQuat_a,o=r,s=(cc_1.Quat.fromAxisAngle(i,tempVec3_b,n/(o-1)),new cc_1.Vec3),l=(cc_1.Vec3.multiplyScalar(s,tempVec3_a,a),[]);for(let c=0;c<o;c++)l[c]=e.clone(),l[c].add(s),cc_1.Vec3.transformQuat(s,s,i);return{positions:l,normals:Array(r).fill(new cc_1.Vec3(tempVec3_b)),indices:[...Array(r).keys()],primitiveType:PrimitiveMode.LINE_STRIP}}calcCircleData(c,e,t,n=60){var a=this.getBiNormalByNormal(e);return this.calcArcData(c,e,a,EditorMath.TWO_PI,t,n)}calcLinesData(e,c,t=!0){c={positions:e,normals:Array(e.length).fill(new cc_1.Vec3(0,1,0)),indices:c,primitiveType:PrimitiveMode.LINE_LIST};if(t){var n=new cc_1.Vec3,a=new cc_1.Vec3;if(0<e.length){n.set(e[0]),a.set(e[0]);for(let c=1;c<e.length;c++)cc_1.Vec3.min(n,n,e[c]),cc_1.Vec3.max(a,a,e[c])}c.minPos=n,c.maxPos=a}return c}calcDiscData(c,e,t,n=60){var a=this.getBiNormalByNormal(e),r=new cc_1.Vec3(t,t,0),i=new cc_1.Vec3(-t,-t,0);return cc_1.Quat.rotationTo(tempQuat_a,cc_1.Vec3.UNIT_Z,e),cc_1.Vec3.add(r,r,c),cc_1.Vec3.transformQuat(r,r,tempQuat_a),cc_1.Vec3.add(i,i,c),cc_1.Vec3.transformQuat(i,i,tempQuat_a),{positions:this.calcSectorPoints(c,e,a,EditorMath.TWO_PI,t,n),normals:Array(n+1).fill(e.clone()),indices:this.indicesFanToList([...Array(n+1).keys()]),primitiveType:PrimitiveMode.TRIANGLE_LIST,minPos:i,maxPos:r}}calcLineData(c,e){const t=new cc_1.Vec3,n=new cc_1.Vec3,a=(cc_1.Vec3.min(t,c,e),cc_1.Vec3.max(n,c,e),cc_1.Vec3.subtract(tempVec3,n,t),[]);return["x","y","z"].forEach(c=>{0===tempVec3[c]&&a.push(c)}),2===a.length&&a.forEach(c=>{t[c]-=.5,n[c]+=.5}),{positions:[new cc_1.Vec3(c.x,c.y,c.z),new cc_1.Vec3(e.x,e.y,e.z)],normals:Array(2).fill(new cc_1.Vec3(0,1,0)),indices:[0,1],minPos:t,maxPos:n,primitiveType:PrimitiveMode.LINE_LIST}}calcPolygonData(c,e){const t=new cc_1.Vec3,n=new cc_1.Vec3;c.forEach(c=>{cc_1.Vec3.min(t,t,c),cc_1.Vec3.max(n,n,c)});let a;return a=e||[...c.keys()],{positions:c,normals:Array(c.length).fill(new cc_1.Vec3(0,1,0)),indices:a,minPos:t,maxPos:n,primitiveType:PrimitiveMode.TRIANGLE_LIST}}calcOctahedronData(c,e,t,n,a=.2){var t=t/2,n=n/2,r=new cc_1.Vec3,i=new cc_1.Vec3;const o=[new cc_1.Vec3(0,0,0),new cc_1.Vec3(0,1,0),new cc_1.Vec3(t,a,n),new cc_1.Vec3(-t,a,n),new cc_1.Vec3(-t,a,-n),new cc_1.Vec3(t,a,-n)];var t=cc_1.Vec3.subtract(new cc_1.Vec3,e,c),a=cc_1.Vec3.len(t),n=(cc_1.Vec3.normalize(t,t),cc_1.Quat.rotationTo(new cc_1.Quat,cc_1.Vec3.UNIT_Y,t)),s=cc_1.Mat4.fromRTS(new cc_1.Mat4,n,c,new cc_1.Vec3(a,a,a));for(let c=0;c<o.length;++c){var l=o[c];cc_1.Vec3.transformMat4(l,l,s),cc_1.Vec3.min(r,r,l),cc_1.Vec3.max(i,i,l)}var _=[2,3,0,3,4,0,4,5,0,5,2,0,1,3,2,1,4,3,1,5,4,1,2,5],V=_.length,m=new Array(3*V).fill(0);for(let c=0;c<V;++c){var u=_[c];m[3*c]=o[u].x,m[3*c+1]=o[u].y,m[3*c+2]=o[u].z}var h=external_1.default.GeometryUtils.calculateNormals(m,Array.from({length:V},(c,e)=>e),new Array(m.length).fill(0)),p=[];for(let c=0;c<h.length;c+=3)p.push(new cc_1.Vec3(h[c],h[c+1],h[c+2]));e=_.map(c=>o[c]),t=[...Array(e.length).keys()];return{primitiveType:PrimitiveMode.TRIANGLE_LIST,positions:e,normals:p,indices:t,minPos:r,maxPos:i}}}exports.default=new ControllerShape;