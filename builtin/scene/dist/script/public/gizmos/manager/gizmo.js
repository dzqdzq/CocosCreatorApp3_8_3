"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.gizmoManager=exports.GizmoManager=void 0;const cc_1=require("cc"),structures_1=require("@itharbors/structures"),node_1=__importDefault(require("../../../3d/manager/node")),node_2=__importDefault(require("../../../utils/node")),selection_1=__importDefault(require("../../selection")),config_1=__importDefault(require("../utils/config")),transform_tool_1=require("./transform-tool"),world_axis_1=__importDefault(require("../controller/world-axis")),gizmo_select_1=__importDefault(require("../components/base/gizmo-select")),event_enum_1=require("../../event-enum"),camera_1=__importDefault(require("../../../3d/manager/camera")),message_1=require("../../../3d/manager/message"),rect_transform_snapping_1=require("../utils/rect-transform-snapping"),gizmo_operation_1=__importDefault(require("../gizmo-operation")),index_1=__importDefault(require("../utils/engine/index")),gizmo_select_2=__importDefault(require("../components/light-probe-group/gizmo-select")),gizmo_select_3=__importDefault(require("../components/mesh-renderer/gizmo-select")),gizmo_select_4=__importDefault(require("../components/skinned-mesh-renderer/gizmo-select")),selection_2=__importDefault(require("../../selection")),pool_1=require("./pool"),data_1=require("./data"),hack_component_1=require("./hack-component"),create3DNode=index_1.default["create3DNode"],SceneGizmoLayer=cc_1.Layers.Enum.SCENE_GIZMO;class GizmoPoolManager extends structures_1.EventEmitter{constructor(){super(...arguments),this._gizmoPool=new pool_1.GizmoPool,this._iconVisible=!1}get iconVisible(){return this._iconVisible}set iconVisible(o){this._iconVisible=o,node_1.default.queryUuids().forEach(e=>{e=node_1.default.query(e);e&&(0,hack_component_1.walkNodeComponent)(e,e=>{e=(0,data_1.getGizmoProperty)("icon",e);e&&e.setIconGizmoVisible(o)})})}forEachInstanceList(e,o,t){return this._gizmoPool.forEachInstanceList(e,o,t)}clearAllGizmos(){this._gizmoPool.clearAllGizmos()}createGizmoFromType(e,o,t){o=this._gizmoPool.createGizmo(e,o);return t&&(0,data_1.setGizmoProperty)(e,t,o),o&&o instanceof gizmo_select_1.default&&o.shouldRegisterGizmoOperationEvent&&(gizmo_operation_1.default.registerGizmoOperationEventListener(o),o.shouldRegisterGizmoOperationEvent=!1),o}createGizmo(e,o){return this.createGizmoFromType("component",e,o)}destroyGizmo(e){this._gizmoPool.destroyGizmo(e)}showGizmo(e,o,t=!1){let i=(0,data_1.getGizmoProperty)(e,o);i&&!t||(t=cc_1.js.getClassName(o),i=this.createGizmoFromType(e,t),(0,data_1.setGizmoProperty)(e,o,i)),"icon"===e?null!==i&&void 0!==i&&i.setIconGizmoVisible(this._iconVisible):null!==i&&void 0!==i&&i.show()}hideGizmo(e){e&&e.hide()}removeGizmo(e,o){var t=(0,data_1.getGizmoProperty)(e,o);t&&(this.hideGizmo(t),(0,data_1.setGizmoProperty)(e,o,null))}showGizmoOfNode(o,e){e&&e.parent&&e.activeInHierarchy&&(0,hack_component_1.walkNodeComponent)(e,e=>{e.enabledInHierarchy&&this.showGizmo(o,e)})}removeGizmoOfNode(o,e){(0,hack_component_1.walkNodeComponent)(e,e=>{this.removeGizmo(o,e)})}showAllGizmoOfNode(e,o=!1){e&&!node_2.default.isEditorNode(e)&&((0,hack_component_1.walkNodeComponent)(e,e=>{e.enabledInHierarchy&&(this.showGizmo("icon",e),this.showGizmo("persistent",e),this.showGizmo("component",e))}),!0===o)&&e.children.forEach(e=>{this.showAllGizmoOfNode(e,!0)})}removeAllGizmoOfNode(e,o=!1){e&&((0,hack_component_1.walkNodeComponent)(e,e=>{this.removeGizmo("component",e),this.removeGizmo("icon",e),this.removeGizmo("persistent",e)}),!0===o)&&e.children.forEach(e=>{this.removeAllGizmoOfNode(e,!0)})}on(e,o){return this.addListener(e,o)}off(e,o){return this.removeListener(e,o)}once(e,o){return this.addOnceListener(e,o)}}class TransformGizmoManager extends GizmoPoolManager{get transformToolName(){return this.transformToolData.toolName}set transformToolName(e){this.transformToolData.toolName=e}get coordinate(){return this.transformToolData.coordinate}set coordinate(e){this.transformToolData.coordinate=e}get pivot(){return this.transformToolData.pivot}set pivot(e){this.transformToolData.pivot=e}constructor(){super(),this.transformToolData=new transform_tool_1.TransformToolData,this.__listenEvents()}onCameraControlModeChanged(e){}init(){camera_1.default.on("control-3d-mode",this.onCameraControlModeChanged.bind(this))}__listenEvents(){const o=this.transformToolData;function t(){var e=o.snapConfigs.getPureDataObject();Editor.Profile.setConfig("scene","snap-configs",e)}o.addListener("tool-name-changed",e=>{message_1.messageManager.broadcast("scene:gizmo-tool-changed",e)}),o.addListener("coordinate-changed",e=>{message_1.messageManager.broadcast("scene:gizmo-coordinate-changed",e)}),o.addListener("pivot-changed",e=>{message_1.messageManager.broadcast("scene:gizmo-pivot-changed",e)}),o.snapConfigs.addListener("snap-position-changed",e=>{t(),Editor.Message.broadcast("scene:snap-position-changed",e)}),o.snapConfigs.addListener("snap-rotation-changed",e=>{t(),Editor.Message.broadcast("scene:snap-rotation-changed",e)}),o.snapConfigs.addListener("snap-scale-changed",e=>{t(),Editor.Message.broadcast("scene:snap-scale-changed",e)}),o.snapConfigs.addListener("enable-snap-position-changed",e=>{t(),Editor.Message.broadcast("scene:enable-snap-position-changed",e)}),o.snapConfigs.addListener("enable-snap-rotation-changed",e=>{t(),Editor.Message.broadcast("scene:enable-snap-rotation-changed",e)}),o.snapConfigs.addListener("enable-snap-scale-changed",e=>{t(),Editor.Message.broadcast("scene:enable-snap-scale-changed",e)})}queryTransformSnapConfigs(){return this.transformToolData.snapConfigs.getPureDataObject()}setTransformSnapConfigs(e,o){this.transformToolData.snapConfigs[e]=o}onUpdate(t){cce.Selection.query().map(e=>cce.Node.query(e)).filter(Boolean).forEach(e=>{e&&(0,hack_component_1.walkNodeComponent)(e,e=>{var o=(0,data_1.getGizmoProperty)("component",e);e&&o&&o.update(t)})})}}class SelectionGizmoManager extends TransformGizmoManager{constructor(){super(...arguments),this._selection=[]}select(e){e.forEach(e=>{var o;-1===this._selection.indexOf(e)&&(o=node_1.default.query(e))&&(this.showAllGizmoOfNode(o),this.onNodeSelectionChanged(o,!0),this._selection.push(e))});const o=[];this._selection.forEach(e=>{e=node_1.default.query(e);e&&o.push(e)}),this.emit("node-selected",e)}unselect(e){e.forEach(e=>{var o=this._selection.indexOf(e),o=(-1!==o&&this._selection.splice(o,1),node_1.default.query(e));o&&(this.onNodeSelectionChanged(o,!1),this.removeGizmoOfNode("component",o))});this._selection.map(e=>node_1.default.query(e));this.emit("node-unselected",e),cce.Engine.repaintInEditMode()}querySelectNodes(){return this._selection.map(e=>node_1.default.query(e)).filter(e=>void 0!==e)}getSelectionUUIDs(){return this._selection}hasSelected(e){return this._selection.includes(e)}onNodeSelectionChanged(e,o){}}class GizmoManager extends SelectionGizmoManager{constructor(){super(...arguments),this._worldAxisController=null,this._lightProbeEditModeListener=[gizmo_operation_1.default],this._lightProbeEditMode=!1,this._lightProbeBoundingBoxEditMode=!1}get is2D(){return this.transformToolData.is2D}set is2D(e){this.transformToolData.is2D=!!e,e?(null!=(e=this._worldAxisController)&&e.hide(),this.iconVisible=!1):(null!=(e=this._worldAxisController)&&e.show(),this.iconVisible=!0),this.emit("info-update")}saveRectSnapConfigs(){var e=rect_transform_snapping_1.rectTransformSnapping.getPureDataObject();Editor.Profile.setConfig("scene","rect-snap-configs",e)}createSceneGizmo(){var e=new cc_1.Node("Scene Gizmo Camera"),e=(e.layer=cc_1.Layers.Enum.EDITOR|cc_1.Layers.Enum.IGNORE_RAYCAST,e.parent=cce.backgroundNode,e.addComponent("cc.Camera"));e.inEditorMode=!0,(this.sceneGizmoCamera=e).far=1e3,e.clearFlags=cc_1.gfx.ClearFlagBit.DEPTH_STENCIL,e.visibility=SceneGizmoLayer,e.rect=new cc_1.Rect(.7,.8,.2,.2),e.priority=1610612736,e.clearColor=new cc_1.Color(e.clearColor.r,e.clearColor.g,e.clearColor.b,0),this.gizmoRootNode&&(this._worldAxisController=new world_axis_1.default(this.gizmoRootNode,e)),this.setSceneGizmoCameraRect()}setSceneGizmoCameraRect(){var e=cc_1.director.root&&cc_1.director.root.curWindow?cc_1.director.root.curWindow.width:0,o=cc_1.director.root&&cc_1.director.root.curWindow?cc_1.director.root.curWindow.height:0,t=o/6/o,e=(e-o)*t/2/e,o=30*window.devicePixelRatio/o;this.sceneGizmoCamera&&(this.sceneGizmoCamera.rect=new cc_1.Rect(1-t+e,1-t-o,t,t))}onNodeSelectionChanged(e,o){e&&e.parent&&e.activeInHierarchy&&(0,hack_component_1.walkNodeComponent)(e,e=>{e=(0,data_1.getGizmoProperty)("icon",e);e&&e.onNodeSelectionChanged&&e.onNodeSelectionChanged(o)})}isIconGizmo3D(){return config_1.default.isIconGizmo3D}setIconGizmo3D(o){null!=o&&(config_1.default.isIconGizmo3D=o,node_1.default.queryUuids().forEach(e=>{e=node_1.default.query(e);e&&(0,hack_component_1.walkNodeComponent)(e,e=>{e=(0,data_1.getGizmoProperty)("icon",e);e&&e.setIconGizmo3D(o)})}),cce.Engine.repaintInEditMode())}queryIconGizmoSize(){return config_1.default.iconGizmoSize}setIconGizmoSize(o){null!=o&&(config_1.default.iconGizmoSize=o,node_1.default.queryUuids().forEach(e=>{e=node_1.default.query(e);e&&(0,hack_component_1.walkNodeComponent)(e,e=>{e=(0,data_1.getGizmoProperty)("icon",e);e&&e.setIconGizmoSize(o)})}),cce.Engine.repaintInEditMode())}queryToolsVisibility3d(){return config_1.default.toolsVisibility3d}setToolsVisibility3d(e){config_1.default.toolsVisibility3d=Boolean(e),selection_2.default.query().forEach(e=>{e=node_1.default.query(e);e&&(0,hack_component_1.walkNodeComponent)(e,e=>{var o=(0,data_1.getGizmoProperty)("component",e);o&&(o.target!==e&&this.showGizmo("component",e,!0),o.checkVisible()?o.show():o.hide())})}),cce.Engine.repaintInEditMode()}queryRectSnappingConfigs(e){var o=rect_transform_snapping_1.rectTransformSnapping.getPureDataObject();return e?o[e]:o}setRectSnappingConfigs(e,o){rect_transform_snapping_1.rectTransformSnapping[e]=o,this.saveRectSnapConfigs()}init(){this.gizmoRootNode=create3DNode("gizmoRoot"),this.gizmoRootNode.parent=cce.foregroundNode,this.createSceneGizmo(),super.init(),this.initFromConfig(),gizmo_operation_1.default.init(this),this.clearAllGizmos(),selection_1.default.on("select",(e,o)=>{this.select([e])}),selection_1.default.on("unselect",e=>{this.unselect([e])}),this.addListener("node-selected",e=>{e.forEach(e=>{e=node_1.default.query(e);e&&e.getComponent(cc_1.LightProbeGroup)&&(this._lightProbeEditMode&&cce.SceneFacadeManager.toggleLightProbeEditMode(!1),this._lightProbeBoundingBoxEditMode)&&cce.SceneFacadeManager.toggleLightProbeBoundingBoxEditMode(!1)})}),this.emit("init"),cce.Camera.controller.on("projection-changed",e=>{var o;null!=(o=this._worldAxisController)&&o.onCameraProjectionChanged(e)})}async initFromConfig(){var e=await Editor.Profile.getConfig("scene","gizmos-infos"),e=(this.setIconGizmo3D(e.is3DIcon),this.setIconGizmoSize(e.iconSize),this.is2D=e.is2D,this.transformToolName=e.transformToolName,this.pivot=e.pivot,this.coordinate=e.coordinate,this.setToolsVisibility3d(void 0===e.toolsVisibility3d||e.toolsVisibility3d),await Editor.Profile.getConfig("scene","snap-configs")),e=(e&&this.transformToolData.snapConfigs.initFromData(e),await Editor.Profile.getConfig("scene","rect-snap-configs"));e&&rect_transform_snapping_1.rectTransformSnapping.initFromData(e)}async saveConfig(){var e={is2D:this.is2D,is3DIcon:this.isIconGizmo3D(),iconSize:this.queryIconGizmoSize(),transformToolName:this.transformToolName,pivot:this.pivot,coordinate:this.coordinate,toolsVisibility3d:this.queryToolsVisibility3d()},o=this.transformToolData.snapConfigs.getPureDataObject(),t=rect_transform_snapping_1.rectTransformSnapping.getPureDataObject();cce.Ipc.send("record-gizmos",{gizmosInfos:e,snapConfigs:o,rectSnapConfigs:t})}lockGizmoTool(e){this.transformToolData.isLocked=e}isGizmoToolLocked(){return this.transformToolData.isLocked}showSelectionRegion(e,o,t,i){var n,r=new cc_1.Vec3(e,i,.1),i=new cc_1.Vec3(o,i,.1),o=new cc_1.Vec3(o,t,.1),e=new cc_1.Vec3(e,t,.1),t=new cc_1.Vec3,a=new cc_1.Vec3,s=new cc_1.Vec3,c=new cc_1.Vec3,i=(null!=(n=camera_1.default.camera)&&n.screenToWorld(r,t),null!=(n=camera_1.default.camera)&&n.screenToWorld(i,a),null!=(r=camera_1.default.camera)&&r.screenToWorld(o,s),null!=(n=camera_1.default.camera)&&n.screenToWorld(e,c),cce.Engine.getGeometryRenderer());i&&(i.removeData("addQuad"),i.addQuad(t,a,s,c,new cc_1.Color(255,255,255,120),!1,!1,!0)),cce.Engine.repaintInEditMode()}hideSelectionRegion(){var e;null!=(e=cce.Engine.getGeometryRenderer())&&e.removeData("addQuad"),cce.Engine.repaintInEditMode()}callAllGizmoFuncOfNode(e,t,...i){let n=!1;return!e||((0,hack_component_1.walkNodeComponent)(e,e=>{var o=(0,data_1.getGizmoProperty)("component",e);e&&o&&o[t]&&!1===o[t](...i)&&(n=!0)}),!n)}onDimensionChanged(e){this.setToolsVisibility3d(config_1.default.toolsVisibility3d)}onMouseLeave(){gizmo_operation_1.default.onMouseLeave()}onResize(){this.setSceneGizmoCameraRect()}onSceneOpened(){var e;this.clearAllGizmos(),this.transformToolName="position",selection_1.default.query().forEach(e=>{this.select([e]),selection_1.default.select(e)}),node_1.default.queryUuids().forEach(e=>{e=node_1.default.query(e);e&&!node_2.default.isEditorNode(e)&&(this.showGizmoOfNode("icon",e),this.showGizmoOfNode("persistent",e))}),this.transformToolData.is2D||null!=(e=this._worldAxisController)&&e.show(),null!=(e=this._worldAxisController)&&e.onEditorCameraMoved()}onSceneClosed(){this.saveConfig()}onNodeChanged(e,t){if(e){const i=this.hasSelected(e.uuid);var o=null==t?void 0:t.type;(0,hack_component_1.walkNodeComponent)(e,o=>{if(o instanceof hack_component_1._EditorHackTransformComponent_||o.enabled&&e.active){let e;i&&((e=(0,data_1.getGizmoProperty)("component",o))?e.onNodeChanged&&e.onNodeChanged(t):this.showGizmo("component",o)),(e=(0,data_1.getGizmoProperty)("persistent",o))?e.onNodeChanged&&e.onNodeChanged(t):this.showGizmo("persistent",o),(e=(0,data_1.getGizmoProperty)("icon",o))?e.onNodeChanged&&e.onNodeChanged(t):this.showGizmo("icon",o)}else i&&this.removeGizmo("component",o),this.removeGizmo("icon",o),this.removeGizmo("persistent",o)}),o!==event_enum_1.NodeEventType.CHILD_CHANGED&&e.children.forEach(e=>{this.onNodeChanged(e,t)}),cce.Engine.repaintInEditMode()}}onNodeAdded(e){e&&this.hasSelected(e.uuid)&&this.showAllGizmoOfNode(e)}onNodeRemoved(e){null!==e&&this.removeAllGizmoOfNode(e,!0)}onComponentAdded(e){e&&this.hasSelected(e.node.uuid)&&this.showAllGizmoOfNode(e.node)}onComponentRemoved(e){this.removeGizmo("icon",e),this.removeGizmo("persistent",e);e=(0,data_1.getGizmoProperty)("component",e);this.hideGizmo(e)}set lightProbeEditMode(e){e!==this._lightProbeEditMode&&((this._lightProbeEditMode=e)&&(this.lightProbeBoundingBoxEditMode=!1),this.lightProbeEditModeChanged(e))}get lightProbeEditMode(){return this._lightProbeEditMode}set lightProbeBoundingBoxEditMode(e){e!==this._lightProbeBoundingBoxEditMode&&((this._lightProbeBoundingBoxEditMode=e)&&(this.lightProbeEditMode=!1),this.boundingBoxEditModeChanged(e))}get lightProbeBoundingBoxEditMode(){return this._lightProbeBoundingBoxEditMode}lightProbeEditModeChanged(t){this._lightProbeEditMode=t,this._lightProbeEditModeListener.forEach(e=>{var o;return null==(o=e.lightProbeEditModeChanged)?void 0:o.call(e,t)}),Editor.Message.broadcast("scene:light-probe-edit-mode-changed",t)}updateLightProbeInfo(){this.forEachInstanceList("component","cc.Mesh",e=>{e.nodes[0]&&(e=e.nodes[0].getComponent("cc.Mesh"))&&(e=(0,data_1.getGizmoProperty)("component",e))&&e instanceof gizmo_select_2.default&&e.lightProbeInfoChanged()})}lightProbeInfoChanged(){this.walkAllLightProbeGizmoListener(e=>e.lightProbeInfoChanged())}boundingBoxEditModeChanged(t){this._lightProbeBoundingBoxEditMode=t,this._lightProbeEditModeListener.forEach(e=>{var o;return null==(o=e.boundingBoxEditModeChanged)?void 0:o.call(e,t)}),Editor.Message.broadcast("scene:light-probe-bounding-box-edit-mode-changed",t)}get globalSelectProbes(){const o=[];return this._lightProbeEditModeListener.forEach(e=>{e instanceof gizmo_select_2.default&&e.checkCurrentTargetPointingSelf()&&o.push(...e._controller.currentSelectedProbes)}),o}registerLightProbeEditModeListener(e){this._lightProbeEditModeListener.unshift(e)}walkAllLightProbeGizmoListener(o){this._lightProbeEditModeListener.forEach(e=>{e instanceof gizmo_select_2.default&&e.visible()&&e.checkCurrentTargetPointingSelf()&&o(e)})}updateLightProbeInnerTetrahedron(){this.forEachInstanceList("component","cc.MeshRenderer",e=>{var o;(e instanceof gizmo_select_3.default||e instanceof gizmo_select_4.default)&&e.visible()&&e.target&&e.target.model&&null!=(o=e.tetrahedronController)&&o.updateInnerTetrahedron(e.tetrahedronController.getTetrahedronIndex())}),cce.Engine.repaintInEditMode()}duplicateCurrentSelectedProbes(){gizmo_operation_1.default.duplicateCurrentSelectedProbes()}removeCurrentSelectedProbes(){gizmo_operation_1.default.removeCurrentSelectedProbes()}selectAllLightProbes(){gizmo_operation_1.default.selectAllLightProbes()}}exports.GizmoManager=GizmoManager,exports.gizmoManager=new GizmoManager;