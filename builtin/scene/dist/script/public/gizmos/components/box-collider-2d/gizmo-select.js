"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),external_1=__importDefault(require("../../utils/external")),base_1=require("../base"),rectangle_controller_1=require("../../node/rectangle-controller"),NodeUtils=external_1.default.NodeUtils,EditorMath=external_1.default.EditorMath,HandleType=rectangle_controller_1.RectangleController.RectHandleType,tempQuat_a=new cc_1.Quat,tempMat4=new cc_1.Mat4,tempVec2=new cc_1.Vec2;class BoxCollider2DGizmo extends base_1.SelectGizmo{constructor(){super(...arguments),this._size=new cc_1.Size,this._offset=new cc_1.Vec2,this._anchor=new cc_1.Vec2(.5,.5),this._altKey=!1,this._propPath=null}init(){this.createController()}onShow(){this._controller.show(),this.updateController()}onHide(){this._controller.hide()}createController(){this._controller=new rectangle_controller_1.RectangleController(this.getGizmoRoot()),this._controller.editable=!0,this._controller.setColor(new cc.Color(107,194,53)),this._controller.setEditHandlesColor(new cc.Color(107,194,53)),this._controller.setAreaOpacity(50),this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)}onControllerMouseDown(){this.target&&(this._size=this.target.size.clone(),this._offset=this.target.offset.clone(),this._propPath=this.getCompPropPath("size"))}onControllerMouseMove(){var t,e,o;this._controller.updated&&(this.onControlUpdate(this._propPath),t=this._controller.getCurHandleType(),e=this._controller.getDeltaSize(),t===HandleType.Area?this.handleAreaMove(e):(o=this._altKey,this.handleTargetSize(t,e,o)))}onControllerMouseUp(){this.onControlEnd(this._propPath)}onKeyDown(t){this._altKey=t.altKey}onKeyUp(t){this._altKey=t.altKey}handleAreaMove(t){var e;this.target&&(e=this.target.node,t=t.clone(),e&&(e.getWorldMatrix(tempMat4),cc_1.Mat4.invert(tempMat4,tempMat4),tempMat4.m12=tempMat4.m13=0,cc_1.Vec3.transformMat4(t,t,tempMat4)),t.z=0,tempVec2.set(this._offset),tempVec2.add2f(t.x,t.y),NodeUtils.makeVec2InPrecision(tempVec2,1),this.target.offset.set(tempVec2),this.onComponentChanged(e))}modifyPosDeltaWithAnchor(t,e,o,r,i){t===HandleType.Right||t===HandleType.TopRight||t===HandleType.BottomRight?(i&&(o.x/=1-r.x),e.x=o.x*r.x):(i&&(o.x/=r.x),e.x=-o.x*(1-r.x)),t===HandleType.Bottom||t===HandleType.BottomRight||t===HandleType.BottomLeft?(i&&(o.y/=r.y),e.y=-o.y*(1-r.y)):(i&&(o.y/=1-r.y),e.y=o.y*r.y)}handleTargetSize(t,e,o){var r=e.clone(),e=new cc_1.Vec2(e.x,e.y);e.x=EditorMath.toPrecision(e.x,3),e.y=EditorMath.toPrecision(e.y,3),this.modifyPosDeltaWithAnchor(t,r,e,this._anchor,o),this.target&&((t=this.target.node).getWorldMatrix(tempMat4),cc_1.Mat4.invert(tempMat4,tempMat4),tempMat4.m12=tempMat4.m13=0,cc_1.Vec3.transformMat4(r,r,tempMat4),o||(o=tempQuat_a,t.getRotation(o),cc_1.Vec3.transformQuat(r,r,o),r.z=0,tempVec2.set(this._offset),tempVec2.add2f(r.x,r.y),NodeUtils.makeVec2InPrecision(tempVec2,1),this.target.offset.set(tempVec2)),o=new cc_1.Vec3,t.getWorldScale(o),e.x=e.x/o.x,e.y=e.y/o.y,r=this._size.width+e.x,o=this._size.height+e.y,r=EditorMath.toPrecision(r,1),o=EditorMath.toPrecision(o,1),this.target.size.set(cc.size(r,o)),this.onComponentChanged(t))}updateControllerData(){var t,e,o,r,i,l;this._isInitialized&&null!==this.target&&((t=this.target)?((e=t.node)&&e.getWorldMatrix(tempMat4),o=t.size,i=t.offset,(r=cc.v3()).x=i.x,r.y=i.y,i=NodeUtils.getWorldScale3D(e),cc_1.Vec3.transformMat4(r,r,tempMat4),l=tempQuat_a,NodeUtils.getWorldRotation3D(e,l),this._controller.setPosition(r),this._controller.setRotation(l),this._controller.updateSize(cc_1.Vec3.ZERO,cc.v2(o.width*i.x,o.height*i.y)),this._controller.edit=t.editing):this._controller.hide())}updateController(){this.updateControllerData()}onTargetUpdate(){this.updateController()}onNodeChanged(){this.updateController()}}exports.default=BoxCollider2DGizmo;