"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),external_1=__importDefault(require("../../utils/external")),utils_1=__importDefault(require("../../utils")),base_1=require("../base"),image_1=__importDefault(require("../../controller/image")),NodeUtils=external_1.default.NodeUtils,tempQuat_a=new cc_1.Quat;class VideoPlayerGizmo extends base_1.SelectGizmo{constructor(){super(...arguments),this._videoElem=document.createElement("video"),this._canvasElem=document.createElement("canvas"),this._canvas2D=null,this._image=new ccwindow.Image,this._tex2D=new cc_1.Texture2D,this._curUrl=""}init(){this.createController(),this._videoElem&&(this._videoElem.style.position="absolute",this._videoElem.style.bottom="0px",this._videoElem.style.left="0px",this._videoElem.className="cocosVideo",this._videoElem.hidden=!0,this._videoElem.addEventListener("loadeddata",this.onVideoLoaded.bind(this)),this._canvasElem&&(this._canvas2D=this._canvasElem.getContext("2d")),document.body.append(this._videoElem))}onShow(){this._controller.show(),this.updateController()}onHide(){this._controller.hide()}createController(){var e=this.getGizmoRoot();this._controller=new image_1.default(e,{texture:!0}),this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)}onControllerMouseDown(){}onControllerMouseMove(){}onControllerMouseUp(){this.target&&utils_1.default.select(this.target.node.uuid)}updateControllerData(){if(this._isInitialized&&this.target&&this._videoElem&&this.target instanceof cc_1.VideoPlayer){var t=this.target.node.getComponent(cc_1.UITransform);t&&(this.target.keepAspectRatio&&0<this._videoElem.readyState&&t.setContentSize(this._videoElem.videoWidth,this._videoElem.videoHeight),t=t.contentSize,this._controller.show(),this._controller.updateSize(cc.v3(),cc.v2(t.width,t.height)));let e="";e=this.target.resourceType===cc_1.VideoPlayer.ResourceType.REMOTE?this.target.remoteURL:(null==(t=this.target.clip)?void 0:t.nativeUrl)||"",this.target.enabled?this._controller.show():this._controller.hide(),e?this._curUrl!==e&&this._videoElem&&(this._videoElem.src=e.replace("#","%23"),this._curUrl=e):(this._controller.hide(),this._curUrl=e)}}onVideoLoaded(){var e;if(this._videoElem&&this._canvasElem){this._canvasElem.width=this._videoElem.videoWidth,this._canvasElem.height=this._videoElem.videoHeight,this.target&&this.target.keepAspectRatio&&null!=(e=this.target.node.getComponent(cc_1.UITransform))&&e.setContentSize(this._videoElem.videoWidth,this._videoElem.videoHeight),null!=(e=this._canvas2D)&&e.scale(1,-1),null!=(e=this._canvas2D)&&e.drawImage(this._videoElem,0,0,this._videoElem.videoWidth,-this._videoElem.videoHeight),this._image.src=this._canvasElem.toDataURL();const t=new cc_1.ImageAsset(this._image),o=()=>{this._tex2D.image=t,this._controller.setTexture(this._tex2D),this._controller.show(),cce.Engine.repaintInEditMode()};t.loaded?o():t.once("load",()=>{o()})}}updateControllerTransform(){var e,t,o;this._isInitialized&&null!==this.target&&(e=this.target.node,t=NodeUtils.getWorldPosition3D(e),o=tempQuat_a,NodeUtils.getWorldRotation3D(e,o),this._controller.setPosition(t),this._controller.setRotation(o))}updateController(){this.updateControllerData(),this.updateControllerTransform()}onTargetUpdate(){this.updateController()}onNodeChanged(){this.updateController()}}exports.default=VideoPlayerGizmo;