"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,i)}:function(e,t,r,o){e[o=void 0===o?r:o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const base_1=__importDefault(require("../../controller/base")),controller_utils_1=__importDefault(require("../../utils/controller-utils")),cc_1=require("cc"),controller_light_probe_1=__importStar(require("./controller-light-probe")),index_1=__importDefault(require("../../utils/engine/index")),{setMeshSHCoefficients,setMeshColor,addMeshToNode}=index_1.default,sceneGlobals=()=>{var e;return null==(e=cc_1.director.getScene())?void 0:e.globals};class LightProbeTetrahedronController extends base_1.default{static get Name(){return"LightProbeGroupController_"+LightProbeTetrahedronController.Count++}constructor(e,t){super(e),this.gizmo=t,this._lockSize=!0,this._isInitialized=!1,this._probeSphere=controller_utils_1.default.create3DNode("ProbeSphere"),this._innerTetrahedron=controller_utils_1.default.create3DNode("InnerTetrahedron"),this._probeSphereNodes=[],this._currentTetrahedronIndex=0,this._probeSHData=new Float32Array(cc_1.pipeline.UBOSH.COUNT),this.lightProbeInfo=controller_light_probe_1.lightProbeInfo,this.tempAdjustSizeV3=new cc_1.Vec3,this.initShape(),this.registerCameraMovedEvent()}initShape(){this.createShapeNode(LightProbeTetrahedronController.Name),this._probeSphere.parent=this.shape,this.initProbeSphere(),this._innerTetrahedron.parent=this.shape,this.clearLayer(this._probeSphere),this.clearLayer(this._innerTetrahedron),this.hide(),cce.Engine.repaintInEditMode(),cc.director.once(cc.Director.EVENT_AFTER_DRAW,()=>{this.updateController()})}initProbeSphere(){var t=new cc_1.Material,r={instancing:!1,depthTestForTriangles:!0,effectName:"internal/editor/light-probe-visualization",technique:0,useLightProbe:!0};const o=controller_utils_1.default.sphere((0,cc_1.v3)(0,0,0),5,LightProbeTetrahedronController.ProbeColor,r,t);var i=o.getComponent(cc_1.MeshRenderer).mesh;this._probeSphereNodes.push(o);for(let e=0;e<3;e++){const o=controller_utils_1.default.create3DNode();addMeshToNode(o,i,r,t),setMeshColor(o,LightProbeTetrahedronController.ProbeColor),this._probeSphereNodes.push(o)}for(const[e,o]of this._probeSphereNodes.entries())o.noNeedCommitChanges=!0,o.name="TetrahedronController_ProbeSphere_"+e,this.clearLayer(o),o.parent=this._probeSphere;this.adjustControllerSize()}show(){var e;null!=(e=null==(e=null==(e=this.gizmo.target)?void 0:e.model)?void 0:e.showTetrahedron())&&e&&(super.show(),this.updateLightProbeInfo(),this.updateController())}updateController(){var e;(null!==(e=!this.gizmo.target)?!e:null!=(e=null==(e=null==(e=this.gizmo.target)?void 0:e.model)?void 0:e.showTetrahedron())&&e)&&(super.updateController(),this.updateLightProbeInfo(),0<=(e=this.getTetrahedronIndex())&&this.updateInnerTetrahedron(e),this.adjustControllerSize(),cce.Engine.repaintInEditMode())}updateLightProbeInfo(){var e;this.lightProbeInfo.update(null==(e=sceneGlobals())?void 0:e.lightProbeInfo)}updateInnerTetrahedron(e){if(!(e<0)){var t=null==(t=null==(t=sceneGlobals())?void 0:t.lightProbeInfo)?void 0:t.data;const o=null==(r=null==(r=sceneGlobals())?void 0:r.lightProbeInfo)?void 0:r.reduceRinging,i=null!=(r=null==t?void 0:t.probes)?r:[];if(0!==i.length){const n=i.map(e=>e.position),l=i.map(e=>e.coefficients);var r,t=null!=(r=null==t?void 0:t.tetrahedrons)?r:[];0===t.length||e>t.length-1||(t=[(r=t[e]).vertex0,r.vertex1,r.vertex2],r.isInnerTetrahedron()&&t.push(r.vertex3),this._probeSphereNodes[this._probeSphereNodes.length-1].active=r.isInnerTetrahedron(),t.forEach((e,t)=>{if(this._probeSphereNodes[t].setPosition(n[e]),0<l[e].length){e=l[e].slice();cc_1.SH.reduceRinging(e,o||0),cc_1.SH.updateUBOData(this._probeSHData,cc_1.pipeline.UBOSH.SH_LINEAR_CONST_R_OFFSET,e)}else for(let e=0;e<cc_1.pipeline.UBOSH.COUNT;e++)this._probeSHData[e]=0;setMeshSHCoefficients(this._probeSphereNodes[t],this._probeSHData)}),r.isInnerTetrahedron()?controller_utils_1.default.drawLines(this._innerTetrahedron,t.map(e=>n[e]),controller_light_probe_1.default.TetrahedronLines,LightProbeTetrahedronController.LineColor):r.isOuterCell()&&((e=t.map(e=>(0,cc_1.v3)(i[e].position))).push(...t.map(e=>(0,cc_1.v3)(i[e].position).add(i[e].normal))),0<n.length)&&controller_utils_1.default.drawLines(this._innerTetrahedron,e,controller_light_probe_1.default.OuterCellLines,LightProbeTetrahedronController.LineColor))}}}clearLayer(e){e.layer=cc_1.Layers.Enum.IGNORE_RAYCAST,e.children.forEach(e=>this.clearLayer(e))}getProbesData(){}getTetrahedronIndex(){var e=this.gizmo.target;return!e||!(e=e.model)||!e.node.activeInHierarchy||e.tetrahedronIndex<0?-1:e.tetrahedronIndex}adjustControllerSize(){this.updateLightProbeInfo();for(const e of this._probeSphereNodes)this.tempAdjustSizeV3.set(this.lightProbeInfo.lightProbeSphereVolume,this.lightProbeInfo.lightProbeSphereVolume,this.lightProbeInfo.lightProbeSphereVolume),this.tempAdjustSizeV3.multiplyScalar(.06),e.setScale(this.tempAdjustSizeV3)}}(exports.default=LightProbeTetrahedronController).Count=0,LightProbeTetrahedronController.ProbeColor=new cc_1.Color("ACEDCF"),LightProbeTetrahedronController.LineColor=new cc_1.Color("CEF6E2");