"use strict";var __importDefault=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LightProbePositionGizmo=void 0;const cc_1=require("cc"),event_enum_1=require("../../../event-enum"),position_1=__importDefault(require("../../node/position")),config_1=__importDefault(require("../../utils/config")),base_1=require("../base"),controller_light_probe_1=__importDefault(require("./controller-light-probe")),controller_light_probe_bounding_box_1=__importDefault(require("./controller-light-probe-bounding-box"));let pivot=void 0;class LightProbeGizmo extends base_1.SelectGizmo{constructor(){super(...arguments),this.shouldRegisterGizmoOperationEvent=!0,this._originTarget=null,this._minPosPath=null,this._maxPosPath=null,this._isInitialized=!1,this._positionGizmo=new LightProbePositionGizmo(null),this.debounceUpdateController=null,this.debounceUpdateLines=null}get boundingBoxController(){return this._boundingBoxController}init(){this._isInitialized=!0;var o=this.getGizmoRoot();this.createController(o),cce.Gizmo.registerLightProbeEditModeListener(this)}createController(o){this._positionGizmo.show(),this._lightProbeRoot=new cc_1.Node("LightProbeController"),this._lightProbeRoot.parent=o,this._controller=new controller_light_probe_1.default(this._lightProbeRoot,this),this._boundingBoxRoot=new cc_1.Node("LightProbeBoundingBoxController"),this._boundingBoxRoot.parent=o,this._boundingBoxController=new controller_light_probe_bounding_box_1.default(this._boundingBoxRoot,this),this._boundingBoxController.onControllerMouseDown=this.onBBControllerMouseDown.bind(this),this._boundingBoxController.onControllerMouseMove=this.onBBControllerMouseMove.bind(this),this._boundingBoxController.onControllerMouseUp=this.onBBControllerMouseUp.bind(this),this._boundingBoxController.hide()}onShow(){this._controller.show(),this._boundingBoxController.editMode&&this._boundingBoxController.show()}onHide(){this._controller.hide(),this._boundingBoxController.hide(),cce.Gizmo.lightProbeEditMode=!1,cce.Gizmo.lightProbeBoundingBoxEditMode=!1}onNodeChanged(o){this._isInitialized&&this.checkCurrentTargetPointingSelf()&&(this.updateNodeTransformInfo(this._controller.probeSphere),this._boundingBoxRoot&&this.updateNodeTransformInfo(this._boundingBoxRoot),"undo"===o.source?this.target&&this.target.onProbeChanged(!0,!0):this._checkShouldSkipUpdateLightProbeController(o)&&(this.updateBoundingBoxController(),this._controller.updateController()))}updateBoundingBoxController(){this._boundingBoxController.editMode&&this._boundingBoxController.onShow()}afterPositionGizmoSetPositions(){this.debounceUpdateLines&&clearTimeout(this.debounceUpdateLines),this.debounceUpdateLines=setTimeout(()=>{this.target&&this.target.onProbeChanged(!1,!1),this._controller.updateLines(),this._controller.adjustControllerSize(),cce.Engine.repaintInEditMode(),this.debounceUpdateLines=null},0)}_checkShouldSkipUpdateLightProbeController(o){var t;switch(null==o?void 0:o.type){case event_enum_1.NodeEventType.COMPONENT_CHANGED:return this.updateBoundingBoxController(),!1;case event_enum_1.NodeEventType.PREFAB_INFO_CHANGED:return cce.SceneFacadeManager.toggleLightProbeEditMode(!1),cce.SceneFacadeManager.toggleLightProbeBoundingBoxEditMode(!1),!0;case event_enum_1.NodeEventType.TRANSFORM_CHANGED:return this.afterPositionGizmoSetPositions(),this.debounceUpdateController&&clearTimeout(this.debounceUpdateController),this.debounceUpdateController=setTimeout(()=>{this.target&&this.target.onProbeChanged(!0,!0),this.debounceUpdateController=null},250),!1;case event_enum_1.NodeOperationType.SET_PROPERTY:return null!=(t=o.propPath)&&t.includes("__comps__.")?(this.target&&this.target.onProbeChanged(!0,!0),this.updateBoundingBoxController(),!0):(this.afterPositionGizmoSetPositions(),!1);case event_enum_1.NodeOperationType.RESET_COMPONENT:return this.target&&this.target.onProbeChanged(!0,!0),!0;case event_enum_1.NodeEventType.LIGHT_PROBE_CHANGED:return!0;case event_enum_1.NodeOperationType.CREATE_COMPONENT:case event_enum_1.NodeEventType.NOTIFY_NODE_CHANGED:}return(null==o?void 0:o.source)===event_enum_1.EventSourceType.UNDO&&(this.target&&this.target.onProbeChanged(!0,!0),!0)}onTargetUpdate(){var o;null!=(o=super.onTargetUpdate)&&o.call(this),!this._isInitialized||this._originTarget&&this.target===this._originTarget||(this._originTarget=this.target,this.updateNodeTransformInfo(this._controller.probeSphere),this._boundingBoxRoot&&this.updateNodeTransformInfo(this._boundingBoxRoot),this._controller.updateController(),this._boundingBoxController.updateController())}onBBControllerMouseDown(o){this._isInitialized&&null!=this.target&&(this._minPosPath=this.getCompPropPath("minPos"),this._maxPosPath=this.getCompPropPath("maxPos"),this._boundingBoxController.recordStartPosition(),this._positionGizmo.hide())}onBBControllerMouseMove(o){this.onControlUpdate(this._minPosPath),this.onControlUpdate(this._maxPosPath),this._boundingBoxController.updateDataFromBBController(o),this.target&&this.onComponentChanged(this.target.node)}onBBControllerMouseUp(o){this.onControlEnd(this._minPosPath),this.onControlEnd(this._maxPosPath),this._boundingBoxController.updateController(),this._boundingBoxController.boundingBoxEditModeChanged(!0),this._positionGizmo.show()}updateNodeTransformInfo(o){this.checkCurrentTargetPointingSelf()&&this.target&&o.setWorldPosition(this.target.node.worldPosition)}lightProbeEditModeChanged(o){var t;o&&!this.checkCurrentTargetPointingSelf()||(o&&!this.visible()&&this.show(),o||config_1.default.toolsVisibility3d||this.hide(),o?(null!=(t=this._boundingBoxController.positionGizmo)&&t.hide(),this._boundingBoxController.positionGizmo=null,void 0===pivot&&(pivot=this._positionGizmo.controller.transformToolData.pivot,this._positionGizmo.controller.transformToolData.pivot="center"),this._controller.positionGizmo=this._positionGizmo,this._controller.positionGizmo.hide()):(void 0!==pivot&&(this._positionGizmo.controller.transformToolData.pivot=pivot,pivot=void 0),this._positionGizmo.nodes=cce.Gizmo.querySelectNodes(),null!=(t=this._controller.positionGizmo)&&t.show()),this._controller.lightProbeEditModeChanged(o))}boundingBoxEditModeChanged(o){var t;o&&!this.checkCurrentTargetPointingSelf()||(o?(null!=(t=this._controller.positionGizmo)&&t.hide(),this._controller.positionGizmo=null,this._boundingBoxController.positionGizmo=this._positionGizmo,this._boundingBoxRoot&&this.updateNodeTransformInfo(this._boundingBoxRoot),this._boundingBoxController.boundingBoxEditModeChanged(!0)):(this._boundingBoxRoot&&this.updateNodeTransformInfo(this._boundingBoxRoot),this._boundingBoxController.boundingBoxEditModeChanged(!1),this._boundingBoxController.positionGizmo=null,this._controller.positionGizmo=this._positionGizmo,this.target&&null!=(t=this.target.iconGizmo)&&t.hide(),this._positionGizmo.nodes=cce.Gizmo.querySelectNodes(),this._controller.positionGizmo.show()),this._controller.boundingBoxEditModeChanged(o))}lightProbeInfoChanged(){this._controller.lightProbeInfoChanged()}checkCurrentTargetPointingSelf(){var o;return!!this.target&&!!this.target.node&&!!(o=this.target.node.getComponent(cc_1.LightProbeGroup))&&(null==o?void 0:o.gizmo)===this}duplicateCurrentSelectedProbes(){return this._controller.duplicateCurrentSelectedProbes()}deleteCurrentSelectedProbes(){return this._controller.deleteCurrentSelectedProbes()}select(o){this._controller.select(o)}selectAll(){this._controller.selectAll()}unselect(o){this._controller.unselect(o)}unselectAll(){this._controller.unselectAll()}onNotGizmoMouseDown(o){this._controller.onNotGizmoMouseDown(o)}onNotGizmoMouseMove(o){this._controller.onNotGizmoMouseMove(o)}onNotGizmoMouseUp(o){this._controller.onNotGizmoMouseUp(o)}shouldEmitNodes(){return this._controller.shouldEmitNodes()}currentSelectedNodes(){return this._controller.currentSelectedNodes()}}exports.default=LightProbeGizmo;class LightProbePositionGizmo extends position_1.default{constructor(){super(...arguments),this.__nodes=[],this.disableUndo=!0}set nodes(o){this.__nodes=o,this.onTargetUpdate()}get nodes(){return this.__nodes}}exports.LightProbePositionGizmo=LightProbePositionGizmo;