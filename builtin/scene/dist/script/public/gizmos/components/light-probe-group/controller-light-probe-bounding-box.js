"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),external_1=__importDefault(require("../../utils/external")),box_1=__importDefault(require("../../controller/box")),NodeUtils=external_1.default.NodeUtils;class LightProbeBoundingBoxController extends box_1.default{get editMode(){return this._editMode}set positionGizmo(i){if(i&&!i.controller&&i.init(),this.positionGizmo&&this.positionGizmo.removeMouseEventListener(this._gizmoEventListenerIndex),i){const e=[],n=[],s=[];cce.Gizmo.walkAllLightProbeGizmoListener(t=>{var o=t.boundingBoxController.getRoot();o&&t.target&&(n.push(o),s.push(t),e.push(t.target.uuid))}),i.nodes=n;const r=[];this._gizmoEventListenerIndex=i.addMouseEventListener(new class{constructor(){this.undoID="",this.recording=!1}onControlBegin(){this.recording||(this.undoID=cce.SceneFacadeManager.beginRecording(e),this.recording=!0)}onControlEnd(){this.recording&&this.undoID&&(cce.SceneFacadeManager.endRecording(this.undoID),this.recording=!1)}onControllerMouseDown(t){this.onControlBegin();for(let t=r.length=0;t<i.nodes.length;t++)r.push(i.nodes[t].position.clone())}onControllerMouseUp(t){for(let t=0;t<i.nodes.length;t++){var o=i.nodes[t].position.subtract(r[t]),e=s[t];e.target&&(e.target.maxPos=e.target.maxPos.add(o),e.target.minPos=e.target.minPos.add(o),e.onComponentChanged(e.target.node))}cce.Engine.repaintInEditMode(),this.onControlEnd()}})}this._positionGizmo=i}get positionGizmo(){return this._positionGizmo}constructor(t,o){super(t),this.gizmo=o,this._editable=!0,this._boundingBoxScale=new cc_1.Vec3(1,1,1),this._minPos=new cc_1.Vec3,this._maxPos=new cc_1.Vec3,this._startPos=new cc_1.Vec3,this._editMode=!1,this._gizmoEventListenerIndex="",this._positionGizmo=null,this.setColor(cc_1.Color.GREEN),this.edit=!0}show(){super.show(),this.updateController()}recordStartPosition(){var t;this.gizmo.target&&(this._boundingBoxScale=NodeUtils.getWorldScale3D(this._rootNode),t=this.getRoot(),this._minPos.set(this.gizmo.target.minPos),this._maxPos.set(this.gizmo.target.maxPos),this._startPos.set(t.getWorldPosition()))}updateDataFromBBController(t){var o,e;this.gizmo.target&&this.updated&&(o=this.getDeltaSize().clone(),e=this.getRoot(),o.divide(this._boundingBoxScale),o.divide((0,cc_1.v3)(2,2,2)),t.handleName.includes("neg")?(t=(0,cc_1.v3)(this._minPos).subtract(o),this.gizmo.target.minPos=t):(t=(0,cc_1.v3)(this._maxPos).add(o),this.gizmo.target.maxPos=t),o.divide((0,cc_1.v3)(2,2,2)),e.position=this.getBoundingBoxCenter(),this.updateSize(e.position,(0,cc_1.v3)(this.gizmo.target.maxPos).subtract(this.gizmo.target.minPos)),null!=(t=this.positionGizmo))&&t.onTargetUpdate()}onShow(){var t;this.gizmo.target&&(super.onShow(),(t=this.getRoot())&&(t.setWorldPosition(this.getBoundingBoxCenter().add(this.gizmo.target.node.getWorldPosition())),null!=(t=this.positionGizmo)&&t.onTargetUpdate(),this.updateSize((0,cc_1.v3)(),(0,cc_1.v3)(this.gizmo.target.maxPos).subtract(this.gizmo.target.minPos))),null!=(t=this._positionGizmo))&&t.show()}onHide(){var t;super.onHide(),null!=(t=this._positionGizmo)&&t.hide()}getBoundingBoxCenter(){return this.gizmo.target?(0,cc_1.v3)(this.gizmo.target.maxPos).add(this.gizmo.target.minPos).divide((0,cc_1.v3)(2,2,2)):new cc_1.Vec3}setBoundingBoxCenter(t){this.gizmo.target&&this.updateController()}lightProbeEditModeChanged(t){this.hide(),cce.Engine.repaintInEditMode()}boundingBoxEditModeChanged(t){(this._editMode=t)?this.show():this.hide(),cce.Engine.repaintInEditMode()}}exports.default=LightProbeBoundingBoxController;