"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),external_1=__importDefault(require("../../utils/external")),base_1=require("../base"),box_1=__importDefault(require("../../controller/box")),NodeUtils=external_1.default.NodeUtils,tempVec3_a=new cc_1.Vec3,PLANE="40563723-f8fc-4216-99ea-a81636435c10",SPHERE="655c9519-1a37-472b-bae6-29fefac0b550";class ReflectionProbeGizmo extends base_1.SelectGizmo{constructor(){super(...arguments),this._bbHalfSize=new cc_1.Vec3,this._sphereMeshRenderer=null,this._planeMeshRenderer=null,this._sphere=null,this._plane=null,this._loadModelState="idle"}onBBControllerMouseDown(e){this._isInitialized&&null!=this.target&&this.target instanceof cc_1.ReflectionProbe&&this._bbHalfSize.set(this.target.size)}onBBControllerMouseMove(e){var t,r;this.target instanceof cc_1.ReflectionProbe&&null!=(t=this._controller)&&t.updated&&this.target&&(this.recordChanges(),t=this.target.node,r=this._controller.getDeltaSize(),cc_1.Vec3.add(tempVec3_a,this._bbHalfSize,r),this.target.size.set(0<tempVec3_a.x?tempVec3_a.x:0,0<tempVec3_a.y?tempVec3_a.y:0,0<tempVec3_a.z?tempVec3_a.z:0),this.onComponentChanged(t))}onBBControllerMouseUp(e){this.commitChanges()}init(){this.createController()}onShow(){this._isInitialized&&(this._sphere&&this._sphereMeshRenderer&&this._plane&&this._planeMeshRenderer?(this.updateControllerTransform(),this._controller.show(),this.target instanceof cc_1.ReflectionProbe&&(this._sphere&&(this.target.previewSphere=this._sphere),this._plane)&&(this.target.previewPlane=this._plane)):this.loadModel())}generateMaterial(e){var t=new cc_1.Material;return t.initialize(null!=e?e:{effectName:"builtin-standard"}),t}onHide(){this._controller.hide(),this._sphere&&(this._sphere.active=!1),this._plane&&(this._plane.active=!1),this.target instanceof cc_1.ReflectionProbe&&(this.target.previewSphere=null)}createController(){var e=this.getGizmoRoot();this._controller=new box_1.default(e),this._controller.setColor(cc_1.Color.GREEN),this._controller.editable=!0,this._controller.edit=!0,this._controller.onControllerMouseDown=this.onBBControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onBBControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onBBControllerMouseUp.bind(this),this.onHide(),this.loadModel()}loadModel(){"loading"!==this._loadModelState&&(this._loadModelState="loading",Promise.all([this.loadPlane(),this.loadSphere()]).then(([e,t])=>{var r=this.getGizmoRoot();this._plane=(0,cc_1.instantiate)(e),this._plane.layer=cc_1.Layers.Enum.IGNORE_RAYCAST|cc_1.Layers.Enum.GIZMOS,this._plane.name=ReflectionProbeGizmo.PLANE_NODE_NAME,this._planeMeshRenderer=this._plane.getComponent(cc_1.MeshRenderer),this._planeMeshRenderer&&(this._planeMeshRenderer.material=this.generateMaterial({effectName:"builtin-standard",technique:1}),this._planeMeshRenderer.material.setProperty("albedo",(0,cc_1.color)(255,255,255,145)),this._planeMeshRenderer.material.setProperty("metallic",1),this._planeMeshRenderer.material.setProperty("roughness",0),this._planeMeshRenderer.bakeSettings.reflectionProbe=cc_1.ReflectionProbeType.PLANAR_REFLECTION),this._plane.active=!1,this._plane.parent=r,this._sphere=(0,cc_1.instantiate)(t),this._sphere.layer=cc_1.Layers.Enum.IGNORE_RAYCAST|cc_1.Layers.Enum.GIZMOS,this._sphere.name=ReflectionProbeGizmo.SPHERE_NODE_NAME,this._sphereMeshRenderer=this._sphere.getComponent(cc_1.MeshRenderer),this._sphereMeshRenderer&&(this._sphereMeshRenderer.material=this.generateMaterial({effectName:"builtin-reflection-probe-preview",technique:0}),this._sphereMeshRenderer.bakeSettings.reflectionProbe=cc_1.ReflectionProbeType.BAKED_CUBEMAP,this._sphereMeshRenderer.bakeSettings.bakeToReflectionProbe=!1),this._sphere.parent=r,this._loadModelState="completed",this.onShow(),cce.Engine.repaintInEditMode()}).catch(e=>{console.error(e),this._loadModelState="idle"}))}loadSphere(){return new Promise((r,i)=>{ReflectionProbeGizmo._SPHERE_PREFAB?r(ReflectionProbeGizmo._SPHERE_PREFAB):cc_1.assetManager.loadAny(SPHERE,(e,t)=>{e?i(e):t instanceof cc_1.Prefab?(ReflectionProbeGizmo._SPHERE_PREFAB=t,r(t)):i(new Error("Invalid data type loaded for sphere. uuid: "+SPHERE))})})}loadPlane(){return new Promise((r,i)=>{ReflectionProbeGizmo._PLANE_PREFAB?r(ReflectionProbeGizmo._PLANE_PREFAB):cc_1.assetManager.loadAny(PLANE,(e,t)=>{e?i(e):t instanceof cc_1.Prefab?(ReflectionProbeGizmo._PLANE_PREFAB=t,r(t)):i(new Error("Invalid data type loaded for plane. uuid: "+PLANE))})})}updateControllerTransform(){this.updateControllerData()}updateControllerData(){var e,t,r,i;this._isInitialized&&null!=this.target&&this.target instanceof cc_1.ReflectionProbe&&(r=this.target.node,t=NodeUtils.getWorldPosition3D(r),r=NodeUtils.getWorldRotation(r),i=this.target.probeType===cc_1.renderer.scene.ProbeType.CUBE,this._controller.setScale(cc_1.Vec3.ONE),this._controller.updateSize(cc_1.Vec3.ZERO,cc_1.Vec3.multiplyScalar(tempVec3_a,this.target.size,2)),this._controller.setRotation(i?cc_1.Quat.IDENTITY:r),null!=(e=this._controller)&&e.setPosition(t),this._sphere&&this._sphereMeshRenderer&&(i?(this._sphere.active=!0,this._sphere.setWorldPosition(t)):this._sphere.active=!1),this._plane)&&this._planeMeshRenderer&&(i?this._plane.active=!1:(this._plane.active=!0,this._plane.setWorldPosition(t),this._plane.setRotation(r),this._plane.setScale(this.target.size.x/5,this.target.size.y/5,this.target.size.z/5)))}onTargetUpdate(){this.updateControllerData()}onNodeChanged(){this.updateControllerData()}}ReflectionProbeGizmo.SPHERE_NODE_NAME="Reflection Probe Sphere",ReflectionProbeGizmo.PLANE_NODE_NAME="Reflection Probe Plane",exports.default=ReflectionProbeGizmo;