"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),utils_1=__importDefault(require("../../utils")),engine_1=__importDefault(require("../../utils/engine")),external_1=__importDefault(require("../../utils/external")),box_1=__importDefault(require("../../controller/box")),circle_1=__importDefault(require("../../controller/circle")),hemisphere_1=__importDefault(require("../../controller/hemisphere")),sphere_1=__importDefault(require("../../controller/sphere")),controller_cone_1=__importDefault(require("./controller-cone")),base_1=require("../base"),create3DNode=engine_1.default["create3DNode"],NodeUtils=external_1.default.NodeUtils,EditorMath=external_1.default.EditorMath,tempVec3=new cc_1.Vec3,tempQuat_a=new cc_1.Quat,ShapeType={Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4},CurveRangeMode={Constant:0,Curve:1,TwoCurves:2,TwoConstants:3},EmitLocation={Base:0,Edge:1,Shell:2,Volume:3};class ParticleSystemComponentGizmo extends base_1.SelectGizmo{constructor(){super(...arguments),this._curEmitterShape=ShapeType.Box,this._shapeControllers={},this._PSGizmoColor=new cc_1.Color(100,100,255),this._activeController=null,this._pSGizmoRoot=null,this._scale=cc.v3(),this._size=cc.v3(),this._radius=0,this._arc=0,this._coneHeight=0,this._coneAngle=0,this._bottomRadius=0,this._bbHalfSize=new cc_1.Vec3}init(){this.createController(),this._isInitialized=!0}createController(){var e=this.getGizmoRoot();this._boundingBoxController=new box_1.default(e),this._boundingBoxController.setColor(cc_1.Color.GREEN),this._boundingBoxController.editable=!0,this._boundingBoxController.onControllerMouseDown=this.onBBControllerMouseDown.bind(this),this._boundingBoxController.onControllerMouseMove=this.onBBControllerMouseMove.bind(this),this._boundingBoxController.onControllerMouseUp=this.onBBControllerMouseUp.bind(this)}onShow(){this.updateControllerData()}onHide(){var e;null!=(e=this._activeController)&&e.hide(),this._boundingBoxController.hide()}createControllerByShape(e){var t=this.getGizmoRoot(),o=create3DNode("ParticleSystemGizmo");o.parent=t,this._pSGizmoRoot=o;let i=null;switch(e){case ShapeType.Box:i=new box_1.default(o);break;case ShapeType.Sphere:i=new sphere_1.default(o);break;case ShapeType.Circle:i=new circle_1.default(o);break;case ShapeType.Cone:i=new controller_cone_1.default(o);break;case ShapeType.Hemisphere:i=new hemisphere_1.default(o);break;default:console.error("Invalid Type:",e)}return i&&(i.editable=!0,i.setColor(this._PSGizmoColor),i.onControllerMouseDown=this.onControllerMouseDown.bind(this),i.onControllerMouseMove=this.onControllerMouseMove.bind(this),i.onControllerMouseUp=this.onControllerMouseUp.bind(this)),i}getControllerByShape(e){let t=this._shapeControllers[e];return t?t.setRoot(this._pSGizmoRoot):(t=this.createControllerByShape(e),this._shapeControllers[e]=t),t}getConeData(e){var e=e.shapeModule,t=e?e.radius:1,o=e?e.length:5;let i=e?e.angle:0,r=0;return i<0&&(i=0),{topRadius:t,height:o,bottomRadius:t+(r=90<=i?1e3:Math.tan(i*EditorMath.D2R)*o),coneAngle:i}}modifyConeData(t,o,i,r){t=t.shapeModule;if(t)if(0!==o){let e=this._radius+o;(e=EditorMath.toPrecision(e,3))<0&&(e=1e-4),t.radius=e}else if(0!==i){let e=this._coneHeight+i;(e=EditorMath.toPrecision(e,3))<=0&&(e=1e-4),t.length=e}else if(0!==r){let e=this._bottomRadius+r;e<this._radius&&(e=this._radius);o=Math.atan2(e-this._radius,this._coneHeight)*EditorMath.R2D;t.angle=EditorMath.toPrecision(o,3)}}setCurveRangeInitValue(e,t){let o;switch(e.mode){case CurveRangeMode.Constant:e.constant=t;break;case CurveRangeMode.Curve:(o=e.curve.keyFrames[0])&&(o.value=t);break;case CurveRangeMode.TwoCurves:(o=e.curveMax.keyFrames[0])&&(o.value=t);break;case CurveRangeMode.TwoConstants:e.constantMax=t;break;default:console.error("unknown cure range mode:",e.mode)}}onControllerMouseDown(){if(this._isInitialized&&null!==this.target){var e,t=this.target.shapeModule;switch(this._curEmitterShape=t.shapeType,this._scale=NodeUtils.getWorldScale3D(this.target.node),this._curEmitterShape){case ShapeType.Box:this._size=t.scale.clone();break;case ShapeType.Sphere:this._radius=t.radius;break;case ShapeType.Circle:this._radius=t.radius,this._arc=t.arc;break;case ShapeType.Cone:e=this.getConeData(this.target),this._radius=e.topRadius,this._coneHeight=e.height,this._coneAngle=e.coneAngle,this._bottomRadius=e.bottomRadius;break;case ShapeType.Hemisphere:this._radius=t.radius}}}onControllerMouseMove(){this.updateDataFromController()}onControllerMouseUp(){this.commitChanges()}getScaledDeltaRadius(e,t,o){return 0!==t.x?e/=o.x:0!==t.y?e/=o.y:0!==t.z&&(e/=o.z),e}updateDataFromController(){if(null!=(e=this._activeController)&&e.updated&&this.target){this.recordChanges();var e=this.target.node,t=this.target.shapeModule;switch(this._curEmitterShape){case ShapeType.Box:var o=this._activeController.getDeltaSize(),o=(cc_1.Vec3.divide(o,o,this._scale),cc_1.Vec3.multiplyScalar(o,o,2),cc_1.Vec3.add(tempVec3,this._size,o));utils_1.default.clampSize(o),t.scale=o;break;case ShapeType.Sphere:var o=this._activeController.getDeltaRadius(),i=this._activeController.getControlDir(),o=this.getScaledDeltaRadius(o,i,this._scale),i=this._radius+o,i=Math.abs(i);i=EditorMath.toPrecision(i,3),t.radius=i;break;case ShapeType.Circle:{let e=this._activeController.getDeltaRadius();o=this._activeController.getControlDir(),i=(0!==o.x?e/=this._scale.x:0!==o.y&&(e/=this._scale.y),this._radius+e),i=Math.abs(i);i=EditorMath.toPrecision(i,3),t.radius=i;break}case ShapeType.Cone:var o=this._activeController.getDeltaRadius(),i=this._activeController.getDeltaHeight(),r=this._activeController.getDeltaBottomRadius();this.modifyConeData(this.target,o,i,r);break;case ShapeType.Hemisphere:o=this._activeController.getDeltaRadius(),i=this._activeController.getControlDir(),o=this.getScaledDeltaRadius(o,i,this._scale),r=this._radius+o,r=Math.abs(r);r=EditorMath.toPrecision(r,3),t.radius=r}this.onComponentChanged(e)}}updateControllerTransform(){var e,t,o,i;this.target&&this.target.shapeModule&&(this.target,(e=this.target.shapeModule).enable)&&this._pSGizmoRoot&&(t=this.target.node,i=tempQuat_a,o=NodeUtils.getWorldPosition3D(t),NodeUtils.getWorldRotation3D(t,i),t=NodeUtils.getWorldScale3D(t),this._pSGizmoRoot.setWorldPosition(o),this._pSGizmoRoot.setWorldRotation(i),this._pSGizmoRoot.setWorldScale(t),o=e.rotation,i=tempQuat_a,cc_1.Quat.fromEuler(i,o.x,o.y,o.z),this._activeController)&&(this._activeController.setPosition(e.position),this._activeController.setRotation(i),this._activeController.setScale(e.scale))}getConeRadius(e,t){return Math.tan(e/2*EditorMath.D2R)*t}updateControllerData(){if(this._isInitialized&&null!==this.target){var e,t=this.target.shapeModule;if(t.enable){switch(this._activeController&&(e=this._activeController._isMouseDown,this._activeController.hide(),this._activeController._isMouseDown=e),this._activeController=this.getControllerByShape(t.shapeType),null!=(e=this._activeController)&&e.checkEdit(),this.updateControllerTransform(),t.shapeType){case ShapeType.Box:var o=this._activeController;o.edit&&o.updateEditHandles(),o.adjustEditHandlesSize();break;case ShapeType.Sphere:this._activeController.radius=t.radius;break;case ShapeType.Circle:this._activeController.updateSize(cc.v3(),t.radius,t.arc);break;case ShapeType.Cone:o=this.getConeData(this.target);o&&this._activeController.updateSize(cc.v3(),o.topRadius,o.height,o.bottomRadius);break;case ShapeType.Hemisphere:this._activeController.radius=t.radius}null!=(e=this._activeController)&&e.show()}else null!=(e=this._activeController)&&e.hide();this.updateBBControllerData()}}onTargetUpdate(){this.updateControllerData()}onNodeChanged(){this.updateControllerData()}updateDataFromBBController(){var e,t;this._boundingBoxController.updated&&this.target&&(this.recordChanges(),e=this.target.node,t=this._boundingBoxController.getDeltaSize(),cc_1.Vec3.add(tempVec3,this._bbHalfSize,t),(t=this.target).aabbHalfX=tempVec3.x,t.aabbHalfY=tempVec3.y,t.aabbHalfZ=tempVec3.z,this.onComponentChanged(e))}updateBBControllerData(){var e,t;this.target&&(e=(t=this.target)._boundingBox,t.renderCulling&&e&&t._isShowBB?(this._boundingBoxController.edit=!0,this._boundingBoxController.setPosition(e.center),t=e.halfExtents,this._boundingBoxController.updateSize(cc_1.Vec3.ZERO,tempVec3.set(2*t.x,2*t.y,2*t.z)),this._boundingBoxController.show()):this._boundingBoxController.hide())}onBBControllerMouseDown(){var e;this._isInitialized&&null!=this.target&&(e=this.target,this._bbHalfSize.set(e.aabbHalfX,e.aabbHalfY,e.aabbHalfZ))}onBBControllerMouseMove(){this.updateDataFromBBController()}onBBControllerMouseUp(){this.commitChanges()}showBoundingBox(e){var t;this.target&&((t=this.target)&&(t._isShowBB=e),this.updateBBControllerData())}isShowBoundingBox(){var e;return null==(e=this.target)?void 0:e._isShowBB}}exports.default=ParticleSystemComponentGizmo;