"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),controller_shape_1=__importDefault(require("../../utils/controller-shape")),controller_utils_1=__importDefault(require("../../utils/controller-utils")),engine_1=__importDefault(require("../../utils/engine")),editable_1=__importDefault(require("../../controller/editable")),{AttributeName,setMeshColor,getModel,updatePositions}=engine_1.default,tempVec3=new cc_1.Vec3;class ParticleSystemConeController extends editable_1.default{constructor(t){super(t),this._oriDir=new cc_1.Vec3(0,0,-1),this._center=new cc_1.Vec3,this._radius=100,this._height=100,this._bottomRadius=120,this._deltaRadius=0,this._deltaHeight=0,this._deltaBottomRadius=0,this._coneLineNode=null,this._circleNode=null,this._bottomCircleNode=null,this._circleFromDir=new cc_1.Vec3(1,0,0),this._coneLineMR=null,this._circleMR=null,this._bottomCircleMR=null,this._mouseDeltaPos=new cc_1.Vec2,this._curDistScalar=0,this._axisDir={},this._axisDir.x=new cc_1.Vec3(1,0,0),this._axisDir.y=new cc_1.Vec3(0,1,0),this._axisDir.neg_x=new cc_1.Vec3(-1,0,0),this._axisDir.neg_y=new cc_1.Vec3(0,-1,0),this._axisDir.bottom_x=new cc_1.Vec3(1,0,0),this._axisDir.bottom_y=new cc_1.Vec3(0,1,0),this._axisDir.bottom_neg_x=new cc_1.Vec3(-1,0,0),this._axisDir.bottom_neg_y=new cc_1.Vec3(0,-1,0),this._axisDir.bottom_neg_z=new cc_1.Vec3(0,0,-1),this._editHandleKeys=Object.keys(this._axisDir),this.initShape()}get radius(){return this._radius}set radius(t){this.updateSize(this._center,t,this._height,this._bottomRadius)}get height(){return this._height}set height(t){this.updateSize(this._center,this._radius,t,this._bottomRadius)}setColor(t){setMeshColor(this._coneLineNode,t),setMeshColor(this._circleNode,t),setMeshColor(this._bottomCircleNode,t),this.setEditHandlesColor(t),this._color=t}_updateEditHandle(t){var e=this._handleDataMap[t].topNode,i=this._axisDir[t],s=new cc_1.Vec3,t=("bottom"===t.substr(0,6)?(cc_1.Vec3.multiplyScalar(s,this._oriDir,this._height),"bottom_neg_z"!==t&&(cc_1.Vec3.multiplyScalar(tempVec3,i,this._bottomRadius),s.add(tempVec3))):(cc_1.Vec3.multiplyScalar(tempVec3,i,this._radius),s.add(tempVec3)),new cc_1.Vec3(s));t.add(this._center),cc_1.Vec3.multiply(t,t,this.getScale()),e.setPosition(t)}initShape(){this.createShapeNode("ConeController");var t=this.getConeLineData(),t=controller_utils_1.default.createShapeByData(t,this._color,{name:"coneLines"}),t=(t.parent=this.shape,this._coneLineNode=t,this._coneLineMR=getModel(t),controller_utils_1.default.arc(this._center,this._oriDir,this._circleFromDir,this._twoPI,this._radius,this._color)),t=(t.parent=this.shape,this._circleNode=t,this._circleMR=getModel(t),controller_utils_1.default.arc(this._center,this._oriDir,this._circleFromDir,this._twoPI,this._bottomRadius,this._color)),e=(t.parent=this.shape,new cc_1.Vec3);cc_1.Vec3.multiplyScalar(e,this._oriDir,this._height),t.setPosition(e.x,e.y,e.z),this._bottomCircleNode=t,this._bottomCircleMR=getModel(t),this.hide()}getConeLineData(){var e=[],i=[];let s=controller_shape_1.default.calcArcPoints(this._center,this._oriDir,this._circleFromDir,this._twoPI,this._radius,5);s=s.slice(0,s.length-1);var t=new cc_1.Vec3,o=(cc_1.Vec3.multiplyScalar(t,this._oriDir,this._height),new cc_1.Vec3);cc_1.Vec3.add(o,this._center,t);let r=controller_shape_1.default.calcArcPoints(o,this._oriDir,this._circleFromDir,this._twoPI,this._bottomRadius,5);r=r.slice(0,r.length-1);for(let t=0;t<s.length;t++){e.push(s[t]),e.push(r[t]);var c=2*t;i.push(c,1+c)}return controller_shape_1.default.calcLinesData(e,i,!1)}updateSize(t,e,i,s){this._center=t,this._radius=e,this._height=i,this._bottomRadius=s;t=this.getConeLineData(),updatePositions(this._coneLineMR,t.positions),e=controller_shape_1.default.calcArcPoints(this._center,this._oriDir,this._circleFromDir,this._twoPI,this._radius),updatePositions(this._circleMR,e),i=controller_shape_1.default.calcArcPoints(this._center,this._oriDir,this._circleFromDir,this._twoPI,this._bottomRadius),updatePositions(this._bottomCircleMR,i),s=new cc_1.Vec3;cc_1.Vec3.multiplyScalar(s,this._oriDir,this._height),this._bottomCircleNode.setPosition(s.x,s.y,s.z),this._edit&&this.updateEditHandles(),this.adjustEditHandlesSize()}onMouseDown(t){this._mouseDeltaPos=new cc_1.Vec2(0,0),this._curDistScalar=super.getDistScalar(),this._deltaRadius=0,this._deltaHeight=0,this._deltaBottomRadius=0,this.onControllerMouseDown&&this.onControllerMouseDown(t)}onMouseMove(t){var e;this._isMouseDown&&(this._mouseDeltaPos.x+=t.moveDeltaX,this._mouseDeltaPos.y+=t.moveDeltaY,e=this._axisDir[t.handleName],e=this.getAlignAxisMoveDistance(this.localToWorldDir(e),this._mouseDeltaPos)*this._curDistScalar,"bottom_neg_z"===t.handleName?this._deltaHeight=e:"bottom"===t.handleName.substr(0,6)?this._deltaBottomRadius=e:this._deltaRadius=e,this.onControllerMouseMove)&&this.onControllerMouseMove(t)}onMouseUp(t){this.onControllerMouseUp&&this.onControllerMouseUp(t)}onMouseLeave(t){this.onMouseUp(t)}getDeltaRadius(){return this._deltaRadius}getDeltaHeight(){return this._deltaHeight}getDeltaBottomRadius(){return this._deltaBottomRadius}}exports.default=ParticleSystemConeController;