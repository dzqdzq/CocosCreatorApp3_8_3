"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainEditorSelect=exports.TerrainEditorWeightMapData=void 0;const terrain_editor_mode_1=require("./terrain-editor-mode"),cc_1=require("cc");class TerrainEditorWeightMapData{constructor(){this.data=new Uint8Array,this.width=0,this.height=0}}exports.TerrainEditorWeightMapData=TerrainEditorWeightMapData;class TerrainEditorSelect extends terrain_editor_mode_1.TerrainEditorMode{constructor(e){super(e),this._selectMaterial=null,this._selectBlock=null,this._weightMap=null,this._weightData=null,this._layerList=[];e=cc.EffectAsset.get("internal/editor/terrain-select-brush");e&&(this._selectMaterial=new cc_1.Material,this._selectMaterial.initialize({effectAsset:e}))}setSelectBlock(a){if(this._selectBlock!==a)if(cce.Plugin.sendToFloatWindow("cc.Terrain",{action:"block-update"}),this._selectBlock&&this._updateBlockSelectMaterial(this._selectBlock,null),null!==a){var e=a.getTerrain();if(this._selectBlock=a,this._weightMap=a.weightmap,this._weightData=null,this._weightMap){this._weightData=new TerrainEditorWeightMapData,this._weightData.width=e.info.weightMapSize,this._weightData.height=e.info.weightMapSize,this._weightData.data=new Uint8Array(this._weightData.width*this._weightData.height*4);let i=0;var r=a.getIndex()[0]*e.info.weightMapSize,l=a.getIndex()[1]*e.info.weightMapSize,c=r+e.info.weightMapSize,s=l+e.info.weightMapSize;for(let t=l;t<s;++t)for(let e=r;e<c;++e){var n=a.getTerrain().getWeight(e,t);this._weightData.data[i++]=(0,cc_1.clamp)(255*n.x,0,255),this._weightData.data[i++]=(0,cc_1.clamp)(255*n.y,0,255),this._weightData.data[i++]=(0,cc_1.clamp)(255*n.z,0,255),this._weightData.data[i++]=(0,cc_1.clamp)(255*n.w,0,255)}}this._layerList.length=a.layers.length;for(let e=0;e<a.layers.length;++e){var t=a.layers[e];0<=t?(t=a.getTerrain().getLayer(t),this._layerList[e]=t?t.detailMap:null):this._layerList[e]=null}this._updateBlockSelectMaterial(a,this._selectMaterial)}else this._selectBlock=null,this._weightMap=null,this._weightData=null,this._layerList=[]}getSelectBlock(){return this._selectBlock}getCurrentBlockIndex(){return this._selectBlock?this._selectBlock.getIndex():null}getCurrentWeightMap(){return this._weightMap}getCurrentWeightData(){return this._weightData}getCurrentLayerList(){return this._layerList}onDeactivate(){this.setSelectBlock(null)}onMouseDown(e,t,i,a){var r=t.node.getPosition(),l=new cc_1.Vec3(0,0,0),c=new cc_1.Vec3(0,0,0),t=(t.screenToWorld(new cc_1.Vec3(i,a,0),l),cc_1.Vec3.subtract(c,l,r),cc_1.Vec3.normalize(c,c),this._pickTerrainBlock(e,r,c,.35));t&&this.setSelectBlock(t)}_pickTerrainBlock(t,e,i,a){var r=e,l=(cc_1.Vec3.subtract(r,e,t.node.getWorldPosition()),new cc_1.Vec3);l.set(i),l.multiplyScalar(a);let c=null;if(i.equals(new cc_1.Vec3(0,1,0))){e=t.getHeightAt(r.x,r.z);null!==e&&r.y<=e&&(c=new cc_1.Vec3(r.x,e,r.z))}else if(i.equals(new cc_1.Vec3(0,-1,0))){a=t.getHeightAt(r.x,r.z);null!==a&&r.y>=a&&(c=new cc_1.Vec3(r.x,a,r.z))}else{let e=0;for(;e++<2e3;){var s=t.getHeightAt(r.x,r.z);if(null!==s&&r.y<=s)break;r.add(i)}for(;e++<2e3;){var n=t.getHeightAt(r.x,r.z);if(null!==n&&r.y<=n){c=new cc_1.Vec3(r.x,n,r.z);break}r.add(l)}}if(!c)return null;var h=new cc_1.Vec2(c.x,c.z);let o=null;for(const u of t.getBlocks()){var _=u.getIndex(),g=new cc_1.Rect;if(g.x=_[0]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*t.info.tileSize,g.y=_[1]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*t.info.tileSize,g.width=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*t.info.tileSize,g.height=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*t.info.tileSize,g.contains(h)){o=u;break}}return o}_updateBlockSelectMaterial(e,t){e.setBrushMaterial(t)}}exports.TerrainEditorSelect=TerrainEditorSelect;