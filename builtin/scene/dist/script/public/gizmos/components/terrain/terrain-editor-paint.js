"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainEditorPaint=void 0;const cc_1=require("cc"),terrain_brush_1=require("./terrain-brush"),terrain_editor_mode_1=require("./terrain-editor-mode"),terrain_operation_1=require("./terrain-operation"),clamp=cc_1.math.clamp;class TerrainEditorPaint extends terrain_editor_mode_1.TerrainEditorMode{constructor(r){super(r),this._undo=null,this._currentLayer=-1;var r=new terrain_brush_1.TerrainCircleBrush,e=(r.strength=5,new terrain_brush_1.TerrainImageBrush);e.strength=5,this._brushes=[r,e],this._currentBrush=this._brushes[0]}setCurrentBrush(r){var e=this._currentBrush.position,t=this._currentBrush.radius,i=this._currentBrush.strength,s=this._currentBrush._setHeight,n=this._currentBrush._rotation;this._currentBrush=this._brushes[r],this._currentBrush.position=e,this._currentBrush.radius=t,this._currentBrush.strength=i,this._currentBrush._setHeight=s,this._currentBrush._rotation=n}getCurrentBrush(){return this._currentBrush}getBrush(r){return this._brushes[r]}setBrushImage(r){null!==(this.getBrush(terrain_brush_1.TerrainBrushType.IMAGE).image=r)?this.setCurrentBrush(terrain_brush_1.TerrainBrushType.IMAGE):this.setCurrentBrush(terrain_brush_1.TerrainBrushType.CIRCLE)}setCurrentLayer(r){this._currentLayer=r}getCurrentLayer(){return this._currentLayer}onUpdate(r,e){null!=this._undo&&(this._updateWeight(r,e),r.isTerrainChange=!0)}onUpdateBrushPosition(r,e){var t=this._currentBrush,e=(t.update(r,e),r.getBlocks());for(const n of e){var i=n.getIndex(),s=new cc_1.Rect,i=(s.x=i[0]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,s.y=i[1]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,s.width=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,s.height=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,new cc_1.Rect);i.x=t.position.x-t.radius,i.y=t.position.z-t.radius,i.width=2*t.radius,i.height=2*t.radius,s.intersects(i)?n.setBrushMaterial(t.material):n.setBrushMaterial(null)}}onMouseDown(r){-1!==this._currentLayer&&(this._undo=new terrain_operation_1.TerrainWeightUndoRedo(this.gizmo._target))}onMouseUp(){this._undo&&cce.SceneFacadeManager.beginRecording("",{customCommand:this._undo,auto:!0}),this._undo=null}onDeactivate(){var r=this._gizmo.editor.getEditTerrain();r&&null!==r._asset||(this._currentLayer=-1)}_updateWeight(t,i){var s=t.info.weightMapSize*t.info.blockCount[0],n=t.info.weightMapSize*t.info.blockCount[1];if(0!=s&&0!=n){var h=this._currentBrush,a=h.position.x-h.radius,r=h.position.z-h.radius,u=h.position.x+h.radius,o=h.position.z+h.radius;if(a=a/t.info.size.width*(s-1),r=r/t.info.size.height*(n-1),u=u/t.info.size.width*(s-1),o=o/t.info.size.height*(n-1),a=Math.floor(a),r=Math.floor(r),u=Math.floor(u),o=Math.floor(o),!(s-1<a||u<0||n-1<r||o<0)){var a=clamp(a,0,s-1),r=clamp(r,0,n-1),u=clamp(u,0,s-1),o=clamp(o,0,n-1),_=new terrain_operation_1.TerrainWeightOperation(t);this._undo&&this._undo.redoOperations.push(_);for(let e=r;e<=o;++e)for(let r=a;r<=u;++r){var c=t.getWeight(r,e),l=Math.floor(r/t.info.weightMapSize),d=Math.floor(e/t.info.weightMapSize),l=t.getBlock(l,d),d=[l.getLayer(0),l.getLayer(1),l.getLayer(2),l.getLayer(3)],g=r/(s-1)*t.info.size.width,p=e/(n-1)*t.info.size.height,g=h.getDelta(g,p)*i;if(0!=g){if(d[0]===this._currentLayer)c.x+=g;else if(d[1]===this._currentLayer)c.y+=g;else if(d[2]===this._currentLayer)c.z+=g;else if(d[3]===this._currentLayer)c.w+=g;else if(-1===d[0])l.setLayer(0,this._currentLayer),c.x+=g;else if(-1===d[1])l.setLayer(1,this._currentLayer),c.y+=g;else if(-1===d[2])l.setLayer(2,this._currentLayer),c.z+=g;else{if(-1!==d[3])continue;l.setLayer(3,this._currentLayer),c.w+=g}p=c.x+c.y+c.z+c.w;0<p&&c.multiplyScalar(1/p),null!=this._undo&&(this._undo.push(r,e,t.getWeight(r,e)),this._undo.pushBlock(l,d,l.layers)),_.push(r,e,c)}}_.apply()}}}}exports.TerrainEditorPaint=TerrainEditorPaint;