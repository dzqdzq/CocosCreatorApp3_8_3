"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainWeightUndoRedo=exports.TerrainBlockLayerData=exports.TerrainWeightOperation=exports.TerrainLayerUndoRedo=exports.TerrainLayerOperation=exports.TerrainWeightData=exports.TerrainHeightUndoRedo=exports.TerrainHeightOperation=exports.TerrainHeightData=void 0;const cc_1=require("cc"),undo_1=require("../../../../export/undo");class TerrainHeightData{constructor(){this.x=0,this.y=0,this.value=0}}exports.TerrainHeightData=TerrainHeightData;class TerrainHeightOperation extends undo_1.SceneUndoCommand{constructor(e){super(),this.data=new Array,this._terrain=e}set terrain(e){this._terrain=e}get terrain(){return this._terrain}static addChangeList(e,r){for(const t of e)if(t===r)return;e.push(r)}push(e,r,t){for(const i of this.data)if(i.x===e&&i.y===r)return;var a=new TerrainHeightData;a.x=e,a.y=r,a.value=t,this.data.push(a)}apply(){if(this._terrain&&0!=this.data.length){let t=this.data[0].x,a=this.data[0].x,e=this.data[0].y,i=this.data[0].y;for(const o of this.data)this._terrain.setHeight(o.x,o.y,o.value),t=Math.min(t,o.x),a=Math.max(a,o.x),e=Math.min(e,o.y),i=Math.max(i,o.y);0<t&&--t,a<this._terrain.info.vertexCount[0]-1&&(a+=1),0<e&&--e,i<this._terrain.info.vertexCount[1]-1&&i;for(let r=e;r<=i;++r)for(let e=t;e<=a;++e){var s=this._terrain._calcNormal(e,r);this._terrain._setNormal(e,r,s)}var r=new Array,n=new cc_1.Rect(t,e,a-t,i-e);for(const h of this._terrain.getBlocks())h.getRect().intersects(n)&&TerrainHeightOperation.addChangeList(r,h);for(const c of r)c._updateHeight(),c.update()}}}class TerrainHeightUndoRedo extends(exports.TerrainHeightOperation=TerrainHeightOperation){constructor(){super(...arguments),this.redoOperations=[]}async undo(){this.apply()}async redo(){this.redoOperations.forEach(e=>{e.apply()})}}exports.TerrainHeightUndoRedo=TerrainHeightUndoRedo;class TerrainWeightData{constructor(){this.x=0,this.y=0,this.value=new cc_1.Vec4}}exports.TerrainWeightData=TerrainWeightData;class TerrainLayerOperation{constructor(e){this._layers=[],this._terrain=e}set terrain(e){this._terrain=e}get terrain(){return this._terrain}setLayers(){for(let e=0;e<this.terrain._layers.length;e++)this._layers[e]=this.terrain._layers[e]}apply(){for(let e=0;e<this._layers.length;e++)this.terrain.setLayer(e,this._layers[e])}}class TerrainLayerUndoRedo extends(exports.TerrainLayerOperation=TerrainLayerOperation){constructor(){super(...arguments),this.redoOperations=[]}undo(){this.apply()}redo(){this.redoOperations.forEach(e=>{e.apply()})}}exports.TerrainLayerUndoRedo=TerrainLayerUndoRedo;class TerrainWeightOperation extends undo_1.SceneUndoCommand{constructor(e){super(),this.data=new Array,this._terrain=e}set terrain(e){this._terrain=e}get terrain(){return this._terrain}static addChangeList(e,r){for(const t of e)if(t===r)return;e.push(r)}push(e,r,t){for(const i of this.data)if(i.x===e&&i.y===r)return;var a=new TerrainWeightData;a.x=e,a.y=r,a.value=t,this.data.push(a)}apply(){if(this._terrain){for(const t of this.data)this._terrain.setWeight(t.x,t.y,t.value);var e=new Array;for(const a of this._terrain.getBlocks()){var r=new cc_1.Rect;r.x=a.getIndex()[0]*this._terrain.info.weightMapSize,r.y=a.getIndex()[1]*this._terrain.info.weightMapSize,r.width=this._terrain.info.weightMapSize,r.height=this._terrain.info.weightMapSize;for(const i of this.data)r.contains(new cc_1.Vec2(i.x,i.y))&&TerrainWeightOperation.addChangeList(e,a)}for(const s of e)s._updateWeightMap(),s.update()}}}exports.TerrainWeightOperation=TerrainWeightOperation;class TerrainBlockLayerData{constructor(e,r){this.layers=[-1,-1,-1,-1],this.block=e,this.layers.length=r.length;for(let e=0;e<r.length;++e)this.layers[e]=r[e]}}exports.TerrainBlockLayerData=TerrainBlockLayerData;class TerrainWeightUndoRedo extends TerrainWeightOperation{constructor(){super(...arguments),this.undoBlockLayers=new Array,this.redoBlockLayers=new Array,this.redoOperations=[]}async undo(){this.apply()}async redo(){for(const t of this.redoBlockLayers){var e=t.block,r=t.layers;e.setLayer(0,r[0]),e.setLayer(1,r[1]),e.setLayer(2,r[2]),e.setLayer(3,r[3])}this.redoOperations.forEach(e=>{e.apply()})}pushBlock(e,r,t){for(const a of this.redoBlockLayers)if(a.block===e){a.layers.length=t.length;for(let e=0;e<t.length;++e)a.layers[e]=t[e];return}this.redoBlockLayers.push(new TerrainBlockLayerData(e,t));for(const i of this.undoBlockLayers)if(i.block===e)return;this.undoBlockLayers.push(new TerrainBlockLayerData(e,r))}apply(){if(this._terrain){for(const t of this.undoBlockLayers){var e=t.block,r=t.layers;e.setLayer(0,r[0]),e.setLayer(1,r[1]),e.setLayer(2,r[2]),e.setLayer(3,r[3])}super.apply()}}}exports.TerrainWeightUndoRedo=TerrainWeightUndoRedo;