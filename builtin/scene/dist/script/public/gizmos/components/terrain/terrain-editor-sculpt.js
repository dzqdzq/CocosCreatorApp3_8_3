"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainEditorSculpt=void 0;const cc_1=require("cc"),terrain_brush_1=require("./terrain-brush"),terrain_editor_mode_1=require("./terrain-editor-mode"),terrain_editor_sculpt_tools_1=require("./terrain-editor-sculpt-tools"),terrain_operation_1=require("./terrain-operation"),clamp=cc_1.math.clamp;class TerrainEditorSculpt extends terrain_editor_mode_1.TerrainEditorMode{constructor(r){super(r),this._undo=null,this._currentTool=null;var r=new terrain_brush_1.TerrainCircleBrush,t=(r.strength=5,new terrain_brush_1.TerrainImageBrush);t.strength=5,this._brushes=[r,t],this._currentBrush=this._brushes[0]}setCurrentBrush(r){var t=this._currentBrush.position,e=this._currentBrush.radius,i=this._currentBrush.strength,o=this._currentBrush._setHeight;this._currentBrush=this._brushes[r],this._currentBrush.position=t,this._currentBrush.radius=e,this._currentBrush.strength=i,this._currentBrush._setHeight=o}getCurrentBrush(){return this._currentBrush}getBrush(r){return this._brushes[r]}setBrushImage(r){null!==(this.getBrush(terrain_brush_1.TerrainBrushType.IMAGE).image=r)?this.setCurrentBrush(terrain_brush_1.TerrainBrushType.IMAGE):this.setCurrentBrush(terrain_brush_1.TerrainBrushType.CIRCLE)}setSculptBrushRotation(r){this.getBrush(terrain_brush_1.TerrainBrushType.IMAGE)._rotation=r}onUpdate(r,t,e){var i;null!=this._currentTool&&((i=new terrain_brush_1.TerrainEdModifierKeyState).siftPressed=e,this._updateHeight(r,t,i),r.isTerrainChange=!0)}onUpdateBrushPosition(r,t){var e=this._currentBrush;e.update(r,t);for(const u of r.getBlocks()){var i=u.getIndex(),o=new cc_1.Rect,i=(o.x=i[0]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,o.y=i[1]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,o.width=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,o.height=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,new cc_1.Vec2),n=new cc_1.Vec2,s=(e.getBound(i,n),new cc_1.Rect);s.x=i.x,s.y=i.y,s.width=n.x-i.x,s.height=n.y-i.y,o.intersects(s)?u.setBrushMaterial(e.material):u.setBrushMaterial(null)}}onMouseDown(r){var t;this._undo=new terrain_operation_1.TerrainHeightUndoRedo(this.gizmo._target);let e=terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SCULPT;this.gizmo.isSmooth?e=terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SMOOTH:this.gizmo.isFlatten?e=terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.FLATTEN:this.gizmo.isSetHeight&&(e=terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SET_HEIGHT),e==terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SCULPT?this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool_Sculpt(this.gizmo.isConcave):e==terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SMOOTH?this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool_Smooth:e==terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.FLATTEN?this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool_Flatten:e==terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SET_HEIGHT?this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool_SetHeight(this._currentBrush._setHeight):this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool;var i=this._currentBrush,o=i.position.x,i=i.position.z;o/=r.info.tileSize,i/=r.info.tileSize,o=Math.floor(o),i=Math.floor(i),null!=(t=this._currentTool)&&t.start(r,o,i)}onMouseUp(){this._undo&&cce.SceneFacadeManager.beginRecording("",{customCommand:this._undo,auto:!0}),this._undo=null,this._currentTool=null}_updateHeight(e,i,o){var n=this._currentBrush;if(null!==this._currentTool){var r=new cc_1.Vec2,t=new cc_1.Vec2,s=(n.getBound(r,t),r.x),r=r.y,u=t.x,_=t.y;if(s/=e.info.tileSize,r/=e.info.tileSize,u/=e.info.tileSize,_/=e.info.tileSize,s=Math.floor(s),r=Math.floor(r),u=Math.floor(u),_=Math.floor(_),!(s>e.info.vertexCount[0]-1||u<0||r>e.info.vertexCount[1]-1||_<0)){var s=clamp(s,0,e.info.vertexCount[0]-1),r=clamp(r,0,e.info.vertexCount[1]-1),u=clamp(u,0,e.info.vertexCount[0]-1),_=clamp(_,0,e.info.vertexCount[1]-1),a=new terrain_operation_1.TerrainHeightOperation(e);this._undo&&this._undo.redoOperations.push(a),e.gizmo.isSmooth;for(let t=r;t<=_;++t)for(let r=s;r<=u;++r){var l=e.getHeightClamp(r,t),h=(null!=this._undo&&this._undo.push(r,t,l),r*e.info.tileSize),c=t*e.info.tileSize,h=n.getDelta(h,c)*i,l=this._currentTool.apply(e,r,t,l,h,o);a.push(r,t,l)}a.apply(),e.manager&&e.manager.onSculpt(e.node)}}}}exports.TerrainEditorSculpt=TerrainEditorSculpt;