"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),utils_1=__importDefault(require("../../utils")),external_1=__importDefault(require("../../utils/external")),terrain_editor_1=require("./terrain-editor"),terrain_editor_mode_1=require("./terrain-editor-mode"),terrain_brush_1=require("./terrain-brush"),event_enum_1=require("../../../event-enum"),base_1=require("../base"),terrain_1=__importDefault(require("../../controller/terrain")),EditorCamera=external_1.default.EditorCamera,rushModeHistory={};class TerrainGizmo extends base_1.SelectGizmo{constructor(){super(...arguments),this._isEditorInit=!1,this._isShiftDown=!1,this._isConcave=!1,this._isSmooth=!1,this._isFlatten=!1,this._isSetHeight=!1}get editor(){return this._editor}init(){this._editor=new terrain_editor_1.TerrainEditor(EditorCamera.camera,this),this.createController(),this._isInitialized=!0}get isConcave(){return this._isConcave}get isSmooth(){return this._isSmooth}get isFlatten(){return this._isFlatten}get isSetHeight(){return this._isSetHeight}applySmooth(e){this._isSmooth=e}get isTerrainChange(){return this.target.manager&&this.target.manager.isTerrainChange}set isTerrainChange(e){this.target.manager&&(this.target.manager.isTerrainChange=e)}onShow(){this._controller.show(),this.updateControllerData(),cce.Engine.repaintInEditMode()}onHide(){var e;this._isEditorInit=!1,this._editor.clearBrush(),this._editor.setEditTerrain(null),null!=(e=this._editor)&&e.setCurrentLayer(0),this._controller.hide(),cce.Engine.repaintInEditMode()}createController(){var e=this.getGizmoRoot();this._controller=new terrain_1.default(e),this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this),this._controller.onControllerHoverOut=this.onControllerHoverOut.bind(this)}onControllerMouseDown(e){this._editor&&(this._isShiftDown=e.shiftKey,this._editor.onMouseDown(e.x,e.y),cce.Engine.repaintInEditMode(),this.reportRushModeAndPaintModeUsedCount())}reportRushModeAndPaintModeUsedCount(){var e=Date.now();let t;t=this._isShiftDown?"A100002":this._isSmooth?"A100003":this._isFlatten?"A100004":this._isSetHeight?"A100005":"A100001";var i=null!=(i=rushModeHistory[t])?i:0;(!rushModeHistory[t]||6e4<e-i)&&(this._editor.getCurrentModeType()==terrain_editor_mode_1.eTerrainEditorMode.PAINT?this.target instanceof cc_1.Terrain&&this.target.getLayer(this.getCurrentEditLayer())&&Editor.Metrics._trackEventWithTimer({category:"terrainSystem",id:"A100006",value:1}):Editor.Metrics._trackEventWithTimer({category:"terrainSystem",id:t,value:1}),rushModeHistory[t]=e)}onControllerMouseMove(e){this._editor&&(this._editor.onMouseMove(e.x,e.y),cce.Engine.repaintInEditMode())}onControllerMouseUp(e){this._editor&&(this._editor.isChanged&&this.emitNodeChange(),e?this._editor.onMouseUp(e.x,e.y):this._editor.onMouseUp(),cce.Engine.repaintInEditMode())}onControllerHoverOut(){this._editor&&(this._editor.clearBrush(),cce.Engine.repaintInEditMode())}updateControllerData(){var e;this._isInitialized&&null!==this.target&&(this.initEditor(),(e=this.target.info)&&this._controller.updateSize(e.size.width,e.size.height),cce.Engine.repaintInEditMode())}initEditor(){this._isEditorInit||this._editor&&(this._editor.setEditTerrain(this.target),this._isEditorInit=!0,cce.Engine.repaintInEditMode())}async addLayerByUuid(e){return this.target?new Promise((i,r)=>{cc_1.assetManager.loadAny(e,(e,t)=>{e?r(e):t&&((e=new cc_1.TerrainLayer).detailMap=t,e.tileSize=1,this.isTerrainChange=!0,this.target?(t=this.target.addLayer(e),this.emitNodeChange(),i(t)):i(-1),cce.Engine.repaintInEditMode())})}):-1}async setSculptBrush(e){const n=this._editor.getMode(terrain_editor_mode_1.eTerrainEditorMode.SCULPT);if(e)return new Promise((i,r)=>{cc_1.assetManager.loadAny(e,(e,t)=>{n.getBrush(terrain_brush_1.TerrainBrushType.IMAGE).image===t&&i(!0),e?r(e):t&&(n.setBrushImage(t),this.isTerrainChange=!0,i(!0),cce.Engine.repaintInEditMode())})});n.setBrushImage(null)}async setSculptBrushRotation(e){this._editor.getMode(terrain_editor_mode_1.eTerrainEditorMode.SCULPT).setSculptBrushRotation(e)}async setPaintBrush(e){const n=this._editor.getMode(terrain_editor_mode_1.eTerrainEditorMode.PAINT);if(e)return new Promise((i,r)=>{cc_1.assetManager.loadAny(e,(e,t)=>{n.getBrush(terrain_brush_1.TerrainBrushType.IMAGE).image===t&&i(!0),e?r(e):t&&(n.setBrushImage(t),this.isTerrainChange=!0,i(!0),cce.Engine.repaintInEditMode())})});n.setBrushImage(null)}async setLayerValue(n,t,o){if(this.target){const s=this.target.getLayer(n);return s?new Promise((i,r)=>{var e;o&&("tileSize"in o&&(s.tileSize=o.tileSize),"metallic"in o&&(s.metallic=o.metallic),"roughness"in o&&(s.roughness=o.roughness),"normalMap"in o?o.normalMap?(e=o.normalMap,cc_1.assetManager.loadAny(e,(e,t)=>{e?r(e):t&&(s.normalMap=t,this.updateTerrainAsset(),this.isTerrainChange=!0,this.emitNodeChange(),cce.Engine.repaintInEditMode())})):(s.normalMap=null,this.updateTerrainAsset(),this.isTerrainChange=!0,this.emitNodeChange(),cce.Engine.repaintInEditMode()):(this.isTerrainChange=!0,this.emitNodeChange(),cce.Engine.repaintInEditMode())),t?cc_1.assetManager.loadAny(t,(e,t)=>{e?r(e):t&&(s.detailMap=t,this.updateTerrainAsset(),this.isTerrainChange=!0,this.emitNodeChange(),i(n),cce.Engine.repaintInEditMode())}):i(n)}):null}}removeLayerByIndex(e){this.target&&(this.target.removeLayer(e),this.isTerrainChange=!0,this.emitNodeChange(),cce.Engine.repaintInEditMode())}setCurrentEditLayer(e){this._editor.setCurrentLayer(e),cce.Engine.repaintInEditMode()}getLayers(){var t=[];if(this.target)for(let e=0;e<cc_1.TERRAIN_MAX_LAYER_COUNT;e++){var i=this.target.getLayer(e);t.push(i?{detailMap:i.detailMap?i.detailMap._uuid:null,metallic:i.metallic,normalMap:i.normalMap?i.normalMap._uuid:null,roughness:i.roughness,tileSize:i.tileSize}:null)}return t}getCurrentEditLayer(){return this._editor.getCurrentLayer()}setCurrentEditMode(e,t){t=Object.assign({isSculptDown:!1,isSmooth:!1,isFlatten:!1,isSetHeight:!1},t||{});this._isConcave=this._isShiftDown=t.isSculptDown,this._isSmooth=t.isSmooth,this._isFlatten=t.isFlatten,this._isSetHeight=t.isSetHeight,0!==e&&this.alignQuadShape(),this._editor.setMode(e),cce.Engine.repaintInEditMode()}queryTerrainInfo(){var e=this.target;let t=null;return t=e?{tileSize:e.info.tileSize,weightMapSize:e.info.weightMapSize,lightMapSize:e.info.lightMapSize,blockCount:e.info.blockCount}:t}changeTerrainInfo(e){var t,i=this.target;i&&(t=new cc_1.TerrainInfo,this.isTerrainChange=!0,Object.assign(t,e),i.rebuild(t),utils_1.default.onNodeChanged(i.node,e),cce.Engine.repaintInEditMode())}queryBrushOfMode(e){let t=null;return e!==terrain_editor_mode_1.eTerrainEditorMode.SCULPT&&e!==terrain_editor_mode_1.eTerrainEditorMode.PAINT||(e=this._editor.getMode(e),t={radius:e.getCurrentBrush().radius,strength:e.getCurrentBrush().strength,_setHeight:e.getCurrentBrush()._setHeight}),t}setBrushOfMode(e,t){let i=null;e!==terrain_editor_mode_1.eTerrainEditorMode.SCULPT&&e!==terrain_editor_mode_1.eTerrainEditorMode.PAINT||(e=this._editor.getMode(e),i=e.getCurrentBrush()),i&&Object.keys(t).forEach(e=>{"material"!==e&&null!==i[e]&&void 0!==i[e]&&(i[e]=t[e])})}getBlockInfo(){var e=this._editor.getMode(3),t=e.getCurrentBlockIndex()||[0,0],i=e.getCurrentWeightData()||null,e=e.getCurrentLayerList();return{index:{x:t[0],y:t[1]},weight:i&&{data:Array.from(i.data),width:i.width,height:i.height},layers:e.map(e=>e?e._uuid:"")}}alignQuadShape(){this._controller&&this.target&&(this._controller.shape.children[0].setWorldPosition(this.target.node.getWorldPosition()),cce.Engine.repaintInEditMode())}onTargetUpdate(){this.alignQuadShape(),this.updateControllerData(),cce.Engine.repaintInEditMode()}onNodeChanged(){this.alignQuadShape(),this.updateControllerData(),cce.Engine.repaintInEditMode()}emitNodeChange(){this.target&&utils_1.default.onNodeChanged(this.target.node,{type:event_enum_1.NodeEventType.COMPONENT_CHANGED})}onKeyDown(e){e.shiftKey&&(this._isShiftDown=!0)}onKeyUp(e){16===e.keyCode&&(this._isConcave?this._isShiftDown=!0:this._isShiftDown=!1)}onUpdate(e){this._editor&&(cce.Engine.repaintInEditMode(),this._editor.update(e,this._isShiftDown),cce.Engine.repaintInEditMode())}onCameraControlModeChanged(e){0!==e&&this.onControllerMouseUp(null)}updateTerrainAsset(){var e;null!=(e=this.target)&&e._asset&&this.target.exportLayerListToAsset(this.target._asset)}}exports.default=TerrainGizmo;