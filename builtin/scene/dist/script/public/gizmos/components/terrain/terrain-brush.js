"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainImageBrush=exports.TerrainCircleBrush=exports.eTerrainCircleBrushType=exports.TerrainBrushData=exports.TerrainBrush=exports.TerrainEdModifierKeyState=exports.TerrainBrushType=void 0;const cc_1=require("cc");var TerrainBrushType,eTerrainCircleBrushType;!function(e){e[e.CIRCLE=0]="CIRCLE",e[e.IMAGE=1]="IMAGE",e[e._MAX=2]="_MAX"}(TerrainBrushType=exports.TerrainBrushType||(exports.TerrainBrushType={}));class TerrainEdModifierKeyState{constructor(){this.siftPressed=!1}}exports.TerrainEdModifierKeyState=TerrainEdModifierKeyState;class TerrainBrush{constructor(){this.material=null,this.position=new cc_1.Vec3(0,0,0),this.radius=5,this.strength=1,this._setHeight=0,this._rotation=0}get rotation(){return this._rotation/180*Math.PI}getDelta(e,t){return 0}getBound(e,t){var i=this.position.x-this.radius,r=this.position.z-this.radius,a=this.position.x+this.radius,s=this.position.z+this.radius;e.x=i,e.y=r,t.x=a,t.y=s}update(e,t){this.position=t}}exports.TerrainBrush=TerrainBrush;class TerrainBrushData{constructor(){this.bmin=[0,0],this.bmax=[0,0]}width(){return this.bmax[0]-this.bmax[0]+1}height(){return this.bmax[1]-this.bmax[1]+1}}exports.TerrainBrushData=TerrainBrushData,function(e){e[e.Linear=0]="Linear",e[e.Smooth=1]="Smooth",e[e.Spherical=2]="Spherical",e[e.Tip=3]="Tip"}(eTerrainCircleBrushType=exports.eTerrainCircleBrushType||(exports.eTerrainCircleBrushType={}));class TerrainCircleBrush extends TerrainBrush{constructor(){super(),this.type=eTerrainCircleBrushType.Linear,this.falloff=.5,this._updateMaterial()}setType(e){this.type!==e&&(this.type=e,this._updateMaterial())}getType(){return this.type}_updateMaterial(){var e=cc.EffectAsset.get("internal/editor/terrain-circle-brush");null!=e&&(this.material=new cc_1.Material,this.material.initialize({effectAsset:e,defines:this._getTypeDefine()}))}_getTypeDefine(){switch(this.type){case eTerrainCircleBrushType.Linear:return{LINEAR:1};case eTerrainCircleBrushType.Smooth:return{SMOOTH:1};case eTerrainCircleBrushType.Spherical:return{SPHERICAL:1};case eTerrainCircleBrushType.Tip:return{TIP:1}}}static _calculateFalloff_Linear(e,t,i){return e<=t?1:t+i<e?0:Math.max(0,1-(e-t)/i)}static _calculateFalloff_Spherical(e,t,i){e=this._calculateFalloff_Linear(e,t,i);return e*e*(3-2*e)}static _calculateFalloff_Smooth(e,t,i){return e<=t?1:t+i<e?0:(e=(e-t)/i,Math.sqrt(1-e*e))}static _calculateFalloff_Tip(e,t,i){return e<=t?1:t+i<e?0:(t=(i+t-e)/i,1-Math.sqrt(1-t*t))}getDelta(e,t){var e=e-this.position.x,t=t-this.position.z,i=Math.sqrt(e*e+t*t),r=(1-this.falloff)*this.radius,a=this.falloff*this.radius;let s=0;switch(this.type){case eTerrainCircleBrushType.Linear:s=TerrainCircleBrush._calculateFalloff_Linear(i,r,a);break;case eTerrainCircleBrushType.Smooth:s=TerrainCircleBrush._calculateFalloff_Smooth(i,r,a);break;case eTerrainCircleBrushType.Spherical:s=TerrainCircleBrush._calculateFalloff_Spherical(i,r,a);break;case eTerrainCircleBrushType.Tip:s=TerrainCircleBrush._calculateFalloff_Tip(i,r,a)}return s*this.strength}update(i,e){if(super.update(i,e),null!=this.material){var t=(1-this.falloff)*this.radius,r=this.falloff*this.radius,a=new cc_1.Vec4,s=new cc_1.Vec4;a.x=i.node.getWorldPosition().x+e.x,a.y=i.node.getWorldPosition().y+e.y,a.z=i.node.getWorldPosition().z+e.z,s.x=t,s.y=r;for(let t=0;t<i.blockCount[0];++t)for(let e=0;e<i.blockCount[1];++e){var h=i.getBlock(t,e);h._getBrushMaterial()==this.material&&null!=h._getBrushPass()&&null!=(h=h.material)&&(h.setProperty("BrushPos",a),h.setProperty("BrushParams",s))}}}}exports.TerrainCircleBrush=TerrainCircleBrush;class TerrainImageBrush extends TerrainBrush{constructor(){super(),this._image=null,this._pixelData=null;var e=cc.EffectAsset.get("internal/editor/terrain-image-brush");null!=e&&(this.material=new cc_1.Material,this.material.initialize({effectAsset:e}))}set image(e){if(this._image!=e&&(this._image=e,(this._pixelData=null)!==this._image)){e=document.createElement("canvas");const r=e.getContext("2d");if(r){e.width=this._image.width,e.height=this._image.height;var e=this._image.mipmaps[0].data,t=e._src;if(t){const a=document.createElement("img");a.addEventListener("load",()=>{document.body.removeChild(a),r.drawImage(a,0,0,a.width,a.height);var t=r.getImageData(0,0,a.width,a.height);this._pixelData=new Array,this._pixelData.length=a.width*a.height;for(let e=0;e<this._pixelData.length;++e)this._pixelData[e]=t.data[4*e+0]/255}),a.addEventListener("error",()=>{document.body.removeChild(a)}),a.src="file://"+t,a.style.display="none",document.body.appendChild(a)}else{r.drawImage(e,0,0,this._image.width,this._image.height);var i=r.getImageData(0,0,this._image.width,this._image.height);this._pixelData=new Array,this._pixelData.length=this._image.width*this._image.height;for(let e=0;e<this._pixelData.length;++e)this._pixelData[e]=i.data[4*e+0]/255}}}}get image(){return this._image}static getColor(e,t,i,r,a){return r=(0,cc_1.clamp)(r,0,t-1),e[(a=(0,cc_1.clamp)(a,0,i-1))*t+r]}static sampleImage(e,t,i,r,a){r*=t-1,a*=i-1;var s=Math.floor(r),h=Math.floor(a),n=s+1,l=h+1,r=r-s,a=a-h,o=this.getColor(e,t,i,s,h),h=this.getColor(e,t,i,n,h),s=this.getColor(e,t,i,s,l),h=o+(h-o)*r;return h+(s+(this.getColor(e,t,i,n,l)-s)*r-h)*a}sample(e,t){return null===this._pixelData||null===this._image?1:TerrainImageBrush.sampleImage(this._pixelData,this._image.width,this._image.height,e,t)}getDelta(e,t){let i=this.position.x-e,r=this.position.z-t;0!=this.rotation&&(e=Math.sin(this.rotation),t=Math.cos(this.rotation),a=i*t+r*e,e=i*-e+r*t,i=a,r=e);var t=i/this.radius*.5+.5,a=r/this.radius*.5+.5;return t<0||1<t||a<0||1<a?0:this.sample(t,a)*this.strength}getBound(e,t){var i,r,a,s,h,n,l,o,c=-this.radius,u=-this.radius,p=this.radius,m=this.radius;0!=this.rotation&&(r=-(a=Math.sin(this.rotation)),a=a,s=i=Math.cos(this.rotation),(h=new cc_1.Vec2).x=c*i+u*r,h.y=c*a+u*s,(n=new cc_1.Vec2).x=p*i+u*r,n.y=p*a+u*s,(l=new cc_1.Vec2).x=p*i+u*r,l.y=p*a+u*s,(o=new cc_1.Vec2).x=p*i+m*r,o.y=p*a+m*s,e.x=h.x,e.y=h.y,e.x=Math.min(e.x,l.x),e.y=Math.min(e.y,l.y),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.x=Math.min(e.x,o.x),e.y=Math.min(e.y,o.y),t.x=h.x,t.y=h.y,t.x=Math.max(t.x,l.x),t.y=Math.max(t.y,l.y),t.x=Math.max(t.x,n.x),t.y=Math.max(t.y,n.y),t.x=Math.max(t.x,o.x),t.y=Math.max(t.y,o.y)),e.x=c+this.position.x,e.y=u+this.position.z,t.x=p+this.position.x,t.y=m+this.position.z}update(i,e){if(super.update(i,e),null!==this.material){var t=this.radius,r=new cc_1.Vec4,a=new cc_1.Vec4;r.x=i.node.getWorldPosition().x+e.x,r.y=i.node.getWorldPosition().y+e.y,r.z=i.node.getWorldPosition().z+e.z,a.x=t,a.y=1,a.z=this.rotation;for(let t=0;t<i.blockCount[0];++t)for(let e=0;e<i.blockCount[1];++e){var s=i.getBlock(t,e);s._getBrushMaterial()==this.material&&null!=s._getBrushPass()&&null!=(s=s.material)&&(s.setProperty("BrushPos",r),s.setProperty("BrushParams",a),null!==this._image?s.setProperty("BrushImage",this._image):s.setProperty("BrushImage",cc_1.builtinResMgr.get("grey-texture")))}}}}exports.TerrainImageBrush=TerrainImageBrush;