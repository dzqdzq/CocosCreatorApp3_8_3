"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SceneUndoCommand=exports.SceneUndoManager=void 0;const node_1=__importDefault(require("../../3d/manager/node")),base_1=require("./base"),index_1=__importDefault(require("../dump/index")),event_enum_1=require("../../public/event-enum");class SceneUndoCommand extends base_1.UndoCommand{constructor(){super(...arguments),this.tag="",this.id="",this.auto=!1,this.custom=!1,this.uuids=[],this.undoData=new Map,this.redoData=new Map}async undo(){await this.applyData(this.undoData)}async applyData(e){for(var[t,n]of e){var a=cce.Node.query(t);if(a)n&&(await index_1.default.restoreNode(a,n),cce.Node.emit("change",a,{source:event_enum_1.EventSourceType.UNDO}));else{var o=cce.Component.query(t);if(o&&n){var r=n;for(const d in r.value)await index_1.default.restoreProperty(o,d,r.value[d]);cce.Node.emit("change",o.node,{source:event_enum_1.EventSourceType.UNDO})}}}}async redo(){await this.applyData(this.redoData)}}exports.SceneUndoCommand=SceneUndoCommand;class SceneUndoManager extends base_1.UndoManagerBase{constructor(){super(...arguments),this._autoCommands=[],this._manualCommands=[],this._uuidDumpMap={},this.id=0,this.records=[]}init(){cce.Engine.on("onEditorTick",()=>{this._recordTargetAtFrameEnd()})}_createCommand(e){let t=null;return e.customCommand?(t=e.customCommand).custom=!0:t=new SceneUndoCommand,void 0!==e.tag&&(t.tag=e.tag),void 0!==e.auto&&(t.auto=e.auto),(!1!==t.auto?this._autoCommands:this._manualCommands).push(t),this.id++,t.id=t.tag+this.id,t}_isCommandExist(e){return-1!==this._commandArray.indexOf(e)}_recordTargetAtFrameEnd(){0<this._autoCommands.length&&(this._autoCommands.forEach(e=>{this.endRecording(e.id)}),this._autoCommands.length=0)}_setUndo(e,t){let n=null;var a=cce.Node.query(t);n=a?index_1.default.dumpNode(a):(a=cce.Component.query(t))?index_1.default.dumpComponent(a):null,this._uuidDumpMap[t]=n,e.undoData.set(t,n)}_setRedo(e,t){let n=null;var a=cce.Node.query(t);n=a?index_1.default.dumpNode(a):(a=cce.Component.query(t))?index_1.default.dumpComponent(a):null,this._uuidDumpMap[t]=n,e.redoData.set(t,n)}beginRecording(e,t){var n=this._createCommand(t=null!=t?t:{auto:!1});e=Array.isArray(e)?e:[e];for(const a of new Set(e).values())n.uuids.push(a),n.custom||this._setUndo(n,a);return n.id}_removeCommand(e,t){var n=e.find(e=>e.id===t);if(n){n=e.indexOf(n);if(-1!==n)return e.splice(n,1),!0}return!1}cancelRecording(e){let t=this._removeCommand(this._autoCommands,e);return t=t||this._removeCommand(this._manualCommands,e)}endRecording(t){const n=null!=(e=this._autoCommands.find(e=>e.id===t))?e:this._manualCommands.find(e=>e.id===t);if(!n)return!1;if(this._isCommandExist(n))return console.warn("command is already exist",n.tag),!1;n.custom||n.uuids.forEach(e=>{this._setRedo(n,e)}),""===n.tag&&(e=n.uuids.map(e=>{var t;return(null==(t=cce.Node.query(e))?void 0:t.name)||(null==(t=cce.Component.query(e))?void 0:t.name)}).join(" "),n.tag="modify:"+e),this.push(n);var e=this._manualCommands.indexOf(n);return-1!==e&&this._manualCommands.splice(e,1),this.records.length>n.uuids.length&&console.debug("records length > command uuids length",this.records,n.uuids),!(this.records.length=0)}reset(){super.reset(),this._autoCommands.length=0,this._manualCommands.length=0,this._uuidDumpMap={}}_getUndoData(e=this.records){const t=new Map;return e.forEach(e=>{t.set(e,this._uuidDumpMap[e])}),t}_getRedoData(e=this.records){return this.updateDump(e),this._getUndoData(e)}updateDump(e=[],n=!0){e.forEach(e=>{try{var t=node_1.default.query(e);!t||t.objFlags&cc.Object.Flags.HideInHierarchy||!n&&this._uuidDumpMap[e]||(this._uuidDumpMap[e]=node_1.default.queryDumpAtAll(e))}catch(e){console.error(e)}})}async undo(){var e=await super.undo();return e&&!e.custom&&this.updateDump(e.uuids),cce.Engine.repaintInEditMode(),e}async redo(){var e=await super.redo();return e&&!e.custom&&this.updateDump(e.uuids),cce.Engine.repaintInEditMode(),e}snapshot(){try{var e=this._getUndoData(),t=this._getRedoData();if(this.records.length=0,JSON.stringify(Array.from(e.entries()))===JSON.stringify(Array.from(t.entries())))return!1;var n=new SceneUndoCommand,a=(n.undoData=e,n.redoData=t,this.beginRecording(n.uuids,{customCommand:n}));this.endRecording(a)}catch(e){console.error(e)}}abort(){this.records.length=0}record(e){this.records.includes(e)||this.records.push(e)}}exports.SceneUndoManager=SceneUndoManager;