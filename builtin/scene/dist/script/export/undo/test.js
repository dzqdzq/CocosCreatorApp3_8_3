"use strict";var __decorate=this&&this.__decorate||function(e,n,o,t){var a,d=arguments.length,r=d<3?n:null===t?t=Object.getOwnPropertyDescriptor(n,o):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,n,o,t);else for(var c=e.length-1;0<=c;c--)(a=e[c])&&(r=(d<3?a(r):3<d?a(n,o,r):a(n,o))||r);return 3<d&&r&&Object.defineProperty(n,o,r),r};Object.defineProperty(exports,"__esModule",{value:!0}),exports.test=exports.TestComponent=void 0;const scene_1=require("./scene"),cc_1=require("cc"),component_1=require("../../3d/manager/prefab/component"),node_1=require("../../3d/manager/prefab/node"),PrefabInfo=cc_1.Prefab._utils.PrefabInfo;let SceneTest;const{ccclass,property}=cc_1._decorator;let TestComponent=class extends cc_1.Component{constructor(){super(...arguments),this.test=null}update(e){}};async function delay(n,o=20){return new Promise(e=>{setTimeout(async()=>{await n(),e(!0)},o)})}function equal(e,n,o){n===o?console.log(`test:${e} success`):console.error(`test:${e} fail,value:`,n,o)}async function createPrefabTestAsset(e){var n=cc.director.getScene();let o=new cc_1.Node(e);n.addChild(o),o.addComponent(TestComponent);n=new cc_1.Node("child"),o.addChild(n),n=await cce.SceneFacadeManager.createPrefab(o.uuid,`db://assets/${e}.prefab`);return{assetID:n,node:o=cc.find(e)}}async function testPrefab(){const a=cc.director.getScene(),{assetID:d,node:r}=await createPrefabTestAsset("prefab"),{assetID:c,node:i}=await createPrefabTestAsset("prefab2");SceneTest.beginRecording([r.uuid,a.uuid]),await cce.Node.setProperty(r.uuid,"_name",{type:"string",value:"test"});var e={type:"cc.Node",value:{uuid:i.children[0].uuid}},e=(await cce.Node.setProperty(r.uuid,"__comps__.0.test",e),await delay(async()=>{var e=null!=(e=(null==(e=r._prefab)?void 0:e.instance).propertyOverrides)?e:[],n=a._prefab.targetOverrides;console.log("propertyOverrides",e),console.log("targetOverrides",n),await SceneTest.undo();for(const o of e)o.propertyPath.join().includes("name")&&equal("propertyOverrides undo",o.value,"prefab");equal("targetOverrides undo",null==(n=a._prefab)?void 0:n.targetOverrides,void 0),await SceneTest.redo();for(const t of null==(n=null==(e=r._prefab)?void 0:e.instance)?void 0:n.propertyOverrides)t.propertyPath.join().includes("name")&&equal("propertyOverrides redo",t.value,"test");n=null==(e=a._prefab)?void 0:e.targetOverrides;equal("targetOverrides redo",n.length,1),equal("targetOverrides redo",n[0].propertyPath[0],"test"),equal("targetOverrides redo",n[0].source,r),equal("targetOverrides redo",n[0].target,i)}),{uuid:r.uuid,path:"__comps__",index:0}),n=(null==(n=r.components[0].__prefab)?void 0:n.fileId)||"";await cce.SceneFacadeManager.removeNodeArrayElement(e);class o extends scene_1.SceneUndoCommand{constructor(){super(...arguments),this.uuid="",this.fileID=""}async undo(){console.log("custom undo applyRemovedComponent"),await component_1.componentOperation.undoApplyRemovedComponent(this.data)}async redo(){console.log("custom redo applyRemovedComponent"),await component_1.componentOperation.doApplyRemovedComponent(this.uuid,this.fileID)}}var t,e=r.uuid,l=await component_1.componentOperation.doApplyRemovedComponent(e,n);l&&((t=new o).uuid=e,t.fileID=n,t.data=l,SceneTest.beginRecording(r.uuid,{customCommand:t}),await delay(async()=>{var e,n={parent:a.uuid,assetUuid:d,name:"prefabAfterApplyRemoveComponent.prefab",type:"cc.Prefab"},o=await cce.SceneFacadeManager.createNode(n),t=cce.Node.query(o);equal("applyRemoveComponent before undo",!t,!1),equal("applyRemoveComponent before undo",null==(e=null==t?void 0:t.components)?void 0:e.length,0),await SceneTest.undo(),n.name="prefabAfterUndo.prefab",o=await cce.SceneFacadeManager.createNode(n),equal("applyRemoveComponent after undo1",!(t=cce.Node.query(o)),!1),equal("applyRemoveComponent after undo2",null==(e=null==t?void 0:t.components)?void 0:e.length,1),equal("applyRemoveComponent after undo3",null==t?void 0:t.components[0].name,"prefabAfterUndo<TestComponent>"),await SceneTest.redo(),n.name="prefabAfterRedo.prefab",o=await cce.SceneFacadeManager.createNode(n),equal("applyRemoveComponent after redo1",!(t=cce.Node.query(o)),!1),equal("applyRemoveComponent after redo2",null==(e=null==t?void 0:t.components)?void 0:e.length,0)}));class u extends scene_1.SceneUndoCommand{constructor(){super(...arguments),this.uuid=""}async undo(){console.log("custom undo applyPrefab"),await node_1.nodeOperation.undoApplyPrefab(this.applyInfo)}async redo(){console.log("custom redo applyPrefab"),await node_1.nodeOperation.doApplyPrefab(this.uuid)}}await cce.Node.setProperty(i.children[0].uuid,"_name",{type:"string",value:"test2"}),await cce.Node.setProperty(i.uuid,"__comps__.0.test",{type:"cc.Node",value:{uuid:r.children[0].uuid}}),equal("applyPrefab修改属性",i.children[0].name,"test2"),equal("applyPrefab修改属性",!i.components[0].test,!1);e=await node_1.nodeOperation.doApplyPrefab(i.uuid);equal("applyPrefab",!e,!1),e&&((n=new u).applyInfo=e,n.uuid=i.uuid,SceneTest.beginRecording(i.uuid,{customCommand:n}),await delay(async()=>{var e={parent:a.uuid,assetUuid:c,type:"cc.Prefab"},n=await cce.SceneFacadeManager.createNode(e),n=cce.Node.query(n),o=null==n?void 0:n.children[0],t=null==n?void 0:n.components[0],n=(equal("applyPrefab before undo",!n,!1),equal("applyPrefab before undo",null==o?void 0:o.name,"test2"),equal("applyPrefab before undo",null==(o=null==n?void 0:n.components)?void 0:o.length,1),equal("applyPrefab before undo",null==(o=null==n?void 0:n.children)?void 0:o.length,1),equal("applyPrefab before undo",null==t?void 0:t.name,"prefab2<TestComponent>"),equal("applyPrefab before undo",null==t?void 0:t.test,null),await SceneTest.undo(),await cce.SceneFacadeManager.createNode(e)),o=cce.Node.query(n),t=null==o?void 0:o.children[0],n=(equal("applyPrefab after undo",!o,!1),equal("applyPrefab after undo",null==t?void 0:t.name,"child"),equal("applyPrefab after undo",null==(n=null==o?void 0:o.components)?void 0:n.length,1),equal("applyPrefab after undo",null==(t=null==o?void 0:o.children)?void 0:t.length,1),await SceneTest.redo(),await cce.SceneFacadeManager.createNode(e)),o=cce.Node.query(n),t=null==o?void 0:o.children[0];null!=o&&o.components[0];equal("applyPrefab after redo",!o,!1),equal("applyPrefab after redo",null==t?void 0:t.name,"test2"),equal("applyPrefab after redo",null==(e=null==o?void 0:o.components)?void 0:e.length,1),equal("applyPrefab after redo",null==(n=null==o?void 0:o.children)?void 0:n.length,1)},200))}async function testNode(){const e=new cc_1.Node("node"),n=new cc_1.Node("node2"),o=new cc_1.Node("parent"),t=(cc.director.getScene().addChild(o),SceneTest.beginRecording(o.uuid),o.addChild(e),await delay(async()=>{await SceneTest.undo(),equal("undo add node",e.parent,null),await SceneTest.redo(),equal("redo add node",e.parent,o)}),SceneTest.beginRecording(e.uuid,{tag:"修改单个"}),e.name="xx",e.setPosition(new cc.Vec3(3,3,3)),await delay(async()=>{await SceneTest.undo(),equal("undo set property",e.name,"node"),equal("undo set property",e.position.x,0),equal("undo set property",e.position.y,0),equal("undo set property",e.position.z,0),await SceneTest.redo(),equal("redo set property",e.name,"xx"),equal("redo set property",e.position.x,3),equal("redo set property",e.position.y,3),equal("redo set property",e.position.z,3)}),SceneTest.beginRecording(o.uuid),o.removeChild(e),await delay(async()=>{await SceneTest.undo(),equal("undo remove node",e.parent,o),await SceneTest.redo(),equal("redo remove node",e.parent,null)}),SceneTest.beginRecording(e.uuid),e.addComponent("cc.EditBox"));await delay(async()=>{await SceneTest.undo(),equal("undo add EditBox",e.components.length,0),await SceneTest.redo(),equal("redo add EditBox",e.components.length,2)}),SceneTest.beginRecording(t.uuid),t.string="test",await delay(async()=>{equal("modify EditBox before undo",t.string,"test"),await SceneTest.undo(),equal("modify EditBox after undo",t.string,""),await SceneTest.redo(),equal("modify EditBox after redo",t.string,"test")}),o.addChild(e),o.addChild(n),SceneTest.beginRecording([o.uuid,e.uuid]),n.setParent(e),await delay(async()=>{await SceneTest.undo(),equal("change parent undo",n.parent,o),await SceneTest.redo(),equal("change parent redo",n.parent,e)}),o.addChild(n),SceneTest.beginRecording(o.uuid),n.setSiblingIndex(0),await delay(async()=>{await SceneTest.undo(),equal("setSiblingIndex undo",o.children[0],e),equal("setSiblingIndex undo",o.children[1],n),await SceneTest.redo(),equal("setSiblingIndex redo",o.children[0],n),equal("setSiblingIndex redo",o.children[1],e)})}async function example(){SceneTest=new scene_1.SceneUndoManager,(window.SceneTest=SceneTest).init(),await testNode(),await testPrefab()}function test(){try{example()}catch(e){console.log("undo test error: "+e)}}__decorate([property({type:cc_1.Node})],TestComponent.prototype,"test",void 0),TestComponent=__decorate([ccclass("TestComponent")],TestComponent),exports.TestComponent=TestComponent,exports.test=test;