"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.decodeTargetOverrides=exports.updatePropertyFromNull=exports.resetProperty=exports.decodePatch=exports.decodeNode=exports.decodeScene=exports.decodeMountedRoot=void 0;const utils_1=require("./utils"),lodash_1=__importDefault(require("lodash")),{get,set}=lodash_1.default,dump_defines_1=require("./dump-defines"),cc_1=require("cc"),util_1=require("util"),TargetOverrideInfo=cc_1.Prefab._utils.TargetOverrideInfo,TargetInfo=cc_1.Prefab._utils.TargetInfo,PrefabInfo=cc_1.Prefab._utils.PrefabInfo;function decodeChildren(e,a){const t=e.map(e=>e.value.uuid),o=a.children.map(e=>e.uuid);o.forEach(e=>{t.includes(e)||!(e=cce.Node.query(e))||e.objFlags&cc.Object.Flags.HideInHierarchy||(e.parent=null)}),t.forEach((e,t)=>{var r=cce.Node.query(e);r&&(r.walk(e=>{e._objFlags&=cc.Object.Flags.PersistentMask,e._objFlags&=~cc.Object.Flags.Destroyed}),o.includes(e)||(r.parent=a),r.setSiblingIndex(t))})}function decodeMountedRoot(e,t){e&&((t=cce.Node.query(t))?(e[cc_1.editorExtrasTag]||(e[cc_1.editorExtrasTag]={}),e[cc_1.editorExtrasTag].mountedRoot=t):e[cc_1.editorExtrasTag]&&(e[cc_1.editorExtrasTag].mountedRoot=void 0))}async function decodeComponents(a,o,c){if(a){const i={},u=a.map(e=>e.value.uuid?(e.value.__prefab&&e.value.__prefab.value&&e.value.__prefab.value.fileId.value&&(i[e.value.__prefab.value.fileId.value]=e),e.value.uuid.value):"").filter(Boolean);var r=o.components.map(e=>{if(c){var t=(0,utils_1.getTypeName)(e.constructor);if(c.includes(t))return""}var r;return e.__prefab&&e.__prefab.fileId&&(t=i[e.__prefab.fileId])&&-1!==(r=u.indexOf(t.value.uuid.value))&&(u.splice(r,1,e.uuid),t.value.uuid.value=e.uuid),e.uuid}).filter(Boolean);let e=r.length**2,t=r.length-1;do{var s=r[t];s&&!u.includes(s)&&cce.Node.removeComponent(s)?r.splice(t,1):t--,e--}while(0!==r.length&&e);cc.Object._deferredDestroy();var l=o.components.slice();for(let r=o._components.length=0;r<a.length;r++){var n=a[r];if(n.value&&n.value.uuid){let e=l[r];var d=n.value.uuid.value;let t=cce.Component.query(d);(t=t||cce.Component.queryRecycle(d))&&(e!==t&&(t.node!==o&&!function t(e){if(e.objFlags&cc.Object.Flags.Destroying||e.objFlags&cc.Object.Flags.Destroyed)return;const r=e.node._getDependComponent(e);r.forEach(e=>{t(e)});cce.Node.removeComponent(e.uuid);cc.Object._deferredDestroy()}(t),(t.objFlags&cc.Object.Flags.Destroying||t.objFlags&cc.Object.Flags.Destroyed)&&(t.objFlags&=cc.Object.Flags.PersistentMask,t.objFlags&=~cc.Object.Flags.Destroyed),e=t),cce.Node.addComponentAt(o,e,r));const p=[];if(isPreviewProcess&&"cc.Animation"===n.type){const f=e;f.clips.map(e=>{return f.getState(null!=(e=null==e?void 0:e.name)?e:"")}).filter(e=>null==e?void 0:e.isPlaying).forEach(e=>{p.push(e.name)})}for(const y in n.value)await decodePatch(y,n.value[y],e);if(0<p.length){const _=e;p.forEach(e=>{_.play(e)})}decodeMountedRoot(e,n.mountedRoot),e&&e.onRestore&&e.onRestore()}}}}async function decodePrefab(t,e){if(t||e._prefab)if(!t&&e._prefab)e._prefab=null;else{var r=new PrefabInfo,a=cce.Node.query(t.rootUuid);if(r.root=a||e,t.uuid)try{r.asset=await(0,util_1.promisify)(cc_1.assetManager.loadAny)(t.uuid)}catch(e){console.error(e),r.asset=new cc_1.Prefab,r.asset.initDefault(t.uuid)}r.fileId=t.fileId||e.uuid,t.instance?await decodePatch("instance",t.instance,r):r.instance=void 0,t.targetOverrides?r.targetOverrides=decodeTargetOverrides(t.targetOverrides):r.targetOverrides=void 0,e._prefab=r}}async function decodeScene(e,t){if(e){(t=t||new cc.Scene).name=e.name.value,t.active=e.active.value,e.children&&decodeChildren(e.children,t);for(const r of Object.keys(e._globals))await decodePatch("_globals."+r,e._globals[r],t);e.targetOverrides?(t._prefab||(t._prefab=new cc._PrefabInfo),t._prefab.targetOverrides=decodeTargetOverrides(e.targetOverrides)):t._prefab=void 0}}async function decodeNode(e,t,r){if(!e)return null;if(!(t=t||new cc.Node))return null;await decodePrefab(e.__prefab__,t),t.name=e.name.value,t.active=e.active.value,t.layer=e.layer.value,t.mobility=e.mobility.value,t.setPosition(e.position.value);var a=new cc_1.Quat,o=e.rotation.value;return cc_1.Quat.fromEuler(a,o.x,o.y,o.z),t.setRotation(a),t.setScale(e.scale.value),decodeMountedRoot(t,e.mountedRoot),e.parent&&e.parent.value&&e.parent.value.uuid?t.parent=cce.Node.query(e.parent.value.uuid):t.parent=null,e.children&&decodeChildren(e.children,t),await decodeComponents(e.__comps__,t,r),t}async function _decodeByType(e,t,r,a,o){e=dump_defines_1.DumpDefines[e];return!!e&&(await e.decode(t,r,a,o),!0)}async function decodePatch(t,r,a){var o=(0,utils_1.parsingPath)(t,a),c=(0,utils_1.parsingPath)(o.search,a),s=[cc_1.editorExtrasTag,"__scriptAsset","node","uuid"];const l=o.search?get(a,o.search):a;if(l&&!(l instanceof cc_1.Component&&s.includes(o.key))){if("[object Object]"===Object.prototype.toString.call(l)){let e=Object.getOwnPropertyDescriptor(l,o.key);if(void 0===(e=window.isSceneNative&&void 0===e?Object.getOwnPropertyDescriptor(l.__proto__,o.key):e)){if(!(e=cc.Class.attr(l,o.key))||!e.hasSetter)return void(o.key in l&&(!e||!0!==e.hasGetter)&&(l[o.key]=r.value))}else if(!e.writable&&!e.set)return}const h=c.search?get(a,c.search):a;if(!("value"in r)||"Unknown"===r.type){let e=cc.Class.attr(l,o.key);Array.isArray(h)&&"_components"!==c.search&&(n=(s=(0,utils_1.parsingPath)(c.search,a)).search?get(a,s.search):a,e=cc.Class.attr(n,s.key),e=cc.Class.attr(e.ctor,o.key));var n=getDefaultAttrData(e);return l[o.key]=n}var d=cc.js.getClassByName(r.type),s=d?(0,utils_1.getTypeInheritanceChain)(d):[],n="cc.Node",e="cc.Component",i="cc.Asset",u="cc.ValueType";if(r.isArray)if(Array.isArray(r.value)){var p=[],f=cc.Class.attr(l.constructor,o.key);for(let e=0;e<r.value.length;e++)p[e]=(0,utils_1.ccClassAttrPropertyDefaultValue)(f),await decodePatch(""+e,r.value[e],p);l[o.key]=p}else l[o.key]=[];else{var y={};if(y.ccType=d,!await _decodeByType(r.type,l,o,r,y))if("cc.Scene"===r.type)_decodeByType(n,l,o,r,y);else if(ArrayBuffer.isView(r.value))_decodeByType("TypedArray",l,o,r,y);else if(s.includes(n)||n===r.type)_decodeByType(n,l,o,r,y);else if(s.includes(i)||i===r.type)await _decodeByType(i,l,o,r,y);else if(s.includes(e)||e===r.type)_decodeByType(e,l,o,r,y);else if(s.includes(u))_decodeByType(u,l,o,r,y);else if("length"===o.key&&"Array"===r.type){for(;l.length>r.value;)l.pop();const h=get(a,c.search);var _=cc.Class.attr(h,c.key);for(let e=l.length;e<r.value;e++)l[e]=(0,utils_1.ccClassAttrPropertyDefaultValue)(_);set(a,o.search,l)}else if(d&&!l[o.key]&&null!==r.value){l[o.key]=new d;for(let e=0;e<d.__props__.length;e++){var v=d.__props__[e],g=r.value[v];g&&await decodePatch(t+"."+v,g,a)}}else if(null===r.value)l[o.key]=r.value;else if("object"==typeof r.value)for(const b in r.value)void 0!==r.value[b]&&await decodePatch(b,r.value[b],l[o.key]);else l[o.key]=r.value}if(setNodeSpecialProperty(a,o),o.search&&set(a,o.search,l),c&&c.search){const l=get(a,c.search);l instanceof Object&&null!=(n=cc.Class.attr(l,o.key))&&n.hasSetter&&(l[c.key]=l[c.key])}}}exports.decodeMountedRoot=decodeMountedRoot,exports.decodeScene=decodeScene,exports.decodeNode=decodeNode,exports.decodePatch=decodePatch;const nodeSpecialPropertyDefaultValue={_lpos(){return new cc_1.Vec3(0,0,0)},eulerAngles(){return new cc_1.Vec3(0,0,0)},_lscale(){return new cc_1.Vec3(1,1,1)},mobility(){return cc_1.MobilityMode.Static}};function setNodeSpecialProperty(e,t){if(e instanceof cc.Node)switch(t.key){case"_lpos":e.setPosition(e._lpos);break;case"eulerAngles":e.setRotationFromEuler(e.eulerAngles.x,e.eulerAngles.y,e.eulerAngles.z);break;case"_lscale":e.setScale(e._lscale)}}function getDefaultAttrData(e){let t=(0,utils_1.getDefault)(e);return"object"==typeof t&&t&&("function"==typeof t.clone?t=t.clone():Array.isArray(t)&&(t=[])),t}function resetProperty(e,t){var r,t=(0,utils_1.parsingPath)(t,e),e=t.search?get(e,t.search):e;e&&(t.key in nodeSpecialPropertyDefaultValue?(e[t.key]=nodeSpecialPropertyDefaultValue[t.key](),setNodeSpecialProperty(e,t)):(r=cc.Class.attr(e.constructor,t.key),e[t.key]=getDefaultAttrData(r)))}function updatePropertyFromNull(e,t){var r,t=(0,utils_1.parsingPath)(t,e),e=t.search?get(e,t.search):e;e&&(r=cc.Class.attr(e.constructor,t.key),e[t.key]=getDefaultAttrData(r),null!==e[t.key]&&void 0!==e[t.key]||!r.ctor||(e[t.key]=new r.ctor))}function decodeTargetOverrides(e){const a=[];return e.forEach(e=>{var t,r=new TargetOverrideInfo;r.source=cce.Node.query(e.source),e.sourceInfo&&((t=new TargetInfo).localID=e.sourceInfo,r.sourceInfo=t),r.propertyPath=e.propertyPath,r.target=cce.Node.query(e.target),e.targetInfo&&((t=new TargetInfo).localID=e.targetInfo,r.targetInfo=t),a.push(r)}),a}exports.resetProperty=resetProperty,exports.updatePropertyFromNull=updatePropertyFromNull,exports.decodeTargetOverrides=decodeTargetOverrides,exports.default={decodeScene:decodeScene,decodeNode:decodeNode,decodePatch:decodePatch,resetProperty:resetProperty,updatePropertyFromNull:updatePropertyFromNull,decodeMountedRoot:decodeMountedRoot,decodeTargetOverrides:decodeTargetOverrides};