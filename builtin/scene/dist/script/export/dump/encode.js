"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.encodeObject=exports.encodeComponent=exports.encodeScene=exports.encodeNode=void 0;const utils_1=__importDefault(require("./utils")),dump_defines_1=require("./dump-defines"),cc_1=require("cc"),utils_2=require("../../3d/manager/prefab/utils"),attributeProps=["enumList","radioGroup","bitmaskList","displayName","group","multiline","min","max","step","slide","tooltip","animatable","unit","radian","displayOrder"],autoI18nAttributeNames=["displayName","tooltip"];function encodeNode(t){var e=t.constructor,o=Object.keys(cc.Layers.Enum).map((e,t)=>({name:e,value:cc.Layers.Enum[e]})),a=(o.sort((e,t)=>e.value-t.value),Object.keys(cc_1.MobilityMode).map((e,t)=>({name:e,value:cc_1.MobilityMode[e]}))),n="2d"===cce.SceneFacadeManager._projectType,a={active:encodeObject(t.active,{displayName:"Active",default:null},t),locked:encodeObject(Boolean(t.objFlags&cc.Object.Flags.LockedInEditor),{displayName:"Locked",default:!1,animatable:!1},t),name:encodeObject(t.name,{displayName:"Name",default:null,animatable:!1},t),position:encodeObject(t.position,{displayName:"Position",default:new cc.math.Vec3,tooltip:"i18n:scene.tooltips.positionTip"},t),rotation:encodeObject(t.eulerAngles,{displayName:"Rotation",default:new cc.math.Vec3,tooltip:"i18n:scene.tooltips."+(n?"rotationTip2D":"rotationTip3D")},t),scale:encodeObject(t.scale,{displayName:"Scale",default:new cc.math.Vec3(1,1,1),tooltip:"i18n:scene.tooltips.scaleTip"},t),mobility:encodeObject(t.mobility,{displayName:"Mobility",default:0,type:"Enum",enumList:a},t),layer:encodeObject(t.layer,{displayName:"Layer",default:1073741824,type:"Enum",enumList:o,readonly:!1,animatable:!1},t),uuid:encodeObject(t.uuid,{displayName:"UUID",default:null,animatable:!1},t),parent:encodeObject(t.parent,{ctor:cc.Node},t),children:t.children.map(e=>{if(e&&!(e.objFlags&cc.Object.Flags.HideInHierarchy))return encodeObject(e,{ctor:cc.Node},t)}).filter(Boolean),__type__:utils_1.default.getTypeName(e),__comps__:t._components.map(e=>encodeComponent(e)),mountedRoot:null==(n=utils_2.prefabUtils.getMountedRoot(t))?void 0:n.uuid};return t._prefab&&(o=utils_2.prefabUtils.getPrefabStateInfo(t),a.__prefab__={uuid:t._prefab.asset&&t._prefab.asset._uuid||"",fileId:t._prefab.fileId,rootUuid:t._prefab.root&&t._prefab.root.uuid,sync:!0,prefabStateInfo:o},t._prefab.targetOverrides&&(a.__prefab__.targetOverrides=encodeTargetOverrides(t._prefab.targetOverrides)),t._prefab.instance&&(a.__prefab__.instance=encodeObject(t._prefab.instance,{default:null},t)),0<(e=utils_2.prefabUtils.getRemovedComponents(t)).length)&&(a.removedComponents=e.map(e=>({name:cc_1.js.getClassName(e),fileID:e.__prefab.fileId}))),_checkObjFlags(t,a),a}function encodeScene(o){var e=o.constructor;const a={active:encodeObject(o.active,{default:null}),locked:encodeObject(!1,{default:!1}),name:encodeObject(o.name||e.name,{default:null}),uuid:encodeObject(o.uuid,{default:null}),autoReleaseAssets:encodeObject(o.autoReleaseAssets,{displayName:"Auto Release Assets",default:!1}),children:o.children.map(e=>{if(e&&!(e.objFlags&cc.Object.Flags.HideInHierarchy))return encodeObject(e,{ctor:cc.Node})}).filter(Boolean),parent:"",__type__:utils_1.default.getTypeName(e),_globals:{},isScene:!0};return o._globals&&o._globals.constructor.__props__.map(e=>{var t=cc.Class.attr(o._globals.constructor,e);a._globals[e]=encodeObject(o._globals[e],t,o._globals)}),null!=(e=o._prefab)&&e.targetOverrides&&(a.targetOverrides=encodeTargetOverrides(o._prefab.targetOverrides)),a}function encodeComponent(a){var e,t=a.constructor,o=utils_2.prefabUtils.getMountedRoot(a);let n=null==o?void 0:o.uuid;o&&(o=o._prefab)&&o.root&&(o=null==(o=null==(o=o.root._prefab)?void 0:o.instance)?void 0:o.prefabRootNode)&&o!==cce.Scene.rootNode&&(n=void 0);const c={value:{uuid:encodeObject(a.uuid,{default:null,visible:!1},a),name:encodeObject(a.name,{default:null,visible:!1},a),enabled:encodeObject(a.enabled,{default:null,visible:!1},a)},default:void 0,type:utils_1.default.getTypeName(t),readonly:!1,visible:!0,cid:a.__cid__,mountedRoot:n};return t.__props__.forEach(t=>{if(c.value)try{var e,o;t in a&&(e=cc.Class.attr(a,t),"Unknown"!==(o=encodeObject(a[t],e,a,t)).type&&(c.value[t]=o),_checkConstructorRewriteType(o,a[t],e))}catch(e){console.warn(`Component property dump failed:
  Node: ${a.node.name}(${a.node.uuid})
 Component: ${c.type}(${a.uuid})
 Property: `+t),console.warn(e),delete c.value[t]}}),c.editor={inspector:t._inspector||"",icon:t._icon||"",help:t._help||"",_showTick:"function"==typeof a.start||"function"==typeof a.update||"function"==typeof a.lateUpdate||"function"==typeof a.onEnable||"function"==typeof a.onDisable},c.value&&(o=c.value.__scriptAsset,a instanceof cc._MissingScript?(e=(e=(e=a._$erialized)&&e.__type__)&&EditorExtends.UuidUtils.decompressUuid(a._$erialized.__type__),o.visible=!(!e||!EditorExtends.UuidUtils.isUuid(e)),o.value={uuid:e}):(o.visible=!!a.__scriptUuid,o.value={uuid:a.__scriptUuid}),o.displayOrder=-999),t&&(c.extends=utils_1.default.getTypeInheritanceChain(t)),c}function _checkConstructorRewriteType(e,t,o){t&&"object"==typeof t&&!Array.isArray(t)&&t.constructor&&o&&o.ctor&&!(t instanceof o.ctor)&&(e.type="Unknown")}function _checkAttributes(t,o,e){if(void 0!==o.visible&&("function"==typeof o.visible?e?t.visible=!!o.visible.call(e):console.warn("try to use visible function without owner"):t.visible=!!o.visible),!o.ctor&&o.type&&(t.type=""+o.type),"enumList"in o&&"Enum"===o.type&&(t.type="Enum"),o&&o.hasGetter&&!o.hasSetter&&(t.readonly=!0),attributeProps.forEach(e=>{o.hasOwnProperty(e)&&(t[e]=o[e])}),"string"==typeof t.name&&e&&"object"==typeof e){var a=cc_1.js.getClassName(e);if(a.startsWith("cc."))for(const n of autoI18nAttributeNames)Object.prototype.hasOwnProperty.call(o,n)||(t[n]=`i18n:ENGINE.classes.${a}.properties.${t.name}.`+n)}}function _encodeByType(e,t,o,a){e=e||"";e=dump_defines_1.DumpDefines[e];return!!e&&(e.encode(t,o,a),!0)}function _checkObjFlags(e,t){let o=!1,a=!1,n=!1,c=!1,r=!1;e._components.forEach(e=>{e.objFlags&cc.Object.Flags.IsPositionLocked&&(o=!0),e.objFlags&cc.Object.Flags.IsSizeLocked&&(a=!0),e.objFlags&cc.Object.Flags.IsAnchorLocked&&(n=!0),e.objFlags&cc.Object.Flags.IsScaleLocked&&(c=!0),e.objFlags&cc.Object.Flags.IsRotationLocked&&(r=!0)}),o&&(t.position.readonly=!0),c&&(t.scale.readonly=!0),r&&(t.rotation.readonly=!0);const l=[];t.__comps__.forEach(e=>{"cc.UITransform"===e.cid&&l.push(e)}),l.length&&(a&&l.forEach(e=>{e.value.contentSize.readonly=!0}),n)&&l.forEach(e=>{e.value.anchorPoint.readonly=!0})}function encodeObject(a,n,t=null,e,o){var c=utils_1.default.getConstructor(a,n);let r=utils_1.default.getDefault(n);if(r&&"object"==typeof r&&r.constructor&&Array.isArray(r.constructor.__props__)){const f={type:utils_1.default.getTypeName(r.constructor),value:{}};r.constructor.__props__.forEach(e=>{var t=cc.Class.attr(r.constructor,e),t=encodeObject(r[e],t,r,e);"Unknown"!==t.type&&(f.value[e]=t)}),r=f}let l=utils_1.default.getTypeName(c);null===t&&null!==n.default&&void 0!==n.default&&(u=utils_1.default.getConstructor(n.default,n),utils_1.default.getTypeName(u)!==l)&&(l="Unknown");var i={name:e,value:null,default:r,type:l,readonly:!!n.readonly,visible:!0,animatable:void 0===n.animatable||!!n.animatable};if(n.userData&&(i.userData=n.userData),_checkAttributes(i,n,t),r&&Array.isArray(r)&&(i.isArray=!0),!i.isArray&&Array.isArray(a)&&(i.isArray=!0),i.isArray)if(Array.isArray(a)&&"Array"!==i.type){var s=Object.assign({},n),u=(s.visible=!0,s.readonly&&void 0!==s.readonly.deep&&(s.readonly=s.readonly.deep),utils_1.default.ccClassAttrPropertyDefaultValue(n)),d=(s.default=getElementDefaultValue(n,u),o||(i.elementTypeData=encodeObject(s.default,s,u,void 0,!0)),[]);for(let e=0;e<a.length;e++){var p=a[e],p=(p&&p.constructor&&(s.ctor=p&&p.constructor),encodeObject(p,s,t));"Unknown"!==p.type?d.push(p):d.push(i.elementTypeData)}i.value=d}else i.type="Unknown";else{e={};if(e.ctor=c,!_encodeByType(i.type,a,i,e))if(ArrayBuffer.isView(a))_encodeByType("TypedArray",a,i,e);else if(cc.js.isChildClassOf(c,cc.ValueType))_encodeByType("cc.ValueType",a,i,e);else if(cc.js.isChildClassOf(c,cc.Node))_encodeByType("cc.Node",a,i,e);else if(cc.js.isChildClassOf(c,cc.Component))_encodeByType("cc.Component",a,i,e);else if(cc.js.isChildClassOf(c,cc.Asset))_encodeByType("cc.Asset",a,i,e);else if(c&&c.__props__)if(a){const _={};c.__props__.forEach(e=>{var t=cc.Class.attr(a,e),o=(n.readonly&&n.readonly.deep&&(t.readonly={deep:!0}),encodeObject(a[e],t,a,e));"Unknown"!==o.type&&(_[e]=o),_checkConstructorRewriteType(o,a[e],t)}),i.value=_}else i.value=null;else"Unknown"!==i.type&&(i.value=a)}return c&&(i.extends=utils_1.default.getTypeInheritanceChain(c)),i}function getElementDefaultValue(e,t){return e.type?utils_1.default.ccClassAttrPropertyDefaultValue(e):getElementDefaultValueFromParentInitializer(t)}function getElementDefaultValueFromParentInitializer(e){if(e&&Array.isArray(e)&&0!==e.length)switch(typeof e[0]){case"number":return 0;case"string":return"";case"boolean":return!1}return null}function encodeTargetOverrides(e){if(!e||e.length<=0)return null;const t=[];return e.forEach(e=>{e.source&&e.target&&(e={source:e.source.uuid,sourceInfo:e.sourceInfo?e.sourceInfo.localID:void 0,propertyPath:e.propertyPath,target:e.target.uuid,targetInfo:e.targetInfo?e.targetInfo.localID:void 0},t.push(e))}),t}exports.encodeNode=encodeNode,exports.encodeScene=encodeScene,exports.encodeComponent=encodeComponent,exports.encodeObject=encodeObject,exports.default={encodeNode:encodeNode,encodeScene:encodeScene,encodeComponent:encodeComponent,encodeObject:encodeObject};