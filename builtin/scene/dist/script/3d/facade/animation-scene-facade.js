"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const general_scene_facade_1=__importDefault(require("./general-scene-facade")),animation_scene_proxy_1=__importDefault(require("../manager/scene/proxy/animation-scene-proxy")),scene_facade_state_interface_1=require("./scene-facade-state-interface"),animation_1=require("../../export/undo/animation"),node_1=__importDefault(require("../../utils/node")),cc_1=require("cc"),message_1=require("../manager/message");class AnimationSceneFacade extends general_scene_facade_1.default{constructor(){super(...arguments),this._undoMgr=new animation_1.AnimationUndoManager}init(){this.modeName=scene_facade_state_interface_1.SceneModeType.Animation,this._sceneProxy=new animation_scene_proxy_1.default(this._sceneMgr,this),this._animationMgr.on("scene:animation-clip-change",(e,n)=>{this._undoMgr.reset(e,n)}),this.initEventListener()}initEventListener(){super.initEventListener(),this._sceneEventListener.push(this._animationMgr)}async enter(e){console.debug("enter animation scene facade"),e.uuid&&await this.openScene(e.uuid,e.clipUuid),Editor.EditMode.enter(this.modeName.toLocaleLowerCase()),this._sceneProxy.sendModeChangeMsg(this.modeName),this._animationMgr.enter(e.uuid,e.clipUuid)}async exit(){console.debug("exit animation scene facade"),await this.closeSceneState()}async openScene(e,n){var t=this._sceneProxy.open(e);return this._animationMgr.record(e,!0,n),t}async closeScene(){return!0}queryCurrentAnimationState(){return this._animationMgr.queryPlayState()}queryCurrentAnimationInfo(){return this._animationMgr.getEditAnimationInfo()}queryAnimationRootNode(e){return this._animationMgr.queryAnimationRoot(e)}queryAnimationRootInfo(e){return this._animationMgr.queryAnimationRootInfo(e)}queryAnimationClipDump(e,n){return this._animationMgr.queryAnimationClipDump(e,n)}queryAnimationProperties(e){return this._animationMgr.queryProperties(e)}queryAnimationClipsInfo(e){return this._animationMgr.queryAnimClipsInfo(e)}queryAnimationClipCurrentTime(e){return this._animationMgr.queryPlayingClipTime(e)}queryAnimationPropValueAtFrame(e,n,t,i){return this._animationMgr.getPropValueAtFrame(e,n,t,i)}queryAuxCurveValueAtFrame(e,n,t){return this._animationMgr.getAuxCurveValueAtFrame(e,n,t)}async recordAnimation(e,n,t){return this._animationMgr.record(e,n,t)}async changeAnimationRootNode(e,n){return this._animationMgr.changeAnimNode(e,n)}async setCurEditTime(e){return this._animationMgr.setCurEditTime(e)}async changeClipState(e,n){return this._animationMgr[e](n)}async setEditClip(e){return this._animationMgr.setEditClip(e)}async saveClip(){return this._animationMgr.save()}async applyAnimationOperation(e,n){return this._animationMgr.operation(e,n)}queryAnimationNodeEditInfo(e){return this._animationMgr.queryAnimationNodeEditInfo(e)}async createNode(e){}async removeNode(e){}async patchSceneState(){var e=await this._sceneProxy.patch();return this._animationMgr.setComponentDirty(!1),e}async setNodeProperty(e){if("name"===e.path)return!1;var n=this._nodeMgr.query(e.uuid),{compName:n,propName:t}=node_1.default.getNameDataByPropPath(n,e.path);if(n===cc_1.js.getClassName(cc_1.Animation)||n===cc_1.js.getClassName(cc_1.SkeletalAnimation))if("clips"===t){n=e.path.match(/clips.(.*)/);if(!n||!n[1]||isNaN(Number(n[1])))return Array.isArray(e.dump.value)&&e.dump.value.find(e=>e.value&&e.value.uuid===this._animationMgr.curEditClipUuid)?this._nodeMgr.setProperty(e.uuid,e.path,e.dump):(console.warn(Editor.I18n.t("scene.animation.delete_edit_clip_limit")),message_1.messageManager.broadcast("scene:change-node",e.uuid),!1);n=n[1],n=this._animationMgr.queryRecordAniClips()[Number(n)];if(n&&n._uuid===this._animationMgr.curEditClipUuid)return console.warn(Editor.I18n.t("scene.animation.delete_edit_clip_limit")),message_1.messageManager.broadcast("scene:change-node",e.uuid),!1}else if("defaultClip"===t)return n=this._nodeMgr.setProperty(e.uuid,e.path,e.dump),this._animationMgr.setCurDefaultClipByUuid(null==(t=e.dump.value)?void 0:t.uuid),n;return this._nodeMgr.setProperty(e.uuid,e.path,e.dump)}isOperationOnAnimationClip(e,n){var e=this._nodeMgr.query(e),{compName:e,propName:n}=node_1.default.getNameDataByPropPath(e,n);return(e===cc_1.js.getClassName(cc_1.Animation)||e===cc_1.js.getClassName(cc_1.SkeletalAnimation))&&"clips"===n}async removeNodeArrayElement(e){return"__comps__"!==e.path&&(this.isOperationOnAnimationClip(e.uuid,e.path)?(message_1.messageManager.broadcast("scene:change-node",e.uuid),!1):this._nodeMgr.removeArrayElement(e.uuid,e.path,e.index))}onNodeChanged(e,n){this.dispatchEvents("onNodeChanged",e,n),this.recordNode(e)}async createComponent(e){}async removeComponent(e){}onComponentAdded(e){this.dispatchEvents("onComponentAdded",e)}selectNode(t){var i=this._nodeMgr.query(t);if(i){let e=!1,n=i;for(;n;)n.uuid===this._sceneProxy.rootUuid&&(e=!0),n=n.parent;e&&this._selectionMgr.select(t)}}queryCurrentSceneUuid(){var e;return(null==(e=this.fromState)?void 0:e.queryCurrentSceneUuid())||""}async previewMaterial(e,n){await this._assetMgr.previewMaterial(e,n,{emit:!1})}async saveScene(e){return await this._sceneProxy.save(e)}}exports.default=AnimationSceneFacade;