"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const scene_proxy_1=__importDefault(require("./scene-proxy")),utils_1=__importDefault(require("../utils")),cc_1=require("cc"),terrain_1=__importDefault(require("../../terrain")),component_1=__importDefault(require("../../component")),scene_cache_1=require("./../scene-cache"),message_1=require("../../message"),utils_2=require("../../prefab/utils"),serialize_1=require("../../../../export/serialize");class GeneralSceneProxy extends scene_proxy_1.default{constructor(){super(...arguments),this.current="",this._sceneJustSaved=!1}get name(){return"scene"}async open(e){return this._open(e)}async _open(e,t=!0){cce.Ipc.send("clear-scene"),this._staging&&(s=new Error("Scene data has been temporarily stored. This data is about to be discarded."),console.warn(s),this._staging=null);var s=await cce.Ipc.request("query-scene");if(e&&e===s||cce.Selection.clear(),e&&this.current===e)super.open(e);else{if(t){if(!await this.checkClose())return!1;await this.close()}if(e&&"string"==typeof e)if(await this._loadScene(e))return await this._afterLoadScene(),await cce.Ipc.send("set-scene",e),!0;this.current="",await this._loadEmptyScene(),await this._afterLoadScene(),await cce.Ipc.send("set-scene","")}return!0}async _loadScene(t,s){try{return s?await utils_1.default.loadSceneByJson(s):await scene_cache_1.sceneCacheManager.loadCacheScene(t)||await utils_1.default.loadSceneByUuid(t),!0}catch(e){if(console.error("Open scene failed: "+t),console.error(e),!s)return scene_cache_1.sceneCacheManager.loadCacheScene(t)}return!1}async _loadEmptyScene(){var e;return!await scene_cache_1.sceneCacheManager.loadCacheScene("")&&(e=await Editor.Message.request("asset-db","execute-custom-operation","scene","queryDefaultContent"),await utils_1.default.loadSceneByJson(e),e=null==(e=cc_1.director.getScene())?void 0:e.uuid)&&cce.Camera.updateForEmptyScene(e),!0}async _afterLoadScene(){var e=cc_1.director.getScene(),t=e.uuid;this.current=t,this._sceneMgr.sendSceneOpenMsg(e,t,e),super.open(t)}async checkClose(){if(2===await terrain_1.default.close())return!1;var e=await this.queryDirty();if(e)switch(await cce.Ipc.request("dirty-dialog","Scene")){case 0:await this.save(!1,!1);break;case 1:await Editor.Message.request("scene","clear-scene-cache",this.current);break;case 2:return!1}return!0}async close(){var e;return this._staging&&(e=new Error("Scene data has been temporarily stored. This data is about to be discarded."),console.warn(e),this._staging=null),this.current="",this._sceneMgr.sendSceneCloseMsg(cc_1.director.getScene()),super.close(),!0}async reload(){var e;return this._sceneJustSaved?!(this._sceneJustSaved=!1):(e=this.current,!!await this.checkClose()&&(await this.close(),!!await this._open(e,!1)))}async softReload(e=null){var t=cc_1.director.getScene();if(!t)return!1;if(this._isSoftReloading)return!(this._needOneMoreReload=!0);try{this._isSoftReloading=!0;var s=this.storePrefabUUID(t),r=(e=e||this.serialize(!0),this._sceneMgr.sendSceneCloseMsg(t),await utils_1.default.loadSceneByJson(e),cc_1.director.getScene());return this.restorePrefabUUID(r,s),this._sceneMgr.sendSceneOpenMsg(r,r.uuid,r),this._isSoftReloading=!1,this._needOneMoreReload&&(this._needOneMoreReload=!1,this.softReload()),!0}catch(e){return console.error("Failed to refresh the current scene"),console.error(e),!1}}serialize(e=!1){var t,s;return this._staging||((t=cc_1.director.getScene())?(s=new cc_1.SceneAsset,utils_2.prefabUtils.gatherPrefabInstanceRoots(t),utils_2.prefabUtils.removeInvalidPrefabData(t),s.scene=t,e?(0,serialize_1.serializeSafe)(s):cce.Utils.serialize(s)):null)}async save(e,t=!0){var s=cc_1.director.getScene(),s=(s&&(s.children.forEach(e=>{utils_2.prefabUtils.checkMountedRootData(e,!0)}),utils_2.prefabUtils.checkTargetOverridesData(s)),this.serialize(!0));let r=!1,a="";if(r=this.current&&!e&&await cce.Ipc.request("query-asset-meta",this.current)?!0:r)this._sceneJustSaved=!0,await cce.Ipc.send("save-asset",this.current,s);else{if(!(a=await cce.Ipc.send("create-asset","",s,"scene")))return;this._sceneJustSaved=!0,await cce.Ipc.send("set-scene",a)}for(const n of JSON.parse(s))if(n.__type__===cc.js.getClassName(cc_1.Terrain)){const a=n._id;var c=component_1.default.query(a);c&&c._asset&&c._asset._uuid&&await terrain_1.default.saveAssetDialog()}return message_1.messageManager.broadcast("scene:save",a),this._sceneMgr.emit("save",cc_1.director.getScene()),await cce.Ipc.send("immediately-dump",[s,"",""]),this._sceneFacade._undoMgr.save(),!r&&t&&await this.open(a),r?this.current:a}async staging(){return this._staging||(this._staging=this.serialize()),!0}async restore(e){if(e&&(this._staging=e),!this._staging)return!1;this._sceneMgr.sendSceneCloseMsg(cc_1.director.getScene());try{await utils_1.default.loadSceneByJson(this._staging),this.restoreScenePrefabUUID();var t=cc_1.director.getScene();return this._sceneMgr.sendSceneOpenMsg(t,t.uuid,t),this._staging=null,super.open(t.uuid),!0}catch(e){return console.error(e),!1}}async queryDirty(){return cce.SceneFacadeManager.getCurrentFacade().querySceneDirty()}queryCurrentSceneUuid(){return this.current||""}getRootNode(){return this._sceneMgr.rootNode}}exports.default=GeneralSceneProxy;