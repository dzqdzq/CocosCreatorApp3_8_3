"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const node_1=__importDefault(require("../../node")),component_1=__importDefault(require("../../component")),message_1=require("../../message");class SceneProxy{constructor(e,r){this.isOpen=!1,this._staging=null,this.rootUuid="",this._isSoftReloading=!1,this._needOneMoreReload=!1,this._PrefabUUIDMap=new Map,this._sceneMgr=e,this._sceneFacade=r}async open(e){return this.rootUuid=e,this.isOpen=!0,Promise.resolve(!0)}async checkClose(){return Promise.resolve(!0)}async close(){return this.isOpen=!1,Promise.resolve(!0)}async reload(){return Promise.resolve(!0)}async softReload(e=0){return Promise.resolve(!0)}serialize(){return Promise.resolve(!0)}async queryDirty(){return Promise.resolve(!1)}async save(e){return Promise.resolve(!0)}async staging(){return Promise.resolve(!0)}async restore(e=0){return Promise.resolve(!0)}async patch(){return Promise.resolve(!0)}sendModeChangeMsg(e){this._sceneMgr.emit("mode-change",e),message_1.messageManager.broadcast("scene:change-mode",e)}queryCurrentSceneUuid(){return""}getRootNode(){return null}generatePrefabUUIDMap(r,e){if(e){var s=r._prefab;let t=e;s&&(s.instance&&(t=new Map,e.set(s.instance.fileId,t)),t.set(s.fileId,r.uuid),r.components.forEach(e=>{var r=e.__prefab;null!=r&&r.fileId&&(t.has(r.fileId)?console.warn(`generatePrefabUUIDMap ${r.fileId} already exist`):t.set(r.fileId,e.uuid))}));for(let e=0;e<r.children.length;e++){var n=r.children[e];this.generatePrefabUUIDMap(n,t)}}}storePrefabUUID(r){var t=new Map;for(let e=0;e<r.children.length;e++){var s=r.children[e];this.generatePrefabUUIDMap(s,t)}return t}applyPrefabUUID(r,e){if(e){var s=r._prefab;let t=e;s&&(t=s.instance?e.get(s.instance.fileId):t)&&(e=t.get(s.fileId),node_1.default.changeNodeUUID(r.uuid,e),r.components.forEach(e=>{var r=e.__prefab;null!=r&&r.fileId&&(r=t.get(r.fileId))&&component_1.default.changeUUID(e.uuid,r)}));for(let e=0;e<r.children.length;e++){var n=r.children[e];this.applyPrefabUUID(n,t)}}}restorePrefabUUID(r,t){for(let e=0;e<r.children.length;e++){var s=r.children[e];this.applyPrefabUUID(s,t)}}storeScenePrefabUUID(){var e,r=cc.director.getScene();r&&(e=this.storePrefabUUID(r),this._PrefabUUIDMap.set(r.uuid,e))}restoreScenePrefabUUID(){var e=cc.director.getScene(),e=this._PrefabUUIDMap.get(e.uuid);e&&this.restorePrefabUUID(cc.director.getScene(),e)}}exports.default=SceneProxy;