"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,i)}:function(e,t,r,o){e[o=void 0===o?r:o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const scene_proxy_1=__importDefault(require("./scene-proxy")),dumpEncode=__importStar(require("../../../../export/dump/encode")),dumpDecode=__importStar(require("../../../../export/dump/decode")),utils_1=__importDefault(require("../utils")),cc_1=require("cc"),animation_1=__importDefault(require("../../animation")),message_1=require("../../message"),event_enum_1=require("../../../../public/event-enum"),animCompRE=/Animation/;class AnimationSceneProxy extends scene_proxy_1.default{get name(){return"animation"}constructor(e,t){super(e,t),this.root="",this.rootNodeDump=null,this.materialsDump=null,this.duplicateMatUuids=[],this.root="",this.rootNodeDump=null,this.materialsDump=null,this.duplicateMatUuids=[]}getType(e,t){let r=null;return r=cc_1.CCClass._isCCClass(e.constructor)?require("../../animation/utils").utils.getCCClassAnimablePropType(e,t):typeof e[t]}async open(e){this.root=e,this.rootNodeDump=null;var t=cce.Node.query(this.root);return t?(t.walk(e=>{e.components.forEach(e=>{e instanceof cc_1.ParticleSystem2D&&e.onFocusInEditor()})}),this._sceneMgr.emit("animation-start",e),message_1.messageManager.broadcast("scene:animation-start",e),super.open(e),Promise.resolve(!0)):Promise.resolve(!1)}async checkClose(){return animation_1.default.saveCheck()}async close(){var e=cce.Node.query(this.root);return!!e&&(animation_1.default.restoreData(),this.rootNodeDump=dumpEncode.encodeNode(e),animation_1.default.record(this.root,!1),this.root="",this._sceneMgr.emit("animation-end"),message_1.messageManager.broadcast("scene:animation-end"),super.close(),!0)}async reload(){return Promise.resolve(!0)}async softReload(){var e=cc_1.director.getScene();if(!e)return!1;if(this._isSoftReloading)return!(this._needOneMoreReload=!0);try{this._isSoftReloading=!0;var t=this.storePrefabUUID(e),r=new cc.SceneAsset,o=(r.scene=e,cce.Utils.serialize(r)),i=(this._sceneMgr.sendSceneCloseMsg(e),await utils_1.default.loadSceneByJson(o),this.restorePrefabUUID(cc_1.director.getScene(),t),cc_1.director.getScene());this._sceneMgr.sendSceneOpenMsg(i,i.uuid,cce.Node.query(this.root)),this._isSoftReloading=!1,this._needOneMoreReload&&(this._needOneMoreReload=!1,this.softReload())}catch(e){console.error("Failed to refresh the current scene"),console.error(e)}return!0}serialize(){return animation_1.default.getSerializedEditClip()}async queryDirty(){return animation_1.default.isDirty()}async save(){var e=await animation_1.default.save();return e&&this._sceneFacade._undoMgr.save(),e}async patch(){if(!this.rootNodeDump)return Promise.resolve(!1);var e=cce.Node.query(this.rootNodeDump.uuid.value);if(!e)return Promise.resolve(!1);var t=e.getComponent("cc.Animation");let r=null;if(this.rootNodeDump.__comps__.some(e=>!!animCompRE.test(e.cid)&&(r=e,!0)),!t||!r)return Promise.resolve(!1);if(!animation_1.default.isComponentDirty())return Promise.resolve(!1);for(const i in r.value)i in r.value&&await dumpDecode.decodePatch(i,r.value[i],t);dumpDecode.decodeMountedRoot(t,r.mountedRoot);var o=e.components.indexOf(t),o={type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:"__comps__."+o};return cce.Node.emit("change",e,o),Promise.resolve(!0)}getRootNode(){return cc_1.director.getScene()}}exports.default=AnimationSceneProxy;