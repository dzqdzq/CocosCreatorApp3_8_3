"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.formatTime=exports.sceneCacheManager=void 0;const fs_extra_1=require("fs-extra"),utils_1=__importDefault(require("./utils"));class SceneCacheManager{constructor(){this.useSceneCache=!0}async init(){var e=await Editor.Profile.getConfig("scene","scene_cache");this.useSceneCache=e.use,e.use||console.log("The scene instant cache function is turned off")}async queryLatestCache(e){if(this.useSceneCache&&!isPreviewProcess){e=await this.queryLastCacheInfo(e);if(e){var t=await Editor.Dialog.info(Editor.I18n.t("scene.messages.scene_cache.use_latest_scene",{time:formatTime(e.time),url:e.url}),{buttons:[Editor.I18n.t("scene.messages.scene_cache.apply"),Editor.I18n.t("scene.messages.scene_cache.no")],default:1,cancel:1});if(0===t.response)try{return e.json}catch(e){console.error(e)}}}}async loadCacheScene(t=""){var e=await this.queryLatestCache(t);if(!e)return!1;try{return await utils_1.default.loadSceneByJson(e),!0}catch(e){return this.clearSceneCache(t),console.error("Open cache scene failedÔºÅ"),console.error(e),!1}}async queryLastCacheInfo(e){e=await Editor.Message.request("scene","query-latest-cache",e);if(e)try{return{time:e.time,json:e.data||(0,fs_extra_1.readJSONSync)(e.file),url:e.url}}catch(e){console.error(e)}}clearSceneCache(e){Editor.Message.send("scene","clear-scene-cache",e)}}function formatTime(e){return new Date(e).toLocaleString()}exports.sceneCacheManager=new SceneCacheManager,exports.formatTime=formatTime;