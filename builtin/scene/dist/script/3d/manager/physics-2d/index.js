"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Physics2DManager=void 0;const sharp_1=__importDefault(require("sharp")),cc_1=require("cc"),marching_squares_1=__importDefault(require("./marching-squares")),node_1=__importDefault(require("../node"));function getNodeRectPoints(e,t){if(!e||0===e.width&&0===e.height)return t&&t(null,[new cc_1.Vec2(-50,-50),new cc_1.Vec2(50,-50),new cc_1.Vec2(50,50),new cc_1.Vec2(-50,50)]);var r=-e.anchorX*e.width,o=-e.anchorY*e.height,n=r+e.width,e=o+e.height;t&&t(null,[new cc_1.Vec2(r,o),new cc_1.Vec2(r,e),new cc_1.Vec2(n,e),new cc_1.Vec2(n,o)])}class Physics2DManager{async getContourPoints(e,r={threshold:1,loop:!0},o){const n=e.getComponent(cc_1.UITransform);if(!n)return getNodeRectPoints(n,o);e=e.getComponent(cc_1.SpriteComponent);if(!e)return getNodeRectPoints(n,o);e=e.spriteFrame;if(!e)return getNodeRectPoints(n,o);var t=e._uuid.split("@")[0],t=await Editor.Message.request("asset-db","query-path",t);if(!t)return getNodeRectPoints(n,o);const i=require("./rdp"),c=e.getRect();let s=c.width,h=c.height;e=e.isRotated();e&&(s=c.height,h=c.width),(0,sharp_1.default)(t).extract({left:c.x,top:c.y,width:s,height:h}).rotate(e?90:0).raw().toBuffer((e,t)=>{if(e)return o&&o(e);e=marching_squares_1.default.getBlobOutlinePoints(t,c.width,c.height,r.loop);0<(e=i(e,r.threshold)).length&&e[0].equals(e[e.length-1])&&--e.length,e.forEach(e=>{e.y=c.height-e.y,e.x*=n.width/c.width,e.y*=n.height/c.height,e.x-=n.anchorX*n.width,e.y-=n.anchorY*n.height}),cc_1.Physics2DUtils.PolygonSeparator.ForceCounterClockWise(e),o&&o(null,e)})}resetPoints(r){this.getContourPoints(r.node,{threshold:r.threshold,loop:!0},(e,t)=>{if(e)return console.error(e);e=cce.SceneFacadeManager.beginRecording(r.uuid);r.points=t,cce.SceneFacadeManager.endRecording(e),node_1.default.emit("change",r.node)})}resetPointsByUuid(e){var t=cce.Component.query(e);t?this.resetPoints(t):console.error(`Component with UUID ${e} does not exist!`)}}exports.Physics2DManager=Physics2DManager,exports.default=new Physics2DManager;