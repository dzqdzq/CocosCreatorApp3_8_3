"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.startup=void 0;const webview_1=__importDefault(require("./webview")),queue=[];let lock=!0;const outTime=18e4,customIpc=webview_1.default;function startup(){lock=!1,step(),Editor.Metrics.trackTimeEnd("scene:scene-view-startup",{output:!0})}async function step(e=!1){if(!(lock=!e&&lock)){const r=queue.shift();if(r){const s=r.options;e=cce[s.module];if(!e)throw new Error(`Module [${s.module}] does not exist.(Method: ${s.handler})`);if(!e[s.handler])throw new Error(`Method [${s.handler}] does not exist.(Module: ${s.module})`);lock=!0;try{var t=e[s.handler](...s.params);if(t instanceof Promise){let o;Promise.race([t,new Promise((e,t)=>{o=setTimeout(async()=>{console.debug("Scene Not Response",s.module+"."+s.handler),queue.forEach(e=>{console.debug("ipc queue",e.options.module,e.options.handler)}),await Editor.Dialog.warn(Editor.I18n.t("scene.messages.warning"),{detail:Editor.I18n.t("scene.messages.not_response"),buttons:[Editor.I18n.t("scene.messages.confirm")]}),t(new Error(`${s.module}.${s.handler} timeout.
  `+JSON.stringify(s.params)))},outTime)})]).then(e=>{r.resolve(e)}).catch(e=>{r.reject(e)}).finally(()=>{o&&clearTimeout(o),step(!0)})}else r.resolve(t),step(!0)}catch(e){r.reject(e),step(!0)}}}}customIpc.startup=startup,customIpc.clearQueue=()=>{queue.length=0},exports.startup=startup,customIpc.on("call-method",s=>{if(s.queue)return new Promise((e,t)=>{queue.push({options:s,resolve:e,reject:t}),step()});{var e=cce[s.module];if(!e)throw new Error(`Module [${s.module}] does not exist.(Method: ${s.handler})`);if(!e[s.handler])throw new Error(`Method [${s.handler}] does not exist.(Module: ${s.module})`);const n=e[s.handler](...s.params);return new Promise((t,o)=>{if(n instanceof Promise)if(s.timeout){const r=setTimeout(()=>{o(new Error(`${s.module}.${s.handler} timeout.
  `+JSON.stringify(s.params)))},3e4);n.then(e=>{clearTimeout(r),t(e)}).catch(e=>{clearTimeout(r),o(e)})}else n.then(e=>{t(e)}).catch(e=>{o(e)});else t(n)})}}),exports.default=customIpc;