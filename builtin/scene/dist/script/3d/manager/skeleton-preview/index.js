"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SkeletonPreview=void 0;const cc_1=require("cc"),misc_1=require("../../../utils/misc"),controller_utils_1=__importDefault(require("../../../public/gizmos/utils/controller-utils")),node_1=__importDefault(require("../../../utils/node")),Interactive_preview_1=require("../preview/Interactive-preview"),regions=[new cc_1.gfx.BufferTextureCopy],tempVec3A=(regions[0].texExtent.depth=1,new cc_1.Vec3),tempVec3B=new cc_1.Vec3,tempQuatA=new cc_1.Quat;class JointData{constructor(){this.childJoint=[],this.position=new cc_1.Vec3}}class SkeletonPreview extends Interactive_preview_1.InteractivePreview{constructor(){super(...arguments),this._jointMap={}}init(e,t){super.init(e,t)}createNodes(e){this.lightComp=new cc.Node("Skeleton Preview Light").addComponent(cc_1.DirectionalLight),this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.parent=e}async setSkeleton(e){if(!e)return console.warn("invalid uuid"),null;this._modelNode&&(this.scene.removeChild(this._modelNode),this._modelNode.isValid)&&this._modelNode.destroy(),cc_1.assetManager.assets.has(e)&&cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(e));var t=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(e);if(t.joints.length!==t.bindposes.length)return console.error("joints number not equal to bindposes number"),null;this._modelNode&&(this.scene.removeChild(this._modelNode),this._modelNode.isValid)&&this._modelNode.destroy();var i=new cc_1.Node("SkeletonRoot");i.layer=cc_1.Layers.Enum.DEFAULT,this._jointMap={};for(let e=0;e<t.joints.length;e++){var o=t.joints[e],s=t.inverseBindposes[e],n=new JointData;cc_1.Vec3.transformMat4(n.position,n.position,s),this._jointMap[o]=n}for(let e=0;e<t.joints.length;e++){var r=t.joints[e],a=r.lastIndexOf("/");0<a&&(a=r.substring(0,a),a=this._jointMap[a],r=this._jointMap[r],a)&&(a.childJoint.push(r),(r=controller_utils_1.default.octahedron(r.position,a.position,.15,.15,.8,cc_1.Color.GRAY,{effectName:"builtin-standard"})).parent=i,r.layer=cc_1.Layers.Enum.DEFAULT)}return i.parent=this.scene,this._modelNode=i,this.cameraComp.enabled=!0,this.resetCamera(),this.perfectCameraView(node_1.default.getBoundaryOfMeshNodes([this._modelNode])),{jointCount:t.joints.length}}setLightEnable(e){this.lightComp.enabled!==e&&(this.lightComp.enabled=e)}resetCamera(){this._modelNode&&super.resetCamera(this._modelNode)}}exports.SkeletonPreview=SkeletonPreview;