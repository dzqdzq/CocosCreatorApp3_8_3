"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NodeManager=void 0;const NodeMgr=EditorExtends.Node,EventEmitter_1=__importDefault(require("../../../public/EventEmitter")),{get,set,findLast}=require("lodash"),utils_1=require("./utils"),promisify=require("util")["promisify"],{basename,extname}=require("path"),node_1=__importDefault(require("../../../utils/node")),dump_1=__importDefault(require("../../../export/dump")),get_component_function_of_node_1=__importDefault(require("../../utils/get-component-function-of-node")),cc_1=require("cc"),event_enum_1=require("../../../public/event-enum"),utils_2=require("../prefab/utils"),selection_1=__importDefault(require("../selection")),scene_facade_state_interface_1=require("../../facade/scene-facade-state-interface"),creatableAssetTypes=["cc.AnimationClip","cc.AudioClip","cc.BitmapFont","cc.LabelAtlas","cc.Mesh","cc.ParticleAsset","cc.Prefab","cc.Script","cc.SpriteFrame","cc.TTFFont","cc.TerrainAsset","cc.TiledMapAsset","cc.VideoClip","dragonBones.DragonBonesAsset","dragonBones.DragonBonesAtlasAsset","sp.SkeletonData"];let stashInstants=null;class NodeManager extends EventEmitter_1.default{constructor(){super(...arguments),this._previewPropertysCache=new Map,this.requireComponentList=[]}get creatableAssetTypes(){return creatableAssetTypes}init(){}initWithScene(e){if(e){const t=NodeMgr.getNodesInScene();Object.keys(t).forEach(e=>{this.registerEventListeners(t[e])}),this.registerNodeMgrEvents(),cce.Component.init(),this._previewPropertysCache=new Map,this.emit("inited",this.queryUuids(),e)}}onSceneOpened(e){this.initWithScene(e)}onSceneClosed(){cce.Component.unregisterCompMgrEvents(),this.unregisterNodeMgrEvents(),this.clear()}registerNodeMgrEvents(){this.unregisterNodeMgrEvents(),this._onNodeAdded=this.add.bind(this),NodeMgr.on("add",this._onNodeAdded),this._onNodeChanged=this.change.bind(this),NodeMgr.on("change",this._onNodeChanged),this._onNodeRemoved=this.remove.bind(this),NodeMgr.on("remove",this._onNodeRemoved)}unregisterNodeMgrEvents(){this._onNodeAdded&&NodeMgr.off("add",this._onNodeAdded),this._onNodeChanged&&NodeMgr.off("change",this._onNodeChanged),this._onNodeRemoved&&NodeMgr.off("remove",this._onNodeRemoved)}registerEventListeners(e){e&&e.isValid&&!node_1.default.isEditorNode(e)&&(this._onTransformChanged=this.onNodeTransformChanged.bind(this,e),e.on(cc_1.Node.EventType.TRANSFORM_CHANGED,this._onTransformChanged,this),this._onSizeChanged=this.onNodeSizeChanged.bind(this,e),e.on(cc_1.Node.EventType.SIZE_CHANGED,this._onSizeChanged,this),this._onAnchorChanged=this.onNodeAnchorChanged.bind(this,e),e.on(cc_1.Node.EventType.ANCHOR_CHANGED,this._onAnchorChanged,this),this._onParentChanged=this.onNodeParentChanged.bind(this,e),e.on(cc_1.Node.EventType.CHILD_ADDED,this._onParentChanged,this),e.on(cc_1.Node.EventType.CHILD_REMOVED,this._onParentChanged,this),this._onLightProbeChanged=this.onLightProbeChanged.bind(this,e),e.on(cc_1.Node.EventType.LIGHT_PROBE_CHANGED,this._onLightProbeChanged,this))}unregisterEventListeners(e){e&&e.isValid&&!node_1.default.isEditorNode(e)&&(this._onTransformChanged&&e.off(cc_1.Node.EventType.TRANSFORM_CHANGED,this._onTransformChanged),this._onSizeChanged&&e.off(cc_1.Node.EventType.SIZE_CHANGED,this._onSizeChanged),this._onAnchorChanged&&e.off(cc_1.Node.EventType.ANCHOR_CHANGED,this._onAnchorChanged),this._onParentChanged&&e.off(cc_1.Node.EventType.CHILD_ADDED,this._onParentChanged),this._onParentChanged&&e.off(cc_1.Node.EventType.CHILD_REMOVED,this._onParentChanged),this._onLightProbeChanged)&&e.off(cc_1.Node.EventType.LIGHT_PROBE_CHANGED,this._onLightProbeChanged)}onNodeTransformChanged(e,t){var r={type:event_enum_1.NodeEventType.TRANSFORM_CHANGED,source:event_enum_1.EventSourceType.ENGINE};switch(t){case cc_1.Node.TransformBit.POSITION:r.propPath="position";break;case cc_1.Node.TransformBit.ROTATION:r.propPath="rotation";break;case cc_1.Node.TransformBit.SCALE:r.propPath="scale"}this.emit("change",e,r)}onNodeSizeChanged(e){var t={type:event_enum_1.NodeEventType.SIZE_CHANGED,source:event_enum_1.EventSourceType.ENGINE},r=e.getComponent(cc_1.UITransform);r&&(r=e.components.indexOf(r),t.propPath=`_components.${r}.contentSize`),this.emit("change",e,t)}onNodeAnchorChanged(e){var t={type:event_enum_1.NodeEventType.ANCHOR_CHANGED,source:event_enum_1.EventSourceType.ENGINE},r=e.getComponent(cc_1.UITransform);r&&(r=e.components.indexOf(r),t.propPath=`_components.${r}.anchorPoint`),this.emit("change",e,t)}onNodeParentChanged(e,t){node_1.default.isEditorNode(t)||(this.emit("change",e,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),t.parent&&this.emit("change",t,{type:event_enum_1.NodeEventType.PARENT_CHANGED}))}onLightProbeChanged(e){var t={type:event_enum_1.NodeEventType.LIGHT_PROBE_CHANGED,source:event_enum_1.EventSourceType.ENGINE};this.emit("change",e,t)}clear(){const t=NodeMgr.getNodes();Object.keys(t).forEach(e=>{this.unregisterEventListeners(t[e])}),NodeMgr.clear(),cce.Component.clear()}add(e,t){this.registerEventListeners(t),node_1.default.isEditorNode(t)||this.emit("added",t)}change(e,t){if(!node_1.default.isEditorNode(t)){let e="";var r=t.getComponent(cc_1.LODGroup);r&&(r=t.components.indexOf(r),e="__comps__."+r),this.emit("change",t,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:e})}}remove(e,t){this.unregisterEventListeners(t),node_1.default.isEditorNode(t)||this.emit("removed",t,{source:event_enum_1.EventSourceType.ENGINE})}query(e){var t;return void 0===e?null:null!=(t=NodeMgr.getNode(e))?t:cce.SceneFacadeManager.getCurrentFacade().queryRecycleNode(e)}queryUuids(){var e=NodeMgr.getNodes();return Object.keys(e)}queryDump(e){e=NodeMgr.getNodesInScene()[e];return e?dump_1.default.dumpNode(e):null}queryDumpAtAll(e){e=this.query(e);return e?dump_1.default.dumpNode(e):null}queryNodesByAssetUuid(e){return e?NodeMgr.getNodesByAsset(e):[]}async queryNodesMissAsset(){var e;const a=[],o=[],t=(EditorExtends.walkProperties(null==(e=cc_1.director.getScene())?void 0:e.children,(e,t,r,n)=>{r._uuid&&!(cc.assetManager.assets.get(r._uuid)||cc.assetManager.assets.get(Editor.Utils.UUID.compressUUID(r._uuid,!0)))&&(n=findLast(n,e=>e instanceof cc.Node))&&!a.includes(n.uuid)&&a.push(n.uuid),r instanceof cc_1.MissingScript&&(n=null==(n=r._$erialized)?void 0:n.__type__,o.push({nodeUuid:r.node.uuid,scriptUuid:EditorExtends.UuidUtils.decompressUuid(n)}))},{dontSkipNull:!1,ignoreSubPrefabHelper:!0}),(await Editor.Message.request("asset-db","batch-message-handler",o.map(e=>({name:"query-asset-info",args:[e.scriptUuid]})))).map(e=>e&&e.uuid));return o.forEach(e=>{t.includes(e.scriptUuid)||a.includes(e.nodeUuid)||a.push(e.nodeUuid)}),a}async previewSetNodeProperty(e,t,r){var n=this.query(e),a=dump_1.default.parsingPath(t,n);if(!n)return console.warn("previewSetNodeProperty failed：node not found",e),!1;if(!a.search)return console.warn("previewSetNodeProperty failed：property path error",t),!1;let o=get(n,a.search)?get(n,a.search)[a.key]:void 0;o=o||dump_1.default.getDefaultValue(r.type);n=dump_1.default.encodeObject(o,{type:r.type,ctor:o.constructor},o),a=this._previewPropertysCache.has(e)?this._previewPropertysCache.get(e):new Map;return null!=a&&a.has(t)||null!=a&&a.set(t,n),this._previewPropertysCache.set(e,a),this.setProperty(e,t,r,!1)}async cancelPreviewSetNodeProperty(e,t){var r=this.query(e),n=dump_1.default.parsingPath(t,r);return r?n.search?!!(r=this._previewPropertysCache.get(e))&&!!(n=null==r?void 0:r.get(t))&&(null!=r&&r.delete(t),this.setProperty(e,t,n,!1)):(console.warn("cancelPreviewSetNodeProperty failed:property path error",t),!1):(console.warn("cancelPreviewSetNodeProperty failed:node not found",e),!1)}async setProperty(e,t,r,n=!0){var a;return Array.isArray(e)?(e.forEach(async e=>{await this.setProperty(e,t,r)}),!1):(a=this.query(e))?(this.emit("before-change",a),"parent"===t&&a.parent&&this.emit("before-change",a.parent),await dump_1.default.restoreProperty(a,t,r),this.emit("change",a,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t,record:n}),"parent"===t&&a.parent&&this.emit("change",a.parent,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:"children",record:n}),!0):(console.warn(`Set property failed: ${e} does not exist`),!1)}async resetProperty(e,t){if(Array.isArray(e))e.forEach(e=>{this.resetProperty(e,t)});else{var r=this.query(e);if(!r)return console.warn(`Set default value failed: ${e} does not exist`),!1;this.emit("before-change",r),await dump_1.default.resetProperty(r,t),this.emit("change",r,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t})}return!0}async updatePropertyFromNull(e,t){if(Array.isArray(e))e.forEach(e=>{this.updatePropertyFromNull(e,t)});else{var r=this.query(e);if(!r)return console.warn(`Set default value failed: ${e} does not exist`),!1;this.emit("before-change",r),await dump_1.default.updatePropertyFromNull(r,t),this.emit("change",r,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t})}return!0}async resetNode(e){if(Array.isArray(e))e.forEach(e=>{this.resetNode(e)});else{var t=this.query(e);if(!t)return console.warn(`Set default value failed: ${e} does not exist`),!1;this.emit("before-change",t);for(const r of["position","rotation","scale","mobility"])await dump_1.default.resetProperty(t,r),this.emit("change",t,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:r})}return!0}async setNodeAndChildrenLayer(e,t){await this.setProperty(e,"layer",t);e=this.query(e);e&&e.children&&0<e.children.length&&e.children.forEach(e=>{this.setNodeAndChildrenLayer(e.uuid,t)})}moveArrayElement(e,t,r,n){if(Array.isArray(e))return e.forEach(e=>{this.moveArrayElement(e,t,r,n)}),!1;var a=this.query(e);if(!a)return console.warn(`Move property failed: ${e} does not exist`),!1;var o=(t=t.replace("__comps__","_components"))?get(a,t):a;if(!o)return console.warn(`Move property failed: ${e} does not exist`),!1;if(!Array.isArray(o))return console.warn(`Move property failed: ${e} - ${t} isn't an array`),!1;if(this.emit("before-change",a),"children"===t){var e=o.filter(e=>!(e.objFlags&cc.Object.Flags.HideInHierarchy)),s=e[r];if(!s)return!1;e=o.indexOf(e[r+n]);s.setSiblingIndex(e)}else{s=o.splice(r,1);o.splice(r+n,0,s[0]),set(a,t,o)}return this.emit("change",a,{type:event_enum_1.NodeOperationType.MOVE_ARRAY_ELEMENT,propPath:t}),!0}removeArrayElement(e,t,r){if(Array.isArray(e))e.forEach(e=>{this.removeArrayElement(e,t,r)});else{var n=this.query(e),a=(t||"").split(".").pop();if("children"===a)return console.warn("Unable to change `children` of the parent, Please change the `parent` of the child"),!1;if(!n)return console.warn(`Move property failed: ${e} does not exist`),!1;var o=(t=t.replace("__comps__","_components"))?get(n,t):n;if(!o)return console.warn(`Move property failed: ${e} does not exist`),!1;if(!Array.isArray(o))return console.warn(`Move property failed: ${e} - ${t}.${a} isn't an array`),!1;this.emit("before-change",n),"_components"===t?(e=o[r],this.removeComponent(e.uuid)):(o.splice(r,1),set(n,t,o)),this.emit("change",n,{type:event_enum_1.NodeOperationType.REMOVE_ARRAY_ELEMENT,propPath:t,index:r})}return!0}onComponentAdded(t,e){0!==this.requireComponentList.length&&this.requireComponentList.find(e=>t instanceof e)&&this.requireComponentList.find(e=>cc_1.js.getClassName(e)===cc_1.js.getClassName(t))&&cce.Component.onComponentAddedFromEditor(t)}createComponent(e,n){if(Array.isArray(e))return e.forEach(e=>{this.createComponent(e,n)}),console.warn("don't add component to more than one node at one time"),!1;var a=this.query(e);if(!a)return console.warn(`create component failed: ${e} does not exist`),!1;if(!n)return console.warn(`create component failed: ${n} does not exist`),!1;{this.emit("before-change",a),this.emit("before-add-component",n,a);let r=null;try{if("MissingScript"===n||"cc.MissingScript"===n)throw new Error("Reset Component failed: MissingScript does not exist");let t=cc_1.js.getClassById(n);if(t=t||cc_1.js.getClassByName(n),cc_1.js.isChildClassOf(t,cc_1.Component)){let e=t;if(e._requireComponent)for(;e._requireComponent;)this.requireComponentList.push(e._requireComponent),e=e._requireComponent;r=a.addComponent(t),this.requireComponentList=[]}else console.error(`ctor with name ${n} is not child class of Component `);this.checkComponentsCollision(a),this.checkDynamicBodyShape(a)}catch(e){console.error(e)}r&&cce.Component.onComponentAddedFromEditor(r),this.emit("change",a,{type:event_enum_1.NodeOperationType.CREATE_COMPONENT})}return!0}async resetComponent(e){var t=cce.Component.query(e);if(!t)return console.warn(`Reset Component failed: ${e} does not exist`),!1;this.emit("before-change",t.node);e=await cce.Component.resetComponent(t);return this.emit("change",t.node,{type:event_enum_1.NodeOperationType.RESET_COMPONENT}),e}removeComponent(e){var t=cce.Component.query(e);return t?cce.Component.removeComponent(t):(console.warn(`Remove Component failed: ${e} does not exist`),!1)}copyNode(e){Array.isArray(e)||(e=[e]),e=this.canRemoveOrCopy(e),stashInstants={};for(const r of e){var t=this.query(r);t&&(function t(r){var e=r._prefab;if(e){if(e.instance)return;r._prefab=null;for(let e=0;e<r.components.length;e++)r.components[e].__prefab=null}if(0<r.children.length){let e=r.children.length;for(;e--;){var n=r.children[e],a=n.objFlags&cc.Object.Flags.HideInHierarchy,o=n.objFlags&cc.Object.Flags.DontSave;a&&o?r.removeChild(n):t(n)}}}(t=cc.instantiate(t)),stashInstants[r]={instant:t})}return e}duplicateNode(e){Array.isArray(e)||(e=[e]);var t=[],r=stashInstants;for(const a of e=this.copyNode(e)){var n=this.query(a);n&&(n=this.createNode(null==(n=n.parent)?void 0:n.uuid,null,a,!1,!0))&&t.push(n)}stashInstants=r;e=t.filter(Boolean);return selection_1.default.clear(),e.forEach(e=>{selection_1.default.select(e)}),e}async pasteNode(e,t,r=!1){var n=[];for(const i of t=Array.isArray(t)?t:[t]){var a,o,s=this.createNode(e,null,i,r,!0);s&&((o=this.query(s))&&(a=cce.SceneFacadeManager.getCurrentFacade().modeName===scene_facade_state_interface_1.SceneModeType.Prefab&&this.checkNodeUseCanvasRequired(o),(a=await this.checkCanvasRequired(o,a,this.getNewNodeParent(e),void 0))!==o)&&o.setParent(a,r),n.push(s),e||(o=this.query(s))&&(e=null==(a=o.parent)?void 0:a.uuid))}t=n.filter(Boolean);return selection_1.default.clear(),t.forEach(e=>{selection_1.default.select(e)}),t}setParent(e,t,r=!1){t=(t=Array.isArray(t)?t:[t]).filter(e=>{e=this.query(e);return!(!e||!e.parent)});let n;n=(n=e?this.query(e):n)||cc_1.director.getScene();for(const o of t){var a=this.query(o);null!=a&&a.setParent(n,r)}return t}generateAvailableName(e,t){e=e||"Node";let r=cc_1.director.getScene();return t&&(t=this.query(t),r=t||r),(0,utils_1.getNodeName)(e,r)}createNode(t,r,n,a=!1,o=!1){if(cc.director._scene){null===a&&(a=!0);var s,t=this.getNewNodeParent(t);let e=null;if(n&&stashInstants[n]&&(s=stashInstants[n]["instant"],s)&&(e=cc.instantiate(s))&&((0,utils_1.visitNode)(e,e=>{e=e._prefab;if(null!=e&&e.instance)return e.instance=utils_2.prefabUtils.cloneInstanceWithNewFileId(e.instance),!0}),r=(0,utils_1.getNodeName)(e.name,t)),e=e||new cc.Node)return r&&(e.name=r),t.layer&&t!==cc_1.director.getScene()&&!o&&(e.layer=t.layer),this.emit("before-add",e),this.emit("before-change",t),e.setParent(t,a),n||this.ensureUITransformComponent(e),this.emit("add",e),t&&this.emit("change",t,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),cce.Selection.clear(),cce.Selection.select(e.uuid),e.uuid}}ensureUITransformComponent(r){if(r instanceof cc.Node&&0===r.children.length){let e=!1,t=r.parent;for(;t;){if(t.components.map(e=>cc.js.getClassName(e.constructor)).includes("cc.Canvas")){e=!0;break}t=t.parent}if(e)try{r.addComponent("cc.UITransform")}catch(e){console.error(e)}}}async restorePrefab(e,t){var r;const l=this;if(!cc_1.director.getScene())return!1;const n=cce.Selection.query(),u=(cce.Selection.clear(),this.query),p=u(e),h={};const _={};const a={};function m(e){const r={};if(e){if(a[e.uuid])return a[e.uuid];Array.isArray(e.children)&&(e.children.forEach((e,t)=>{e&&e._prefab&&(r[e._prefab.fileId]=t)}),a[e.uuid]=r)}return r}async function f(r,n,a){if(r.objFlags&cc.Object.Flags.HideInHierarchy)return!1;var n=m(n),o=function(e){const t={};if(e){if(_[e.uuid])return _[e.uuid];Array.isArray(e.children)&&(e.children.forEach(e=>{e&&e._prefab&&(t[e._prefab.fileId]=e.uuid)}),_[e.uuid]=t)}return t}(a),s=dump_1.default.dumpNode(r),i=s.__prefab__.fileId,c=a?u(o[i]):p;if(c){if(l.emit("before-change",c),Array.isArray(c.children)){var d=m(r);let e=0,t=c.children[e];for(;t&&e<c.children.length;)t._prefab&&void 0===d[t._prefab.fileId]?l.removeNode(t.uuid):e++,t=c.children[e]}o=dump_1.default.dumpNode(c);delete s.uuid,delete s.children,a?s.parent.value.uuid=a.uuid:(s.active.value=o.active.value,s.name.value=o.name.value,s.position.value=o.position.value,s.rotation.value=o.rotation.value),s.__prefab__=JSON.parse(JSON.stringify(o.__prefab__)),Array.isArray(s.__comps__)&&!function o(e){e.forEach(e=>{var t,r,n;if(e.value&&"object"==typeof e.value)for(const a of Object.keys(e.value))["node"].includes(a)||((t=e.value[a]).isArray&&Array.isArray(t.value)?o(t.value):"cc.Node"===t.type&&(r=u(t.value.uuid))&&null!=(n=null==r?void 0:r._prefab)&&n.fileId&&(n=h[r._prefab.fileId])&&(t.value.uuid=n.uuid))})}(s.__comps__),await dump_1.default.restoreNode(c,s),void 0!==n[i]&&c.setSiblingIndex(n[i]);let e=0,t=r.children[e];for(;t&&e<r.children.length;)await f(t,r,c)||e++,t=r.children[e];return l.emit("change",c),!1}o=r._prefab;return o&&a&&(l.emit("before-add",r),l.emit("before-change",a),s=n[o.fileId],a.insertChild(r,s),o.root=null==(i=a._prefab)?void 0:i.root,l.emit("add",r),l.emit("change",a)),!0}try{!function t(e){e&&e._prefab&&(h[e._prefab.fileId]=e,Array.isArray(e.children))&&e.children.forEach(e=>{t(e)})}(p);var o=await promisify(cc_1.assetManager.loadAny)(t),s=cc.instantiate(o);null!=(r=p.parent)&&r.addChild(s),await f(s),s.parent=null,this.emit("change",p)}catch(e){return console.warn("The prefab asset no longer exist."),console.error(e),!1}return setTimeout(()=>{n.forEach(e=>{cce.Selection.select(e)})}),!0}checkNodeUseCanvasRequired(e){if(!e)return!1;let t=!1;return!e.getComponent("cc.Canvas")&&(e.walk(e=>{t||e.components.forEach(e=>{t=t||"cc.UITransform"===cc_1.js.getClassName(e)})}),t)}async checkCanvasRequired(e,r,n,a){var o=cce.SceneFacadeManager.queryMode();let s=null,i=null;if("prefab"===o&&(s=cce.SceneFacadeManager._facadeFSM.prefabSceneFacade._sceneProxy,i=s.getRootNode(),n===cc_1.director.getScene())&&(n=i),r){let t=null;if("prefab"===o){t=(0,utils_1.getUICanvasNode)(n,!1);r=(0,utils_1.getUITransformParentNode)(n);if(t)t.parent!==cc_1.director.getScene()&&(n=t);else if(r)t=r;else{o=await Editor.Dialog.warn(Editor.I18n.t("scene.contributions.messages.description.UITransform_lack"),{buttons:[Editor.I18n.t("scene.contributions.messages.description.UITransform_add_to_root"),Editor.I18n.t("scene.contributions.messages.description.UITransform_within_canvas"),Editor.I18n.t("scene.contributions.messages.description.UITransform_cancel")],default:0,cancel:2});if(0===o.response){if(!i)return console.error("prefab Root is not exist"),null;i.addComponent("cc.UITransform"),i.parent&&!(0,utils_1.hasOneKindOfComponent)(i.parent,cc_1.Canvas)&&(t=await(null===s||void 0===s?void 0:s._sceneWrapCanvasNode(cc_1.director.getScene())),i.parent=t)}2===o.response&&(t=new cc_1.Node)}}else(t=(0,utils_1.getUICanvasNode)(n))&&(n=t);if(!t){let e="f773db21-62b8-4540-956a-29bacf5ddbf5";"2d"===cce.SceneFacadeManager._projectType&&(e="4c33600e-9ca9-483b-b734-946008261697"),cc_1.assetManager.assets.remove(e);r=await promisify(cc_1.assetManager.loadAny)(e);t=cc.instantiate(r),cce.Prefab.removePrefabInfoFromNode(t),n.addChild(t),n=t}a&&(a.z=t.position.z)}return n}async createNodeFromAsset(n,a,e){if(cc.director._scene){n=this.getNewNodeParent(n);try{var{name:o,type:s,position:i,unlinkPrefab:c}=e;let r=e["canvasRequired"];if(!s||creatableAssetTypes.includes(s)){DEBUG_TIME_COST&&console.time("createNodeFromAsset");let e,t;switch(s){case"cc.AnimationClip":cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a);var d=(e=new cc_1.Node(t.name)).addComponent(cc_1.Animation);d&&(d.defaultClip=t);break;case"cc.AudioClip":cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a);var l=(e=new cc_1.Node(t.name)).addComponent(cc_1.AudioSource);l&&(l.clip=t);break;case"cc.BitmapFont":r=!0,cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a),(e=new cc_1.Node(t.name)).layer=cc_1.Layers.Enum.UI_2D;var u=e.addComponent(cc_1.Label);u&&(u.font=t);break;case"cc.LabelAtlas":r=!0,cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a),(e=new cc_1.Node(t.name)).layer=cc_1.Layers.Enum.UI_2D;var p=e.addComponent(cc_1.Label),h=(p.font=t,p.fontSize=t.fontSize,t.fntConfig.commonHeight);p.lineHeight=h||p.lineHeight;break;case"cc.Mesh":cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a);var _=(e=new cc_1.Node(t.name)).addComponent(cc_1.MeshRenderer);_&&(_.mesh=t),await createNodeMetrics(a);break;case"cc.ParticleAsset":r=!0,cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a);var m=(e=new cc_1.Node(t.name)).addComponent(cc_1.ParticleSystem2D);m&&(m.file=t);break;case"cc.Prefab":cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a),e=cce.Prefab.createNodeFromPrefabAsset(t),await createNodeMetrics(a),await createLODMetrics(e);break;case"cc.Script":var f=await cce.Script.queryScriptName(a)||"",y=await cce.Script.queryScriptCid(a)||"";e=new cc_1.Node(f),y&&"MissingScript"!==y&&"cc.MissingScript"!==y&&e.addComponent(cc_1.js.getClassById(y));break;case"cc.SpriteFrame":r=!0,cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a);var g,v="9db8cd0b-cbe4-42e7-96a9-a239620c0a9d",N=(cc_1.assetManager.assets.remove(v),await promisify(cc_1.assetManager.loadAny)(v)),C=(N.name=t.name,(e=cc.instantiate(N)).layer=cc_1.Layers.Enum.UI_2D,e.getComponent("cc.Sprite"));C&&(C.spriteFrame=t,g=await Editor.Message.request("asset-db","query-asset-meta",a))&&"none"===g.userData.trimType&&(C.trim=!1,C.sizeMode=cc_1.Sprite.SizeMode.RAW);break;case"cc.TTFFont":r=!0,cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a),(e=new cc_1.Node(t.name)).layer=cc_1.Layers.Enum.UI_2D;var E=e.addComponent(cc_1.Label);E&&(E.font=t);break;case"cc.TerrainAsset":cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a);var b=(e=new cc_1.Node(t.name)).addComponent(cc_1.Terrain);b&&(b._asset=t);break;case"cc.TiledMapAsset":r=!0,cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a),(e=new cc_1.Node(t.name)).layer=cc_1.Layers.Enum.UI_2D;var A=e.addComponent(cc_1.TiledMap);A&&(A.tmxAsset=t);break;case"cc.VideoClip":r=!0,cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a),(e=new cc_1.Node(t.name)).layer=cc_1.Layers.Enum.UI_2D;var M=e.addComponent(cc_1.VideoPlayer);M&&(M.clip=t);break;case"dragonBones.DragonBonesAsset":r=!0,cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a),(e=new cc_1.Node(t.name)).layer=cc_1.Layers.Enum.UI_2D;var T=e.addComponent(cc_1.dragonBones.ArmatureDisplay);T&&(T.dragonAsset=t);break;case"dragonBones.DragonBonesAtlasAsset":r=!0,cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a),(e=new cc_1.Node(t.name)).layer=cc_1.Layers.Enum.UI_2D;var w=e.addComponent(cc_1.dragonBones.ArmatureDisplay);w&&(w.dragonAtlasAsset=t);break;case"sp.SkeletonData":r=!0,cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a),(e=new cc_1.Node(t.name)).layer=cc_1.Layers.Enum.UI_2D;var S=e.addComponent(cc_1.sp.Skeleton);S&&(S.skeletonData=t);break;default:cc_1.assetManager.assets.remove(a),t=await promisify(cc_1.assetManager.loadAny)(a),e=cc.instantiate(t)}return n=await this.checkCanvasRequired(e,Boolean(r),n,i),o&&(e.name=basename(o,extname(o))),DEBUG_TIME_COST&&console.time("addNodeEvent"),this.emit("before-add",e),this.emit("before-change",n),("cc.Prefab"!==s||c)&&(cce.Prefab.removePrefabInfoFromNode(e),n.layer)&&n!==cc_1.director.getScene()&&(e.layer=n.layer),n.addChild(e),i&&e.setWorldPosition(i),this.emit("add",e),this.emit("change",n,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),DEBUG_TIME_COST&&console.timeEnd("addNodeEvent"),cce.Selection.clear(),cce.Selection.select(e.uuid),DEBUG_TIME_COST&&console.timeEnd("createNodeFromAsset"),e.uuid}}catch(e){console.error(e)}}}_walkNode(e,t){e&&e.children&&e.children.forEach(e=>{t(e),this._walkNode(e,t)})}removeNode(e,t){Array.isArray(e)||(e=[e]);for(const a of e=this.canRemoveOrCopy(e)){var r=this.query(a);if(r){var n=r.parent;this.emit("before-remove",r),n&&this.emit("before-change",n),console.time("NodeMgr::removeNode"),r.setParent(null,t),r._objFlags|=cc_1.CCObject.Flags.Destroyed;try{this._walkNode(r,e=>{e._objFlags|=cc_1.CCObject.Flags.Destroyed})}catch(e){console.warn(e)}console.timeEnd("NodeMgr::removeNode"),this.emit("remove",r,{source:event_enum_1.EventSourceType.EDITOR})}}}changeNodeLock(e,t,r){for(const a of e=Array.isArray(e)?e:[e]){var n=this.query(a);if(n){this.emit("before-change",n);try{t?n.objFlags|=cc.Object.Flags.LockedInEditor:n.objFlags&=~cc.Object.Flags.LockedInEditor}catch(e){console.error(e)}this.emit("change",n),!0===r&&n.children&&0<n.children.length&&n.children.forEach(e=>{this.changeNodeLock(e.uuid,t,r)})}}}queryComponentFunctionOfNode(e){e=this.query(e);return e?(0,get_component_function_of_node_1.default)(e):{}}canRemoveOrCopy(e){var t=[];const r=[];for(const a of e){var n=this.query(a);!n||!n.parent||n.objFlags&cc.Object.Flags.DontDestroy||r.push(a)}for(const o of r)!function e(t){if(!t.parent)return!1;return!!r.includes(t.parent.uuid)||e(t.parent)}(this.query(o))&&t.push(o);return t}getNewNodeParent(e){let t;t=(t=e?this.query(e):(e=cce.Selection.query(),Array.isArray(e)&&e[0]?this.query(e[0]):cc_1.director.getScene()))||cc_1.director.getScene();var e=cce.SceneFacadeManager.queryMode();return t="prefab"===e&&(e=cce.SceneFacadeManager._facadeFSM.prefabSceneFacade._sceneProxy.getRootNode(),t===cc.director._scene)?e:t}changeNodeUUID(e,t){e&&t&&NodeMgr.changeNodeUUID(e,t)}addComponentAt(e,t,r){return!(!e||!t||r<0||t instanceof cc_1.MissingScript&&!t._$erialized||(e._addComponentAt(t,r),cce.Component.emit("add",t),0))}checkComponentsCollision(e){(0,utils_1.hasOneKindOfComponent)(e,cc_1.animation.AnimationController)&&(0,utils_1.hasOneKindOfComponent)(e,cc_1.Animation)&&console.warn(Editor.I18n.t("scene.contributions.messages.description.animationComponentCollision"))}checkDynamicBodyShape(e){if((0,utils_1.hasOneKindOfComponent)(e,cc_1.RigidBody)&&(0,utils_1.hasOneKindOfComponent)(e,cc_1.Collider)){var t=e.getComponent(cc_1.RigidBody);if(t){var r=e.getComponent(cc_1.Collider);if(t.type===cc_1.ERigidBodyType.DYNAMIC)switch(null==r?void 0:r.type){case cc_1.EColliderType.PLANE:case cc_1.EColliderType.TERRAIN:console.warn(Editor.I18n.t("scene.contributions.messages.description.physicsDynamicBodyShape"));break;case cc_1.EColliderType.MESH:r.convex||console.warn(Editor.I18n.t("scene.contributions.messages.description.physicsDynamicBodyShape"))}}}}}async function createNodeMetrics(e){if(e&&-1!==e.indexOf("@"))try{var[t,,]=e.split("@"),r=await Editor.Message.request("asset-db","query-asset-meta",t);r&&r.importer&&("fbx"===r.importer||"gltf"===r.importer)&&(r.userData&&r.userData.meshOptimizer&&r.userData.meshOptimizer.enable&&Editor.Metrics._trackEventWithTimer({category:"createNode",id:"A100010",value:1}),r.userData)&&r.userData.fbx&&r.userData.fbx.smartMaterialEnabled&&Editor.Metrics._trackEventWithTimer({category:"createNode",id:"A100011",value:1})}catch(e){console.debug(e)}}async function createLODMetrics(e){e&&e._components&&e.getComponent("cc.LODGroup")&&Editor.Metrics._trackEventWithTimer({category:"LOD",id:"A100001",value:1})}exports.NodeManager=NodeManager,exports.default=new NodeManager;