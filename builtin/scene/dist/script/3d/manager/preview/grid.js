"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Grid=void 0;const cc_1=require("cc"),utils_1=require("../camera/utils"),linear_ticks_1=__importDefault(require("../camera/grid/linear-ticks")),_lineEnd=1e6,tempV3=new cc_1.Vec3;class Grid{constructor(e,i){this._lineColor=cc.color().fromHEX("#A6A6A6"),this._hide=!1,this._gridMeshComp=utils_1.CameraUtils.createGrid("internal/editor/grid"),this._gridMeshComp.node.layer=cc_1.Layers.Enum.DEFAULT,this._gridMeshComp.node.setRotationFromEuler(new cc_1.Vec3(90,0,0)),this._gridMeshComp.node.parent=e,this.synchronizeCamera=i,this.hTicks=(new linear_ticks_1.default).initTicks([5,2],1,1e4).spacing(15,80),this.vTicks=(new linear_ticks_1.default).initTicks([5,2],1,1e4).spacing(15,80),this.synchronizeCamera.node.on("transform-changed",this.updateGrid,this)}hide(){this._hide=!0,this._gridMeshComp.node.active=!1}_updateGridData(i,t,s,e=0){var r=this.hTicks,a=this.vTicks,h=(this.synchronizeCamera.node.getWorldPosition(tempV3),tempV3),c=5e3*(h.y/500)|0,o=-c+h.x,n=c+h.x,l=-c+h.z,u=c+h.z,d=(r.range(o,n,5e3),a.range(l,u,5e3),s.clone());d.a=0;for(let e=r.minTickLevel;e<=r.maxTickLevel;++e){var _=r.tickRatios[e];if(0<_){var p=r.ticksAtLevel(e,!0);for(let e=0;e<p.length;++e){var m=p[e],g=s.clone(),f=(g.a=200*_,Math.abs(m-h.x));g.a*=1-f/c,i.push(m,h.z),i.push(m,l),i.push(m,h.z),i.push(m,u),t.push(g.x,g.y,g.z,g.w),t.push(d.x,d.y,d.z,d.w),t.push(g.x,g.y,g.z,g.w),t.push(d.x,d.y,d.z,d.w)}}}for(let e=a.minTickLevel;e<=a.maxTickLevel;++e){var v=a.tickRatios[e];if(0<v){var x=a.ticksAtLevel(e,!0);for(let e=0;e<x.length;++e){var k=x[e],C=s.clone(),z=(C.a=200*v,Math.abs(k-h.z));C.a*=1-z/c,i.push(h.x,k),i.push(o,k),i.push(h.x,k),i.push(n,k),t.push(C.x,C.y,C.z,C.w),t.push(d.x,d.y,d.z,d.w),t.push(C.x,C.y,C.z,C.w),t.push(d.x,d.y,d.z,d.w)}}}}updateGrid(){if(!this._hide){var i=[],e=[],t=[];if(this._updateGridData(i,e,this._lineColor,_lineEnd),0<i.length){for(let e=0;e<i.length;e+=2)t.push(e/2);utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_POSITION,i),utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_COLOR,e),utils_1.CameraUtils.updateIB(this._gridMeshComp,t)}}}}exports.Grid=Grid;