"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MeshPreview=void 0;const cc_1=require("cc"),misc_1=require("../../../utils/misc"),node_1=__importDefault(require("../../../utils/node")),Interactive_preview_1=require("../preview/Interactive-preview"),regions=[new cc_1.gfx.BufferTextureCopy],tempVec3A=(regions[0].texExtent.depth=1,new cc_1.Vec3),tempVec3B=new cc_1.Vec3,tempQuatA=new cc_1.Quat;function calcModelInfo(e){var t={vertices:0,polygons:0,uvs:[]};let i=0,s=0;var o=[];if(e){var r,n=e.getComponent(cc_1.MeshRenderer);if(n&&n.mesh){for(const l of n.mesh.struct.primitives){var c=n.mesh.struct.vertexBundles[l.vertexBundelIndices[0]].view.count,a=(0!==l.vertexBundelIndices.length&&(i+=c),l.indexView?l.indexView.count:c);switch(l.primitiveMode){case cc_1.gfx.PrimitiveMode.TRIANGLE_LIST:s+=a/3;break;case cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP:case cc_1.gfx.PrimitiveMode.TRIANGLE_FAN:s+=a-2}}if(n.mesh.struct.vertexBundles)for(const m of n.mesh.struct.vertexBundles)for(const u of m.attributes){var d=u.name;if(0===d.indexOf(cc_1.gfx.AttributeName.ATTR_TEX_COORD)){let e=0;d=d.charAt(cc_1.gfx.AttributeName.ATTR_TEX_COORD.length);d&&(e=Number.parseInt(d)),o.includes(e)||o.push(e)}}n.mesh.struct.minPosition&&(r=n.mesh.struct.minPosition,t.minPosition={x:r.x,y:r.y,z:r.z}),n.mesh.struct.maxPosition&&(r=n.mesh.struct.maxPosition,t.maxPosition={x:r.x,y:r.y,z:r.z})}e.children.forEach(e=>{e=calcModelInfo(e);i+=e.vertices,s+=e.polygons}),t.vertices=i,t.polygons=s,t.uvs=o}return t}class MeshPreview extends Interactive_preview_1.InteractivePreview{constructor(){super(...arguments),this._modelInfo={vertices:0,polygons:0,uvs:[]}}init(e,t){super.init(e,t)}createNodes(e){this.lightComp=new cc.Node("Mesh Preview Light").addComponent(cc_1.DirectionalLight),this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.parent=e,this._modelNode=new cc_1.Node("Mesh Preview Mesh"),this._modelNode.parent=this.scene,this._modelComp=this._modelNode.addComponent(cc_1.MeshRenderer),this._defaultMat=new cc_1.Material,this._defaultMat.initialize({effectName:"builtin-standard"}),this._modelComp.material=this._defaultMat}async setMesh(e){if(!e)return console.warn("invalid uuid"),null;if(!this._modelNode)return console.warn("invalid mode node"),null;cc_1.assetManager.assets.remove(e);e=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(e);this._modelComp.mesh=e,this._modelNode.parent=this.scene;for(let e=0;e<this._modelComp.mesh.struct.primitives.length;e++)this._modelComp.setMaterial(this._defaultMat,e);return this._modelInfo=calcModelInfo(this._modelNode),this.cameraComp.enabled=!0,this.resetCamera(),this.perfectCameraView(node_1.default.getBoundaryOfMeshNodes([this._modelNode])),this._modelInfo}resetCamera(){this._modelNode&&super.resetCamera(this._modelNode)}async getModelUVs(e){if(!e)return console.warn("invalid uuid"),null;if(!this._modelNode)return console.warn("invalid mode node"),null;this._modelComp.mesh||this.setMesh(e);var t=this._modelComp.mesh;if(!t.allowDataAccess)return[];var i,s,o,r,n=t.readIndices(0),c=[];for([i,s]of Object.entries(cc_1.gfx.AttributeName))i.includes("ATTR_TEX_COORD")&&(o=t.readAttributeFormat(0,s))&&(r=t.readAttribute(0,s),c.push({name:s,buffer:r,format:{count:o.count},index:n}));return c}getModelInfo(){return this._modelInfo}setLightEnable(e){this.lightComp.enabled!==e&&(this.lightComp.enabled=e)}}exports.MeshPreview=MeshPreview;