"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,n){void 0===n&&(n=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&("get"in r?t.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,n,r)}:function(e,t,o,n){e[n=void 0===n?o:n]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const encode_1=__importDefault(require("../../../export/dump/encode")),dumpUtil=__importStar(require("../../../export/dump/utils")),asset_1=require("../../../utils/asset"),utils_1=__importDefault(require("./utils"));class EditComponentAsset{constructor(){this.component=null}modifyProp(e,t){if(e.name=t,e.value&&"object"==typeof e.value)for(const o in e.value)"object"==typeof e.value[o]&&this.modifyProp(e.value[o],o)}encodeComponent(n){const r=n.constructor;if(!r.__props__)return null;const u={};return r.__props__.forEach(t=>{try{var e,o;t in n&&(e=cc.Class.attr(r,t),"Unknown"!==(o=encode_1.default.encodeObject(n[t],e,n,t)).type)&&(u[t]=o,this.modifyProp(u[t],t))}catch(e){console.warn(`Component property dump failed:
 Component: ${n.constructor.name}
 Property: `+t),console.warn(e)}}),u}cacheComponent(e){this.component=e}getComponent(){return this.component}async updateComponent(e){for(const t in e)e[t].visible&&await async function t(o,n,r){if(!n)return;if("object"!=typeof n)return"uuid"===r&&"_uuid"in o?void(o._uuid=n):void(o[r]=n);if(n[r].isArray){const e=cc.Class.attr(o.constructor,r);if(Array.isArray(o[r])||(o[r]=dumpUtil.ccClassAttrPropertyDefaultValue(e)),Array.isArray(o[r])){const u=o[r].length,i=n[r].value.length;if(i>u)for(let e=u;e<i;e++)if(n[r].value[e].type){const a=cc.js.getClassByName(n[r].value[e].type);a?(o[r][e]=new a,await t(o[r],n[r].value,e.toString())):o[r][e]=utils_1.default.getDefaultValue(n[r].value[e].type)}else o[r][e]=null;else if(i<u)for(;o[r].length>i;)o[r].pop();else if(u){const l=o[r].slice();o[r]=[];for(let e=0;e<u;e++)void 0!==n[r].value[e]&&(o[r][e]=l[n[r].value[e].name])}for(let e=0;e<o[r].length;e++){if(n[r].value[e].type&&n[r].value[e].type!==o[r][e].constructor.name){const s=cc.js.getClassByName(n[r].value[e].type);s&&(o[r][e]=new s)}await t(o[r],n[r].value,e.toString())}}else delete o[r]}else if(null===n[r].value||"object"!=typeof n[r].value)o[r]=n[r].value;else{const c=Object.keys(n[r].value);for(const p of c)"uuid"===p?n[r].value[p]?o[r]&&(void 0===o[r]._uuid||o[r]._uuid===n[r].value[p])||(o[r]=await(0,asset_1.loadAssetUncached)(n[r].value.uuid)):o[r]=null:await t(o[r],n[r].value,p)}}(this.component,e,t);return this.encodeComponent(this.component)}}exports.default=EditComponentAsset;