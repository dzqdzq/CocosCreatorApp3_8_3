"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var s=Object.getOwnPropertyDescriptor(t,a);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,s)}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),material_1=require("cc/editor/material"),dumpUtil=__importStar(require("../../../export/dump/utils")),dumpDecode=__importStar(require("../../../export/dump/decode")),dumpEncode=__importStar(require("../../../export/dump/encode")),misc_1=require("../../../utils/misc"),utils_1=__importDefault(require("./utils")),message_1=require("../message");function getObjectKeys(e){if(!e)return[];if(e.constructor.__isJSB){var t=[];for(const a in e)t.push(a);return t}return Object.keys(e)}function tryGetEffectTooltip(e,t){return"string"==typeof t&&""!==t?t:(t="ENGINE.assets.effect.propertyTips."+e,""!==Editor.I18n.t(t)?"i18n:"+t:void 0)}function deepCopyProperty(e,t,a,r){if(e){const n=e[a],o=t[a];if(void 0!==o)if(Array.isArray(n)){if(Array.isArray(o)){var s=o.length,i=n.length;if(r&&i<s)for(let e=0;e<s-i;e++)n.push(new r);for(let e=0;e<o.length;e++)deepCopyProperty(n,o,e,r)}}else if(cc_1.CCClass._isCCClass(n.constructor)){const c=n.constructor;c.__props__.map(e=>{var t;void 0!==n[e]&&void 0!==o[e]&&(t=cc_1.CCClass.attr(c,e),t=dumpUtil.getConstructor(o[e],t),deepCopyProperty(n,o,e,t))})}else e[a]=t[a]}}function changePassStateToCCClass(a){const r=new material_1.PassStatesEditor,s=(r.blendState.init(a.blendState),r.constructor);return s.__props__.map(e=>{var t;void 0!==r[e]&&void 0!==a[e]&&(t=cc_1.CCClass.attr(s,e),t=dumpUtil.getConstructor(a[e],t),deepCopyProperty(r,a,e,t))}),r}function getPassDefaultValue(e){let t=null;var a=cc_1.js.getClassByName(e);if(a)t=new a;else switch(e){case"Boolean":t=!1;break;case"Number":case"Float":case"Integer":case"Enum":t=0;break;case"String":t=""}return t}function patchNameToDump(e,t){if(e){e.name=t;const a=e.value;if(Array.isArray(a))for(let e=0;e<a.length;e++)patchNameToDump(a[e],""+e);else"object"==typeof a&&(e.isObject=!0,Object.keys(a).forEach(e=>{patchNameToDump(a[e],e)}))}}function patchDumpData(e,t){if(e){e.name=t;const r=e.value;if(Array.isArray(r)){var a=getPassDefaultValue(e.type);e.elementTypeData=dumpEncode.encodeObject(a,{type:e.type,enumList:e.enumList}),patchNameToDump(e.elementTypeData,t);for(let e=0;e<r.length;e++)patchDumpData(r[e],""+e)}else"object"!=typeof r||e.extends.includes("cc.ValueType")?e.default=r:(e.isObject=!0,Object.keys(r).forEach(e=>{patchDumpData(r[e],e)}));e.isMat=!0}}const getPropData=(t,e)=>{var a={},r=e.blocks.find(e=>void 0!==e.members.find(e=>e.name===t)),r=(r&&(a.defines=r.defines,r=r.members.find(e=>e.name===t))&&(a.count=r.count),e.samplerTextures.find(e=>e.name===t));return r&&(a.defines=r.defines,a.count=r.count),a},_previewLocker={},attributeProps=["visible","displayName","min","max","step","slide","tooltip","range"];function checkInspectorAttr(a){const r={};return attributeProps.forEach(e=>{var t;a&&void 0!==a[e]&&("range"===e?2<=(t=a[e]).length&&(r.min=t[0],r.max=t[1],2<t.length)&&(r.step=t[2]):r[e]=a[e])}),r}class MaterialAsset{async queryAllEffects(){let t=[];try{t=await Editor.Message.request("asset-db","query-assets",{ccType:"cc.EffectAsset"})}catch(e){console.error(e)}if(!t||!Array.isArray(t)||t.length<1)return{};var a={};for(let e=0;e<t.length;e++){var r=t[e],s=cc_1.EffectAsset.get(r.uuid);s?a[r.uuid]={uuid:r.uuid,name:s.name,hideInEditor:s.hideInEditor,assetPath:r.path}:console.warn(`EffectAsset ${r.name} ${r.uuid} not found`)}return a}queryEffect(e){e=cc_1.EffectAsset.get(e);return e?this.encodeEffect(e):[]}encodeEffect(s){return s.techniques.map(e=>{var t=e.passes.map((t,e)=>{const l=[],i=[],u=s.shaders.find(e=>e.name===t.program);u.defines.forEach(t=>{if(!t.name.startsWith("CC_")){var a=utils_1.default.GFXToValueTypeMap[t.type]||t.type;let e;switch(a){case"Number":e=t.range[0];break;case"String":e=t.options[0];break;default:e=!1}var r=dumpEncode.encodeObject(e,{default:e}),s=tryGetEffectTooltip(t.name,null==(s=t.editor)?void 0:s.tooltip);Object.assign(r,{name:t.name,defines:t.defines,type:a,options:t.options,range:t.range,default:r.value,tooltip:s}),i.push(r)}}),t.properties&&getObjectKeys(t.properties).forEach(s=>{var i=t.properties[s];if(!i.editor||!i.editor.deprecated){var n=i.handleInfo&&i.handleInfo[0]||s;let e=i.editor&&i.editor.parent;e&&!Array.isArray(e)&&(e=[e]);var o=getPropData(n,u);let t=utils_1.default.GFXToValueTypeMap[i.type]||i.type,a=(i.editor&&"color"===i.editor.type&&(t="cc.Color"),utils_1.default.getDefaultValue(t,i.value));if(o.count&&1<o.count){var c=[];for(let e=0;e<o.count;e++)c.push(a);a=c}let r={};i&&i.editor&&(r=checkInspectorAttr(i.editor));n=tryGetEffectTooltip(s,null==(n=i.editor)?void 0:n.tooltip),n=dumpEncode.encodeObject(a,Object.assign({default:a,displayName:i.editor&&i.editor.displayName,visible:i.editor&&i.editor.visible,tooltip:n,range:i.editor&&i.editor.range,type:t},r));Array.isArray(n.value)&&n.value.forEach(e=>{e.default=e.value}),Object.assign(n,{name:s,defines:e||o.defines,default:n.value}),l.push(n)}});var a=changePassStateToCCClass(t),a=dumpEncode.encodeObject(a,{}),r=(patchDumpData(a,"pipelineStates"),void 0!==t.propertyIndex&&t.propertyIndex!==e);return{switch:{name:t.switch,value:!1},propertyIndex:{value:void 0===t.propertyIndex?e:t.propertyIndex},props:r?[]:l,defines:r?[]:i,states:a,phase:t.phase}});return{name:e.name,passes:t}})}async decodeMaterial(e){var t=new cc_1.Material,e=(t._effectAsset=cc_1.EffectAsset.get(e.effect),t._props=[],t._defines=[],t._techIdx=e.technique,e.data[e.technique]);const n=[];function o(e){return e.default!==e.value&&JSON.stringify(e.default)!==JSON.stringify(e.value)}function c(a,r){if(a.isObject)r[a.name]={},Object.keys(a.value).forEach(e=>{c(a.value[e],r[a.name])});else if(a.isArray)if(cc_1.js.getClassByName(a.type)||"Object"===a.type||"Array"===a.type){r[a.name]=[];for(let e=0;e<a.value.length;e++)c(a.value[e],r[a.name])}else{r[a.name]=void 0;let t=!1;for(let e=0;e<a.value.length;e++)if(o(a.value[e])){t=!0;break}t&&(e=a.name,s=a,i=r,n.push(dumpDecode.decodePatch(""+e,s,i)))}else{if(!o(a))return;r[a.name]=void 0,e=a.name,s=a,i=r,n.push(dumpDecode.decodePatch(""+e,s,i))}var e,s,i}var a=e&&e.passes||[],r=[],s=[],i=[];for(let t=0;t<a.length;t++){var l=a[t];r[t]={},s[t]={},i[t]={},l.switch&&l.switch.name&&l.switch.value&&(s[t][l.switch.name]=l.switch.value);for(let e=0;e<l.defines.length;e++)c(l.defines[e],s[t]);for(let e=0;e<l.props.length;e++)c(l.props[e],r[t]);var u=Object.values(l.states.value);for(let e=0;e<u.length;e++)c(u[e],i[t])}if(await Promise.all(n),t._props=r,t._defines=s,t._states=i,t._effectAsset&&t._effectAsset.techniques){var p=t._effectAsset.techniques[t._techIdx];if(p)for(let e=p.passes.length-1;0<=e;e--){var d=p.passes[e];void 0!==d.propertyIndex&&d.propertyIndex!==e&&(t._props[e]={},t._defines[e]={})}}return cce.Utils.serialize(t)}async queryMaterial(e){let s=void 0;try{s=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(e)}catch(e){console.error(e)}return s?(e=cc_1.EffectAsset.get(s.effectName))?((e=this.encodeEffect(e))[s._techIdx].passes.forEach((a,r)=>{getObjectKeys(s._defines[r]||{}).forEach(t=>{var e=a.defines.find(e=>e.name===t);e?n(e,s._defines[r][t]):a.switch.name===t&&(a.switch.value=s._defines[r][t])}),getObjectKeys(s._props[r]||{}).forEach(t=>{var e=a.props.find(e=>e.name===t);e&&n(e,s._props[r][t])}),getObjectKeys(s._states[r]||{}).forEach(t=>{var e=Object.values(a.states.value).find(e=>e.name===t);e&&n(e,s._states[r][t])})}),{effect:s.effectName,technique:s._techIdx,data:e}):{effect:"",technique:0,data:[]}:null;function n(t,a){if(void 0!==t)if(t.isObject){const i=a;getObjectKeys(i).forEach(e=>{n(t.value[e],i[e])})}else if(t.isArray){if(a.length>t.value.length){var r=a.length-t.value.length;for(let e=0;e<r;e++){var s=JSON.parse(JSON.stringify(t.elementTypeData));s.name=""+t.value.length,s.displayName=""+t.value.length,t.value.push(s)}}for(let e=0;e<a.length;e++)n(t.value[e],a[e])}else{var e=dumpEncode.encodeObject(a,{});"Unknown"!==e.type&&(t.value=e.value)}}}async previewMaterial(e,t,a){if(void 0!==_previewLocker[e])_previewLocker[e]={uuid:e,data:t};else{var r,s,i;if(await Editor.Message.request("asset-db","query-asset-info",e)){_previewLocker[e]=null;try{t?(r=await this.decodeMaterial(t),(s=await(0,misc_1.promisify)(cc_1.assetManager.loadWithJson.bind(cc_1.assetManager))(r))._uuid=e,cce.Preview.materialPreview.setMaterial(s),a&&!1===a.emit||cc_1.assetManager.assetListener.emit(e,s)):(i=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(e),cce.Preview.materialPreview.setMaterial(i),a&&!1===a.emit||cc_1.assetManager.assetListener.emit(e,i))}catch(e){console.error(e)}t=_previewLocker[e];t&&process.nextTick((e,t,a)=>{this.previewMaterial(e,t,a)},t.uuid,t.data,a),cce.Engine.repaintInEditMode(),await(0,misc_1.sleep)(0),message_1.messageManager.broadcast("scene:material-preview-dirty")}delete _previewLocker[e]}}}exports.default=new MaterialAsset;