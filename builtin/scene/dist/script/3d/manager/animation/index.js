"use strict";var PlayState,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnimationManager=void 0;const event_enum_1=require("../../../public/event-enum"),cc_1=require("cc"),events_1=require("events"),node_1=__importDefault(require("../node")),scene_1=__importDefault(require("../scene")),selection_1=__importDefault(require("../../../public/selection")),utils_1=require("./utils"),editor_animation_clip_1=__importDefault(require("./editor-animation-clip")),node_2=__importDefault(require("../../../utils/node")),message_1=require("../message"),embedded_player_1=require("cc/editor/embedded-player"),new_gen_anim_1=require("cc/editor/new-gen-anim"),AnimEditState=(!function(e){e[e.STOP=0]="STOP",e[e.PLAYING=1]="PLAYING",e[e.PAUSE=2]="PAUSE"}(PlayState=PlayState||{}),{record:!1,dirty:!1,playState:PlayState.STOP}),skelAnimAllowOperations=["addEvent","deleteEvent","updateEvent","moveEvents","copyEventsTo","changeSpeed","changeWrapMode","changeSample","copyEvent","addEmbeddedPlayer","updateEmbeddedPlayer","deleteEmbeddedPlayer","clearEmbeddedPlayer","addEmbeddedPlayerGroup","removeEmbeddedPlayerGroup","clearEmbeddedPlayerGroup","addAuxiliaryCurve","removeAuxiliaryCurve","renameAuxiliaryCurve","createAuxKey","removeAuxKey","copyAuxKey","moveAuxKeys","modifyAuxCurveOfKey"],keysOperations=["createKey","moveKeys","removeKey","updateKey","copyKeysTo","spacingKeys","clearKeys","copyPropTo","changeWrapMode"];class EditorAnimationEventTarget extends cc_1.EventTarget{isValid(){return!0}}const animationComponentName=cc_1.js.getClassName(cc_1.AnimationComponent);class AnimationManager extends events_1.EventEmitter{get curEditClipUuid(){return this._curEditClipUuid}set curEditTime(e){this._curEditTime!==e&&(this._curEditTime=e,message_1.messageManager.broadcast("scene:animation-time-change",e),this.emit("scene:animation-time-change",e))}get curEditRootNodeUuid(){return this._curEditRootNodeUuid}set curEditRootNodeUuid(e){this._curEditRootNodeUuid=e}set curDefaultClip(e){this._curDefaultClip=e}constructor(){super(),this._lastSaveClipDump=null,this._curEditRootNodeUuid="",this._curEditClipUuid="",this._curEditAnimClip=null,this._curEditTime=0,this._animUpdateInterval=null,this._isDirty=!1,this._componentDirty=!1,this._isInEdit=!1,this._curDefaultClip=null,this._animationStateMap=new Map,this._eventTarget=new EditorAnimationEventTarget,this.isNewClip=!0,this.init(),node_1.default.on("gizmo-control-end",this.onNodeChanged.bind(this))}init(){this._curEditRootNodeUuid="",this._curEditClipUuid="",this._curEditTime=0}setCurDefaultClipByUuid(e){e?cc_1.assetManager.loadAny(e,(e,i)=>{e?console.error(e):this._curDefaultClip=i}):this._curDefaultClip=null}async record(e,i,t){if(i)return!!e&&!!(t=t||this._curEditRootNodeUuid||(null==(i=this.queryNodeAnimationData(e).defaultClip)?void 0:i._uuid))&&(this._isInEdit=!0,AnimEditState.record=!0,this._curEditRootNodeUuid=e,t&&this._curEditClipUuid!==t&&await this.setEditClip(t),await this.registerAndFireEvents(e,this._curEditClipUuid),this.emit("scene:animation-clip-change",e,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-clip-change",this._curEditClipUuid),this._animUpdateInterval||(this._animUpdateInterval=setInterval(this.update.bind(this),100)),this.storeData(),this.setCurEditTime(0),this.emit("scene:animation-record-start"),!0);if(!this._isInEdit)return!1;try{this.stop()}catch(e){console.error(e)}this.changePlayState(PlayState.STOP);i=this.queryRecordAnimState();if(i)try{this._unregisterAnimStateEVents(i),null!=i&&i.destroy()}catch(e){console.error(e)}return this._curEditRootNodeUuid="",AnimEditState.record=!1,this._isInEdit=!1,this._curDefaultClip=null,this._animUpdateInterval&&(clearInterval(this._animUpdateInterval),this._animUpdateInterval=null),this.clearAnimationState(),cce.Engine.exitState(cce.NeedAnimState.ANIMATION_MODE),this.emit("scene:animation-record-end"),!0}storeData(){}restoreData(){}_registerAnimStateEvents(e){e&&(e.on("finished",this._onAnimPlayEnd,this),e.on("play",this._onAnimPlay,this),e.on("pause",this._onAnimPause,this),e.on("resume",this._onAnimResume,this),e.on("stop",this._onAnimStopped,this))}_unregisterAnimStateEVents(e){e&&(e.off("finished",this._onAnimPlayEnd,this),e.off("play",this._onAnimPlay,this),e.off("pause",this._onAnimPause,this),e.off("resume",this._onAnimResume,this),e.off("stop",this._onAnimStopped,this))}isComponentDirty(){return this._componentDirty}setComponentDirty(e){this._componentDirty=e}isDirty(){return this._isDirty}async saveCheck(e){if(e=e||this.queryRecordAnimState()){var i=e=>{Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"AnimatorSave",value:{save_result:"save_result_"+e}})};if(this.isDirty())switch(await cce.Ipc.send("dirty-dialog",e.clip.name+".anim")){case 0:case"0":await this.save(),i(1);break;case 1:case"1":await this.restoreFromDump(this._curEditRootNodeUuid,this._curEditClipUuid,this._lastSaveClipDump),i(2);break;case 2:case"2":return!1}}return!0}registerAndFireEvents(e,i){var t=this.queryNodeAnimationData(e),a=null==(a=t.clips)?void 0:a.find(e=>(null==e?void 0:e._uuid)===i);return!!a&&!(!(a=this.queryAnimState(a))||(this._curDefaultClip=t.defaultClip,utils_1.utils.initAninState(a,t.node),this._registerAnimStateEvents(a),this._isDirty=!1,this._lastSaveClipDump=this.dumpClip(e,i),this._curEditAnimClip=new editor_animation_clip_1.default(t.node,i,a),this.curEditTime=0))}async changeAnimNode(e,i){var t;return!(!e||!i||!this._isInEdit||!(t=this.queryRecordAnimState())||!await this.saveCheck(t)||(this.stop(),this._unregisterAnimStateEVents(t),!scene_1.default.modes.animation.open(e))||(await this.setEditClip(i),0))}async enter(e,i){var t;this.isNewClip=!1,this._curEditAnimClip?(t=await this._curEditAnimClip.getDumpData(),this.isNewClip=0===(null==t?void 0:t.curves.length)&&!this.isSkeletonClip(i)):(t=await Editor.Message.request("asset-db","query-asset-info",i),this.isNewClip=Boolean(t)),Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"hippoAnimator",value:{project_id:Editor.Project.uuid,clip_id:i,version:Editor.App.version}})}async save(){var e=await this.saveClip(this._curEditClipUuid);return await this.trackUserData(),e}async saveClip(e){var i,t,a=this.queryRecordAnimState();return!!a&&(a=a.clip,i=cce.Utils.serialize(a),this._lastSaveClipDump=this.dumpClip(this._curEditRootNodeUuid,e),this.isSkeletonClip(e)?(e=await cce.Ipc.send("query-asset-meta",a._uuid))&&e.userData&&((t=utils_1.utils.queryEvents(a))?e.userData.events=t.map(e=>({frame:e.frame,func:e.func,params:e.params})):console.error("Event data error"),e.userData.embeddedPlayers=Array.from(a[embedded_player_1.getEmbeddedPlayersTag]()).map(e=>({begin:e.begin,end:e.end,reconciledSpeed:e.reconciledSpeed,editorExtras:{group:e[cc_1.editorExtrasTag]&&e[cc_1.editorExtrasTag].group,displayName:e[cc_1.editorExtrasTag]&&e[cc_1.editorExtrasTag].displayName},playable:utils_1.utils.getPlayableInfo(e.playable)})),e.userData.editorExtras={embeddedPlayerGroups:a[cc_1.editorExtrasTag].embeddedPlayerGroups},e.userData.wrapMode=a.wrapMode,e.userData.speed=a.speed,e.userData.sample=a.sample,e.userData.auxiliaryCurves=(0,utils_1.getSerializedAuxCurves)(a),await cce.Ipc.send("save-asset-meta",a._uuid,JSON.stringify(e))):(t=await cce.Ipc.send("query-asset-info",a._uuid))?await cce.Ipc.send("save-asset",t.url,i):(e="db://assets/"+a.name+".anim",await cce.Ipc.send("create-asset",e,i)),this._isDirty=!1,this.emit("scene:animation-save",this.curEditRootNodeUuid,a._uuid),!0)}async trackUserData(){var e=new Set,i=new Set;let t=0;var a;const n=new Set,s=new Set;let r=0;const o=new Set;var u={project_id:Editor.Project.uuid,version:Editor.App.version,is_new:"is_new_"+(this.isNewClip?1:2),clip_id:this._curEditClipUuid,is_skeleton:"is_skeleton_"+(this.isSkeletonClip(this._curEditClipUuid)?1:2)};if(this._curEditAnimClip){var d=await this._curEditAnimClip.getDumpData();if(d){a=d.duration*d.sample|0;for(const c in d.auxiliaryCurves){var l=d.auxiliaryCurves[c];e.add(c),l.keyframes&&l.keyframes.forEach(e=>{s.add(e.frame)})}for(let e=0;e<d.curves.length;e++){const m=d.curves[e];m.parentPropKey||(i.add(m.nodePath),t++,m.keyframes&&m.keyframes.forEach(e=>{n.add(e.frame),"position"===m.key&&o.add(e.frame)}),"position"===m.key&&r++)}u.auxiliary_curve_no=e.size,u.auxiliary_curve_frame_no=s.size,u.node_no=i.size,u.property_no=t,u.frame_no=a,u.key_frame_no=n.size,u.position_no=r,u.position_frame_no=o.size}}Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"AnimatorSave",value:u})}isSkeletonClip(e){return!!e&&0<=e.indexOf("@")}needLock(e,i){e=this.queryNodeAnimationData(e).animComp;return!!(e&&e instanceof cc_1.SkeletalAnimation)||this.isSkeletonClip(i)}getEditAnimationInfo(){return{rootid:this._curEditRootNodeUuid,clipid:this._curEditClipUuid}}getSerializedEditClip(){var e;return this._isInEdit&&this._curEditClipUuid&&(e=this.queryRecordAnimState())&&e.clip?(e=e.clip,cce.Utils.serialize(e)):null}queryAnimationNodeEditInfo(e){var i,t,a={state:"failure",result:null};return node_1.default.query(e)?(i=(this._isInEdit?this._curEditRootNodeUuid:null)||this.queryAnimationRoot(e),t=(a.state="success",a.result={root:i},this.queryNodeAnimationData(i)),a.result.node=cce.Scene.queryNodeTree(i),Object.assign(a.result,{aniComp:t.animComp&&cc.js.getClassName(t.animComp)||"",clipsMenu:t.clips&&utils_1.utils.decodeClipsMenu(t.clips)||[],defaultClip:null==(t=t.defaultClip)?void 0:t._uuid,root:i})):a.reason=`Animation node(${e}) doesn't exist`,a}queryRecordAniClips(){return this.queryRecordAniData().clips}queryRecordAniData(){return this.queryNodeAnimationData(this._curEditRootNodeUuid)}queryRecordAnimState(e,i){e=e||this._curEditClipUuid,i=i||this._curEditRootNodeUuid;e=this.queryAnimationClip(e,i);return e&&this.queryAnimState(e)}queryRecordAnimData(){return this.queryNodeAnimationData(this._curEditRootNodeUuid)}queryAnimationClip(i,e){var e=this.queryNodeAnimationData(e);return e&&(null==(e=e.clips)?void 0:e.find(e=>(null==e?void 0:e._uuid)===i))}queryNodeAnimationData(e){var t={defaultClip:null};if(e){let i=null;if(i="string"==typeof e?node_1.default.query(e):e){t.node=i;let e=[];var a=this.queryAnimComp(i);a&&(a instanceof cc_1.animation.AnimationController?(e=(0,utils_1.uniqAnimationClips)([...(0,new_gen_anim_1.visitAnimationClipsInController)(a)]),t.animComp=a):(e=(0,utils_1.uniqAnimationClips)(a.clips),t.animComp=a,t.defaultClip=a.defaultClip),t.clips=e.filter(e=>!(null==e||!e.name)),t.defaultClip=t.defaultClip||e[0],null!=(a=t.defaultClip)&&a.name||(t.defaultClip=null))}else console.debug(`Node(${e}) doesn't exist`)}else console.debug(`Node(${e}) doesn't exist`);return t}queryAnimComp(e){var i=e.getComponent(cc_1.animation.AnimationController);return i||e.getComponent(cc_1.Animation)}queryAnimState(e,i=!1){if(!e.name)return null;let t=null;return this._animationStateMap.has(e._uuid)?t=this._animationStateMap.get(e._uuid):!1===i&&((t=new cc_1.AnimationState(e))._setEventTarget(this._eventTarget),this._animationStateMap.set(e._uuid,t)),t}queryAnimClipsInfo(e,i){return(i=i||this.queryNodeAnimationData(e)).clips?{clipsMenu:utils_1.utils.decodeClipsMenu(i.clips),defaultClip:null==(e=i.defaultClip)?void 0:e._uuid}:null}queryPlayState(){return AnimEditState.playState}async setEditClip(e){if(!e)return console.log("Clip uuid is empty"),!1;if(e!==this._curEditClipUuid){if(this._isInEdit){var i=this.queryRecordAnimState();if(i){if(!await this.saveCheck(i))return!1;this._unregisterAnimStateEVents(i)}if(!this.queryRecordAnimState(e))return!1;this.stop(),this._curEditClipUuid=e,await this.registerAndFireEvents(this._curEditRootNodeUuid,e),cce.Engine.repaintInEditMode()}else this._curEditClipUuid=e;this.emit("scene:animation-clip-change",this._curEditRootNodeUuid,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-clip-change",this._curEditClipUuid)}return!0}setCurEditTime(e){if(this._curEditTime=e,!this._isInEdit)return!1;var i=this.queryRecordAnimState();if(!i)return!1;let t=e;t>i.duration&&(t=i.duration),i.weight=1,i.setTime(t),i.isPaused||i.pause();try{i.sample()}catch(e){console.error(e)}return cce.Engine.repaintInEditMode(),message_1.messageManager.broadcast("scene:animation-time-change",t),this.emit("scene:animation-time-change",t),!0}changePlayState(e){switch(AnimEditState.playState=e){case PlayState.PLAYING:cce.Engine.enterState(cce.NeedAnimState.ANIMATION_MODE);break;case PlayState.PAUSE:case PlayState.STOP:cce.Engine.exitState(cce.NeedAnimState.ANIMATION_MODE)}message_1.messageManager.broadcast("scene:animation-state-change",AnimEditState.playState)}play(e){e=this._animationStateMap.get(e);return!!e&&(e.weight=1,e.isPlaying&&e.isPaused?e.resume():e.play(),cce.Engine.repaintInEditMode(),this.emit("scene:animation-state-change",cc_1.Animation.EventType.PLAY),!0)}pause(){var e=this._animationStateMap.get(this._curEditClipUuid);return!!e&&(e.pause(),this.emit("scene:animation-state-change",cc_1.Animation.EventType.PAUSE),this._curEditTime=this.queryPlayingClipTime(),cce.Engine.repaintInEditMode(),!0)}resume(){var e=this._animationStateMap.get(this._curEditClipUuid);return!!e&&(e.isPlaying||(e.weight=1,e.play()),e.resume(),this.emit("scene:animation-state-change",cc_1.Animation.EventType.RESUME),cce.Engine.repaintInEditMode(),!0)}stop(){var e=this._animationStateMap.get(this._curEditClipUuid);if(!e)return!1;e.setTime(0),this._curEditTime=0,e.isPaused||e.pause();try{e.sample()}catch(e){console.error(e)}return e.stop(),this.emit("scene:animation-state-change",cc_1.Animation.EventType.STOP),cce.Engine.repaintInEditMode(),this.changePlayState(PlayState.STOP),!0}async queryAnimationClipDump(e,i){DEBUG_TIME_COST&&console.time("queryClipDumpCost");var t=this.queryRecordAnimState(i,e);if(!t)return!1;var a=this.queryNodeAnimationData(e);let n=this._curEditAnimClip;this._curEditAnimClip&&this._curEditAnimClip.rootNode===a.node&&this._curEditClipUuid===i||(n=new editor_animation_clip_1.default(a.node,i,t)),Editor.Metrics.trackTimeStart("scene:query-animation-clip-dump");a=await n.getDumpData();return Editor.Metrics.trackTimeEnd("scene:query-animation-clip-dump",{output:!0,label:"scene:query-animation-clip-dump "+i}),this.needLock(e,i)&&a&&(a.isLock=!0),DEBUG_TIME_COST&&console.timeEnd("queryClipDumpCost"),"2d"===cce.SceneFacadeManager._projectType&&a&&(a.curves=a.curves.filter(e=>("position"!==e.key&&"scale"!==e.key||(e.partKeys=e.partKeys.filter(e=>!e.includes(".z"))),"eulerAngles"===e.key&&(e.partKeys=e.partKeys.filter(e=>e.includes(".z"))),!["position.z","eulerAngles.x","eulerAngles.y","scale.z"].includes(e.key)))),a}dumpClip(e,i){i=this.queryAnimationClip(i,e);return i&&(e=this.queryAnimState(i))?cce.Utils.serialize(e.clip):null}restoreFromDump(n,s,e){const r=this.queryNodeAnimationData(n);var i=null==(i=r.clips)?void 0:i.find(e=>(null==e?void 0:e._uuid)===s);if(!i)return!1;const o=this.queryAnimState(i);if(!o)return!1;utils_1.utils.initAninState(o,r.node);const u=o.clip;return new Promise((t,a)=>{utils_1.utils.loadJsonWithUuid(s,e,async(e,i)=>{e?a(e):i&&(utils_1.utils.copyClip(u,i),this._curEditAnimClip=new editor_animation_clip_1.default(r.node,s,o),await this._curEditAnimClip.updateCurveData(),this._isDirty=!0,this.setCurEditTime(this._curEditTime),this.emit("scene:animation-change",n,s,"undo"),message_1.messageManager.broadcast("scene:animation-change",n,s),t(!0))})})}queryAnimationRoot(e){let i=node_1.default.query(e);if(i)do{if(this.queryAnimComp(i))return i.uuid}while(i=i.parent);return e}async queryAnimationRootInfo(e){var i=cce.Scene.queryNodeTree(e),t=this.queryNodeAnimationData(e),a=this.queryAnimClipsInfo(e,t);if(!a||a.clipsMenu&&0===a.clipsMenu.length)return{root:e,nodeTreeDump:i};var n=a.defaultClip;let s=!1;return t.animComp instanceof cc_1.SkeletalAnimation&&(s=t.animComp.useBakedAnimation),{root:e,nodeTreeDump:i,clipsMenu:a.clipsMenu,defaultClip:n,clipDump:n?await this.queryAnimationClipDump(e,n):null,time:this.queryPlayingClipTime(n),state:this.queryPlayState(),useBakedAnimation:s}}queryProperties(e){var i=node_1.default.query(e);if(!i)return console.debug(`Animation node(${e})doesn't exist`),[];let t=i;for(;t&&!t.getComponent(cc_1.Animation);){if(t.parent instanceof cc_1.Scene){t=i;break}t=t.parent}e=utils_1.utils.getAnimableProperties(i,t!==i);let a=e?e:[];return a}queryPlayingClipTime(e){if(!this._isInEdit)return 0;e=e||this._curEditClipUuid;e=this._animationStateMap.get(e);return e?e.current:0}async getPropValueAtFrame(e,i,t,a){return this._animationStateMap.get(e)?e!==this._curEditClipUuid?(console.warn(`current edit clip: '${this._curEditClipUuid}' but you want to operate: '`+e),null):this._curEditAnimClip?this._curEditAnimClip.getPropValueAtFrame(i,t,a):null:null}async getAuxCurveValueAtFrame(e,i,t){return this._animationStateMap.get(e)?e!==this._curEditClipUuid?(console.warn(`current edit clip: '${this._curEditClipUuid}' but you want to operate: '`+e),null):this._curEditAnimClip?this._curEditAnimClip.getAuxCurveValueAtFrame(i,t):null:null}async getAllPropValueAtFrame(i,t,e,a){const n={};return await Promise.all(e.map(async e=>{n[e]=await this.getPropValueAtFrame(i,t,e,a)})),n}async operation(i,e){var t={state:"success",result:!0};let a=!1;e=null==(e=null==e?void 0:e.recordUndo)||e;let n;e&&(n=await cce.SceneFacadeManager.beginRecording(this._curEditRootNodeUuid,{external:{animation:!0}}));for(let e=0;e<i.length;e++){var s=i[e],r=s.funcName,s=s.args;if(this.needLock(this._curEditRootNodeUuid,this._curEditClipUuid)&&!skelAnimAllowOperations.includes(r)){t.reason=`Method '${r}' does not allowed in skeleton animation.`,t.state="failure",console.log(t.reason);break}var o=s[0];if(o!==this._curEditClipUuid){t.state="failure",t.reason=`current edit clip: '${this._curEditClipUuid}' but you want to operate: '`+o,console.log(t.reason);break}if(!this._curEditAnimClip[r]){t.state="failure",t.reason=`Method '${r}' does not exist to manipulate the animation.`,console.log(t.reason);break}s.splice(0,1);try{if(!await this._curEditAnimClip[r](...s)){t.state="failure",t.reason=`call method ${r} failed`,console.log(t.reason);break}keysOperations.includes(r)&&(a=!0)}catch(e){console.error(e),t.state="failure",t.reason=`call method ${r} failed`;break}}return"success"===t.state?(a&&this.setCurEditTime(this._curEditTime),this._isDirty=!0,cce.Engine.repaintInEditMode(),this.emit("scene:animation-change",this._curEditRootNodeUuid,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-change",this._curEditRootNodeUuid,this._curEditClipUuid)):t.result=!1,e&&"string"==typeof n&&(t.result?cce.SceneFacadeManager.endRecording(n):cce.SceneFacadeManager.cancelRecording(n)),t}async onNodeChanged(t,a={}){if(AnimEditState.record&&(null==a?void 0:a.source)!==event_enum_1.EventSourceType.ENGINE){a=a.propPath;if(t&&a&&"string"==typeof a){var n=node_1.default.query(this._curEditRootNodeUuid);if(n){var s=this.queryRecordAnimState();if(s){if(this._curEditAnimClip){n=utils_1.utils.getNodePathFromAnimRoot(n,t);if(n){var r=[],o=utils_1.utils.generateHierarchyPath(n),o=(o&&r.push(o),node_2.default.getNameDataByPropPath(t,a));o.compName===animationComponentName&&this.setComponentDirty(!0);let e=o.propName;var t=o.compName,a=o.propName,o=(t&&(r.push(new cc_1.animation.ComponentPath(t)),e=t+"."+e),s.clip);let i=null;"rotation"===a?(i=this._curEditAnimClip.getCreatedCurve(n,"eulerAngles"))?e="eulerAngles":(e=a,i=this._curEditAnimClip.getCreatedCurve(n,e)):i=this._curEditAnimClip.getCreatedCurve(n,e),i&&(r=o.sample,t=Math.round(this._curEditTime*r),i.hasKey(t)?await this.operation([{funcName:"updateKey",args:[this._curEditClipUuid,n,e,[t]]}]):await this.operation([{funcName:"createKey",args:[this._curEditClipUuid,n,e,t,null]}]))}}}else console.log(`AnimationState of '(${this._curEditClipUuid})' clip doesn't exist`)}}}}_onAnimPlay(){this.changePlayState(PlayState.PLAYING)}_onAnimPause(){this.changePlayState(PlayState.PAUSE)}_onAnimResume(){this.changePlayState(PlayState.PLAYING)}_onAnimStopped(){this.changePlayState(PlayState.STOP),message_1.messageManager.broadcast("scene:animation-time-change",0)}_onAnimPlayEnd(){this.changePlayState(PlayState.STOP),this._curEditTime=this.queryPlayingClipTime(),message_1.messageManager.broadcast("scene:animation-time-change",this._curEditTime),this.emit("scene:animation-time-change",this._curEditTime)}update(){AnimEditState.playState===PlayState.PLAYING&&(this._curEditTime=this.queryPlayingClipTime(),message_1.messageManager.broadcast("scene:animation-time-change",this._curEditTime))}onAssetDeleted(t){if(t){var a=this.queryRecordAniClips();if(a){let i=!1;for(let e=0;e<a.length;e++)a[e]&&a[e]._uuid===t&&(i=!0);i&&this._isInEdit&&(this._isDirty=!1,cce.SceneFacadeManager.closeScene())}}}onAssetRefreshed(i){if(i){var t=this.queryRecordAnimData(),a=null==(a=t.clips)?void 0:a.find(e=>(null==e?void 0:e._uuid)===i);if(a&&(t.animComp instanceof cc_1.Animation&&t.clips&&0<t.clips.length&&a&&t.animComp instanceof cc_1.Animation&&(t.animComp.defaultClip=this._curDefaultClip,message_1.messageManager.broadcast("scene:change-node",this._curEditRootNodeUuid)),i===this._curEditClipUuid)){let e=this._curEditRootNodeUuid;e||0<(n=selection_1.default.query()).length&&(e=n[0]),this.removeAnimationState(this._curEditClipUuid);var n=this.queryAnimState(a);n&&(utils_1.utils.initAninState(n,t.node),this._curEditAnimClip=new editor_animation_clip_1.default(t.node,this._curEditClipUuid,n)),this.emit("scene:animation-change",e,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-change",e,this._curEditClipUuid)}}}removeAnimationState(e){var i=this._animationStateMap.get(e);i&&(this.pause(),this._registerAnimStateEvents(i),i.destroy(),this._animationStateMap.delete(e))}clearAnimationState(){this._animationStateMap.forEach((e,i)=>{this.removeAnimationState(i)})}onSceneOpened(e){var i,t;this._isInEdit&&(this.storeData(),this.removeAnimationState(this._curEditClipUuid),i=this.queryRecordAnimData(),(t=this.queryRecordAnimState())&&this._registerAnimStateEvents(t),this._curEditAnimClip?this._curEditAnimClip.refreshData(i.node,this._curEditClipUuid):this._curEditAnimClip=new editor_animation_clip_1.default(i.node,this._curEditClipUuid,t),this.setCurEditTime(this._curEditTime))}async queryAuxiliaryCurves(e){var i=this._curEditAnimClip;return i&&i.clipUUID===e?await i.getAuxiliaryCurves():{}}}exports.AnimationManager=AnimationManager,exports.default=new AnimationManager;