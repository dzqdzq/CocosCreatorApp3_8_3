"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var n=Object.getOwnPropertyDescriptor(t,a);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,n)}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.multiplyTrackWithTimer=exports.allowModifyCurveType=exports.isHierarchyPath=exports.utils=exports.copyAuxiliaryCurves=exports.uniqAnimationClips=exports.getSerializedAuxCurves=exports.isSkeletonClip=void 0;const cc_1=require("cc"),uniform_handler_1=require("./uniform-handler"),dumpEncode=__importStar(require("../../../export/dump/encode")),dumpDecode=__importStar(require("../../../export/dump/decode")),dumpUtil=__importStar(require("../../../export/dump/utils")),embedded_player_1=require("cc/editor/embedded-player"),util_1=require("util"),new_gen_anim_1=require("cc/editor/new-gen-anim"),allowModifyCurveType=["cc.Number","Number","Integer","Float"],propToDisplayNameMap=(exports.allowModifyCurveType=allowModifyCurveType,{eulerAngles:"rotation(eulerAngles)",rotation:"rotation(quaternion)"});function generateAnimablePropData(e,t){let a=e;return{name:e,key:e,displayName:a=propToDisplayNameMap[e]?propToDisplayNameMap[e]:a,type:{value:t},menuName:a,propData:{targetPaths:(new cc_1.animation.TrackPath).toProperty(e),type:{value:t}}}}const defaultProperties=[generateAnimablePropData("position","cc.Vec3"),generateAnimablePropData("eulerAngles","cc.Vec3"),generateAnimablePropData("rotation","cc.Quat"),generateAnimablePropData("scale","cc.Vec3")],activeProperty=generateAnimablePropData("active","cc.Boolean"),excludeComponentAnimProps={"*":["type","__scriptAsset"],"cc.ParticleSystem":["materials"]},excludeCCClass=["cc.Mesh","cc.ColorOvertimeModule","cc.CurveRange","cc.ForceOvertimeModule","cc.GradientRange","cc.LimitVelocityOvertimeModule","cc.RotationOvertimeModule","cc.SizeOvertimeModule","cc.TextureAnimationModule","cc.VelocityOvertimeModule","cc.ShapeModule","cc.TrailModule","cc.Terrain","cc.TerrainAsset","cc.Material"],valueTypePartMap={"cc.Vec2":["x","y"],"cc.Vec3":["x","y","z"],"cc.Vec4":["x","y","z","w"],"cc.Color":["r","g","b","a"],"cc.Size":["width","height"]},valueTypeParts=Object.keys(valueTypePartMap);function isSkeletonClip(e){return-1<e.indexOf("@")}function isHierarchyPath(e){return cc_1.animation.isCustomPath(e,cc_1.animation.HierarchyPath)}function isComponentPath(e){return e instanceof cc_1.animation.ComponentPath}function isPropPath(e){return"string"==typeof e}function isElementPath(e){return"number"==typeof e}function getExcludeAnimProps(a){const r=[];return Object.keys(excludeComponentAnimProps).forEach(e=>{var t;("*"===e||(t=cc_1.js.getClassByName(e))&&cc_1.js.isChildClassOf(a,t))&&r.concat(excludeComponentAnimProps[e])}),r}function getSerializedAuxCurves(e){var t={};for(const r of e.getAuxiliaryCurveNames_experimental()){var a=e.getAuxiliaryCurve_experimental(r);t[r]={curve:cce.Utils.serialize(a,{stringify:!1})}}return t}function uniqAnimationClips(e){var t,a={},r=[];for(const n of e)null!=n&&(void 0!==(t=a[n.uuid])?t!==n&&console.warn(`Animation clip conflict(has same uuid but fails in equality comparisons): "${n.uuid}"`):(a[n.uuid]=n,r.push(n)));return r}function copyAuxiliaryCurves(e,t){if(0<t.auxiliaryCurveCount_experimental)for(const n of t.getAuxiliaryCurveNames_experimental())t.removeAuxiliaryCurve_experimental(n);for(const i of e.getAuxiliaryCurveNames_experimental()){var a=e.getAuxiliaryCurve_experimental(i),r=t.addAuxiliaryCurve_experimental(i);r.assignSorted(a.keyframes()),r.preExtrapolation=a.preExtrapolation,r.postExtrapolation=a.postExtrapolation}}exports.isSkeletonClip=isSkeletonClip,exports.isHierarchyPath=isHierarchyPath,exports.getSerializedAuxCurves=getSerializedAuxCurves,exports.uniqAnimationClips=uniqAnimationClips,exports.copyAuxiliaryCurves=copyAuxiliaryCurves;class AnimationUtil{cloneCCClass(e){let t=null;return t=e?(0,cc_1.deserialize)(cce.Utils.serialize(e)):t}getNodePathFromAnimRoot(t,a){let r=null,n=!1;if(t===a)r="/",n=!0;else{r="/"+a.name;let e=a.parent;for(;e;){if(e===t){n=!0;break}r="/"+e.name+r,e=e.parent}}return n?r:null}getCustomModifierData(e){var t={};return e instanceof cc_1.animation.HierarchyPath?t.path=e.path:e instanceof cc_1.animation.ComponentPath?t.component=e.component:console.log("Unknown modifier "+e.constructor.name),t}decodeClipsMenu(e){const t=[];return e.forEach(e=>{e&&e.name&&(e={name:e.name,uuid:e._uuid},t.push(e))}),t}getPropDumpData(t,a,r,e){var n={displayName:"",propData:{}};let i;if(e)e instanceof cc_1.animation.UniformProxyFactory&&(o=uniform_handler_1.uniformHandler.getUniformDumpData(a,e),n.displayName=o.displayName,n.key=o.key,i=o.type),n.propData.valueAdapter=e;else{let e=null;t&&cc_1.CCClass._isCCClass(t.constructor)&&(e=cc_1.CCClass.attr(t.constructor,r));var o=dumpUtil.getConstructor(a,e);i={value:""},e&&!e.ctor&&e.type?e.type instanceof cc_1.CCClass.Attr.PrimitiveType?i.value=e.type.name:i.value=e.type:i.value=dumpUtil.getTypeName(o),o&&(i.extends=dumpUtil.getTypeInheritanceChain(o))}return n.type=i,n}dumpKeyframeData(e){const r=[];return e.forEach((e,t)=>{var a=e.value,a={frame:e.frame,dump:dumpEncode.encodeObject(a,{default:void 0}),inTangent:e.inTangent,inTangentWeight:e.inTangentWeight,outTangent:e.outTangent,outTangentWeight:e.outTangentWeight,interpMode:e.interpMode,tangentWeightMode:e.tangentWeightMode,easingMethod:e.easingMethod};r.push(a)}),r}async getKeyframeDataFromDump(t){var a=[],r=[];for(let e=0;e<t.length;e++){var n=t[e],n=(null===n.dump.value||void 0===n.dump.value?r[e]=n.dump.value:await dumpDecode.decodePatch(""+e,n.dump,r),{frame:n.frame,value:r[e],inTangent:n.inTangent,inTangentWeight:n.inTangentWeight,outTangent:n.outTangent,outTangentWeight:n.outTangentWeight,interpMode:n.interpMode,tangentWeightMode:n.tangentWeightMode});a.push(n)}return a}getPartsOfType(e){return e&&valueTypeParts.includes(e)?valueTypePartMap[e]:null}createPropertyCurve(e,t,a,r){const n=[],i=[];r.forEach((e,t)=>{n.push(e.frame/a),i.push(e.value)});r=t.push(n)-1,t={keys:r,values:i,easingMethods:{}};return{modifiers:e.targetPaths,valueAdapter:e.valueAdapter,data:t}}getNodePath(e,t){let a="/",r=e.slice();return r&&0<(r=t?t.modifiers.concat(r):r).length&&r.isHierarchyAt(0)&&"/"!==(e=r.parseHierarchyAt(0)).substr(0,1)&&(a+=e),a}generateHierarchyPath(e){return e&&"/"!==e?(e=e.substr(1),(new cc_1.animation.TrackPath).toHierarchy(e)):null}getPropInfo(a,e){let r="",n="",i="",o="/",l;var c,s;let u=e,t="",p=e;for(let t=0;t<a.length;t++){let e="";if(a.isPropertyAt(t)||a.isElementAt(t)){var d=a.isPropertyAt(t)?a.parsePropertyAt(t):a.parseElementAt(t);a.isPropertyAt(t)&&(r=a.parsePropertyAt(t)),e=a.isElementAt(t)?`[${d}]`:"."+d,n+="."+d,u=u&&(p=u)[d]}else if(a.isHierarchyAt(t)){d=a.parseHierarchyAt(t);if("/"!==d&&("/"===d.substr(0,1)?o=d:o+=d,u))try{u=u.getChildByPath(d),p=u}catch(e){}}else a.isComponentAt(t)&&(s=a.parseComponentAt(t),e=s,l=s,u&&(c=u.getComponent(l),u=c,p=c),n+=s);i+=e}return"."===i.charAt(0)&&(i=i.substr(1)),"."===n.charAt(0)&&(n=n.substr(1)),t=i,propToDisplayNameMap[i]&&(t=propToDisplayNameMap[i]),{nodePath:o,propPath:i,propKey:n,compName:l,propName:r,displayName:t,propObject:u,propOwnerObject:p}}getCurveInfoByTrack(e,t){var a=t.path,r=t.proxy,e=this.getPropInfo(a,e),n=this.getPropDumpData(e.propOwnerObject,e.propObject,e.propName,r),i=n.key?(null==e?void 0:e.propKey)+"."+n.key:null==e?void 0:e.propKey,o=n.displayName?(null==e?void 0:e.displayName)+"."+n.displayName:null==e?void 0:e.displayName;return n.type&&"Unknown"!==n.type.value||(n.type=this.getTypeByTrack(t)),n.type&&"Unknown"!==n.type.value||console.warn("Can't find type of "+o),{nodePath:null==e?void 0:e.nodePath,propKey:i,combinedType:void 0,type:n.type,targetPaths:a,valueAdapter:r,displayName:o,propName:null==e?void 0:e.propName,compName:null==e?void 0:e.compName,partName:void 0}}getTypeByTrack(e){let t="",a;if(e instanceof cc_1.animation.VectorTrack)switch(e.componentsCount){case 2:t="cc.Vec2";break;case 3:t="cc.Vec3";break;case 4:t="cc.Vec4"}else if(e instanceof cc_1.animation.RealTrack)t="Number";else if(e instanceof cc_1.animation.QuatTrack)t="cc.Quat";else if(e instanceof cc_1.animation.ColorTrack)t="cc.Color";else if(e instanceof cc_1.animation.ObjectTrack){var r,n;for([r,n]of e.channel.curve.keyframes())if(void 0!==n&&null!==n){var i=dumpEncode.encodeObject(n,{default:void 0});t=i.type,a=i.extends;break}}return{value:t||"",extends:a}}copyClip(e,t){e.name=t.name,e.duration=t.duration,e.sample=t.sample,e.speed=t.speed,e.wrapMode=t.wrapMode,e.clearTracks();for(const a of t.tracks)e.addTrack(a);e.events=t.events,e[cc_1.editorExtrasTag].embeddedPlayerGroups=t[cc_1.editorExtrasTag].embeddedPlayerGroups,e[embedded_player_1.clearEmbeddedPlayersTag]();for(const r of t[embedded_player_1.getEmbeddedPlayersTag]())e[embedded_player_1.addEmbeddedPlayerTag](r);copyAuxiliaryCurves(t,e)}queryEvents(e){return e?e.events:(console.warn("Clip is not valid"),null)}isObject(e){return"object"==typeof e}isExcludeType(e){var t=cc_1.js.getClassByName(e);return excludeCCClass.includes(e)||t&&cc_1.js.isChildClassOf(t,cc_1.Component)||cc_1.js.isChildClassOf(t,cc_1.Node)}handleAnimableProp(e,t,a,r,n,i){let o=[];var l;return this.isExcludeType(a)||(Array.isArray(r)?(l=this.handleArrayProp(e,t,a,r,n,i))&&(o=l):this.isObject(r)?(l=this.handlePrimitiveProp(e,t,a,n),(r=this.handleObjectProp(e,t,a,r,n,i))&&(o=o.concat(r)),!l||r&&r.length||(o=o.concat(l))):(i=this.handlePrimitiveProp(e,t,a,n))&&(o=[i])),o}generatePropDumpData(e,t,a){var r={propData:{}},n=(new cc_1.animation.TrackPath).toComponent(e);if(r.category=e,a){n.append(a);for(let t=0;t<a.length;++t){let e="";switch(!0){default:e="UnknownPath";break;case a.isPropertyAt(t):e=a.parsePropertyAt(t);break;case a.isElementAt(t):e=""+a.parseElementAt(t);break;case a.isHierarchyAt(t):e=a.parseHierarchyAt(t);break;case a.isComponentAt(t):e=a.parseComponentAt(t)}r.category+="/"+e}}n.toProperty(t);e=this.getPropInfo(n);return r.key=e.propKey,r.displayName=e.displayName,r.name=e.propName,e.displayName.endsWith(e.propName)||"number"!=typeof t?r.menuName=e.propName:r.menuName=e.propName+`[${t}]`,r.propData.targetPaths=n,r}handlePrimitiveProp(e,t,a,r){t=this.generatePropDumpData(e,t,r),t.comp=e,r={value:a},e=cc_1.js.getClassByName(a);return e&&(r.extends=dumpUtil.getTypeInheritanceChain(e)),t.type=r,t.propData.type=t.type,t}handleObjectProp(n,i,o,l,c,s){if(!l)return null;if(this.isExcludeType(o))return null;if(s.includes(o))return null;let u=[];if(o===cc_1.js.getClassName(cc_1.renderer.MaterialInstance)){var e=uniform_handler_1.uniformHandler.getAnimablePropsFromMaterial(l);e&&0<e.length&&e.forEach(e=>{var t=this.generatePropDumpData(n,i,c),a=(t.type=e.type,t.comp=n,t.name=e.name,t.category+=`/${i}/`+e.name,uniform_handler_1.uniformHandler.getUniformNameData(e.passIndex,e.name));t.key+="."+a.key,t.displayName+="."+a.displayName,t.menuName=a.displayName,e.uniformAdapter&&(t.propData.valueAdapter=e.uniformAdapter),u.push(t)})}else{let r=!1,e=[];cc_1.js.getClassByName(o)?(r=!0,l.constructor&&l.constructor.__props__&&(e=l.constructor.__props__)):e=Object.keys(l);const p=(null!=c?c:new cc_1.animation.TrackPath).toProperty(i);e.forEach(e=>{var t=l[e];let a=null;r?a=this.getCCClassAnimablePropType(l,e):t&&(a=typeof t),a&&(s.includes(o)||s.push(o),u=u.concat(this.handleAnimableProp(n,e,a,t,p,s)))})}return u}handleArrayProp(a,e,r,t,n,i){let o=[];const l=n.slice().toProperty(e);return t.forEach((e,t)=>{o=o.concat(this.handleAnimableProp(a,t,r,e,l,i))}),o}getCCClassAnimablePropType(e,t){if(!this.isObject(e))return null;var a=e.constructor,a=cc_1.CCClass.attr(a,t);if(!a)return null;let r=!0;if(!(r=a.type!==cc_1.js.getClassName(cc_1.Node)&&(void 0!==a.animatable?a.animatable:void 0===a.visible||a.visible)))return null;e=e[t],t=dumpUtil.getConstructor(e,a);let n=null;return!a.ctor&&a.type?n=a.type:Array.isArray(e)?(a=e[0])&&a.constructor&&(n=dumpUtil.getTypeName(a.constructor)):n=dumpUtil.getTypeName(t),n="Unknown"===n?null:n}getAnimablePropsFromProperty(e,t){cc_1.js.isChildClassOf(e.constructor,cc_1.Renderer)&&"sharedMaterials"===t&&(t="materials");var a=this.getCCClassAnimablePropType(e,t);if(!a)return null;let r="";r=a instanceof cc_1.CCClass.Attr.PrimitiveType?a.name:a;a=e[t],e=dumpUtil.getTypeName(e.constructor);return this.handleAnimableProp(e,t,r,a,new cc_1.animation.TrackPath,[e])}getAnimablePropsFromComponent(t){let a=[];var e=t.constructor;if(e){e=e.__props__;const r=getExcludeAnimProps(e);e.map(e=>{r.includes(e)||null!==(e=this.getAnimablePropsFromProperty(t,e))&&(a=a.concat(e))})}return a}getAnimableProperties(e,t){if(!e)return null;const a=[];return t&&a.push(activeProperty),defaultProperties.forEach(e=>{a.push(e)}),e.components.forEach(t=>{if(!(t instanceof cc_1.Animation))try{if(!excludeCCClass.includes(cc_1.js.getClassName(t))){for(let e=0;e<a.length;++e)if(a[e].name.startsWith(cc_1.js.getClassName(t)))return;this.getAnimablePropsFromComponent(t).forEach(e=>{a.push(e)})}}catch(e){console.warn(e)}}),a}getClipName(t,e){if(!t)return null;let a=null;return e.forEach(e=>{e&&e._uuid===t&&(a=e.name)}),a}queryNodeAnimationData(a,r){var n={defaultClip:null};if(a){let t=null;if(t="string"==typeof a?cce.Node.query(a):a){let e=[];var i=(n.node=t).getComponent(cc_1.animation.AnimationController);if(i)e=[...(0,new_gen_anim_1.visitAnimationClipsInController)(i)],n.animComp=i;else{i=t.getComponent(cc_1.Animation);if(!i)return console.debug(`Node(${a}) lacks Animation`),n;e=i.clips,n.animComp=i,n.defaultClip=i.defaultClip}if(r){let t=null;e.forEach(e=>{e&&e._uuid===r&&(t=e)}),n.clips=e,n.defaultClip=n.defaultClip||e[0],t&&0 instanceof cc_1.animation.AnimationController}}else console.debug(`Node(${a}) doesn't exist`)}else console.debug(`Node(${a}) doesn't exist`);return n}getDefaultValue(e){let t=null;var a=cc_1.js.getClassByName(e);if(a)t=new a;else switch(e){case"Boolean":t=!1;break;case"Number":case"Integer":case"Float":t=0;break;case"String":t=""}return t}async getValueFrom(t,a,r=null){var n,i;if(a){let e;return r&&void 0!==r.newValue?(n=a.type.value,e=r.newValue,e=cc_1.js.getClassByName(n)?a.type.extends&&a.type.extends.includes("cc.Asset")?(i=(null==(i=r.newValue)?void 0:i.uuid)||(null==(i=r.newValue)?void 0:i._uuid))&&""!==i?await(0,util_1.promisify)(cc_1.assetManager.loadAny)(i):null:((i={}).__type__=n,Object.assign(i,r.newValue),(0,cc_1.deserialize)(i)):r.newValue):(n=a.targetPaths,i=a.valueAdapter,r=n.trace(r=t),i?i instanceof cc_1.animation.UniformProxyFactory&&(e=await uniform_handler_1.uniformHandler.getCurrentValue(r,i,a)):(e=void 0!==r?r:e)&&e.constructor&&cc_1.js.isChildClassOf(e.constructor,cc_1.ValueType)&&(e=e.clone())),e}}loadJsonWithUuid(e,t,a){cc_1.assetManager.assets.remove(e),cc_1.assetManager.loadWithJson(t,{assetId:e},(e,t)=>{a&&a(e,t)})}copyCurveData(e,t){var a;t.inTangent=null!=(a=e.inTangent)?a:t.inTangent,t.inTangentWeight=null!=(a=e.inTangentWeight)?a:t.inTangentWeight,t.outTangent=null!=(a=e.outTangent)?a:t.outTangent,t.outTangentWeight=null!=(a=e.outTangentWeight)?a:t.outTangentWeight,t.interpMode=null!=(a=e.interpMode)?a:t.interpMode,t.tangentWeightMode=null!=(a=e.tangentWeightMode)?a:t.tangentWeightMode,t.tangentMode=null!=(a=e.tangentMode)?a:t.tangentMode,t.broken=null!=(a=e.broken)?a:t.broken,t.easingMethod=null!=(a=e.easingMethod)?a:t.easingMethod}isNumber(e){return"number"==typeof e&&!isNaN(e)}getTrackTypeBy(e){let t=null;switch(e){case"cc.Vec2":t="vec2";break;case"cc.Vec3":t="vec3";break;case"cc.Vec4":t="vec4";break;case"cc.Color":t="color";break;case"cc.Size":t="size"}return t}isTypeSupportCurve(e){return!(!e||!allowModifyCurveType.includes(e))}calcEmbeddedPlayerKey(e){var t;return`begin:${e.begin},end:${e.end},player:${null==(t=e.playable)?void 0:t.type},group:${e.group}},displayName:${e.displayName}}`}initAninState(e,t){e._curveLoaded=!1;try{e.initialize(t)}catch(e){console.error(e)}}getPlayableInfo(e){return e instanceof embedded_player_1.EmbeddedParticleSystemPlayable?{path:e.path,type:"particle-system"}:e instanceof embedded_player_1.EmbeddedAnimationClipPlayable?{path:e.path,clip:(null==(e=e.clip)?void 0:e._uuid)||"",type:"animation-clip"}:null}}const utils=new AnimationUtil;function multiplyTrackWithTimer(e,t){for(const a in t)Editor.Metrics._trackEventWithTimer({category:e,id:a,value:t[a]})}exports.utils=utils,exports.multiplyTrackWithTimer=multiplyTrackWithTimer;