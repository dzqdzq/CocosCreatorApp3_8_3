"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),editor_animation_curve_1=require("./editor-animation-curve"),editor_animation_combined_curve_1=__importDefault(require("./editor-animation-combined-curve")),editor_animation_aux_curve_1=require("./editor-animation-aux-curve"),utils_1=require("./utils"),uniform_handler_1=require("./uniform-handler"),embedded_player_1=require("cc/editor/embedded-player"),asset_1=require("../../../utils/asset"),CombinedType=["cc.Vec2","cc.Vec3","cc.Vec4","cc.Color","cc.Size"];class EditorAnimationClip{constructor(e,t,a){this._initPropDataMap=new Map,this._createdCurveMap=new Map,this._editorCurves=[],this._editEmbeddedPlayerMap={},this._createdAuxCurveMap=new Map,this._auxCurves=new Set,this._rootNode=e,this._clipUuid=t,this._animComp=e.getComponent(cc_1.Animation),this._animState=a,this.init()}refreshData(t,e){this._rootNode=t,this._clipUuid=e,this._animComp=t.getComponent(cc_1.Animation);for(let e=0;e<this._editorCurves.length;e++)this._editorCurves[e].node=t;for(const a of this._auxCurves)a.node=t}init(){var e=this._getAnimState();if(e){var t=e.clip;if(this._editorSharedClipData={sample:t.sample,duration:t.duration},t.upgradeUntypedTracks((e,t)=>{let a=null;if(t)t instanceof cc_1.animation.UniformProxyFactory&&(r=e.trace(this._rootNode),r=uniform_handler_1.uniformHandler.getUniformDumpData(r,t),a=r.type);else{var t=e.trace(this._rootNode,0,e.length-1),r=e.length-1,e=e.isPropertyAt(r)?e.parsePropertyAt(r):e.isElementAt(r)?e.parseElementAt(r):null;if(null===e||"number"==typeof e)return null;a=cc_1.CCClass._isCCClass(t.constructor)?(r=cc_1.CCClass.attr(t.constructor,e),t instanceof cc_1.Node&&("position"===e||"eulerAngles"===e||"scale"===e)?"cc.Vec3":r.type):typeof t[e]}return utils_1.utils.getTrackTypeBy(a)}),t[cc_1.editorExtrasTag]&&t[cc_1.editorExtrasTag].embeddedPlayerGroups||(t[cc_1.editorExtrasTag]={embeddedPlayerGroups:[]}),t.tracks){var a=this.generateClipData(t);for(const o of t.tracks){var r,i,n=utils_1.utils.getCurveInfoByTrack(this._rootNode,o);o instanceof cc_1.animation.RealTrack||o instanceof cc_1.animation.QuatTrack||o instanceof cc_1.animation.ObjectTrack?(r=o.channel.curve,(i=new editor_animation_curve_1.EditorAnimationCurve(this._rootNode,a)).initFromCurve(n,r),this.addEditorCurve(i)):o instanceof cc_1.animation.VectorTrack||o instanceof cc_1.animation.ColorTrack||o instanceof cc_1.animation.SizeTrack?this.createCombinedAndPartsAnimCurve(a,n,o):console.warn("unknown track:",o)}e=t[embedded_player_1.getEmbeddedPlayersTag]();this._editEmbeddedPlayerMap={};for(const d of e){var s={begin:Math.round(d.begin*t.sample),end:Math.round(d.end*t.sample),reconciledSpeed:d.reconciledSpeed,group:d[cc_1.editorExtrasTag]&&d[cc_1.editorExtrasTag].group,displayName:d[cc_1.editorExtrasTag]&&d[cc_1.editorExtrasTag].displayName,playable:utils_1.utils.getPlayableInfo(d.playable)||void 0},u=utils_1.utils.calcEmbeddedPlayerKey(s);this._editEmbeddedPlayerMap[u]=s}this._initAuxCurves(!0)}else console.warn("tracks is null")}}get rootNode(){return this._rootNode}get clipUUID(){return this._clipUuid}generateClipData(e){return{sharedData:this._editorSharedClipData}}createCombinedAndPartsAnimCurve(e,t,a){e=new editor_animation_combined_curve_1.default(this._rootNode,e);e.initFromTrack(t,a),this.addEditorCurve(e),e.getPartEditorAnimCurves().forEach(e=>{this.addEditorCurve(e)})}addInitPropDataMap(e,t){const a=new Map;t.forEach(e=>{a.set(e.key,e)}),this._initPropDataMap.set(e,a)}getInitPropData(t,e){if(!this._initPropDataMap.has(t)){let e=this._rootNode;"/"!==t&&(e=e.getChildByPath(t.substr(1)));var a=utils_1.utils.getAnimableProperties(e,e!==this._rootNode);a&&this.addInitPropDataMap(t,a)}a=this._initPropDataMap.get(t);return a?a.get(e):null}getCreatedCurve(e,t){let a=null;e=this._createdCurveMap.get(e);return a=e?e.get(t):a}getCreatedAuxCurve(e,t){var a=this._createdAuxCurveMap.get(e);if(!0===t&&void 0===a)throw new Error(`Cannot find auxiliary curve named "${e}"`);return a}addEditorCurve(e){this._editorCurves.includes(e)||(this._editorCurves.push(e),this.addToCreatedCurveMap(e))}addAuxCurve(e){var t;this._auxCurves.has(e)||(this._auxCurves.add(e),t=e.curveInfo.displayName,void 0!==(t=this._createdAuxCurveMap.get(t))&&this._auxCurves.delete(t),this.addToAuxCurveMap(e))}addToCreatedCurveMap(e){let t=this._createdCurveMap.get(e.nodePath);(t=t||new Map).set(e.propKey,e),this._createdCurveMap.set(e.nodePath,t)}addToAuxCurveMap(e){var t=e.curveInfo.displayName;Editor.App.dev&&this._createdAuxCurveMap.has(t)&&console.warn(`aux curve "${t}" already exists and will be overwritten.`),this._createdAuxCurveMap.set(t,e)}rebuildCreatedCurveMap(){this._createdCurveMap.clear(),this._editorCurves.forEach(e=>{this.addToCreatedCurveMap(e)}),this._createdAuxCurveMap.clear();for(const e of this._auxCurves)this.addToAuxCurveMap(e)}async getDumpData(){var e=this._getAnimState();if(!e)return null;const t=e.clip,a=[];for(let e=0;e<this._editorCurves.length;e++){var r=this._editorCurves[e];const s=await r.getDumpData();r instanceof editor_animation_combined_curve_1.default?(a.push(s),await r.iteratorPartAnimCurves(async(e,t)=>{e=await e.getDumpData();e.parentPropKey=s.key,s.partKeys?s.partKeys.push(e.key):s.partKeys=[e.key],a.push(e)})):r instanceof editor_animation_curve_1.EditorAnimationCurve&&(r.isPartCurve||a.push(s))}var i=await this.getAuxiliaryCurves();let n=!1;return this._animComp instanceof cc_1.SkeletalAnimation&&(n=this._animComp.useBakedAnimation),{name:t.name,duration:t.duration,sample:t.sample,speed:t.speed,wrapMode:t.wrapMode,curves:a,events:t.events.map(e=>({frame:Math.round(e.frame*t.sample),func:e.func,params:e.params})),embeddedPlayers:Array.from(t[embedded_player_1.getEmbeddedPlayersTag]()).map(e=>({begin:Math.round(e.begin*t.sample),end:Math.round(e.end*t.sample),reconciledSpeed:e.reconciledSpeed,group:e[cc_1.editorExtrasTag]&&e[cc_1.editorExtrasTag].group,displayName:e[cc_1.editorExtrasTag]&&e[cc_1.editorExtrasTag].displayName,playable:utils_1.utils.getPlayableInfo(e.playable)||void 0})),embeddedPlayerGroups:t[cc_1.editorExtrasTag].embeddedPlayerGroups,time:e.time||0,isLock:!1,auxiliaryCurves:i,isSkeleton:(0,utils_1.isSkeletonClip)(this.clipUUID),useBakedAnimation:n}}recalculateDuration(){var e=this._getAnimState();if(e&&!(this._animComp instanceof cc_1.SkeletalAnimation)){let t=0;this._editorCurves.forEach(e=>{e instanceof editor_animation_curve_1.EditorAnimationCurve&&(t=Math.max(e.getCurveDuration(),t))}),this._editorSharedClipData.duration=t}}async applyEditorCurvesToClip(){var e=this._getAnimState();if(e){const n=e.clip;n.sample=this._editorSharedClipData.sample,n.duration=this._editorSharedClipData.duration;var t=[];try{for(let e=0;e<this._editorCurves.length;e++){var a,r,i=this._editorCurves[e];i instanceof editor_animation_curve_1.EditorAnimationCurve?i.isPartCurve||(a=this.createTrack(i,n.sample))&&t.push(a):i instanceof editor_animation_combined_curve_1.default&&(await i.updateCurveData(),r=this.createTrack(i,n.sample))&&t.push(r)}}catch(e){return void console.error(e)}n.clearTracks(),t.forEach(e=>{n.addTrack(e)})}}applyAuxCurvesToClip(){var e=this._getAnimState();if(e){var t=e.clip;for(const r of this._auxCurves){var a=t.getAuxiliaryCurve_experimental(r.curveInfo.displayName);null!=a&&(0,editor_animation_aux_curve_1.syncToRealCurve)(r,a)}}}async applyEditorEmbeddedPlayersToClip(){var e=this._getAnimState();if(e){var t=Object.values(this._editEmbeddedPlayerMap);e.clip[embedded_player_1.clearEmbeddedPlayersTag]();for(const i of t){var a,r=new embedded_player_1.EmbeddedPlayer;r.begin=i.begin/e.clip.sample,r.end=i.end/e.clip.sample,r.reconciledSpeed=i.reconciledSpeed,r[cc_1.editorExtrasTag]={group:i.group,displayName:i.displayName},i.playable&&("animation-clip"===i.playable.type&&(a=new embedded_player_1.EmbeddedAnimationClipPlayable,i.playable.clip&&(a.clip=await(0,asset_1.loadAssetUncached)(i.playable.clip,cc_1.AnimationClip)),i.playable.path&&(a.path=i.playable.path),r.playable=a),"particle-system"===i.playable.type)&&(a=new embedded_player_1.EmbeddedParticleSystemPlayable,i.playable.path&&(a.path=i.playable.path),r.playable=a),e.clip[embedded_player_1.addEmbeddedPlayerTag](r)}}}updateEditorEmbeddedPlayers(){var e=this._getAnimState();e&&(e.clip.duration=this._editorSharedClipData.duration,utils_1.utils.initAninState(e,this._rootNode))}_ensureEditorExtras(e){e[cc_1.editorExtrasTag]||(e[cc_1.editorExtrasTag]={})}_getRealKeyframeData(e){var t={value:e.value,interpolationMode:e.interpMode,rightTangent:e.outTangent,rightTangentWeight:e.outTangentWeight,leftTangent:e.inTangent,leftTangentWeight:e.inTangentWeight,tangentWeightMode:e.tangentWeightMode,easingMethod:e.easingMethod};return void 0!==e.tangentMode&&(this._ensureEditorExtras(t),t[cc_1.editorExtrasTag].tangentMode=e.tangentMode),void 0!==e.broken&&(this._ensureEditorExtras(t),t[cc_1.editorExtrasTag].broken=e.broken),t}createTrack(e,i){let t=null;var a=e.curveInfo,r=a.type.value;if(e instanceof editor_animation_combined_curve_1.default){switch(r){case"cc.Vec2":case"cc.Vec3":case"cc.Vec4":t=new cc_1.animation.VectorTrack,"cc.Vec2"===r?t.componentsCount=2:"cc.Vec3"===r?t.componentsCount=3:"cc.Vec4"===r&&(t.componentsCount=4);break;case"cc.Color":t=new cc_1.animation.ColorTrack;break;case"cc.Size":t=new cc_1.animation.SizeTrack;break;default:console.error("unknown track type:",r)}if(t){var n=e.getPartEditorAnimCurves();const s=t.channels();n.forEach((a,e)=>{const r=s[e];a.keyframeData.forEach(e=>{var t=this._getRealKeyframeData(e);r.curve.addKeyFrame(e.frame/i,t),a.partName&&(r.name=a.partName)}),r.curve.preExtrapolation=a.preExtrap,r.curve.postExtrapolation=a.postExtrap})}}else if(e instanceof editor_animation_curve_1.EditorAnimationCurve){switch(r){case"cc.Quat":t=new cc_1.animation.QuatTrack;break;case"cc.Number":case"Number":case"Integer":case"Float":t=new cc_1.animation.RealTrack;break;default:t=new cc_1.animation.ObjectTrack}if(t){const u=t.channel.curve;e.keyframeData.forEach(e=>{var t;u instanceof cc_1.RealCurve?(t=this._getRealKeyframeData(e),u.addKeyFrame(e.frame/i,t)):u instanceof cc_1.QuatCurve?u.addKeyFrame(e.frame/i,{value:e.value}):u.addKeyFrame(e.frame/i,e.value)}),(u instanceof cc_1.QuatCurve||u instanceof cc_1.RealCurve)&&(u.preExtrapolation=e.preExtrap,u.postExtrapolation=e.postExtrap)}}return t&&(t.path=e.curveInfo.targetPaths,a.valueAdapter)&&(t.proxy=a.valueAdapter),t}async updateCurveData(){var e=this._getAnimState();e&&(await this.applyEditorCurvesToClip(),utils_1.utils.initAninState(e,this._rootNode))}updateEventData(){var e=this._getAnimState();e&&(e.clip.updateEventDatas(),e.clip.duration=this._editorSharedClipData.duration,utils_1.utils.initAninState(e,this._rootNode))}async changeSample(a){var e=this._getAnimState();if(!e)return!1;a=Math.round(a),(isNaN(a)||a<1)&&(a=1);const r=e.clip;e=r.events;return e&&e.forEach(e=>{var t=Math.round(e.frame*r.sample);e.frame=t/a}),this._editorSharedClipData.sample=a,this.recalculateDuration(),await this.updateCurveData(),this.applyAuxCurvesToClip(),!0}async changeSpeed(e){var t=this._getAnimState();return!!t&&(t.clip.speed=e,await this.updateCurveData(),this.applyAuxCurvesToClip(),!0)}async changeWrapMode(e){var t=this._getAnimState();return!!t&&(void 0===cc.AnimationClip.WrapMode[e]&&(e=0),e=Number(e),t.clip.wrapMode=e,await this.updateCurveData(),this.applyAuxCurvesToClip(),!0)}async removeNode(t){if(!this._getAnimState())return!1;for(let e=this._editorCurves.length-1;0<=e;e--)this._editorCurves[e].nodePath===t&&this._editorCurves.splice(e,1);return this.rebuildCreatedCurveMap(),this.recalculateDuration(),await this.updateCurveData(),!0}async changeNodeDataPath(t,a){if(t===a)return!1;if(!this._getAnimState())return!1;if(void 0===t||void 0===a)return!1;let r=-1;var e,i=[];let n=null;for(let e=0;e<this._editorCurves.length;e++){var s=this._editorCurves[e];s.nodePath===t?(r=e,this._editorCurves[r].changeNodePath(a),this._editorCurves[r]instanceof editor_animation_combined_curve_1.default&&(n=this._editorCurves[r])):s.nodePath===a&&i.push(e)}if(0<i.length)for(let e=i.length-1;0<=e;e--)this._editorCurves.splice(i[e],1);return 0<=r&&(n&&(e=this.getInitPropData(n.nodePath,n.propKey),n.updateType(null==e?void 0:e.type)),this.rebuildCreatedCurveMap(),await this.updateCurveData(),!0)}async copyNode(e,t){var a=t.nodePath,r=e.curvesDump;if(r.length<=0)return console.warn("source of copyNode is empty"),!1;for(let e=0;e<r.length;e++){var i=r[e],n=i.key;let t;await this.createProp(a,n)&&(t=this.getCreatedCurve(a,n));n=this.getCreatedCurve(i.nodePath,n);if(!(CombinedType.includes(i.type&&i.type.value||"")||n instanceof editor_animation_combined_curve_1.default)&&t){var s=await utils_1.utils.getKeyframeDataFromDump(i.keyframes);for(let e=0;e<s.length;e++){var u=s[e],o={newValue:u.value};utils_1.utils.copyCurveData(u,o),await t.createKey(u.frame,o)}}}return this.recalculateDuration(),await this.updateCurveData(),!0}async copyProp(e,t){var a=t.nodePath,r=e.curvesDump;if(!t.propKeys)return console.warn("need a propKeys for target"),!1;if(t.propKeys&&t.propKeys.length!==r.length)return console.warn("src curves number doesn't equal to dst propKeys"),!1;if(r.length<=0)return console.warn("source of copyProp is empty"),!1;for(let e=0;e<r.length;e++){var i=r[e],n=(i.key,t.propKeys[e]),s=this.getCreatedCurve(a,n);if((null==(n=i.type)?void 0:n.value)!==(null==(n=null==s?void 0:s.curveInfo.type)?void 0:n.value))return console.warn(`type of source ${null==(n=i.type)?void 0:n.value} doesn't equal to type of target `+(null==(n=null==s?void 0:s.curveInfo.type)?void 0:n.value)),!1;if(s){var u=await utils_1.utils.getKeyframeDataFromDump(i.keyframes);for(let e=0;e<u.length;e++){var o=u[e],d={newValue:o.value};utils_1.utils.copyCurveData(o,d),await s.createKey(o.frame,d)}}}return this.recalculateDuration(),await this.updateCurveData(),!0}async copyKey(e,t){var a=t.nodePath,r=e.curvesDump;if(!t.propKeys)return console.warn("need a propKeys for target"),!1;if(t.propKeys&&t.propKeys.length!==r.length)return console.warn("src curves number doesn't equal to dst propKeys"),!1;if(r.length<=0)return console.warn("source of copyKey is empty"),!1;for(let e=0;e<r.length;e++){var i=r[e],n=t.propKeys[e],s=this.getCreatedCurve(i.nodePath,n);if(s instanceof editor_animation_curve_1.EditorAnimationCurve&&s.parentCurve&&await this.createProp(a,s.parentCurve.propKey),await this.createProp(a,n)){var u=this.getCreatedCurve(a,n);if((null==(s=i.type)?void 0:s.value)!==(null==(s=null==u?void 0:u.curveInfo.type)?void 0:s.value))return console.warn(`type of source ${null==(s=i.type)?void 0:s.value} doesn't equal to type of target `+(null==(s=null==u?void 0:u.curveInfo.type)?void 0:s.value)),!1;if(u){var o=await utils_1.utils.getKeyframeDataFromDump(i.keyframes),d=o[0].frame;for(let e=0;e<o.length;e++){var l=o[e],c={newValue:l.value};utils_1.utils.copyCurveData(l,c),await u.createKey(l.frame+t.startFrame-d,c)}}}else console.warn(`fail to create prop: ${a} `+n)}return this.recalculateDuration(),await this.updateCurveData(),!0}copyEvent(e,t){var a=e.eventsDump;if(a.length<=0)return console.warn("source of copyEvent is empty"),!1;var r=a[0].frame,i=[];for(let e=0;e<a.length;e++){var n=a[e],n=t.startFrame+n.frame-r;i.push(n),this._deleteEvent([n])}for(let e=0;e<a.length;e++){var s=a[e],u=i[e];this.addEvent(u,s.func,s.params)}return!0}async copyPropTo(e,t,a,r){if(e===a&&t===r)return!1;if(!this._getAnimState())return!1;if(!(e&&t&&a&&r))return!1;var i=this.getCreatedCurve(e,t);if(!i)return console.log(`can't find src prop Curve: nodePath:${e} propKey:`+t),!1;var n=this.getCreatedCurve(a,r);if(!n)return console.log(`can't find dst prop Curve: nodePath:${a} propKey:`+r),!1;e=i.curveInfo,t=n.curveInfo;if(!e.type||!t.type)return!1;if(e.type.value!==t.type.value)return!1;var s=i.keyframeData;if(!s)return!1;for(let e=0;e<s.length;e++){var u=s[e];await n.createKey(u.frame,{newValue:u.value})}return this.recalculateDuration(),await this.updateCurveData(),!0}async createProp(e,t){var a=this._getAnimState();if(!a)return!1;var r=this.getCreatedCurve(e,t);if(!r){r=this.getInitPropData(e,t);if(!r)return!1;var i=new cc_1.animation.TrackPath,n=utils_1.utils.generateHierarchyPath(e),n=(n&&i.append(n),r.propData.valueAdapter),s=r.propData.targetPaths,s=(i.append(s),a.clip),a=r.type.value,s=this.generateClipData(s),e={nodePath:e,propKey:t,type:r.type,targetPaths:i,valueAdapter:n,displayName:r.displayName,propName:r.name,compName:r.comp};utils_1.utils.getPartsOfType(a)?((t=new editor_animation_combined_curve_1.default(this._rootNode,s)).curveInfo=e,t.separateDataIntoParts(),this.addEditorCurve(t),t.getPartEditorAnimCurves().forEach(e=>{this.addEditorCurve(e)})):((i=new editor_animation_curve_1.EditorAnimationCurve(this._rootNode,s)).curveInfo=e,this.addEditorCurve(i)),await this.updateCurveData()}return!0}async removeProp(e,t){if(!this._getAnimState())return!1;var a=this.getCreatedCurve(e,t);if(!a)return!1;let r=null;if(a instanceof editor_animation_combined_curve_1.default)r=a.getPartEditorAnimCurves();else if(a instanceof editor_animation_curve_1.EditorAnimationCurve&&a.isPartCurve)return console.warn("can't remove part prop directly"),!1;for(let e=this._editorCurves.length-1;0<=e;e--){var i=this._editorCurves[e];i===a?this._editorCurves.splice(e,1):i instanceof editor_animation_curve_1.EditorAnimationCurve&&r&&r.includes(i)&&this._editorCurves.splice(e,1)}return this.rebuildCreatedCurveMap(),this.recalculateDuration(),await this.updateCurveData(),!0}async createKey(e,t,a=0,r){return!(a<0||!this._getAnimState()||!(e=this.getCreatedCurve(e,t))||!await e.createKey(a,r)||(this.recalculateDuration(),await this.updateCurveData(),(0,utils_1.multiplyTrackWithTimer)("hippoAnimator",{A100001:1,project_id:Editor.Project.uuid,clip_id:this._clipUuid,version:Editor.App.version}),0))}async moveKeys(e,t,a,r){if(a.length<=0)return!1;for(let e=0;e<a.length;e++)if(a[e]<0)return!1;let i=[];return Array.isArray(r)?i=r:a.forEach(e=>{i.push(r)}),0!==i.length&&a.length===i.length&&!(!this._getAnimState()||!(e=this.getCreatedCurve(e,t))||!e.moveKeys(a,i)||(this.recalculateDuration(),await this.updateCurveData(),0))}async removeKey(e,t,a){if(!this._getAnimState())return!1;if(null==a)return!1;Array.isArray(a)||(a=[a]);e=this.getCreatedCurve(e,t);return!!e&&!!e.removeKey(a)&&(this.recalculateDuration(),await this.updateCurveData(),!0)}async updateKey(e,t,a){if(null==a)return!1;if(!this._getAnimState())return!1;Array.isArray(a)||(a=[a]);e=this.getCreatedCurve(e,t);return!!e&&!!await e.updateKey(a)&&(await this.updateCurveData(),!0)}async copyKeysTo(e,t,a,r){if(!this._getAnimState())return!1;a.sort((e,t)=>e-t);e=this.getCreatedCurve(e,t);return!!e&&!!await e.copyKeysTo(a,r)&&(this.recalculateDuration(),await this.updateCurveData(),!0)}async spacingKeys(e,t,a,r){return!!this._getAnimState()&&!!(e=this.getCreatedCurve(e,t))&&(await e.spacingKeys(a,r),this.recalculateDuration(),await this.updateCurveData(),!0)}async clearKeys(e,t){return!(!this._getAnimState()||!(e=this.getCreatedCurve(e,t))||!e.clearKeys()||(this.recalculateDuration(),await this.updateCurveData(),0))}addEvent(e,t,a){var r;return!(e<0||!(r=this._getAnimState()))&&((r=r.clip)?(e={frame:e/r.sample,func:t||"",params:a||[]},r.events=r.events||[],r.events.push(e),r.events.sort((e,t)=>e.frame-t.frame),this.updateEventData(),!0):(console.log("Clip doesn't exist"),null))}_getEditClip(){var e=this._getAnimState();return e?e.clip||(console.log("Clip doesn't exist"),null):null}addEmbeddedPlayerGroup(t){var e=this._getEditClip();if(!e||!t.key||!t.type)return!1;if(e[cc_1.editorExtrasTag]&&e[cc_1.editorExtrasTag].embeddedPlayerGroups){if(e[cc_1.editorExtrasTag].embeddedPlayerGroups.find(e=>e.key===t.key))return!1}else e[cc_1.editorExtrasTag]={embeddedPlayerGroups:[]};return e[cc_1.editorExtrasTag].embeddedPlayerGroups.push({key:t.key,name:t.name,type:t.type}),!0}async removeEmbeddedPlayerGroup(t){var e=this._getEditClip();return!!e&&(e[cc_1.editorExtrasTag].embeddedPlayerGroups=e[cc_1.editorExtrasTag].embeddedPlayerGroups.filter(e=>e.key!==t),this._clearEmbeddedPlayerGroup(t),await this.applyEditorEmbeddedPlayersToClip(),this.updateEditorEmbeddedPlayers(),!0)}_clearEmbeddedPlayerGroup(t){return Object.keys(this._editEmbeddedPlayerMap).forEach(e=>{this._editEmbeddedPlayerMap[e].group===t&&delete this._editEmbeddedPlayerMap[e]}),!0}async clearEmbeddedPlayerGroup(e){return this._clearEmbeddedPlayerGroup(e),await this.applyEditorEmbeddedPlayersToClip(),this.updateEditorEmbeddedPlayers(),!0}async addEmbeddedPlayer(e){return!(e.end<e.begin||e.begin<0||!this._addEmbeddedPlayer(e)||(await this.applyEditorEmbeddedPlayersToClip(),this.updateEditorEmbeddedPlayers(),0))}_addEmbeddedPlayer(e){var t=utils_1.utils.calcEmbeddedPlayerKey(e);return this._editEmbeddedPlayerMap||(this._editEmbeddedPlayerMap={}),this._editEmbeddedPlayerMap[t],this._editEmbeddedPlayerMap[t]=e,!0}async deleteEmbeddedPlayer(e){return!!this._deleteEmbeddedPlayer(e)&&(await this.applyEditorEmbeddedPlayersToClip(),this.updateEditorEmbeddedPlayers(),!0)}async clearEmbeddedPlayer(e){delete this._editEmbeddedPlayerMap[e],await this.applyEditorEmbeddedPlayersToClip(),this.updateEditorEmbeddedPlayers()}_deleteEmbeddedPlayer(e){e=utils_1.utils.calcEmbeddedPlayerKey(e);return!!this._editEmbeddedPlayerMap[e]&&(delete this._editEmbeddedPlayerMap[e],!0)}async updateEmbeddedPlayer(e,t){if(!this._getEditClip())return!1;e=utils_1.utils.calcEmbeddedPlayerKey(e);if(!this._editEmbeddedPlayerMap[e])return!1;delete this._editEmbeddedPlayerMap[e];e=utils_1.utils.calcEmbeddedPlayerKey(t);return this._editEmbeddedPlayerMap[e]=t,await this.applyEditorEmbeddedPlayersToClip(),this.updateEditorEmbeddedPlayers(),!0}_deleteEvent(e){var t=this._getAnimState();if(!t)return!1;if(null==e)return!1;Array.isArray(e)||(e=[e]);t=t.clip;if(!t)return console.log("Clip doesn't exist"),!1;const r=t.events;if(!r)return!1;const i=t.sample,n=[];return e.forEach(t=>{for(let e=r.length-1;0<=e;e--){var a=r[e];Math.round(a.frame*i)===t&&(r.splice(e,1),n.push(a))}}),!0}deleteEvent(e){e=this._deleteEvent(e);return this.updateEventData(),e}updateEvent(e,a){return!!this._getAnimState()&&null!=e&&((e=Array.isArray(e)?e:[e]).forEach(t=>{if(!this.deleteEvent([t]))return!1;a&&a.forEach(e=>{this.addEvent(t,e.func,e.params)})}),this.updateEventData(),!0)}moveEvents(t,a){var e=this._getAnimState();if(!e)return!1;if(null==t)return!1;var r=utils_1.utils.queryEvents(e.clip);if(!r)return!1;var i=e.clip.sample;for(let e=0;e<r.length;e++){var n=r[e],s=Math.round(n.frame*i);if(0<=t.indexOf(s)){let e=s+a;e<0&&(e=0),n.frame=e/i}}return this.updateEventData(),!0}copyEventsTo(t,a){if(!t||t.length<=0)return!1;var e=this._getAnimState();if(!e)return!1;var r=utils_1.utils.queryEvents(e.clip);if(!r)return!1;t.sort((e,t)=>e-t);var i=e.clip.sample,n=t[0],s=[];for(let e=0;e<r.length;e++){var u=r[e],o=Math.round(u.frame*i);if(0<=t.indexOf(o)){let e=o-n+a;e<0&&(e=0),s.push({frame:e,func:u.func,params:u.params})}}return s.forEach(e=>{this.addEvent(e.frame,e.func,e.params)}),this.updateEventData(),!0}async modifyCurveOfKey(e,t,a,r){return!!this._getAnimState()&&!!(e=this.getCreatedCurve(e,t))&&!(!(t=null==(t=e.curveInfo.type)?void 0:t.value)||!utils_1.allowModifyCurveType.includes(t)||!e.modifyCurveOfKey(a,r)||(await this.updateCurveData(),0))}async getPropValueAtFrame(e,t,a){var e=this.getCreatedCurve(e,t);return e?(e=await e.getPropValueAtFrame(a),"2d"===cce.SceneFacadeManager._projectType&&e&&("position"===t&&(e.lock={z:{default:0,message:"i18n:scene.is3DValueWarn"}}),"rotation"===t&&(e.lock={x:{default:0,message:"i18n:scene.is3DValueWarn"},y:{default:0,message:"i18n:scene.is3DValueWarn"}}),"eulerAngles"===t&&(e.lock={x:{default:0,message:"i18n:scene.is3DValueWarn"},y:{default:0,message:"i18n:scene.is3DValueWarn"}}),"scale"===t)&&(e.lock={z:{default:1,message:"i18n:scene.is3DValueWarn"}}),e):null}_getRawAuxiliaryCurves(e){var t=[];for(const r of e.getAuxiliaryCurveNames_experimental()){var a=e.getAuxiliaryCurve_experimental(r);null!=a&&t.push({name:r,curve:a})}return t}_initAuxCurves(e){var t=this._getAnimState(),a=this._rootNode,r=this._getRawAuxiliaryCurves(t.clip),i=this._createdAuxCurveMap,n=this.generateClipData(t.clip);for(const u of r){i.has(u.name)&&Editor.App.dev&&console.warn(`auxiliary curve named "${u.name}" already exists`);var s=(0,editor_animation_aux_curve_1.createEditorCurve)(u.name,u.curve,a,n);this.addAuxCurve(s)}}async getAuxiliaryCurves(){var e={};for(const a of this._getAnimState().clip.getAuxiliaryCurveNames_experimental()){var t=this._createdAuxCurveMap.get(a);void 0!==t&&(t=await t.getDumpData(),e[a]=t)}return e}addAuxiliaryCurve(e){var t=this._animState.clip,a=t.addAuxiliaryCurve_experimental(e),t=this.generateClipData(t),e=(0,editor_animation_aux_curve_1.createEditorCurve)(e,a,this._rootNode,t);return this.addAuxCurve(e),null!==a}renameAuxiliaryCurve(e,t){var a=this._createdAuxCurveMap.get(e),a=(null!=a&&(this._auxCurves.delete(a),this._createdAuxCurveMap.delete(a.curveInfo.displayName)),this._animState.clip),r=this.generateClipData(a),e=(a.renameAuxiliaryCurve_experimental(e,t),a.getAuxiliaryCurve_experimental(t)),a=(0,editor_animation_aux_curve_1.createEditorCurve)(t,e,this._rootNode,r);return this.addAuxCurve(a),!0}removeAuxiliaryCurve(e){var t=this._createdAuxCurveMap.get(e);return t?(this._animState.clip.removeAuxiliaryCurve_experimental(e),this._createdAuxCurveMap.delete(e),this._auxCurves.delete(t)):Editor.App.dev&&console.warn(`auxiliary curve "${e}" has already been removed`),!0}async createAuxKey(e,t,a){return!(!Number.isFinite(t)||t<0||!this._getAnimState()||!(e=this.getCreatedAuxCurve(e))||!await e.createKey(t,a)||(this.updateCurveData(),this.applyAuxCurvesToClip(),0))}async removeAuxKey(e,t){return!(!Number.isFinite(t)||t<0||(await this.getCreatedAuxCurve(e,!0).removeKey([t]),await this.updateCurveData(),this.applyAuxCurvesToClip(),0))}async moveAuxKeys(e,t,a){var e=this.getCreatedAuxCurve(e);return!!e&&(!0===(e=await e.moveKeys(t,Array.isArray(a)?a:[a]))&&(await this.updateCurveData(),this.applyAuxCurvesToClip()),e)}async copyAuxKey(e,t){return this.getCreatedAuxCurve(t.name,!0).createKey(t.frame,e.data).then(e=>(this.applyAuxCurvesToClip(),e))}async modifyAuxCurveOfKey(e,t,a){var e=this.getCreatedAuxCurve(e,!0),r=null==(r=e.curveInfo.type)?void 0:r.value;return!("string"!=typeof r||!utils_1.allowModifyCurveType.includes(r))&&((r=await e.modifyCurveOfKey(t,a))&&this.applyAuxCurvesToClip(),r)}async getAuxCurveValueAtFrame(e,t){e=this.getCreatedAuxCurve(e);return e?await e.getPropValueAtFrame(t):null}_getAnimState(){return this._animState}}exports.default=EditorAnimationClip;