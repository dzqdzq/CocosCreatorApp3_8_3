"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var i=Object.getOwnPropertyDescriptor(t,a);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,i)}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.EditorAnimationCurve=void 0;const cc_1=require("cc"),editor_animation_curve_base_1=__importDefault(require("./editor-animation-curve-base")),utils_1=require("./utils"),dumpEncode=__importStar(require("../../../export/dump/encode"));class EditorAnimationCurve extends editor_animation_curve_base_1.default{get parentCurve(){return this._parentCurve}set parentCurve(e){this._parentCurve=e}get isPartCurve(){return this._parentCurve}get partName(){return this._curveInfo.partName}get targetPaths(){return this._curveInfo.targetPaths}get combinedPropKey(){var e=this._curveInfo.propKey.lastIndexOf(".");return this._curveInfo.propKey.substring(0,e)}get combinedCurveKeyData(){return null}get combinedDisplayName(){var e=this._curveInfo.displayName.lastIndexOf(".");return this._curveInfo.displayName.substring(0,e)}get displayName(){let t=this._curveInfo.displayName;if(this.isPartCurve){var a=this._curveInfo.displayName.lastIndexOf("."),r=this._curveInfo.displayName.substring(0,a),i=this._curveInfo.displayName.substring(a+1);let e="";0<=(a=r.lastIndexOf("."))&&(e=r.substring(a+1)+"."),t=e+i}return t}constructor(e,t){super(),this._parentCurve=null,this.isActive=!0,this._node=e,this._clipData=t}async getDumpData(){var e=utils_1.utils.dumpKeyframeData(this._keyframeData),t=null==(t=this._curveInfo.type)?void 0:t.value,t=utils_1.utils.isTypeSupportCurve(t);return{nodePath:this._curveInfo.nodePath,keyframes:e,displayName:this.displayName,key:this._curveInfo.propKey,type:this._curveInfo.type,preExtrap:this.preExtrap,postExtrap:this.postExtrap,isCurveSupport:t}}getCompName(){return this._curveInfo.compName}getPropName(){return this._curveInfo.propName}changeNodePath(e){var t,a=null;(a=this._curveInfo.targetPaths)&&0<a.length&&(a.isHierarchyAt(0)?"/"===e?this._curveInfo.targetPaths=a.slice(1):(t=e.substr(1),this._curveInfo.targetPaths=(new cc_1.animation.TrackPath).toHierarchy(t).append(a.slice(1))):"/"!==e&&(t=e.substr(1),this._curveInfo.targetPaths=(new cc_1.animation.TrackPath).toHierarchy(t).append(a))),this._curveInfo.nodePath=utils_1.utils.getNodePath(this._curveInfo.targetPaths)}queryKeyIndex(t){if(this._keyframeData)for(let e=0;e<this._keyframeData.length;e++)if(this._keyframeData[e].frame===t)return e;return-1}queryKeyframe(t){if(this._keyframeData)for(let e=0;e<this._keyframeData.length;e++){var a=this._keyframeData[e];if(a.frame===t)return a}return null}getValidKeys(t){if(!this._keyframeData)return null;var a=[];for(let e=0;e<this._keyframeData.length;e++){var r=this._keyframeData[e].frame;t.includes(r)&&a.push(r)}return a}hasKey(e){return null!==this.queryKeyframe(e)}async createKey(t=0,a){var r=this.propData,i=await utils_1.utils.getValueFrom(this._node,r,a),s=this.queryKeyframe(t);if(s)s.value=i,a&&utils_1.utils.copyCurveData(a,s);else{let e=0;for(e=0;e<this._keyframeData.length&&!(this._keyframeData[e].frame>t);e++);s={frame:t,value:i,interpMode:cc_1.RealInterpolationMode.LINEAR};utils_1.utils.isTypeSupportCurve(null==(i=r.type)?void 0:i.value)&&(s.inTangent=0,s.inTangentWeight=1,s.outTangent=0,s.outTangentWeight=1,s.tangentWeightMode=cc_1.TangentWeightMode.NONE,s.tangentMode=0),a&&utils_1.utils.copyCurveData(a,s),this._keyframeData.splice(e,0,s),this._isDirty=!0}return!0}async moveKeys(t,s){if(!this._keyframeData)return!1;var n=[];for(let e=0;e<t.length;e++){var a=t[e],a=this.queryKeyIndex(a);if(a<0)return!1;n.push(this._keyframeData[a]),this._keyframeData.splice(a,1)}for(let e=0;e<n.length;e++){var u=n[e];let t=u.frame+s[e],a=(t<0&&(t=0),0),r=!1,i=!1;if(0<this._keyframeData.length){for(let e=0;e<this._keyframeData.length;e++){var l=this._keyframeData[e].frame;if(l>=t){a=e,r=!0,l===t&&(i=!0);break}}r||(t<=this._keyframeData[0].frame?a=0:t>this._keyframeData[this._keyframeData.length-1].frame&&(a=this._keyframeData.length))}var o=i?1:0,h={frame:t,value:u.value};utils_1.utils.copyCurveData(u,h),this._keyframeData.splice(a,o,h)}return this._isDirty=!0}async removeKey(e){return e.forEach(e=>{e=this.queryKeyIndex(e);e<0||this._keyframeData.splice(e,1)}),this._isDirty=!0}async updateKey(t){var a=this.propData;for(let e=0;e<t.length;e++){var r=t[e],r=this.queryKeyframe(r);if(!r)return!1;var i=await utils_1.utils.getValueFrom(this._node,a,null);r.value=i}return this._isDirty=!0}async copyKeysTo(t,a){for(let e=0;e<t.length;e++){var r,i=t[e],s=this.queryKeyframe(i);s&&(r={newValue:s.value},utils_1.utils.copyCurveData(s,r),await this.createKey(a+i-t[0],r))}return this._isDirty=!0}async spacingKeys(t,a){if(t.sort((e,t)=>e-t),1<t.length){var r=t[0],i=[],s=[];for(let e=1;e<t.length;e++)i.push(t[e]),s.push(r+e*a-t[e]);return this.moveKeys(i,s),this._isDirty=!0}return!1}async clearKeys(){return this._keyframeData=[],!0}async modifyCurveOfKey(e,t){e=this.queryKeyframe(e);return!!e&&(utils_1.utils.copyCurveData(t,e),this._isDirty=!0)}getCurveDuration(){let e=0;var t,a,r,i;return this._keyframeData&&0<this._keyframeData.length&&(t=this._keyframeData[this._keyframeData.length-1].frame,a=this.getCompName(),r=this.getPropName(),i=this.getClipSample(),e=a===cc_1.js.getClassName(cc_1.Sprite)&&"spriteFrame"===r?(t+1)/i:t/i),e}async getPropValueAtFrame(a){var r;let i=null;var s=this.propData;if(0===this._keyframeData.length){let e=await utils_1.utils.getValueFrom(this._node,s);null!==(e=null!==e&&void 0!==e?e:utils_1.utils.getDefaultValue(null==(r=s.type)?void 0:r.value))&&void 0!==e&&(i=dumpEncode.encodeObject(e,{default:void 0}))}else{const n=this.getClipSample();let e=null;switch(this.curveInfo.type.value){case"cc.Quat":(e=new cc_1.QuatCurve).assignSorted(this._keyframeData.map(e=>[e.frame/n,{value:e.value}])),e.preExtrapolation=this.preExtrap,e.postExtrapolation=this.postExtrap;break;case"cc.Number":case"Number":case"Integer":case"Float":(e=new cc_1.RealCurve).assignSorted(this._keyframeData.map(e=>[e.frame/n,{value:e.value,interpolationMode:e.interpMode,leftTangent:e.inTangent,rightTangent:e.outTangent,leftTangentWeight:e.inTangentWeight,rightTangentWeight:e.outTangentWeight,tangentWeightMode:e.tangentWeightMode}])),e.preExtrapolation=this.preExtrap,e.postExtrapolation=this.postExtrap;break;default:(e=new cc_1.ObjectCurve).assignSorted(this._keyframeData.map(e=>[e.frame/n,e.value]))}let t=e.evaluate(a/n);null!==(t=null!==t&&void 0!==t?t:utils_1.utils.getDefaultValue(null==(r=s.type)?void 0:r.value))&&void 0!==t&&(i=dumpEncode.encodeObject(t,{default:void 0}))}return i}}exports.EditorAnimationCurve=EditorAnimationCurve,exports.default=EditorAnimationCurve;