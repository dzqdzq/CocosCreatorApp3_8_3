"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var i=Object.getOwnPropertyDescriptor(t,a);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,i)}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),editor_animation_curve_1=__importDefault(require("./editor-animation-curve")),editor_animation_curve_base_1=__importDefault(require("./editor-animation-curve-base")),utils_1=require("./utils"),uniform_handler_1=require("./uniform-handler"),dumpEncode=__importStar(require("../../../export/dump/encode"));class EditorAnimationCombinedCurve extends editor_animation_curve_base_1.default{get maxPartNumber(){return this._maxPartNumber}set maxPartNumber(e){this._maxPartNumber=e}get curveInfo(){return this._curveInfo}set curveInfo(e){super.curveInfo=e}constructor(e,t){super(),this.canMerge=!0,this._partEditorAnimCurves=[],this._maxPartNumber=0,this._node=e,this._clipData=t}updateType(t){t&&(this._curveInfo.type=t,this._partEditorAnimCurves.forEach(e=>{e.curveInfo.combinedType=t}))}async getDumpData(){await this.updateCurveData();var e,t=utils_1.utils.dumpKeyframeData(this._keyframeData);let a=!1;return this._partEditorAnimCurves&&0<this._partEditorAnimCurves.length&&(e=null==(e=this._partEditorAnimCurves[0].curveInfo.type)?void 0:e.value,a=utils_1.utils.isTypeSupportCurve(e)),{nodePath:this._curveInfo.nodePath,keyframes:t,displayName:this._curveInfo.displayName,key:this._curveInfo.propKey,type:this._curveInfo.type,isCurveSupport:a}}getClipSample(){return this._clipData.sharedData.sample}getClipDuration(){return this._clipData.sharedData.duration}changeNodePath(e){var t=this._curveInfo.targetPaths;0<t.length&&(t.isHierarchyAt(0)?"/"===e?this._curveInfo.targetPaths=this._curveInfo.targetPaths.slice(1):(t=e.substr(1),this._curveInfo.targetPaths=(new cc_1.animation.TrackPath).toHierarchy(t).append(this._curveInfo.targetPaths.slice(1))):"/"!==e&&(t=e.substr(1),this._curveInfo.targetPaths=(new cc_1.animation.TrackPath).toHierarchy(t).append(this._curveInfo.targetPaths))),this._curveInfo.nodePath=utils_1.utils.getNodePath(this._curveInfo.targetPaths)}initFromTrack(e,t){this._curveInfo=e,this._partEditorAnimCurves=[];var e=null==(e=this._curveInfo.type)?void 0:e.value,a=utils_1.utils.getPartsOfType(e);if(a){let r=null;const h=uniform_handler_1.uniformHandler.isUniformCurve(this._curveInfo.valueAdapter);h&&(r=uniform_handler_1.uniformHandler.getValueToArrayIndexMapByType(e)),this.maxPartNumber=a.length,a.forEach(e=>{var t,a=this.curveInfo.targetPaths.slice().toProperty(e),a={nodePath:this._curveInfo.nodePath,propKey:this._curveInfo.propKey+"."+e,combinedType:this._curveInfo.type,type:{value:"Number"},targetPaths:a,partName:e,displayName:this._curveInfo.displayName+"."+e,propName:this._curveInfo.propName,compName:this._curveInfo.compName},e=(h&&(a.targetPaths=this._curveInfo.targetPaths,t=utils_1.utils.cloneCCClass(this._curveInfo.valueAdapter),r&&(e=r[e],t.channelIndex=e),a.valueAdapter=t),new editor_animation_curve_1.default(this._node,this._clipData));e.curveInfo=a,(e.parentCurve=this)._partEditorAnimCurves.push(e)});var i=t.channels();for(let e=0;e<this._partEditorAnimCurves.length;e++)if(e<i.length){var n=this._partEditorAnimCurves[e],s=i[e].curve;if(n.partName&&s){var u,o,l=[];for([u,o]of s.keyframes())l.push({frame:Math.round(u*this._clipData.sharedData.sample),value:o.value,inTangent:o.leftTangent,inTangentWeight:o.leftTangentWeight,outTangent:o.rightTangent,outTangentWeight:o.rightTangentWeight,interpMode:o.interpolationMode,tangentWeightMode:o.tangentWeightMode,easingMethod:o.easingMethod});n.keyframeData=l}}this.updateCurveData()}}async updateCurveData(){let n=new Map;await this.iteratorPartAnimCurves(async(e,t)=>{var a=e.keyframeData;if(a)for(let e=0;e<a.length;e++){var r=a[e];if(!n.has(r.frame)){let e=await utils_1.utils.getValueFrom(this._node,this.propData);var i={value:e=void 0===e&&this.propData.type?utils_1.utils.getDefaultValue(this.propData.type.value):e,keyNumber:0,isEasingMethodSame:!0};n.set(r.frame,i)}i=n.get(r.frame);i&&(i.keyNumber++,void 0!==i.value)&&null!==i.value&&(i.value[t]=r.value)}}),n=new Map([...n.entries()].sort((e,t)=>e[0]-t[0])),this._keyframeData=[],n.forEach((e,t)=>{t={frame:t,value:e.value};this._keyframeData.push(t)}),this.canMerge=!0;var t=Array.from(n.values());for(let e=0;e<t.length;e++){var a=t[e];if(a.keyNumber!==this.maxPartNumber||!a.isEasingMethodSame){this.canMerge=!1;break}}this._partEditorAnimCurves.forEach(e=>{e.isActive=!this.canMerge})}separateDataIntoParts(){this._partEditorAnimCurves=[];var e=null==(e=this._curveInfo.type)?void 0:e.value,t=utils_1.utils.getPartsOfType(e);if(t){let r=null;const o=uniform_handler_1.uniformHandler.isUniformCurve(this._curveInfo.valueAdapter);o&&(r=uniform_handler_1.uniformHandler.getValueToArrayIndexMapByType(e)),this.maxPartNumber=t.length,t.forEach(e=>{var t,a=this.curveInfo.targetPaths.slice().toProperty(e),a={nodePath:this._curveInfo.nodePath,propKey:this._curveInfo.propKey+"."+e,combinedType:this._curveInfo.type,type:{value:"Number"},targetPaths:a,partName:e,displayName:this._curveInfo.displayName+"."+e,propName:this._curveInfo.propName,compName:this._curveInfo.compName},e=(o&&(a.targetPaths=this._curveInfo.targetPaths,t=utils_1.utils.cloneCCClass(this._curveInfo.valueAdapter),r&&(e=r[e],t.channelIndex=e),a.valueAdapter=t),new editor_animation_curve_1.default(this._node,this._clipData));e.curveInfo=a,(e.parentCurve=this)._partEditorAnimCurves.push(e)});for(let e=0;e<this._partEditorAnimCurves.length;e++){var a=this._partEditorAnimCurves[e],i=a.partName;if(i){var n=[];for(let t=0;t<this._keyframeData.length;t++){var s=this._keyframeData[t],u=s.value;let e=0;void 0!==u&&(e=u[i]),n.push({frame:s.frame,value:e})}a.keyframeData=n}}}}addPartEditorAnimCurve(e){this._partEditorAnimCurves.push(e),this.maxPartNumber<this._partEditorAnimCurves.length&&(this.maxPartNumber=this._partEditorAnimCurves.length)}getPartEditorAnimCurves(){return this._partEditorAnimCurves}async iteratorPartAnimCurves(t){for(let e=0;e<this._partEditorAnimCurves.length;e++){var a=this._partEditorAnimCurves[e],r=a.partName;r&&await t(a,r)}}hasKey(t){let a=!1;return this._partEditorAnimCurves.forEach(e=>{e.hasKey(t)&&(a=!0)}),a}async createKey(r=0,i){let n=!0;return await this.iteratorPartAnimCurves(async(e,t)=>{let a;i&&i.newValue&&(a={newValue:i.newValue[t]}),await e.createKey(r,a)||(n=!1)}),this._isDirty=!0,n}async moveKeys(r,i){let n=!0;return this._partEditorAnimCurves.forEach(e=>{var t=e.getValidKeys(r);const a=[];t&&0<t.length&&(t.forEach(e=>{e=r.indexOf(e);a.push(i[e])}),e.moveKeys(t,a)||(n=!1))}),this._isDirty=!0,n}async removeKey(a){let r=!0;return this._partEditorAnimCurves.forEach(e=>{var t=e.getValidKeys(a);t&&0<t.length&&(e.removeKey(t)||(r=!1))}),this._isDirty=!0,r}async updateKey(a){let r=!0;return await this.iteratorPartAnimCurves(async e=>{var t=e.getValidKeys(a);t&&0<t.length&&(await e.updateKey(t)||(r=!1))}),this._isDirty=!0,r}async copyKeysTo(a,r){let i=!0;return await this.iteratorPartAnimCurves(async e=>{var t=e.getValidKeys(a);t&&0<t.length&&(await e.copyKeysTo(t,r)||(i=!1))}),this._isDirty=!0,i}async spacingKeys(a,r){let i=!0;return this._partEditorAnimCurves.forEach(e=>{var t=e.getValidKeys(a);t&&0<t.length&&(e.spacingKeys(t,r)||(i=!1))}),this._isDirty=!0,i}async clearKeys(){let t=!0;return this._partEditorAnimCurves.forEach(e=>{e.clearKeys()||(t=!1)}),this._isDirty=!0,t}async modifyCurveOfKey(t,a){let r=!0;return this._partEditorAnimCurves.forEach(e=>{!e.hasKey(t)||e.modifyCurveOfKey(t,a)||(r=!1)}),this._isDirty=!0,r}async getPropValueAtFrame(i){var t;let a=null;var n=this.propData;if(0===this._keyframeData.length){let e=await utils_1.utils.getValueFrom(this._node,n);null!==(e=null!==e&&void 0!==e?e:utils_1.utils.getDefaultValue(null==(t=n.type)?void 0:t.value))&&void 0!==e&&(a=dumpEncode.encodeObject(e,{default:void 0}))}else{const s=this.getClipSample();let r=await utils_1.utils.getValueFrom(this._node,n);null!==r&&void 0!==r||(r=utils_1.utils.getDefaultValue(null==(t=n.type)?void 0:t.value)),await this.iteratorPartAnimCurves(async(e,t)=>{var e=e.keyframeData,a=new cc_1.RealCurve;a.assignSorted(e.map(e=>[e.frame/s,{value:e.value,interpolationMode:e.interpMode,leftTangent:e.inTangent,rightTangent:e.outTangent,leftTangentWeight:e.inTangentWeight,rightTangentWeight:e.outTangentWeight,tangentWeightMode:e.tangentWeightMode}])),r[t]=a.evaluate(i/s)}),null!==(r=null!==r&&void 0!==r?r:utils_1.utils.getDefaultValue(null==(t=n.type)?void 0:t.value))&&void 0!==r&&(a=dumpEncode.encodeObject(r,{default:void 0}))}return a}}exports.default=EditorAnimationCombinedCurve;