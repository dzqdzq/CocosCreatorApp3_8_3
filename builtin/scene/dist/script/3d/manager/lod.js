"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LODManager=void 0;const cc_1=require("cc"),camera_1=__importDefault(require("./camera")),component_1=__importDefault(require("./component")),lod_group_utils_1=require("cc/editor/lod-group-utils"),selection_1=__importDefault(require("./selection")),node_1=__importDefault(require("./node")),component_2=__importDefault(require("./component"));class LODManager{constructor(){this._selectedUUIDs=[],this._selectedMeshRendererSet=new Set,this._selectedLODSet=new Set}onResize(e){}onSceneOpened(e){}onSceneReload(e){}onSceneClosed(e){}onNodeChanged(e,t){}onAddNode(e){}onRemoveNode(e){}onNodeAdded(e,t){}onNodeRemoved(e,t){}onAddComponent(e){}onRemoveComponent(e){}onComponentAdded(e,t){}onComponentRemoved(e,t){}applyCurrentCameraSize(e){e=component_1.default.query(e);return e instanceof cc_1.LODGroup?lod_group_utils_1.LODGroupEditorUtility.getRelativeHeight(e,camera_1.default.camera.camera):null}onSelect(e,t){for(let e=0;e<t.length;e++){var n,o=t[e];this._selectedUUIDs.includes(o)||(o=node_1.default.query(o))&&((n=o.getComponent(cc_1.MeshRenderer))&&this.onSelectMeshRenderer(n),(o=o.getComponent(cc_1.LODGroup))&&this.onSelectLOD(o),o||n)&&this.updateAllLODGroupLockedVisibility()}this._selectedUUIDs.length=0,this._selectedUUIDs.push(...t)}onUnselect(e,t){for(let e=0;e<this._selectedUUIDs.length;e++){var n,o=this._selectedUUIDs[e];t.includes(o)||(o=node_1.default.query(o))&&((n=o.getComponent(cc_1.MeshRenderer))&&this.onUnselectMeshRenderer(n),(o=o.getComponent(cc_1.LODGroup))&&this.onUnselectLOD(o),o||n)&&this.updateAllLODGroupLockedVisibility()}this._selectedUUIDs.length=0,this._selectedUUIDs.push(...t)}onSelectMeshRenderer(e){this._selectedMeshRendererSet.add(e)}onUnselectMeshRenderer(e){this._selectedMeshRendererSet.has(e)&&this._selectedMeshRendererSet.delete(e)}onSelectLOD(e){this._selectedLODSet.add(e)}onUnselectLOD(e){this._selectedLODSet.has(e)&&this._selectedLODSet.delete(e)}updateAllLODGroupLockedVisibility(){var e;null!=(e=cc_1.director.getScene())&&e.getComponentsInChildren(cc_1.LODGroup).forEach(n=>{var e;n.enabled&&(e=n.LODs.map((e,t)=>{if(!this._selectedLODSet.has(n)&&e.renderers.some(e=>e&&this._selectedMeshRendererSet.has(e)))return t}).filter(e=>"number"==typeof e),n.forceLODs(e))})}insertLOD(e,...t){e=component_2.default.query(e);e instanceof cc_1.LODGroup&&(e.insertLOD(...t),cce.Node.emit("change",e.node))}eraseLOD(e,...t){e=component_2.default.query(e);e instanceof cc_1.LODGroup&&(e.eraseLOD(...t),cce.Node.emit("change",e.node))}init(){null==this._onSelect&&(this._onSelect=this.onSelect.bind(this)),null==this._onUnselect&&(this._onUnselect=this.onUnselect.bind(this)),selection_1.default.on("select",this._onSelect),selection_1.default.on("unselect",this._onUnselect)}}exports.LODManager=LODManager,exports.default=new LODManager;