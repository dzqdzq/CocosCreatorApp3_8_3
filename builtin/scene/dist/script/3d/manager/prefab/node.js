"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.nodeOperation=void 0;const cc_1=require("cc"),utils_1=require("./utils"),component_1=require("./component"),node_1=__importDefault(require("../node")),component_2=__importDefault(require("../component")),util_1=require("util"),node_2=__importDefault(require("../../../utils/node")),event_enum_1=require("../../../../script/public/event-enum"),scene_facade_state_interface_1=require("../../facade/scene-facade-state-interface"),timer_util_1=require("../../utils/timer-util"),scene_1=__importDefault(require("../scene")),undo_1=require("../../../export/undo"),serialize_1=require("../../../export/serialize"),PrefabInfo=cc_1.Prefab._utils.PrefabInfo,PropertyOverrideInfo=cc_1.Prefab._utils.PropertyOverrideInfo,CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo,TargetInfo=cc_1.Prefab._utils.TargetInfo,TargetOverrideInfo=cc_1.Prefab._utils.TargetOverrideInfo,RootReservedProperty=["_name","_lpos","_lrot","_euler"],compKey="_components",diffExcludePropMap={"cc.Node":["_objFlags","_parent","_children","_components","_prefab",cc_1.editorExtrasTag],"cc.Component":["node","_objFlags",cc_1.editorExtrasTag]};function getDiffExcludeProps(r){let a=[];return Object.keys(diffExcludePropMap).forEach(e=>{var t=cc_1.js.getClassByName(e);t&&cc_1.js.isChildClassOf(r,t)&&(a=a.concat(diffExcludePropMap[e]))}),a}class ApplyPrefabCommand extends undo_1.SceneUndoCommand{constructor(e,t){super(),this.applyPrefabInfo=null,this._undoFunc=e,this._redoFunc=t}async undo(){this.applyPrefabInfo&&await this._undoFunc(this.applyPrefabInfo)}async redo(){this.applyPrefabInfo&&await this._redoFunc(this.applyPrefabInfo.nodeUUID)}}class CreatePrefabCommand extends undo_1.SceneUndoCommand{async undo(){await this.applyData(this.undoData)}async redo(){await this.applyData(this.redoData)}}class RevertPrefabCommand extends CreatePrefabCommand{constructor(){super(...arguments),this.tag="RevertPrefabCommand"}}class NodeOperation{constructor(){this.assetToNodesMap=new Map,this.isRemovingMountedChildren=!1,this._timerUtil=new timer_util_1.TimerUtil}onSceneOpened(e){this.assetToNodesMap.clear(),component_1.componentOperation.clearCompCache(),utils_1.prefabUtils.clearCache(),this._timerUtil.clear(),node_1.default.queryUuids().forEach(e=>{e=node_1.default.query(e);e instanceof cc_1.Scene||e&&!node_2.default.isEditorNode(e)&&(this.checkToAddPrefabAssetMap(e),e.components.forEach(e=>{component_1.componentOperation.cacheComp(e)}))})}onNodeRemoved(e){var t=e._prefab;(null==t?void 0:t.instance)&&null!=t&&t.asset&&(t=this.assetToNodesMap.get(t.asset._uuid))&&0<=(e=t.indexOf(e))&&t.splice(e,1)}checkToAddOverrides(r,e,a){if(r&&e){var n=e.replace(/^__comps__/,compKey);const s=(n||"").split(".");var o=utils_1.prefabUtils.getPrefab(r);let t=null;e!==n&&s[0]===compKey&&(t=r[s[0]][s[1]]);e=o&&!(null!=(n=null==(e=o.root)?void 0:e._prefab)&&n.instance);!o||e||t&&utils_1.prefabUtils.isMountedComponent(t)?a&&this.addTargetOverrideWithModifyPath(r,s,a):t&&2===s.length?t.constructor.__props__.forEach(e=>{!1!==cc.Class.attr(t,e).visible&&this.checkToAddPropertyOverrides(r,[...s,e],a)}):this.checkToAddPropertyOverrides(r,s,a)}}onNodeChangedInGeneralMode(e,t,r){var a;t&&(t.type===event_enum_1.NodeEventType.CHILD_CHANGED?this.updateChildrenData(e):(t.type===event_enum_1.NodeEventType.PARENT_CHANGED&&t.modeName===scene_facade_state_interface_1.SceneModeType.Prefab&&(a=null==(a=e._prefab)?void 0:a.instance)&&(a.prefabRootNode=r),"children"===t.propPath&&t.type===event_enum_1.NodeOperationType.MOVE_ARRAY_ELEMENT||(t.propPath&&(a=e.uuid+"|"+t.propPath,this._timerUtil.callFunctionLimit(a,this.checkToAddOverrides.bind(this),e,t.propPath,r)),this._timerUtil.callFunctionLimit(e.uuid,this.updateSpecialComponent.bind(this),e,t.propPath,r))))}updateSpecialComponent(t,e,r){if("position"===e){const a=t.getComponent(cc_1.Widget);if(a&&!utils_1.prefabUtils.isMountedComponent(a)){const n=t.components.indexOf(a),o={isAlignLeft:"left",isAlignRight:"right",isAlignHorizontalCenter:"horizontalCenter",isAlignTop:"top",isAlignBottom:"bottom",isAbsoluteVerticalCenter:"verticalCenter"};Object.keys(o).forEach(e=>{a[e]&&this.checkToAddPropertyOverrides(t,["_components",""+n,o[e]],r)})}}}onAddNode(e){var t=e.parent;t&&(this.updateChildrenData(t),this.createReservedPropertyOverrides(e))}onNodeAdded(e,t){var r,a,n;this.checkToAddPrefabAssetMap(e),t.modeName===scene_facade_state_interface_1.SceneModeType.Prefab&&(t=utils_1.prefabUtils.getPrefab(e),a=scene_1.default.rootNode)&&(n=utils_1.prefabUtils.getPrefab(a))&&(null!=t&&t.instance?t.instance.prefabRootNode=null!=(r=t.instance.prefabRootNode)?r:n.root:t&&null!=(t=null==(r=t.root)?void 0:r._prefab)&&t.instance||(n.root||(console.warn("root of PrefabInfo is null, set to root node"),n.root=a),utils_1.prefabUtils.addPrefabInfo(e,n.root,n.asset)))}checkToAddTargetOverride(t,r,a){if(t instanceof cc_1.Component){var n=r.value;const l=a._prefab;if(null==n&&t)utils_1.prefabUtils.removeTargetOverride(l,t,r.pathKeys);else{let e=null;if(n instanceof cc_1.Node?e=n:n instanceof cc_1.Component&&(e=n.node),e)if(utils_1.prefabUtils.getPrefab(e)){var o=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(e),s=o.outMostPrefabInstanceNode;if(s)if(n instanceof cc_1.Node&&s===n)utils_1.prefabUtils.removeTargetOverride(l,t,r.pathKeys);else{o=o.targetPath;if(null==(i=s._prefab)?void 0:i.instance){if(o.splice(0,1),n instanceof cc_1.Node){var i=n._prefab;if(!i||!i.fileId)return console.error("can't get fileId of prefab node: "+n.name),!1;o.push(i.fileId)}else if(n instanceof cc_1.Component){i=n.__prefab;if(!i||!i.fileId)return utils_1.prefabUtils.getMountedRoot(n)||console.error(`can't get fileId of prefab component: ${n.name} in node: `+n.node.name),!1;o.push(i.fileId)}if(!a)return!1;a._prefab||(a._prefab=utils_1.prefabUtils.createPrefabInfo(a.uuid));const l=a._prefab;n=utils_1.prefabUtils.getTargetOverride(l,t,r.pathKeys);if(n)return utils_1.prefabUtils.fireBeforeChangeMsg(a),n.target=s,(i=new TargetInfo).localID=o,n.targetInfo=i,utils_1.prefabUtils.fireChangeMsg(a),!0}}}}}return!1}checkToAddPropertyOverrides(e,t,r){var a=utils_1.prefabUtils.getPropertyOverrideLocationInfo(e,t);if(a){var n=a.outMostPrefabInstanceNode;if(n){var o=n._prefab;if(o&&o.asset){var s=null==o?void 0:o.instance;if(s){var i=a.target,l=utils_1.prefabUtils.getMountedRoot(i);if(!l||l!==n){var f=a.targetPath,l=utils_1.prefabUtils.getPrefabAssetNodeInstance(o);if(l){n=utils_1.prefabUtils.getTarget(f,l);if(n){var l=utils_1.prefabUtils.getPropertyOverridesOfTarget(s,f),d=this.getDiffPropertyInfos(i,n,[],this.isInPropertyOverrides.bind(this,l));if(d&&0<d.length){utils_1.prefabUtils.fireBeforeChangeMsg(a.outMostPrefabInstanceNode);for(let e=0;e<d.length;e++){var c=d[e];i instanceof cc_1.Component&&this.checkToAddTargetOverride(i,c,r)||(utils_1.prefabUtils.getPropertyOverride(s,f,c.pathKeys).value=c.value)}r&&this.addTargetOverrideWithModifyPath(e,t,r),utils_1.prefabUtils.fireChangeMsg(a.outMostPrefabInstanceNode)}}else console.debug(`can't find item: ${i.name} in prefab asset `+o.asset._uuid)}}}}}}}isInTargetOverrides(e,t,r){return!!t&&utils_1.prefabUtils.isInTargetOverrides(t,e,r)}isInPropertyOverrides(e,t){return utils_1.prefabUtils.isInPropertyOverrides(t,e)}getDiffPropertyInfos(a,n,o,s){if(!a)return null;const i=a.constructor;var e=n.constructor;if(!i||!e||i!==e)return null;e=i.__values__;const l=getDiffExcludeProps(i);let f=[];return e.map(e=>{var t,r;l.includes(e)||!1!==cc_1.CCClass.attr(i,e).serializable&&(r=a[e],t=n[e],r=this.handleDiffPropertyInfos(r,t,e,o,s),f=f.concat(r))}),f}handleDiffPropertyInfos(t,r,e,a,n){let o=[];var s=a.concat(e),a={pathKeys:s,value:t};if(null==t)t===r&&!n(s)||o.push(a);else if(null==r||n(s))o.push(a);else if(Array.isArray(t)){var e=s.concat("length");t.length===r.length&&!n(e)||(e={pathKeys:e,value:t.length},o.push(e));for(let e=0;e<t.length;e++){var i=this.handleDiffPropertyInfos(t[e],r[e],""+e,s,n);i&&0<i.length&&(o=o.concat(i))}}else"object"==typeof t?t instanceof cc_1.Node?((e=t._prefab)&&e.fileId!==(null==(e=r._prefab)?void 0:e.fileId)||t.uuid!==r.uuid)&&o.push(a):t instanceof cc_1.Component?(t.__prefab&&t.__prefab.fileId!==(null==(e=r.__prefab)?void 0:e.filedId)||t.uuid!==r.uuid)&&o.push(a):t instanceof cc_1.ValueType?t.equals(r)&&!n(s)||o.push(a):t instanceof cc_1.Asset?t._uuid===r._uuid&&!n(s)||o.push(a):cc_1.CCClass.isCCClassOrFastDefined(t.constructor)&&(e=this.getDiffPropertyInfos(t,r,s,n))&&0<e.length&&(o=o.concat(e)):t===r&&!n(s)||o.push(a);return o}addTargetOverrideWithModifyPath(e,t,r){let a=e,n=null;for(let e=0;e<t.length;e++){var o=t[e];if(!a)break;a=a[o],1===e&&"_components"===t[0]&&(n=a)}a!==e&&n&&(t.shift(),t.shift(),this.checkToAddTargetOverride(n,{pathKeys:t,value:a},r))}checkToAddPrefabAssetMap(t){var r=t._prefab;if((null==r?void 0:r.instance)&&null!=r&&r.asset){let e=this.assetToNodesMap.get(r.asset._uuid);e||(e=[],this.assetToNodesMap.set(r.asset._uuid,e)),e.includes(t)||e.push(t)}}isReservedPropertyOverrides(e,t){var r=e.targetInfo;if(1===(null==r?void 0:r.localID.length)&&r.localID[0]===t){r=e.propertyPath;if(1===r.length&&RootReservedProperty.includes(r[0]))return!0}return!1}removeModifiedPropertyOverrides(t,r){var a=[];for(let e=0;e<t.propertyOverrides.length;e++){var n=t.propertyOverrides[e];this.isReservedPropertyOverrides(n,r)&&a.push(n)}t.propertyOverrides=a}applyMountedChildren(r){var t=r;const a=utils_1.prefabUtils.getPrefab(t);if(a&&a.instance){var n=a.instance;const d=new Map;var o=n.mountedChildren;for(let e=0;e<o.length;e++){var s=o[e],i=s.targetInfo;if(i)if(1<i.localID.length){var i=utils_1.prefabUtils.getTarget(i.localID,t),l=(a.instance=void 0,utils_1.prefabUtils.getOutMostPrefabInstanceInfo(i));a.instance=n;const c=l.outMostPrefabInstanceNode;if(c){const p=c._prefab;if(p){var f=p.instance;if(f){const u=l.targetPath.slice();l=l.targetPath.slice(1),i=null==(i=utils_1.prefabUtils.getPrefab(i))?void 0:i.fileId;i&&(l.push(i),i=utils_1.prefabUtils.getPrefabInstanceMountedChildren(f,l),s.nodes.forEach(e=>{var t=e._prefab,e=(utils_1.prefabUtils.addPrefabInfo(e,c,p.asset),utils_1.prefabUtils.setMountedRoot(e,c),e._prefab);e&&(u.push(e.fileId),d.set(u,{prefabInfo:t}))}),i.nodes=i.nodes.concat(s.nodes))}}}}else s.nodes.forEach(e=>{let t=utils_1.prefabUtils.getPrefab(e);utils_1.prefabUtils.setMountedRoot(e,void 0),t?t.instance||utils_1.prefabUtils.addPrefabInfo(e,r,a.asset):(utils_1.prefabUtils.addPrefabInfo(e,r,a.asset),t=utils_1.prefabUtils.getPrefab(e)),d.set([t.fileId],{prefabInfo:null})})}return n.mountedChildren=[],d}}applyPropertyOverrides(e){var t=e,r=t._prefab;if(r){var a=r.instance;if(a){var n=a.propertyOverrides,o=[];for(let e=0;e<n.length;e++){var s=n[e];if(this.isReservedPropertyOverrides(s,r.fileId))o.push(s);else{var i=s.targetInfo;if(i&&1<i.localID.length){i=utils_1.prefabUtils.getTarget(i.localID,t);if(i){let e=i;e instanceof cc_1.Component&&(e=e.node),r.instance=void 0;var l=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(e),f=(r.instance=a,l.outMostPrefabInstanceNode);f&&(f=f._prefab)&&(f=f.instance)&&((l=l.targetPath.slice()).splice(0,1),i=i instanceof cc_1.Node?i._prefab:i.__prefab)&&(l.push(i.fileId),utils_1.prefabUtils.getPropertyOverride(f,l,s.propertyPath).value=s.value)}}}}a.propertyOverrides=o}}}applyTargetOverrides(n){var e=[],t=scene_1.default.rootNode;if(t){var o=utils_1.prefabUtils.getPrefab(t);if(o){var s=utils_1.prefabUtils.getPrefab(n);if(s){var i=s.instance;if(i&&o.targetOverrides)for(let a=o.targetOverrides.length-1;0<=a;a--){var l=o.targetOverrides[a];let r=l.source;var f=r instanceof cc_1.Component?r.node:r,d=l.sourceInfo;if(d&&r instanceof cc_1.Node){const n=utils_1.prefabUtils.getTarget(d.localID,r);r=n||r}var c=l.targetInfo;if(c)if(null==(p=null==(p=l.target)?void 0:p._prefab)?void 0:p.instance){var p=l.target,p=p?utils_1.prefabUtils.getTarget(c.localID,p):null;if(p){p=p instanceof cc_1.Component?p.node:p;if(f&&p){if(node_2.default.isPartOfNode(f,n)&&node_2.default.isPartOfNode(p,n)){s.targetOverrides||(s.targetOverrides=[]);let e=r;(new TargetOverrideInfo).propertyPath=l.propertyPath;f=null==d?void 0:d.localID;f&&l.source instanceof cc_1.Node&&(p=utils_1.prefabUtils.getTarget(f,l.source))&&(e=p);let t=l.target;d=c.localID;d&&l.target instanceof cc_1.Node&&(f=utils_1.prefabUtils.getTarget(d,l.target))&&(t=f),s.instance=void 0,this.checkToAddTargetOverride(e,{pathKeys:l.propertyPath,value:t},n),s.instance=i,o.targetOverrides.splice(a,1)}e.push(l)}}}}}}}return e}applyRemovedComponents(e){var t=e,r=t._prefab;if(r){var a=r.instance;if(a){var n=utils_1.prefabUtils.getPrefabAssetNodeInstance(r);if(!n)return null;var o=a.removedComponents;for(let e=0;e<o.length;e++){var s,i,l=o[e];l&&1<l.localID.length&&(i=utils_1.prefabUtils.getTarget(l.localID,n))&&i.__prefab&&(s=i.node,s=utils_1.prefabUtils.getPrefab(s),i)&&s&&((l=l.localID.slice()).pop(),l.push(s.fileId),s=utils_1.prefabUtils.getTarget(l,t),r.instance=void 0,l=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(s),r.instance=a,s=l.outMostPrefabInstanceNode)&&(s=utils_1.prefabUtils.getPrefab(s))&&(s=s.instance)&&((l=l.targetPath.slice()).splice(0,1),l.push(i.__prefab.fileId),(i=new TargetInfo).localID=l,s.removedComponents.push(i))}a.removedComponents=[]}}}async waitForSceneLoaded(){return new Promise((e,t)=>{scene_1.default.once("soft-reload",e)})}async applyPrefab(e){var t=new ApplyPrefabCommand(this.undoApplyPrefab.bind(this),this.doApplyPrefab.bind(this)),r=cce.SceneFacadeManager.beginRecording(e,{customCommand:t}),e=await this.doApplyPrefab(e);return e?(t.applyPrefabInfo=e,cce.SceneFacadeManager.endRecording(r),await this.waitForSceneLoaded()):cce.SceneFacadeManager.cancelRecording(r),!1}async doApplyPrefab(e){var t,r,a,n,o,s,i,l,f,d=node_1.default.query(e);return d&&(i=null==(t=utils_1.prefabUtils.getPrefab(d))?void 0:t.instance)&&null!=t&&t.asset?(a=t.asset,utils_1.prefabUtils.isSubAsset(a._uuid)?(console.warn("can't apply data to SubAsset Prefab"),null):(r=a.data,(a=await Editor.Message.request("asset-db","query-asset-info",a._uuid))&&(n=this.applyMountedChildren(d))&&(o=component_1.componentOperation.applyMountedComponents(d))&&(s=i.propertyOverrides,this.applyPropertyOverrides(d),i=i.removedComponents,this.applyRemovedComponents(d),l=this.applyTargetOverrides(d),f=utils_1.prefabUtils.generatePrefabDataFromNode(d))?(f.clearedReference&&this.restoreClearedReference(d,f.clearedReference),await Editor.Message.request("asset-db","create-asset",a.source,f.prefabData,{overwrite:!0}),utils_1.prefabUtils.removePrefabAssetNodeInstanceCache(t),{nodeUUID:e,mountedChildrenInfoMap:n,mountedComponentsInfoMap:o,propertyOverrides:s,removedComponents:i,oldPrefabNodeData:r,targetOverrides:l}):null)):null}async undoApplyPrefab(e){const r=node_1.default.query(e.nodeUUID);if(r){var t=r._prefab;if(t){var a=t.instance;if(a){t=t.asset;if(t){var n=await Editor.Message.request("asset-db","query-asset-info",t._uuid);if(n){t.data=e.oldPrefabNodeData;t=(0,serialize_1.serializeSafe)(t);a.mountedChildren=[];const o=utils_1.prefabUtils.getTargetMap(r);e.mountedChildrenInfoMap.forEach((e,t)=>{t=cc_1.Prefab._utils.getTarget(t,o);t&&(utils_1.prefabUtils.setMountedRoot(t,r),t._prefab=e.prefabInfo,t.parent)&&this.updateChildrenData(t.parent)}),e.mountedComponentsInfoMap.forEach((e,t)=>{t=cc_1.Prefab._utils.getTarget(t,o);t&&(utils_1.prefabUtils.setMountedRoot(t,r),t.__prefab=e.prefabInfo,t.node)&&component_1.componentOperation.updateMountedComponents(t.node)}),a.propertyOverrides=e.propertyOverrides,a.removedComponents=e.removedComponents;a=scene_1.default.rootNode;if(a){const s=utils_1.prefabUtils.getPrefab(a);s&&(s.targetOverrides||(s.targetOverrides=[]),null!=(e=e.targetOverrides)&&e.forEach(e=>{var t,r=new TargetOverrideInfo;e.sourceUUID&&((t=node_1.default.query(e.sourceUUID))?r.source=t:(t=component_2.default.query(e.sourceUUID))&&(r.source=t)),r.sourceInfo=e.sourceInfo,e.targetUUID&&((t=node_1.default.query(e.targetUUID))?r.target=t:(t=component_2.default.query(e.targetUUID))&&(r.target=t)),r.targetInfo=e.targetInfo,r.propertyPath=e.propertyPath,null!=(t=s.targetOverrides)&&t.push(r)}),cc_1.Prefab._utils.applyTargetOverrides(a))}await Editor.Message.request("asset-db","create-asset",n.source,t,{overwrite:!0})}}}}}}updateChildrenData(t){if(t&&!this.isRemovingMountedChildren){var e=t._prefab;if(e){var r=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(t);const c=r.outMostPrefabInstanceNode;if(c){var a=r.targetPath,r=c._prefab,n=null==r?void 0:r.instance;if(c&&r&&n){r=utils_1.prefabUtils.getPrefabAssetNodeInstance(r);if(r){a.splice(0,1),a.push(e.fileId);e=utils_1.prefabUtils.getTarget(a,r);if(e){var o=e.children.map(e=>{e=e._prefab;if(e)return(e.instance||e).fileId}),s=[];for(let e=0;e<t.children.length;e++){var i=t.children[e],l=utils_1.prefabUtils.getPrefab(i),f=null==l?void 0:l.instance;l&&(f=(f||l).fileId,o.includes(f)||(l=utils_1.prefabUtils.getMountedRoot(i))&&l!==c)||s.push(i)}if(utils_1.prefabUtils.fireBeforeChangeMsg(c),0<s.length){r=utils_1.prefabUtils.getPrefabInstanceMountedChildren(n,a);r.nodes=s,r.nodes.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,c)})}else for(let e=0;e<n.mountedChildren.length;e++){var d=n.mountedChildren[e];if(d.isTarget(a)){d.nodes.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,void 0)}),n.mountedChildren.splice(e,1);break}}utils_1.prefabUtils.fireChangeMsg(c)}}}}}}}isCircularRefPrefabInstance(t,r){var e=t._prefab;if(e){e=e.instance;if(e&&t!==r){if(a(t,r))return!0;let e=t.parent;if(e)for(;e&&e!==r;){if(a(t,e))return!0;e=e.parent}function a(e,t){var e=e._prefab,r=null==e?void 0:e.instance,t=t._prefab,a=null==t?void 0:t.instance;return!(!r||!a||(null==(r=null==e?void 0:e.asset)?void 0:r._uuid)!==(null==(a=null==t?void 0:t.asset)?void 0:a._uuid))}}}return!1}canBeMadeToPrefabAsset(t){let r=!1,a=!1;return t.walk(e=>{e.getComponent(cc_1.Terrain)&&(r=!0),this.isCircularRefPrefabInstance(e,t)&&(console.warn(`Circular reference prefab checked: [${e.name}]`),a=!0)}),r?(console.warn("Can't create prefabAsset from a node that contains terrain"),!1):!a||(console.warn("Can't create prefabAsset from a node that contains circular reference prefab"),!1)}async createPrefabAssetFromNode(r,a,n=!0){var o=node_1.default.query(r);if(!o)return null;var s=utils_1.prefabUtils.getPrefab(o);if(s){var i=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(o)["outMostPrefabInstanceNode"];if(i!==o&&o.isChildOf(i)&&!utils_1.prefabUtils.getMountedRoot(o))return console.warn("can't create prefabAsset from a prefabNode inside a prefabInstance"),null;s.instance&&this.applyPropertyOverrides(o)}if(!this.canBeMadeToPrefabAsset(o))return null;i=utils_1.prefabUtils.generatePrefabDataFromNode(o);if(!i)return null;s&&s.asset&&this.assetToNodesMap.delete(s.asset._uuid);s=await Editor.Message.request("asset-db","create-asset",a,i.prefabData);if(s){let e,t;a=o.parent,n=(n&&a&&(t=new CreatePrefabCommand,e=cce.SceneFacadeManager.beginRecording(r,{customCommand:t}),t.undoData=new Map,t.undoData.set(a.uuid,cce.Dump.encode.encodeNode(a)),t.undoData.set(r,cce.Dump.encode.encodeNode(o))),await this.replaceNewPrefabAssetWithClearedReference(o,s.uuid,i.clearedReference));e&&t&&a&&(t.redoData=new Map,t.redoData.set(a.uuid,cce.Dump.encode.encodeNode(a)),t.redoData.set(n.uuid,cce.Dump.encode.encodeNode(n)),cce.SceneFacadeManager.endRecording(e))}return null==s?void 0:s.uuid}restoreClearedReference(e,t){var r={};cc_1.Prefab._utils.generateTargetMap(e,r,!0);for(const o in t){var a=t[o],n=[a.component],n=cc_1.Prefab._utils.getTarget(n,r);if(n){n[a.path]=a.value;const e=n.node;n={propPath:`__comps__.${n.node.components.indexOf(n)}.`+a.path,type:"set-property"};this.onNodeChangedInGeneralMode(e,n,scene_1.default.rootNode)}}}async replaceNewPrefabAssetWithClearedReference(e,t,r){var a,n=e.parent;if(n)return utils_1.prefabUtils.fireBeforeChangeMsg(n),a=e.getSiblingIndex(),t=await(0,util_1.promisify)(cc_1.assetManager.loadAny)(t),(t=(0,cc_1.instantiate)(t))._prefab.instance||(t._prefab.instance=utils_1.prefabUtils.createPrefabInstance()),e._prefab&&e._prefab.instance&&(t._prefab.instance.fileId=e._prefab.instance.fileId),this.createReservedPropertyOverrides(t),this.syncPropertyOverrides(t,scene_1.default.rootNode),this.restoreClearedReference(t,r),e.parent=null,n.insertChild(t,a),utils_1.prefabUtils.fireChangeMsg(n),t}async linkNodeWithPrefabAsset(t,e){let r=null;if(!(r="string"==typeof t?node_1.default.query(t):t))return!1;let a=e;if(!(a="string"==typeof e?await(0,util_1.promisify)(cc_1.assetManager.loadAny)(e):a))return console.error(`asset ${e} doesn't exist`),!1;t=a.data;if(t&&t._prefab){utils_1.prefabUtils.fireBeforeChangeMsg(r);let e=r._prefab;if(e||(e=new PrefabInfo,r._prefab=e),utils_1.prefabUtils.removePrefabAssetNodeInstanceCache(e),e.instance)utils_1.prefabUtils.removeMountedRootInfo(r);else{const n=utils_1.prefabUtils.createPrefabInstance(),e=r._prefab;e&&(n.prefabRootNode=e.root),e.instance=n}e.fileId=t._prefab.fileId,e.root=r;const n=null===e||void 0===e?void 0:e.instance;return e&&n&&(this.createReservedPropertyOverrides(r),n.mountedChildren=[],this.removeModifiedPropertyOverrides(n,e.fileId)),e.asset=a,utils_1.prefabUtils.fireChangeMsg(r),this.syncPrefabInfo(t,r,r),this.checkToAddPrefabAssetMap(r),!0}}syncPropertyOverrides(t,e){var r,a=[];if(utils_1.prefabUtils.findOutmostPrefabInstanceNodes(e,a),0<a.length){const n=new Map;t.walk(e=>{e._prefab&&e._prefab.instance&&n.set(e._prefab.instance.fileId,e)});for(let e=a.length-1;0<=e;e--){const o=a[e]._prefab,s=null==(r=null===o||void 0===o?void 0:o.instance)?void 0:r.fileId,i=null==(r=t._prefab.instance)?void 0:r.fileId;if(n.has(s)&&null!==o&&void 0!==o&&o.instance&&o.instance.propertyOverrides){const l=t._prefab.instance.propertyOverrides;o.instance.propertyOverrides.forEach(e=>{var t;this.isReservedPropertyOverrides(e,o.fileId)||(l.push(e),s!==i&&s&&(null==(t=e.targetInfo)?void 0:t.localID[0])!==s&&null!=(t=e.targetInfo)&&t.localID.unshift(s))})}}e={};cc_1.Prefab._utils.generateTargetMap(t,e,!0),cc_1.Prefab._utils.applyPropertyOverrides(t,t._prefab.instance.propertyOverrides,e)}}syncPrefabInfo(t,r,a){if(t&&r&&a){var e=t._prefab;if(e){utils_1.prefabUtils.fireBeforeChangeMsg(r),r._prefab||(r._prefab=new PrefabInfo);var n=r._prefab;if(n)if(n.instance&&r!==a)n.asset=e.asset,n.instance.prefabRootNode=a,utils_1.prefabUtils.fireChangeMsg(r);else if(n.fileId=e.fileId,n.asset=e.asset,n.root=a,t.components.length!==r.components.length)console.error("Prefab Component doesn't match");else{for(let e=0;e<t.components.length;e++){var o=t.components[e],s=r.components[e];o&&o.__prefab&&s&&(s.__prefab||(s.__prefab=new CompPrefabInfo),s.__prefab.fileId=o.__prefab.fileId)}utils_1.prefabUtils.fireChangeMsg(r);const f=[];if(r.children.forEach(e=>{e.objFlags&cc_1.CCObject.Flags.HideInHierarchy||f.push(e)}),t.children.length!==f.length)console.error("Prefab Node doesn't match");else for(let e=0;e<t.children.length;e++){var i=t.children[e],l=f[e];this.syncPrefabInfo(i,l,a)}}}}}createReservedPropertyOverrides(t){var r=t._prefab,a=null==r?void 0:r.instance;if(r&&a)for(let e=0;e<RootReservedProperty.length;e++){var n=[r.fileId],o=[RootReservedProperty[e]],s=t[RootReservedProperty[e]];utils_1.prefabUtils.getPropertyOverride(a,n,o).value=s}}revertPropertyOverrideOfTarget(e,t){if(!t||!t.propPath)return!1;var t=(t.propPath.replace(/^__comps__/,compKey)||"").split("."),r=utils_1.prefabUtils.getPropertyOverrideLocationInfo(e,t);if(!r)return!1;t=r.outMostPrefabInstanceNode;if(!t)return!1;var t=t._prefab,a=null==t?void 0:t.instance;if(!a||null==t||!t.asset)return!1;t=utils_1.prefabUtils.getPrefabAssetNodeInstance(t);if(!t)return!1;var n={},o={};cc_1.Prefab._utils.generateTargetMap(t,n,!0),cc_1.Prefab._utils.generateTargetMap(e,o,!0),utils_1.prefabUtils.fireBeforeChangeMsg(e);for(let e=0;e<a.propertyOverrides.length;e++){var s=a.propertyOverrides[e];if(s.isTarget(r.targetPath,r.relativePathKeys)){this.revertPropertyOverride(s,o,n),a.propertyOverrides.splice(e,1);break}}return utils_1.prefabUtils.fireChangeMsg(e),!0}revertPropertyOverride(e,t,r){if(!e||!e.targetInfo)return!1;var a=e.targetInfo,r=cc_1.Prefab._utils.getTarget(a.localID,r),a=cc_1.Prefab._utils.getTarget(a.localID,t);if(!r||!a)return!1;let n=null;if(a instanceof cc_1.Node?n=a:a instanceof cc_1.Component&&(n=a.node),!n)return!1;let o=r,s=a,i=a,l="";var f=e.propertyPath.slice();if(0<f.length){t=f.pop();if(!t)return!1;for(let e=0;e<f.length;e++){var d=f[e];l=d,o=o[d],s=(i=s)[d]}utils_1.prefabUtils.fireBeforeChangeMsg(n),s[t]=o[t],Array.isArray(s)&&i&&l&&(i[l]=s),utils_1.prefabUtils.fireChangeMsg(n)}else console.warn("property path is empty");return!0}async revertPrefab(e){let t=null;if(!(t="string"==typeof e?node_1.default.query(e):e))return!1;var r=t._prefab,a=null==r?void 0:r.instance;if(!a||null==r||!r.asset)return!1;var n=(0,cc_1.instantiate)(r.asset);if(!n)return!1;var o=t._prefab,s=n._prefab;if(!o||!s)return!1;var i={},l={},f=(cc_1.Prefab._utils.generateTargetMap(n,i,!0),cc_1.Prefab._utils.generateTargetMap(t,l,!0),utils_1.prefabUtils.fireBeforeChangeMsg(t),new RevertPrefabCommand),o=cce.SceneFacadeManager.beginRecording(t.uuid,{customCommand:f}),d=(f.undoData=new Map,f.undoData.set(t.uuid,cce.Dump.encode.encodeNode(t)),f.redoData=new Map,[]);for(let e=0;e<a.propertyOverrides.length;e++){var c,p=a.propertyOverrides[e];this.isReservedPropertyOverrides(p,r.fileId)?d.push(p):((c=(c=utils_1.prefabUtils.getTarget(null!=(c=null==(c=p.targetInfo)?void 0:c.localID)?c:[],t))instanceof cc_1.Node?c:null==c?void 0:c.node)&&!f.undoData.has(c.uuid)&&f.undoData.set(c.uuid,cce.Dump.encode.encodeNode(c)),this.revertPropertyOverride(p,l,i),c&&!f.redoData.has(c.uuid)&&f.redoData.set(c.uuid,cce.Dump.encode.encodeNode(c)))}a.propertyOverrides=d,this.isRemovingMountedChildren=!0;for(let e=0;e<a.mountedChildren.length;e++){var u=a.mountedChildren[e];for(let e=0;e<u.nodes.length;e++)u.nodes[e].setParent(null)}a.mountedChildren=[],this.isRemovingMountedChildren=!1,component_1.componentOperation.isRemovingMountedComponents=!0;for(let e=0;e<a.mountedComponents.length;e++){var _=a.mountedComponents[e];for(let e=_.components.length-1;0<=e;e--){var b=_.components[e];b&&b.node&&b.node.removeComponent(b)}}cc.Object._deferredDestroy(),a.mountedComponents=[],component_1.componentOperation.isRemovingMountedComponents=!1,component_1.componentOperation.isRevertingRemovedComponents=!0;for(let e=0;e<a.removedComponents.length;e++){var v,g=a.removedComponents[e],h=cc_1.Prefab._utils.getTarget(g.localID,i);h&&((g=g.localID.slice()).pop(),g.push(null==(v=h.node._prefab)?void 0:v.fileId),v=cc_1.Prefab._utils.getTarget(g,l),await component_1.componentOperation.cloneComponentToNode(v,h))}return a.removedComponents=[],component_1.componentOperation.isRevertingRemovedComponents=!1,f.redoData.set(e,cce.Dump.encode.encodeNode(t)),o&&cce.SceneFacadeManager.endRecording(o),utils_1.prefabUtils.fireChangeMsg(t),await cce.SceneFacadeManager.softReloadScene(),!0}removePrefabInfoFromNode(e,r){e.children.forEach(e=>{var t;(null==(t=e._prefab)?void 0:t.instance)&&!r||this.removePrefabInfoFromNode(e,r)}),utils_1.prefabUtils.removePrefabInfo(e)}removePrefabInfoFromInstanceNode(a,n){var e=a._prefab;return!!e&&!(!e.instance&&e.asset||(utils_1.prefabUtils.removeMountedRootInfo(a),utils_1.prefabUtils.walkNode(a,(e,t)=>{if(t){t=e._prefab;if(!t)return!0;var r=t.instance;if(r||!t.asset){if(r&&r.prefabRootNode===a&&(r.prefabRootNode=void 0,utils_1.prefabUtils.fireChangeMsg(e)),!n)return!0;this.removePrefabInfoFromInstanceNode(e)}else utils_1.prefabUtils.removePrefabInfo(e)}return!1}),utils_1.prefabUtils.removePrefabInfo(a),0))}removePrefabInstanceAndChangeRoot(e,r,a){e.children.forEach(e=>{var t;null!=(t=e._prefab)&&t.instance&&!a||this.removePrefabInstanceAndChangeRoot(e,r,a)});var t,n=e._prefab;n&&(utils_1.prefabUtils.fireBeforeChangeMsg(e),(t=r._prefab)&&(n.root=r,n.asset=t.asset),n.instance&&(n.instance=void 0),n.fileId=e.uuid,e.components.forEach(e=>{e.__prefab&&(e.__prefab.fileId=e.uuid)}),utils_1.prefabUtils.fireChangeMsg(e))}unWrapPrefabInstance(e,t){let r=null;return!!(r="string"==typeof e?node_1.default.query(e):e)&&!(!(e=r._prefab)||!e.instance&&e.asset)&&this.removePrefabInfoFromInstanceNode(r,t)}unWrapPrefabInstanceInPrefabMode(e,t){let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return!1;var a,e=r._prefab;if(!e)return!1;let n=r;return utils_1.prefabUtils.getMountedRoot(r)?n=scene_1.default.rootNode:r.parent&&r.parent._prefab&&(n=r.parent._prefab.root),!!n&&!!(a=n._prefab)&&!(!e.instance&&e.asset||(this.removePrefabInfoFromInstanceNode(r,t),utils_1.prefabUtils.addPrefabInfo(r,n,a.asset),e=[],utils_1.prefabUtils.findOutmostPrefabInstanceNodes(r,e),e.forEach(e=>{var t=null==(t=null==e?void 0:e._prefab)?void 0:t.instance;t&&(t.fileId=utils_1.prefabUtils.generateUUID(),utils_1.prefabUtils.fireChangeMsg(e))}),0))}}const nodeOperation=new NodeOperation;exports.nodeOperation=nodeOperation;