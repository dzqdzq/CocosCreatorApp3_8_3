"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PrefabManager=void 0;const node_1=__importDefault(require("../node")),utils_1=require("./utils"),cc_1=require("cc"),component_1=require("./component"),node_2=require("./node"),message_1=require("../message");class PrefabManager{constructor(){this._softReloadTimer=null,this._utils=utils_1.prefabUtils}init(){}onSceneOpened(e){node_2.nodeOperation.onSceneOpened(e)}onNodeRemoved(e){node_2.nodeOperation.onNodeRemoved(e)}onNodeChangedInGeneralMode(e,n,o){node_2.nodeOperation.onNodeChangedInGeneralMode(e,n,o)}onAddNode(e){node_2.nodeOperation.onAddNode(e)}onNodeAdded(e,n){node_2.nodeOperation.onNodeAdded(e,n)}removePrefabInfoFromNode(e,n){node_2.nodeOperation.removePrefabInfoFromNode(e,n)}checkToRemoveTargetOverride(e,n){utils_1.prefabUtils.checkToRemoveTargetOverride(e,n)}async createPrefabAssetFromNode(e,n){return node_2.nodeOperation.createPrefabAssetFromNode(e,n)}async linkNodeWithPrefabAsset(e,n){node_2.nodeOperation.linkNodeWithPrefabAsset(e,n)}generatePrefabDataFromNode(e){return utils_1.prefabUtils.generatePrefabDataFromNode(e)}async revertPrefab(e){return node_2.nodeOperation.revertPrefab(e)}getUnlinkNodeUuids(e,r){const t=[];var n=node_1.default.query(e);return n&&(t.push(e),n.children.forEach(e=>{!function n(e){var o=utils_1.prefabUtils.getPrefab(e);r?(t.push(e.uuid),e.children.forEach(e=>{n(e)})):o&&!o.instance&&(t.push(e.uuid),e.children.forEach(e=>{n(e)}))}(e)})),t}unWrapPrefabInstance(e,n){return node_2.nodeOperation.unWrapPrefabInstance(e,n)}unWrapPrefabInstanceInPrefabMode(e,n){return node_2.nodeOperation.unWrapPrefabInstanceInPrefabMode(e,n)}async applyPrefab(e){return node_2.nodeOperation.applyPrefab(e)}onAddComponent(e){component_1.componentOperation.onAddComponent(e)}onComponentAdded(e,n){component_1.componentOperation.onComponentAdded(e,n)}onRemoveComponentInGeneralMode(e,n){component_1.componentOperation.onRemoveComponentInGeneralMode(e,n)}onComponentRemovedInGeneralMode(e,n){component_1.componentOperation.onComponentRemovedInGeneralMode(e,n)}async revertRemovedComponent(e,n){component_1.componentOperation.revertRemovedComponent(e,n)}async applyRemovedComponent(e,n){component_1.componentOperation.applyRemovedComponent(e,n)}async onAssetChanged(e,n,o){node_2.nodeOperation.assetToNodesMap.has(e)&&(clearTimeout(this._softReloadTimer),this._softReloadTimer=setTimeout(async()=>{await cce.SceneFacadeManager.softReloadScene()},500))}async onAssetDeleted(e){node_2.nodeOperation.assetToNodesMap.has(e)&&(clearTimeout(this._softReloadTimer),this._softReloadTimer=setTimeout(async()=>{await cce.SceneFacadeManager.softReloadScene()},500))}revert(e){}sync(e){}createNodeFromPrefabAsset(e){var n=(0,cc_1.instantiate)(e),o=n._prefab;return o?(o.instance||(o.instance=utils_1.prefabUtils.createPrefabInstance()),n):(console.error("Not a Prefab Asset:",e.uuid),null)}filterChildOfAssetOfPrefabInstance(e,n){var o,r=[];for(const a of e=Array.isArray(e)?e:[e]){var t=node_1.default.query(a);t&&(!utils_1.prefabUtils.isOutmostPrefabInstanceMountedChildren(t)&&!utils_1.prefabUtils.isPrefabInstanceRoot(t)&&utils_1.prefabUtils.isPartOfAssetInPrefabInstance(t)?(console.warn(`Node [${t.name}] is a prefab child of prefabInstance [${null==(o=null==(o=t._prefab)?void 0:o.root)?void 0:o.name}], `+n),message_1.messageManager.broadcast("scene:change-node",t.uuid)):r.push(a))}return r}filterPartOfPrefabAsset(e,n){var o,r=[];for(const a of e=Array.isArray(e)?e:[e]){var t=node_1.default.query(a);t&&(utils_1.prefabUtils.isPartOfAssetInPrefabInstance(t)?(console.warn(`Node [${t.name}] is part of prefabInstance [${null==(o=null==(o=t._prefab)?void 0:o.root)?void 0:o.name}], `+n),message_1.messageManager.broadcast("scene:change-node",t.uuid)):r.push(a))}return r}filterChildOfPrefabAssetWhenRemoveNode(e){return this.filterChildOfAssetOfPrefabInstance(e,"it's not allowed to delete in current context, you can delete it in it's prefabAsset or         do it after unlink prefab from root node")}filterChildOfPrefabAssetWhenSetParent(e){return this.filterChildOfAssetOfPrefabInstance(e,"it's not allowed to change parent in current context, you can modify it in it's prefabAsset or         do it after unlink prefab from root node")}canModifySibling(n,o,r){if(0===r)return!1;n=node_1.default.query(n);if(!n)return!1;if(n._prefab&&utils_1.prefabUtils.isPartOfPrefabAsset(n)&&null!=(t=null==(t=null==(t=n._prefab)?void 0:t.root)?void 0:t._prefab)&&t.instance&&n.children){var t=n.children.filter(e=>!(e.objFlags&cc.Object.Flags.HideInHierarchy)),n=n.children[o];if(!n)return!1;let e=!0;if(n._prefab){var a=utils_1.prefabUtils.getPrefabStateInfo(n);if(!(e=a.isAddedChild))return console.warn(`Node [${n.name}] is a prefab child of prefabInstance [${null==(a=n._prefab.root)?void 0:a.name}],                     it's not allowed to modify hierarchy in current context, you can modify it in it's prefabAsset or do it after unlink prefab from root node`),message_1.messageManager.broadcast("scene:change-node",n.uuid),!1}a=t[o+r];if(e&&a._prefab)return console.warn(`Node [${a.name}] is a prefab child of prefabInstance [${null==(t=a._prefab.root)?void 0:t.name}],                 it's not allowed to modify hierarchy in current context, you can modify it in it's prefabAsset or do it after unlink prefab from root node`),message_1.messageManager.broadcast("scene:change-node",n.uuid),!1}return!0}filterPartOfPrefabAssetWhenCreateComponent(e){return this.filterPartOfPrefabAsset(e,"it's not allow to add component in current context currently, you can add component in it's prefabAsset or         do it after unlink prefab from root node")}filterPartOfPrefabAssetWhenRemoveComponent(e){return this.filterPartOfPrefabAsset(e,"it's not allow to remove component in current context currently, you can remove component in it's prefabAsset or         do it after unlink prefab from root node")}findPathWithRule(e,r){function t(n,o){Object.keys(n).forEach(e=>{"object"!=typeof n[e]||!n[e]||s.get(n[e])||(s.set(n[e],!0),r(n[e])?(console.log("找到了",o+"|"+e),a.push(o+"|"+e)):t(n[e],o+"|"+e))})}const a=[],s=new Map;return t(e,""),a}}exports.PrefabManager=PrefabManager,exports.default=new PrefabManager;