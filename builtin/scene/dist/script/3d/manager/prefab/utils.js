"use strict";var PrefabState,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PrefabState=exports.prefabUtils=void 0;const event_enum_1=require("../../../../script/public/event-enum"),cc_1=require("cc"),node_1=__importDefault(require("../../../utils/node")),PrefabInfo=cc_1.Prefab._utils.PrefabInfo,CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo,PrefabInstance=cc_1.Prefab._utils.PrefabInstance,TargetInfo=cc_1.Prefab._utils.TargetInfo,PropertyOverrideInfo=cc_1.Prefab._utils.PropertyOverrideInfo,MountedChildrenInfo=cc_1.Prefab._utils.MountedChildrenInfo,TargetOverrideInfo=cc_1.Prefab._utils.TargetOverrideInfo,MountedComponentsInfo=cc_1.Prefab._utils.MountedComponentsInfo,compKey=(!function(e){e[e.NotAPrefab=0]="NotAPrefab",e[e.PrefabChild=1]="PrefabChild",e[e.PrefabInstance=2]="PrefabInstance",e[e.PrefabLostAsset=3]="PrefabLostAsset"}(PrefabState=PrefabState||{}),exports.PrefabState=PrefabState,"_components"),DELIMETER=cc_1.CCClass.Attr.DELIMETER;function compareStringArray(e,r){return!(!e||!r)&&e.length===r.length&&e.every((e,t)=>e===r[t])}function isInClassChain(e,t){var r;return!(!e||!t)&&((r=cc_1.CCClass.getInheritanceChain(e)).push(e),r.includes(t))}function isSameNode(e,t){return e.getPathInHierarchy()===t.getPathInHierarchy()&&e.getSiblingIndex()===t.getSiblingIndex()}function pushNestedPrefab(e,t,r){var n;let a=e.parent;for(;a&&a!==t;)null!=(n=a._prefab)&&n.instance&&r.unshift(null==(n=a._prefab)?void 0:n.instance.fileId),a=a.parent}class PrefabUtil{constructor(){this.assetTargetMapCache=new Map,this.prefabAssetNodeInstanceMap=new Map}getPrefab(e){return e._prefab}fireBeforeChangeMsg(e){cce.Node.emit("before-change",e)}fireChangeMsg(e,t={}){t.type=event_enum_1.NodeEventType.PREFAB_INFO_CHANGED,cce.Node.emit("change",e,t)}getPrefabAssetNodeInstance(e){if(this.prefabAssetNodeInstanceMap.has(e))return this.prefabAssetNodeInstanceMap.get(e);let t=void 0;var r;return(t=e&&e.asset?(0,cc_1.instantiate)(e.asset):t)&&((r=t._prefab)&&(r.instance=e.instance),this.prefabAssetNodeInstanceMap.set(e,t)),t}clearCache(){this.assetTargetMapCache.clear(),this.prefabAssetNodeInstanceMap.clear()}removePrefabAssetNodeInstanceCache(e){this.prefabAssetNodeInstanceMap.has(e)&&this.prefabAssetNodeInstanceMap.delete(e)}getTargetMap(e,t=!1){return t&&this.assetTargetMapCache.has(e)?this.assetTargetMapCache.get(e):(this.generateTargetMap(e,t={},!0),this.assetTargetMapCache.set(e,t),t)}getTarget(e,t,r=!1){t=this.getTargetMap(t,r);return cc_1.Prefab._utils.getTarget(e,t)}generateTargetMap(t,e,n){if(t){let r=e;var a=null==(o=t._prefab)?void 0:o.instance,o=(!n&&a&&(e[a.fileId]={},r=e[a.fileId]),t._prefab),s=(o&&(r[o.fileId]=t),t.components);for(let e=0;e<s.length;e++){var i=s[e];i.__prefab&&(r[i.__prefab.fileId]=i)}for(let e=0;e<t.children.length;e++){var f=t.children[e];this.generateTargetMap(f,r,!1)}if(a&&0<a.mountedChildren.length)for(let e=0;e<a.mountedChildren.length;e++){var l=a.mountedChildren[e];if(l&&l.targetInfo){let t=r;var d=l.targetInfo.localID;if(0<d.length)for(let e=0;e<d.length-1;e++)t=t[d[e]];if(l.nodes&&t)for(let e=0;e<l.nodes.length;e++){var c=l.nodes[e];c&&this.generateTargetMap(c,t,!1)}}}}}getPropertyOverrideLocationInfo(r,n){var a=this.getOutMostPrefabInstanceInfo(r),o=a.outMostPrefabInstanceNode;if(o){a=a.targetPath;let t=r;if(null==(s=o._prefab)?void 0:s.instance){a.splice(0,1);let e=[];if(n.length<=0)return null;if(n[0]===compKey){if(2===n.length)return null;if(1===n.length)return null;var s=r[n[0]][n[1]];if(!s.__prefab)return null;a.push(s.__prefab.fileId),e=n.slice(2),t=s}else{s=r._prefab;s?(a.push(s.fileId),e=n):console.error(`node: ${r.name} doesn't have a prefabInfo`)}return{outMostPrefabInstanceNode:o,targetPath:a,relativePathKeys:e,target:t}}}return null}getPrefabForSerialize(e,t=void 0){const o=(0,cc_1.instantiate)(e);this.removeMountedRootInfo(o);var r=new cc.Prefab;const s=prefabUtils.createPrefabInfo(e.uuid);s.asset=r,s.root=o;e=this.getPrefab(o);e&&(r.optimizationPolicy=null==(n=e.asset)?void 0:n.optimizationPolicy,r.persistent=null==(n=e.asset)?void 0:n.persistent,s.targetOverrides=e.targetOverrides,s.fileId=e.fileId),o._prefab=s;const i=[];this.walkNode(o,(t,e)=>{if(!(t.objFlags&cc.Object.Flags.HideInHierarchy)){var r,n=this.getPrefab(t);if(n?n.instance?(r=this.getOutMostPrefabInstanceInfo(t)["outMostPrefabInstanceNode"],r===t&&(n.nestedPrefabInstanceRoots=void 0,n.instance.prefabRootNode=o,i.push(t))):(t._prefab.root=s.root,null!=(r=t._prefab)&&(r.asset=s.asset)):((n=new PrefabInfo).root=s.root,n.asset=s.asset,n.fileId=t.uuid,t._prefab=n),t.components&&t.components.length)for(let e=0;e<t.components.length;e++){var a=t.components[e];a.__prefab||(a.__prefab=new CompPrefabInfo,a.__prefab.fileId=a.uuid)}}}),s.nestedPrefabInstanceRoots=0<i.length?i:void 0;var n=EditorExtends.PrefabUtils.checkAndStripNode(o,t);return this.removeInvalidPrefabData(o),this.setMountedRoot(o,void 0),r.data=o,{prefab:r,clearedReference:n}}addPrefabInfo(e,t,r){return EditorExtends.PrefabUtils.addPrefabInfo(e,t,r)}walkNode(e,t,r=!1){EditorExtends.PrefabUtils.walkNode(e,t,r)}addPrefabInfoToComponent(e){e.__prefab||(e.__prefab=new CompPrefabInfo),e.__prefab&&(e.__prefab.fileId=e.__prefab.fileId||e.uuid)}generatePrefabDataFromNode(e){let t=null;var r;return(t="string"==typeof e?cce.Node.query(e):e)&&({prefab:e,clearedReference:r}=this.getPrefabForSerialize(t),e)?(e.data._prefab.instance=void 0,this.removeInvalidPropertyOverrideReference(e.data),{prefabData:cce.Utils.serialize(e),clearedReference:r}):null}removeMountedRootInfo(e){e=e._prefab;e&&e.instance&&(e.instance.mountedChildren.forEach(e=>{e.nodes.forEach(e=>{this.setMountedRoot(e,void 0)})}),e.instance.mountedComponents.forEach(e=>{e.components.forEach(e=>{this.setMountedRoot(e,void 0)})}))}generateUUID(){return EditorExtends.UuidUtils.uuid()}createPrefabInstance(){var e=new PrefabInstance;return e.fileId=this.generateUUID(),e}createPrefabInfo(e){var t=new PrefabInfo;return t.fileId=e,t}cloneInstanceWithNewFileId(e){var t=this.createPrefabInstance(),r=e.propertyOverrides;t.propertyOverrides=[];for(let e=0;e<r.length;e++){var n=r[e],a=new PropertyOverrideInfo;a.targetInfo=n.targetInfo,a.propertyPath=n.propertyPath,a.value=n.value,t.propertyOverrides.push(a)}var o=e.mountedChildren;t.mountedChildren=[];for(let e=0;e<o.length;e++){var s=o[e],i=new MountedChildrenInfo;i.targetInfo=s.targetInfo,i.nodes=s.nodes.slice(),t.mountedChildren.push(i)}var f=e.mountedComponents;t.mountedComponents=[];for(let e=0;e<f.length;e++){var l=f[e],d=new MountedComponentsInfo;d.targetInfo=l.targetInfo,d.components=l.components.slice(),t.mountedComponents.push(d)}return t.removedComponents=e.removedComponents.slice(),t}getPrefabInstanceRoot(e){var t;let r=e,n=null;for(;r;){if(null!=(t=r._prefab)&&t.instance){n=r;break}r=r.parent}return n}isSameSourceTargetOverride(e,t,r,n){return!(e.source!==t||(r||e.sourceInfo)&&!compareStringArray(r,null==(t=e.sourceInfo)?void 0:t.localID)||!compareStringArray(e.propertyPath,n))}getSourceData(e){let t=e,r;var n,a=e.node;return a?(a._prefab&&!this.isMountedComponent(e)&&(n=(a=this.getOutMostPrefabInstanceInfo(a)).outMostPrefabInstanceNode)&&(t=n,(r=a.targetPath).splice(0,1),null!=(n=e.__prefab)&&n.fileId?r.push(null==(a=e.__prefab)?void 0:a.fileId):console.error(`can't get fileId of component: ${e.name} in node: `+e.node.name)),{sourceTarget:t,sourceLocalID:r}):null}removeTargetOverrideBySource(t,r){if(!t)return!1;if(!t.targetOverrides)return!1;let n=!1;for(let e=t.targetOverrides.length-1;0<=e;e--)t.targetOverrides[e].source===r&&(t.targetOverrides.splice(e,1),n=!0);return n}removeTargetOverride(t,e,r){if(!t)return!1;if(!t.targetOverrides)return!1;e=this.getSourceData(e);if(!e)return!1;var n=e.sourceTarget,a=e.sourceLocalID;let o=!1;for(let e=t.targetOverrides.length-1;0<=e;e--){var s=t.targetOverrides[e];this.isSameSourceTargetOverride(s,n,a,r)&&(t.targetOverrides.splice(e,1),o=!0)}return o}isInTargetOverrides(t,e,r){e=this.getSourceData(e);if(e){var n=e.sourceTarget,a=e.sourceLocalID;for(let e=0;e<t.length;e++){var o=t[e];if(this.isSameSourceTargetOverride(o,n,a,r))return!0}}return!1}getTargetOverride(t,e,r){let n=null;t.targetOverrides||(t.targetOverrides=[]);e=this.getSourceData(e);if(!e)return null;var a=e.sourceTarget,o=e.sourceLocalID;for(let e=0;e<t.targetOverrides.length;e++){var s=t.targetOverrides[e];if(this.isSameSourceTargetOverride(s,a,o,r)){n=s;break}}return n||((n=new TargetOverrideInfo).source=a,o&&(n.sourceInfo=new TargetInfo,n.sourceInfo.localID=o),n.propertyPath=r,t.targetOverrides.push(n)),n}getPropertyOverridesOfTarget(t,r){var n,a=[];for(let e=0;e<t.propertyOverrides.length;e++){var o=t.propertyOverrides[e];compareStringArray(null==(n=o.targetInfo)?void 0:n.localID,r)&&a.push(o)}return a}isInPropertyOverrides(t,r){for(let e=0;e<r.length;e++)if(compareStringArray(r[e].propertyPath,t))return!0;return!1}getPropertyOverride(t,r,n){var a;let o=null,s=null;for(let e=0;e<t.propertyOverrides.length;e++){var i=t.propertyOverrides[e];if(compareStringArray(null==(a=i.targetInfo)?void 0:a.localID,r)&&(s=i.targetInfo,compareStringArray(i.propertyPath,n))){o=i;break}}return o||(o=new PropertyOverrideInfo,s||((s=new TargetInfo).localID=r),o.targetInfo=s,o.propertyPath=n,t.propertyOverrides.push(o)),o}removePropertyOverride(t,r,n){var a;for(let e=t.propertyOverrides.length-1;0<=e;e--){var o=t.propertyOverrides[e];compareStringArray(null==(a=o.targetInfo)?void 0:a.localID,r)&&compareStringArray(o.propertyPath,n)&&t.propertyOverrides.splice(e,1)}}findPrefabInstanceMountedChildren(e,t){let r=null;var n=e.mountedChildren;for(let e=0;e<n.length;e++){var a=n[e];if(a.isTarget(t)){r=a;break}}return r}createMountedChildrenInfo(e){var t=new TargetInfo,e=(t.localID=e,new MountedChildrenInfo);return e.targetInfo=t,e}getPrefabInstanceMountedChildren(e,t){let r=this.findPrefabInstanceMountedChildren(e,t);return r||(r=this.createMountedChildrenInfo(t),e.mountedChildren.push(r)),r}getPrefabInstanceMountedComponents(e,t){let r=null;var n,a=e.mountedComponents;for(let e=0;e<a.length;e++){var o=a[e];if(o.isTarget(t)){r=o;break}}return r||((n=new TargetInfo).localID=t,(r=new MountedComponentsInfo).targetInfo=n,e.mountedComponents.push(r)),r}addRemovedComponent(e,t){var r=e.removedComponents;for(let e=0;e<r.length;e++){const n=r[e];if(compareStringArray(n.localID,t))return}const n=new TargetInfo;n.localID=t,r.push(n)}deleteRemovedComponent(e,t){var r=e.removedComponents;for(let e=0;e<r.length;e++)if(compareStringArray(r[e].localID,t)){r.splice(e,1);break}}isChildOfPrefabInstance(e){var t;let r=e.parent,n=!1;for(;r;){if(null!=(t=r._prefab)&&t.instance){n=!0;break}r=r.parent}return n}isPrefabInstanceRoot(e){var e=e._prefab;return!(!e||!e.instance||e.instance.prefabRootNode&&null!=(e=e.instance.prefabRootNode._prefab)&&e.instance)}isChildOfPrefabAsset(e){var t=e._prefab;return!!t&&!(!(e=e.parent)||!(e=e._prefab)||t.root!==e.root&&(null==(t=t.instance)?void 0:t.prefabRootNode)!==e.root)}isPartOfPrefabAsset(e){var t=e._prefab,r=this.getOutMostPrefabInstanceInfo(e);return!(!t||!r.outMostPrefabInstanceNode||this.isMountedChildOf(r.outMostPrefabInstanceNode,e))}isPartOfPrefabInstance(e){var t;let r=e,n=!1;for(;r;){if(null!=(t=r._prefab)&&t.instance){n=!0;break}r=r.parent}return n}isPartOfAssetInPrefabInstance(e){return!!this.isPartOfPrefabInstance(e)&&this.isPartOfPrefabAsset(e)}getOutMostPrefabInstanceInfo(e){var t=[];let r=null,n=e;for(;n;){var a=null==(a=n._prefab)?void 0:a.instance;if(a){if(t.unshift(a.fileId),r=n,!a.prefabRootNode)break;var o=a.prefabRootNode,s=cce.Scene.rootNode;if(o&&s&&isSameNode(o,s))break;if(pushNestedPrefab(n,a.prefabRootNode,t),n===a.prefabRootNode){console.warn("getOutMostPrefabInstanceInfo failed: prefab instance root node has loop");break}n=a.prefabRootNode}else n=n.parent}return{outMostPrefabInstanceNode:r,targetPath:t}}isSceneNode(e){return e instanceof cc_1.Scene}getPrefabStateInfo(e){let t=PrefabState.NotAPrefab,r=!1,n=!1,a=!1,o=!1,s="";var i;return this.isSceneNode(e)||(e._prefab&&(e._prefab.asset&&(s=e._prefab.asset._uuid),e._prefab.instance?(r=!0,n=!0,a=!0,t=PrefabState.PrefabInstance,i=this.getOutMostPrefabInstanceInfo(e)["outMostPrefabInstanceNode"],i!==e&&(r=!1,n=!1,a=!1)):t=PrefabState.PrefabChild,e._prefab.asset&&!e._prefab.asset.isDefault&&""!==e._prefab.asset.uuid||(t=PrefabState.PrefabLostAsset,r=!0),this.isSubAsset(s))&&(a=!1),e.parent&&!this.isSceneNode(e.parent)&&e.parent._prefab&&(i=this.getOutMostPrefabInstanceInfo(e.parent))&&i.outMostPrefabInstanceNode&&this.isMountedChildOf(i.outMostPrefabInstanceNode,e)&&(o=!0)),{state:t,isUnwrappable:r,isRevertable:n,isApplicable:a,isAddedChild:o,assetUuid:s}}getMountedRoot(e){return null==(e=e[cc_1.editorExtrasTag])?void 0:e.mountedRoot}setMountedRoot(e,t){e&&(e[cc_1.editorExtrasTag]||(e[cc_1.editorExtrasTag]={}),e[cc_1.editorExtrasTag].mountedRoot=t)}isMountedChildOf(e,t){t=this.getMountedRoot(t);return!(!t||t!==e)}isMountedComponent(e){var t=e.node;return!!t&&!!(t=this.getOutMostPrefabInstanceInfo(t).outMostPrefabInstanceNode)&&!(!(e=this.getMountedRoot(e))||e!==t)}getRemovedComponents(e){var t=[],r=e._prefab;if(r){var n=this.getOutMostPrefabInstanceInfo(e),a=n.outMostPrefabInstanceNode;if(a){var n=n.targetPath,o=null==(o=a._prefab)?void 0:o.instance,a=a._prefab;if(o&&a&&a.asset){if(o.removedComponents.length<=0)return t;n.splice(0,1),n.push(r.fileId);o=this.getPrefabAssetNodeInstance(a);if(!o)return t;r=this.getTarget(n,o,!0);if(!r)return t;var s=e.components.map(e=>{return null==(e=e.__prefab)?void 0:e.fileId}).filter(e=>!!e);for(const i of r.components)!i.__prefab||s.includes(i.__prefab.fileId)||t.push(i)}}}return t}checkToRemoveTargetOverride(e,t){t&&this.removeTargetOverrideBySource(t._prefab,e)&&this.fireChangeMsg(t)}findOutmostPrefabInstanceNodes(e,t){var r=e._prefab;null!=r&&r.instance?(t.push(e),r.nestedPrefabInstanceRoots&&(r.nestedPrefabInstanceRoots.forEach(e=>{e._prefab&&(e._prefab.nestedPrefabInstanceRoots=void 0)}),r.nestedPrefabInstanceRoots=void 0),null!=(r=null==(r=r.instance)?void 0:r.mountedChildren)&&r.forEach(e=>{e.nodes.forEach(e=>{this.findOutmostPrefabInstanceNodes(e,t)})})):e.children.forEach(e=>{this.findOutmostPrefabInstanceNodes(e,t)})}gatherPrefabInstanceRoots(e){const t=[];e.children.forEach(e=>{node_1.default.isEditorNode(e)||this.findOutmostPrefabInstanceNodes(e,t)}),0<t.length?(e._prefab||(e._prefab=prefabUtils.createPrefabInfo(e.uuid)),e._prefab.nestedPrefabInstanceRoots=t):(e=e._prefab)&&(e.nestedPrefabInstanceRoots=void 0)}isSubAsset(e){return e.includes("@")}removePrefabInfo(e){this.fireBeforeChangeMsg(e),e._prefab=null,e.components.forEach(e=>{e.__prefab=null}),this.fireChangeMsg(e)}checkMountedRootData(r,e){var n=this.getMountedRoot(r);if(n){let t=!1;var a=null==(n=n._prefab)?void 0:n.instance;if(a&&a.mountedChildren)for(let e=0;e<a.mountedChildren.length;e++)if(a.mountedChildren[e].nodes.includes(r)){t=!0;break}t||this.setMountedRoot(r,void 0)}r.components.forEach(r=>{var e=this.getMountedRoot(r);if(e){let t=!1;var n=null==(e=e._prefab)?void 0:e.instance;if(n&&n.mountedComponents)for(let e=0;e<n.mountedComponents.length;e++)if(n.mountedComponents[e].components.includes(r)){t=!0;break}t||this.setMountedRoot(r,void 0)}}),e&&r.children.forEach(e=>{this.checkMountedRootData(e,!0)})}removePrefabInstanceRoots(e){e=e._prefab;e&&(e.nestedPrefabInstanceRoots=void 0)}checkTargetOverridesData(e){e=e._prefab;if(e){var t=e.targetOverrides;if(t)for(let e=t.length-1;0<=e;e--){var r=t[e];r&&r.source||t.splice(e,1)}}}isOutmostPrefabInstanceMountedChildren(e){let t=e;for(;t;){var r=this.getMountedRoot(t);if(r)if(this.getOutMostPrefabInstanceInfo(r).outMostPrefabInstanceNode===r)return!0;if(!(t=t.parent)||this.isPrefabInstanceRoot(t))break}return!1}removeInvalidPropertyOverrides(e){var t=e._prefab;if(t&&t.instance){var r=t.instance.propertyOverrides,t=r.length,n=this.getTargetMap(e);if(n&&0!==Object.keys(n).length)for(let e=t-1;0<=e;e--){var a=r[e].targetInfo;a&&!cc_1.Prefab._utils.getTarget(a.localID,n)&&r.splice(e,1)}else console.debug("removeInvalidPropertyOverrides return,targetMap is empty",e)}}removeInvalidTargetOverrides(e){e=null==e?void 0:e._prefab;if(e){var n=e.targetOverrides;if(n)for(let r=n.length-1;0<=r;r--){var a=n[r];let e=a.source;var o,t=a.sourceInfo,s=a.targetInfo;if((e=t&&a.source instanceof cc_1.Node?this.getTarget(t.localID,a.source):e)&&s&&(a.target instanceof cc_1.Node&&(o=this.getTarget(s.localID,a.target)))){var i=a.propertyPath.slice();let t=e;for(let e=0;e<i.length;e++){var f=i[e],l=cc_1.CCClass.Attr.getClassAttrs(t.constructor);if(!(t=t[f])){n.splice(r,1);break}e===i.length-1&&(f=f+DELIMETER+"ctor",!isInClassChain(t.constructor,o.constructor)||l&&l[f]&&!isInClassChain(o.constructor,l[f]))&&n.splice(r,1)}}}}}removeInvalidPrefabData(e){this.removeInvalidTargetOverrides(e);e=e._prefab,e=null==e?void 0:e.nestedPrefabInstanceRoots;e&&e.forEach(e=>{this.removeInvalidPropertyOverrides(e)})}removeInvalidPropertyOverrideReference(o){var e=this.getPrefab(o);const s=new Map;return e&&null!=(e=e.nestedPrefabInstanceRoots)&&e.forEach(r=>{var e=this.getPrefab(r),n=null==(e=null==e?void 0:e.instance)?void 0:e.propertyOverrides;if(n)for(let t=n.length-1;0<=t;t--){var a=n[t];let e=a.value;if(e instanceof cc.Component.EventHandler?e=e.target:e instanceof cc.Component&&(e=e.node),e&&e instanceof cc.Node&&!e.isChildOf(o)){n.splice(t,1);let e=s.get(r);e||(e=[],s.set(r,e)),e.push(a)}}}),s}}PrefabUtil.PrefabState=PrefabState;const prefabUtils=new PrefabUtil;exports.prefabUtils=prefabUtils;