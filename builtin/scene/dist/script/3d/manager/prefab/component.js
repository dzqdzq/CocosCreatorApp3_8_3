"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.componentOperation=void 0;const cc_1=require("cc"),utils_1=require("./utils"),node_1=__importDefault(require("../node")),dump_1=__importDefault(require("../../../export/dump")),scene_facade_state_interface_1=require("../../facade/scene-facade-state-interface"),undo_1=require("../../../export/undo"),CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo;class ApplyRemoveComponentCommand extends undo_1.SceneUndoCommand{constructor(e,t){super(),this.removedCompInfo=null,this._undoFunc=e,this._redoFunc=t}async undo(){this.removedCompInfo&&this._undoFunc(this.removedCompInfo)}async redo(){this.removedCompInfo&&this._redoFunc(this.removedCompInfo.nodeUUID,this.removedCompInfo.compData.__prefab.fileId)}}class ComponentOperation{constructor(){this.isRevertingRemovedComponents=!1,this.isRemovingMountedComponents=!1,this.compMap={}}cacheComp(e){this.compMap[e.uuid]=e._instantiate()}getCachedComp(e){return this.compMap[e]}clearCompCache(){this.compMap={}}onAddComponent(e){this.cacheComp(e),this.isRevertingRemovedComponents||(e=e.node)&&e._prefab&&this.updateMountedComponents(e)}onComponentAdded(e,t){this.cacheComp(e),t.modeName===scene_facade_state_interface_1.SceneModeType.Prefab&&e.node&&e.node._prefab&&(e.__prefab||(e.__prefab=new CompPrefabInfo,e.__prefab.fileId=e.uuid))}onRemoveComponentInGeneralMode(e,t){var n,o;this.isRemovingMountedComponents||(n=e.node)&&n._prefab&&(o=utils_1.prefabUtils.getMountedRoot(e),e.__prefab&&!o?this.onPrefabComponentRemoved(e):this.updateMountedComponents(n))}onPrefabComponentRemoved(e){var t,n,o=e.__prefab;o&&(e=e.node)._prefab&&(t=(e=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(e)).outMostPrefabInstanceNode)&&(e=e.targetPath,n=null==(n=t._prefab)?void 0:n.instance)&&(e.splice(0,1),e.push(o.fileId),utils_1.prefabUtils.fireBeforeChangeMsg(t),utils_1.prefabUtils.addRemovedComponent(n,e),utils_1.prefabUtils.fireChangeMsg(t))}onComponentRemovedInGeneralMode(e,t){this.isRemovingMountedComponents||utils_1.prefabUtils.checkToRemoveTargetOverride(e,t)}async doApplyRemovedComponent(e,t){var n=node_1.default.query(e);if(n){var o=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(n),a=o.outMostPrefabInstanceNode;if(a){var o=o.targetPath,s=null==(s=a._prefab)?void 0:s.instance,r=a._prefab;if(s&&r&&r.asset){var i=r.asset._uuid;if(utils_1.prefabUtils.isSubAsset(i))return console.warn("can't apply RemovedComponent in SubAsset Prefab"),null;o.splice(0,1),o.push(t);i=utils_1.prefabUtils.getPrefabAssetNodeInstance(r);if(!i)return null;var t=utils_1.prefabUtils.getTarget(o,i),p=t.node.components.indexOf(t),f=t._instantiate();if(!f)return null;null!=(l=n._prefab)&&l.instance&&(null==(l=n._prefab)?void 0:l.instance)!==s&&(l=(n=i._prefab).instance,n.instance=void 0,this.onRemoveComponentInGeneralMode(t,i),n.instance=l),t._destroyImmediate();var n=i._prefab,l=(n&&(n.instance=void 0),utils_1.prefabUtils.generatePrefabDataFromNode(i));return l?(t=l.prefabData,(n=await Editor.Message.request("asset-db","query-asset-info",r.asset._uuid))?(utils_1.prefabUtils.fireBeforeChangeMsg(a),utils_1.prefabUtils.deleteRemovedComponent(s,o),utils_1.prefabUtils.fireChangeMsg(a),await Editor.Message.request("asset-db","create-asset",n.source,t,{overwrite:!0}),cce.SceneFacadeManager.abortSnapshot(),{nodeUUID:e,compIndex:p,compData:f}):null):null}}}return null}async undoApplyRemovedComponent(e){var t,n,o,a,s,r;e&&(s=node_1.default.query(e.nodeUUID))&&(t=(n=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(s)).outMostPrefabInstanceNode)&&(n=n.targetPath,o=null==(o=t._prefab)?void 0:o.instance,a=t._prefab,o)&&a&&a.asset&&(n.splice(0,1),(r=n.slice()).push(s._prefab.fileId),s=e.compData.__prefab.fileId,n.push(s),s=utils_1.prefabUtils.getPrefabAssetNodeInstance(a))&&(utils_1.prefabUtils.getTarget(r,s)._addComponentAt(e.compData,e.compIndex),r=utils_1.prefabUtils.generatePrefabDataFromNode(s))&&(e=await Editor.Message.request("asset-db","query-asset-info",a.asset._uuid))&&(utils_1.prefabUtils.fireBeforeChangeMsg(t),utils_1.prefabUtils.addRemovedComponent(o,n),utils_1.prefabUtils.fireChangeMsg(t),await Editor.Message.request("asset-db","create-asset",e.source,r.prefabData,{overwrite:!0}),cce.SceneFacadeManager.abortSnapshot())}async applyRemovedComponent(e,t){var n=new ApplyRemoveComponentCommand(this.undoApplyRemovedComponent.bind(this),this.doApplyRemovedComponent.bind(this)),o=cce.SceneFacadeManager.beginRecording(e,{customCommand:n}),e=await this.doApplyRemovedComponent(e,t);e?(n.removedCompInfo=e,cce.SceneFacadeManager.endRecording(o)):cce.SceneFacadeManager.cancelRecording(o)}async cloneComponentToNode(e,t){var n,o=dump_1.default.dumpComponent(t),a=(delete o.value._objFlags,e.addComponent(cc_1.js.getClassName(t))),s=e.components;s&&s.length&&(n=s[s=s.length-1])&&n===a&&(await dump_1.default.restoreProperty(e,"__comps__."+s,o),a instanceof cc_1.MissingScript)&&(a._$erialized=t._$erialized)}async revertRemovedComponent(e,t){var n,o,a,s,r=node_1.default.query(e);r&&(n=(o=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(r)).outMostPrefabInstanceNode)&&(o=o.targetPath,a=null==(a=n._prefab)?void 0:a.instance,s=n._prefab,a)&&s&&s.asset&&(o.splice(0,1),o.push(t),t=(0,cc_1.instantiate)(s.asset))&&(s=cce.SceneFacadeManager.beginRecording([n.uuid,e]),e=utils_1.prefabUtils.getTarget(o,t),utils_1.prefabUtils.fireBeforeChangeMsg(r),this.isRevertingRemovedComponents=!0,await this.cloneComponentToNode(r,e),this.isRevertingRemovedComponents=!1,utils_1.prefabUtils.fireChangeMsg(r),utils_1.prefabUtils.fireBeforeChangeMsg(n),utils_1.prefabUtils.deleteRemovedComponent(a,o),utils_1.prefabUtils.fireChangeMsg(n),cce.SceneFacadeManager.endRecording(s))}updateMountedComponents(t){var e=t._prefab;if(e){var n=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(t);const l=n.outMostPrefabInstanceNode;if(!l)return null;var o=n.targetPath,n=l._prefab,a=null==n?void 0:n.instance;if(l&&n&&a){n=utils_1.prefabUtils.getPrefabAssetNodeInstance(n);if(n){o.splice(0,1),o.push(e.fileId);e=utils_1.prefabUtils.getTarget(o,n);if(e){var s=e.components.map(e=>{return null==(e=e.__prefab)?void 0:e.fileId}),r=[];for(let e=0;e<t.components.length;e++){var i,p=t.components[e];p.__prefab&&(s.includes(null==(i=p.__prefab)?void 0:i.fileId)||(i=utils_1.prefabUtils.getMountedRoot(p))&&i!==l)||r.push(p)}if(utils_1.prefabUtils.fireBeforeChangeMsg(l),0<r.length){n=utils_1.prefabUtils.getPrefabInstanceMountedComponents(a,o);n.components=r,n.components.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,l)})}else for(let e=0;e<a.mountedComponents.length;e++){var f=a.mountedComponents[e];if(f.isTarget(o)){f.components.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,void 0)}),a.mountedComponents.splice(e,1);break}}utils_1.prefabUtils.fireChangeMsg(l)}}}}}applyMountedComponents(e){var t=e;const r=t._prefab;if(r){const i=r.instance;if(i){const p=new Map;var n=i.mountedComponents;for(let e=0;e<n.length;e++){var o=n[e];const f=o.targetInfo;if(f){const l=utils_1.prefabUtils.getTarget(f.localID,t);l&&o.components.forEach(e=>{var t,n,o,a,s;e.__prefab||(e.__prefab=new CompPrefabInfo,e.__prefab.fileId=e.uuid),1<f.localID.length?(r.instance=void 0,t=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(l),r.instance=i,(n=t.outMostPrefabInstanceNode)&&(o=n._prefab)&&(o=o.instance)&&(s=l._prefab)&&((a=t.targetPath.slice(1)).push(s.fileId),utils_1.prefabUtils.getPrefabInstanceMountedComponents(o,a).components.push(e),utils_1.prefabUtils.setMountedRoot(e,n),(s=t.targetPath.slice()).push(e.__prefab.fileId),p.set(s,{prefabInfo:null}))):(p.set([e.__prefab.fileId],{prefabInfo:null}),utils_1.prefabUtils.setMountedRoot(e,void 0))})}}return i.mountedComponents=[],p}}}}const componentOperation=new ComponentOperation;exports.componentOperation=componentOperation;