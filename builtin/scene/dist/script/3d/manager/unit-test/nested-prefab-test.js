"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.nestedPrefabTest=void 0;const node_1=__importDefault(require("../node")),cc_1=require("cc"),common_1=require("./common"),cubeAssetUUID="30da77a1-f02d-4ede-aa56-403452ee7fde",boxColliderClassName=cc_1.js.getClassName(cc_1.BoxCollider),testPrefabAssetUrl="db://assets/testPrefab.prefab",childPrefabAssetUrl="db://assets/childPrefab.prefab",cubeNode2PrefabAssetUrl="db://assets/CubeNode2.prefab";class NestedPrefabTest{async test(a){console.log("NestedPrefabTest-----------");const t=1200;await a.openScene("");var e=await a.createNode({name:"testPrefab"});if(!e)return(0,common_1.returnFalseWithLog)("testNodeUUID check failed");var n=await a.createPrefab(e,testPrefabAssetUrl);if(!n)return(0,common_1.returnFalseWithLog)("testPrefabAssetUUID check failed");e=(await a.queryNodesByAssetUuid(n))[0],await new Promise(e=>{setTimeout(function(){e()},t)});let r=node_1.default.query(e);var i=(0,common_1.getPrefabInfo)(r);if(null==i||!i.fileId)return(0,common_1.returnFalseWithLog)("rootNodePrefabInfo.fileID check failed");i=null==(i=i.instance)?void 0:i.propertyOverrides;if(!i||4!==i.length)return(0,common_1.returnFalseWithLog)("property overrides doesn't match");let s="",o=null;async function d(e,t="testPrefab"){if(a.openScene(e),await new Promise(e=>{setTimeout(function(){e()},500)}),!(o=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");r=o.getChildByName(t),s=r.uuid}await d(n);await a.createNode({name:"childCylinderNode",assetUuid:"ab3e16f9-671e-48a7-90b7-d0884d9cbb85",parent:s});var i=await a.createNode({name:"childPrefab",assetUuid:cubeAssetUUID,parent:s}),i=(await a.createNode({name:"CubeNode",assetUuid:cubeAssetUUID,parent:i}),await a.createPrefab(i,childPrefabAssetUrl)),c=(await new Promise(e=>{setTimeout(function(){e()},t)}),await a.saveScene(),await a.openScene(i),await new Promise(e=>{setTimeout(function(){e()},500)}),await a.saveScene(),await d(n),r.children[1]),u="CubeNode2",l=await a.createNode({name:u,assetUuid:cubeAssetUUID,parent:c.uuid});await a.createNode({name:"CubeNode2Child",assetUuid:cubeAssetUUID,parent:l});let f=c.children[0];if(node_1.default.createComponent(f.uuid,boxColliderClassName),await a.saveScene(),await a.closeScene(),await d(n),2!==(c=r.children[1]).children.length)return(0,common_1.returnFalseWithLog)("mounted child in nested prefab save failed. "+c.children.length);if(!(f=c.children[0]).getComponent(boxColliderClassName))return(0,common_1.returnFalseWithLog)("mounted component in nested prefab save failed");if(1!==c.children[1].children.length)return(0,common_1.returnFalseWithLog)("mounted component in nested prefab save failed");l=c.children[1].uuid,await a.createPrefab(l,cubeNode2PrefabAssetUrl);if(await new Promise(e=>{setTimeout(function(){e()},t)}),!(o=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");r=o.getChildByName("testPrefab"),s=r.uuid;l=(c=r.children[1]).children[1];if(l.name!==u)return(0,common_1.returnFalseWithLog)("mounted prefabInstance node in nested prefab save failed");u="CubeNode2NewName";if(await a.setNodeProperty({uuid:l.uuid,path:"name",dump:{type:"String",value:u}}),await a.saveScene(),await a.closeScene(),await d(n),(l=(c=r.children[1]).children[1]).name!==u)return(0,common_1.returnFalseWithLog)("mounted prefabInstance node in nested prefab change name failed");if(await a.unlinkPrefab(l.uuid,!1),await a.saveScene(),await a.closeScene(),await d(n),(l=(c=r.children[1]).children[1]).name!==u)return(0,common_1.returnFalseWithLog)("mounted prefabInstance node in nested prefab change name failed");if(1!==l.children.length)return(0,common_1.returnFalseWithLog)("mounted prefabInstance node in nested prefab unWrap failed");await a.duplicateNode(c.uuid);var u=r.children[2],l=(0,common_1.getPrefabInfo)(c),m=(0,common_1.getPrefabInfo)(u);if(null!=l&&l.instance&&null!=m&&m.instance&&l.instance.fileId===m.instance.fileId)return(0,common_1.returnFalseWithLog)("duplicate prefabInstance node has the same fileId");if(a.unlinkPrefab(c.uuid,!1),a.unlinkPrefab(u.uuid,!1),await a.saveScene(),await a.closeScene(),await new Promise(e=>{setTimeout(function(){e()},500)}),!(o=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");if(r=o.getChildByName("testPrefab"),s=r.uuid,c=r.children[1],u=r.children[2],c.uuid===u.uuid)return(0,common_1.returnFalseWithLog)("unWrap duplicate prefabInstance node has the same uuid");if(l=(0,common_1.getPrefabInfo)(c),m=(0,common_1.getPrefabInfo)(u),l&&m&&l.fileId===m.fileId)return(0,common_1.returnFalseWithLog)("unWrap duplicate prefabInstance node has the same fileId");await d(n),c=r.children[1],u=r.children[2],a.removeNode({uuid:c.uuid}),a.removeNode({uuid:u.uuid});a.createNode({parent:s,type:"cc.Prefab",assetUuid:i});await new Promise(e=>{setTimeout(function(){e()},500)}),c=r.children[1],f=c.children[0],a.setNodeProperty({uuid:f.uuid,path:"__comps__.0.shadowCastingMode",dump:{type:"Enum",value:1}}),await a.saveScene(),await a.closeScene(),await d(n),c=r.children[1];l=(f=c.children[0]).getComponent(cc_1.MeshRenderer);return 1!==(null==l?void 0:l.shadowCastingMode)?(0,common_1.returnFalseWithLog)("component value in nested prefab not saved correctly"):(await a.saveScene(),await a.closeScene(),(o=cc_1.director.getScene())?(e=(r=o.getChildByName("testPrefab")).uuid,a.removeNode({uuid:e}),!0):(0,common_1.returnFalseWithLog)("scene is null"))}async clear(){return cce.Selection.clear(),await Editor.Message.request("asset-db","delete-asset",testPrefabAssetUrl),await Editor.Message.request("asset-db","delete-asset",childPrefabAssetUrl),await Editor.Message.request("asset-db","delete-asset",cubeNode2PrefabAssetUrl),!0}}const nestedPrefabTest=new NestedPrefabTest;exports.nestedPrefabTest=nestedPrefabTest;