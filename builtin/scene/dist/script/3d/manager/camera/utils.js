"use strict";var CameraMoveMode,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CameraUtils=exports.CameraMoveMode=void 0;const cc_1=require("cc"),editor_camera_components_1=__importDefault(require("./editor-camera-components")),path_1=require("path"),_maxTicks=100,vbMap=new Map,ibMap=new Map;class Utils{_createHtml(t){var s=document.createElement("div");s.hidden=!0,s.id=t.rootID,s.innerHTML=t.innerHTML;let r;if(t.imgInfos){r=[];for(let e=0;e<t.imgInfos.length;e++){var o=t.imgInfos[e],a=s.querySelector(o.selector);a.onerror=e=>{console.error(e)},a.src=o.src,r.push(a)}}return document.body.appendChild(s),{imgs:r,root:s}}constructor(){this.$cameraMoveInfo=this._createHtml({rootID:"cameraInfo",innerHTML:`
            <style>
                #cameraInfo { 
                    position: absolute;
                    bottom: 10px;
                    left: 10px;
                    text-align: center;
                }
                #cameraInfo #wasd {
                    width: 104px;
                    height: 52px;
                }
            </style>
            <img id="wasd"/>
            `,imgInfos:[{selector:"#wasd",src:"file://"+(0,path_1.join)(__dirname,"../../../../../static/icons/wasd.png")}]}).root;var e=this._createHtml({rootID:"snapInfo",innerHTML:`
            <style>    
                #snapInfo { 
                    position: absolute;
                    bottom: 10px;
                    left: 10px;
                }
            </style>
            <img class="snap" width="215px" height="66px" id="snapInfoEN">
            <img class="snap" width="162px" height="66px" id="snapInfoZH">
            `,imgInfos:[{selector:"#snapInfoEN",src:"file://"+(0,path_1.join)(__dirname,"../../../../../static/icons/snap-ui-en.png")},{selector:"#snapInfoZH",src:"file://"+(0,path_1.join)(__dirname,"../../../../../static/icons/snap-ui-zh.png")}]});this.$snapInfoEN=e.imgs[0],this.$snapInfoZH=e.imgs[1],this.$snapInfoRoot=e.root}updateSnapInfoUI(){"zh"===Editor.I18n.getLanguage()?(this.$snapInfoEN.hidden=!0,this.$snapInfoZH.hidden=!1):(this.$snapInfoZH.hidden=!0,this.$snapInfoEN.hidden=!1)}showSnapTip(){this.$snapInfoRoot.hidden=!1,this.updateSnapInfoUI()}hideSnapTip(){this.$snapInfoRoot.hidden=!0}showCameraMoveTip(){this.$cameraMoveInfo.hidden=!1}hideCameraMoveTip(){this.$cameraMoveInfo.hidden=!0}updateVBAttr(s,r,o){s=s&&s.model&&s.model.subModels[0];if(s&&s.inputAssembler&&s.subMesh){var{inputAssembler:s,subMesh:a}=s,n=vbMap.get(a);if(n){let e=0,t=cc_1.gfx.Format.UNKNOWN;for(const i of s.attributes){if(i.name===r){t=i.format;break}e+=cc_1.gfx.FormatInfos[i.format].size}s=s.vertexBuffers[0];t&&s&&(cc_1.utils.writeBuffer(new DataView(n),o,t,e,s.stride),s.update(n,s.stride*s.count),a.geometricInfo)&&a.geometricInfo.positions.set(o)}else console.error(a,n)}}updateIB(e,t){var s,r,o,a,e=e&&e.model&&e.model.subModels[0];e&&e.inputAssembler&&e.subMesh&&({inputAssembler:e,subMesh:s}=e,(r=ibMap.get(s))?(a=e.indexCount,o=e.indexBuffer,a&&o&&(a=cc_1.gfx.Format[`R${8*o.stride}UI`],cc_1.utils.writeBuffer(new DataView(r),t,a),o.update(r,o.stride*o.count),e.indexCount=t.length)):console.error(s,r))}grid(e,t,s,r){const a=[],n=[],i=[];var o=.5*e,c=.5*t,d=e/s,p=t/r,e=cc.v3(-o,-.1,-c),s=cc.v3(o,.1,c);function u(e,t,s,r){var o=a.length/3;e===s?(a.push(e+.01,0,t),n.push(1,0),a.push(e-.01,0,t),n.push(0,0),a.push(e+.01,0,r),n.push(1,0),a.push(e-.01,0,r),n.push(0,0)):(a.push(e,0,t-.01),n.push(0,1),a.push(e,0,t+.01),n.push(1,1),a.push(s,0,t-.01),n.push(0,1),a.push(s,0,t+.01),n.push(1,1)),i.push(o,1+o,2+o,2+o,1+o,3+o)}for(let e=-o;e<=o;e+=d)u(e,-c,e,c);for(let e=-c;e<=c;e+=p)u(-o,e,o,e);return{positions:a,uvs:n,indices:i,minPos:e,maxPos:s}}createStrokeGrid(e,t){var s=new cc.Node("Editor Grid"),s=(s.layer=cc.Layers.Enum.EDITOR|cc.Layers.Enum.IGNORE_RAYCAST,s.parent=cce.backgroundNode,s.addComponent(cc_1.MeshRenderer));s.mesh=cc_1.utils.createMesh(this.grid(e,t,e,t));const r=s.onEnable.bind(s);s.onEnable=()=>{r()};e=new cc.Material;return e.initialize({effectName:"internal/editor/grid-stroke"}),s.material=e,s}createGrid(e){var t=new cc.Node(e),t=(t.layer=cc.Layers.Enum.EDITOR|cc.Layers.Enum.IGNORE_RAYCAST,t.parent=cce.backgroundNode,t.setWorldPosition(cc.v3(0,0,0)),t.addComponent(cc_1.MeshRenderer));const s=t.onEnable.bind(t);t.onEnable=()=>{s()};var r=[],o=[],a=[];for(let e=0;e<_maxTicks*_maxTicks;e++)r.push(0,0),o.push(1,1,1,1);for(let e=0;e<r.length;e+=2)a.push(e/2);var n=cc_1.gfx.PrimitiveMode.LINE_LIST,i=[{name:cc_1.gfx.AttributeName.ATTR_POSITION,format:cc_1.gfx.Format.RG32F}],i=cc.utils.createMesh({positions:r,indices:a,colors:o,primitiveMode:n,attributes:i}),c=i.renderingSubMeshes[0],d=i.struct.vertexBundles[0].view,d=i.data.buffer.slice(d.offset,d.offset+d.length),d=(vbMap.set(c,d),i.struct.primitives[0].indexView),d=i.data.buffer.slice(d.offset,d.offset+d.length),c=(ibMap.set(c,d),t.mesh=i,new cc.Material);return c.initialize({effectName:e,states:{primitive:n}}),t.material=c,t}createCamera(e){var t=new cc.Node("Editor Camera"),t=(t.layer=cc.Layers.Enum.EDITOR,t.parent=cce.backgroundNode,t.addComponent(editor_camera_components_1.default));return t.clearFlags=cc_1.Camera.ClearFlag.SKYBOX|cc_1.gfx.ClearFlagBit.COLOR,t.clearColor=e,t.visibility=cc_1.Layers.makeMaskExclude([cc_1.Layers.BitMask.PROFILER,cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO]),t.far=1e5,t.near=.1,t}queryLightNodes(t){const s=[];return cce.Node.queryUuids().forEach(e=>{e=cce.Node.query(e);e&&!t.includes(e)&&e.getComponent(cc_1.Light)&&s.push(e)}),s}isSceneHasActiveLight(t){let s=!1;const r=[];return t.forEach(e=>{var t;e.active&&((t=e.getComponent(cc_1.Light))?!0===t.enabled&&(s=!0):r.push(e))}),r.forEach(e=>{e=t.indexOf(e);t.splice(e,1)}),s}queryComponent(t){const s=[];return cce.Node.queryUuids().forEach(e=>{var e=cce.Node.query(e);e&&(e=e.getComponent(t))&&s.push(e)}),s}}!function(e){e[e.IDLE=0]="IDLE",e[e.ORBIT=1]="ORBIT",e[e.PAN=2]="PAN",e[e.ZOOM=3]="ZOOM",e[e.WANDER=4]="WANDER"}(CameraMoveMode=CameraMoveMode||{}),exports.CameraMoveMode=CameraMoveMode;const CameraUtils=new Utils;exports.CameraUtils=CameraUtils;