"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.WanderMode=void 0;const mode_base_1=require("./mode-base"),utils_1=require("../../utils"),operation_1=__importDefault(require("../../../operation")),cc_1=require("cc"),quat_1=require("../../../../../utils/math/quat"),vec3_1=require("../../../../../utils/math/vec3"),animate_value_1=require("../../animate-value"),v3a=new cc_1.Vec3,v3b=new cc_1.Vec3,v3c=new cc_1.Vec3,v3d=new cc_1.Vec3,_wanderKeys=["q","w","e","a","s","d"];class WanderMode extends mode_base_1.ModeBase{constructor(){super(...arguments),this._curMouseDX=0,this._curMouseDY=0,this._rotateSpeed=.002,this._movingSpeedShiftScale=10,this._damping=.6,this._wanderSpeed=10,this._flyAcceleration=2,this._shiftKey=!1,this._velocity=new cc_1.Vec3,this._wanderKeyDown=!1,this._destPos=new cc_1.Vec3,this._destRot=new cc_1.Quat,this._wanderSpeedTarget=0,this._wanderAnim=new animate_value_1.AnimVec3(new cc_1.Vec3),this._enableAcceleration=!0}get wanderSpeed(){return this._wanderSpeed}set wanderSpeed(e){this._wanderSpeed=e}get enableAcceleration(){return this._enableAcceleration}set enableAcceleration(e){this._enableAcceleration=e}async enter(){var e=this._cameraCtrl.node;e.getWorldPosition(this._curPos),e.getWorldRotation(this._curRot),this._destPos=this._curPos.clone(),this._destRot=this._curRot.clone(),utils_1.CameraUtils.showCameraMoveTip(),this._curMouseDX=0,this._curMouseDY=0,operation_1.default.requestPointerLock(),this._cameraCtrl.emit("camera-move-mode",utils_1.CameraMoveMode.WANDER),cce.Engine.enterState(cce.NeedAnimState.CAMERA_WANDER)}async exit(){operation_1.default.exitPointerLock(),utils_1.CameraUtils.hideCameraMoveTip(),this._cameraCtrl.updateViewCenterByDist(-this._cameraCtrl.viewDist),cce.Engine.exitState(cce.NeedAnimState.CAMERA_WANDER),this._velocity.set(0,0,0)}onMouseMove(e){return this._curMouseDX+=e.moveDeltaX,this._curMouseDY+=e.moveDeltaY,!1}onMouseWheel(e){}onKeyDown(e){this._shiftKey=e.shiftKey;e=e.key.toLowerCase();switch(e){case"d":this._velocity.x=1;break;case"a":this._velocity.x=-1;break;case"e":this._velocity.y=1;break;case"q":this._velocity.y=-1;break;case"s":this._velocity.z=1;break;case"w":this._velocity.z=-1}_wanderKeys.includes(e)&&!this._wanderKeyDown&&(this._wanderKeyDown=!0)}onKeyUp(e){this._shiftKey=e.shiftKey;e=e.key.toLowerCase();switch(e){case"d":0<this._velocity.x&&(this._velocity.x=0);break;case"a":this._velocity.x<0&&(this._velocity.x=0);break;case"e":0<this._velocity.y&&(this._velocity.y=0);break;case"q":this._velocity.y<0&&(this._velocity.y=0);break;case"s":0<this._velocity.z&&(this._velocity.z=0);break;case"w":this._velocity.z<0&&(this._velocity.z=0)}_wanderKeys.includes(e)&&this._velocity.equals3f(0,0,0)&&(this._wanderKeyDown=!1)}onUpdate(t){var e=this._destPos,i=this._destRot,s=(quat_1.MQuat.rotateX(i,i,-this._curMouseDY*this._rotateSpeed),quat_1.MQuat.rotateAround(i,i,cc_1.Vec3.UNIT_Y,-this._curMouseDX*this._rotateSpeed),v3b),s=(quat_1.MQuat.toEuler(s,i),quat_1.MQuat.fromEuler(i,s.x,s.y,0),quat_1.MQuat.slerp(this._curRot,this._curRot,i,this._damping),0<this._velocity.lengthSqr()),i=this._shiftKey?this._movingSpeedShiftScale:1;if(s){let e=1;this._enableAcceleration&&(e=Math.pow(this._flyAcceleration,t)),this._wanderSpeedTarget=this._wanderSpeedTarget<cc_1.math.EPSILON?this._wanderSpeed:this._wanderSpeedTarget*e}else this._wanderSpeedTarget=0;cc_1.Vec3.multiplyScalar(v3c,this._velocity.normalize(),this._wanderSpeedTarget*i),this._wanderAnim.target=v3c,this._wanderAnim.update(t),v3c.set(0,0,0),vec3_1.MVec3.multiplyScalar(v3d,this._wanderAnim.value,t),vec3_1.MVec3.transformQuat(v3d,v3d,this._curRot),vec3_1.MVec3.add(e,e,v3d),vec3_1.MVec3.lerp(this._curPos,this._curPos,e,this._damping),this._cameraCtrl.node.setPosition(this._curPos),this._cameraCtrl.node.setRotation(this._curRot),this._curMouseDX=0,this._curMouseDY=0,this._cameraCtrl.updateGrid()}}exports.WanderMode=WanderMode;