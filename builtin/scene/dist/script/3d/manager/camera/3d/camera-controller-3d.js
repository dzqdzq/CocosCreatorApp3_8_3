"use strict";var ModeCommand,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CameraController3D=exports.smoothMouseWheelScale=void 0;const node_1=__importDefault(require("../../../../utils/node")),camera_controller_base_1=__importDefault(require("../camera-controller-base")),linear_ticks_1=__importDefault(require("../grid/linear-ticks")),tween_1=require("../tween"),utils_1=require("../utils"),cc_1=require("cc"),quat_1=require("../../../../utils/math/quat"),vec3_1=require("../../../../utils/math/vec3"),finite_state_machine_1=__importDefault(require("../../../utils/state-machine/finite-state-machine")),orbit_mode_1=require("./mode/orbit-mode"),pan_mode_1=require("./mode/pan-mode"),wander_mode_1=require("./mode/wander-mode"),idle_mode_1=require("./mode/idle-mode"),_lineColor=cc.color().fromHEX("#555555"),_lineEnd=1e6,ORTHO=cc_1.Camera.ProjectionType.ORTHO,PERSPECTIVE=cc_1.Camera.ProjectionType.PERSPECTIVE,tempVec3A=new cc_1.Vec3,tempQuatA=new cc_1.Quat;function smoothMouseWheelScale(e){return(0<e?1:-1)*(Math.pow(2,.02*Math.abs(e))-1)*10}!function(e){e.ToIdle="toIdle",e.ToPan="toPan",e.ToOrbit="toOrbit",e.ToWander="toWander"}(ModeCommand=ModeCommand||{}),exports.smoothMouseWheelScale=smoothMouseWheelScale;class CameraController3D extends camera_controller_base_1.default{constructor(){super(...arguments),this.v3a=new cc_1.Vec3,this.v3b=new cc_1.Vec3,this.v3c=new cc_1.Vec3,this.v3d=new cc_1.Vec3,this._wheelSpeed=.01,this._near=.1,this._far=1e4,this._orthoScale=.1,this._minScalar=.1,this.homePos=cc.v3(50,50,50),this.homeRot=quat_1.MQuat.fromViewUp(new cc_1.Quat,vec3_1.MVec3.normalize(this.v3a,this.homePos)),this._sceneViewCenter=cc.v3(),this.viewDist=20,this.forward=cc.v3(cc_1.Vec3.UNIT_Z),this._curRot=new cc_1.Quat,this._curEye=new cc_1.Vec3,this._lineColor=cc.color().fromHEX("#555555"),this.lastFocusNodeUUID=[]}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}emit(e,...t){return super.emit(e,...t)}isMoving(){return this._modeFSM.currentState!==this._idleMode}get lineColor(){return this._lineColor}set lineColor(e){this._lineColor=e}get sceneViewCenter(){return this._sceneViewCenter}set sceneViewCenter(e){this._sceneViewCenter.set(e)}get wanderSpeed(){return this._wanderMode.wanderSpeed}set wanderSpeed(e){this._wanderMode.wanderSpeed=e}get enableAcceleration(){return this._wanderMode.enableAcceleration}set enableAcceleration(e){this._wanderMode.enableAcceleration=e}init(e){super.init(e),this._gridMeshComp=utils_1.CameraUtils.createGrid("internal/editor/grid"),this._gridNode=this._gridMeshComp.node,this._gridNode.active=!1,this._gridNode.setWorldRotationFromEuler(90,0,0),this._initMode(),this.reset(),this._initLinearTick()}_initMode(){this._idleMode=new idle_mode_1.IdleMode(this,utils_1.CameraMoveMode.IDLE),this._orbitMode=new orbit_mode_1.OrbitMode(this,utils_1.CameraMoveMode.ORBIT),this._panMode=new pan_mode_1.PanMode(this,utils_1.CameraMoveMode.PAN),this._wanderMode=new wander_mode_1.WanderMode(this,utils_1.CameraMoveMode.WANDER),this._modeFSM=new finite_state_machine_1.default([this._idleMode,this._orbitMode,this._panMode,this._wanderMode]),this._modeFSM.addTransition(this._idleMode,this._orbitMode,ModeCommand.ToOrbit).addTransition(this._idleMode,this._panMode,ModeCommand.ToPan).addTransition(this._idleMode,this._wanderMode,ModeCommand.ToWander).addTransition(this._orbitMode,this._idleMode,ModeCommand.ToIdle).addTransition(this._orbitMode,this._panMode,ModeCommand.ToPan).addTransition(this._orbitMode,this._wanderMode,ModeCommand.ToWander).addTransition(this._panMode,this._idleMode,ModeCommand.ToIdle).addTransition(this._panMode,this._orbitMode,ModeCommand.ToOrbit).addTransition(this._panMode,this._wanderMode,ModeCommand.ToWander).addTransition(this._wanderMode,this._idleMode,ModeCommand.ToIdle).addTransition(this._wanderMode,this._orbitMode,ModeCommand.ToOrbit).addTransition(this._wanderMode,this._panMode,ModeCommand.ToPan),this._modeFSM.Begin(this._idleMode)}_initLinearTick(){this.hTicks=(new linear_ticks_1.default).initTicks([5,2],1,1e4).spacing(15,80),this.vTicks=(new linear_ticks_1.default).initTicks([5,2],1,1e4).spacing(15,80)}set active(e){e?(this._camera.projection=1,this.node.setWorldPosition(this._curEye),this.node.setWorldRotation(this._curRot),this._camera.far=this.far,this._camera.near=this.near):(this.node.getWorldPosition(this._curEye),this.node.getWorldRotation(this._curRot)),this.showGrid(e)}changeMode(e){this._modeFSM.issueCommand(e);let t=utils_1.CameraMoveMode.IDLE;switch(e){case ModeCommand.ToIdle:t=utils_1.CameraMoveMode.IDLE;break;case ModeCommand.ToOrbit:t=utils_1.CameraMoveMode.ORBIT;break;case ModeCommand.ToPan:t=utils_1.CameraMoveMode.PAN;break;case ModeCommand.ToWander:t=utils_1.CameraMoveMode.WANDER}this.emit("mode",t)}reset(){this.node.setWorldPosition(this.homePos),this.node.setWorldRotation(this.homeRot),this.node.getWorldRotation(this._curRot),this.node.getWorldPosition(this._curEye),this.node.updateWorldTransform()}updateViewCenterByDist(e){this.node.getWorldPosition(this._curEye),this.node.getWorldRotation(this._curRot),vec3_1.MVec3.transformQuat(this.forward,cc_1.Vec3.UNIT_Z,this._curRot),vec3_1.MVec3.multiplyScalar(this.v3a,this.forward,e),vec3_1.MVec3.add(this.sceneViewCenter,this._curEye,this.v3a)}scale(e){let t=this.viewDist;var i;Math.abs(t)<this._minScalar&&(t=1),this.isOrtho()?(i=this._camera.orthoHeight,i+=e*this._wheelSpeed*t*this._orthoScale,this.setOrthoHeight(i)):(e=this.smoothScale(e),this.node.getWorldPosition(this._curEye),this.node.getWorldRotation(this._curRot),vec3_1.MVec3.transformQuat(this.forward,cc_1.Vec3.UNIT_Z,this._curRot),vec3_1.MVec3.multiplyScalar(this.v3a,this.forward,e*this._wheelSpeed*t),vec3_1.MVec3.add(this._curEye,this._curEye,this.v3a),node_1.default.makeVec3InRange(this._curEye,-1e12,1e12),this.viewDist=vec3_1.MVec3.distance(this._curEye,this.sceneViewCenter),this.node.setWorldPosition(this._curEye)),this.updateGrid(),cce.Engine.repaintInEditMode()}smoothScale(e){return smoothMouseWheelScale(e)}focus(i=null,o,a){if(this.camera_move_mode===utils_1.CameraMoveMode.IDLE&&null!=(s=this._camera)&&s.camera)if(o){var s=this.node.getPosition(),r=this.node.getRotation(),{position:o,rotation:n,viewCenter:d}=o||{};o?(this._curEye.x=o.x||0,this._curEye.y=o.y||0,this._curEye.z=o.z||0):(this._curEye.x=this.homePos.x||0,this._curEye.y=this.homePos.y||0,this._curEye.z=this.homePos.z||0),n?(this._curRot.x=n.x||0,this._curRot.y=n.y||0,this._curRot.z=n.z||0,this._curRot.w=n.w||0):(this._curRot.x=this.homeRot.x||0,this._curRot.y=this.homeRot.y||0,this._curRot.z=this.homeRot.z||0,this._curRot.w=this.homeRot.w||0),this.sceneViewCenter=d||cc.v3(),this.viewDist=vec3_1.MVec3.distance(this._curEye,this.sceneViewCenter),a?(this.node.setPosition(this._curEye),this.node.setRotation(this._curRot),this.updateGrid(),cce.Engine.repaintInEditMode()):((0,tween_1.tweenPosition)(s,this._curEye,300).step(e=>{this.node.setPosition(e),this.updateGrid(),cce.Engine.repaintInEditMode()}),(0,tween_1.tweenRotation)(r,this._curRot,300).step(e=>{this.node.setRotation(e),this.updateGrid()}))}else if(i&&!(i.length<=0)){o=i.map(e=>cce.Node.query(e)).filter(Boolean);if(!(o.length<=0)){let e=cc_1.Vec3.ZERO;("center"===cce.Gizmo.transformToolData.pivot||(e=node_1.default.getWorldPosition3D(o[o.length-1]),cce.SceneFacadeManager.queryLightProbeBoundingBoxEditMode()))&&(e=node_1.default.getCenterWorldPos3D(o)),this.lastFocusNodeUUID=i.map(e=>e);n=node_1.default.getMaxRangeOfNodes(o);let t=0;this._camera.projection===PERSPECTIVE?(d=new cc_1.Vec3(0,0,1),s=Math.min(this._camera.camera.width,this._camera.camera.height)/2,r=new cc_1.Vec3(s,0,1),i=new cc_1.Vec3(0,0,0),null!=(o=this._camera)&&o.screenToWorld(d,i),o=new cc_1.Vec3(0,0,0),null!=(d=this._camera)&&d.screenToWorld(r,o),d=i.subtract(o).length(),t=Math.max(n/s*d,1.3*this.near),t=Math.min(t,.9*this.far)):this._camera.projection===ORTHO&&(r=this._camera.fov/180*Math.PI*this._camera.orthoHeight,t=n*r/this._camera.orthoHeight*13,i=this._camera.node.eulerAngles.x%360,i=90<Math.abs(i)?180-Math.abs(i):Math.abs(i),t/=Math.cos(i/180*Math.PI)),this.sceneViewCenter=e,this.node.getRotation(this._curRot),vec3_1.MVec3.transformQuat(this.forward,cc_1.Vec3.UNIT_Z,this._curRot),vec3_1.MVec3.multiplyScalar(this.v3c,this.forward,t),vec3_1.MVec3.add(this.v3d,e,this.v3c),this.isOrtho()&&(o=this.getDepthSize()*t,a?(this._camera.orthoHeight=o,cce.Gizmo.transformToolData.cameraOrthoHeight=o,cce.Engine.repaintInEditMode()):(0,tween_1.tweenNumber)(this._camera.orthoHeight,o,300).step(e=>{this._camera&&(this._camera.orthoHeight=e,cce.Gizmo.transformToolData.cameraOrthoHeight=e,cce.Engine.repaintInEditMode())})),a?(this.node.setPosition(this.v3d),this._curEye=this.v3d,this.viewDist=vec3_1.MVec3.distance(this.v3d,this.sceneViewCenter),this.updateGrid(),cce.Engine.repaintInEditMode()):(s=this.node.getPosition(),(0,tween_1.tweenPosition)(s,this.v3d,300).step(e=>{this.node.setPosition(e),this._curEye=e,this.viewDist=vec3_1.MVec3.distance(e,this.sceneViewCenter),this.updateGrid(),cce.Engine.repaintInEditMode()}))}}}async alignNodeToSceneView(e){if(e&&0<e.length){var t=e.map(e=>cce.Node.query(e)).filter(Boolean),e=t.map(e=>e.uuid),e=await cce.SceneFacadeManager.beginRecording(e),i=t[0],o=i.getWorldRT(),a=(cc_1.Mat4.invert(o,o),i.getWorldRotation()),s=(quat_1.MQuat.invert(a,a),this.node.getWorldPosition()),r=this.node.getWorldRotation(),n=this.node.getWorldRT();if(i.setWorldPosition(s),i.setWorldRotation(r),this.alignCameraOrthoHeightToNode(i.getComponents(cc_1.Camera)),1<t.length)for(let e=1;e<t.length;e++){var d=t[e],h=d.getWorldPosition(),c=d.getWorldRotation();vec3_1.MVec3.transformMat4(h,h,o),quat_1.MQuat.multiply(c,a,c),vec3_1.MVec3.transformMat4(h,h,n),d.setWorldPosition(h),quat_1.MQuat.multiply(c,r,c),d.setWorldRotation(c),this.alignCameraOrthoHeightToNode(d.getComponents(cc_1.Camera))}cce.SceneFacadeManager.endRecording(e)}}alignCameraOrthoHeightToNode(e){1===e.length&&(e=e[0])&&e.projection===cc_1.Camera.ProjectionType.ORTHO&&(e.orthoHeight=cce.Camera.camera.orthoHeight)}alignSceneViewToNode(e){var t;e&&0<e.length&&(t=(e=e.map(e=>cce.Node.query(e)).filter(Boolean)[0]).getWorldPosition(),e=e.getWorldRotation(),this.node.setWorldPosition(t),this.node.setWorldRotation(e),cce.Engine.repaintInEditMode())}onMouseDown(e){return this.altKey=e.altKey,this.shiftKey=e.shiftKey,e.middleButton?this.changeMode(ModeCommand.ToPan):e.rightButton&&!e.leftButton?this.changeMode(ModeCommand.ToWander):e.leftButton&&this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.WANDER&&this.changeMode(ModeCommand.ToIdle),this._modeFSM.currentState.onMouseDown(e)}onMouseMove(e){return e.altKey?this._modeFSM.currentState.modeName!==utils_1.CameraMoveMode.ORBIT&&this.changeMode(ModeCommand.ToOrbit):this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.ORBIT&&this.changeMode(ModeCommand.ToIdle),this._modeFSM.currentState.onMouseMove(e)}onMouseUp(e){return e.middleButton?this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.PAN&&this.changeMode(ModeCommand.ToIdle):e.rightButton&&this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.WANDER&&this.changeMode(ModeCommand.ToIdle),this._modeFSM.currentState.onMouseUp(e)}onMouseWheel(e){this._modeFSM.currentState.modeName!==utils_1.CameraMoveMode.WANDER&&this.scale(e.deltaY*this._wheelBaseScale),this._modeFSM.currentState.onMouseWheel(e)}onKeyDown(e){this.shiftKey=e.shiftKey,this.altKey=e.altKey,e.altKey&&this._modeFSM.currentState.modeName!==utils_1.CameraMoveMode.ORBIT&&this.changeMode(ModeCommand.ToOrbit)," "===e.key.toLowerCase()&&this.changeMode(ModeCommand.ToPan),this._modeFSM.currentState.onKeyDown(e)}onKeyUp(e){switch(this.shiftKey=e.shiftKey,this.altKey=e.altKey,e.altKey||this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.ORBIT&&this.changeMode(ModeCommand.ToIdle),e.key.toLowerCase()){case" ":this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.PAN&&this.changeMode(ModeCommand.ToIdle);break;case"h":this.focus()}this._modeFSM.currentState.onKeyUp(e)}onUpdate(e){this._modeFSM.currentState.onUpdate(e)}_updateGridData(t,i,o,e=0){var a=this.hTicks,s=this.vTicks,r=cc.v3(),n=(this.node.getPosition(r),r.y),d=5e3*(n/500)|0,h=-d+r.x,c=d+r.x,_=-d+r.z,m=d+r.z,l=(a.range(h,c,5e3),s.range(_,m,5e3),o.clone());l.a=0;for(let e=a.minTickLevel;e<=a.maxTickLevel;++e){var u=a.tickRatios[e];if(0<u){var M=a.ticksAtLevel(e,!0);for(let e=0;e<M.length;++e){var p=M[e],g=o.clone(),w=(g.a=200*u,Math.abs(p-r.x));g.a*=1-w/d,t.push(p,r.z),t.push(p,_),t.push(p,r.z),t.push(p,m),i.push(g.x,g.y,g.z,g.w),i.push(l.x,l.y,l.z,l.w),i.push(g.x,g.y,g.z,g.w),i.push(l.x,l.y,l.z,l.w)}}}for(let e=s.minTickLevel;e<=s.maxTickLevel;++e){var v=s.tickRatios[e];if(0<v){var C=s.ticksAtLevel(e,!0);for(let e=0;e<C.length;++e){var T=C[e],R=o.clone(),f=(R.a=200*v,Math.abs(T-r.z));R.a*=1-f/d,t.push(r.x,T),t.push(h,T),t.push(r.x,T),t.push(c,T),i.push(R.x,R.y,R.z,R.w),i.push(l.x,l.y,l.z,l.w),i.push(R.x,R.y,R.z,R.w),i.push(l.x,l.y,l.z,l.w)}}}}updateGrid(){var t=[],e=[],i=[];if(this._updateGridData(t,e,this._lineColor,_lineEnd),0<t.length){for(let e=0;e<t.length;e+=2)i.push(e/2);utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_POSITION,t),utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_COLOR,e),utils_1.CameraUtils.updateIB(this._gridMeshComp,i)}}refresh(){this.updateGrid(),cce.Engine.repaintInEditMode()}rotateCameraToDir(e,t){var i=cc.v3(),o=cc.quat(),e=(this.node.getPosition(i),this.node.getRotation(o),quat_1.MQuat.rotationTo(this._curRot,cc_1.Vec3.UNIT_Z,e),cc.v3(0,0,0));t&&(e.z=this.viewDist,vec3_1.MVec3.transformQuat(e,e,this._curRot),vec3_1.MVec3.add(this._curEye,this.sceneViewCenter,e)),(0,tween_1.tweenPosition)(i,this._curEye,300).step(e=>{this.node.setPosition(e),this.updateGrid(),cce.Engine.repaintInEditMode()}),(0,tween_1.tweenRotation)(o,this._curRot,300).step(e=>{this.node.setRotation(e),this.updateGrid()})}getDepthSize(){var e=this._camera.fov;return Math.tan(e/2*Math.PI/180)}calcCameraPosInOrtho(){var e=this.getDepthSize(),e=this._camera.orthoHeight/e;return this.viewDist<e&&(this.viewDist=e),this.node.getWorldRotation(tempQuatA),vec3_1.MVec3.transformQuat(this.forward,cc_1.Vec3.UNIT_Z,tempQuatA),vec3_1.MVec3.normalize(this.forward,this.forward),vec3_1.MVec3.multiplyScalar(this.v3a,this.forward,this.viewDist),vec3_1.MVec3.add(this.v3b,this.sceneViewCenter,this.v3a),this.v3b}isOrtho(){return this._camera.projection===ORTHO}setOrthoHeight(e){this._camera.orthoHeight=e=e<0?.01:e,cce.Gizmo.transformToolData.cameraOrthoHeight=e}changeProjection(){var e;this.isOrtho()?(e=this.calcCameraPosInOrtho(),this.node.setWorldPosition(e),this._camera.projection=PERSPECTIVE,this.emit("projection-changed",PERSPECTIVE),this.updateGrid()):(this._camera.projection=ORTHO,e=this.getDepthSize()*this.viewDist,this.setOrthoHeight(e),this.emit("projection-changed",ORTHO))}onResize(){this.updateGrid(),cce.Engine.repaintInEditMode()}zoomUp(){this.scale(20)}zoomDown(){this.scale(-20)}}exports.CameraController3D=CameraController3D;