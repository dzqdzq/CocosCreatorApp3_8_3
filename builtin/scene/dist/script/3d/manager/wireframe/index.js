"use strict";var WireframeMode,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ModelWireframe=void 0;const cc_1=require("cc"),wireframe_1=__importDefault(require("./wireframe")),event_enum_1=require("../../../public/event-enum"),pool_1=__importDefault(require("../../../utils/pool")),_subModelPool=(!function(e){e[e.NONE=0]="NONE",e[e.LINE=1]="LINE",e[e.BLEND=2]="BLEND"}(WireframeMode=WireframeMode||{}),new pool_1.default(()=>new cc.renderer.scene.SubModel,32));function initSubModel(e,r,t,i=-1){modelWireframe.currMode===WireframeMode.LINE&&(t=modelWireframe.material);var n,o=this;null==o._subModels[e]?o._subModels[e]=_subModelPool.alloc():o._subModels[e].destroy(),-1!==i&&i<=e&&(i=e-i,o._mesh.struct.morph)&&(n={attributes:(n=o._mesh.struct.morph.subMeshMorphs)[i].attributes,targets:n[i].targets},o._mesh.struct.morph.subMeshMorphs.push(n)),o._subModels[e].initialize(r,t.passes,o.getMacroPatches(e)),o._updateAttributesAndBinding(e),o._inited=!0}let _setMaterial=null;function setMaterial(e,r){_setMaterial.call(this,e,r),modelWireframe.generateWireframe(this)}cc.renderer.models.SkinningModel.prototype.initSubModel=function(e,r,t){var i=r.vertexBuffers;r.vertexBuffers=r.jointMappedBuffers,initSubModel.bind(this),initSubModel(e,r,t),r.vertexBuffers=i};class ModelWireframe{constructor(){this.currMode=WireframeMode.NONE,this.color=[255,255,255,255],this.primitiveIndex=0,this.extrude=.001,this.blockCount={}}async init(){var e=await Editor.Profile.getConfig("scene","wireframe");e&&(this.currMode=parseInt(e.mode)-1,this.color=e.color),this.applyStorage(this.currMode,this.color),this.material=new cc_1.Material,this.material.initialize({effectName:"internal/builtin-wireframe",states:{primitive:cc_1.gfx.PrimitiveMode.LINE_LIST}}),this.handleColor=this.material.passes[0].getHandle("lineColor"),this.initEventListener()}initEventListener(){cce.Terrain.on("sculpt",e=>{this._change(e)})}onSceneOpened(e){this._onLoadScene(e)}onSceneReload(e){this._onLoadScene(e)}_nodeChildrenAdd(e,r=!1){var t=e.children,i=t.length;r&&this._create(e,this.currMode,new cc_1.Color(...this.color));for(let e=0;e<i;e++){var n=t[e];if(n.isWireframeNode)return;0!==n.children.length&&this._nodeChildrenAdd(n),this._create(n,this.currMode,new cc_1.Color(...this.color),!1)}}_nodeChildrenActive(e,r=!1){var t=e.children,i=t.length;r&&this._change(e,!0);for(let e=0;e<i;e++){var n=t[e];if(n.isWireframeNode)return;0!==n.children.length&&this._nodeChildrenActive(n),this._change(n,!0,!1)}}onNodeAdded(e,r){this._nodeChildrenAdd(e,!0)}onNodeRemoved(e){e.off(event_enum_1.NodeEventType.ACTIVE_IN_HIERARCHY_CHANGE)}onNodeChanged(e,r){r&&r.blockCount&&(this.blockCount[e.uuid]=r.blockCount),this._change(e)}_change(r,t=!1,i=!0){if(this.currMode!==WireframeMode.NONE||t){var n,t=r.getComponent(cc_1.Terrain)||r.getComponent(cc_1.MeshRenderer),o=r.getComponent(cc_1.SkinnedMeshRenderer),a=this._getWireframeInChild(r);if(t){let e;(e=t instanceof cc_1.Terrain?t.enabled&&r.activeInHierarchy:t.mesh&&t.enabled&&r.activeInHierarchy)?a?((n=a.getComponent(cc_1.MeshRenderer)).mesh=this._generateMesh(t),this.currMode===WireframeMode.NONE?n.enabled=!1:n.enabled=!0):this._create(r,this.currMode,new cc_1.Color(...this.color),i):(a&&(a.getComponent(cc_1.MeshRenderer).enabled=!1),o&&this.generateWireframe(o)),this.currMode!==WireframeMode.LINE||o||t.onDisable(),cce.Engine.repaintInEditMode()}else a&&(a.getComponent(cc_1.MeshRenderer).enabled=!1,cce.Engine.repaintInEditMode())}}applyStorage(e=WireframeMode.LINE,r=[255,255,255,255]){this.currMode=e,this.color=r}async _onLoadScene(e){this.scene=e,this.applyScene(this.currMode,this.color)}_traverse(r,t,e=!0){if(r&&t&&!(r.objFlags&cc.Object.Flags.DontSave)){e&&t(r);for(let e=0;e<r.children.length;e++){var i=r.children[e];t(i),0<i.children.length&&this._traverse(i,t,!1)}}}_generateWireframeVB(r,t){var i=new cc_1.Vec3,n=new cc_1.Vec3,o=new cc_1.Vec2,a=r.length/3,s=[],c=[[0,1],[0,0],[1,0]],d=[];for(let e=0;e<a;e++)cc_1.Vec3.fromArray(i,r,3*e),t&&cc_1.Vec3.fromArray(n,t,3*e),cc_1.Vec3.scaleAndAdd(i,i,cc_1.Vec3.normalize(n,n),this.extrude),cc_1.Vec3.toArray(s,i,3*e),cc_1.Vec2.fromArray(o,c[(e+1)%3]),cc_1.Vec2.toArray(d,o,2*e);return{vertices:s,uvs:d}}_generateWireframeIB(r){var t=[],i=r.length/3;for(let e=0;e<i;e++){var n=r[3*e+0],o=r[3*e+1],a=r[3*e+2];t.push(n,o,o,a,a,n)}return t}applyScene(e=WireframeMode.LINE,r=[255,255,255,255]){e=parseInt(e),this.currMode=e,this.color=r;const t=new cc_1.Color(...r);this._traverse(this.scene,e=>{e!==this.scene&&e!==cce.backgroundNode&&e!==cce.foregroundNode&&this._create(e,this.currMode,t)})}setColor(e=[255,255,255,255]){this.color=e;e=new cc_1.Color(...e);this.material.passes[0].setUniform(this.handleColor,e),cce.Engine.repaintInEditMode()}setMode(e=WireframeMode.LINE){this.applyScene(e,this.color),cce.Engine.repaintInEditMode()}_getTerrainAttrs(t){var e=this.blockCount[t.node.uuid]||[1,1],i=e[0]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY,n=e[1]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY,o=[i,n],a=(o[0]+=1,o[1]+=1,new Float32Array(3*o[0]*o[1])),s=new Float32Array(3*o[0]*o[1]);let c=0,d=0;for(let r=0;r<o[1];++r)for(let e=0;e<o[0];++e){var l=e,h=r,m=t.getPosition(l,h),l=t.getNormal(l,h);a[c++]=m.x,a[c++]=m.y,a[c++]=m.z,s[d++]=l.x,s[d++]=l.y,s[d++]=l.z}var _=new Uint16Array(i*n*6);let f=0;for(let r=0;r<n;++r)for(let e=0;e<i;++e){var u=r*o[0]+e,M=r*o[0]+e+1,g=(r+1)*o[0]+e,p=(r+1)*o[0]+e+1;_[f++]=u,_[f++]=g,_[f++]=M,_[f++]=M,_[f++]=g,_[f++]=p}return{positions:a,normals:s,indices:_}}_generateMesh(e){let r,t,i;var n=new cc.Mesh,o=(i=e instanceof cc_1.Terrain?(o=this._getTerrainAttrs(e),r=o.positions,t=o.normals,o.indices):(r=e.mesh.readAttribute(this.primitiveIndex,cc_1.gfx.AttributeName.ATTR_POSITION),t=e.mesh.readAttribute(this.primitiveIndex,cc_1.gfx.AttributeName.ATTR_NORMAL),e.mesh.readIndices(this.primitiveIndex)),this._generateWireframeVB(r,t));return cc_1.utils.createMesh({positions:o.vertices,indices:this._generateWireframeIB(i),primitiveMode:cc_1.gfx.PrimitiveMode.LINE_LIST},n,{calculateBounds:!0}),n}_getWireframeInChild(r){for(let e=0;e<r.children.length;e++)if(r.children[e]instanceof wireframe_1.default)return r.children[e];return null}_onHierarchyChanged(e){e.on(event_enum_1.NodeEventType.ACTIVE_IN_HIERARCHY_CHANGE,e=>{e.activeInHierarchy&&this._nodeChildrenActive(e,!0)})}generateWireframe(r){var t=r.mesh?r.mesh.subMeshCount:0,i=r.mesh.renderingSubMeshes;let n=t;if(i&&t)for(let e=0;e<t;++e){var o,a,s=r.getRenderMaterial(e),c=i[e];c&&r.model&&(o=this._generateMesh(c).renderingSubMeshes[0],(a=new cc_1.RenderingSubMesh(c.vertexBuffers,c.attributes,cc_1.gfx.PrimitiveMode.LINE_LIST)).indexBuffer=o.indexBuffer,_setMaterial=_setMaterial||r.setMaterial,r.setMaterial=setMaterial.bind(r),r.model instanceof cc.renderer.models.SkinningModel||(r.model.initSubModel=initSubModel.bind(r.model)),this.currMode!==WireframeMode.LINE?(r.model.initSubModel(e,c,s),this.currMode===WireframeMode.NONE?r.model.initSubModel(n,c,s,t):r.model.initSubModel(n,a,this.material,t)):(r.model.initSubModel(e,a,this.material),r.model.initSubModel(n,a,this.material,t)),n++)}}_create(r,t=WireframeMode.LINE,i=cc_1.Color.WHITE.clone(),n=!0){var o=this._getWireframeInChild(r);if(n&&this._onHierarchyChanged(r),o){n=o.getComponent(cc_1.MeshRenderer),o=r.getComponent(cc_1.Terrain)||r.getComponent(cc_1.MeshRenderer);n.mesh=this._generateMesh(o),this.material.setProperty("lineColor",i),t===WireframeMode.NONE?(n.enabled=!1,o.onEnable()):t===WireframeMode.LINE?(o.onDisable(),n.enabled=!0):t===WireframeMode.BLEND&&(o.onEnable(),n.enabled=!0),o.onLoad(),r.activeInHierarchy||o.onDisable()}else{var n=r.getComponent(cc_1.MeshRenderer),o=r.getComponent(cc_1.Terrain),a=r.getComponent(cc_1.SkinnedMeshRenderer);let e;if(this.material.passes[0].setUniform(this.handleColor,i),o)e=this._generateMesh(o),t===WireframeMode.LINE?o.onDisable():o.onEnable();else{if(a&&a.mesh&&!r.isWireframeNode)return void this.generateWireframe(a);if(!n||!n.mesh||r.isWireframeNode)return;e=this._generateMesh(n),t===WireframeMode.LINE?n.onDisable():n.onEnable()}o=new wireframe_1.default("WireframeNode"),a=(o.layer|=cc_1.Layers.Enum.DEFAULT,o.parent=r,o.addComponent(cc_1.MeshRenderer));a.material=this.material,this.material.passes[0].setUniform(this.handleColor,i),a.mesh=e,t===WireframeMode.NONE&&(a.enabled=!1)}}open(e,r=WireframeMode.LINE,t=[255,255,255,255]){e&&(t=new cc_1.Color(...t),e=cce.Node.query(e))&&this._create(e,r,t)}close(e){this.open(e,WireframeMode.NONE)}}const modelWireframe=new(exports.ModelWireframe=ModelWireframe);exports.default=modelWireframe;