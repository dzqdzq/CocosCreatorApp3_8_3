"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&("get"in r?t.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){e[n=void 0===n?i:n]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0});const ipc=__importStar(require("@base/electron-base-ipc")),Events={"mouse-down":"_dispatchMouseDownEvent","mouse-move":"_dispatchMouseMoveEvent","mouse-up":"_dispatchMouseUpEvent","mouse-wheel":"_dispatchMouseScrollEvent",keydown:"_dispatchKeyboardDownEvent",keyup:"_dispatchKeyboardUpEvent"},isPreview=isPreviewProcess,ReceiveChannel=isPreview?"native-from-browser-preview":"native-from-browser",SendChannel=isPreview?"native-from-scene-preview":"native-from-scene",isWin32="win32"===process.platform,minLength=isWin32?10:30;let ccInput=null;class NativeScene{constructor(){this.windowMap=new Map,this.intervalHandle=null,this.redrawTimes=0,ipc.registerChannel(ReceiveChannel),ipc.on("native-scene",(async(e,t)=>{var{message:t,params:i}=t;this[t]?(i=await this[t].call(this,...i),e.reply(null,i)):console.warn(`browserToScene ${t} not exist`)}).bind(this))}createWindow(e,t,i){i=Buffer.from(i,"base64");let n=this.windowMap.get(t);return n||(e.width<=0&&(e.width=minLength),e.height<=0&&(e.height=minLength),n=new NativeWindow(e.width,e.height,i),this.windowMap.set(t,n),this.resize(e.x,e.y,e.width,e.height,t)),{handler:n.handler,isPreviewProcess:isPreview}}close(e){this.setVisible(e,!1),this.redirectTargetWindow(e,!0)}async resize(e,t,i,n,r){r=this.windowMap.get(r);if(r)return e&&t&&(r.x=e,r.y=t,r.setPos(e,t)),i&&n&&(r.width=i,r.height=n,r.setSize(i,n)),null!=(e=r.updateContextID)&&e.call(r),await this.redraw(),r.handler}redirectTargetWindow(e,t=!1){let i=!1;var n=this.windowMap.get(e);let r=0;if(n){n.renderWindow.clearCameras();var s,e=null!=(e=null==(e=cc.director.getScene().renderScene)?void 0:e.cameras)?e:[],a=cc.Layers.makeMaskInclude([cc.Layers.Enum.GIZMOS,cc.Layers.Enum.SCENE_GIZMO,cc.Layers.Enum.EDITOR]);for(const c of e)c.node.layer&a||(isPreview&&!i&&(c.visibility|=cc.Layers.Enum.PROFILER,i=!0),s=t?cc.director.root.tempWindow:n.renderWindow,c.changeTargetWindow(s),c.update(!0),r++)}return r}async handleInput(e,t){var i,e=Events[e];e&&(ccInput||(i=(await Promise.resolve().then(()=>__importStar(require("cc"))))["input"],ccInput=i),ccInput)&&(t.windowId=2,null!=(i=ccInput[e]))&&i.call(ccInput,t)}async setVisible(e,t){e=this.windowMap.get(e);if(e&&(t?(e.setPos(e.x,e.y),e.setSize(e.width,e.height)):(e.setPos(10,10),e.setSize(minLength,minLength)),await this.redraw(),!isWin32))return null!=(t=e.updateContextID)&&t.call(e),e.handler}async redraw(){return new Promise(e=>{var t;null!=(t=cce.Engine)&&t.repaintInEditMode(),cc.director&&cc.director.once(cc.Director.EVENT_AFTER_DRAW,()=>{e(!0)})})}sendToBrowser(e,...t){ipc.send(SendChannel,e,...t)}}exports.default=new NativeScene;