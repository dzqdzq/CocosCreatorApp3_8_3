"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.preload=void 0,require("@editor/creator");const log_1=__importDefault(require("../manager/startup/log"));function check(){require("@base/electron-base-ipc").sendSync("scene:check-ipc")?startup():setTimeout(()=>{window.location.reload()},1e3)}async function initPreview(){try{await cce.Ipc.startup(),await cce.Startup.requireEngine(),log_1.default.setLevel(4),console.info(Editor.I18n.t("scene.game_view.ready")),cce.Ipc.send("preview-ready")}catch(e){console.error(Editor.I18n.t("scene.game_view.failed")+":"+e),cce.Ipc.send("preview-failed")}}async function startup(){var e=require("path")["join"],r=(await require("editor/preload").init(),window.Editor=require("editor"),Editor.Metrics.trackTimeStart("scene:scene-view-startup"),require("../manager/startup").default),i=require("../manager/ipc/index").default;window.cce={Startup:r,Ipc:i},isSceneNative&&(r=require("./native/native-scene").default,cce.NativeScene=r),window.AppModulePath=e(Editor.App.path,"node_modules"),isPreviewProcess?(r=require("./editor-preview").default,cce.EditorPreview=r,log_1.default.changePrefix("PreviewInEditor"),log_1.default.setLevel(2),initPreview()):i.send("ready"),Editor.Message.send("process","register-process-info",process.pid,"webview:scene-web")}function preload(e){window.isSceneNative=e.isSceneNative,window.isPreviewProcess=e.isPreviewProcess,check();let i=0;window.addEventListener("beforeunload",async e=>{var r;isSceneNative&&cce.NativeScene.sendToBrowser("onEngineClose",isPreviewProcess),isPreviewProcess?cce.Ipc.send("preview-close"):(r=require("../manager/ipc/index").default,1===i?e.returnValue=!0:cce.Scene&&2!==i?(r.send("immediately-dump",cce.SceneFacadeManager.dumpAllScenes()),i=1,e.returnValue=!0,await cce.SceneFacadeManager.beforeClose()?(i=2,window.location.reload()):i=0):r.send("close"))}),require("electron").ipcRenderer.send("fire-web-contents")}exports.preload=preload;