"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getCachePath=exports.sceneCacheManager=exports.SceneCacheManager=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),fs_1=require("fs"),crypto_1=require("crypto"),_=require("lodash"),SCENE_CACHE_DIR=(0,path_1.join)(Editor.Project.tmpDir,"scene/cache"),UnSaveSceneId="unSave";async function safeRemove(e){(0,fs_1.existsSync)(e)?await(0,fs_extra_1.remove)(e):console.debug("scene cache removing dir not exists",e,(new Error).stack)}class SceneCacheManager{constructor(){this.cacheTimerList={},this.cacheJsonList={},this._currentSceneUUID="",this._mode="general",this._disabled=!1,this._saveInterval=5e3,this._maxFileNum=3,this._hasInit=!1,this._eventList={},this._sceneReady=!1,this._deviceMd5="",this._unSaveSceneUUID="";var e=require("os");this._systemInfo={arch:e.arch(),cpu:e.cpus()[0].model,version:e.version()},this._deviceMd5=this._calcDeviceInfoMd5(this._systemInfo),this._cacheInfo={systemInfo:this._systemInfo,sceneListMap:{},deviceMd5:this._deviceMd5}}set disabled(e){e!==this._disabled&&((this._disabled=e)?this._removeEventListener():this.init())}get disabled(){return this._disabled||"general"!==this._mode}async getCurrentSceneUUID(){return this._currentSceneUUID||(this._currentSceneUUID=await Editor.Message.request("scene","query-current-scene",!0)),this._currentSceneUUID}async getCurrentCacheID(e){var t;return this._unSaveSceneUUID===e?UnSaveSceneId:(t=await Editor.Message.request("asset-db","query-asset-info",e))&&t.visible?e:(this._unSaveSceneUUID=e,UnSaveSceneId)}async updateConfig(){var e=await Editor.Profile.getConfig("scene","scene_cache");this.disabled=!e.use,this._saveInterval=e.interval,this._maxFileNum=e.maxFileNum}async init(){if(this._hasInit)this._addEventListener();else if(await this.updateConfig(),this.disabled)console.log("The scene cache function is turned off");else{if(this.saveSceneCache=_.throttle(()=>{this._saveSceneDump()},this._saveInterval,{leading:!0,trailing:!0}),this.saveJsonToFile=_.debounce((e,t,s)=>{this._saveJsonToFile(e,t,s)},this._saveInterval+300,{leading:!0}),await Editor.Message.request("asset-db","query-ready"))this._initSceneCacheMap();else{const e=()=>{this._initSceneCacheMap(),Editor.Message.__protected__.removeBroadcastListener("asset-db:ready",e)};Editor.Message.__protected__.addBroadcastListener("asset-db:ready",e)}this._hasInit=!0,this._addEventListener()}}async _initSceneCacheMap(){if((0,fs_1.existsSync)(SCENE_CACHE_DIR)){var t=(0,path_1.join)(SCENE_CACHE_DIR,"info.json");let e=!1;try{this._cacheInfo=(0,fs_extra_1.readJSONSync)(t),this._cacheInfo.sceneListMap=this._cacheInfo.sceneListMap||{},e=!0}catch(e){this._cacheInfo={systemInfo:this._systemInfo,sceneListMap:{},deviceMd5:this._deviceMd5}}var s=await(0,fs_extra_1.readdir)(SCENE_CACHE_DIR);await Promise.all(s.map(async t=>{var e,s,i=t&&await Editor.Message.request("asset-db","query-asset-info",t),a=getCacheDirWithId(t);i||t===UnSaveSceneId?((e=(await(0,fs_extra_1.readdir)((0,path_1.join)(SCENE_CACHE_DIR,t))).map(e=>Number((0,path_1.basename)(e,(0,path_1.extname)(e))))).sort((e,t)=>e-t),s=e.splice(this._maxFileNum-1,e.length-this._maxFileNum),await Promise.all(s.map(e=>safeRemove(getCachePath(t,e)))),i&&i.file!==this._cacheInfo.sceneListMap[t]||this._deviceMd5!==this._cacheInfo.deviceMd5?(console.debug(`invalid cache: uuid(${t}} file(${i&&i.file})`),await safeRemove(a),delete this._cacheInfo.sceneListMap[t]):(i&&(this._cacheInfo.sceneListMap[t]=i.file),this.cacheTimerList[t]=e)):await safeRemove(a)})),this._cacheInfo.systemInfo=this._systemInfo,this._cacheInfo.deviceMd5=this._deviceMd5,console.debug("init cacheTimerList "+JSON.stringify(this.cacheTimerList)),e||(0,fs_extra_1.outputJSONSync)(t,this._cacheInfo,{spaces:4})}}async _addEventListener(){this._hasInit&&!Object.keys(this._eventList).length&&(this._eventList={"scene:save":this.onSceneSaved.bind(this),"scene:change-node":this.saveSceneCache.bind(this),"asset-db:asset-delete":this.onAssetDelete.bind(this),"scene:change-mode":e=>this._mode=e},Object.keys(this._eventList).forEach(e=>{Editor.Message.__protected__.addBroadcastListener(e,this._eventList[e])}))}async _removeEventListener(){this._hasInit&&Object.keys(this._eventList).length&&(Object.keys(this._eventList).forEach(e=>{Editor.Message.__protected__.removeBroadcastListener(e,this._eventList[e])}),this._eventList={})}async _saveJsonToFile(e,t,s){try{(0,fs_extra_1.outputJSONSync)(getCachePath(e,t),s,{spaces:4})}catch(e){console.log(e)}}onSceneSaved(e){this._unSaveSceneUUID=""}async queryLatestCache(e){var t=await this.getCurrentCacheID(e);if(!this.disabled&&(this.cacheJsonList[t]||this.cacheTimerList[t])){var e=e&&await Editor.Message.request("asset-db","query-asset-info",e)||null,s=this.cacheTimerList[t],i=e&&(0,fs_1.statSync)(e.file).mtimeMs||0;if(this.cacheJsonList[t]&&this.cacheJsonList[t][0].time>i)return Object.assign({url:e&&e.url||""},this.cacheJsonList[t][0]);if(s&&s[s.length-1]>i){i=getCachePath(t,s[s.length-1]);if((0,fs_1.existsSync)(i))return{time:s[s.length-1],file:i,url:e&&e.url||""}}}}async onAssetDelete(e,t){"cc.SceneAsset"===(null==t?void 0:t.type)&&await this.clearSceneCache(e)}async clearSceneCache(e){this.disabled||(e=e||await this.getCurrentSceneUUID())&&(await safeRemove(getCacheDirWithId(e=await this.getCurrentCacheID(e))),delete this.cacheTimerList[e],delete this.cacheJsonList[e],this._currentSceneUUID="")}async save(){var e;this.disabled||(e=(0,path_1.join)(SCENE_CACHE_DIR,"info.json"),(0,fs_extra_1.outputJSONSync)(e,this._cacheInfo,{spaces:4}))}_calcDeviceInfoMd5(e){return(0,crypto_1.createHash)("md5").update(JSON.stringify(e)).digest("hex")}async onSceneReady(e){this._sceneReady=!1,this._currentSceneUUID=e,this.clearSceneCache(e),this._sceneReadyTimer=setTimeout(()=>{this._sceneReady=!0},1e3)}onSceneClosed(){this._sceneReadyTimer&&clearTimeout(this._sceneReadyTimer),this._currentSceneUUID="",this._sceneReady=!1,this._unSaveSceneUUID=""}async _saveSceneDump(){var e,t,s,i,a;return!(this.disabled||!this._sceneReady||!(e=await this.getCurrentSceneUUID())||!await Editor.Message.request("scene","query-dirty")||!(t=await Editor.Message.request("scene","query-scene-json"))||(s=await this.getCurrentCacheID(e),this.cacheJsonList[s]||(this.cacheJsonList[s]=[]),(a=this.cacheJsonList[s]).length&&a[0].data===t)||(i=Date.now(),a.unshift({time:i,data:t}),a.length=Math.min(this._maxFileNum,a.length),this.saveJsonToFile(s,i,t),e&&!this._cacheInfo.sceneListMap[s]&&(a=e&&await Editor.Message.request("asset-db","query-asset-info",e))&&(this._cacheInfo.sceneListMap[s]=a.file),this.save(),0))}}function getCachePath(e,t){return(0,path_1.join)(SCENE_CACHE_DIR,e,t+".json")}function getCacheDirWithId(e){return(0,path_1.join)(SCENE_CACHE_DIR,e)}exports.SceneCacheManager=SceneCacheManager,exports.sceneCacheManager=new SceneCacheManager,exports.getCachePath=getCachePath;