"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const electron_base_ipc_1=require("@base/electron-base-ipc");function DebugUV(t,e=1024){const i={x:0,y:0};var r=[{x:0,y:0},{x:0,y:0},{x:0,y:0}],h=[],s=document.createElement("canvas");const a=e,l=e,g=(s.width=a,s.height=l,s.getContext("2d"));g.lineWidth=.3,g.strokeStyle="#F8D299",g.textAlign="center",g.fillStyle="#353535",g.fillRect(0,0,a,l);var n=t.index||t.buffer,o=t.buffer,u=t.format.count,f=Object.keys(n).length;for(let t=0;t<f;t+=3){h[0]=n[t],h[1]=n[t+1],h[2]=n[t+2],r[0].x=o[h[0]*u],r[0].y=o[h[0]*u+1],r[1].x=o[h[1]*u],r[1].y=o[h[1]*u+1],r[2].x=o[h[2]*u],r[2].y=o[h[2]*u+1],E=d=void 0;var d=r;g.beginPath(),i.x=0;for(let t=i.y=0,e=d.length;t<e;t++){var E=d[t];i.x+=E.x,i.y+=E.y,0===t?g.moveTo(E.x*(a-2)+.5,(1-E.y)*(l-2)+.5):g.lineTo(E.x*(a-2)+.5,(1-E.y)*(l-2)+.5)}g.closePath(),g.stroke()}return s}class GlPreview{constructor(t,e){this.gl=null,this.buffers=[],this.textures=[],this.shaders=[],this.programs=[],this.uniforms={framebufferLoc1:null},this._framebufferCount=1,this.initialized=!1,this._registerName=t,this._name=e}set isMulFramebuffer(t){this._framebufferCount=t?2:1}get isMulFramebuffer(){return 2===this._framebufferCount}async init(t){var e;t=t||{width:(null==(e=this.canvas)?void 0:e.width)||100,height:(null==(e=this.canvas)?void 0:e.height)||100},(0,electron_base_ipc_1.sendToChannel)(this._registerName,this._name,{width:t.width,height:t.height}),this.initialized=!0}_applyTex(t,e,i,r,h,s){this.gl.activeTexture(this.gl.TEXTURE0+r),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.uniform1i(i,r),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,h,s,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t)}computedUV(t,e,i){(t=t||[]).format&&t.format.count||console.warn("cannot get uv count");var t=DebugUV(t,Math.min(e,i)),r=null==(r=t.getContext("2d"))?void 0:r.getImageData(0,0,t.width,t.height),h=document.createElement("canvas"),h=(h.width=e,h.height=i,h.getContext("2d"));return h.fillStyle="rgb(71, 71, 71)",h.fillRect(0,0,e,i),h.putImageData(r,(e-Math.min(e,t.width))/2,(i-Math.min(i,t.height))/2),{buffer:h.getImageData(0,0,e,i).data,width:e,height:i}}queryPreviewData(t){var e;return t=t||{width:(null==(e=this.canvas)?void 0:e.width)||100,height:(null==(e=this.canvas)?void 0:e.height)||100},new Promise((i,r)=>{(0,electron_base_ipc_1.sendToChannel)(this._registerName,this._name,{width:t.width,height:t.height}).option({original:!0}).callback((t,e)=>{if(t)return r(t);i(e)})})}resizeGL(t,e){this.gl&&(this.gl.viewport(0,0,t,e),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,e,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null))}drawGL(t){this.gl&&(this._applyTex(t.buffer,this.textures[0],this.uniforms.framebufferLoc1,0,t.width,t.height),this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_BYTE,0))}async getContext(e){let i;try{if(!(i=e.getContext("webgl",{alpha:!1,depth:!1,antialias:!0}))){for(let t=0;t<3;t++)if(i=await new Promise(t=>{setTimeout(()=>{t(e.getContext("webgl",{alpha:!1,depth:!1,antialias:!0}))},100)}))return i;throw new Error("cannot get webgl context")}}catch(t){console.error(t)}return i}async initGL(t,e={}){if(t){this.canvas=t,this.buffers=[],this.textures=[],this.shaders=[],this.programs=[],this.gl=await this.getContext(t);var i=this._initShaderProgram(this.gl,`attribute vec3 pos;
attribute vec2 uv;
varying vec2 v_uv;
void main () {
    gl_Position = vec4(pos, 1.0);
    v_uv = uv;
}`,`precision highp float;
varying vec2 v_uv;
uniform sampler2D framebuffer1;
void main () {
    gl_FragColor = texture2D(framebuffer1, v_uv);
}`),r=[-1,-1,1,-1,-1,1,1,1],h=this.gl.createBuffer(),r=(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,h),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(r),this.gl.STATIC_DRAW),this.buffers.push(h),this.gl.createBuffer()),s=(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),this.gl.STATIC_DRAW),this.buffers.push(r),this.gl.createBuffer()),a=(this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,s),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint8Array([0,2,3,3,1,0]),this.gl.STATIC_DRAW),this.buffers.push(s),this.uniforms.framebufferLoc1=this.gl.getUniformLocation(i,"framebuffer1"),t.width=e.width,t.height=e.height,e.width||t.width),l=e.height||t.height;for(let t=0;t<this._framebufferCount;t++){var g=this.gl.createTexture();this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this.gl.TEXTURE_2D,g),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,l,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.textures.push(g)}this.gl.viewport(0,0,a,l);e=this.gl.getAttribLocation(i,"pos"),t=this.gl.getAttribLocation(i,"uv");this.gl.bindBuffer(this.gl.ARRAY_BUFFER,h),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.enableVertexAttribArray(t),this.gl.vertexAttribPointer(t,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,s),this.gl.useProgram(i)}}destroyGL(){this.buffers.forEach(t=>this.gl.deleteBuffer(t)),this.textures.forEach(t=>this.gl.deleteTexture(t)),this.shaders.forEach(t=>this.gl.deleteShader(t)),this.programs.forEach(t=>this.gl.deleteProgram(t)),this.gl&&this.gl.getExtension("WEBGL_lose_context")&&this.gl.getExtension("WEBGL_lose_context").loseContext()}_initShaderProgram(t,e,i){var e=this._loadShader(t,t.VERTEX_SHADER,e),i=this._loadShader(t,t.FRAGMENT_SHADER,i),r=t.createProgram();return t.attachShader(r,e),t.attachShader(r,i),t.linkProgram(r),t.getProgramParameter(r,t.LINK_STATUS)?(this.programs.push(r),r):(console.warn("Unable to initialize the shader program: "+t.getProgramInfoLog(r)),t.deleteProgram(r),null)}_loadShader(t,e,i){e=t.createShader(e);return t.shaderSource(e,i),t.compileShader(e),t.getShaderParameter(e,t.COMPILE_STATUS)?(this.shaders.push(e),e):(console.warn("An error occurred compiling the shaders: "+t.getShaderInfoLog(e)),t.deleteShader(e),null)}}exports.default=GlPreview;