"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,n,a,t){void 0===t&&(t=a);var i=Object.getOwnPropertyDescriptor(n,a);i&&("get"in i?n.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return n[a]}}),Object.defineProperty(e,t,i)}:function(e,n,a,t){e[t=void 0===t?a:t]=n[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,n){Object.defineProperty(e,"default",{enumerable:!0,value:n})}:function(e,n){e.default=n}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(n,e,a);return __setModuleDefault(n,e),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.listeners=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),message_1=require("./message"),infobarPlugin=__importStar(require("../engine-view/plugin/infobar")),toolbarPlugin=__importStar(require("../engine-view/plugin/toolbar")),service_1=require("../engine-view/plugin/toolbar/service"),base_client_1=require("../engine-view/views/base-client"),panel_constant_1=require("./panel-constant"),panel_manager_1=require("./panel-manager");let panel=null,isNative;function addSceneCSSVariable(){var e,n;panel&&({width:e,height:n}=panel.$.content.getBoundingClientRect(),panel.$.content.style.setProperty("--scene-width",e+"px"),panel.$.content.style.setProperty("--scene-height",n+"px"))}function notifyScenePanelChange(){panel&&!0===this.ready&&(exports.methods["editor-preview-change-style"](),addSceneCSSVariable(),panel_manager_1.ScenePanelManager.resize(panel_constant_1.PanelName.Scene))}function attach(e){if(!e.invalid&&e.info.contributions&&e.info.contributions.scene){var n,a=e.info.contributions.scene;try{a.custom&&((n=Editor.Module.__protected__.requireFile((0,path_1.join)(e.path,a.custom))).floatWindows&&panel.$.scene.attachFloatWindow(e.name,n.floatWindows),n.toolbars&&panel.$.scene.attachToolbar(e.name,n.toolbars),n.infobars)&&panel.$.scene.attachInfobar(e.name,n.infobars)}catch(e){console.log(e)}}}function detach(e){panel.$.scene.detachFloatWindow(e.name),panel.$.scene.detachToolbar(e.name),panel.$.scene.detachInfobar(e.name)}async function updateIcon(){try{if(isNative){var e=panel.$.content.getRootNode().host.parentElement.parentElement.querySelector("img[src*=scene][src*=builtin]");if(!(e instanceof HTMLImageElement))throw new Error("scene panel icon error:img of selector is not exist");e.onerror=console.error,e.src="file://"+(0,path_1.join)(__dirname,"../../static/native-icon-2x.png")}}catch(e){console.error(e)}}async function defineEngineView(e,n){window.customElements.get("engine-view")||(n?(updateIcon(),n=(await Promise.resolve().then(()=>__importStar(require("../engine-view/views/native/engine-view"))))["NativeEngineView"],n=(window.customElements.define("engine-view",n),await Promise.resolve().then(()=>__importStar(require("./native/native-window-panel"))))["NativeWindowPanel"],(n=new n(e,panel_constant_1.PanelName.Scene)).onPanelReady(),e.nativeWindowPanel=n,window.document.body.setAttribute("mode","native"),panel_manager_1.ScenePanelManager.init(!0),panel_manager_1.ScenePanelManager.scene=e):(n=(await Promise.resolve().then(()=>__importStar(require("../engine-view/views/web/engine-view"))))["WebEngineView"],window.customElements.define("engine-view",n)))}async function ready(){(panel=this).updateIcon=updateIcon,isNative=await panel["query-is-native"](),await defineEngineView(panel,isNative);var e=toolbarPlugin.init(panel.$.toolbar),n=(infobarPlugin.init(panel.$.infobar),(0,message_1.init)(panel),panel.$.scene),e=(isNative&&n.setAttribute("loading","loading"),await n.init(),isNative?(0,service_1.nativeToolbarAdapter)():(0,service_1.webviewToolbarAdapter)(e));n.connectToGameView(e),Editor.Package.getPackages({enable:!0}).forEach(attach),Editor.Package.__protected__.on("enable",attach),Editor.Package.__protected__.on("disable",detach),await n.callSceneMethod("changeSceneViewVisible",[!panel.hidden]),document.addEventListener("click",()=>{Editor.Message.broadcast("scene:toolbar-menu-active","")}),panel.ready=!0,notifyScenePanelChange.call(panel),isNative&&n.removeAttribute("loading")}async function beforeClose(){var e=panel.$.scene;if(!e)return!0;if(base_client_1.BaseClient.isCrash)return!0;e.onClose();e=await panel.$.scene.callSceneMethod("beforeClose",[],!0,!1);return await Editor.Message.request("scene","save-scene-cache-to-file"),e}async function close(){this.ready=!1,Editor.Package.__protected__.removeListener("enable",attach),Editor.Package.__protected__.removeListener("disable",detach),toolbarPlugin.close(),panel_manager_1.ScenePanelManager.close(panel_constant_1.PanelName.Scene)}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../dist/index.css"),"utf8"),exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../static","/template/index.html"),"utf8"),exports.$={loading:".loading",content:".content",toolbar:".toolbar",infobar:".infobar",scene:".scene",gizmos:".gizmos",uiTools:".ui-tools"},exports.listeners={resize:notifyScenePanelChange,move:notifyScenePanelChange,show(){panel.$.scene.callSceneMethod("changeSceneViewVisible",[!0]),panel_manager_1.ScenePanelManager.show(panel_constant_1.PanelName.Scene)},hide(){panel.$.scene.callSceneMethod("changeSceneViewVisible",[!1]),panel_manager_1.ScenePanelManager.hide(panel_constant_1.PanelName.Scene)}},exports.methods=(0,message_1.apply)(),exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;