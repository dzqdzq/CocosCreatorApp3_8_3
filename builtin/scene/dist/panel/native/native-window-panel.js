"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){e[n=void 0===n?i:n]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NativeWindowPanel=void 0;const remote=__importStar(require("@electron/remote")),panel_constant_1=require("../panel-constant"),lodash_1=require("lodash"),preview_input_1=require("./preview-input"),ipc_1=require("./ipc"),isWin32="win32"===process.platform,EPSILON=1e-4;function checkRect(e,t){return Math.abs(e.width-t.width)<EPSILON&&Math.abs(e.height-t.height)<EPSILON&&Math.abs(e.x-t.x)<EPSILON&&Math.abs(e.y-t.y)<EPSILON}class NativeWindowPanel{constructor(e,t){this.panelName=panel_constant_1.PanelName.Default,this.browserWindowId=0,this.isShow=!0,this.cameraInvalid=!1,this._sceneReady=!1,this._backgroundPriority=panel_constant_1.PanelBackgroundPriority.normal,this.panel=e,this.panelName=t,this.rect={x:0,y:0,width:0,height:0};e=remote.getCurrentWindow();this.browserWindowId=e.id,this._debounceResize=(0,lodash_1.debounce)(this._resize,100,{trailing:!0}),this.init()}init(){this.createBackground(),this.panelName===panel_constant_1.PanelName.Preview&&(0,preview_input_1.registerInput)(this.panel.$.preview,this)}createBackground(){this.background=document.createElement("div"),this.background.setAttribute("style","position:absolute;background:#262626;width:100%;height:100%"),this.panel.$.content.appendChild(this.background)}get backgroundPriority(){return this._backgroundPriority}set backgroundPriority(e){this._backgroundPriority=e}setBackgroundVisible(e,t=panel_constant_1.PanelBackgroundPriority.normal){this._sceneReady&&this._backgroundPriority<=t&&(this._backgroundPriority=t,e?this.background.setAttribute("style","position:absolute;background:#262626;width:100%;height:100%"):this.cameraInvalid||this.background.setAttribute("style","display: none"))}enableInput(e){(0,preview_input_1.enableInput)(e)}getRect(){var e=this.panel.$.content.getBoundingClientRect(),t=isWin32?window.devicePixelRatio:1;return{x:e.left*t,y:(isWin32?e.top:window.innerHeight-e.bottom)*t,width:e.width*t,height:e.height*t}}onSceneReady(){this._sceneReady=!0}onPanelReady(){ipc_1.PanelIpc.sendToBrowser("onPanelReady",this.browserWindowId,this.panelName,this.getRect())}async _resize(e){await ipc_1.PanelIpc.requestToBrowser("onPanelResize",this.browserWindowId,this.panelName,e),this.setBackgroundVisible(!1)}resize(e){!this.isShow||checkRect(e=e||this.getRect(),this.rect)||(this.rect=e,this.setBackgroundVisible(!0),this._debounceResize(e))}close(){this._sceneReady=!1,ipc_1.PanelIpc.sendToBrowser("onPanelClose",this.browserWindowId,this.panelName)}beforeClose(){ipc_1.PanelIpc.sendToBrowser("onPanelBeforeClose",this.browserWindowId,this.panelName)}async show(){this.isShow||(this.isShow=!0,this.setBackgroundVisible(!0),await ipc_1.PanelIpc.requestToBrowser("onPanelShow",this.browserWindowId,this.panelName),this.setBackgroundVisible(!1))}async hide(){this.isShow&&(this.isShow=!1,await ipc_1.PanelIpc.requestToBrowser("onPanelShow",this.browserWindowId,this.panelName))}onBrowserPanel(e,...t){this[e]&&this[e].call(this,...t)}setCameraInvalid(e){e?(this.setBackgroundVisible(!0),this.cameraInvalid=!0):(this.cameraInvalid=!1,this.setBackgroundVisible(!1))}}exports.NativeWindowPanel=NativeWindowPanel;