"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.template=exports.style=exports.listeners=void 0;const fs_1=require("fs"),path_1=require("path"),env_1=__importDefault(require("../../script/utils/env")),toolbar_1=require("../../engine-view/plugin/toolbar"),device_adapter_1=require("../../script/utils/device-adapter"),native_window_panel_1=require("./native-window-panel"),panel_constant_1=require("../panel-constant"),panel_manager_1=require("../panel-manager");let panel;const isWin32="win32"===process.platform;function getRect(){var e,t;if(null!=(t=null===panel||void 0===panel?void 0:panel.$)&&t.preview)return t=JSON.parse(JSON.stringify(panel.$.preview.getBoundingClientRect())),e=isWin32?window.devicePixelRatio:1,toRoundRect(t={x:t.left*e,y:(isWin32?t.top:window.innerHeight-t.bottom)*e,width:t.width*e,height:t.height*e}),t}class EditorPreviewElement extends HTMLElement{constructor(){super(),this.rect={x:0,y:0,width:0,height:0},this.isPreviewing=!1}updateBackground(){var e=this.parentElement.querySelector(".game-view-toolbar"),t=this.parentElement.getBoundingClientRect(),e=e.getBoundingClientRect(),i=isWin32?window.devicePixelRatio:1,a="free"===(null==(a=panel.devicesInfo)?void 0:a.type),e=a?0:(t.height-e.height-this.rect.height/i)/2,a=a?0:(t.width-this.rect.width/i)/2;this.style.borderColor="var(--color-normal-fill)",this.style.borderStyle="solid",this.style.borderBottomWidth=e+"px",this.style.borderTopWidth=e+"px",this.style.borderLeftWidth=a+"px",this.style.borderRightWidth=a+"px"}async resize(e){this.rect=e||this.rect,toRoundRect(this.rect),this.updateBackground(),panel_manager_1.ScenePanelManager.resize(panel_constant_1.PanelName.Preview,this.rect)}}function toRoundRect(e){e.x=Math.round(e.x),e.y=Math.round(e.y),e.width=Math.round(e.width),e.height=Math.round(e.height)}function onPreviewPanelChange(){var e;panel&&(e=getRect())&&(device_adapter_1.NativeAdapter.reset(null==e?void 0:e.width,null==e?void 0:e.height),panel.editorPreviewChangeStyle())}async function ready(){var e;await env_1.default.useNativeScene()?(panel=this,(e=new native_window_panel_1.NativeWindowPanel(panel,panel_constant_1.PanelName.Preview)).onPanelReady(),panel.nativeWindowPanel=e,panel_manager_1.ScenePanelManager.preview=panel,window.customElements.get("editor-preview")||window.customElements.define("editor-preview",EditorPreviewElement),device_adapter_1.NativeAdapter.enable=!0,await panel.initToolbar(),(e=getRect())&&device_adapter_1.NativeAdapter.reset(null==e?void 0:e.width,null==e?void 0:e.height)):Editor.Panel.close("scene.preview")}function beforeClose(){}function close(){this.destroyToolbar(),panel_manager_1.ScenePanelManager.close(panel_constant_1.PanelName.Preview)}exports.listeners={async show(){panel_manager_1.ScenePanelManager.show(panel_constant_1.PanelName.Preview)},hide(){panel_manager_1.ScenePanelManager.hide(panel_constant_1.PanelName.Preview)},resize:onPreviewPanelChange,move:onPreviewPanelChange},exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../dist/preview.css"),"utf-8"),exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../static/template/preview.html"),"utf-8"),exports.$={toolbar:".toolbar > template",preview:".preview",content:".preview"},exports.methods={async initToolbar(){var e;await Editor.Message.request("scene","is-native")?(e=new toolbar_1.ToolbarGameView({propsData:{isNative:!0,visible:!0}}).$mount(this.$.toolbar),this._toolbarVm=e):this.destroyToolbar()},destroyToolbar(){var e;this._toolbarVm&&(null!=(e=this._toolbarVm)&&e.$destroy(),this._toolbarVm=void 0)},async getGameViewData(){var e;if(this._toolbarVm)return e=this._toolbarVm.gameViewData,Object.assign({},e);throw new Error("preview toolbar is not initialized yet or it's disabled")},async editorPreviewChangeStyle(){if(panel&&panel._toolbarVm){var{rotate:i,scaleValue:a,devicesInfo:r,fullScreen:n}=panel._toolbarVm.gameViewData;let e=r.width,t=r.height;"ratio"===r.type?(o=device_adapter_1.NativeAdapter.ratioToSize(e,t),e=o.width*window.devicePixelRatio,t=o.height*window.devicePixelRatio):"design"===r.type?(o=await Editor.Profile.getProject("project","general.designResolution"),e=o.width,t=o.height):"free"===r.type&&(e=device_adapter_1.NativeAdapter.screenWidth*window.devicePixelRatio,t=device_adapter_1.NativeAdapter.screenHeight*window.devicePixelRatio),device_adapter_1.NativeAdapter.fitScreen(e,t,n,i,a/100);var o=getRect();return o&&(o.x+=device_adapter_1.NativeAdapter.offsetX,o.y+=device_adapter_1.NativeAdapter.offsetY,o.width=device_adapter_1.NativeAdapter.width,o.height=device_adapter_1.NativeAdapter.height),panel.devicesInfo=r,panel.$.preview.resize(o),{scale:Math.floor(100*device_adapter_1.NativeAdapter.scale)}}},async editorPreviewChangeConfig(){panel},onEditorPreviewStop(){panel_manager_1.ScenePanelManager.onPreviewStop()}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;