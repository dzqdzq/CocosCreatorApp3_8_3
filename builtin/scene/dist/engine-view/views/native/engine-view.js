"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NativeEngineView=void 0;const base_view_1=require("../base-view"),index_1=__importDefault(require("../../ipc/index")),message_1=require("../../ipc/message"),tasks_1=__importDefault(require("../../tasks")),preview_client_1=require("./preview-client"),editor_client_1=require("./editor-client"),panel_constant_1=require("../../../panel/panel-constant"),ipc_1=require("../../../panel/native/ipc");class NativeEngineView extends base_view_1.BaseView{constructor(){super(),this.$scene=new editor_client_1.NativeEditorClient,this.previewClient=new preview_client_1.NativePreviewClient,this.isPreviewEnabled=!1,this._lastSceneJson="",this._platform=""}listenIpc(i){i&&Object.keys(message_1.EngineViewIPCMessages).forEach(t=>{var e;null!=(e=i.on)&&e.call(i,t,async(...e)=>(ipc_1.PanelIpc.onSceneToPanel(t,...e),message_1.EngineViewIPCMessages[t].call(this,...e)))})}async init(){document.body.setAttribute("style","background:#434343"),this.$scene.load(this),this.ipc=new index_1.default(this.$scene.ipc),super.init(),this.listenIpc(this.$scene.ipc),Editor.Startup.__protected__.ready.package?this.depend.finish(tasks_1.default.editorInit[0]):Editor.Startup.__protected__.once("package-ready",()=>{this.depend.finish(tasks_1.default.editorInit[0])}),await this.depend.execute(tasks_1.default.assetDbReady[0])&&this.depend.finish(tasks_1.default.assetDbReady[0]),await this.depend.execute(tasks_1.default.packerDriverReady[0])&&this.depend.finish(tasks_1.default.packerDriverReady[0]),this.info=await this.depend.execute(tasks_1.default.queryEngineInfo[0]),this.depend.finish(tasks_1.default.queryEngineInfo[0])}async checkAvailable(t){return new Promise(e=>{this.isPreviewEnabled===t&&e(!1),this.previewClient.checkAvailable().then(e)})}async previewSetPlay(e){if(this._showLoading(),!await this.checkAvailable(e))return this._hideLoading(),!1;this._broadcastPreviewState(panel_constant_1.EditorPreviewState.Changing,e);var t=await this._changePreviewState(e);return t&&(this.isPreviewEnabled=e,this._broadcastPreviewState(e?panel_constant_1.EditorPreviewState.Start:panel_constant_1.EditorPreviewState.Stop,e)),this._hideLoading(),t}async _changePreviewState(e){if(e){var t=await this.safeCallSceneMethod("querySceneSerializedData",[])||"",[i,,]=(this._lastSceneJson=t,await this.callEditorPreviewMethod("start"));if(i)return console.error("Preview Error:",i),!1;this.ipc.setPreviewIpcEnabled(!0),await this.safeCallSceneMethod("changePreviewPlayState",[e,t])}else await this.safeCallSceneMethod("changePreviewPlayState",[e]),this.ipc.setPreviewIpcEnabled(!1),await this.safeCallSceneMethod("softReloadScene",[]),this.safeCallSceneMethod("forceUpdatePlugin",[]),this.previewClient.reload(),this._lastSceneJson="";return!0}resetStyle(){this.previewClient.resetStyle()}async previewUpdateConfig(){var{fps:e,stats:t}=await this._gameViewService.getGameViewData();await this.safeCallSceneMethod("callPreviewPlayMethod",["setFps",e]),await this.safeCallSceneMethod("callPreviewPlayMethod",["showState",t])}async previewCallMethod(e,...t){if("setPlatform"===e){var i=t[0];if(i===this._platform)return;"gameView"===i?await this._loadPreview():await this._unloadPreview(),this._platform=i}return this.safeCallSceneMethod("callPreviewPlayMethod",[e,...t])}_loadPreview(){this.previewClient.load(this),this.ipc.setPreviewIpc(this.previewClient.ipc),this.listenIpc(this.previewClient.ipc)}_unloadPreview(){this.previewClient.unload(this),this._hideLoading(),this.isPreviewEnabled=!1}async restartPreview(){this._showLoading(),await this.previewClient.restart()&&(await this.safeCallSceneMethod("changePreviewPlayState",[!0,this._lastSceneJson]),await this.previewUpdateConfig()),this._hideLoading()}_showLoading(){Editor.Message.broadcast("scene:show-loading")}_hideLoading(){Editor.Message.broadcast("scene:hide-loading")}async safeCallSceneMethod(i,a,e=!1,s=!0){return new Promise(t=>{this.callSceneMethod(i,a,e,s).then(e=>{t(e)}).catch(e=>{console.debug("safeCallSceneMethod params",i,a),console.error(`SceneMethod ${i} executed failed:
`,e),t(null)})})}async callEditorPreviewMethod(e,i=[]){return new Promise(t=>{this.previewClient.ipc.send("call-method",{module:"EditorPreview",handler:e,params:i,queue:!0,timeout:!1}).then(e=>{t([null,e])}).catch(e=>{t([e,null])})})}async callNativeSceneMethod(i=!1,a,...s){return new Promise(t=>{var e=(i?this.previewClient:this.$scene).ipc;null!=e&&e.send("call-method",{module:"NativeScene",handler:a,params:s,queue:!0,timeout:!1}).then(e=>{t([null,e])}).catch(e=>{t([e,null])})})}_broadcastPreviewState(e,t){Editor.Message.broadcast("scene:editor-preview-set-play",e,t)}}exports.NativeEngineView=NativeEngineView;