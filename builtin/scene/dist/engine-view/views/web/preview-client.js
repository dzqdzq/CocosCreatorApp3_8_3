"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreviewClient=void 0;const join=require("path")["join"],scene_web_ipc_1=__importDefault(require("../../ipc/scene-web-ipc")),utils_1=require("../../../script/utils/ipc/utils"),device_adapter_1=require("../../../script/utils/device-adapter"),base_client_1=require("../base-client"),remote_1=require("@electron/remote"),lodash_1=require("lodash"),previewPreload=join(__dirname,"../../../script/3d/preload/web/preview.js"),previewURL="packages://scene/static/template/3d-webview.html?url="+encodeURI(previewPreload),PreviewMessages={"preview-ready"(){this.isPreviewReady=!0},"preview-failed"(){this.isPreviewFailed=!0},"preview-close"(){this.isPreviewReady=!1,this.isPreviewFailed=!1},"preview-restart"(){this.restart()}};class PreviewClient extends base_client_1.BaseClient{get isPreviewReady(){return this._isPreviewReady}set isPreviewReady(e){this._isPreviewReady=e,this.ipc.setReady(e),e&&this._readyResolve&&this._readyResolve(!0)}get isPreviewFailed(){return this._isPreviewFailed}set isPreviewFailed(e){(this._isPreviewFailed=e)&&this._readyResolve&&this._readyResolve(!1)}constructor(){super(),this._restarting=!1,this._loaded=!1,this._isPreviewReady=!1,this._isPreviewFailed=!1,this._readyResolve=null,this._resizeDebounce=(0,lodash_1.debounce)(this.setSize,120)}setSize(e,i){this._loaded&&(this.webview.setAttribute("style",`width:${e}px; height:${i}px;`),requestAnimationFrame(()=>{device_adapter_1.WebAdapter.offsetX=this.webview.offsetLeft,device_adapter_1.WebAdapter.offsetY=this.webview.offsetTop}),this.webview.parentElement)&&(this.webview.parentElement.setAttribute("game-view",""),this.webview.parentElement.addEventListener("wheel",this.preventWheelScroll))}preventWheelScroll(e){e.preventDefault()}async load(e){super.load(e),this.webview.setAttribute("src",previewURL),this.webview.setAttribute("style",`position:absolute; width:${device_adapter_1.WebAdapter.screenWidth}px;height:${device_adapter_1.WebAdapter.screenHeight}px;`),this.webview.addEventListener("dom-ready",()=>{this._restarting||(this.webview.setAttribute("style","display:none"),this._loaded=!0);var e=remote_1.webContents.fromId(this.webview.getWebContentsId());null!=e&&e.setBackgroundThrottling(!1)}),this.ipc=new scene_web_ipc_1.default(this.webview,utils_1.IPCChannel.PreviewSend,utils_1.IPCChannel.PreviewReply),this._listerPreviewEvent()}_listerPreviewEvent(){Object.keys(PreviewMessages).forEach(e=>{var i,t;null!=(t=null==(i=this.ipc)?void 0:i.on)&&t.call(i,e,PreviewMessages[e].bind(this))})}unload(e){this._loaded&&(this.isPreviewFailed=!1,this.isPreviewReady=!1,this._loaded=!1,this._readyResolve&&(this._readyResolve(!1),this._readyResolve=null),this.webview.setAttribute("src",""),this.webview.reload(),e.removeChild(this.webview))}show(){}hide(){this.webview.setAttribute("style","display: none")}async updateStyle(e){var{rotate:e,scaleValue:i,devicesInfo:t,fullScreen:s}=e;let r=t.width,a=t.height;"ratio"===t.type?(d=device_adapter_1.WebAdapter.ratioToSize(r,a),r=d.width,a=d.height):"design"===t.type?(d=await Editor.Profile.getProject("project","general.designResolution"),r=d.width,a=d.height):"free"===t.type&&(r=device_adapter_1.WebAdapter.screenWidth*window.devicePixelRatio,a=device_adapter_1.WebAdapter.screenHeight*window.devicePixelRatio),device_adapter_1.WebAdapter.fitScreen(r,a,s,e,i/100);var d=Math.floor(device_adapter_1.WebAdapter.width),t=Math.floor(device_adapter_1.WebAdapter.height);return this._resizeDebounce(d,t),{scale:Math.floor(100*device_adapter_1.WebAdapter.scale)}}resetStyle(){this.webview.setAttribute("style","pointer-events: none;flex:1;"),this.webview.parentElement&&(this.webview.parentElement.removeAttribute("game-view"),this.webview.parentElement.removeEventListener("wheel",this.preventWheelScroll))}async restart(){return new Promise((t,e)=>{this._showLoading(),this._restarting=!0,this.ipc.setReady(!1);const s=(async()=>{this.webview.removeEventListener("did-finish-load",s),this.ipc.clearBuffer(),this.ipc.setReady(!0);var[e,i]=await this.callEditorPreviewMethod("start");this._restarting=!1,this._hideLoading(),e?(console.error("Preview Error:",e,i),t(!1)):t(!0)}).bind(this);this.webview.addEventListener("did-finish-load",s),this.webview.reload()})}async checkAvailable(){return new Promise(e=>{this.isPreviewFailed&&(console.info(Editor.I18n.t("scene.game_view.failed")),e(!1)),this.isPreviewReady?e(!0):this._readyResolve=e})}_showLoading(){Editor.Message.broadcast("scene:show-loading")}_hideLoading(){Editor.Message.broadcast("scene:hide-loading")}}exports.PreviewClient=PreviewClient;