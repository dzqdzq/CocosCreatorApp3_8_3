"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.WebEngineView=void 0;const panel=require("@editor/panel"),base_view_1=require("../base-view"),index_1=__importDefault(require("../../ipc/index")),message_1=require("../../ipc/message"),tasks_1=__importDefault(require("../../tasks")),device_adapter_1=require("../../../script/utils/device-adapter"),float_window_1=__importDefault(require("../../plugin/float-window")),infobar_1=__importDefault(require("../../plugin/infobar")),preview_client_1=require("./preview-client"),editor_client_1=require("./editor-client"),panel_constant_1=require("../../../panel/panel-constant");class WebEngineView extends base_view_1.BaseView{constructor(){super(),this.$scene=new editor_client_1.EditorClient,this.previewClient=new preview_client_1.PreviewClient,this.isPreviewEnabled=!1,this._lastSceneJson="",this._platform="",this._enableMiniPreview=!0}async init(){await this.$scene.load(this),this.ipc=new index_1.default(this.$scene.ipc),super.init(),Object.keys(message_1.EngineViewIPCMessages).forEach(e=>{var i,t;null!=(t=null==(i=this.$scene.ipc)?void 0:i.on)&&t.call(i,e,message_1.EngineViewIPCMessages[e].bind(this))}),Editor.Startup.__protected__.ready.package?this.depend.finish(tasks_1.default.editorInit[0]):Editor.Startup.__protected__.once("package-ready",()=>{this.depend.finish(tasks_1.default.editorInit[0])}),await this.depend.execute(tasks_1.default.assetDbReady[0])&&this.depend.finish(tasks_1.default.assetDbReady[0]),await this.depend.execute(tasks_1.default.packerDriverReady[0])&&this.depend.finish(tasks_1.default.packerDriverReady[0]),this.info=await this.depend.execute(tasks_1.default.queryEngineInfo[0]),this.depend.finish(tasks_1.default.queryEngineInfo[0])}async checkAvailable(i){return new Promise(e=>{this.isPreviewEnabled===i&&e(!1),this.previewClient.checkAvailable().then(e)})}focus(){device_adapter_1.WebAdapter.enable&&this.previewClient.webview.focus()}async previewSetPlay(e){if(this._showLoading(),!await this.checkAvailable(e))return this._hideLoading(),!1;this._broadcastPreviewState(panel_constant_1.EditorPreviewState.Changing,e);var i=await this._changePreviewState(e);return i&&(this.isPreviewEnabled=e,this._setPreviewMenuVisible(e),this._switchWebviewVisibility(e),this._updateTitle(e),this._broadcastPreviewState(e?panel_constant_1.EditorPreviewState.Start:panel_constant_1.EditorPreviewState.Stop,e)),this._hideLoading(),i}async _changePreviewState(e){if(e){await this.callSceneMethod("saveSceneConfig");var i=await this.callSceneMethod("querySceneSerializedData",[])||"",[t,,]=(this._lastSceneJson=i,this._enableMiniPreview=!1,await this.callEditorPreviewMethod("start"));if(t)return console.error("Preview Error:",t),!1;this.ipc.setPreviewIpcEnabled(!0),await this.callSceneMethod("changePreviewPlayState",[e,i]),await this.previewUpdateConfig()}else await this.callSceneMethod("changePreviewPlayState",[e]),this.ipc.setPreviewIpcEnabled(!1),this._enableMiniPreview=!0,await this.callSceneMethod("softReloadScene",[]),this.callSceneMethod("forceUpdatePlugin",[]),this.previewClient.reload(),this._lastSceneJson="";return!0}_switchWebviewVisibility(e){e?(this.$scene.hide(),this.callSceneMethod("changeSceneViewVisible",[!1])):(this.$scene.show(),this.previewClient.hide(),this.callSceneMethod("changeSceneViewVisible",[!0]))}_updateTitle(e){var i=panel.queryInfo("scene");i.userData.title=e?"i18n:scene.preview_title":"i18n:scene.title",panel.changeUserData("scene",i.userData)}_setPreviewMenuVisible(e){this._enableMiniPreview=!e,this._gameViewService.setGameViewVisible(e),device_adapter_1.WebAdapter.enable=e,this.__plugin_info__&&this.updatePlugin(this.__plugin_info__),e?this.previewUpdateStyle():this.resetStyle()}async previewUpdateStyle(){var e=await this._gameViewService.getGameViewData();if(await this._gameViewService.showGameView())return device_adapter_1.WebAdapter.reset(this.offsetWidth,this.offsetHeight),this.previewClient.updateStyle(e)}resetStyle(){this.previewClient.resetStyle()}async previewUpdateConfig(){var{fps:e,stats:i}=await this._gameViewService.getGameViewData();await this.callSceneMethod("callPreviewPlayMethod",["setFps",e]),await this.callSceneMethod("callPreviewPlayMethod",["showState",i])}async previewCallMethod(e,...i){if("pause"===e)i[0]?this._setPreviewMenuVisible(!1):(this._setPreviewMenuVisible(!0),this.previewUpdateConfig());else if("setPlatform"===e){var t=i[0];if(t===this._platform)return;"gameView"===t?this._loadPreview():this._unloadPreview(),this._platform=t}return this.callSceneMethod("callPreviewPlayMethod",[e,...i])}_loadPreview(){this.previewClient.load(this),this.ipc.setPreviewIpc(this.previewClient.ipc),Object.keys(message_1.EngineViewIPCMessages).forEach(e=>{var i;null!=(i=this.previewClient.ipc)&&i.on(e,message_1.EngineViewIPCMessages[e].bind(this))})}_unloadPreview(){this.previewClient.unload(this),this._hideLoading(),this.isPreviewEnabled=!1}async callEditorPreviewMethod(e,t=[]){return new Promise(i=>{this.previewClient.ipc.send("call-method",{module:"EditorPreview",handler:e,params:t,queue:!0,timeout:!1}).then(e=>{i([null,e])}).catch(e=>{i([e,null])})})}_showLoading(){Editor.Message.broadcast("scene:show-loading")}_hideLoading(){Editor.Message.broadcast("scene:hide-loading")}_broadcastPreviewState(e,i){Editor.Message.broadcast("scene:editor-preview-set-play",e,i)}updatePlugin(e){this._enableMiniPreview?super.updatePlugin(e):(this.__plugin_info__=e,float_window_1.default.isHidden()||float_window_1.default.unselect(),infobar_1.default.update(e,[],{}))}}exports.WebEngineView=WebEngineView;