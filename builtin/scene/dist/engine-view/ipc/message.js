"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,a)}:function(e,t,s,r){e[r=void 0===r?s:r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.EngineViewIPCMessages=void 0;const basename=require("path")["basename"],float_window_1=__importDefault(require("../plugin/float-window")),toolbar=__importStar(require("../plugin/toolbar")),listener_1=require("../listener"),path_1=require("path"),tasks_1=__importDefault(require("../tasks")),index_1=require("../particle/index"),index_2=require("../physics-2d/index"),electronIpc=__importStar(require("@base/electron-base-ipc")),escToExitPointerLock=e=>{"Escape"===e.code&&(document.exitPointerLock(),document.removeEventListener("keydown",escToExitPointerLock))},messages={async ready(){this.depend.execute("webview-ready"),Editor.Profile.getConfig("preview","preview.current.platform","local").then(e=>{this.previewCallMethod("setPlatform",e)})},close(){this.depend.reset("webview-ready")},"immediately-dump"(e){tasks_1.default.updateDump(e)},"query-engine"(){return{path:this.info.path,utils:this.info.utils,compile:this.info.compile}},async"query-scene"(){return await Editor.Profile.getTemp("scene","current-scene")||""},async"set-scene"(e){await Editor.Profile.setTemp("scene","current-scene",e||"")},async"clear-scene"(){Editor.Profile.setTemp("scene","current-scene","")},async"change-title"(e,t){var s=basename(Editor.Project.path);let r="Untitled",a=(e&&(e=await Editor.Message.request("asset-db","query-asset-info",e))&&(r=basename(e.source||"")),t&&(r+="*"),r+" - "+s);"darwin"!==process.platform&&(a+=" - Cocos Creator "+Editor.App.version),Editor.Message.broadcast("editor-title-change",a)},async"query-scripts"(){return await Editor.Message.request("asset-db","query-assets",{ccType:"cc.Script"})},async"query-effects"(){return(await Editor.Message.request("asset-db","query-assets",{importer:"effect",ccType:"cc.EffectAsset"})).map(e=>e.uuid)},async"query-asset-info"(e){return Editor.Message.request("asset-db","query-asset-info",e)},async"query-asset-meta"(e){return Editor.Message.request("asset-db","query-asset-meta",e)},async"query-uuid"(e){return Editor.Message.request("asset-db","query-uuid",e)},async"query-assets"(e){return Editor.Message.request("asset-db","query-assets",e)},async"query-app-path"(){return Editor.App.path},async"query-project-path"(){return Editor.Project.path},async"get-config"(e,t,s){return await Editor.Profile.getConfig(e,t,s)},async"set-config"(e,t,s,r){return Editor.Profile.setConfig(e,t,s,r)},async"get-project"(e,t,s){return Editor.Profile.getProject(e,t,s)},async"set-project"(e,t,s,r){return Editor.Profile.setProject(e,t,s,r)},async"enter-mode"(e){Editor.EditMode.enter(e)},async"get-packages"(e){return Editor.Package.getPackages(e)},async selection(e,...t){return Editor.Selection[e](...t)},async"editor-dialog"(e,...t){return Editor.Dialog[e](...t)},async i18n(e,t){return Editor.I18n.t(e,t)},async"get-contour-points"(e,t){return index_2.physics2DMgr.getContourPoints(e,t)},async"export-particle-plist"(e,t){return index_1.particleMgr.exportParticlePlist(e,t)},async panel(e,...t){return Editor.Panel[e](...t)},async broadcast(e,...t){await Editor.Message.broadcast(e,...t)},async"init-preview-ipc"(s,e){electronIpc.unregisterChannel(s),electronIpc.registerChannel(s),electronIpc.on(e,async(e,t)=>{t=await this.callSceneMethod("queryPreviewData",[s,t]);e.reply(null,t)})},"scene:ready"(){(0,listener_1.start)()},"scene:close"(){(0,listener_1.stop)(),float_window_1.default.unselect()},"select-nodes"(e){e.forEach(e=>{Editor.Selection.select("node",e)})},"unselect-nodes"(e){e.forEach(e=>{Editor.Selection.unselect("node",e)})},"lock-pointer"(e){e?(this.requestPointerLock(),document.addEventListener("keydown",escToExitPointerLock)):(document.exitPointerLock(),document.removeEventListener("keydown",escToExitPointerLock))},"change-pointer"(e){document.body.style.cursor=e},async"save-asset"(e,t){return await Editor.Message.request("asset-db","save-asset",e,t)},async"create-asset"(e,t,s){if(!e&&s){var r={scene:{url:"db://assets/scene.scene",title:"scene.save",name:"Scene File",warn:"scene.messages.save_fail"},prefab:{url:"db://assets/node.prefab",title:"scene.save_prefab",name:"Prefab File",warn:"scene.messages.save_fail_prefab"}},a=await Editor.Message.request("asset-db","generate-available-url",r[s].url),a=await Editor.Message.request("asset-db","query-path",a)||"",{canceled:i,filePath:n}=await Editor.Dialog.save({title:Editor.I18n.t(r[s].title),path:a,filters:[{name:r[s].name,extensions:[s]}]});if(i)return;i=null!=n?n:a,n=(0,path_1.join)(Editor.Project.path,"assets");if(!Editor.Utils.Path.contains(n,i)||!i.endsWith("."+s))return void await Editor.Dialog.warn(Editor.I18n.t(r[s].warn),{title:Editor.I18n.t("scene.messages.warning")});a=await Editor.Message.request("asset-db","query-url",i);if(!a)return;e=a}n=await Editor.Message.request("asset-db","create-asset",e,t,{overwrite:!0});if(n)return Editor.Message.send("assets","twinkle",n.uuid,"shrink"),n.uuid},async"save-asset-meta"(e,t){return Editor.Message.request("asset-db","save-asset-meta",e,t)},async"dirty-dialog"(e){return(await Editor.Dialog.warn((e||"Scene")+Editor.I18n.t("scene.messages.scenario_modified"),{title:Editor.I18n.t("scene.messages.warning"),detail:Editor.I18n.t("scene.messages.want_to_save"),default:0,cancel:2,buttons:[Editor.I18n.t("scene.messages.save"),Editor.I18n.t("scene.messages.dont_save"),Editor.I18n.t("scene.messages.cancel")]})).response},"generate-available-url"(e){return Editor.Message.request("asset-db","generate-available-url",e)},async"record-scene-view"(e){await Editor.Profile.setConfig("scene","scene_view",e)},async"record-gizmos"(e){var t;e.gizmosInfos&&(t=await Editor.Profile.getConfig("scene","gizmos-infos")||{},Object.assign(t,e.gizmosInfos),await Editor.Profile.setConfig("scene","gizmos-infos",t)),e.snapConfigs&&(t=await Editor.Profile.getConfig("scene","snap-configs")||{},Object.assign(t,e.snapConfigs),await Editor.Profile.setConfig("scene","snap-configs",t)),e.rectSnapConfigs&&(t=await Editor.Profile.getConfig("scene","rect-snap-configs")||{},Object.assign(t,e.rectSnapConfigs),await Editor.Profile.setConfig("scene","rect-snap-configs",t))},"update-plugin"(e){this.updatePlugin(e)},"send-plugin"(e,...t){"float-window"===e&&float_window_1.default.send(...t)},"force-update"(e,t){const s={},r=[];switch(t.nodes.forEach(e=>{e.components.forEach(e=>{r.includes(e.type)||(r.push(e.type),(s[e.type]=s[e.type]||[]).push(e))})}),e){case"toolbar":toolbar.update(t,r,s);break;case"float-window":float_window_1.default.update(t,r,s)}}};exports.EngineViewIPCMessages=messages;