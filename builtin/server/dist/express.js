"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.stop=exports.startup=exports.setPort=exports.queryHTTPSEnabled=exports.getPort=void 0;const fs_extra_1=require("fs-extra"),http_1=require("http"),https_1=require("https"),express_1=__importDefault(require("express")),os_1=require("os"),socket_1=require("./socket"),plugin_1=require("./plugin"),compression=require("compression"),app=(0,express_1.default)(),ports=(app.use(compression()),{http:7456,https:7567}),server={http:null,https:null};function getPort(){return ports.http}function queryHTTPSEnabled(){return server.https}function setPort(e){ports.http=e}async function startup(){server.http=(0,http_1.createServer)(app),ports.http=await Editor.Profile.getConfig("server","server_port")||7456;var e,t=await Editor.Profile.getConfig("server","https");t.enable&&(e={key:void 0,cert:void 0,ca:void 0},(0,fs_extra_1.existsSync)(t.key)&&(e.key=await(0,fs_extra_1.readFile)(t.key)),(0,fs_extra_1.existsSync)(t.cert)&&(e.cert=await(0,fs_extra_1.readFile)(t.cert)),(0,fs_extra_1.existsSync)(t.ca)&&(e.ca=await(0,fs_extra_1.readFile)(t.ca)),server.https=(0,https_1.createServer)(e,app),ports.https=await Editor.Profile.getConfig("server","https.port")||7567);try{ports.http=await Editor.Network.getFreePort(ports.http),ports.https=await Editor.Network.getFreePort(ports.https),await new Promise((t,r)=>{var e;const s={error(){var e;null!=(e=server.http)&&e.removeListener("listening",s.listener),null!=(e=server.https)&&e.removeListener("listening",s.listener),r(`Port ${ports.http} is occupied`)},listener(){var e;null!=(e=server.http)&&e.removeListener("error",s.error),null!=(e=server.https)&&e.removeListener("error",s.error),t()}};null!=(e=server.http)&&e.once("error",s.error),null!=(e=server.http)&&e.once("listening",s.listener),null!=(e=server.http)&&e.listen(ports.http),null!=(e=server.https)&&e.once("error",s.error),null!=(e=server.https)&&e.once("listening",s.listener),null!=(e=server.https)&&e.listen(ports.https)})}catch(e){console.warn("Server: "+e)}(0,socket_1.start)(server.https||server.http),Editor.Message.broadcast("preview:port-change",ports.http)}async function stop(){var e;server&&(null!=(e=server.http)&&e.close(()=>{(0,socket_1.disconnect)()}),null!=(e=server.https)&&e.close(()=>{(0,socket_1.disconnect)()}),server.http=null,server.https=null)}exports.getPort=getPort,exports.queryHTTPSEnabled=queryHTTPSEnabled,exports.setPort=setPort,exports.startup=startup,exports.stop=stop,app.all("*",(e,t,r)=>{server.https&&"http"===e.protocol?t.redirect(`https://${e.host}:`+ports.https+e.url):(t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Content-Type"),t.header("Access-Control-Allow-Methods","*"),r())}),app.all("/__test__connect__",(e,t,r)=>{t.send({})}),app.get("/__server__/handshake",async(e,t)=>{var r=await Editor.User.getData();t.send({host:(0,os_1.hostname)(),name:r.nickname})}),app.get("*",async(o,p,e)=>{for(let e=plugin_1.fileArray.length-1;0<=e;e--){const n=plugin_1.fileArray[e];var t=o.path.match(n.regexp);if(t){o.params=t.filter((e,t)=>0!==t).map(e=>decodeURIComponent(e));let s=!1;if(await new Promise(t=>{const r=p.end;p.end=function(){s=!1,p.end=r,t(),r.call(p)},n.handle(o,p,e=>{e&&console.error(e),s=!0,p.end=r,t()})}),!s)return}}for(let e=plugin_1.getArray.length-1;0<=e;e--){var r=plugin_1.getArray[e],s=o.path.match(r.regexp);if(s){o.params=s.filter((e,t)=>0!==t).map(e=>decodeURIComponent(e));let e=!1;if(await r.handle(o,p,()=>{e=!0}),!e)return}}e()}),app.post("*",async(t,r,e)=>{for(let e=plugin_1.postArray.length-1;0<=e;e--){var s=plugin_1.postArray[e],o=t.path.match(s.regexp);if(o){t.params=o.filter((e,t)=>0!==t).map(e=>decodeURIComponent(e));let e=!1;if(await s.handle(t,r,()=>{e=!0}),!e)return}}e()}),app.get("*",(e,t)=>{t.status(404),t.send("404 - Not Found")}),app.use((e,t,r,s)=>{console.error(e),r.status(500),r.send("500 - Web Server Error")});