"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MissingClass=exports.MissingClassReporter=void 0;const _=require("lodash"),ps=require("path"),ObjectWalker=require("./object-walker"),missing_reporter_1=require("./missing-reporter");async function report(s,n,a,c){var l=missing_reporter_1.MissingReporter.getObjectType(a),p=c&&ps.basename(c);if(a instanceof cc.SceneAsset||a instanceof cc.Prefab){let r,e,t;s instanceof cc.Component?(e=s,t=e.node):cc.Node.isNode(s)&&(t=s);a=p?` in ${l} "${p}"`:"";let i=n,o=!1;if(e){let s=cc.js.getClassName(e);e instanceof cc._MissingScript&&(o=!0,i=s=e._$erialized.__type__),r=`Class "${n}" used by component "${s}"${a} is missing or invalid.`}else{if(!t)return;o=!0,r=`Script "${n}" attached to "${t.name}"${a} is missing or invalid.`}r+=missing_reporter_1.MissingReporter.INFO_DETAILED;try{let s=t,e=s.name;for(;s.parent&&!(s.parent instanceof cc.Scene);)s=s.parent,e=s.name+"/"+e;r+=`Node path: "${e}"
`}catch(s){}if(c&&(r+=`Asset url: "${c}"
`),o&&Editor.Utils.UUID.isUUID(i)){s=Editor.Utils.UUID.decompressUUID(i);try{var g=await Editor.Message.request("asset-db","query-missing-asset-info",s.match(/[^@]*/)[0]);g&&(r=(r+=`Script file: "${g.path}"
`)+`Script deleted time: "${new Date(g.removeTime).toLocaleString()}"
`)}catch(s){}r=(r+=`Script UUID: "${s}"
`)+`Class ID: "${i}"
`}r.slice(0,-1),console.error(r)}}async function reportByWalker(s,e,r,t,i,o){o=o||s._$erialized&&s._$erialized.__type__;let n;await report(n=e instanceof cc.Component||cc.Node.isNode(e)?e:_.findLast(r,s=>s instanceof cc.Component||cc.Node.isNode(s)),o,t,i)}class MissingClassReporter extends missing_reporter_1.MissingReporter{report(){ObjectWalker.walk(this.root,(s,e,r,t)=>{this.missingObjects.has(r)&&reportByWalker(r,s,t,this.root)})}reportByOwner(){let o,e;if(this.root instanceof cc.Asset){try{var s=globalThis.Manager;s&&s.assetManager&&(e=s.assetManager.queryAssetInfo(this.root._uuid))}catch(s){console.error(s),e=null}o=e?e.path:null}ObjectWalker.walkProperties(this.root,(s,e,r,t)=>{var i=this.missingOwners.get(s);i&&e in i&&(i=i[e],reportByWalker(r,s,t,this.root,o,i))},{dontSkipNull:!0})}}exports.MissingClassReporter=MissingClassReporter,exports.MissingClass={reporter:new MissingClassReporter,classFinder(s,e,r,t){var i=cc.js.getClassById(s);return i||(s&&(console.warn("Missing class: "+s),exports.MissingClass.hasMissingClass=!0,exports.MissingClass.reporter.stashByOwner(r,t,s)),null)},hasMissingClass:!1,reportMissingClass(s){s._uuid&&exports.MissingClass.hasMissingClass&&(exports.MissingClass.reporter.root=s,exports.MissingClass.reporter.reportByOwner(),exports.MissingClass.hasMissingClass=!1)},reset(){exports.MissingClass.reporter.reset()}},exports.MissingClass.classFinder.onDereferenced=function(s,e,r,t){s=exports.MissingClass.reporter.removeStashedByOwner(s,e);s&&exports.MissingClass.reporter.stashByOwner(r,t,s)};