"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MissingObjectReporter=void 0;const missing_reporter_1=require("./missing-reporter"),_=require("lodash"),ps=require("path"),ObjectWalker=require("./object-walker");class MissingObjectReporter extends missing_reporter_1.MissingReporter{async doReport(e,s,t,i,r){let n,o="";(n=e instanceof cc.Component||e instanceof cc.Asset?e:_.findLast(t,e=>e instanceof cc.Component||e instanceof cc.Asset))instanceof cc.Component?(e=missing_reporter_1.MissingReporter.getObjectType(n),o=` by ${e} "${cc.js.getClassName(n)}"`):(n=_.findLast(t,e=>e instanceof cc.Node))&&(o=` by node "${n.name}"`);let a;if("string"==typeof s)a=`Asset "${s}" used${o}${r} is missing.`;else{let e=cc.js.getClassName(s);e.startsWith("cc.")&&(e=e.slice(3)),a=s instanceof cc.Asset?`The ${e} used${o}${r} is missing.`:`The ${e} referenced${o}${r} is invalid.`}a+=missing_reporter_1.MissingReporter.INFO_DETAILED,n instanceof cc.Component&&(n=n.node);try{if(n instanceof cc.Node){let e=n,s=e.name;for(;e.parent&&!(e.parent instanceof cc.Scene);)e=e.parent,s=e.name+"/"+s;a+=`Node path: "${s}"
`}}catch(e){}if(i&&(a+=`Asset url: "${i}"
`),s instanceof cc.Asset&&s._uuid){try{var c=await Editor.Message.request("asset-db","query-missing-asset-info",s._uuid.match(/[^@]*/)[0]);c&&(a=(a+=`Asset file: "${c.path}"
`)+`Asset deleted time: "${new Date(c.removeTime).toLocaleString()}"
`)}catch(e){}a+=`Missing uuid: "${s._uuid}"
`}a.slice(0,-1),console[this.outputLevel]?console[this.outputLevel](a):console.warn(a)}report(){let n,s;if(this.root instanceof cc.Asset){try{var e=globalThis.Manager;e&&e.assetManager&&(s=e.assetManager.queryAssetInfo(this.root._uuid))}catch(e){console.error(e),s=null}n=s?s.path:null}e=missing_reporter_1.MissingReporter.getObjectType(this.root);const o=n?` in ${e} "${ps.basename(n)}"`:"";ObjectWalker.walk(this.root,(e,s,t,i,r)=>{this.missingObjects.has(t)&&this.doReport(e,t,i,n,o)})}reportByOwner(){let n,s;if(this.root instanceof cc.Asset){try{var e=globalThis.Manager;e&&e.assetDBManager.ready&&(s=e.assetManager.queryAssetInfo(this.root._uuid))}catch(e){console.error(e),s=null}n=s?s.path:null}e=missing_reporter_1.MissingReporter.getObjectType(this.root);const o=n?` in ${e} "${ps.basename(n)}"`:"";ObjectWalker.walkProperties(this.root,(e,s,t,i)=>{var r=this.missingOwners.get(e);r&&s in r&&(r=r[s],this.doReport(e,r||t,i,n,o))},{dontSkipNull:!0})}}exports.MissingObjectReporter=MissingObjectReporter;