"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){e[i=void 0===i?r:i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Parser=void 0;const cc_1=require("cc"),cc=__importStar(require("cc")),uuid_1=require("../uuid"),populate_internal_constants_1=require("cc/editor/populate-internal-constants"),builder_1=__importDefault(require("./compiled/builder")),dynamic_builder_1=__importDefault(require("./dynamic-builder")),{PersistentMask,DontSave,DontDestroy,EditorOnly}=cc_1.CCObject.Flags,getDefault=cc_1.CCClass.getDefault,Attr=cc_1.CCClass.Attr,EDITOR_ONLY=Attr.DELIMETER+"editorOnly",DEFAULT=Attr.DELIMETER+"default",FORMERLY_SERIALIZED_AS=Attr.DELIMETER+"formerlySerializedAs";function equalsToDefault(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof cc_1.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return cc_1.js.isEmptyObject(e)&&cc_1.js.isEmptyObject(t)}return!1}function isSerializableClass(e,t){return!!t&&cc_1.CCClass.isCCClassOrFastDefined(t)&&!!cc_1.js.getClassId(e,!1)}function isSyncPrefab(e){var t;return(null==(t=null==(t=null==(t=null==e?void 0:e._prefab)?void 0:t.root)?void 0:t._prefab)?void 0:t.instance)&&((null==(t=null==e?void 0:e._prefab)?void 0:t.instance)||!isMountedChild(e))}function isMountedChild(e){return!(null==(e=e[cc_1.editorExtrasTag])||!e.mountedRoot)}class Parser{constructor(e,t){this.parsingInfos=new Map,this.exporting=!!(t=t||{})._exporting,this.mustCompresseUuid=!!t.compressUuid,this.discardInvalid=!("discardInvalid"in t&&!t.discardInvalid),this.dontStripDefault=!(this.exporting&&"dontStripDefault"in t&&!t.dontStripDefault),this.missingClassReporter=t.missingClassReporter,this.missingObjectReporter=t.missingObjectReporter,this.reserveContentsForAllSyncablePrefab=!!t.reserveContentsForSyncablePrefab;var r,i={};i[cc.Node.reserveContentsForAllSyncablePrefabTag]=this.reserveContentsForAllSyncablePrefab,this._serializationContext={root:null,toCCON:null!=(r=t.useCCON)&&r,customArguments:i},this.builder=e,this.keepNodeUuid=!!t.keepNodeUuid,this.assetExists=this.missingObjectReporter&&Object.create(null),this.customExportingCtxCache=this.exporting?{_depends:[],dependsOn(e,t){this._compressUuid&&(t=(0,uuid_1.compressUuid)(t,!0)),this._depends.push(e,t)},_compressUuid:this.mustCompresseUuid}:null,t.recordAssetDepends&&(this.recordAssetDepends=t.recordAssetDepends,this.assetDepends=new Set)}parse(e){(this.root=e)instanceof cc.Prefab?(this.prefabRoot=e.data,this._serializationContext.root=e.data):this._serializationContext.root=e;e=this.parseObjField(null,null,"",e,null);this.builder.setRoot(e),this.recordAssetDepends&&this.recordAssetDepends.push(...this.assetDepends)}checkMissingAsset(e,t){this.missingObjectReporter&&!this.assetExists[t]&&this.missingObjectReporter(e)}isObjRemoved(e){if(e instanceof cc_1.CCObject){e=e.objFlags;if(this.exporting&&(e&EditorOnly||populate_internal_constants_1.SERVER_MODE))return!0;if(e&DontSave){if(this.discardInvalid)return!0;if(e&DontDestroy)return!0}}return!1}setParsedObj(t,r,i,s){if(i&&"object"==typeof i){let e=this.parsingInfos.get(i);if(e=!e&&i instanceof cc_1.Asset&&this.root instanceof cc_1.Asset&&i._uuid&&i._uuid===this.root._uuid?this.parsingInfos.get(this.root):e)return this.builder.setProperty_ParsedObject(t,r,e,s),!0}return!1}verifyNotParsedValue(e,t,r){var i=typeof r;if("object"!=i)return"function"!=i?e instanceof cc_1.CCObject&&"_objFlags"===t&&0<r?r&PersistentMask:r:null;if(!r)return null;if(r instanceof cc_1.CCObject){if(r instanceof cc_1.Asset)return(i=r._uuid)?(this.checkMissingAsset(r,i),r):null;if(this.discardInvalid){if(!r.isValid)return null!=(e=this.missingObjectReporter)&&e.call(this,r),null}else if(!r.isRealValid)return null;if(cc_1.Node&&cc_1.Node.isNode(r))if(this.canDiscardByPrefabRoot(r)&&r!==r._prefab.root)return null;if(r instanceof cc_1.Component)if(r.node&&this.canDiscardByPrefabRoot(r.node)&&!(null!=(t=r[cc_1.editorExtrasTag])&&t.mountedRoot))return null}return r}canDiscardByPrefabRoot(e){return!(this.reserveContentsForAllSyncablePrefab||!isSyncPrefab(e)||this.prefabRoot===e)}enumerateClass(t,r,e,i){var s=Attr.getClassAttrs(e),n=i||e.__values__;for(let e=0;e<n.length;e++){var a,o,c=n[e],l=t[c];this.isObjRemoved(l)||this.exporting&&s[c+EDITOR_ONLY]||(a=s[c+FORMERLY_SERIALIZED_AS],this.setParsedObj(r,c,l,a))||(l=this.verifyNotParsedValue(t,c,l),o=getDefault(s[c+DEFAULT]),this.exporting&&!this.dontStripDefault&&equalsToDefault(o,l))||this.parseField(t,r,c,l,{formerlySerializedAs:a,defaultValue:o})}if(cc_1.Node&&t instanceof cc_1.Node||cc_1.Component&&t instanceof cc_1.Component){if(this.exporting){if(!this.keepNodeUuid)if(!(t instanceof cc_1.Node&&t._parent instanceof cc.Scene))return;if(this.prefabRoot)return;if(!this.dontStripDefault&&!t._id)return}this.builder.setProperty_Raw(t,r,"_id",t._id)}}static isDefaultTrs(e){return 0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&0===e[5]&&1===e[6]&&1===e[7]&&1===e[8]&&1===e[9]}parseField(t,r,i,s,n){var a,e=typeof s;if("object"==e)if(s)if(s instanceof cc_1.Asset&&t){let e=s._uuid;this.mustCompresseUuid&&(e=(0,uuid_1.compressUuid)(e,!0)),(n=n||{}).expectedType=cc_1.js.getClassId(s.constructor),this.builder.setProperty_AssetUuid(t,r,i,e,n),void(null!=(a=this.assetDepends)&&a.add(e))}else this.parseObjField(t,r,i,s,n);else this.builder.setProperty_Raw(t,r,i,null,n);else"function"!=e?this.builder.setProperty_Raw(t,r,i,s,n):this.builder.setProperty_Raw(t,r,i,null,n)}parseObjField(i,s,n,a,o){var t;const c=a.constructor;if(isSerializableClass(a,c)){const p=e=>{let t=c.__values__;a._onBeforeSerialize&&(t=a._onBeforeSerialize(t)||t);try{c!==cc_1.cclegacy._MissingScript||0!==t.length&&"_$erialized"===t[t.length-1]||(cc.error(`The '_$erialized' prop in '${a.name}' is missing. Will force the raw data to be read.`),cc.error(`    Error props: ['${t}'], raw props: ['${c.__values__}']. Please contact jare.`),t.push("_$erialized"))}catch(e){cc.warn("Error when checking MissingScript 3, "+e)}if(0!==t.length)if("_$erialized"!==t[t.length-1])this.enumerateClass(a,e,c,t);else{try{if(!a._$erialized)return void cc.error(`The formerly serialized data is not found from '${a.name}'. Please check the previous error report.`)}catch(e){cc.warn("Error when checking MissingScript 2, "+e)}var r=a._$erialized,i=r.__type__;this.enumerateDict(r,e),this.missingClassReporter&&this.missingClassReporter(a,i)}};var e=()=>{var e=o||{},t=a._$erialized?a._$erialized.__type__:cc.js.getClassId(c,!1);e.type=t,e.uniquelyReferenced=null==(t=cc.getSerializationMetadata(c))?void 0:t.uniquelyReferenced;const r=this.builder.setProperty_Class(i,s,n,e);if(this.parsingInfos.set(a,r),a[cc.serializeTag]){try{if(a instanceof cc_1.cclegacy._MissingScript)return cc.error("Should not declare CustomSerializable on MissingScript. Please contact jare."),p(r),r}catch(e){cc.warn("Error when checking MissingScript 1, "+e)}t={writeProperty:(e,t)=>{this.isObjRemoved(t)||this.setParsedObj(r,e,t,null)||this.parseField(a,r,e,t,{})},writeThis:()=>p(r),writeSuper:()=>{var e=cc_1.js.getSuper(c);e&&(e=e.__values__)&&this.enumerateClass(a,r,c,e)}};a[cc.serializeTag](t,this._serializationContext)}else p(r);return r};if(a instanceof cc_1.ValueType){var r=this.builder.setProperty_ValueType(i,s,n,a,o);if(r)return r}try{a instanceof cc_1.cclegacy._MissingScript&&a._serialize&&(cc.error("Should not declare _serialize on MissingScript. Please contact jare."),a._serialize=void 0)}catch(e){cc.warn("Error when checking MissingScript 0, "+e)}if(a._serialize){var r=o||{},l=(r.content=a._serialize(this.customExportingCtxCache),r.type=cc.js.getClassId(c,!1),this.builder.setProperty_CustomizedClass(i,s,n,r));if(this.parsingInfos.set(a,l),this.customExportingCtxCache){var u=this.customExportingCtxCache._depends;for(let e=0;e<u.length;e+=2)this.builder.setProperty_AssetUuid(a,l,u[e],u[e+1],null),null!=(t=this.assetDepends)&&t.add(u[e+1]);u.length=0}return l}return e()}if(ArrayBuffer.isView(a))return cc_1.Node&&cc_1.Node.isNode(i)&&"_trs"===n&&Parser.isDefaultTrs(a)||this.builder.setProperty_TypedArray(i,s,n,a,o),null;if(c&&c!==Object&&!Array.isArray(a)){if(i)return c.__isJSB?(r=this.builder.setProperty_Dict(i,s,n,o),this.parsingInfos.set(a,r),this.enumerateBindedDict(a,r),r):null;throw new Error("Unknown object to serialize: "+a)}if(Array.isArray(a)){var d=a.filter(e=>!this.isObjRemoved(e)),e=o||{},f=(e.writeOnlyArray=d,this.builder.setProperty_Array(i,s,n,e));this.parsingInfos.set(a,f);for(let e=0;e<d.length;++e){var _=d[e];this.setParsedObj(f,e,_,null)||(_=this.verifyNotParsedValue(a,e,_),this.parseField(a,f,e,_,null))}return f}return r=this.builder.setProperty_Dict(i,s,n,o),this.parsingInfos.set(a,r),this.enumerateDict(a,r),r}enumerateDict(t,r){for(const i in t)if(!(t.hasOwnProperty&&!t.hasOwnProperty(i)||95===i.charCodeAt(0)&&95===i.charCodeAt(1)&&"__prefab"!==i)){let e=t[i];if(this.isObjRemoved(e))e=null;else{if(this.setParsedObj(r,i,e,null))continue;e=this.verifyNotParsedValue(t,i,e)}this.parseField(t,r,i,e,null)}}enumerateBindedDict(t,r){for(const i in t)if(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__prefab"===i){let e=t[i];if("function"!=typeof e){if(this.isObjRemoved(e))e=null;else{if(this.setParsedObj(r,i,e,null))continue;e=this.verifyNotParsedValue(t,i,e)}this.parseField(t,r,i,e,null)}}}}function serialize(e,t){t=t||{};let r;return r=new("compiled"===t.builder?(t._exporting=!0,t.useCCON=!1,builder_1):dynamic_builder_1).default(t),new Parser(r,t).parse(e),e=null,r.dump()}exports.Parser=Parser,exports.default=serialize;