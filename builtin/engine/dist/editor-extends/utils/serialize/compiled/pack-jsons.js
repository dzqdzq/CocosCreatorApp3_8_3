"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),types_1=require("./types"),builder_1=require("./builder"),create_class_mask_1=__importDefault(require("./create-class-mask")),{EMPTY_PLACEHOLDER,CUSTOM_OBJ_DATA_CLASS,ARRAY_ITEM_VALUES,CLASS_PROP_TYPE_OFFSET,MASK_CLASS,OBJ_DATA_MASK,DICT_JSON_LAYOUT,PACKED_SECTIONS}=cc_1.deserialize._macros;function genArrayParser(s){return(r,a,t)=>{for(let e=0;e<a.length;++e)s(r,a[e],t)}}function parseArray(r,a,t){var s=a[ARRAY_ITEM_VALUES];for(let e=0;e<s.length;++e){var _=a[e+1],_=PARSERS[_];_&&_(r,s[e],t)}}function parseDict(r,a,t){for(let e=DICT_JSON_LAYOUT+1;e<a.length;e+=3){var s=a[e+1],s=PARSERS[s];s&&s(r,a[e+2],t)}}function parseClass(r,a,t){var s=r[4][a[OBJ_DATA_MASK]],_=r[3][s[MASK_CLASS]],e=types_1.ClassNode.fromData(_,s,a),l=(t.push(e),_[CLASS_PROP_TYPE_OFFSET]);for(let e=s[s.length-1];e<a.length;++e){var S=_[s[e]+l],S=PARSERS[S];S&&S(r,a[e],t)}}function parseCustomClass(e,r,a){e=e[3][r[CUSTOM_OBJ_DATA_CLASS]],e=types_1.CustomClassNode.fromData(e,r);a.push(e)}const PARSERS=new Array(13);function parseInstances(r,a){var t=r[3],s=r[5],_=r[6],l=_===EMPTY_PLACEHOLDER?0:_.length,e=s[s.length-1];let S=s.length-l,n=("number"==typeof e&&--S,0);for(;n<S;++n)parseClass(r,s[n],a);if(_)for(let e=0;e<l;++e,++n){var A,u=_[e],o=s[n];0<=u?(A=t[u],(A=types_1.CustomClassNode.fromData(A,[u,o])).instanceIndex=n,a.push(A),_[e]=A):(u=~u,(A=PARSERS[u])&&A(r,o,a))}}function parseJSON(e,r,a,t){var s=e[1],_=e[2],l=e[10];for(let e=0;e<l.length;++e){var S=s[l[e]];r.traceString(S,l,e)}if(e[7]){var n=e[7],A=n.length-1;for(let e=0;e<A;e+=3){var u=n[e+1];0<=u&&(u=_[u],a.traceString(u,n,e+1))}}var o=e[9];for(let e=0;e<o.length;++e){var c=o[e];0<=c&&(c=_[c],a.traceString(c,o,e))}parseInstances(e,t)}function packJSONs(r){var a=new types_1.TraceableDict,t=new types_1.TraceableDict,s=new Array;for(let e=0;e<r.length;++e)parseJSON(r[e],a,t,s);var{sharedClasses:e,sharedMasks:_}=(0,create_class_mask_1.default)(s);for(let e=0;e<r.length;++e){var l=r[e],S=l[6];if(S)for(let e=0;e<S.length;++e){var n=S[e];n instanceof types_1.CustomClassNode&&(S[e]=n.dumped[CUSTOM_OBJ_DATA_CLASS])}l.splice(0,5)}var A=new Array(PACKED_SECTIONS+1);return A[0]=builder_1.FORMAT_VERSION,A[1]=(0,builder_1.reduceEmptyArray)(a.dump()),A[2]=(0,builder_1.reduceEmptyArray)(t.dump()),A[3]=e,A[4]=(0,builder_1.reduceEmptyArray)(_),A[PACKED_SECTIONS]=r,A}PARSERS.fill(null),PARSERS[4]=parseClass,PARSERS[10]=parseCustomClass,PARSERS[12]=parseArray,PARSERS[9]=genArrayParser(parseClass),PARSERS[11]=parseDict,exports.default=packJSONs;