"use strict";var RefsBuilder,__createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,a)}:function(e,t,s,r){e[r=void 0===r?s:r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getRootData=exports.reduceEmptyArray=exports.FORMAT_VERSION=void 0;const cc_1=require("cc"),cc=__importStar(require("cc")),serialization_1=require("cc/editor/serialization"),types_1=require("./types"),create_class_mask_1=__importDefault(require("./create-class-mask")),base_builder_1=require("../base-builder"),{EMPTY_PLACEHOLDER,CUSTOM_OBJ_DATA_CLASS,CUSTOM_OBJ_DATA_CONTENT}=cc_1.deserialize._macros,INNER_OBJ_PLACEHOLDER=(exports.FORMAT_VERSION=1,0);function reduceEmptyArray(e){return e&&0<e.length?e:EMPTY_PLACEHOLDER}(RefsBuilder||(RefsBuilder={})).Impl=class{constructor(e){this.beforeOffsetRefs=new Array,this.afterOffsetRefs=new Array,this.ctx=e}addRef(e,t,s){return s.instanceIndex<e.instanceIndex?s.instanceIndex:(t=[NaN,t,s.instanceIndex],e.indexed?(t[0]=e.instanceIndex,this.afterOffsetRefs.push(t),NaN):(t[0]=INNER_OBJ_PLACEHOLDER,this.beforeOffsetRefs.push(t),~(this.beforeOffsetRefs.length-1)))}build(){if(0===this.beforeOffsetRefs.length&&0===this.afterOffsetRefs.length)return null;var e=this.beforeOffsetRefs.length,t=this.beforeOffsetRefs.concat(this.afterOffsetRefs),s=new Array(3*t.length+1);let r=0;for(const n of t){s[r++]=n[0];var a=n[1];"number"==typeof a?s[r++]=~a:this.ctx.sharedStrings.traceString(a,s,r++),s[r++]=n[2]}return s[r]=e,s}},exports.reduceEmptyArray=reduceEmptyArray;class CompiledBuilder extends base_builder_1.Builder{constructor(e){if(super(e),this.sharedUuids=new types_1.TraceableDict,this.sharedStrings=new types_1.TraceableDict,this.dependAssets=new Array,this.normalNodes=new Array,this.advancedNodes=new Array,this.classNodes=new Array,this.data=new Array(11),e.forceInline)throw new Error("CompiledBuilder doesn't support `forceInline`");this.noNativeDep=!("noNativeDep"in e&&!e.noNativeDep),this.refsBuilder=new RefsBuilder.Impl(this)}setProperty_Array(e,t,s,r){r=new types_1.ArrayNode(r.writeOnlyArray.length);return this.advancedNodes.push(r),this.setDynamicProperty(t,s,r),r}setProperty_Dict(e,t,s,r){var a=new types_1.DictNode;return this.advancedNodes.push(a),this.setDynamicProperty(t,s,a),a}setProperty_Class(e,t,s,r){r=new types_1.ClassNode(r.type);return this.normalNodes.push(r),this.classNodes.push(r),this.setDynamicProperty(t,s,r),r}setProperty_CustomizedClass(e,t,s,r){r=new types_1.CustomClassNode(r.type,r.content);return this.advancedNodes.push(r),this.classNodes.push(r),this.setDynamicProperty(t,s,r),r}setProperty_ParsedObject(e,t,s,r){e.setDynamic(s,t)}setProperty_Raw(e,t,s,r,a){t.setStatic(s,0,r)}setProperty_ValueType(e,t,s,r,a){if(!t)throw new Error("CompiledBulider: Not support serializing ValueType as root object.");r=(0,serialization_1.serializeBuiltinValueType)(r);if(!r)return null;let n=8;return a&&a.defaultValue instanceof cc.ValueType&&(n=5),t.setStatic(s,n,r),r}setProperty_TypedArray(e,t,s,r,a){if(!(e instanceof cc.Node)||"_trs"!==s)throw new Error("Not support to serialize TypedArray yet. Can only use TypedArray in TRS.");if(10!==r.length)throw new Error(`TRS ${r} should contains 10 elements.`);e=Array.from(r);t.setStatic(s,7,e)}setProperty_AssetUuid(e,t,s,r,a){this.dependAssets.push(t,s,r),t instanceof types_1.CustomClassNode&&(t.shouldBeIndexed=!0)}setRoot(e){this.rootNode=e}setDynamicProperty(e,t,s){e&&e.setDynamic(s,t)}collectInstances(){this.normalNodes=this.normalNodes.filter(e=>1<e.refCount),this.normalNodes.sort(types_1.Node.compareByRefCount),this.advancedNodes=this.advancedNodes.filter(e=>e.shouldBeIndexed||1<e.refCount),this.advancedNodes.sort(types_1.Node.compareByRefCount);var e,t=this.rootNode,s=(t instanceof types_1.ClassNode?(-1!==(e=this.normalNodes.indexOf(t))&&this.normalNodes.splice(e,1),this.normalNodes.unshift(t)):-1===this.advancedNodes.indexOf(t)&&(this.advancedNodes.length,this.advancedNodes.push(t)),this.normalNodes.length);for(let e=0;e<s;++e){var r=this.normalNodes[e];r.instanceIndex=e,r.indexed=!0}for(let e=0;e<this.advancedNodes.length;++e){var a=this.advancedNodes[e];a.instanceIndex=s+e,a.indexed=!0}}dumpInstances(){var e=this.normalNodes.length+this.advancedNodes.length,t=new Array(e),s=this.normalNodes.length;for(let e=0;e<s;++e){var r=this.normalNodes[e];t[e]=r.dumpRecursively(this.refsBuilder)}for(let e=0;e<this.advancedNodes.length;++e){var a=this.advancedNodes[e],n=a.dumpRecursively(this.refsBuilder);a instanceof types_1.CustomClassNode?t[s+e]=n[CUSTOM_OBJ_DATA_CONTENT]:t[s+e]=n}0===this.rootNode.instanceIndex&&"number"!=typeof t[t.length-1]&&this.noNativeDep||(e=this.rootNode.instanceIndex,t.push(this.noNativeDep?e:~e)),this.data[5]=t}dumpInstanceTypes(){var e=this.advancedNodes.map(e=>e instanceof types_1.CustomClassNode?e.dumped[CUSTOM_OBJ_DATA_CLASS]:~e.selfType);this.data[6]=reduceEmptyArray(e)}dumpDependUuids(){var r={owners:new Array,keys:new Array,uuids:new Array},a={owners:new Array,keys:new Array,uuids:new Array},n=this.dependAssets;for(let s=0;s<n.length;s+=3){var i=n[s];let e=n[s+1];var o=n[s+2];let t;i.indexed?(t=a,i.setAssetRefPlaceholderOnIndexed(e),t.owners.push(i.instanceIndex)):(t=r,i.setStatic(e,6,t.owners.length),t.owners.push(INNER_OBJ_PLACEHOLDER)),"number"==typeof e&&(e=~e),t.keys.push(e),t.uuids.push(o)}this.data[8]=r.owners.concat(a.owners);var t=this.data[9]=r.keys.concat(a.keys);for(let e=0;e<t.length;++e){var s=t[e];"string"==typeof s&&this.sharedStrings.traceString(s,t,e)}var d=this.data[10]=r.uuids.concat(a.uuids);for(let e=0;e<d.length;++e){var u=d[e];this.sharedUuids.traceString(u,d,e)}}finalizeJsonPart(){this.collectInstances(),this.dumpDependUuids(),this.dumpInstances(),this.data[0]=exports.FORMAT_VERSION;var{sharedClasses:e,sharedMasks:t}=(0,create_class_mask_1.default)(this.classNodes),e=(this.data[3]=e,this.data[4]=reduceEmptyArray(t),this.dumpInstanceTypes(),this.data[7]=this.refsBuilder.build()||EMPTY_PLACEHOLDER,this.sharedStrings.dump()),t=(this.data[2]=reduceEmptyArray(e),this.sharedUuids.dump());return this.data[1]=reduceEmptyArray(t),this.data}}function getRootData(e){var t,e=e[5];return Array.isArray(e)?"number"==typeof(t=e[e.length-1])?e[0<=t?t:~t]:e[0]:e}exports.default=CompiledBuilder,exports.getRootData=getRootData;