"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var a=Object.getOwnPropertyDescriptor(t,o);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,a)}:function(e,t,o,r){e[r=void 0===r?o:r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.importConfig=exports.exportConfig=exports.close=exports.ready=exports.$=exports.template=exports.style=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ModuleItem=__importStar(require("./module-item")),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm=null,moduleConfig=null;const vueTemplate=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../../static/contributions/project-modules.html"),"utf8"),EngineProjectModulesVM=Vue.extend({name:"EngineProjectModulesVM",components:{"module-item":ModuleItem},data(){return{all:!0,modulesDump:{},moduleCache:{},categories:{},categoriesCache:{},noDeprecatedFeatures:{value:!1,version:""},saveTimer:null,moduleDependMap:{},moduleDependedMap:{}}},methods:{t(e){return e?(e=e.replace("i18n:",""),Editor.I18n.t(e)||e):""},async refresh(){const t=this;var{moduleTreeDump:e,moduleDependMap:o,moduleDependedMap:r}=moduleConfig;const a=await Editor.Profile.getProject("engine","modules.cache");t.noDeprecatedFeatures=await Editor.Profile.getProject("engine","modules.noDeprecatedFeatures"),t.modulesDump=e,t.moduleDependMap=Object.freeze(o),t.moduleDependedMap=Object.freeze(r),t.moduleCache=a,Object.keys(e.categories).forEach(e=>{t.calcCategoryValue(e)}),t.all=Object.values(this.categoriesCache).every(Boolean)&&Object.keys(e.default).every(e=>a[e]._value)},async save(){let a=!0;const s=[];const u=this.moduleCache;function t(r){Object.keys(r).forEach(e=>{var t=r[e],o=u[e];(o||t.default)&&(t.default&&!o?s.push(e):(o._value||(a=!1),o._option?o._value&&s.push(o._option):o._value&&s.push(e)))})}Object.values(this.modulesDump.categories).forEach(e=>t(e.modules)),t(this.modulesDump.default),this.all=a,Editor.Profile.setProject("engine","modules.cache",this.moduleCache),Editor.Profile.setProject("engine","modules.flags",{}),Editor.Profile.setProject("engine","modules.includeModules",s.sort()),Editor.Profile.setProject("engine","modules.noDeprecatedFeatures",this.noDeprecatedFeatures),Editor.Message.broadcast("engine:modules-changed")},onDeprecatedAPI(e,t){this.noDeprecatedFeatures[e]=t},_onConfirm(){clearTimeout(this.saveTimer),this.saveTimer=setTimeout(()=>{this.save()},200)},_onCategoryConfirm(e,t){const o=e.target.value,r=this.modulesDump.categories[t].modules;Object.keys(r).forEach(e=>{var t=!!r[e].required||o;this.moduleCache[e]?this.moduleCache[e]._value=t:this.moduleCache[e]={_value:t}}),this.categoriesCache[t]=o},async _onModuleChanged(e,t,o,r){if("_value"===o){const{moduleDependMap:a,moduleDependedMap:s,features:u}=moduleConfig;o=(r?a:s)[t];o&&o.length&&o.forEach(e=>{var t=!!u[e].required||r;this.moduleCache[e]._value=t})}"default"!==e&&this.calcCategoryValue(e)},calcCategoryValue(e){var t=moduleConfig.moduleTreeDump.categories[e].modules,t=Object.keys(t).every(e=>this.moduleCache[e]&&this.moduleCache[e]._value);return this.categoriesCache[e]=t},_onSelectAllChanged(o){const r=this.moduleCache,t=moduleConfig["moduleTreeDump"];function a(t){Object.keys(t).forEach(e=>{t[e].required||(r[e]||(r[e]={_value:o.target.value}),r[e]._value=o.target.value)})}Object.keys(t.categories).forEach(e=>{a(t.categories[e].modules),this.calcCategoryValue(e)}),a(this.modulesDump.default),this._onConfirm()}},template:vueTemplate});async function ready(){panel=this,moduleConfig=await Editor.Message.request("engine","query-modules-config"),null!==vm&&void 0!==vm&&vm.$destroy(),(vm=new EngineProjectModulesVM).$mount(panel.$.container),vm.refresh(),Editor.Message.__protected__.addBroadcastListener("project:engine-modules-changed",vm.refresh)}function close(){vm&&Editor.Message.__protected__.removeBroadcastListener("project:engine-modules-changed",vm.refresh),null!==vm&&void 0!==vm&&vm.$destroy(),vm=null,panel=null}async function exportConfig(){var e={};return e["modules.cache"]=await Editor.Message.request("project","query-config","engine","modules.cache")||{},e["modules.flags"]=await Editor.Message.request("project","query-config","engine","modules.flags")||{},e["modules.includeModules"]=await Editor.Message.request("project","query-config","engine","modules.includeModules")||[],e["modules.noDeprecatedFeatures"]=await Editor.Message.request("project","query-config","engine","modules.cache")||{},e}async function importConfig(e){e["modules.cache"]&&await Editor.Message.request("project","set-config","engine","modules.cache",e["modules.cache"]),e["modules.flags"]&&await Editor.Message.request("project","set-config","engine","modules.flags",e["modules.flags"]),e["modules.includeModules"]&&await Editor.Message.request("project","set-config","engine","modules.includeModules",e["modules.includeModules"]),e["modules.noDeprecatedFeatures"]&&await Editor.Message.request("project","set-config","engine","modules.noDeprecatedFeatures",e["modules.noDeprecatedFeatures"])}exports.style=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"./project-modules.css"),"utf8"),exports.template='<div class="container"></div>',exports.$={container:".container"},exports.ready=ready,exports.close=close,exports.exportConfig=exportConfig,exports.importConfig=importConfig;