"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compareEngineInfo=exports.importConfig=exports.exportConfig=exports.close=exports.ready=exports.$=exports.template=exports.style=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),Vue=require("vue/dist/vue.js"),lodash=(Vue.config.productionTip=!1,Vue.config.devtools=!1,require("lodash"));let panel=null,vm=null;const vueTemplate=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../static/contributions/preferences-engine.html"),"utf8"),EnginePreferenceVM=Vue.extend({name:"EnginePreferenceVM",data(){return{config:{native:{builtin:!0,custom:""},javascript:{builtin:!0,custom:""}},types:{"javascript.builtin":"global","javascript.custom":"global","native.builtin":"global"},showRestartInfo:!1,engineInfo:null}},watch:{"config.javascript.builtin":{async handler(e){e&&(lodash.set(this.config,"native.builtin",!0),await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.native.builtin`,!0,this.types["native.builtin"]))},deep:!0},"config.javascript.custom":{handler(e){e.startsWith("project://")&&(e=Editor.UI.__protected__.File.resolveToRaw(e)),this.config.native.custom=e?(0,path_1.join)(e,"./native"):""},deep:!0}},async mounted(){var e=await Editor.Profile.getConfig("engine","engine."+Editor.App.version.replace(/\./g,""));e&&(this.config=e),this.$set(this.config.javascript,"path",(0,path_1.join)(Editor.App.path,"../resources/3d/engine")),this.$set(this.config.native,"path",(0,path_1.join)(Editor.App.path,"../resources/3d/engine/native"));for(const i of Object.keys(this.types))await this.refresh(i);e=await Editor.Message.request("engine","query-engine-info");this.engineInfo=e,this.showRestartInfo=compareEngineInfo(e,this.config)},methods:{async onConfirm(e){var i=e.target.getAttribute("path");let t=e.target.value;"javascript.builtin"===i?t=!this.config.javascript.builtin:"native.builtin"===i&&(t=!this.config.native.builtin),lodash.set(this.config,i,t),await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.`+i,t,this.types[i]),this.engineInfo&&(this.showRestartInfo=compareEngineInfo(this.engineInfo,this.config))},async refresh(e){var i=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.`+e,"local");this.types[e]=null!=i?"local":"global"},relaunch(){Editor.Message.send("engine","relaunch")},onChangePosition(e,i,t){Editor.Menu.popup({x:e,y:i,menu:[{label:Editor.I18n.t("preferences.menu.move_local"),enabled:"global"===this.types[t],click:async()=>{var e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.`+t);await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.`+t,e),await this.refresh(t),"javascript.builtin"===t&&(e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.custom`),await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.custom`,e),await this.refresh("javascript.custom"))}},{label:Editor.I18n.t("preferences.menu.move_global"),enabled:"local"===this.types[t],click:async()=>{var e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.`+t,"local");await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.`+t,e,"global"),await Editor.Profile.removeConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.`+t,this.types[t]),await this.refresh(t),"javascript.builtin"===t&&(e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.custom`,"local"),await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.custom`,e,"global"),await Editor.Profile.removeConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.custom`,this.types["javascript.custom"]),this.refresh("javascript.custom"))}}]})}},template:vueTemplate});async function ready(){panel=this,null!==vm&&void 0!==vm&&vm.$destroy(),(vm=new EnginePreferenceVM).$mount(panel.$.container)}function close(){null!==vm&&void 0!==vm&&vm.$destroy(),vm=null,panel=null}async function exportConfig(){var e={},i=Editor.App.version.replace(/\./g,"");let t="global";var n=await Editor.Message.request("preferences","query-config","engine","engine."+i,"local");return null!=n&&(t="local"),e["engine."+i]={type:t,value:await Editor.Message.request("preferences","query-config","engine","engine."+i)},e}async function importConfig(e){var i=Editor.App.version.replace(/\./g,"");e["engine."+i]&&await Editor.Message.request("preferences","set-config","engine","engine."+i,e["engine."+i].value,e["engine."+i].type)}function compareEngineInfo(e,i){try{var t="builtin"===e.typescript.type,n=e.typescript.path,o="builtin"===e.native.type,r=t!==i.javascript.builtin,a=o!==i.native.builtin,s=i.javascript.custom.startsWith("project://")?Editor.UI.__protected__.File.resolveToRaw(i.javascript.custom):i.javascript.custom;if(r||a||!t&&n!==s)return!0}catch(e){console.error(e)}return!1}exports.style=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"./engine.css"),"utf8"),exports.template='<div class="container"></div>',exports.$={container:".container"},exports.ready=ready,exports.close=close,exports.exportConfig=exportConfig,exports.importConfig=importConfig,exports.compareEngineInfo=compareEngineInfo;