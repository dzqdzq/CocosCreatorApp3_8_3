"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,i,t,n){void 0===n&&(n=t);var r=Object.getOwnPropertyDescriptor(i,t);r&&("get"in r?i.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return i[t]}}),Object.defineProperty(e,n,r)}:function(e,i,t,n){e[n=void 0===n?t:n]=i[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,i){Object.defineProperty(e,"default",{enumerable:!0,value:i})}:function(e,i){e.default=i}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var i={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(i,e,t);return __setModuleDefault(i,e),i};Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=exports.engineInfo=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),register_modules_1=require("../contributions/project/modules/register-modules"),register_macro_1=require("../contributions/project/register-macro"),utils_1=require("./utils"),engine_1=require("../contributions/preferences/engine"),electron_1=require("electron"),ElectronModule=require("@base/electron-module"),ipc=__importStar(require("@base/electron-base-ipc"));let errorDialog=!1;function queryEngine(e){var i={version:exports.engineInfo.typescript.type,path:exports.engineInfo.typescript.path,nativeVersion:exports.engineInfo.native.type,nativePath:exports.engineInfo.native.path,editor:Editor.App.path};return e&&e.reply(null,i),i}async function configBuiltinEngine(){var e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.builtin`,"local"),e=null!=e?"local":"global";await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.builtin`,!0,e)}function registerEngineI18n(e){try{(0,utils_1.registerI18n)(e),ElectronModule.register("EditorExtends",(0,path_1.join)(__dirname,"../editor-extends/index")),ElectronModule.register("Serialize",(0,path_1.join)(__dirname,"../editor-extends/utils/serialize/index"))}catch(e){console.error("Register engine I18n failed!"),console.error(e)}}async function handleOtherModules(e){try{var i=(await Promise.resolve().then(()=>__importStar(require("cc/preload"))))["default"];await i({root:e,editorExtensions:!1,requiredModules:["cc/editor/macro","cc/editor/populate-internal-constants"]}),await(0,register_macro_1.registerMacroConfig)(e),await(0,register_modules_1.initEngineModules)(e)}catch(e){let i="Load engine modules or register macro config failed!";return console.error(i),console.error(e),afterImportEngineError(i=e instanceof Error?e.stack||e.message:i)}exports.engineInfo.typescript.path=e}async function registerNative(){var e,i=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.native`);exports.engineInfo.native.builtin=(0,path_1.join)(exports.engineInfo.typescript.builtin,"native"),exports.engineInfo.typescript.custom&&(e=await getNormalizeCustomPath(),exports.engineInfo.native.custom=(0,path_1.join)(e,"native")),"custom"===exports.engineInfo.typescript.type?exports.engineInfo.native.type=i.builtin?"builtin":"custom":exports.engineInfo.native.type="builtin",exports.engineInfo.native.path=exports.engineInfo.native[exports.engineInfo.native.type],exports.engineInfo.typescript.path===Editor.App.args.engine&&(exports.engineInfo.native.path=(0,path_1.join)(exports.engineInfo.typescript.path,"native")),console.log("Register native engine in "+exports.engineInfo.native.path)}async function getNormalizeCustomPath(){let e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.custom`);var i;return e.startsWith("project://")&&(i=e.replace("project://",""),e=(0,path_1.join)(Editor.Project.path,i)),e}async function load(){if(Editor.Task.__protected__.removeSyncTask("startup.engine"),Editor.Task.__protected__.addSyncTask("build-engine",Editor.I18n.t("engine.compile_engine"),Editor.I18n.t("engine.wait_quick_compile")),"3d"!==Editor.Project.__protected__.type)await Editor.Dialog.error(Editor.I18n.t("engine.not_support")),Editor.App.quit(),process.exit(0);else{createSymlink();let t="",e=!0;var i=(0,path_1.join)(Editor.App.path,"../resources",Editor.Project.__protected__.type,"engine"),n=(exports.engineInfo.typescript.builtin=(0,path_1.normalize)(i),Editor.App.args.engine);if(!await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.builtin`)||n){n=n||await getNormalizeCustomPath();if((0,fs_extra_1.existsSync)(n)){var r=(0,fs_extra_1.existsSync)((0,path_1.join)(n,"bin",".cache","dev"))?"engine:compile-custom-engine-with-caching":"engine:compile-custom-engine-without-caching";try{Editor.Metrics.trackTimeStart(r),await(0,utils_1.compileEngine)(n,!0),exports.engineInfo.typescript.custom=(0,path_1.normalize)(n),exports.engineInfo.typescript.type="custom",t=exports.engineInfo.typescript.custom,e=!1,Editor.Metrics.trackTimeEnd(r,{output:!0,label:r+"-success"})}catch(e){t="";let i=Editor.I18n.t("engine.engine_compile_failed");if(console.error(i),console.error(e),e instanceof Error&&(i+=(e.stack,e.stack)),Editor.Metrics.trackTimeEnd(r,{output:!0,label:r+"-fail"}),0!==(await Editor.Dialog.error(i,{title:"Engine",buttons:[Editor.I18n.t("engine.confirm"),Editor.I18n.t("engine.load_builtin_engine_failed.exit_editor")],default:1,cancel:-1})).response)return Editor.App.quit(),void process.exit(0);await configBuiltinEngine()}}else{if(0!==(await Editor.Dialog.error(Editor.I18n.t("engine.engine_directory_illegal"),{title:"Engine",buttons:[Editor.I18n.t("engine.confirm"),Editor.I18n.t("engine.close")],default:1,cancel:-1})).response)return Editor.App.quit(),void process.exit(0);await configBuiltinEngine()}}if(e)try{Editor.Metrics.trackTimeStart("engine:compile-builtin-engine"),await(0,utils_1.compileEngine)(i),exports.engineInfo.typescript.type="builtin",t=exports.engineInfo.typescript.builtin,Editor.Metrics.trackTimeEnd("engine:compile-builtin-engine",{output:!0,label:"engine:compile-builtin-engine-success"})}catch(e){t="";let i=Editor.I18n.t("engine.engine_compile_crash");return console.error("Compile builtin engine failed!"),console.error(e),e instanceof Error&&(i+=(e.stack,e.stack)),Editor.Metrics.trackTimeEnd("engine:compile-builtin-engine",{output:!0,label:"engine:compile-builtin-engine-fail"}),await Editor.Dialog.error(i,{title:"Engine",buttons:[Editor.I18n.t("engine.load_builtin_engine_failed.exit_editor")]}),Editor.App.quit(),void process.exit(0)}if(!t)return afterImportEngineError();console.log("Load engine in "+t),registerEngineI18n(t),Editor.Task.__protected__.removeSyncTask("build-engine"),ipc.on("packages-engine:query-engine-info",queryEngine),await(0,utils_1.rebuildImportMaps)(),await handleOtherModules(t),await(0,utils_1.rebuildImportMaps)(),await registerNative(),await exports.methods.onPipelineConfigChange()}}function unload(){ipc.removeListener("packages-engine:query-engine-info",queryEngine)}function createSymlink(){var e=(0,path_1.join)(Editor.App.path,"../resources/3d/engine-native"),i=(0,path_1.join)(Editor.App.path,"../resources/3d/engine/native");if(!(0,fs_extra_1.existsSync)(e))try{(0,fs_extra_1.symlinkSync)(i,e,"junction")}catch(e){console.log("error",e)}}async function afterImportEngineError(e){if("custom"===exports.engineInfo.typescript.type){if(1===(await Editor.Dialog.error(Editor.I18n.t("engine.load_custom_engine_failed.title")+(e?"\n"+e:""),{buttons:[Editor.I18n.t("engine.load_custom_engine_failed.exit_editor"),Editor.I18n.t("engine.load_custom_engine_failed.restart_editor")],default:0,cancel:0})).response)return await configBuiltinEngine(),void exports.methods.relaunch()}else await Editor.Dialog.error(Editor.I18n.t("engine.load_builtin_engine_failed.title")+(e?"\n"+e:""),{buttons:[Editor.I18n.t("engine.load_builtin_engine_failed.exit_editor")],default:0,cancel:0});Editor.App.quit(),process.exit(0)}exports.engineInfo={typescript:{type:"builtin",custom:"",builtin:"",path:""},native:{type:"builtin",custom:"",builtin:"",path:""}},exports.methods={async rebuild(){await(0,utils_1.rebuild)()},async importEngineError(e){!1===errorDialog&&(errorDialog=!0,await afterImportEngineError(e))},async"query-info"(){return console.warn(Editor.I18n.t("engine.deprecatedTip",{oldName:"Message: engine(query-info)",newName:"Message: engine(query-engine-info)"})),queryEngine()},async"query-engine-info"(){return exports.engineInfo},relaunch(){process.send&&process.ppid?process.send({channel:"editor-restart"}):(electron_1.app.relaunch(),electron_1.app.exit(0))},async changeCustomEngineConfig(){var e=await Editor.Profile.getConfig("engine","engine."+Editor.App.version.replace(/\./g,""));await(0,engine_1.compareEngineInfo)(exports.engineInfo,e)&&(Editor.Task.addNotice({title:"Custom Engine",message:Editor.I18n.t("engine.preferences.custom_engine_change_info")}),Editor.Message.broadcast("engine:engine-info-changed"))},async onEngineModulesChanged(e,i){Editor.Message.broadcast("engine:engine-modules-config-changed",i),await(0,utils_1.rebuildImportMaps)()},onCustomMacroChanged(){Editor.Message.broadcast("engine:engine-custom-macro-changed")},onPhysics2DBox2dWasmChanged(){Editor.Message.broadcast("engine:modules-changed")},async onPipelineConfigChange(){try{await Editor.Profile.getConfig("engine","deferred_pipeline")||"5d45ba66-829a-46d3-948e-2ed3fa7ee421"===await Editor.Profile.getProject("project","general.renderPipeline")&&(await Editor.Profile.removeProject("project","general.renderPipeline","project"),Editor.Task.addNotice({title:Editor.I18n.t("engine.back_to_default_pipeline.title"),message:Editor.I18n.t("engine.back_to_default_pipeline.message")}),console.log(Editor.I18n.t("engine.back_to_default_pipeline.title")+" "+Editor.I18n.t("engine.back_to_default_pipeline.message")))}catch(e){console.debug(e)}},async"query-modules-config"(){return register_modules_1.moduleConfigCache}},exports.load=load,exports.unload=unload;