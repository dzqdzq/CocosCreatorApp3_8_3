"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreviewRangeRow=void 0;const vue_js_1=require("vue/dist/vue.js"),path_1=require("path"),lodash_1=require("lodash"),fs_extra_1=require("fs-extra"),animation_ctrl_1=require("../../share/animation-ctrl"),animation_editor_1=require("../../share/animation-editor"),global_data_1=require("../../share/global-data"),pop_menu_1=require("../../share/pop-menu"),utils_1=require("../../utils"),template=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"./../../../../static/template/components/preview-range-row.html"),"utf-8");function patchEmbeddedPlayer(e){var t=utils_1.EmbeddedPlayerMenuMap[e.playable.type],a=e.playable.path;return{...e,icon:t.icon,label:t.label,displayName:e.displayName,defaultDisplayName:a&&(0,path_1.basename)(a)||t.label}}exports.PreviewRangeRow=(0,vue_js_1.defineComponent)({name:"PreviewRangeRow",props:["trackInfo","selectPlayers","lock","index","offset","scroll","updatePosition"],data(){return{refreshTask:null,refreshTaskNumber:0,tips:"",selectEmbeddedPlayerKeys:[],selectInfos:[]}},computed:{previewStyle(){return{transform:`translateY(${this.index*animation_editor_1.animationEditor.LINE_HEIGHT-this.scroll.top}px)`,"pointer-events":"auto"}},previewClass(){let e="";return["content-item","preview-row",e=this.index%2==0?"dark":"light",this.lock?"lock":""]},displayEmbeddedPlayerInfo(){return this.trackInfo&&this.trackInfo.embeddedPlayers?this.trackInfo.embeddedPlayers.map(t=>{var e=this.selectInfos.find(e=>e.key===t.key);return patchEmbeddedPlayer(e||t)}):null}},watch:{selectPlayers(e,t){this.$set(this,"selectEmbeddedPlayerKeys",this.calcSelectKey(e))},updatePosition(){this.$set(this,"selectEmbeddedPlayerKeys",this.calcSelectKey(this.selectInfos))}},mounted(){},methods:{t(e,t="preview_row."){return Editor.I18n.t("animator."+t+e)},queryKeyStyle(e){return`transform: translateX(${e.x||0}px); width: ${e.width||20}px;`},onRangeMouseDown(e,t){2!==e.button&&animation_editor_1.animationEditor.onStartDragSuregion(e,t)},onDragOver(t){var a=(JSON.parse(JSON.stringify(Editor.UI.__protected__.DragArea.currentDragInfo))||{})["value"];if(a&&t.dataTransfer){let e;try{if(e=JSON.parse(a),!(0,lodash_1.isPlainObject)(e)||"string"!=typeof e.group)throw new Error(`unexpected embeddedPlayerInfo:"${a}"`)}catch(e){return Editor.App.dev&&console.debug(e),void(t.dataTransfer.dropEffect="none")}e.playable?.type!==this.trackInfo.type?t.dataTransfer.dropEffect="none":t.dataTransfer.dropEffect="move"}},onDragStart(e,t){var a=e.target.getAttribute("name");["left","right"].includes(a)||(global_data_1.Flags.startDragEmbeddedPlayerInfo.type="drop",e.target.style.cursor="grabbing",e.dataTransfer&&(a=e.target.parentNode,e.dataTransfer.setDragImage(a,0,0),e.dataTransfer.setData("value",JSON.stringify(t)),e.dataTransfer.effectAllowed="move"))},showRangePopMenu(e,t,a){var r=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onEmbeddedPlayerMenus);r.removeEmbeddedPlayer.click=()=>{a?animation_editor_1.animationEditor.deleteSelecteEmbeddedPlayers():animation_ctrl_1.animationCtrl.deleteEmbeddedPlayer(animation_editor_1.animationEditor.transEmbeddedPlayerInfoToDump(t,!1))},r.copyEmbeddedPlayer.click=()=>{animation_ctrl_1.animationCtrl.copyEmbeddedPlayerDump=[animation_editor_1.animationEditor.transEmbeddedPlayerInfoToDump(t,!1)]},Editor.Menu.popup({menu:Object.values(r)})},onDrop(e){animation_editor_1.animationEditor.onEmbeddedPlayerDrop(e,this.trackInfo.key)},async showContextMenu(e){global_data_1.Flags.mouseDownName="",await animation_editor_1.animationEditor.onEmbeddedPlayerContextMenu(e,this.trackInfo)},calcSelectKey(e){return e&&e.length?this.selectInfos=e.filter(e=>e.group===this.trackInfo.key):this.selectInfos=[],this.selectInfos.map(e=>e.key)}},template:template});