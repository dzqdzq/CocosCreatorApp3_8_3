"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.components=exports.computed=exports.watch=exports.data=exports.props=exports.template=void 0;const animation_ctrl_1=require("../../share/animation-ctrl"),animation_editor_1=require("../../share/animation-editor"),grid_ctrl_1=require("../../share/grid-ctrl"),global_data_1=require("../../share/global-data"),utils_1=require("../../utils"),pop_menu_1=require("../../share/pop-menu"),join=require("path")["join"],readFileSync=require("fs-extra")["readFileSync"];exports.template=readFileSync(join(__dirname,"./../../../../static/template/components/preview-row.html"),"utf-8");let KeyFrames=[];function data(){return{keyData:[],refreshTask:null,refreshTaskNumber:0,dbKeyClick:!1,tips:"",selectKey:null,combine:!1}}async function mounted(){var e=this;e.formatKey=getFormatKeyFunc(e.keyType),await e.refresh(),e.$set(e,"selectKey",e.calcSelectKey(e.selectInfo))}function getLineInfo(e,a){var t=Math.min(e,a);return{x:0|t,w:Math.max(e,a)-t}}function getFormatKeyFunc(e){return"image"===e?function(e,a){return{x:e.x,i:a,value:e.value}}:function(e,a){return{x:e.x,i:a}}}exports.props=["keyFrames","selectInfo","param","type","index","listIndex","scroll","lock","offset","updateFrame","updatePosition","updateSelect","hidden"],exports.data=data,exports.watch={async updateFrame(){const e=this;e.refreshTaskNumber++,e.display&&(cancelAnimationFrame(e.refreshTask),e.refreshTask=requestAnimationFrame(async()=>{await e.refresh()}))},updatePosition(){const e=this;e.refreshTaskNumber++,e.display&&(cancelAnimationFrame(e.refreshTask),e.refreshTask=requestAnimationFrame(async()=>{await e.refresh()}))},selectInfo(e,a){var t=this;t.$set(t,"selectKey",t.calcSelectKey(e))},updateSelect(){var e=this;e.$set(e,"selectKey",e.calcSelectKey(e.selectInfo))}},exports.computed={display(){return!0},previewStyle(){return{transform:`translateY(${this.offsetHeight}px)`,"pointer-events":"image"===this.keyType?"auto":"none"}},previewClass(){let e="";return["content-item","preview-row",e=this.index%2==0?"dark":"light",this.lock?"lock":""]},offsetHeight(){return this.listIndex*animation_editor_1.animationEditor.LINE_HEIGHT-(this.scroll?.top??0)},draggable(){var e=this;return"key"!==this.keyType||e.type&&e.type.extends&&e.type.extends.includes("cc.Asset")},keyType(){return this.type&&animation_editor_1.animationEditor.imageCCTypes.includes(this.type.value)?"image":"key"}},exports.components={},exports.methods={t(e,a="preview_row."){return Editor.I18n.t("animator."+a+e)},calcSelectKey(n){const i=this;if(!n||!n.keyFrames||!animation_ctrl_1.animationCtrl.clipsDump)return null;n=JSON.parse(JSON.stringify(n));const s=[];return n.keyFrames.forEach((a,e)=>{const t=n.keyFrames[e];if(t.nodePath===i.param[0]&&!s.some(e=>e.key===a.key))if("key"!==i.keyType&&(e=i.keyFrames.find(e=>e.frame===a.rawFrame))&&(a.value=e.value),i.param[1]){var e=i.param[1],r=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[i.param[0]][t.prop].partKeys;if(Array.isArray(r)&&r.includes(e)){const o=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[i.param[0]][e].keyFrames.find(e=>t.frame===e.frame);if(o&&o.prop===e){if(s.some(e=>e.key===o.key))return;s.push({frame:o.frame,rawFrame:o.frame,prop:o.prop,value:o.dump.value,key:o.key,x:a.x,nodePath:i.param[0]})}}else{r=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[i.param[0]][t.prop].parentPropKey;if("string"!=typeof r||r!==e)return e!==t.prop?null:void s.push(a);s.push(a)}}else s.push(a)}),Object.freeze(s)},async refresh(e){const t=this;if(t.refreshTaskNumber=0,!t.keyFrames||t.hidden)t.keyData=null;else if(t.keyFrames.length<1)t.keyData=null;else{KeyFrames=t.keyFrames;const r={},o=(KeyFrames.forEach((e,a)=>{r[e.frame]=t.formatKey(e,a)}),Object.values(r)),n=(o.sort((e,a)=>e.x-a.x),[o[0]]);var a;for(let e=0;e<o.length-1;e++)a=e,5<o[a+1].x-n[n.length-1].x&&n.push(o[a+1]);n.length!==o.length?t.combine=!0:t.combine=!1,t.keyData=Object.freeze(n.map(e=>e.i))}},calcSelectClass(e){var a=["active"];return e&&this.type?a.push("image"):a.push("key"),a},queryKeyStyle(e){return"image"===this.keyType?`transform: translateX(${0|e}px);`:`transform: translateX(${e-3|0}px) rotate(45deg);`},onDragLeave(e){this.tips="",this.draggable&&animation_editor_1.animationEditor.updateMouseFrame()},onDragOver(e){const a=this;if(a.draggable){const o=[];var{additional:t,value:r}=JSON.parse(JSON.stringify(Editor.UI.__protected__.DragArea.currentDragInfo))||{};t?t.forEach(e=>{e.type===a.type.value&&o.push(e.value)}):r&&!o.includes(r)&&o.push(r),o.length?(requestAnimationFrame(()=>{animation_editor_1.animationEditor.updateMouseFrame({x:e.x,y:e.y})}),a.tips=a.t("asset_position_tips"),e.preventDefault(),e.dataTransfer.dropEffect="copy"):a.tips=a.t("asset_type_should_be")+" "+a.type.value}},async onDrop(a){const t=this,r=(t.tips="",animation_editor_1.animationEditor.updateMouseFrame(),[]),o=[];var{additional:e,value:n,type:i}=JSON.parse(JSON.stringify(Editor.UI.__protected__.DragArea.currentDragInfo))||{};if(e&&e.forEach(e=>{e.type===t.type.value&&(o.push(e.value),r.push(e))}),n&&!o.includes(n)&&(o.push(n),r.push({type:i,value:n})),o.length){let e=grid_ctrl_1.gridCtrl.pageToFrame(a.x);var s=await animation_editor_1.animationEditor.getConfig("spacingFrame")||1,p=(r.sort((e,a)=>e.name>a.name?1:-1),[]);for(const c of r)if(c.type===t.type.value){if(-1===c.value.indexOf("@")){var m=await Editor.Message.request("asset-db","query-asset-info",c.value);if(!m){console.warn("Failed to create keyframe: Asset not found - "+c.value);continue}var l=Object.keys(m.subAssets);c.value=m.subAssets[l[0]].uuid}p.push({frame:e,value:{newValue:{uuid:c.value}},nodePath:t.param[0],prop:t.param[1]}),e+=s}animation_ctrl_1.animationCtrl.createKeyBatch(p)}},onRowMouseDown(e){this.selectInfo&&animation_editor_1.animationEditor.stickInfo&&2!==e.button&&animation_editor_1.animationEditor.stickInfo.left<e.offsetX&&animation_editor_1.animationEditor.stickInfo.width+animation_editor_1.animationEditor.stickInfo.left>e.offsetX&&(global_data_1.Flags.mouseDownName="stick",this.selectInfo.startX=e.x,this.selectInfo.offset=0,this.selectInfo.offsetFrame=0,global_data_1.Flags.startDragStickInfo={type:"center"},e.stopPropagation())},async onMouseDown(e,a){if(e.stopPropagation(),e.stopImmediatePropagation(),0===e.button){const n=this,i=JSON.parse(JSON.stringify(n.keyFrames[a])),s=(n.dbKeyClick?(n.draggable&&i.value&&Editor.Message.send("assets","twinkle",i.value),animation_editor_1.animationEditor.updateCurrentFrame(i.frame)):(n.dbKeyClick=!0,setTimeout(()=>{n.dbKeyClick=!1},300)),{nodePath:n.param[0],prop:i.prop,frame:i.frame});let t=n.selectInfo||{};var r,a=animation_editor_1.animationEditor.getPositionAtSelect(s),o=(0,utils_1.checkCtrlOrCommand)(e);if(n.selectInfo&&o&&-1===a)t.keyFrames.push({...s,...i,rawFrame:i.frame,key:(0,utils_1.calcKeyFrameKey)(i)});else{if(-1!==a&&o){const p=[];return n.type?p.push(s):n.keyFrames.forEach(e=>{e.frame===i.frame&&p.push({nodePath:n.param[0],prop:e.prop||n.param[1],frame:e.frame})}),void animation_editor_1.animationEditor.removeSelectKey(p)}-1===a&&(t={startX:e.x,offset:0,offsetFrame:0,nodePath:s.nodePath,prop:s.prop,keyFrames:[{...s,...i,rawFrame:i.frame,key:(0,utils_1.calcKeyFrameKey)(i)}],location:"node"})}n.type?(r=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[s.nodePath][s.prop].partKeys)&&r.forEach(e=>{var a=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[s.nodePath][e];a&&a.keyFrames.find(e=>e.frame===s.frame&&e.prop===i.prop)&&t.keyFrames.push({nodePath:n.param[0],prop:e,frame:i.frame,rawFrame:i.frame,x:i.x,key:(0,utils_1.calcKeyFrameKey)(i)})}):n.keyFrames.forEach(e=>{e.frame===i.frame&&e.prop!==i.prop&&t.keyFrames.push({nodePath:n.param[0],prop:e.prop||n.param[1],frame:e.frame,rawFrame:e.frame,x:e.x,key:(0,utils_1.calcKeyFrameKey)(e)})}),t.startX=e.x,t.sortDump&&-1!==a&&(t.offset=0,t.offsetFrame=0),t.location=n.param[1]?"prop":"node",animation_editor_1.animationEditor.startDragKey(t,o)}},onPopMenu(e){var a,t,r=this;r.lock||2!==e.button||"grid"===global_data_1.Flags.mouseDownName&&global_data_1.Flags.startDragGridInfo?.start!==e.x||(e.preventDefault(),global_data_1.Flags.mouseDownName="",global_data_1.Flags.startDragGridInfo=null,e.stopPropagation(),t=(a=e.target).getAttribute("name"),!r.type&&"key"!==t)||(e=(a=Number(a.getAttribute("index")))?r.keyFrames[a].frame:grid_ctrl_1.gridCtrl.pageToFrame(e.x),(t="number"==typeof a&&"key"===t?r.getKeyMenu(a):r.getPropContextMenu(e)).push({label:"frame: "+e,enabled:!1}),Editor.Menu.popup({menu:t}))},getKeyMenu(e){var a=this;let t=!1;var r=(0,pop_menu_1.getPopMenuMap)(a.type?pop_menu_1.onPropKeyMenus:pop_menu_1.onNodeKeyMenus,!1);const o={frame:a.keyFrames[e].frame,prop:a.param[1]||a.keyFrames[e].prop,nodePath:a.param[0]},n={nodePath:a.param[0],prop:o.prop},i=a.keyFrames[e]["frame"];let s=[i];if(a.selectInfo&&Array.isArray(a.selectInfo.keyFrames)){for(const l of a.selectInfo.keyFrames)if(l.frame===i){t=!0;break}t&&(s=a.selectInfo.keyFrames.map(e=>e.frame))}s=Array.from(new Set(s)),!a.type&&t&&1<s.length&&(r.spacingKeys.enabled=!0,r.spacingKeys.click=()=>{animation_editor_1.animationEditor.spacingSelectedKeys(animation_editor_1.animationEditor.spacingFrame)});const p=[],m=(a.type?(r.copyKey.enabled=!0,r.copyKey.click=()=>{animation_ctrl_1.animationCtrl.copyKey(t?void 0:Object.assign(n,{frame:s[0]}))},animation_editor_1.animationEditor.checkPropTypeInCopyKeyInfo(a.type)?(r.pasteKey.enabled=!0,r.pasteKey.click=()=>{animation_ctrl_1.animationCtrl.pasteKey({target:i,prop:n.prop,nodePath:n.nodePath})}):r.pasteKey.enabled=!1):a.keyFrames.forEach(e=>{s.includes(e.frame)&&p.push({prop:e.prop,nodePath:o.nodePath,frame:e.frame})}),p.length?p:n);return r.removeKey.enabled=!0,r.removeKey.click=()=>{animation_ctrl_1.animationCtrl.removeKey(t?void 0:Object.assign(m,{frame:s[0]}))},Object.values(r)},getPropContextMenu(e){const a=this,t={nodePath:a.param[0],prop:a.param[1]};var r=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onPropContextMenus,!1);return r.createKey={...pop_menu_1.popMenuMap.createKey,enabled:!0,click(){animation_ctrl_1.animationCtrl.createKey({frame:e,nodePath:a.param[0],prop:a.param[1]})}},animation_editor_1.animationEditor.checkPropTypeInCopyKeyInfo(a.type)&&(r.pasteKey.enabled=!0,r.pasteKey.click=()=>{animation_ctrl_1.animationCtrl.pasteKey({target:e,prop:t.prop,nodePath:t.nodePath})}),Object.values(r)}},exports.mounted=mounted;