"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var i=Object.getOwnPropertyDescriptor(t,a);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,i)}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.calcFrames=exports.animationEditor=exports.CurveColorList=void 0;const lodash_1=__importStar(require("lodash")),vue_js_1=__importDefault(require("vue/dist/vue.js")),utils_1=require("../utils"),animation_ctrl_1=require("./animation-ctrl"),bezier_presets_1=require("./bezier-presets"),clip_cache_1=require("./clip-cache"),global_data_1=require("./global-data"),grid_ctrl_1=require("./grid-ctrl"),ipc_event_1=require("./ipc-event"),pop_menu_1=require("./pop-menu"),defaultLayoutConfig=(exports.CurveColorList=["#AE2D47","#198F6B","#227F9B","#7979D7"],()=>({topMin:0,topMax:500,leftMin:100,leftMax:500,centerMin:0,centerMax:500,auxCurveMin:0,auxCurveMax:500,totalPec:100}));class AnimationEditor{constructor(){this.panel=null,this.LINE_HEIGHT=24,this.KEY_SIZE_R=Math.sqrt(14),this.imageCCTypes=["cc.SpriteFrame","cc.Texture2D","cc.TextureBase","cc.ImageAsset"],this.curveDisabledCCtypes=["Unknown","cc.Boolean","cc.Quat",...this.imageCCTypes],this.gridCtrl=grid_ctrl_1.gridCtrl,this.refreshTask=0,this.hasInitCurve=!1,this.hasInitCurvePreset=!1,this._spacingFrame=1,this._curveData=null,this.selectKeyUpdateFlag=!1,this.stickInfo={leftFrame:0,rightFrame:0,left:0,top:0,width:0,height:0},this.hasShowStick=!1,this.layoutConfig=defaultLayoutConfig(),this.debounceUpdateNode=(0,lodash_1.debounce)(this.updateNode,300),this.debounceFilterNode=(0,lodash_1.debounce)(this.FilterNode,300),this.debounceRefresh=(0,lodash_1.debounce)(this._refresh,300),this.aniPlayTask=0,this.updateSelectQueue=[],this.onMouseUp=t=>{if(["grid","pointer","time-pointer","resize","property","key","event","node","property-list-content","embeddedPlayer","aux-key"].includes(global_data_1.Flags.mouseDownName)||!exports.animationEditor.isLock){const r=exports.animationEditor.vm;var a;switch(t.target.style.cursor="default",global_data_1.Flags.onSelecting=!1,global_data_1.Flags.mouseDownName){case"key":exports.animationEditor.onKeyMouseUp(t,{target:grid_ctrl_1.gridCtrl.pageToFrame(t.x)});break;case"aux-key":this.onAuxKeyMouseup(t);break;case"embeddedPlayer":exports.animationEditor.onEmbeddedPlayerMouseUp(t);break;case"event":exports.animationEditor.onEventMouseUp(t);break;case"stick":exports.animationEditor.onStickMouseUp(t);break;case"resize":exports.animationEditor.onResizeMouseUp(t);break;case"time-pointer":{let e=grid_ctrl_1.gridCtrl.pageToFrame(t.x);e<0&&(e=0),2!==t.button?(r.currentFrame=e,a=(0,utils_1.frameToTime)(e,r.sample),(0,ipc_event_1.IsetCurEditTime)(a)):((a=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onTimerContextMenus,!0)).createEventKey.click=()=>{animation_ctrl_1.animationCtrl.addEvent(e),global_data_1.Flags.mouseDownName=""},a.pasteEventKey.enabled=!!animation_ctrl_1.animationCtrl.copyEventInfo,a.pasteEventKey.click=()=>{animation_ctrl_1.animationCtrl.pasteEvent(e),global_data_1.Flags.mouseDownName=""},Editor.Menu.popup({menu:Object.values(a)}))}break;case"property":r.boxInfo||exports.animationEditor.onPropTrackMenu(t.x,t.y);break;case"property-list-content":2===t.button&&((a=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onPropListContextMenus,!0)).pasteProp.enabled=!(!animation_ctrl_1.animationCtrl.copyPropInfo||!r.selectedId),a.pasteProp.click=()=>{animation_ctrl_1.animationCtrl.pasteNodeData(animation_ctrl_1.animationCtrl.nodesDump.uuid2path[r.selectedId],animation_ctrl_1.animationCtrl.getClipBoardData("prop"))},a.createProp.submenu=r.displayPropertiesMenu,a.createProp.enabled=!!r.selectedId&&!!r.displayPropertiesMenu.length&&!r.clipConfig?.isLock,Editor.Menu.popup({menu:Object.values(a)}));break;case"grid":2!==t.button&&setTimeout(()=>{global_data_1.Flags.mouseDownName="",global_data_1.Flags.startDragGridInfo=null},10)}r.boxInfo=null,r.boxStyle=null,r.boxData=null,global_data_1.Flags.mouseDownName="",global_data_1.Flags.startDragGridInfo=null,r.moveInfo=null}},this.onMouseMove=t=>{if((["grid","pointer","time-pointer","resize","event","key","property","node","embeddedPlayer","aux-key"].includes(global_data_1.Flags.mouseDownName)||!exports.animationEditor.isLock&&!global_data_1.Flags.onScrolling&&t.buttons)&&!exports.animationEditor.vm.maskPanel){const n=exports.animationEditor.vm;var a=t.target,{x:e,y:r}=t,i=n.$refs.gridCanvas.getBoundingClientRect();switch(global_data_1.Flags.mouseDownName&&(n.previewPointer=null),global_data_1.Flags.mouseDownName){case"key":exports.animationEditor.onKeyMouseMove(t);break;case"aux-key":this.onAuxKeyMouseMove(t);break;case"embeddedPlayer":exports.animationEditor.onEmbeddedPlayerMouseMove(t);break;case"event":exports.animationEditor.onEventMouseMove(t);break;case"stick":exports.animationEditor.onStickMouseMove(t);break;case"resize":exports.animationEditor.onResizeMouseMove(t);break;case"grid":case"property":case"node":{if(!global_data_1.Flags.startDragGridInfo)break;a.style.cursor="-webkit-grabbing";const o=e-global_data_1.Flags.startDragGridInfo.lastStart;if(0==o)return;global_data_1.Flags.mouseDownName="grid",global_data_1.Flags.startDragGridInfo.lastStart=e,requestAnimationFrame(()=>{exports.animationEditor.moveTimeLine(o)})}break;case"pointer":case"time-pointer":{a.style.cursor="ew-resize";let e=grid_ctrl_1.gridCtrl.pageToFrame(t.x);e<0&&(e=0),n.currentFrame=e,(0,ipc_event_1.IsetCurEditTime)((0,utils_1.frameToTime)(n.currentFrame,n.sample))}}if(!global_data_1.Flags.mouseDownName){if(e<i.x||e>i.x+i.width||r<i.y||r>i.y+i.height)return;a.style.cursor="";const s=grid_ctrl_1.gridCtrl.pageToCtrl(e,r),l=grid_ctrl_1.gridCtrl.pageToFrame(e);return l<0?void 0:n.previewPointer&&n.previewPointer.frame===l&&n.previewPointer.y===s.y?void 0:(global_data_1.Flags.previewPointerTask&&clearTimeout(global_data_1.Flags.previewPointerTask),s.y+=24,s.y<32&&(s.y=32),void requestAnimationFrame(()=>{n.previewPointer={frame:l,x:s.x-grid_ctrl_1.gridCtrl.startOffset,y:s.y},global_data_1.Flags.previewPointerTask=setTimeout(()=>{n.previewPointer=null},1e3)}))}["node","property"].includes(global_data_1.Flags.mouseDownName)&&0===t.button&&(global_data_1.Flags.onSelecting=!0,exports.animationEditor.isLock||requestAnimationFrame(()=>{n.boxInfo&&(n.boxInfo.x=t.x,n.boxInfo.y=t.y,n.boxStyle=exports.animationEditor.calcBoxStyle())}))}}}get spacingFrame(){return this._spacingFrame}set spacingFrame(e){this._spacingFrame=e,this.changeSpacingFrame(e)}get isLock(){return!this.vm||!(this.vm&&this.vm.animationMode&&!this.vm.lock&&!this.vm.maskPanel)}reset(){this.refreshTask=0,this.hasInitCurve=!1,this.selectKeyUpdateFlag=!1,this.stickInfo={leftFrame:0,rightFrame:0,left:0,top:0,width:0,height:0},this._spacingFrame=1,this.hasShowStick=!1,this.layoutConfig=defaultLayoutConfig(),this.aniPlayTask=0,this.updateSelectQueue=[]}setConfig(e,t){Editor.Profile.setConfig("animator",e,t,"global")}async getConfig(e){return Editor.Profile.getConfig("animator",e)}async init(e){this.vm=e;e=await exports.animationEditor.getConfig("spacingFrame");this._spacingFrame=e||1,(0,utils_1.addEventListenerOnce)(document,"mouseup",this.onMouseUp),(0,utils_1.addEventListenerOnce)(document,"mousemove",this.onMouseMove)}async vmInit(){const e=this.vm;e.$refs.chart.style.width=e.$refs.right.offsetWidth+"px";var t=await this.getConfig("showType");grid_ctrl_1.gridCtrl.init({$canvas:e.$refs.gridCanvas,$left:e.$refs.left,$right:e.$refs.right,$xAxis:e.$refs.xAxis,showType:t,minScale:5,maxScale:100}),this.updateLayoutConfig(),e.offset=e.$refs.left.offsetWidth,requestAnimationFrame(()=>{grid_ctrl_1.gridCtrl.grid.resize(),this.renderTimeAxis(),this.setCurrentFrame(e.currentFrame),this.initCurve(),e.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset})}configureCurveEditor(e){e.setConfig({xRange:[0,1/0],yRange:[-1/0,1/0],showPreWrapMode:!1,showPostWrapMode:!1,precisionX:0,precisionY:3,showXLabel:!1,showYLabel:!0,axisMargin:0,showYLine:!0,showXLine:!1,startXOffset:10,handlerSize:60,gridColor:"#333846",spacingFrame:this.spacingFrame,sample:this.vm.sample,xAxisName:"time",yAxisName:"value"}),grid_ctrl_1.gridCtrl.grid&&e.curveCtrl?.grid?(0,grid_ctrl_1.syncAxisX)(grid_ctrl_1.gridCtrl.grid,e.curveCtrl.grid):(e.curveCtrl.grid.xAxisScale=20,e.curveCtrl.grid.xAxisOffset=10),e.curveCtrl.grid.yAxisScale=10}initCurve(){var{width:e,height:t}=this.vm.$refs["property-content"].getBoundingClientRect();if(this.vm.$refs.curve.curveCtrl&&this.vm.$refs.curve.curveCtrl.canvas.width&&this.vm.$refs.curve.curveCtrl.canvas.height||(this.vm.$refs.curve.resize(e,t),this.configureCurveEditor(this.vm.$refs.curve.editor)),exports.animationEditor.hasInitCurve||(this.vm.$refs.curve.curveCtrl.getCopyKeys=()=>{var e=animation_ctrl_1.animationCtrl.copyKeyInfo;if(!e)return[];const t=[];return e.curvesDump.forEach(e=>{t.push({key:e.key,keys:e.keyframes.map(e=>(0,utils_1.mockDumpToCtrl)(e))})}),t},this.vm.$refs.curve.curveCtrl.on("operate",this.onCurveOperate.bind(this)),exports.animationEditor.hasInitCurve=!0),!this.hasInitCurvePreset){for(const o of bezier_presets_1.defaultBezier.value){var{p1:a,p2:r,p3:i,p4:n}=(0,bezier_presets_1.transformBezierDataToPoint)(o.data);vue_js_1.default.set(o,"svgData",`M${a[0]} ${a[1]} C ${r[0]} ${r[1]}, ${i[0]} ${i[1]}, ${n[0]} `+n[1])}this.hasInitCurvePreset=!0}}getEmbeddedPlayerMenu(e){const t=e||{};return Object.values(utils_1.EmbeddedPlayerMenuMap).map(e=>({label:e.label,click:()=>{this.addEmbeddedPlayerGroup({...t,playable:e.value})}}))}onEmbeddedPlayerTrackMenu(e,t){var a=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onEmbeddedPlayerTrackMenu);a.clearEmbeddedPlayer.click=()=>{this.clearEmbeddedPlayerGroup(t.key),this.unSelectEmbeddedPlayerInfo(t.embeddedPlayers)},a.removeEmbeddedPlayerGroup.click=()=>{this.removeEmbeddedPlayerGroup(t.key),this.unSelectEmbeddedPlayerInfo(t.embeddedPlayers)},Editor.Menu.popup({menu:Object.values(a)})}onEmbeddedPlayerContextMenu(e,t){var a=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onEmbeddedPlayerContextMenu);const r=grid_ctrl_1.gridCtrl.pageToFrame(e.x);a.createEmbeddedPlayer.label=this.vm.t(pop_menu_1.popMenuMap.createEmbeddedPlayer.label,{player:this.vm.t(t.menuInfo.label)}),a.createEmbeddedPlayer.click=()=>{this.addEmbeddedPlayer({begin:r,end:r+5,playable:{type:t.type},group:t.key})},a.clearEmbeddedPlayer.click=()=>{this.clearEmbeddedPlayerGroup(t.key)};let i=animation_ctrl_1.animationCtrl.getClipBoardData("embeddedPlayer")||[];i=i.filter(e=>e.playable.type===t.type),a.pasteEmbeddedPlayer.enabled=!!i.length,a.pasteEmbeddedPlayer.click=()=>{animation_ctrl_1.animationCtrl.pasteEmbeddedPlayer(r,i,t.key)},Editor.Menu.popup({menu:Object.values(a)})}async clearEmbeddedPlayerGroup(e){await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.clearEmbeddedPlayerGroup)(this.vm.currentClip,e))}async removeEmbeddedPlayerGroup(e){await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.removeEmbeddedPlayerGroup)(this.vm.currentClip,e))}async addEmbeddedPlayerGroup(e){var t={begin:this.vm.currentFrame,end:this.vm.currentFrame+5,reconciledSpeed:!1,playable:{type:"animation-clip"},group:""},e=(e&&Object.assign(t,e),[]),t={key:String(Date.now()),name:t.playable.type,type:t.playable.type,embeddedPlayers:[],menuInfo:utils_1.EmbeddedPlayerMenuMap[t.playable.type]};e.push((0,ipc_event_1.addEmbeddedPlayerGroup)(this.vm.currentClip,{key:t.key,name:t.name,type:t.type})),await(0,ipc_event_1.IApplyOperation)(e)}async addEmbeddedPlayer(e){var t={begin:this.vm.currentFrame,end:this.vm.currentFrame+5,reconciledSpeed:!1,playable:{type:"animation-clip"},group:""};e&&Object.assign(t,e);let a=this.findGroupCanAdd(t);e=[];a||(a={key:String(Date.now()),name:t.playable.type,type:t.playable.type,embeddedPlayers:[],menuInfo:utils_1.EmbeddedPlayerMenuMap[t.playable.type]},e.push((0,ipc_event_1.addEmbeddedPlayerGroup)(this.vm.currentClip,{key:a.key,name:a.name,type:a.type})),this.vm.embeddedPlayerGroups.push(a)),a.embeddedPlayers.push(this.transEmbeddedPlayerDumpToInfo(t)),t.group=a.key,e.push((0,ipc_event_1.addEmbeddedPlayer)(this.vm.currentClip,t)),await(0,ipc_event_1.IApplyOperation)(e),(0,utils_1.multiplyTrackWithTimer)("hippoAnimator",{A100002:1,project_id:Editor.Project.uuid,clip_id:this.vm.currentClip,version:Editor.App.version})}findGroupCanAdd(t){if(""!==t.group){var e=this.vm.embeddedPlayerGroups.find(e=>e.key===t.group);if(e&&!e.embeddedPlayers.find(e=>!(e.end<t.begin||t.end<e.begin)))return e}else for(const r of this.vm.embeddedPlayerGroups)if(r.type===t.playable.type){var a=r.embeddedPlayers.find(e=>Math.max(e.begin,t.begin)<Math.min(e.end,t.end));if(!a)return r}return null}changeToEmbeddedPlayerMode(){this.vm.$refs.nodes.scrollTop=this.vm.nodeScrollInfo.top=0,exports.animationEditor.calcDisplayClips()}changeToKeyFrameMode(){this.vm.$refs.nodes.scrollTop=this.vm.nodeScrollInfo.top=0,exports.animationEditor.calcDisplayClips()}renderTimeAxis(){let e=1,t=e*(animation_ctrl_1.animationCtrl.clipConfig.sample||60);for(var a=[],r=this.vm.$refs.container.clientWidth,i=e=>this.gridCtrl.frameToCanvas(e)-10+this.vm.offset;Editor.Utils.Math.clamp(i(t),0,r)===i(t);){var n=this.gridCtrl.frameToCanvas(t);a.push({value:Math.floor(t/(animation_ctrl_1.animationCtrl.clipConfig.sample||60)),x:n}),e++,t=e*(animation_ctrl_1.animationCtrl.clipConfig.sample||60)}this.vm.timeInfos=a,this.vm.scale=(0,lodash_1.clamp)(grid_ctrl_1.gridCtrl.grid.xAxisScale,grid_ctrl_1.gridCtrl.grid.xMinScale,grid_ctrl_1.gridCtrl.grid.xMaxScale)}onCurveOperate(e,t,a){if(this.vm.hasSelectedCurveClip=!1,"unselect"!==e&&this.vm.selectProperty){if(t){const{nodePath:o,type:s}=this.vm.selectProperty;switch(e){case"select":{const l={keyFrames:[],nodePath:o,prop:this.vm.selectProperty.prop,location:"prop"};t.forEach(a=>{var e=(0,utils_1.transformCtrlKeyToDump)(a.keys,s);const r=a.key;l.keyFrames.push(...e.map((e,t)=>{t={x:a.keys[t].key.canvas.x-grid_ctrl_1.gridCtrl.grid.xAxisOffset,frame:e.frame,rawFrame:e.frame,prop:r,nodePath:this.vm.computeSelectPath};return{...t,key:(0,utils_1.calcKeyFrameKey)(t)}}))}),this.selectKeyUpdateFlag=!1,this.vm.selectKeyInfo=l,this.vm.updateSelectKey++}break;case"db-select":var r=t[0].keys,r=(0,utils_1.transformCtrlKeyToDump)(r,s);this.updateCurrentFrame(r[0].frame);break;case"select-curve":this.vm.lightCurve={name:t[0].key,color:this.vm.properties[t[0].key].color};break;case"select-curve-clip":this.vm.lightCurve={name:t[0].key,color:this.vm.properties[t[0].key].color},this.vm.hasSelectedCurveClip=!0;break;case"apply-bezier":this.vm.hasSelectedCurveClip=!0;var i=[];for(const m of t){const d=m.key;var n=(0,utils_1.transformCtrlKeyToDump)(m.keys,s).map(e=>(0,ipc_event_1.ImodifyCurveOfKey)(this.vm.currentClip,o,d,e.frame,{inTangent:e.inTangent,outTangent:e.outTangent,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight,interpMode:e.interpMode,tangentWeightMode:e.tangentWeightMode}));i.push(...n)}(0,ipc_event_1.IApplyOperation)(i);break;case"scale-keys":case"move-keys":{const c=[],p=[],u={nodePath:this.vm.computeSelectPath,keyFrames:[],location:"prop",prop:this.vm.selectProperty.prop};t.forEach(i=>{var e=i.keys;const n=(0,utils_1.transformCtrlKeyToDump)(e,s);e.forEach((e,t)=>{var a=Math.round(e.key.point.x-e.raw.point.x),r={x:grid_ctrl_1.gridCtrl.grid.valueToPixelH(n[t].frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,frame:n[t].frame,prop:i.key,rawFrame:Math.round(e.raw.point.x),nodePath:this.vm.computeSelectPath,offsetFrame:a},r=(u.keyFrames.push({...r,key:(0,utils_1.calcKeyFrameKey)(r)}),Math.round(e.key.point.y-e.raw.point.y));(a||r)&&(a&&c.push((0,ipc_event_1.ImoveKeys)(this.vm.currentClip,o,i.key,[Math.round(e.raw.point.x)],a)),p.push((0,ipc_event_1.IcreateKey)(this.vm.currentClip,o,i.key,n[t].frame,{newValue:e.key.point.y,inTangent:e.key.inTangent,outTangent:e.key.outTangent})))})}),(0,ipc_event_1.IApplyOperation)([...c,...p]),this.selectKeyUpdateFlag=!1,this.vm.selectKeyInfo=u}break;case"tangent":{const h=t[0].key;r=(0,utils_1.transformCtrlKeyToDump)(t[0].keys,s).map(e=>(0,ipc_event_1.ImodifyCurveOfKey)(this.vm.currentClip,o,h,e.frame,{inTangent:e.inTangent,broken:e.broken,outTangent:e.outTangent,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight}));(0,ipc_event_1.IApplyOperation)(r)}break;case"change-broken-state":{const f=t[0].key;r=(0,utils_1.transformCtrlKeyToDump)(t[0].keys,s).map(e=>(0,ipc_event_1.ImodifyCurveOfKey)(this.vm.currentClip,o,f,e.frame,{broken:e.broken}));(0,ipc_event_1.IApplyOperation)(r)}break;case"create-keys":{const _=[];t.forEach(a=>{var e=a.keys;const r=(0,utils_1.transformCtrlKeyToDump)(e,s);r.forEach((e,t)=>{_.push((0,ipc_event_1.IcreateKey)(this.vm.currentClip,o,a.key,r[t].frame,{inTangent:e.inTangent,outTangent:e.outTangent,newValue:e.dump.value,interpMode:e.interpMode,tangentWeightMode:e.tangentWeightMode,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight}))})}),(0,ipc_event_1.IApplyOperation)(_)}break;case"change-interp-mode":{const y=[];t.forEach(t=>{var e=t.keys,e=(0,utils_1.transformCtrlKeyToDump)(e,s);y.push(...e.map(e=>(0,ipc_event_1.ImodifyCurveOfKey)(this.vm.currentClip,o,t.key,e.frame,{inTangent:e.inTangent,outTangent:e.outTangent,interpMode:e.interpMode})))}),(0,ipc_event_1.IApplyOperation)(y)}break;case"change-tangent-weight":{const g=[];t.forEach(t=>{var e=t.keys,e=(0,utils_1.transformCtrlKeyToDump)(e,s);g.push(...e.map(e=>(0,ipc_event_1.ImodifyCurveOfKey)(this.vm.currentClip,o,t.key,e.frame,{tangentWeightMode:e.tangentWeightMode,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight})))}),(0,ipc_event_1.IApplyOperation)(g)}break;case"remove-keys":{const v=[];t.forEach(t=>{var e=t.keys,e=(0,utils_1.transformCtrlKeyToDump)(e,s);v.push(...e.map(e=>(0,ipc_event_1.IremoveKey)(this.vm.currentClip,o,t.key,e.frame)))}),(0,ipc_event_1.IApplyOperation)(v),this.selectKeyUpdateFlag=!1,this.vm.selectKeyInfo=null}break;case"move-curve":{const C=[];t.forEach(t=>{var e=t.keys,e=(0,utils_1.transformCtrlKeyToDump)(e,s);C.push(...e.map(e=>(0,ipc_event_1.IcreateKey)(this.vm.currentClip,o,t.key,e.frame,{newValue:e.dump.value})))}),(0,ipc_event_1.IApplyOperation)(C)}break;case"paste":animation_ctrl_1.animationCtrl.pasteKey({target:a,nodePath:o},animation_ctrl_1.animationCtrl.getClipBoardData("key"));break;case"copy":{const b=[],I=[];t.forEach(e=>{var t=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[o][e.key],a=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[o][t.parentPropKey],r=e.keys,r=(0,utils_1.transformCtrlKeyToDump)(r,s);b.push({nodePath:o,key:e.key,type:t.type,displayName:t.displayName,keyframes:r,_parentType:a&&a.type,preExtrap:t.preExtrap,postExtrap:t.postExtrap,isCurveSupport:t.isCurveSupport}),I.push(r[0].frame)}),animation_ctrl_1.animationCtrl.copyKeyInfo={curvesDump:b,leftFrame:I.sort((e,t)=>e-t)[0]}}}}}else this.vm.selectKeyInfo=null,this.vm.lightCurve=null}FilterNode(e){this.vm.filterName=e,this.calcDisplayNodes()}checkCurveDataDirty(e){var t;return this._curveData?(t=JSON.stringify(this._curveData)!==JSON.stringify(e),this._curveData=e,t):(this._curveData=e,!0)}updateCurveSelecteKeys(){var e;this.vm.showAnimCurve&&(this.vm.selectKeyInfo?(e=this.vm.selectKeyInfo.sortDump||(0,utils_1.sortKeysToTreeMap)(this.vm.selectKeyInfo.keyFrames),e=Object.values(e).map(e=>({key:e.prop,frames:e.keyFrames.map(e=>e.frame)})),this.vm.$refs.curve.curveCtrl.selectKeys(e)):this.vm.$refs.curve.curveCtrl.selectKeys(null))}repaintCurve(e){if(this.vm){try{this.vm.showAnimCurve&&this.vm.$refs.curve.curveCtrl&&this.vm.$refs.curve.paint(e),this._curveData=e}catch(e){console.error(e)}this.selectKeyUpdateFlag&&(this.updateCurveSelecteKeys(),this.selectKeyUpdateFlag=!1)}}updateLayoutConfig(){var e=this.vm.$el.getBoundingClientRect();this.layoutConfig.topMax=e.top+this.panel.clientHeight-133,this.layoutConfig.leftMax=e.left+this.panel.clientWidth-100,this.layoutConfig.totalPec=100*(this.vm.$refs.container.offsetHeight-90)/this.vm.$refs.container.offsetHeight}updateSample(e){this.vm&&this.vm.showAnimCurve&&(this.vm.$refs.curve.sample=e)}hideNodes(){this.vm.$refs.nodes.style.height="24px",this.vm.$refs.nodes.style.flex="unset",this.vm.$refs["node-content"].style.height="24px",this.vm.$refs["node-content"].style.flex="unset"}showToast(e,t=1e3){this.vm.toast.message=e,global_data_1.Flags.tipsTimer&&clearTimeout(global_data_1.Flags.tipsTimer),global_data_1.Flags.tipsTimer=setTimeout(()=>{this.vm.toast.message=""},t)}changeSpacingFrame(e){this.setConfig("spacingFrame",e),this.vm.$refs.curve.curveCtrl&&(this.vm.$refs.curve.curveCtrl.config.spacingFrame=e)}updatePositionInfo(e){var t=this.vm;if(t.updatePosition++,t.previewPointer&&(t.previewPointer=null),t.nodeDump&&animation_ctrl_1.animationCtrl.clipsDump&&(t.nodeDump.forEach(e=>{e.keyFrames=Object.freeze(this.calcNodeFrames(e.path))}),t.properties&&(t.properties=this.calcProperty()),this.calcAuxiliaryCurves(),t.updateKeyFrame++),exports.animationEditor.calcDisplayEmbeddedPlayers(),"move"!==e){if(t.selectKeyInfo){for(const a of t.selectKeyInfo.keyFrames)a&&(a.x=grid_ctrl_1.gridCtrl.frameToCanvas(a.frame));t.updateSelectKey++}if(animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.clipsDump.events&&this.calcEventsDump(),t.selectEventInfo)for(const r of t.selectEventInfo.data)r&&(r.x=grid_ctrl_1.gridCtrl.frameToCanvas(r.frame));if(t.selectEmbeddedPlayerInfo)for(const i of t.selectEmbeddedPlayerInfo)i&&(i.x=grid_ctrl_1.gridCtrl.frameToCanvas(i.rawInfo.begin),i.width=grid_ctrl_1.gridCtrl.frameToCanvas(i.rawInfo.end)-i.x)}}resetSelectedKeyInfo(){var e=this.vm;if(e.selectKeyInfo){const a=JSON.parse(JSON.stringify(e.selectKeyInfo));a.offsetFrame=0,a.offset=0,delete a.sortDump,a.keyFrames.forEach((e,t)=>{a.keyFrames[t].frame=e.frame,delete a.keyFrames[t].offsetFrame}),a.sortDump=(0,utils_1.sortKeysToTreeMap)(a.keyFrames),a.keyFrames.sort((e,t)=>e.frame-t.frame),e.selectKeyInfo=a}}clearSelectData(){this.vm.selectEventInfo||this.vm.selectKeyInfo?(this.vm.selectEventInfo=null,this.vm.selectKeyInfo=null):(this.vm.selectProperty&&(this.vm.selectProperty=null),this.vm.selectEmbeddedPlayerInfo&&(this.vm.selectEmbeddedPlayerInfo=null,Editor.Selection.unselect("animation-embeddedPlayer",Editor.Selection.getSelected("animation-embeddedPlayer"))))}copy(){if(this.isLock)return this.vm.selectEventInfo&&!this.vm.maskPanel?void animation_ctrl_1.animationCtrl.copyEvents():this.vm.selectEmbeddedPlayerInfo?void(animation_ctrl_1.animationCtrl.copyEmbeddedPlayerDump=this.vm.selectEmbeddedPlayerInfo.map(e=>this.transEmbeddedPlayerInfoToDump(e,!1))):void 0;this.vm.selectKeyInfo?animation_ctrl_1.animationCtrl.copyKey():this.vm.selectEmbeddedPlayerInfo?animation_ctrl_1.animationCtrl.copyEmbeddedPlayerDump=this.vm.selectEmbeddedPlayerInfo.map(e=>this.transEmbeddedPlayerInfoToDump(e,!1)):this.vm.selectEventInfo?animation_ctrl_1.animationCtrl.copyEvents():this.vm.selectProperty?animation_ctrl_1.animationCtrl.copyProp(this.vm.selectProperty):this.vm.selectedId&&animation_ctrl_1.animationCtrl.copyNodeData([animation_ctrl_1.animationCtrl.nodesDump.uuid2path[this.vm.selectedId]])}paste(){if(this.isLock)return animation_ctrl_1.animationCtrl.copyEventInfo&&this.vm.animationMode&&!this.vm.maskPanel?void animation_ctrl_1.animationCtrl.pasteEvent(this.vm.currentFrame,animation_ctrl_1.animationCtrl.getClipBoardData("event")):void(animation_ctrl_1.animationCtrl.copyEmbeddedPlayerDump&&animation_ctrl_1.animationCtrl.pasteEmbeddedPlayer(this.vm.currentFrame,animation_ctrl_1.animationCtrl.getClipBoardData("embeddedPlayer")));animation_ctrl_1.animationCtrl.copyKeyInfo?animation_ctrl_1.animationCtrl.pasteKey({target:this.vm.currentFrame,nodePath:this.vm.computeSelectPath},animation_ctrl_1.animationCtrl.getClipBoardData("key")):(animation_ctrl_1.animationCtrl.copyEmbeddedPlayerDump&&animation_ctrl_1.animationCtrl.pasteEmbeddedPlayer(this.vm.currentFrame,animation_ctrl_1.animationCtrl.getClipBoardData("embeddedPlayer")),animation_ctrl_1.animationCtrl.copyEventInfo?animation_ctrl_1.animationCtrl.pasteEvent(this.vm.currentFrame,animation_ctrl_1.animationCtrl.getClipBoardData("event")):this.vm.selectProperty&&animation_ctrl_1.animationCtrl.copyPropInfo?animation_ctrl_1.animationCtrl.pasteProp(this.vm.selectProperty,animation_ctrl_1.animationCtrl.getClipBoardData("prop")):this.vm.selectedId&&animation_ctrl_1.animationCtrl.pasteNodeData(animation_ctrl_1.animationCtrl.nodesDump.uuid2path[this.vm.selectedId],animation_ctrl_1.animationCtrl.getClipBoardData("node")||animation_ctrl_1.animationCtrl.getClipBoardData("prop")))}updateSelectKey(e){var t=this.vm;if(t.selectKeyInfo||e){const s=JSON.parse(JSON.stringify(t.selectKeyInfo||e));if(!s.sortDump){if(!e.nodePath)return;s.sortDump={}}var{nodePath:r,prop:i}=e,n=r+i;if((s.sortDump[n]||e.keyFrames.length)&&i){var o=e.keyFrames.map(e=>e.frame)||[];s.sortDump[n]={keyFrames:e.keyFrames,prop:i,nodePath:r,frames:o},e.keyFrames.length||delete s.sortDump[n];let a=[];Object.keys(s.sortDump).map(e=>{var t=s.sortDump[e];t.keyFrames.length||delete s.sortDump[e],a=a.concat(t.keyFrames)}),s.keyFrames=a.sort((e,t)=>e.frame-t.frame),t.selectKeyInfo=s}}}getPositionAtSelect(t){return this.vm.selectKeyInfo?this.vm.selectKeyInfo.keyFrames.findIndex(e=>e.prop===t.prop&&e.frame===t.frame&&e.nodePath===t.nodePath):-1}removeSelectKey(a){if(!this.vm.selectKeyInfo||!this.vm.selectKeyInfo.keyFrames)return!1;const r=JSON.parse(JSON.stringify(this.vm.selectKeyInfo));return this.vm.selectKeyInfo.keyFrames.forEach((t,e)=>{a.find(e=>lodash_1.default.isEqual(t,e))&&(r.keyFrames.splice(e,1),r.keyFrames.splice(e,1))}),delete r.sortDump,this.vm.selectKeyInfo=r,!0}async deleteSelecteEmbeddedPlayers(){if(!this.vm.selectEmbeddedPlayerInfo)return!1;const t=[];return this.vm.selectEmbeddedPlayerInfo.forEach(e=>{t.push((0,ipc_event_1.deleteEmbeddedPlayer)(this.vm.currentClip,this.transEmbeddedPlayerInfoToDump(e,!1)))}),this.vm.selectEmbeddedPlayerInfo=null,Editor.Selection.unselect("animation-embeddedPlayer",Editor.Selection.getSelected("animation-embeddedPlayer")),(0,ipc_event_1.IApplyOperation)(t)}openEventEditor(e){this.vm.editEventFrame=e,this.vm.maskPanel="event"}closeMaskPanel(){this.vm.maskPanel=""}setMovePath(e){this.vm.moveNodePath=e}cancelMoveNode(){this.vm.moveNodePath=""}selectNode(e,t=!1){var a,r,i;animation_ctrl_1.animationCtrl.nodesDump&&(a=this.vm,(r=animation_ctrl_1.animationCtrl.nodesDump.path2uuid[e])?((i=[r[0]])[0]!==a.selectedId&&t&&i.push(a.selectedId),a.selectedId=r[0],a.selectPath="",Editor.Selection.update("node",i)):(a.selectPath=e,a.properties=this.calcProperty(),a.selectedId="",a.selectedIds.clear()))}startMoveNode(e){this.vm.moveNodePath=e}startDragKey(e,t=!1){var a,r,i;animation_ctrl_1.animationCtrl.nodesDump&&animation_ctrl_1.animationCtrl.clipsDump&&(a=this.vm,e&&(e.keyFrames.sort((e,t)=>e.frame-t.frame),e.sortDump=(0,utils_1.sortKeysToTreeMap)(e.keyFrames),(r=e.keyFrames[0]).nodePath!==a.computeSelectPath&&(i=animation_ctrl_1.animationCtrl.nodesDump.path2uuid[r.nodePath])[0]!==a.selectedId&&(Editor.Selection.unselect("node",a.selectedId),Editor.Selection.select("node",i[0]),a.selectedId=i[0]),this.vm.selectProperty&&this.vm.selectProperty.prop===r.prop&&this.vm.selectProperty.nodePath===r.nodePath||(i=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[r.nodePath][r.prop],exports.animationEditor.updateSelectProperty({nodePath:r.nodePath,prop:r.prop,clipUuid:animation_ctrl_1.animationCtrl.clipsDump.uuid,isCurveSupport:i.isCurveSupport}),this.selectKeyUpdateFlag=!0)),a.selectKeyInfo=e,a.updateSelectKey++,t||(global_data_1.Flags.mouseDownName="key"))}async updateSelectProperty(e){var t,a=this.vm;e.clipUuid===this.vm.currentClip&&e.nodePath===this.vm.computeSelectPath&&(t=await(0,ipc_event_1.IgetPropValueAtFrame)(e.clipUuid,e.nodePath,e.prop,a.currentFrame))&&(a.selectProperty=Object.assign(e,{dump:t,type:{value:t.type,extends:t.extends}}),a.lightCurve=null)}startDragEvent(e,t=!1){this.vm.selectEventInfo=e,t?"event"===global_data_1.Flags.mouseDownName&&(global_data_1.Flags.mouseDownName=""):global_data_1.Flags.mouseDownName="event"}updateMouseFrame(e,t){var a,r=this.vm;e&&(e.x||e.y)?(a=grid_ctrl_1.gridCtrl.pageToCtrl(e.x,e.y),e=e.frame||grid_ctrl_1.gridCtrl.pageToFrame(e.x),r.moveInfo?(r.moveInfo.frame=e,r.moveInfo.x=a.x+5,r.moveInfo.y=a.y+5,r.moveInfo.offsetFrame=t||0):r.moveInfo={frame:e,x:a.x+5,y:a.y+5,offsetFrame:t||0}):r.moveInfo=null}updatePropExpandState(e,t){const a=this.vm;a.expandInfo[e]=t;var r=a.properties[e].partKeys;r?(r.forEach(e=>{a.properties[e].hidden=!t}),a.properties=this.calcProperty(),requestAnimationFrame(()=>{a.updateSelectKey++})):console.log(`[Animation Editor] Can't get partKeys of prop(${e})`)}showFrameInGrid(e){var{start:t,end:a}=grid_ctrl_1.gridCtrl.getFrameRang();a<=e?this.setGridHeaderFrame(e):e<=t&&this.setGridFooterFrame(e)}setGridHeaderFrame(e){var t=grid_ctrl_1.gridCtrl.getFrameRang()["start"],t=grid_ctrl_1.gridCtrl.frameToCanvas(t);this.moveTimeLine(t-grid_ctrl_1.gridCtrl.frameToCanvas(e))}setGridFooterFrame(e){var t=grid_ctrl_1.gridCtrl.getFrameRang()["end"],t=grid_ctrl_1.gridCtrl.frameToCanvas(t);this.moveTimeLine(t-grid_ctrl_1.gridCtrl.frameToCanvas(e))}moveTimeLine(e){this.vm;grid_ctrl_1.gridCtrl.grid.transferX(e),this.vm.transformEvent.emitUpdate("grid")}scaleTimeLineAt(e,t){this.vm;var a=(0,utils_1.smoothScale)(e,grid_ctrl_1.gridCtrl.scale);e<0&&a<=grid_ctrl_1.gridCtrl.grid.xMinScale||0<e&&a>=grid_ctrl_1.gridCtrl.grid.xMaxScale||(grid_ctrl_1.gridCtrl.grid.xAxisScaleAt(t,a),this.vm.transformEvent.emitUpdate("grid"))}scaleTimeLineWith(e){this.vm;e=(0,lodash_1.clamp)(e,grid_ctrl_1.gridCtrl.grid.xMinScale,grid_ctrl_1.gridCtrl.grid.xMaxScale);grid_ctrl_1.gridCtrl.grid.xAxisScale=e,this.vm.transformEvent.emitUpdate("grid")}runPointer(){const e=this.vm;this.aniPlayTask=requestAnimationFrame(async()=>{"play"===e.animationState&&e.animationMode?(await this.checkCurrentTime(),this.runPointer()):(this.aniPlayTask&&cancelAnimationFrame(this.aniPlayTask),await this.checkCurrentTime())})}setCurrentFrame(e){0===(this.vm.currentFrame=e=e<0?0:e)?grid_ctrl_1.gridCtrl.grid&&grid_ctrl_1.gridCtrl.grid.xAxisOffset!==grid_ctrl_1.gridCtrl.startOffset&&this.moveTimeLine(grid_ctrl_1.gridCtrl.startOffset-grid_ctrl_1.gridCtrl.grid.xAxisOffset):this.showFrameInGrid(e)}updateCurrentFrame(e){this.setCurrentFrame(e);e=(0,utils_1.frameToTime)(e,this.vm.sample);(0,ipc_event_1.IsetCurEditTime)(e)}jumpPrevFrame(){0<this.vm.currentFrame&&this.updateCurrentFrame(--this.vm.currentFrame)}jumpNextFrame(){this.updateCurrentFrame(++this.vm.currentFrame)}jumpFirstFrame(){this.updateCurrentFrame(0)}jumpLastFrame(){this.updateCurrentFrame(this.vm.lastFrameInfo.frame)}async nextStep(){var e=this.vm;this.isLock||(e.selectKeyInfo?this.moveSelectKeys(1,!0):e.selectEmbeddedPlayerInfo?this.moveSelectEmbeddedPlayers(1):e.selectEventInfo?await this.moveSelectEvents(1,!0):this.jumpNextFrame())}async prevStep(){var e;this.isLock||((e=this.vm).selectKeyInfo?this.moveSelectKeys(-1,!0):e.selectEmbeddedPlayerInfo?this.moveSelectEmbeddedPlayers(-1):e.selectEventInfo?await this.moveSelectEvents(-1,!0):this.jumpPrevFrame())}jumpToNextKey(){var t=this.vm;if(animation_ctrl_1.animationCtrl.clipsDump&&t.computeSelectPath){let e=[];if(e=t.selectProperty?animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.computeSelectPath][t.selectProperty.prop].keyFrames:this.calcNodeFrames(t.computeSelectPath,!0),t.currentFrame>e[e.length-1].frame)this.updateCurrentFrame(e[e.length-1].frame);else for(const a of e)if(a.frame>t.currentFrame)return void this.updateCurrentFrame(a.frame)}}jumpToPrevKey(){var a=this.vm;if(animation_ctrl_1.animationCtrl.clipsDump&&a.computeSelectPath){let t=[];if(t=a.selectProperty?animation_ctrl_1.animationCtrl.clipsDump.pathsDump[a.computeSelectPath][a.selectProperty.prop].keyFrames:this.calcNodeFrames(a.computeSelectPath,!0),a.currentFrame<t[0].frame)this.updateCurrentFrame(t[0].frame);else for(let e=t.length-1;0<=e;e--){var r=t[e].frame;if(r<a.currentFrame)return void this.updateCurrentFrame(r)}}}async moveSelectEmbeddedPlayers(e){var t=this.vm;if(animation_ctrl_1.animationCtrl.clipsDump&&t.selectEmbeddedPlayerInfo){var a=[];for(const i of t.selectEmbeddedPlayerInfo){var r=Math.max(i.rawInfo.begin+e,0)-i.rawInfo.begin;if(0==r)return;r={...i.rawInfo,begin:i.rawInfo.begin+r,end:i.rawInfo.end+r};a.push((0,ipc_event_1.updateEmbeddedPlayer)(this.vm.currentClip,i.rawInfo,r)),Object.assign(i,this.transEmbeddedPlayerDumpToInfo(r))}await(0,ipc_event_1.IApplyOperation)(a)}}async moveSelectKeys(a,r=!1){var i=this.vm;if(animation_ctrl_1.animationCtrl.clipsDump&&i.selectKeyInfo){var e=JSON.parse(JSON.stringify(i.selectKeyInfo)),n=(e.offsetFrame=e.offsetFrame||0,e)["keyFrames"],o=[];for(let e=0;e<n.length;e++){var s=n[e];let t=s.frame+a;if(t<0)return void this.showToast("i18n:animator.move_key_tips.can_not_be_zero");if(!i.selectKeyInfo.keyFrames.find(e=>e.frame===t))for(var l=n[e],m=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[l.nodePath][l.prop].keyFrames;m.find(e=>e.frame===t);){if(!r||this.hasShowStick)return;a=0<a?a+1:a-1,t=s.frame+a}o.push(t),s.frame=t,s.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(s.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset}0!==o.length&&(o.sort((e,t)=>e-t),0<a?this.showFrameInGrid(o[o.length-1]):this.showFrameInGrid(o[0]),e.ctrl=r,e.offsetFrame+=a,i.selectKeyInfo=e,await animation_ctrl_1.animationCtrl.moveKeys())}}async moveSelectEvents(a,r){var e=this.vm,{data:t,frames:i}=e.selectEventInfo,n=[];for(const o of t){let t=o.frame+a;if(t<0)return void this.showToast("i18n:animator.move_key_tips.can_not_be_zero");if(!i.includes(t))for(;animation_ctrl_1.animationCtrl.clipsDump.events.find(e=>e.frame===t);){let e="";if(e=r&&1===i.length?"i18n:animator.move_key_tips.move_with_ctrl":r&&1!==i.length?"i18n:animator.move_key_tips.move_keys_with_ctrl":"i18n:animator.move_key_tips.should_move_keys_with_ctrl",this.showToast(e),!r||1!==i.length)return;a=0<a?a+1:a-1,t=o.frame+a}n.push(t),o.frame=t,o.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(o.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset}n.sort((e,t)=>e-t),0<a?this.showFrameInGrid(n[i.length-1]):this.showFrameInGrid(n[0]),e.selectEventInfo.offsetFrame+=a,await animation_ctrl_1.animationCtrl.callByDebounce("moveEvents")}onKeyMouseMove(t){var a=this.vm,r=t.target;if(a.selectKeyInfo){var i=JSON.parse(JSON.stringify(a.selectKeyInfo)),{startX:n,keyFrames:o,location:s,nodePath:l}=i;if(!(Math.abs(n-t.x)<.1)){t.altKey?r.style.cursor="copy":r.style.cursor="ew-resize";r=grid_ctrl_1.gridCtrl.pageToFrame(t.x);let e=grid_ctrl_1.gridCtrl.pageToFrame(n);var m=r-(e=e<0?0:e);if(0!=m){var d=grid_ctrl_1.gridCtrl.grid.valueToPixelH(r)-grid_ctrl_1.gridCtrl.grid.valueToPixelH(e),c=[];for(const u of o)if(u)if("prop"===s&&l&&u.nodePath!==l)u.offsetFrame=0,c.push(u.frame);else{var p=u.frame+m;if(p<0)return;u.x+=d,u.frame=p,c.push(p)}i.startX+=d,i.offset+=d,i.offsetFrame+=m,global_data_1.Flags.startDragStickInfo||this.updateMouseFrame({x:t.x,y:t.y,frame:o[0].frame},i.offsetFrame),a.selectKeyInfo=i,c.sort((e,t)=>e-t);var{start:n,end:r}=grid_ctrl_1.gridCtrl.getFrameRang();(c[0]<=n||r<=c[c.length-1])&&this.moveTimeLine(-d)}}}}onAuxKeyMouseMove(t){var a=this.vm,r=t.target,a=a.auxCurveStore;if(a.selectKeyInfo){var i=JSON.parse(JSON.stringify(a.selectKeyInfo)),{startX:n,keyframes:o}=i;if(!(Math.abs(n-t.x)<.1)){t.altKey?r.style.cursor="copy":r.style.cursor="ew-resize";r=grid_ctrl_1.gridCtrl.pageToFrame(t.x);let e=grid_ctrl_1.gridCtrl.pageToFrame(n);var s=r-(e=e<0?0:e);if(0!=s){var l=grid_ctrl_1.gridCtrl.grid.valueToPixelH(r)-grid_ctrl_1.gridCtrl.grid.valueToPixelH(e),m=[];for(const c of o)if(c){m.push(c.frame);var d=c.frame+s;if(d<0)return;c.x+=l,c.frame=d,m.push(d)}"number"==typeof i.startX&&(i.startX+=l),"number"==typeof i.offset&&(i.offset+=l),"number"==typeof i.offset&&(i.offset+=l),"number"==typeof i.offsetFrame&&(i.offsetFrame+=s),global_data_1.Flags.startDragStickInfo||this.updateMouseFrame({x:t.x,y:t.y,frame:o[0].frame},i.offsetFrame),a.selectKeyInfo=i,m.sort((e,t)=>e-t);var{start:n,end:r}=grid_ctrl_1.gridCtrl.getFrameRang();(m[0]<=n||r<=m[m.length-1])&&this.moveTimeLine(-l)}}}}onEmbeddedPlayerMouseMove(e){var t=this.vm;if(global_data_1.Flags.startDragEmbeddedPlayerInfo&&t.selectEmbeddedPlayerInfo){const r=e.x-global_data_1.Flags.startDragEmbeddedPlayerInfo.startX;if(0!=r){var a=e.target;switch(global_data_1.Flags.startDragEmbeddedPlayerInfo.offset=r,global_data_1.Flags.startDragEmbeddedPlayerInfo.type){case"center":e.altKey?a.style.cursor="copy":a.style.cursor="move",t.selectEmbeddedPlayerInfo.forEach(e=>{e.x=e.rawInfo.x+r});break;case"left":a.style.cursor="em-resize",t.selectEmbeddedPlayerInfo.forEach(e=>{var t=e.x;e.x=Math.max(0,e.rawInfo.x+r),e.width=e.rawInfo.width-(t-e.rawInfo.x)});break;case"right":t.selectEmbeddedPlayerInfo.forEach(e=>{e.width=e.rawInfo.width+r})}}}}async onEmbeddedPlayerMouseUp(e){var t=this.vm;if(global_data_1.Flags.startDragEmbeddedPlayerInfo&&t.selectEmbeddedPlayerInfo&&global_data_1.Flags.startDragEmbeddedPlayerInfo.offset&&"drop"!==global_data_1.Flags.startDragEmbeddedPlayerInfo.type){const a=[];t.selectEmbeddedPlayerInfo.forEach(e=>{a.push((0,ipc_event_1.updateEmbeddedPlayer)(this.vm.currentClip,this.transEmbeddedPlayerInfoToDump(e,!1),this.transEmbeddedPlayerInfoToDump(e,!0)))}),await(0,ipc_event_1.IApplyOperation)(a)}}async onEmbeddedPlayerDrop(e,t){var a=(JSON.parse(JSON.stringify(Editor.UI.__protected__.DragArea.currentDragInfo))||{})["value"],a=(e.preventDefault(),e.stopPropagation(),JSON.parse(a)),r=this.transEmbeddedPlayerInfoToDump(a,!1),e=e.x-global_data_1.Flags.startDragEmbeddedPlayerInfo.startX,e=(a.x=a.rawInfo.x+e,a.group=t,this.transEmbeddedPlayerInfoToDump(a,!0));await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.updateEmbeddedPlayer)(this.vm.currentClip,r,e))}onKeyMouseUp(e,t){(t&&t.alt||e.altKey)&&this.vm.selectKeyInfo?(e=t&&t.target||this.vm.currentFrame,animation_ctrl_1.animationCtrl.pasteKey({target:e,nodePath:this.vm.selectKeyInfo.keyFrames[0].nodePath},animation_ctrl_1.animationCtrl.transSelectToCopyKeyInfo())):animation_ctrl_1.animationCtrl.moveKeys()}onAuxKeyMouseup(e){var t,a=this.vm.auxCurveStore;null==a.selectKeyInfo||(t=(a=a.selectKeyInfo).offsetFrame,Math.abs(t)<Number.EPSILON)||animation_ctrl_1.animationCtrl.moveAuxKey(a.keyframes,t)}onEventMouseMove(t){var a=this.vm;if(a.selectEventInfo){var r=t.target,{startX:r,data:i}=(t.altKey?r.style.cursor="copy":r.style.cursor="ew-resize",a.selectEventInfo),n=grid_ctrl_1.gridCtrl.pageToFrame(t.x);let e=grid_ctrl_1.gridCtrl.pageToFrame(r);var o=n-(e=e<0?0:e);if(0!=o){var s=grid_ctrl_1.gridCtrl.grid.valueToPixelH(n)-grid_ctrl_1.gridCtrl.grid.valueToPixelH(e);a.selectEventInfo.startX+=s,a.selectEventInfo.offset+=s,a.selectEventInfo.offsetFrame+=o;for(const l of i)if(l.x+=s,l.frame+=o,l.frame<0)return;this.updateMouseFrame({x:t.x,y:t.y,frame:i[0].frame},a.selectEventInfo.offsetFrame);var{start:r,end:n}=grid_ctrl_1.gridCtrl.getFrameRang();(i[0].frame<=r||i[i.length-1].frame>=n)&&this.moveTimeLine(-s)}}}onEventMouseUp(e){var t=grid_ctrl_1.gridCtrl.pageToFrame(e.x+grid_ctrl_1.gridCtrl.startOffset);e.altKey&&this.vm.selectEventInfo?animation_ctrl_1.animationCtrl.pasteEvent(t,{eventsDump:this.vm.selectEventInfo.data}):this.vm.selectEventInfo&&0===this.vm.selectEventInfo.offsetFrame||animation_ctrl_1.animationCtrl.moveEvents()}unSelectEmbeddedPlayerInfo(e){e.forEach(t=>{var e;this.vm.selectEmbeddedPlayerInfo&&-1!==(e=this.vm.selectEmbeddedPlayerInfo.findIndex(e=>e.key===t.key))&&this.vm.selectEmbeddedPlayerInfo.splice(e,1)}),this.vm.selectEmbeddedPlayerInfo&&(Editor.Selection.unselect("animation-embeddedPlayer",Editor.Selection.getSelected("animation-embeddedPlayer")),Editor.Selection.select("animation-embeddedPlayer",this.vm.selectEmbeddedPlayerInfo.map(e=>JSON.stringify({dump:this.transEmbeddedPlayerInfoToDump(e,!1),clipUuid:this.vm.currentClip,root:animation_ctrl_1.animationCtrl.nodesDump.rawPath}))))}onStartDragSuregion(e,t){var a;(0,utils_1.checkCtrlOrCommand)(e)&&this.vm.selectEmbeddedPlayerInfo&&(-1===(a=this.vm.selectEmbeddedPlayerInfo.findIndex(e=>e.key===t.key))?this.vm.selectEmbeddedPlayerInfo.push({...t,rawInfo:JSON.parse(JSON.stringify(t))}):this.vm.selectEmbeddedPlayerInfo.splice(a,1)),this.vm.selectEmbeddedPlayerInfo=[{...t,rawInfo:JSON.parse(JSON.stringify(t))}],Editor.Selection.unselect("animation-embeddedPlayer",Editor.Selection.getSelected("animation-embeddedPlayer")),Editor.Selection.select("animation-embeddedPlayer",this.vm.selectEmbeddedPlayerInfo.map(e=>JSON.stringify({dump:this.transEmbeddedPlayerInfoToDump(e,!1),clipUuid:this.vm.currentClip,root:animation_ctrl_1.animationCtrl.nodesDump.rawPath}))),global_data_1.Flags.mouseDownName="embeddedPlayer",global_data_1.Flags.startDragEmbeddedPlayerInfo={startX:e.x,type:e.target.getAttribute("name")}}onStickMouseMove(e){var a=this.vm;if(global_data_1.Flags.startDragStickInfo&&a.selectKeyInfo){var t=e.x-global_data_1.Flags.startDragStickInfo.startX;if(0!=t)switch(global_data_1.Flags.startDragStickInfo.type){case"center":this.onKeyMouseMove(e);break;case"right":var r=1+t/global_data_1.Flags.startDragStickInfo.width,i=global_data_1.Flags.startDragStickInfo.cacheData,n=i[0];for(let t=1;t<i.length;t++){var o=i[t];if(o.frame!==n.frame){o=(o.x-n.x)*r+n.x;let e=grid_ctrl_1.gridCtrl.canvasToFrame(o);e===n.frame&&(e=n.frame+(1<r?-1:1)),o=grid_ctrl_1.gridCtrl.frameToCanvas(e),this.stickInfo.width=o+12-this.stickInfo.left,a.selectKeyInfo.keyFrames[t].offsetFrame=e-a.selectKeyInfo.keyFrames[t].rawFrame,Object.assign(a.selectKeyInfo.keyFrames[t],{x:o,frame:e})}}a.updateSelectKey++;break;case"left":var s=t/global_data_1.Flags.startDragStickInfo.width,l=global_data_1.Flags.startDragStickInfo.cacheData,m=l[l.length-1];for(let t=l.length-2;0<=t;t--){var d=l[t];if(d.frame!==m.frame){d=(m.x-d.x)*s+d.x;let e=grid_ctrl_1.gridCtrl.canvasToFrame(d);e===m.frame&&(e=m.frame+(1<s?-1:1)),d=grid_ctrl_1.gridCtrl.frameToCanvas(e),a.selectKeyInfo.keyFrames[t].offsetFrame=e-a.selectKeyInfo.keyFrames[t].rawFrame,Object.assign(a.selectKeyInfo.keyFrames[t],{x:d,frame:e})}}a.updateSelectKey++}}}cancelDebounce(){this.debounceUpdateNode.cancel(),this.debounceFilterNode.cancel(),this.debounceRefresh.cancel()}onSceneClose(){this.cancelDebounce()}async updateNode(t){const a=this.vm;var e,r,i,n,o,s=await(0,ipc_event_1.queryAnimationNodeEditInfo)(t);"failure"!==s.state&&s.result?a.selectedId===t&&({root:e,node:r,aniComp:i,clipsMenu:n,defaultClip:o}=s.result,a.root=e,this.updateRoot(r),a.clipsMenu=n||[],a.nodeDump=Object.freeze(animation_ctrl_1.animationCtrl.nodesDump?animation_ctrl_1.animationCtrl.nodesDump.nodes:null),a.aniCompType=i||null,await Promise.all([(0,ipc_event_1.IqueryPropertiesMenu)(t).then(e=>{t===a.selectedId&&(a.propertiesMenu=e)}),this.updateClips(o,"update")])):console.error(s.reason)}async updateEditInfo(){var e,t=this.vm;"animation"===await(0,ipc_event_1.IquerySceneMode)()?(e=await(0,ipc_event_1.IqueryPlayState)(t.currentClip),this.updatePlayState(e),e=await(0,ipc_event_1.IqueryPlayingClipTime)(t.currentClip),this.setCurrentFrame((0,utils_1.timeToFrame)(e,t.sample)),t.animationMode=!0):(t.animationMode=!1,this.updatePlayState(0),this.setCurrentFrame(0))}async updateClipMenu(e){const t=this.vm;e=e||await(0,ipc_event_1.IqueryclipsMenuInfo)(t.root);return!e||e.clipsMenu&&0===e.clipsMenu.length?(t.clipsMenu=[],this.updateClips(null),!0):(t.clipsMenu=e.clipsMenu,!(t.currentClip===e.defaultClip||(-1!==e.clipsMenu.findIndex(e=>e.uuid===t.currentClip)||!t.animationMode)&&t.animationMode||(e.defaultClip||(e.defaultClip=e.clipsMenu[0].uuid),await this.updateClips(e.defaultClip),0)))}async checkUseBakedAnimationBySkeletalAnimation(){const t=this.vm;return(0,ipc_event_1.IqueryAnimationRootInfo)(t.root).then(e=>{t.showUseBakedAnimationWarn=t.isSkeletonClip&&e.useBakedAnimation})}checkPropTypeInCopyKeyInfo(e){var t=animation_ctrl_1.animationCtrl.copyKeyInfo;if(t)for(const a of t.curvesDump)if(a._parentType&&a._parentType.value===e.value||a.type.value===e.value)return!0;return!1}onPropTrackMenu(e,t){if(!this.vm.properties)return!1;const a=t-this.vm.$refs["property-content"].getBoundingClientRect().top+this.vm.propertyScrollInfo.top,r=Object.values(this.vm.properties).find(e=>e.top+this.LINE_HEIGHT>a&&a>e.top);if(!r)return!1;const i=grid_ctrl_1.gridCtrl.pageToFrame(e);t=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onPropContextMenus,!0);return t.createKey.click=()=>{animation_ctrl_1.animationCtrl.createKey({frame:i,nodePath:r.nodePath,prop:r.prop})},t.pasteKey.enabled=this.checkPropTypeInCopyKeyInfo(r.type),t.pasteKey.click=()=>{animation_ctrl_1.animationCtrl.pasteKey({target:i,nodePath:r.nodePath,prop:r.prop})},Editor.Menu.popup({menu:[...Object.values(t),{label:"frame: "+i,enabled:!1}]}),!0}onNodeTrackMenu(e,t){const a=t-this.vm.$refs["node-content"].getBoundingClientRect().top+this.vm.nodeScrollInfo.top;return!!this.vm.nodeDump.find(e=>e.top+this.LINE_HEIGHT>a&&a>e.top)}spacingSelectedKeys(e){this.selectKeyUpdateFlag=!0,animation_ctrl_1.animationCtrl.spacingKeys(e)}onStickMouseUp(e){var t;if(2===e.button)(t=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onStickMenus,!0)).copyKey.click=()=>{animation_ctrl_1.animationCtrl.copyKey()},t.spacingKeys.click=()=>{this.spacingSelectedKeys(exports.animationEditor.spacingFrame)},t.removeKey.click=()=>{animation_ctrl_1.animationCtrl.removeKey()},Editor.Menu.popup({menu:Object.values(t)});else if(global_data_1.Flags.startDragStickInfo){switch(global_data_1.Flags.startDragStickInfo.type){case"center":this.onKeyMouseUp(e,{target:this.stickInfo.leftFrame});break;case"right":case"left":this.onKeyMouseUp(e)}global_data_1.Flags.startDragStickInfo=null}}onStartResize(e,t){e=e.target;e&&"UI-INPUT"===e.tagName||(global_data_1.Flags.mouseDownName="resize",global_data_1.Flags.startResizeInfo={type:t,start:0})}onResizeMouseMove(r){if(global_data_1.Flags.startResizeInfo){var i=global_data_1.Flags.startResizeInfo.type,n=global_data_1.Flags.startResizeInfo.start;let a=0;if("left"===i?(a=r.x,this.vm.leftResizeMoving=!0):a=r.y+25,n){if(!(r.x<this.layoutConfig.leftMin||r.x>this.layoutConfig.leftMax)){r=r.y-32-this.vm.$refs.container.getBoundingClientRect().top;if("left"===i||!(r>this.layoutConfig.topMax||r<this.layoutConfig.topMin)){global_data_1.Flags.startResizeInfo.start=a;var r=i+"Pec",o="left"===i?this.vm.$refs.container.offsetWidth:this.vm.$refs.container.offsetHeight,s=parseFloat(this.vm.layout[r])/100*o||0;let e=s+a-n,t=("auxCurve"===i&&(e=s-(a-n)),(e=Editor.Utils.Math.clamp(e,this.layoutConfig[i+"Min"],this.layoutConfig[i+"Max"]))/o*100);(t=Math.min(100,t))<4&&("centerPec"==r&&(s=this.vm.layout[r]-t,this.vm.layout.topPec-=s,this.vm.layout.topPec<4)&&(this.vm.layout.topPec=4),t=4),"topPec"==r&&(this.vm.layout.centerPec=this.vm.layout.topPec+this.vm.layout.centerPec-t,this.vm.layout.centerPec<4)&&(this.vm.layout.centerPec=4),this.vm.layout[r]=t}}}else global_data_1.Flags.startResizeInfo.start=a}}onResizeMouseUp(e){this.vm.leftResizeMoving=!1,global_data_1.Flags.startResizeInfo=null,this.setConfig("layout",this.vm.layout),e.target.style="default"}checkSelectData(){this.checkSelectProperty(),this.checkSelectEvents(),this.checkSelectKeys(),this.checkSelectEmbeddedPlayers()}checkSelectEmbeddedPlayers(){var e=this.vm;if(animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.nodesDump&&animation_ctrl_1.animationCtrl.clipsDump.groupToEmbeddedPlayers){var t=Editor.Selection.getSelected("animation-embeddedPlayer");if(t){var a=[];for(const i of t){var r=JSON.parse(i);r.clipUuid!==e.currentClip?Editor.Selection.unselect("animation-embeddedPlayer",i):(r=this.transEmbeddedPlayerDumpToInfo(r.dump),a.push({...r,rawInfo:JSON.parse(JSON.stringify(r))}))}a.length&&(e.selectEmbeddedPlayerInfo=a)}e.selectEmbeddedPlayerInfo&&(e.selectEmbeddedPlayerInfo=e.selectEmbeddedPlayerInfo.filter(e=>{var t=animation_ctrl_1.animationCtrl.clipsDump.groupToEmbeddedPlayers[e.group];if(!t||!t.length)return!1;const a=this.transEmbeddedPlayerInfoToDump(e,!0);t=t.find(e=>lodash_1.default.isEqual(e,a));return!!t&&(Object.assign(e,t),e.rawInfo=JSON.parse(JSON.stringify(t)),!0)}))}else e.selectEmbeddedPlayerInfo=null,Editor.Selection.unselect("animation-embeddedPlayer",Editor.Selection.getSelected("animation-embeddedPlayer"))}checkSelectProperty(){var e=this.vm;e.selectProperty&&e.selectPropData&&animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.nodesDump&&(Object.keys(animation_ctrl_1.animationCtrl.nodesDump.path2uuid).includes(e.selectProperty.nodePath)&&animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.selectProperty.nodePath]&&animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.selectProperty.nodePath][e.selectPropData.prop]||(e.selectProperty=null))}checkSelectEvents(){var e=this.vm;if(e.selectEventInfo)if(animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.clipsDump.events){var t=animation_ctrl_1.animationCtrl.clipsDump.events.map(e=>e.frame);if(t.length){var a=[];for(const r of e.selectEventInfo.frames)-1!==t.indexOf(r)&&a.push(r);0===a.length?e.selectEventInfo=null:e.selectEventInfo.frames=a}else e.selectEventInfo=null}else e.selectEventInfo=null}checkSelectKeys(){const a=this.vm;if(a.selectKeyInfo)if(animation_ctrl_1.animationCtrl.clipsDump){const r=[];var e;a.selectKeyInfo.keyFrames.forEach((e,t)=>{animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.nodePath]&&animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.nodePath][e.prop]&&(t=a.selectKeyInfo.keyFrames[t],animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.nodePath][e.prop].keyFrames.map(e=>e.frame).includes(t.frame))&&(t.rawFrame=e.frame,delete t.offsetFrame,r.push(t))}),0===r.length?a.selectKeyInfo=null:(e=(0,utils_1.sortKeysToTreeMap)(r),Object.assign(a.selectKeyInfo,{keyFrames:r,sortDump:e,offsetFrame:0,offset:0,startX:a.selectKeyInfo.startX}),a.updateSelectKey++)}else a.selectKeyInfo=null}resetState(){var e=this.vm;this.updateClips(null),e.animationMode=!1,e.aniCompType=null,e.clipConfig=null,e.nodeDump=null}calcCreatePropMenu(e){let t=[];var a;if((0,utils_1.isMenuItem)(e))a=e.menuName||e.displayName,t.push({label:a,enabled:!e.disable,click:()=>{this.createProp(e.key)}});else for(const i of Object.keys(e)){var r=e[i];(0,utils_1.isMenuItem)(r)?t=t.concat(this.calcCreatePropMenu(r)):t.push({label:i,submenu:this.calcCreatePropMenu(r)})}return t}async createProp(e){let t=!1;var a=this.vm;if(a.selectedIds&&1<a.selectedIds.size){let e=Array.from(a.selectedIds);if(1<(e=e.filter(e=>animation_ctrl_1.animationCtrl.nodesDump.uuid2path[e])).length){a=await Editor.Dialog.info(Editor.I18n.t("animator.is_add_prop_multi.title"),{buttons:[Editor.I18n.t("animator.is_add_prop_multi.add_to_current"),Editor.I18n.t("animator.is_add_prop_multi.add_to_all")],default:0,cancel:-1});if(-1===a.response)return;t=!!a.response}}animation_ctrl_1.animationCtrl.createProp({prop:e},t)}async updateSelectedId(){var e=this.vm;!e.selectedId&&e.animationMode||(e.selectedId?e.propertiesMenu=await(0,ipc_event_1.IqueryPropertiesMenu)(e.selectedId):(e.root="",this.resetState(),e.propertiesMenu=null),e.properties=this.calcProperty(),this.jumpToSelectedNode())}jumpToSelectedNode(){const t=this.vm;var e,a,r,i;animation_ctrl_1.animationCtrl.nodesDump&&-1!==(a=(e=animation_ctrl_1.animationCtrl.nodesDump.nodesDump||animation_ctrl_1.animationCtrl.nodesDump.nodes).findIndex(e=>e.uuid===t.selectedId&&"number"==typeof e.listIndex))&&(a=(e[a].listIndex+1)*this.LINE_HEIGHT,{top:r,height:i}=t.nodeScrollInfo,i<a-r||a-r<0)&&(t.nodeScrollInfo.top=Editor.Utils.Math.clamp(a-i/2,0,(e.length+1)*this.LINE_HEIGHT-i),this.calcDisplayClips())}calcBoxStyle(){var e,t,a,r,i,n,o,s,l,m,d=this.vm;return d.boxInfo&&d.boxInfo.type&&!d.lock&&({startX:e,startY:t,type:r,x:o,y:a}=d.boxInfo,o=grid_ctrl_1.gridCtrl.pageToCtrl(o,a),{offsetTop:a,offsetHeight:r,offsetWidth:i}=d.$refs[r+"-content"],n=Editor.Utils.Math.clamp(o.x,0,i),l=t-(o=Editor.Utils.Math.clamp(o.y,a,a+r)),s=e-n)&&l?(m={},0<s&&0<l?(m.x=n,m.y=o-a):s<0&&l<0?(m.x=e,m.y=t-a):s<0&&0<l?(m.x=e,m.y=o-a):0<s&&l<0&&(m.x=n,m.y=t-a),d.boxData={origin:m,w:Math.abs(s),h:Math.abs(l),type:d.boxInfo.type},{top:m.y+"px",left:m.x+"px",right:Math.round(i-m.x-Math.abs(s))+"px",bottom:Math.round(r-m.y-Math.abs(l))+"px"}):null}updatePlayState(e){var t=this.vm;switch(e){case 0:t.animationState="stop",this.aniPlayTask&&cancelAnimationFrame(this.aniPlayTask),this.checkCurrentTime();break;case 1:"play"!==animation_ctrl_1.animationCtrl.animationState?console.debug(`Invalid animation state change. (${animation_ctrl_1.animationCtrl.animationState} -> play))`):"play"!==t.animationState&&(t.animationState="play",this.runPointer());break;case 2:t.animationState="pause",this.aniPlayTask&&cancelAnimationFrame(this.aniPlayTask)}}async checkCurrentTime(){var e=this.vm,t=await(0,ipc_event_1.IqueryPlayingClipTime)(e.currentClip),t=(0,utils_1.timeToFrame)(t,e.sample);t!==e.currentFrame&&this.setCurrentFrame(t)}updateRoot(e){var t=this.vm;e&&(""===e.name||e.isScene?(t.selectedId="",t.root="",t.nodeDump=null,animation_ctrl_1.animationCtrl.clipsDump=null,animation_ctrl_1.animationCtrl.nodesDump=null):(animation_ctrl_1.animationCtrl.nodesDump=(0,utils_1.formatNodeDump)(e),t.nodeDump=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.nodesDump.nodes))))}async updateClips(t,a){var r=this.vm;if(r.nodeDump&&!r.active)this.clearClips();else if(t&&""!==r.root){let e=void 0;if(clip_cache_1.animationClipCacheManager.cacheClipDump(r.root,r.currentClip),"string"==typeof t){if(r.currentClip===t&&"update"!==a)return;if(console.time("IqueryClipDump"),e=await(0,ipc_event_1.IqueryClipDump)(r.root,t),console.timeEnd("IqueryClipDump"),!e&&!global_data_1.Flags.sceneReady)return void exports.animationEditor.refreshTask++;if(!e)return console.warn(`Get animation clip data failed! node ${r.root}, clip `+r.currentClip),void this.clearClips();r.currentClip=t}e&&(animation_ctrl_1.animationCtrl.clipsDump=Object.assign((0,utils_1.formatClipDump)(e),{uuid:r.currentClip}),e.sample!==grid_ctrl_1.gridCtrl.grid?.sample&&(grid_ctrl_1.gridCtrl.grid.sample=e.sample,grid_ctrl_1.gridCtrl.grid.render(),this.renderTimeAxis()),Object.keys(animation_ctrl_1.animationCtrl.clipConfig).forEach(e=>{animation_ctrl_1.animationCtrl.clipConfig[e]=animation_ctrl_1.animationCtrl.clipsDump[e]??animation_ctrl_1.animationCtrl.clipConfig[e]}),r.clipConfig=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.clipConfig)),r.clipConfig&&r.clipConfig.duration&&(a=Math.min(r.$refs.chart.offsetWidth/(r.clipConfig.duration*r.clipConfig.sample*2),this.gridCtrl.grid.xMinScale),t=Math.max(r.clipConfig.duration*r.clipConfig.sample,this.gridCtrl.grid.xMaxScale),this.gridCtrl.grid.updateScale(a,t)),r.isSkeletonClip=!0===animation_ctrl_1.animationCtrl.clipsDump.isSkeleton,r.showUseBakedAnimationWarn=r.isSkeletonClip&&animation_ctrl_1.animationCtrl.clipsDump.useBakedAnimation,r.expandLayout.auxiliaryCurve=r.isSkeletonClip,await r.calcSelectProperty(null,!0)),this.calcEventsDump(),this.calcNodes(),this.calcDisplayClips(),r.properties=this.calcProperty(),this.calcAuxiliaryCurves(),this.checkSelectData(),r.updateKeyFrame++}else this.clearClips()}clearClips(){var e=this.vm,t=e.auxCurveStore;e.currentClip="",animation_ctrl_1.animationCtrl.exit(),animation_ctrl_1.animationCtrl.clipsDump=null,e.clipConfig=null,e.eventsDump=null,this.calcDisplayClips(),e.properties=this.calcProperty(),t.reset(),e.embeddedPlayerGroups=[],this.checkSelectData(),e.updateKeyFrame++}calcProperty(){const n=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!n.computeSelectPath||!grid_ctrl_1.gridCtrl.grid)return null;let o=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[n.computeSelectPath];if(!o)return null;o=JSON.parse(JSON.stringify(o));let s=0;return Object.keys(o).forEach((e,t)=>{const a=o[e];let r=a;var i;"string"==typeof o[e].parentPropKey?(-1!==(i=(r=o[o[e].parentPropKey]).partKeys.findIndex(e=>e===a.prop))&&a.isCurveSupport&&(a.color=exports.CurveColorList[i]),!0!==n.expandInfo[r.prop]?(n.expandInfo[r.prop]=!1,o[e].hidden=!0):s++):(s++,a.type&&a.isCurveSupport&&(a.color=exports.CurveColorList[3])),o[e].index=Math.max(0,s-1),o[e].top=(s-1)*this.LINE_HEIGHT,n.propertiesMenu&&!(0,utils_1.checkPropertyInMenu)(r,n.propertiesMenu)&&(o[e].missing=!0),a.keyFrames=Object.freeze(calcFrames(a.keyFrames,n.$refs.chart.offsetWidth,this.imageCCTypes.includes(a.type&&a.type.value)))}),o}calcAuxiliaryCurves(){var e=this.vm.auxCurveStore;e.calcCurves(animation_ctrl_1.animationCtrl.clipsDump?.displayAuxiliaryCurves??[],this.vm.$refs.chart.offsetWidth),e.forceDumpUpdate()}calcEventsDump(){var e=this.vm;let t=[];return animation_ctrl_1.animationCtrl.clipsDump&&grid_ctrl_1.gridCtrl.grid&&(t=animation_ctrl_1.animationCtrl.clipsDump.events.map(e=>(e.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(e.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,e))),e.eventsDump=Object.freeze(t)}calcNodes(){if(!animation_ctrl_1.animationCtrl.nodesDump)return null;if(animation_ctrl_1.animationCtrl.clipsDump){const l=JSON.parse(JSON.stringify(Object.keys(animation_ctrl_1.animationCtrl.nodesDump.path2uuid)));animation_ctrl_1.animationCtrl.nodesDump.nodesDump=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.nodesDump.nodes));for(const e of Object.keys(animation_ctrl_1.animationCtrl.clipsDump.pathsDump))-1===l.indexOf(e)&&!function t(a,r=!1){var i=a.match(/\//g);if(i){const o=i.length;let e=l.findIndex(e=>!!e.match(/\//g)&&e.match(/\//g).length===o);if(i=a.match(/\/([^/]*)$/)){if(-1===(e=0===e?1:e)){e=l.length;var n=a.match(/\/([^/]+)/g);if(n&&!r){let e="";for(const s of n)e+=s,l.includes(e)||t(e,!0);return}}l.splice(e,0,a),animation_ctrl_1.animationCtrl.nodesDump.nodesDump.splice(e,0,{indent:2*o,path:a,name:i[1],uuid:"",keyFrames:[],top:0,rawIndex:e,listIndex:e})}}}(e)}}calcDisplayNodes(){const i=this.vm;if(animation_ctrl_1.animationCtrl.nodesDump){var e=animation_ctrl_1.animationCtrl.nodesDump.nodesDump||animation_ctrl_1.animationCtrl.nodesDump.nodes;const n=[];let r=-1;const o=i.filterInvalid||i.filterName;e.forEach((e,t)=>{if(delete e.listIndex,delete e.top,delete e.rawIndex,o){if(e.hidden=!0,i.filterName&&!new RegExp(i.filterName,"i").test(e.name))return;if(i.filterInvalid&&(!e.keyFrames||!e.keyFrames.length))return;e.hidden=!1,r++}else r=t;var a=r*this.LINE_HEIGHT-i.nodeScrollInfo.top;e.top=r*this.LINE_HEIGHT,e.rawIndex=t,e.listIndex=r,a>-this.LINE_HEIGHT&&a<i.nodeScrollInfo.height+this.LINE_HEIGHT&&(n.push(e),e.hidden=!1)});e=o?r*this.LINE_HEIGHT:e.length*this.LINE_HEIGHT;i.nodesHeight=Math.floor(e),animation_ctrl_1.animationCtrl.nodesDump.displayNodesDump=n,i.nodeDump=n,Math.abs(i.nodeScrollInfo.top-i.$refs.nodes.scrollTop)>this.LINE_HEIGHT&&(i.$refs.nodes.scrollTop=i.nodeScrollInfo.top)}else i.nodeDump=null}calcDisplayClips(){var e=this.vm;if(e.nodeDump&&animation_ctrl_1.animationCtrl.nodesDump&&animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.nodesDump.nodesDump){this.calcDisplayEmbeddedPlayers();const t=Object.create(null);animation_ctrl_1.animationCtrl.nodesDump.nodesDump.forEach(e=>{t[e.path]=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.path],!e.disabled&&t[e.path]&&(e.keyFrames=Object.freeze(JSON.parse(JSON.stringify(this.calcNodeFrames(e.path)))))}),e.nodeDump=animation_ctrl_1.animationCtrl.nodesDump.nodesDump,animation_ctrl_1.animationCtrl.clipsDump.displayClipsDump=t}else e.clipConfig=null;this.calcDisplayNodes()}calcDisplayEmbeddedPlayers(){if(!animation_ctrl_1.animationCtrl.clipsDump||!animation_ctrl_1.animationCtrl.clipsDump.groupToEmbeddedPlayers||!animation_ctrl_1.animationCtrl.clipsDump.embeddedPlayerGroups)return{};const a=[];return animation_ctrl_1.animationCtrl.clipsDump.embeddedPlayerGroups.forEach(e=>{let t=[];animation_ctrl_1.animationCtrl.clipsDump.groupToEmbeddedPlayers[e.key]&&(t=animation_ctrl_1.animationCtrl.clipsDump.groupToEmbeddedPlayers[e.key].map(e=>this.transEmbeddedPlayerDumpToInfo(e))),a.push({name:e.name,type:e.type,key:e.key,embeddedPlayers:t,menuInfo:utils_1.EmbeddedPlayerMenuMap[e.type]})}),this.vm.embeddedPlayerGroups=a}calcNodeFrames(e,t=!1){var a=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump)return[];var r=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e];if(!r)return[];let i=[];for(const o of Object.keys(r)){var n=calcFrames(r[o].keyFrames,a.$refs.chart.offsetWidth,!1);i=i.concat(n)}return t&&0!==i.length&&i.sort((e,t)=>e.frame-t.frame),i}transEmbeddedPlayerDumpToInfo(e,t){return{x:t="number"==typeof t?t:grid_ctrl_1.gridCtrl.frameToCanvas(e.begin),width:grid_ctrl_1.gridCtrl.frameToCanvas(e.end)-t,reconciledSpeed:e.reconciledSpeed,playable:e.playable,group:e.group,displayName:e.displayName,key:(0,utils_1.calcEmbeddedPlayerKey)(e),begin:e.begin,end:e.end}}calcEmbeddedPlayers(e,i){const n=[];return e.forEach(e=>{var t=grid_ctrl_1.gridCtrl.frameToCanvas(e.begin),a=grid_ctrl_1.gridCtrl.frameToCanvas(e.end),r=getDistance(t,i),a=getDistance(a,i);0!==r&&0!==a||n.push(this.transEmbeddedPlayerDumpToInfo(e,t))}),n}transEmbeddedPlayerInfoToDump(e,t){return{begin:t?grid_ctrl_1.gridCtrl.canvasToFrame(e.x):e.begin,end:t?grid_ctrl_1.gridCtrl.canvasToFrame(e.x+e.width):e.end,reconciledSpeed:e.reconciledSpeed,playable:e.playable,group:e.group,displayName:e.displayName}}async _refresh(){var e,t,a=this.vm;const r={w:a.$refs.right.offsetWidth,h:a.$refs.right.offsetHeight};r.w&&r.h?!this.refreshTask&&global_data_1.Flags.domReady&&a.$refs.gridCanvas.width===r.w&&a.$refs.gridCanvas.height===r.h?a.loading="":(Editor.Metrics.trackTimeStart("animator:view-refresh"),a.loading="init_animation_data",global_data_1.Flags.domReady=!0,this.updateScrollInfo(r),requestAnimationFrame(async()=>{this.updateScrollInfo(r)}),e=Editor.Selection.getLastSelected("node"),t=await(0,ipc_event_1.IquerySceneMode)(),a.animationMode="animation"===t,await this.vmInit(),a.wrapModeList=await Editor.Message.request("scene","query-enum-list-with-path","AnimationClip.WrapMode"),a.wrapModeList.forEach(e=>{e.tip=Editor.I18n.t(`animator.animationCurve.WrapMode.${e.name}.tip`)||e.name,e.name=Editor.I18n.t(`animator.animationCurve.WrapMode.${e.name}.label`)||e.name}),e?(console.time("updateNode"),await this.updateNode(e),console.timeEnd("updateNode"),await this.updateEditInfo()):a.animationMode?({rootid:t,clipid:e}=await(0,ipc_event_1.IgetEditAnimationInfo)(),t=await Editor.Message.request("scene","query-node-tree",t),console.time("updateRoot"),await this.updateRoot(t),console.timeEnd("updateRoot"),Editor.Metrics.trackTimeStart("animator:update-clips-data"),await this.updateClips(e),Editor.Metrics.trackTimeEnd("animator:update-clips-data",{output:!0,label:"animator:update-clips-data "+e}),console.timeEnd("updateClips")):this.resetState(),a.loading="",global_data_1.Flags.sceneReady=!0,this.refreshTask=0,Editor.Metrics.trackTimeEnd("animator:view-refresh",{output:!0})):global_data_1.Flags.domReady=!1}resize(){var e=this.vm;if(e.$refs.right){var{offsetWidth:t,offsetHeight:a}=e.$refs.right;e.$refs.chart.style.width=t+"px";const r={w:e.$refs.right.offsetWidth,h:e.$refs.right.offsetHeight};grid_ctrl_1.gridCtrl.grid&&grid_ctrl_1.gridCtrl.grid.resize(t,a),requestAnimationFrame(()=>{this.updateScrollInfo(r),this.calcDisplayClips(),this.calcDisplayNodes(),this.vm.updateKeyFrame++})}else global_data_1.Flags.domReady=!1}updateScrollInfo(e){var t=this.vm,a=t.auxCurveStore;t.nodeScrollInfo={size:e,height:t.$refs["node-content"].offsetHeight,top:t.$refs.nodes.scrollTop},t.propertyScrollInfo={size:e,height:t.$refs["property-content"].offsetHeight,top:t.$refs.property.scrollTop},t.embeddedPlayerScrollInfo={size:e,height:t.$refs["embeddedPlayer-content"].offsetHeight,top:t.$refs.embeddedPlayer.scrollTop},a.scrollInfo={size:e,height:0,top:0}}async onEnter(){clip_cache_1.animationClipCacheManager.animationMode=!0,this.vm.animationMode=!0}onExit(){this.closeMaskPanel(),this.vm.animationMode=!1,clip_cache_1.animationClipCacheManager.animationMode=!1,this.vm.moveNodePath="",this.vm.selectKeyInfo=null,this.vm.selectEventInfo=null,this.vm.selectProperty=null,this._curveData=null,this.vm.showAnimCurve&&this.vm.toggleAniCurve(),this.updateCurrentFrame(0),animation_ctrl_1.animationCtrl.clear()}close(){(0,utils_1.removeEventListener)(document,"mouseup",this.onMouseUp),(0,utils_1.removeEventListener)(document,"mousemove",this.onMouseMove),this.cancelDebounce()}async selectCacheClipToApply(){var e=await clip_cache_1.animationClipCacheManager.selectClipCache(this.vm.currentClip);e&&await Editor.Message.request("scene","execute-scene-script",{name:"animator",method:"restoreFromDump",args:[this.vm.root,this.vm.currentClip,e]})}}function getDistance(e,t){return e+grid_ctrl_1.gridCtrl.grid.xAxisOffset>t?e+grid_ctrl_1.gridCtrl.grid.xAxisOffset-t:e+grid_ctrl_1.gridCtrl.grid.xAxisOffset<0?e+grid_ctrl_1.gridCtrl.grid.xAxisOffset:0}function calcFrames(e,r,t){if(!e)return[];const i=[];function n(e){return t?{x:e.x,prop:e.prop,frame:e.frame,value:e.dump.value&&e.dump.value.uuid}:{x:e.x,prop:e.prop,frame:e.frame}}const o={maxNegative:{distance:-1/0,index:-1},minPositive:{index:-1,distance:1/0}};return e.forEach((e,t)=>{e.x=grid_ctrl_1.gridCtrl.frameToCanvas(e.frame);var a=getDistance(e.x,r);0===a?i.push(n(e)):0<a&&o.minPositive.distance>a?(o.minPositive.distance=a,o.minPositive.index=t):a<0&&o.maxNegative.distance<a&&(o.maxNegative.distance=a,o.maxNegative.index=t)}),i.length!==e.length&&(-1!==o.maxNegative.index&&i.push(n(e[o.maxNegative.index])),-1!==o.minPositive.index)&&i.push(n(e[o.minPositive.index])),i}function hasKeyData(e){if(animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e])for(const t of Object.values(animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e]))if(0!==t.keyFrames.length)return!0;return!1}exports.animationEditor=new AnimationEditor,exports.calcFrames=calcFrames;