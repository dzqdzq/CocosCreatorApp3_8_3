"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.animationCtrl=void 0;const lodash_1=require("lodash"),utils_1=require("../utils"),global_data_1=require("./global-data"),grid_ctrl_1=require("./grid-ctrl"),ipc_event_1=require("./ipc-event"),lodash=require("lodash");class AnimationCtrl{constructor(){this.clipConfig={sample:60,isLock:!1,speed:1,duration:60,wrapMode:0},this.clipsDump=null,this.nodesDump=null,this.propRowIndex={},this.__copyKeyInfo=null,this.__copyNodeInfo=null,this.__copyEventInfo=null,this.__copyPropInfo=null,this.animationState="stop",this.debounceCache={},this.isCreatingAniClip=!1,this.isNewClip=!1}get copyPropInfo(){return this.getClipBoardData("prop")}set copyPropInfo(e){this.__copyPropInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.prop",e)}get copyKeyInfo(){return this.getClipBoardData("key")}set copyKeyInfo(e){this.__copyKeyInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.key",e)}get copyEmbeddedPlayerDump(){return this.getClipBoardData("embeddedPlayer")}set copyEmbeddedPlayerDump(e){this.__copyKeyInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.embeddedPlayer",e)}get copyEventInfo(){return JSON.parse(JSON.stringify(this.__copyEventInfo))||this.getClipBoardData("event")}set copyEventInfo(e){this.__copyEventInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.event",e)}get copyNodeInfo(){return this.getClipBoardData("node")}set copyNodeInfo(e){this.__copyNodeInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.node",e)}reset(){this.clipConfig={sample:60,isLock:!1,speed:1,duration:60,wrapMode:0},this.clipsDump=null,this.nodesDump=null,this.propRowIndex={},this.__copyKeyInfo=null,this.__copyNodeInfo=null,this.__copyEventInfo=null,this.__copyPropInfo=null,this.debounceCache={}}getClipBoardData(e){return Editor.Clipboard.read("animation."+e)}init(e){this.vm=e}getPropData(e,t){if(!this.clipsDump||!this.clipsDump?.pathsDump[e]||!this.vm.properties)return null;let r=this.clipsDump.pathsDump[e][t];return r=r&&this.vm.properties[t]?Object.assign(JSON.parse(JSON.stringify(r)),this.vm.properties[t]):r}setCurrentFrame(e){this.vm.currentFrame=e}async updateConfig(e,t){switch(e){case"speed":(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IchangeClipSpeed)(this.vm.currentClip,t));break;case"sample":(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IchangeClipSample)(this.vm.currentClip,t));break;case"wrapMode":(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IchangeClipWrapMode)(this.vm.currentClip,Number(t)));break;case"exit":await this.exit()}}async createAniCompFromAsset(e){return Editor.Message.request("scene","execute-scene-script",{name:"animator",method:"createAniCompFromAsset",args:[this.vm.root,e.map(e=>e.value),this.vm.aniCompType]})}async addClipFromAsset(e){if(this.vm.clipsMenu){if(this.vm.clipsMenu.find(t=>e.find(e=>t.uuid===e.value)))return!0}else this.vm.clipsMenu=[];var t=await this.createAniCompFromAsset(e);return t&&e.forEach(e=>{this.vm.clipsMenu.push({name:e.name,uuid:e.value})}),t}async addAnimationComponent(){var e=await Editor.Message.request("scene","begin-recording",this.vm.root);await Editor.Message.request("scene","create-component",{uuid:this.vm.root,component:"cc.Animation"}),await Editor.Message.request("scene","end-recording",e)}async createAniClip(){this.isCreatingAniClip=!0;var e=await Editor.Message.request("asset-db","create-asset-dialog",{handler:"animation-clip"});return e&&await exports.animationCtrl.addClipFromAsset([{value:e.uuid,name:e.name}]),this.isCreatingAniClip=!1,e?.uuid||""}async enter(e){return(0,ipc_event_1.Irecord)(this.vm.root,!0,e)}async exit(){return!1!==this.vm.animationMode&&Editor.Message.request("scene","close-scene")}async updatePlayState(e){var t=this.vm,r=("play"===e&&("pause"===t.animationState&&(e="resume"),(0,utils_1.multiplyTrackWithTimer)("hippoAnimator",{A100003:1,project_id:Editor.Project.uuid,clip_id:this.vm.currentClip,version:Editor.App.version})),await(0,ipc_event_1.IchangeAnimationState)(e,t.currentClip));return r?(this.animationState="resume"===e?"play":e,!0):(console.warn(t.currentClip+` change play status ${e} failed！`),!1)}async save(){return Editor.Message.request("scene","save-clip")}callByDebounce(e,...t){var r=this[e];return!!r&&(this.debounceCache[e]||(this.debounceCache[e]=lodash.debounce(r,300)),this.debounceCache[e].call(this,...t))}spacingKeys(a){const t=this.vm;if(t.selectKeyInfo&&t.selectKeyInfo.keyFrames.length){const s=(0,utils_1.sortKeysToTreeMap)(t.selectKeyInfo.keyFrames);if(0!==Object.keys(s).length){const i=[],n={nodePath:t.selectKeyInfo.nodePath,prop:t.selectKeyInfo.prop,keyFrames:[],location:"prop"};Object.keys(s).forEach(e=>{const r=s[e];if(!(r.frames.length<=1)){const p=r.frames[0];e=r.frames.map((e,t)=>{t={x:grid_ctrl_1.gridCtrl.grid.valueToPixelH(p+t*a)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,rawFrame:e,nodePath:r.nodePath,prop:r.prop,frame:p+t*a,offsetFrame:p+t*a-e};return{...t,key:(0,utils_1.calcKeyFrameKey)(t)}}),e=(n.keyFrames.push(...e),exports.animationCtrl.clipsDump.pathsDump[r.nodePath][r.prop].parentPropKey);e&&s[r.nodePath+e]||i.push((0,ipc_event_1.IspacingKeys)(t.currentClip,r.nodePath,r.prop,r.frames,a))}}),(0,ipc_event_1.IApplyOperation)(i),t.selectKeyInfo=n}}}copyKey(t){if(t&&t.frame){var{nodePath:e,prop:r}=t,p=this.clipsDump?.pathsDump[e][r];if(p){var a=[];if(p.partKeys)for(const o of p.partKeys){var s=this.clipsDump.pathsDump[e][o],i=s.keyFrames.find(e=>e.frame===t.frame);i&&a.push({nodePath:e,key:o,type:s.type,displayName:s.displayName,keyframes:[i.curve&&(0,utils_1.transCurveKeyToDumpKey)(i.curve,s.type)||i],_parentType:p.type,postExtrap:s.postExtrap,preExtrap:s.preExtrap,isCurveSupport:s.isCurveSupport})}else{var n=p.keyFrames.find(e=>e.frame===t.frame);n&&a.push({nodePath:e,key:r,type:p.type,displayName:p.displayName,keyframes:[n.curve&&(0,utils_1.transCurveKeyToDumpKey)(n.curve,p.type)||n],postExtrap:p.postExtrap,preExtrap:p.preExtrap,isCurveSupport:p.isCurveSupport})}a.length&&(this.copyKeyInfo={curvesDump:a,leftFrame:t.frame})}}else this.vm.selectKeyInfo&&(r=this.transSelectToCopyKeyInfo()).curvesDump.length&&(this.copyKeyInfo=r)}createKey(e,t){var r=this.vm;e.frame=e.frame??r.currentFrame,(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IcreateKey)(r.currentClip,e.nodePath,e.prop,Number(e.frame),e.value),t)}createKeyBatch(e){const t=this.vm,r=[];e.forEach(e=>{e.frame=e.frame||t.currentFrame,r.push((0,ipc_event_1.IcreateKey)(t.currentClip,e.nodePath,e.prop,Number(e.frame),e.value))}),(0,ipc_event_1.IApplyOperation)(r)}async pasteEmbeddedPlayer(e,t,r){const p=e-t[0].begin,a=[];t.forEach(e=>{e.begin+=p,e.end+=p,e.group=r||e.group,a.push((0,ipc_event_1.addEmbeddedPlayer)(this.vm.currentClip,e))}),await(0,ipc_event_1.IApplyOperation)(a)}pasteKey(r,p){if(p=p||this.copyKeyInfo){const a=[];let e=p.curvesDump;var t;r.prop&&(e=(0,utils_1.pickTargetCurveDump)({nodePath:r.nodePath,prop:r.prop},e,exports.animationCtrl.clipsDump.pathsDump),t=exports.animationCtrl.clipsDump.pathsDump[r.nodePath][r.prop],e.length)&&!t.partKeys&&(t=e[0].keyframes[0].frame,a.push((0,ipc_event_1.IcopyKeys)(this.vm.currentClip,{curvesDump:[e[0]]},{startFrame:r.target+(t-p.leftFrame),nodePath:r.nodePath,propKeys:[r.prop]}))),a.length||e.forEach(e=>{var t;e.keyframes.length&&(t=e.keyframes[0].frame,a.push((0,ipc_event_1.IcopyKeys)(this.vm.currentClip,{curvesDump:[e]},{startFrame:r.target+(t-p.leftFrame),nodePath:r.nodePath,propKeys:[e.key]})))}),(0,ipc_event_1.IApplyOperation)(a)}}transSelectToCopyKeyInfo(){const a=(0,utils_1.sortKeysToTreeMap)(this.vm.selectKeyInfo.keyFrames),s=[];Object.values(a).forEach(e=>{var t=this.clipsDump?.pathsDump[e.nodePath][e.prop];if(t&&t.partKeys)for(const p of t.partKeys){var r=t.nodePath+p;a[r]||(a[r]={prop:p,nodePath:e.nodePath,frames:[],keyFrames:[]}),a[r].frames.push(...e.frames)}}),Object.values(a).forEach(t=>{const r=this.clipsDump?.pathsDump[t.nodePath][t.prop];var e,p;r&&!r.partKeys&&(e=this.clipsDump.pathsDump[t.nodePath][r.parentPropKey],(p=r.keyFrames.filter(e=>t.frames.includes(e.frame)).map(e=>e.curve?(0,utils_1.transCurveKeyToDumpKey)(e.curve,r.type):e)).length)&&s.push({nodePath:t.nodePath,key:t.prop,type:r.type,displayName:r.displayName,keyframes:p,_parentType:e&&e.type,preExtrap:r.preExtrap,postExtrap:r.postExtrap,isCurveSupport:r.isCurveSupport})});let e=this.vm.stickInfo&&this.vm.stickInfo.leftFrame||this.vm.selectKeyInfo.keyFrames[0].frame;return this.vm.selectKeyInfo.offsetFrame&&(e-=this.vm.selectKeyInfo.offsetFrame),{curvesDump:s,leftFrame:e}}async removeKey(t,p=!1){const a=this.vm;if(t){let e=[];Array.isArray(t)?e=t:e.push(t);const i=[];if(e.forEach(e=>{var t,r;"number"!=typeof e.frame&&(e.frame=this.vm.currentFrame),a.selectKeyInfo&&!p&&(t=e.nodePath+e.prop,!(r=a.selectKeyInfo.sortDump||(0,utils_1.sortKeysToTreeMap)(a.selectKeyInfo.keyFrames))[t]||r[t].frames.includes(e.frame))||i.push((0,ipc_event_1.IremoveKey)(a.currentClip,e.nodePath,e.prop,e.frame))}),0<i.length)return void await(0,ipc_event_1.IApplyOperation)(i)}if(a.selectKeyInfo){var e=a.selectKeyInfo.sortDump||(0,utils_1.sortKeysToTreeMap)(a.selectKeyInfo.keyFrames),r=[];for(const n of Object.keys(e)){var s=e[n];r.push((0,ipc_event_1.IremoveKey)(a.currentClip,s.nodePath,s.prop,s.frames))}await(0,ipc_event_1.IApplyOperation)(r)&&(a.selectKeyInfo=null)}}async moveKeys(){var e=this.vm;if(!e.selectKeyInfo)return!1;const p=e.selectKeyInfo["offsetFrame"];if(!(0!==p||global_data_1.Flags.startDragStickInfo&&"center"!==global_data_1.Flags.startDragStickInfo.type||e.selectKeyInfo.ctrl))return!1;var a=[],s=(0,utils_1.changeParentToPart)(e.selectKeyInfo.keyFrames,exports.animationCtrl.clipsDump.pathsDump);if(global_data_1.Flags.startDragStickInfo&&"center"!==global_data_1.Flags.startDragStickInfo.type)for(const i of Object.keys(s)){const n=[],o=[];let t=void 0,r=void 0;s[i].keyFrames.forEach(e=>{(e.offsetFrame||p)&&(n.push(e.rawFrame),o.push(e.offsetFrame??p),t=t||e.nodePath,r=r||e.prop)}),t&&r&&a.push((0,ipc_event_1.ImoveKeys)(e.currentClip,t,r,n,o))}else for(const r of Object.keys(s)){var t=s[r];(t.offsetFrame||p)&&a.push((0,ipc_event_1.ImoveKeys)(e.currentClip,t.nodePath,t.prop,t.frames,t.offsetFrame??p))}return!(0===a.length||!await(0,ipc_event_1.IApplyOperation)(a)&&(e.selectKeyInfo=null,1))}addEvent(e){"number"!=typeof e&&(e=Number(this.vm.currentFrame)),(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IaddEvent)(this.vm.currentClip,e,"",[]))}async deleteEvent(e){var t=this.vm;if(t.selectEventInfo&&!e&&(e=t.selectEventInfo.frames,t.selectEventInfo=null),!e)return!1;var r=[];for(const p of e)r.push((0,ipc_event_1.IdeleteEvent)(t.currentClip,p));return!!await(0,ipc_event_1.IApplyOperation)(r)}copyEvents(t){var e=this.vm;(t=t||e.selectEventInfo&&e.selectEventInfo.frames||[])&&(this.copyEventInfo={eventsDump:this.clipsDump.events.filter(e=>t.includes(e.frame))})}pasteEvent(e,t){var r=this.vm;(t=t||this.copyEventInfo)&&((0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IcopyEvent)(r.currentClip,t,{startFrame:e})),r.selectEventInfo=null)}async moveEvents(){var e,t,r=this.vm;return!!r.selectEventInfo&&({frames:e,offsetFrame:t}=r.selectEventInfo,!!await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.ImoveEvents)(r.currentClip,e,t)))&&(r.selectEventInfo.frames=[...new Set(r.selectEventInfo.data.map(e=>e.frame))],r.selectEventInfo.offsetFrame-=t,!0)}createProp(e,t){var r=[];if(t&&this.vm.selectedIds.size)for(const p of this.vm.selectedIds.values()){if(!this.nodesDump.uuid2path[p])break;r.push((0,ipc_event_1.IcreateProp)(this.vm.currentClip,this.nodesDump.uuid2path[p],e.prop))}else r.push((0,ipc_event_1.IcreateProp)(this.vm.currentClip,e.nodePath||this.vm.computeSelectPath,e.prop));(0,ipc_event_1.IApplyOperation)(r)}async clearPropKeys(e){await checkClearPropData(e.prop)&&(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IclearKeys)(this.vm.currentClip,e.nodePath,e.prop))}async removeProp(e){var t=this.vm;await checkRemoveProp(e.prop)&&((0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IremoveProp)(t.currentClip,e.nodePath,e.prop)),t.selectProperty)&&e.prop===t.selectProperty.prop&&(t.selectProperty=null)}copyProp(t){var e=this.clipsDump?.pathsDump[t.nodePath][t.prop];if(e){const r=[(0,utils_1.propDataToCurveDump)(e)];e.partKeys&&e.partKeys.forEach(e=>{r.push((0,utils_1.propDataToCurveDump)(this.clipsDump.pathsDump[t.nodePath][e]))}),this.copyPropInfo={curvesDump:r}}}pasteProp(r,p){var a=this.vm;if(p=p||this.copyPropInfo,this.copyPropInfo&&r){let t=p.curvesDump.filter(e=>e.type?.value===r.type?.value);if(t.length){var s=exports.animationCtrl.clipsDump.pathsDump[r.nodePath][r.prop];let e=s.partKeys;if(e){const i=t[0],n=exports.animationCtrl.clipsDump.pathsDump[r.nodePath];if(!n[i.key])return;t=n[i.key].partKeys.map(t=>{var e=JSON.parse(JSON.stringify(n[t])),r=p.curvesDump.find(e=>e.key===t)||i;return e.keyFrames=r.keyframes,(0,utils_1.propDataToCurveDump)(e)})}else e=[r.prop],s.parentPropKey&&(s=t.find(e=>e.key===r.prop))&&(t=[s]);(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IcopyProp)(a.currentClip,{curvesDump:t},{nodePath:r.nodePath,propKeys:e}))}else console.warn(Editor.I18n.t("animator.property.can_not_paste_in_current_prop"))}}async clearNodeKeys(e){await checkClearNodeKeys()&&(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IremoveNode)(this.vm.currentClip,e))}moveNodeData(e,t){var r=this.vm;r.moveNodePath&&((0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IchangeNodeDataPath)(r.currentClip,t||r.moveNodePath,e)),r.moveNodePath="",r.selectProperty?.nodePath===(t||r.moveNodePath))&&(r.selectProperty=null)}copyNodeData(e){var t=[];for(const p of e)for(const a of Object.keys(this.clipsDump.pathsDump[p])){var r=this.clipsDump.pathsDump[p][a];t.push((0,utils_1.propDataToCurveDump)(r))}this.copyNodeInfo={curvesDump:t}}pasteNodeData(e,t){(t=t||this.copyNodeInfo)&&e&&(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IcopyNode)(this.vm.currentClip,t,{nodePath:e}))}async clearEmbeddedPlayer(e){return e=e||this.vm.computeSelectPath,(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.clearEmbeddedPlayer)(this.vm.currentClip,e))}async addEmbeddedPlayer(e){e=await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.addEmbeddedPlayer)(this.vm.currentClip,e));return(0,utils_1.multiplyTrackWithTimer)("hippoAnimator",{A100002:1,project_id:Editor.Project.uuid,clip_id:this.vm.currentClip,version:Editor.App.version}),e}async deleteEmbeddedPlayer(e){return(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.deleteEmbeddedPlayer)(this.vm.currentClip,e))}async updateEmbeddedPlayer(e,t){return(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.updateEmbeddedPlayer)(this.vm.currentClip,e,t))}async createAuxKey(e,t,r,p){return(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.createAuxKey)(this.vm.currentClip,e,t??this.vm.currentFrame,r),p)}async removeAuxKey(e,t){return(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.removeAuxKey)(this.vm.currentClip,e,t??this.vm.currentFrame))}async moveAuxKey(e,r){const p=this.vm.currentClip,a=(0,lodash_1.groupBy)(e,e=>e.key);e=Object.keys(a).map(e=>{var t=a[e].reduce((e,t)=>(e.push(t.rawFrame),e),[]);return(0,ipc_event_1.moveAuxKeys)(p,e,t,r)});return(0,ipc_event_1.IApplyOperation)(e)}async copyAuxKey(e,t){return(0,ipc_event_1.IApplyOperation)([(0,ipc_event_1.copyAuxKey)(this.vm.currentClip,e,t)])}clear(){this.__copyPropInfo=null,this.__copyEventInfo=null,this.__copyKeyInfo=null,this.__copyNodeInfo=null}}function T(e,t=""){return Editor.I18n.t("animator."+t+e)}async function checkRemoveProp(e){var t=T;if(1===(await Editor.Dialog.warn(t("is_remove_prop.message"),{title:t("is_remove_prop.title")+`(${e})`,buttons:[t("cancel"),t("is_remove_prop.remove")],default:0,cancel:0})).response)return!0}async function checkClearPropData(e){var t=T;if(1===(await Editor.Dialog.warn(t("is_clear_prop.message"),{title:t("is_clear_prop.title")+`(${e})`,buttons:[t("cancel"),t("is_clear_prop.remove")],default:1,cancel:0})).response)return!0}async function checkClearNodeKeys(){var e=T;if(1===(await Editor.Dialog.warn(e("is_clear_message"),{title:e("is_clear"),buttons:[e("cancel"),e("clear")],default:0,cancel:0})).response)return!0}exports.animationCtrl=new AnimationCtrl;