"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a);var n=Object.getOwnPropertyDescriptor(t,a);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,i,n)}:function(e,t,a,i){e[i=void 0===i?a:i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.listeners=exports.methods=exports.$=exports.template=exports.style=void 0;const lodash_1=require("lodash"),fs_1=require("fs"),path_1=require("path"),VmConfig=__importStar(require("./vm/index")),vue_js_1=__importDefault(require("vue/dist/vue.js")),pinia_1=require("pinia"),ipc_event_1=require("./share/ipc-event"),utils_1=require("./utils"),animation_ctrl_1=require("./share/animation-ctrl"),global_data_1=require("./share/global-data"),animation_editor_1=require("./share/animation-editor"),grid_ctrl_1=require("./share/grid-ctrl"),Utils=__importStar(require("./utils")),pop_menu_1=require("./share/pop-menu");vue_js_1.default.config.productionTip=!Editor.App.dev,vue_js_1.default.config.devtools=!Editor.App.dev,vue_js_1.default.config.silent=!Editor.App.dev,vue_js_1.default.use(pinia_1.PiniaVuePlugin);let panel=null,vm=null;exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../index.css"),"utf8");const vueTemplate=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../static","/template/index.html"),"utf8");function ready(){(panel=this).onChangeNode=(0,lodash_1.throttle)(_onChangeNode.bind(panel),100),this.cancelNodeChange=cancelNodeChange.bind(this),animation_editor_1.animationEditor.panel=panel,initVue(),(Editor.App.dev||Editor.App.args.spectron)&&toggleAnimationEditor()}async function beforeClose(){if(vm&&vm.animationMode){if("animation"!==await(0,ipc_event_1.IquerySceneMode)())return!0;if(this.cancelNodeChange(),!await animation_ctrl_1.animationCtrl.exit())return!1}return!0}function close(){animation_editor_1.animationEditor.close(),vm?.$destroy(),vm=null,panel=null}function toggleAnimationEditor(){window.AnimationEditor=window.AnimationEditor?null:{animationEditor:animation_editor_1.animationEditor,animationCtrl:animation_ctrl_1.animationCtrl,gridCtrl:grid_ctrl_1.gridCtrl,Utils:Utils,menuConfig:pop_menu_1.menuConfig,Test:require((0,path_1.join)(__dirname,"../../test/tools/index.js"))}}function initVue(){animation_editor_1.animationEditor.reset(),animation_ctrl_1.animationCtrl.reset();var e=(0,pinia_1.createPinia)();vm?.$destroy(),vm=new vue_js_1.default({el:panel.$.container,name:"CCAnimator",...VmConfig,template:vueTemplate,pinia:e})}async function _onChangeNode(e,t){var a,i;!panel||panel.hidden||(Editor.App.dev&&console.debug("change-node",e),!vm)||"play"===vm.animationState||vm.animationMode&&"cc.animation.AnimationController"===vm.aniCompType||(vm.animationMode?("cc.SkeletalAnimation"===vm.aniCompType&&animation_editor_1.animationEditor.checkUseBakedAnimationBySkeletalAnimation(),await animation_editor_1.animationEditor.updateClipMenu()):(a=await(0,ipc_event_1.IqueryAnimationRoot)(e),""===vm.selectedId||(i=await(0,ipc_event_1.IqueryAnimationRoot)(vm.selectedId))&&i!==a||global_data_1.Flags.lockUuid||global_data_1.Flags.lockUuid===e||(global_data_1.Flags.lockUuid=e,global_data_1.Flags.lockTimer&&clearTimeout(global_data_1.Flags.lockTimer),await animation_editor_1.animationEditor.updateNode(e),global_data_1.Flags.lockTimer=setTimeout(()=>{global_data_1.Flags.lockUuid=""},600))))}function cancelNodeChange(){this.onChangeNode.cancel()}exports.template=`
    <div class="animator"></div>
`,exports.$={container:".animator"},exports.methods={t:Editor.I18n.t,deleteSelected(){vm&&(vm.selectEventInfo&&animation_ctrl_1.animationCtrl.clipsDump?animation_ctrl_1.animationCtrl.deleteEvent():vm.selectEmbeddedPlayerInfo?animation_editor_1.animationEditor.deleteSelecteEmbeddedPlayers():!animation_editor_1.animationEditor.isLock&&animation_ctrl_1.animationCtrl.clipsDump&&(vm.selectKeyInfo?animation_ctrl_1.animationCtrl.removeKey():vm.selectProperty&&(animation_ctrl_1.animationCtrl.clipsDump.pathsDump[vm.selectProperty.nodePath][vm.selectProperty.prop].parentPropKey?animation_editor_1.animationEditor.showToast("i18n:animator.property.can_not_delete_part_property"):animation_ctrl_1.animationCtrl.removeProp(vm.selectProperty))))},nextStep:animation_editor_1.animationEditor.nextStep.bind(animation_editor_1.animationEditor),prevStep:animation_editor_1.animationEditor.prevStep.bind(animation_editor_1.animationEditor),jumpToNextKey:animation_editor_1.animationEditor.jumpToNextKey.bind(animation_editor_1.animationEditor),jumpToPrevKey:animation_editor_1.animationEditor.jumpToPrevKey.bind(animation_editor_1.animationEditor),jumpFirstFrame:animation_editor_1.animationEditor.jumpFirstFrame.bind(animation_editor_1.animationEditor),jumpLastFrame:animation_editor_1.animationEditor.jumpLastFrame.bind(animation_editor_1.animationEditor),showAllKeys(){vm&&vm.showAllKeys()},showSelectedKeys(){vm&&vm.showSelectedKeys()},copy:animation_editor_1.animationEditor.copy.bind(animation_editor_1.animationEditor),paste:animation_editor_1.animationEditor.paste.bind(animation_editor_1.animationEditor),selectAll(e){if(e){if(e.path&&"INPUT"===e.path[0].tagName)return;e.stopPropagation(),e.preventDefault()}var t;vm&&!animation_editor_1.animationEditor.isLock&&animation_ctrl_1.animationCtrl.clipsDump&&vm.selectProperty&&vm.properties&&(e=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[vm.computeSelectPath][vm.selectProperty.prop].keyFrames.map(e=>({...e,nodePath:vm.computeSelectPath,rawFrame:e.frame,key:Utils.calcKeyFrameKey(e)})),t=(0,utils_1.sortKeysToTreeMap)(e),vm.selectKeyInfo={keyFrames:e,sortDump:t,prop:vm.selectProperty.prop,nodePath:vm.computeSelectPath,location:"prop"})},createKey(){var e,t;vm&&!animation_editor_1.animationEditor.isLock&&vm.selectProperty&&vm.computeSelectPath&&(animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.clipsDump.isLock||({prop:e,nodePath:t}=vm.selectProperty,t===vm.computeSelectPath&&animation_ctrl_1.animationCtrl.createKey({frame:vm.currentFrame,nodePath:t,prop:e})))},playOrPause(){vm&&vm.animationMode&&("stop"===vm.animationState||"pause"===vm.animationState?animation_ctrl_1.animationCtrl.updatePlayState("play"):animation_ctrl_1.animationCtrl.updatePlayState("pause"))},stop(){vm&&vm.animationMode&&animation_ctrl_1.animationCtrl.updatePlayState("stop")},clearSelect(){animation_editor_1.animationEditor.isLock||animation_editor_1.animationEditor.clearSelectData()},changeRecordState(){vm&&vm.currentClip&&vm.active&&(vm.animationMode?(this.cancelNodeChange(),animation_ctrl_1.animationCtrl.exit()):animation_ctrl_1.animationCtrl.enter(vm.currentClip))},"change-debug-mode"(){toggleAnimationEditor()},"asset-db:asset-change"(t,a){if(vm&&Array.isArray(vm.clipsMenu)){let e=!1;for(const i of vm.clipsMenu)if(i.uuid===t){e=!0;break}(e=a&&a.extends?.includes("cc.animation.AnimationGraphLike")?!0:e)&&setTimeout(()=>{vm&&""!==vm.selectedId&&animation_editor_1.animationEditor.updateNode(vm.selectedId)},500)}},async"scene:ready"(){global_data_1.Flags.sceneReady||(global_data_1.Flags.sceneReady=!0,animation_editor_1.animationEditor.refreshTask++,vm&&await animation_editor_1.animationEditor.debounceRefresh())},"scene:close"(){global_data_1.Flags.sceneReady=!1,vm&&(vm.loading="wait_scene_ready"),animation_editor_1.animationEditor.onSceneClose(),this.cancelNodeChange()},async"selection:activated"(e,t){panel&&!panel.hidden&&vm&&"node"===e&&(vm.selectedIds=new Set(t),vm.selectPath="",t.length?(vm.selectedId=t[0],vm.animationMode||await animation_editor_1.animationEditor.debounceUpdateNode(vm.selectedId)):vm.selectedId="")},"scene:change-node"(e,t){global_data_1.Flags.sceneReady&&panel&&panel.onChangeNode(e,t)},"scene:animation-start"(e){vm&&e===vm.root&&!vm.animationMode&&(animation_editor_1.animationEditor.onEnter(),console.debug("scene:animation-start"))},"scene:animation-end"(){global_data_1.Flags.sceneReady=!1,vm&&vm.animationMode&&(vm.animationMode=!1,console.debug("scene:animation-end"))},async"scene:animation-change"(e){panel&&!panel.hidden&&e&&vm&&e===vm.root&&await animation_editor_1.animationEditor.updateClips(vm.currentClip,"update")},"scene:animation-state-change"(e){animation_editor_1.animationEditor.updatePlayState(e)},"scene:change-mode"(e){vm&&(vm.currentSceneMode=e)},async"scene:animation-clip-change"(e){vm&&e!==vm.currentClip&&(await animation_editor_1.animationEditor.updateClips(e),vm.selectKeyInfo=null,vm.selectProperty=null)},async enableEmbeddedPlayer(){vm&&vm.updateEnableEmbeddedPlayer()},async enableAuxiliaryCurve(){vm&&vm.updateAuxCurveEnableState()}},exports.listeners={resize(){global_data_1.Flags.sceneReady&&vm&&(animation_editor_1.animationEditor.updateLayoutConfig(),animation_editor_1.animationEditor.resize())},async show(){global_data_1.Flags.sceneReady&&vm&&await animation_editor_1.animationEditor.debounceRefresh()}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;