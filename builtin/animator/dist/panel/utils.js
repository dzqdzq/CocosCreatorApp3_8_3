"use strict";function smoothScale(e,r){return r=Math.pow(2,.002*e)*r}function initNode(e){e.uuid2path={},e.path2uuid={},e.nodes=[]}function formatNodeDump(e,r="",t=0,a={}){r?(o={path:a.uuid2path[e.uuid]=r,uuid:e.uuid,name:e.name,indent:t,disabled:!1},a.path2uuid[r]?(a.path2uuid[r].push(e.uuid),o.disabled=!0):a.path2uuid[r]=[e.uuid],a.nodes.push(o)):(initNode(a),a.uuid2path[e.uuid]="/",a.path2uuid["/"]=[e.uuid],a.nodes.push({path:"/",uuid:e.uuid,name:e.name,indent:t}));var o,n={name:e.name,children:[],uuid:e.uuid,indent:t,path:r};for(const u of e.children){var p=formatNodeDump(u,r+"/"+u.name,t+2,a);n.children.push(p)}return r||(n.uuid2path=a.uuid2path,n.path2uuid=a.path2uuid,n.nodes=a.nodes,n.path="/",n.rawPath=e.path),n}Object.defineProperty(exports,"__esModule",{value:!0}),exports.multiplyTrackWithTimer=exports.calcEmbeddedPlayerKey=exports.T=exports.propDataToCurveDump=exports.changeParentToPart=exports.pickTargetCurveDump=exports.checkCtrlOrCommand=exports.removeEventListener=exports.addEventListenerOnce=exports.isMenuItem=exports.sortPropertyMenu=exports.checkPropertyInMenu=exports.calcParamPath=exports.sortKeysToTreeMap=exports.sortSelectParams=exports.transFrameByType=exports.transFrameByTypeInGrid=exports.frameToTime=exports.timeToFrame=exports.formatClipDump=exports.transformCurveKeyToDump=exports.transformCtrlKeyToDump=exports.mockDumpToCtrl=exports.transCurveKeyToDumpKey=exports.transDumpKeyToCurveKey=exports.transKeyFrames=exports.calcKeyFrameKey=exports.formatNodeDump=exports.EmbeddedPlayerMenuMap=exports.smoothScale=void 0,exports.smoothScale=smoothScale,exports.EmbeddedPlayerMenuMap={"animation-clip":{label:"i18n:animator.embeddedPlayer.AnimationPlayer",trackLabel:"i18n:animator.embeddedPlayer.AnimationTrack",value:{type:"animation-clip"},icon:"animation",pathPlaceholder:"i18n:animator.embeddedPlayer.nodePathTip"},"particle-system":{label:"i18n:animator.embeddedPlayer.ParticlePlayer",trackLabel:"i18n:animator.embeddedPlayer.ParticleTrack",value:{type:"particle-system"},icon:"particle",pathPlaceholder:"i18n:animator.embeddedPlayer.particlePathTip"}},exports.formatNodeDump=formatNodeDump;const animCompRE=/Animation/;function calcKeyFrameKey(e){let r=e.frame+e.prop+e.x;return e.nodePath&&(r+=e.nodePath),e.value&&(r+=e.value),r}function transKeyFrames(e,r,t){return e.map(e=>{e={frame:e.frame,prop:r,dump:{type:e.dump.type,value:e.dump.value},x:0,curve:t?transDumpKeyToCurveKey(e):null};return{...e,key:calcKeyFrameKey(e)}})}function transDumpKeyToCurveKey(e){return e.dump&&"number"==typeof e.dump.value?{inTangent:e.inTangent,outTangent:e.outTangent,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight,interpMode:e.interpMode,tangentWeightMode:e.tangentWeightMode,easingMethod:e.easingMethod,point:{x:e.frame,y:Number(e.dump.value)}}:null}function transCurveKeyToDumpKey(e,r){return{inTangent:e.inTangent,outTangent:e.outTangent,interpMode:e.interpMode,tangentWeightMode:e.tangentWeightMode,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight,frame:Math.round(e.point.x),easingMethod:e.easingMethod,broken:e.broken,dump:{value:e.point.y,type:r}}}function mockDumpToCtrl(e){return{key:transDumpKeyToCurveKey(e)}}function transformCtrlKeyToDump(e,r){return e.map(e=>transCurveKeyToDumpKey(e.key,r))}function transformCurveKeyToDump(e,r){return e.map(e=>transCurveKeyToDumpKey(e,r))}function formatClipDump(e){var r={...e};const t={},a=(r.curves.forEach(e=>{t[e.nodePath]||(t[e.nodePath]={});var r=JSON.parse(JSON.stringify(e));r.keyFrames=transKeyFrames(r.keyframes,r.key,r.isCurveSupport),r.propOpts=r.opts,r.prop=r.key,r.curve=r.isCurveSupport,delete r.opts,delete r.keyframes,delete r.key,t[e.nodePath][e.key]=r}),r.pathsDump=t,r.embeddedPlayers||(r.embeddedPlayers=[]),r.embeddedPlayerGroups||(r.embeddedPlayerGroups=[]),{});return r.embeddedPlayers.forEach(e=>{a[e.group]||(a[e.group]=[]),e.playable||(console.error("no playable in animation clip"),e.playable={type:"animation-clip"}),a[e.group].push(e)}),r.groupToEmbeddedPlayers=a,r.displayAuxiliaryCurves=Object.values(e.auxiliaryCurves).map(e=>{var r=transKeyFrames(e.keyframes,e.displayName,!0);return{...e,keyframes:r}}),r}function timeToFrame(e,r){return Math.round(e*r)}function frameToTime(e,r){return e/r}function transFrameByTypeInGrid(e,r="frame",t=60){if("frame"===r)return e+"";switch(r){case"time_s":var a=getRightNum(e/t);return 60<a?Math.floor(a/60)+`m${getRightNum(a%60)}s`:a+"s";case"time":return e%t;default:return e+""}}function transFrameByType(t,e="frame",a=60){if("frame"===e)return t+"";switch(e){case"time":{let e="";var o=Math.floor(Math.log10(a))+1;t<0&&(e="-",t=-t);let r=(t%a).toString();return 0<(o-=r.length)&&(r=new Array(1+o).join("0")+r),e+Math.floor(t/a)+"-"+r}case"time_s":o=getRightNum(t/a);return 60<o?Math.floor(o/60)+`m${getRightNum(o%60)}s`:o+"s";default:return t+""}}function getRightNum(e){return Number(e.toFixed(2))}function sortSelectParams(e,r){const t={};for(const o of e){var a;o&&((a=r&&r[o.prop])&&(a.partKeys&&a.partKeys.forEach(e=>{addInfoToProp(t,{...o,prop:e})}),a.parentPropKey)&&addInfoToProp(t,{...o,prop:a.parentPropKey}),addInfoToProp(t,o))}return t}function sortKeysToTreeMap(e){var r,t={};for(const a of e)a&&(t[r=a.nodePath+a.prop]?(t[r].frames.push(a.rawFrame),t[r].keyFrames.push(a)):t[r]={prop:a.prop,nodePath:a.nodePath,frames:[a.rawFrame],keyFrames:[a],offsetFrame:a.offsetFrame});return t}function addInfoToProp(e,r){var t=r.nodePath+r.prop;e[t]?e[t].frames.includes(r.rawFrame)||(e[t].frames.push(r.rawFrame),e[t].keyFrames.push(r)):e[t]={prop:r.prop,nodePath:r.nodePath,frames:[r.rawFrame],keyFrames:[r],offsetFrame:r.offsetFrame}}function calcParamPath(e){let r;return r=e[1]?"path_"+e[0]+e[1]:"path_"+e[0]}function checkPropertyInMenu(r,e){return!!r&&-1!==e.findIndex(e=>r.prop===e.key)}function sortPropertyMenu(e,r){const t=Object.create(null),a=(r=r||[],Object.keys(r));return(e=JSON.parse(JSON.stringify(e))).forEach(e=>{var r;("eulerAngles"===e.key||"rotation"===e.key)&&(a.includes("eulerAngles")||a.includes("rotation"))||a.includes(e.key)?e.disable=!0:e.disable=!1,e.category?(r=e.menuName||e.displayName,setMenuItem(t,e.category+"/"+r,e)):t[e.name]=e}),t}function isMenuItem(e){return e.key&&"string"==typeof e.key}function setMenuItem(e,r,t){const a=r.split("/");let o=e;a.forEach((e,r)=>{r===a.length-1?(isMenuItem(o)&&(r=JSON.parse(JSON.stringify(o)),o._self=r,Object.keys(o).forEach(e=>{"_self"!==e&&delete o[e]})),o[e]=t):o=(null!==o[e]&&void 0!==o[e]||(o[e]=Object.create(null)),o[e])})}function addEventListenerOnce(e,r,t){e&&!t.hasBind&&r&&(e.addEventListener(r,t),t.hasBind=!0)}function removeEventListener(e,r,t){e&&r&&(e.removeEventListener(r,t),t.hasBind=!1)}function checkCtrlOrCommand(e){return!!e&&("win32"===process.platform?e.ctrlKey:e.metaKey)}function pickTargetCurveDump(r,e,t){if(!e||!t[r.nodePath][r.prop])return[];var a=t[r.nodePath][r.prop];const o=a.type;let n=[];if(a.partKeys){const p=a.partKeys.map(e=>t[r.nodePath][e]);e.forEach(r=>{r._parentType&&r._parentType.value===o.value&&p.find(e=>e.displayName===r.displayName)&&r.keyframes.length&&n.push(r)})}else for(const u of e)if(!(o&&u.type&&u.type.value!==o.value||!u.keyframes.length)&&(n=[u],u.key===a.prop))break;return n}function changeParentToPart(e,t){if(!e.length)return{};if(1===e.length)return sortKeysToTreeMap(e);const a={};return e.forEach(r=>{var e=t[r.nodePath][r.prop];e&&e.partKeys?e.partKeys.forEach(e=>{var e=t[r.nodePath][e];e.keyFrames.find(e=>e.frame===r.rawFrame)&&(e=a[e.prop+r.frame],e=r.offsetFrame||e&&e.offsetFrame||r.frame-r.rawFrame,a[r.key]={...r,offsetFrame:e})}):(e=a[e.prop+r.frame],e=r.offsetFrame||e&&e.offsetFrame||r.frame-r.rawFrame,a[r.key]={...r,offsetFrame:e})}),sortKeysToTreeMap(Object.values(a))}function propDataToCurveDump(r){var e=r.keyFrames.map(e=>e.curve&&transCurveKeyToDumpKey(e.curve,r.type)||e);return{nodePath:r.nodePath,keyframes:e,displayName:r.displayName,key:r.prop,type:r.type,postExtrap:r.postExtrap,preExtrap:r.preExtrap,isCurveSupport:r.isCurveSupport}}function T(e,r=""){return Editor.I18n.t("animator."+r+e)}function calcEmbeddedPlayerKey(e){return`begin:${e.begin},end:${e.end},player:${e.playable?.type},group:${e.group},displayName:`+e.displayName}function multiplyTrackWithTimer(e,r){for(const t in r)Editor.Metrics._trackEventWithTimer({category:e,id:t,value:r[t]})}exports.calcKeyFrameKey=calcKeyFrameKey,exports.transKeyFrames=transKeyFrames,exports.transDumpKeyToCurveKey=transDumpKeyToCurveKey,exports.transCurveKeyToDumpKey=transCurveKeyToDumpKey,exports.mockDumpToCtrl=mockDumpToCtrl,exports.transformCtrlKeyToDump=transformCtrlKeyToDump,exports.transformCurveKeyToDump=transformCurveKeyToDump,exports.formatClipDump=formatClipDump,exports.timeToFrame=timeToFrame,exports.frameToTime=frameToTime,exports.transFrameByTypeInGrid=transFrameByTypeInGrid,exports.transFrameByType=transFrameByType,exports.sortSelectParams=sortSelectParams,exports.sortKeysToTreeMap=sortKeysToTreeMap,exports.calcParamPath=calcParamPath,exports.checkPropertyInMenu=checkPropertyInMenu,exports.sortPropertyMenu=sortPropertyMenu,exports.isMenuItem=isMenuItem,exports.addEventListenerOnce=addEventListenerOnce,exports.removeEventListener=removeEventListener,exports.checkCtrlOrCommand=checkCtrlOrCommand,exports.pickTargetCurveDump=pickTargetCurveDump,exports.changeParentToPart=changeParentToPart,exports.propDataToCurveDump=propDataToCurveDump,exports.T=T,exports.calcEmbeddedPlayerKey=calcEmbeddedPlayerKey,exports.multiplyTrackWithTimer=multiplyTrackWithTimer;