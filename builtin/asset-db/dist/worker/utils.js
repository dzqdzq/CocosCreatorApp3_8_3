"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){e[i=void 0===i?r:i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.transI18nName=exports.ensureOutputData=exports.serializeCompiled=exports.getRawInstanceFromImportFile=exports.serializeCompiledWithInstance=exports.moveFile=exports.removeFile=exports.decidePromiseState=exports.PROMISE_STATE=exports.tranAssetInfo=exports.getExtendsFromCCType=exports.libArr2Obj=exports.url2uuid=exports.getMemorySize=exports.url2path=void 0;const asset_db_1=require("@editor/asset-db"),path_1=require("path"),fs_extra_1=require("fs-extra"),EditorExtends=require("@base/electron-module").require("EditorExtends");function url2path(t){if((0,path_1.isAbsolute)(t))return t;if(t.startsWith("db://"))return(0,asset_db_1.queryPath)(t);if(t.startsWith("packages"))try{var e=t.match(/packages:\/\/([^/]*)\/(.*)$/),r=Editor.Package.getPackages({name:e[1]});return(0,path_1.join)(r[0].path,e[2])}catch(e){console.warn("Invalid package url "+t)}return Editor.UI.__protected__.File.resolveToRaw(t)}function getMemorySize(){var e=process.memoryUsage();function t(e){return(e/1024/1024).toFixed(2)+"MB"}return"Process: heapTotal "+t(e.heapTotal)+" heapUsed "+t(e.heapUsed)+" rss "+t(e.rss)}function url2uuid(e){const r=[];let t=e,i="";for(;!(i=(0,asset_db_1.queryUUID)(t))&&"db:/"!==t;)t=t.replace(/\/([^/]*)$/,(e,t)=>(r.splice(0,0,asset_db_1.Utils.nameToId(t)),""));return!i||!(e=(0,asset_db_1.queryAsset)(t))||e.isDirectory()&&0<r.length?t="":(t=e.uuid,0<r.length&&(t+="@"+r.join("@"))),t}exports.url2path=url2path,exports.getMemorySize=getMemorySize,exports.url2uuid=url2uuid;const extnameRex=/^\./;function isExtname(e){return""===e||extnameRex.test(e)}function libArr2Obj(e){var t={};for(const r of e.meta.files)isExtname(r)?t[r]=e.library+r:t[r]=(0,path_1.resolve)(e.library,r);return t}function getExtendsFromCCType(e){if(!e||"cc.Asset"===e)return[];let t=cc.js.getSuper(cc.js.getClassByName(e));var r=[];let i=cc.js.getClassName(t);for(;i&&"cc.Asset"!==r[r.length-1];)r.push(i),t=cc.js.getSuper(t),i=cc.js.getClassName(t);return r}function tranAssetInfo(e){return{file:e.source,uuid:e.uuid,library:libArr2Obj(e),importer:e.meta.importer}}function decidePromiseState(e){const t={name:"test"};return Promise.race([e,t]).then(e=>e===t?exports.PROMISE_STATE.PENDING:exports.PROMISE_STATE.FULFILLED).catch(()=>exports.PROMISE_STATE.REJECTED)}async function removeFile(t){if((0,fs_extra_1.existsSync)(t)){try{await Editor.Utils.File.trashItem(t)}catch(e){console.error(`asset db removeFile ${t} fail!`),console.error(e)}try{var e=t+".meta";(0,fs_extra_1.existsSync)(e)&&await Editor.Utils.File.trashItem(e)}catch(e){}}}async function moveFile(t,r,e){if((0,fs_extra_1.existsSync)(t)&&(0,fs_extra_1.existsSync)(t+".meta")){if(!e){if((0,fs_extra_1.existsSync)(r)||(0,fs_extra_1.existsSync)(r+".meta"))return;e={overwrite:!1}}var i=(0,path_1.join)(Editor.Project.tmpDir,"asset-db","move-temp"),s=(0,path_1.relative)(Editor.Project.path,r);try{Editor.Utils.Path.contains(t,r)?(await(0,fs_extra_1.remove)((0,path_1.join)(i,s)),await(0,fs_extra_1.remove)((0,path_1.join)(i,s)+".meta"),await(0,fs_extra_1.move)(t+".meta",(0,path_1.join)(i,s)+".meta",{overwrite:!0}),await(0,fs_extra_1.move)(t,(0,path_1.join)(i,s),{overwrite:!0}),await(0,fs_extra_1.move)((0,path_1.join)(i,s)+".meta",r+".meta",{overwrite:!0}),await(0,fs_extra_1.move)((0,path_1.join)(i,s),r,e)):(await(0,fs_extra_1.move)(t+".meta",r+".meta",{overwrite:!0}),await(0,fs_extra_1.move)(t,r,e))}catch(e){console.error(`asset db moveFile from ${t} -> ${r} fail!`),console.error(e)}}}exports.libArr2Obj=libArr2Obj,exports.getExtendsFromCCType=getExtendsFromCCType,exports.tranAssetInfo=tranAssetInfo,exports.PROMISE_STATE={PENDING:"pending",FULFILLED:"fulfilled",REJECTED:"rejected"},exports.decidePromiseState=decidePromiseState,exports.removeFile=removeFile,exports.moveFile=moveFile;const defaultSerializeOptions={compressUuid:!0,stringify:!1,dontStripDefault:!1,useCCON:!1,keepNodeUuid:!1};function serializeCompiledWithInstance(e,t){return e?EditorExtends.serializeCompiled(e,Object.assign(defaultSerializeOptions,{compressUuid:!t.debug,useCCON:t.useCCONB,noNativeDep:!e._native})):null}async function getRawInstanceFromImportFile(e,t){var e=e.endsWith(".json")?await(0,fs_extra_1.readJSON)(e):await transformCCON(e),r={asset:null,detail:null},i=(await Promise.resolve().then(()=>__importStar(require("cc"))))["deserialize"],s=new i.Details,a=(s.reset(),EditorExtends.MissingReporter.classInstance),i=i(e,s,{createAssetRefs:!(a.hasMissingClass=!1),ignoreEditorOnly:!0,classFinder:a.classFinder});if(!i)return console.error(Editor.I18n.t("builder.error.deserialize_failed",{url:`{asset(${t.url})}`})),r;i._uuid=t.uuid,a.reset(),r.asset=i,r.detail=s}async function transformCCON(e){var e=await(0,fs_extra_1.readFile)(e),e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),t=(await Promise.resolve().then(()=>__importStar(require("cc/editor/serialization"))))["decodeCCONBinary"];return t(e)}async function serializeCompiled(e,t){e=await getRawInstanceFromImportFile(ensureOutputData(e).import.path,{uuid:e.uuid,url:e.url});return null!=e&&e.asset?serializeCompiledWithInstance(e.asset,t):null}function ensureOutputData(t){let r=t.getData("output");if(!r){r={import:{type:"json",path:t.library+".json"}};const i={};t.meta.files.forEach(e=>{[".json",".cconb"].includes(e)?(r.import.path=t.library+e,".cconb"===e&&(r.import.type="buffer")):e.startsWith(".___")||(i[e]=t.library+e)}),Object.keys(i).length&&(r.native=i),t.setData("output",r)}return r}function transI18nName(e){return"string"!=typeof e?"":e.startsWith("i18n:")&&(e=e.replace("i18n:",""),Editor.I18n.t(e)||console.debug(e+" is not defined in i18n"),Editor.I18n.t(e))||e}exports.serializeCompiledWithInstance=serializeCompiledWithInstance,exports.getRawInstanceFromImportFile=getRawInstanceFromImportFile,exports.serializeCompiled=serializeCompiled,exports.ensureOutputData=ensureOutputData,exports.transI18nName=transI18nName;