"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.setAutoRefresh=exports.refreshAllDatabase=exports.isReady=exports.getWorker=exports.depend=exports.autoRefresh=void 0;const path_1=require("path"),electron_worker_1=__importDefault(require("@base/electron-worker")),electron_windows_1=__importDefault(require("@base/electron-windows")),vDependence=require("v-dependence");let ready=!1;function getWorker(){return databaseWorker}function isReady(){return ready}exports.autoRefresh=!0,exports.depend=vDependence.create(),exports.getWorker=getWorker,exports.isReady=isReady;let databaseWorker=null,engineInfo,hasBindEvent=(exports.depend.add("editor-init",{depends:[],async handle(){},async reset(){}}),exports.depend.add("engine-info",{depends:[],async handle(){engineInfo=await Editor.Message.request("engine","query-engine-info"),exports.depend.finish("engine-info")},async reset(){}}),exports.depend.add("worker-init",{depends:[],async handle(){Editor.Metrics.trackTimeStart("asset-db:ready"),exports.autoRefresh=await Editor.Profile.getConfig("asset-db","autoScan");const e=electron_worker_1.default.create("Assets");setTimeout(()=>{Editor.App.args.debugAssets&&e.debug(!0)});var r=require("@editor/creator").getPreloadFilePath();await e.init({preload:r}),e.require((0,path_1.join)(__dirname,"../../worker/index")),e.on("refresh",()=>{exports.depend.reset("worker-init")}),e.on("closed",()=>{exports.depend.reset("worker-init")}),e.ipc.on("asset-worker:startup",()=>{databaseWorker=e,exports.depend.finish("worker-init")})},async reset(){databaseWorker=null}}),exports.depend.add("asset-worker-init",{depends:["engine-info","worker-init"],async handle(){await databaseWorker.send("asset-worker:init",{engine:engineInfo.typescript.path,type:Editor.Project.__protected__.type,dist:(0,path_1.join)(__dirname,"../../../dist")}),exports.depend.finish("asset-worker-init")},async reset(){}}),!1),refreshALlDatabaseTimer=(exports.depend.add("asset-db-ready",{depends:["asset-worker-init"],async handle(){ready=!0,Editor.Logger.__protected__.record("asset-db is ready!"),console.debug("asset-db is ready!"),!1===hasBindEvent&&(hasBindEvent=!0,electron_windows_1.default.on("blur",()=>{}),electron_windows_1.default.on("focus",()=>{exports.autoRefresh&&refreshAllDatabase()}))},async reset(){ready=!1,Editor.Message.broadcast("asset-db:close")}}),null);function refreshAllDatabase(){refreshALlDatabaseTimer&&clearTimeout(refreshALlDatabaseTimer),refreshALlDatabaseTimer=setTimeout(()=>{databaseWorker&&databaseWorker.send("asset-worker:refresh-all-database").then(()=>{})},100)}function setAutoRefresh(e){exports.autoRefresh=e}exports.refreshAllDatabase=refreshAllDatabase,exports.setAutoRefresh=setAutoRefresh;