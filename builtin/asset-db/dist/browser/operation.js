"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.initAsset=exports.removeAsset=exports.refreshAllEffect=exports.refreshAsset=exports.queryAllAssetTypes=exports.queryAllImporter=exports.reimportAsset=exports.saveAssetMeta=exports.saveAsset=exports.deleteAsset=exports.moveAsset=exports.renameAsset=exports.copyAsset=exports.importAsset=exports.newAsset=exports.createAsset=exports.generateAvailableURL=exports.zip=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("./utils"),index_1=require("./worker/index");function zip(e,t){var r=require("archiver"),e=(0,fs_extra_1.createWriteStream)(e);const a=r("zip");a.on("error",e=>{throw e}),a.pipe(e),t.forEach(e=>{var t=(0,path_1.parse)(e);a.append((0,fs_extra_1.createReadStream)(e),{name:t.ext.substr(1)})}),a.finalize()}async function generateAvailableURL(e){if(!e||"string"!=typeof e)throw new Error(Editor.I18n.t("asset-db.operation.invalid_url"));var t=await(0,index_1.forwarding)("asset-worker:generate-available-url",e);if(t)return t;throw new Error(Editor.I18n.t("asset-db.operation.exists_url")+`
  url: `+e)}function checkURL(e){if(!e||"string"!=typeof e||!e.startsWith("db://"))throw new Error(Editor.I18n.t("asset-db.operation.invalid_url")+` 
  url: `+e)}async function checkReadonly(e){if(await(0,utils_1.isReadonly)(e))throw new Error(Editor.I18n.t("asset-db.operation.readonly")+` 
  url: `+e)}async function generateURL(t){try{return await generateAvailableURL(t)}catch(e){throw new Error(Editor.I18n.t("asset-db.operation.exists_url")+` 
  url: `+t)}}async function queryUUID(e){if(!e.startsWith("db://"))return e;let t;try{t=await(0,index_1.forwarding)("asset-worker:query-uuid",e||"")}catch(e){}return t||null}async function handleAssetOption(e,t){return(t=t||{}).overwrite?"overwrite":t.rename?"rename":0===(t=await Editor.Dialog.warn(Editor.I18n.t("asset-db.operation.overwrite"),{title:Editor.I18n.t("asset-db.operate.dialogQuestion"),detail:e,buttons:[Editor.I18n.t("asset-db.operate.overwrite"),Editor.I18n.t("asset-db.operate.rename"),Editor.I18n.t("asset-db.operate.cancel")],default:0,cancel:2})).response?"overwrite":1===t.response?"rename":"cancel"}async function createAsset(e,t,r){checkURL(e),await checkReadonly((0,path_1.dirname)(e));var a=await generateURL(e);if(a!==e){r=await handleAssetOption(e,r);if("rename"===r)e=a;else if("cancel"===r)return null}a=await(0,index_1.forwarding)("asset-worker:query-path",e);if(null!=t?await(0,fs_extra_1.outputFile)(a,t):await(0,fs_extra_1.ensureDir)(a),await refreshAsset(a),!(0,fs_extra_1.existsSync)(a))throw new Error(""+Editor.I18n.t("asset-db.createAsset.fail.drop",{target:a}));(0,utils_1.metricCreateAsset)(a);r=await queryUUID(e);return r?(0,index_1.forwarding)("asset-worker:query-asset-info",r):(console.warn(""+Editor.I18n.t("asset-db.createAsset.fail.uuid",{target:e})),null)}async function newAsset(e){}async function importAsset(t,r,e){checkURL(r),await checkReadonly((0,path_1.dirname)(r));var a=await generateURL(r);if(r!==a){e=await handleAssetOption(r,e);if("rename"===e)r=a;else if("cancel"===e)return null}try{var s=await(0,index_1.forwarding)("asset-worker:query-path",r);if(await(0,fs_extra_1.copy)(t,s,{overwrite:!0}),s.endsWith(".meta")){const t=s.replace(".meta","");if(await(0,index_1.forwarding)("asset-worker:query-path",t)){await refreshAsset(s);const c=await queryUUID(r);return c?await(0,index_1.forwarding)("asset-worker:query-asset-info",c):null}return null}var i,n=t+".meta",o=s+".meta";(0,fs_extra_1.existsSync)(n)&&(!1===(i=await Editor.Profile.getConfig("asset-db","autoOverwriteMeta"))&&(0,fs_extra_1.existsSync)(o)&&console.log(Editor.I18n.t("asset-db.importAsset.metaExists",{name:t})),await(0,utils_1.isLegalMetaFile)(n))&&await(0,fs_extra_1.copy)(n,o,{overwrite:i}),await refreshAsset(s)}catch(e){return console.error(`Import asset form ${t} -> ${r} failed!`),console.error(e),null}const c=await queryUUID(r);return c?await(0,index_1.forwarding)("asset-worker:query-asset-info",c):null}async function copyAsset(e,t,r){checkURL(e),checkURL(t),await checkReadonly((0,path_1.dirname)(t));var a={source:await(0,index_1.forwarding)("asset-worker:query-path",e),target:await(0,index_1.forwarding)("asset-worker:query-path",t)};if(!a.source||!(0,fs_extra_1.existsSync)(a.source))throw new Error(Editor.I18n.t("asset-db.copyAsset.fail.source")+` 
source: `+e);if(Editor.Utils.Path.contains(a.target,a.source))throw new Error(Editor.I18n.t("asset-db.copyAsset.fail.include")+` 
source: ${e}
target: `+t);let s=await generateURL(t);if(t!==s){e=await handleAssetOption(t,r);if("rename"===e)a.target=await(0,index_1.forwarding)("asset-worker:query-path",s);else{if("cancel"===e)return null;s=t}}r=a.source+".meta",e=a.target+".meta",(0,fs_extra_1.existsSync)(r)&&await(0,utils_1.isLegalMetaFile)(r)&&(await(0,fs_extra_1.copy)(r,e),await(0,utils_1.changeMetaUuid)(e)),await(0,fs_extra_1.copy)(a.source,a.target),await(0,utils_1.changeMetaUuid)(a.target),await refreshAsset(a.target),r=await queryUUID(s);return r?(0,index_1.forwarding)("asset-worker:query-asset-info",r):(console.warn(""+Editor.I18n.t("asset-db.createAsset.fail.uuid",{target:t})),null)}async function renameAsset(e,t,r){checkURL(e),checkURL(t),await checkReadonly((0,path_1.dirname)(e)),await checkReadonly((0,path_1.dirname)(t));var a={source:await(0,index_1.forwarding)("asset-worker:query-path",e),target:await(0,index_1.forwarding)("asset-worker:query-path",t)};if(!a.source||!(0,fs_extra_1.existsSync)(a.source))throw new Error(Editor.I18n.t("asset-db.renameAsset.fail.source")+` 
source: `+e);var s=await generateURL(t);if(e.toLowerCase()===t.toLowerCase()&&t!==s)return(0,index_1.forwarding)("asset-worker:rename-asset",a.source,a.target,r);if(a.target.startsWith((0,path_1.join)(a.source,"/")))throw new Error(Editor.I18n.t("asset-db.renameAsset.fail.parent")+` 
source: ${e}
target: `+t);if(t!==s){e=await handleAssetOption(t,r);if("rename"===e)a.target=await(0,index_1.forwarding)("asset-worker:query-path",s);else if("cancel"===e)return null}return(r=r||{}).overwrite=!0,(0,path_1.dirname)(a.target)!==(0,path_1.dirname)(a.source)?(0,index_1.forwarding)("asset-worker:move-asset",a.source,a.target,r):(0,index_1.forwarding)("asset-worker:rename-asset",a.source,a.target,r)}async function moveAsset(e,t,r){checkURL(e),checkURL(t),await checkReadonly((0,path_1.dirname)(e)),await checkReadonly((0,path_1.dirname)(t));var a={source:await(0,index_1.forwarding)("asset-worker:query-path",e),target:await(0,index_1.forwarding)("asset-worker:query-path",t)};if(!a.source||!(0,fs_extra_1.existsSync)(a.source))throw new Error(Editor.I18n.t("asset-db.moveAsset.fail.source")+` 
source: `+e);var s=await generateURL(t);if(e.toLowerCase()===t.toLowerCase()&&t!==s)return(0,index_1.forwarding)("asset-worker:rename-asset",a.source,a.target);if(a.target.startsWith((0,path_1.join)(a.source,"/")))throw new Error(Editor.I18n.t("asset-db.moveAsset.fail.parent")+` 
source: ${e}
target: `+t);if(t!==s){e=await handleAssetOption(t,r);if("rename"===e)a.target=await(0,index_1.forwarding)("asset-worker:query-path",s);else if("cancel"===e)return null}return(r=r||{}).overwrite=!0,(0,index_1.forwarding)("asset-worker:move-asset",a.source,a.target,r)}async function deleteAsset(e){let t=e;var r;if(t=Editor.Utils.UUID.isUUID(t)?t:await(0,index_1.forwarding)("asset-worker:query-uuid",e))return r=await removeAsset((e=await(0,index_1.forwarding)("asset-worker:query-asset-info",t)).file),Editor.Selection.unselect("asset",t),r?e:null;throw new Error(Editor.I18n.t("asset-db.deleteAsset.fail.unexist")+` 
source: `+t)}async function saveAsset(e,t){var r=await queryUUID(e);if(await checkReadonly(e),void 0===t)throw new Error(""+Editor.I18n.t("asset-db.saveAsset.fail.content"));if(r)return"gltf-material"===(e=await(0,index_1.forwarding)("asset-worker:query-asset-info",r)).importer&&"cc.Material"===e.type?await saveInternalMaterialToMeta(r,t):await(0,fs_extra_1.outputFile)(e.file,t),await refreshAsset(e.file),e;throw new Error(Editor.I18n.t("asset-db.saveAsset.fail.uuid")+` 
`+r)}async function saveInternalMaterialToMeta(t,e){var[r,,]=t.split("@");if(await checkReadonly(r),!e||"string"!=typeof e&&Buffer.isBuffer(e))throw new Error(""+Editor.I18n.t("asset-db.saveAssetMeta.fail.content"));var a=await(0,index_1.forwarding)("asset-worker:query-asset-meta",r);a.userData.materials&&"object"==typeof a.userData.materials||(a.userData.materials={});try{a.userData.materials[t]=JSON.parse(e),await saveAssetMeta(r,JSON.stringify(a))}catch(e){console.error(`Save materials({asset(${t})} data to fbx {asset(${r})} failed!`),console.error(e)}}async function saveAssetMeta(e,t){var r=await queryUUID(e);if(await checkReadonly(e),!t||"string"!=typeof t&&Buffer.isBuffer(t))throw new Error(""+Editor.I18n.t("asset-db.saveAssetMeta.fail.content"));e=await(0,index_1.forwarding)("asset-worker:query-asset-info",r);return await(0,index_1.forwarding)("asset-worker:save-asset-meta",r,t)||console.warn(""+Editor.I18n.t("asset-db.saveAssetMeta.fail.content")),e}async function reimportAsset(e){return(0,index_1.forwarding)("asset-worker:reimport-asset",e)}async function queryAllImporter(){return(0,index_1.forwarding)("asset-worker:query-all-importer")}async function queryAllAssetTypes(){return(0,index_1.forwarding)("asset-worker:query-all-asset-types")}async function refreshAsset(e){return(0,index_1.forwarding)("asset-worker:refresh-asset",e)}async function refreshAllEffect(){return(0,index_1.forwarding)("asset-worker:refresh-all-effect")}async function removeAsset(e){return(0,index_1.forwarding)("asset-worker:remove-asset",e)}async function initAsset(e,t){const r=await(0,index_1.forwarding)("asset-worker:query-asset-info",e);if(!r)return console.warn(Editor.I18n.t("asset-db.saveAsset.fail.uuid")+` 
{asset(${e})}`),null;if(!t||"string"!=typeof t||!t.startsWith("db://"))return console.warn(Editor.I18n.t("asset-db.copyAsset.fail.url")+` 
target: {asset(${t})}`),null;var t=await(0,index_1.forwarding)("asset-worker:query-path",t),a=(0,path_1.parse)(r.name),s=Object.keys(r.library).map(e=>r.library[e]);if(!s||0===s.length)return console.warn(`Unable to instantiate resource 
uuid: `+e),null;try{var i=(0,path_1.join)(t,a.name+r.instantiation);if(zip(i,s),await refreshAsset(i),!(0,fs_extra_1.existsSync)(i))throw new Error(""+Editor.I18n.t("asset-db.createAsset.fail.drop",{target:i}));const e=await queryUUID(i);return e?await(0,index_1.forwarding)("asset-worker:query-asset-info",e):null}catch(e){return console.error(e),null}}exports.zip=zip,exports.generateAvailableURL=generateAvailableURL,exports.createAsset=createAsset,exports.newAsset=newAsset,exports.importAsset=importAsset,exports.copyAsset=copyAsset,exports.renameAsset=renameAsset,exports.moveAsset=moveAsset,exports.deleteAsset=deleteAsset,exports.saveAsset=saveAsset,exports.saveAssetMeta=saveAssetMeta,exports.reimportAsset=reimportAsset,exports.queryAllImporter=queryAllImporter,exports.queryAllAssetTypes=queryAllAssetTypes,exports.refreshAsset=refreshAsset,exports.refreshAllEffect=refreshAllEffect,exports.removeAsset=removeAsset,exports.initAsset=initAsset;