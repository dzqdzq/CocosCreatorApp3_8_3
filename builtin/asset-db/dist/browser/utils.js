"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.formatCreateMenu=exports.metricCreateAsset=exports.isLegalMetaFile=exports.changeMetaUuid=exports.isReadonly=exports.getName=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("./worker/index"),asset_config_1=require("./asset-config"),v4=require("node-uuid")["v4"];function getName(e){if(!(0,fs_extra_1.existsSync)(e))return e;var t=(0,path_1.dirname)(e),r=(0,path_1.extname)(e);let a=(0,path_1.basename)(e,r);for(;/-\d{3}/.test(a)?a=a.replace(/(-(\d{3})$)/,(e,t,r)=>{let a=parseInt(r,10);return"-"+(a=(a+=1).toString().padStart(3,"0"))}):a+="-001",e=(0,path_1.join)(t,a),(0,fs_extra_1.existsSync)(e+r););return e+r}async function isReadonly(e){return!(e=e.startsWith("db://")?e:await(0,index_1.forwarding)("asset-worker:query-url",e))||(e=await(0,index_1.forwarding)("asset-worker:query-db-info",e))&&e.readonly||!1}async function changeMetaUuid(e){var t=(0,fs_extra_1.statSync)(e);if(t.isDirectory())for(const a of await(0,fs_extra_1.readdir)(e))await changeMetaUuid((0,path_1.join)(e,a));else if((0,fs_extra_1.existsSync)(e)&&e.endsWith(".meta"))try{var r=await(0,fs_extra_1.readJson)(e);r.uuid=v4(),await(0,fs_extra_1.outputJson)(e,r)}catch(e){console.warn(""+Editor.I18n.t("asset-db.copyAsset.fail.metauuid")),console.warn(e)}}async function isLegalMetaFile(e){if(!(0,fs_extra_1.existsSync)(e)||!e.endsWith(".meta"))return!1;if(!(0,fs_extra_1.statSync)(e).isFile())return!1;try{var t=await(0,fs_extra_1.readJson)(e);return"subMetas"in t&&"userData"in t?!0:!1}catch(e){return!1}}function metricCreateAsset(e){let t="",r="";e.endsWith(".animgraph")?(t="animationStateMachine",r="A100000"):e.endsWith(".animask")&&(t="animationStateMachine",r="A100001"),t&&r&&Editor.Metrics._trackEventWithTimer({category:t,id:r,value:1})}function formatCreateMenu(e){const r=[],t={},a=(e.forEach(e=>{(e.group?(t[e.group]||(t[e.group]={handler:e.group,list:[]},r.push(t[e.group])),t[e.group].list):r).push(e)}),[]);return r.sort((e,t)=>{return(asset_config_1.createListOrder.includes(e.handler)?asset_config_1.createListOrder.indexOf(e.handler):asset_config_1.createListOrder.length)-(asset_config_1.createListOrder.includes(t.handler)?asset_config_1.createListOrder.indexOf(t.handler):asset_config_1.createListOrder.length)}),r.forEach((e,t)=>{e.list?a.push(...e.list):a.push(e),t!==r.length-1&&a.push({type:"separator"})}),a}exports.getName=getName,exports.isReadonly=isReadonly,exports.changeMetaUuid=changeMetaUuid,exports.isLegalMetaFile=isLegalMetaFile,exports.metricCreateAsset=metricCreateAsset,exports.formatCreateMenu=formatCreateMenu;