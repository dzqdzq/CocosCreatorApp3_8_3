"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackerDriver=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),url_1=require("url"),perf_hooks_1=require("perf_hooks"),prerequisite_imports_1=require("./prerequisite-imports"),utils_1=require("@editor/lib-programming/dist/utils"),ccbuild_1=require("@cocos/ccbuild"),asserts_1=require("../utils/asserts"),query_shared_settings_1=require("../shared/query-shared-settings"),quick_pack_1=require("@cocos/creator-programming-quick-pack/lib/quick-pack"),mod_lo_1=require("@cocos/creator-programming-mod-lo/lib/mod-lo"),asset_db_interop_1=require("./asset-db-interop"),logger_1=require("./logger"),language_service_1=require("../language-service"),intelligence_1=require("../intelligence"),delegate_1=require("../utils/delegate"),json5_1=__importDefault(require("json5")),minimatch_1=__importDefault(require("minimatch")),VERSION="20",featureUnitModulePrefix="cce:/internal/x/cc-fu/",useEditorFolderFeature=!1;function matchPattern(e,t){return(0,minimatch_1.default)(e.replace(/\\/g,"/"),t.replace(/\\/g,"/"))}async function getEditorPatterns(){var e=[];for(const r of await Editor.Message.request("asset-db","query-db-list")){var t=await Editor.Message.request("asset-db","query-db-info",r),t=path_1.default.join(t.target,"**","editor","**/*");e.push(t)}return e}function getCCEModuleIDs(e){return Object.keys(e).filter(e=>"mapLocation"!==e)}class PackerDriver{static async create(){PackerDriver._cceModuleMap=PackerDriver.queryCCEModuleMap();var t=path_1.default.join(Editor.Project.tmpDir,"programming","packer-driver"),e=path_1.default.join(t,"VERSION"),r=path_1.default.join(t,"targets"),t=path_1.default.join(t,"logs","debug.log"),s={};if(await fs_extra_1.default.pathExists(t))try{await fs_extra_1.default.unlink(t)}catch(e){console.warn("Failed to reset log file: "+t)}var i,a,o=new logger_1.PackerDriverLogger(t),n=(o.debug((new Date).toLocaleString()),o.debug("Project: "+Editor.Project.path),o.debug("Targets: "+Object.keys(predefinedTargets)),await PackerDriver._createIncrementalRecord(o)),u=(await PackerDriver._validateIncrementalRecord(n,e,r,o),{"cce:/internal/code-quality/":(0,url_1.pathToFileURL)(path_1.default.join(__dirname,"..","..","static","builtin-mods","code-quality","/")).href}),t=(await Editor.Message.request("engine","query-engine-info",Editor.Project.__protected__.type)).typescript["path"],c=(o.debug("Engine path: "+t),await ccbuild_1.StatsQuery.create(t)),d=c.evaluateIndexModuleSource([]),l={moduleRequestFilter:[/^cc\.?.*$/g],reporter:{moduleName:"cce:/internal/code-quality/cr.mjs",functionName:"report"}};for([i,a]of Object.entries(predefinedTargets)){o.debug(`Initializing target [${a.name}]`);var _=["cc/env","cc/userland/macro",...getCCEModuleIDs(PackerDriver._cceModuleMap)];_.push(...c.getFeatureUnits().map(e=>""+featureUnitModulePrefix+e));let e=a.browsersListTargets;"preview"===i&&n.config.previewTarget&&(e=n.config.previewTarget,o.debug("Use specified preview browserslist target: "+e));var g=new mod_lo_1.ModLo({targets:e,loose:n.config.loose,guessCommonJsExports:n.config.guessCommonJsExports,useDefineForClassFields:n.config.useDefineForClassFields,allowDeclareFields:n.config.allowDeclareFields,cr:l,_compressUUID(e){return Editor.Utils.UUID.compressUUID(e,!1)},logger:o,checkObsolete:!0,importRestrictions:PackerDriver._importRestrictions,preserveSymlinks:n.config.preserveSymlinks}),_=(g.setExtraExportsConditions(n.config.exportsConditions),g.setExternals(_),g.setLoadMappings(u),path_1.default.join(r,i)),h=Editor.Project.path,h=new quick_pack_1.QuickPack({modLo:g,origin:h,workspace:_,logger:o,verbose:!0}),_=(o.debug("Loading cache"),perf_hooks_1.performance.now()),p=(await h.loadCache(),perf_hooks_1.performance.now());o.debug(`Loading cache costs ${p-_}ms.`);let t;t=a.isEditor?(p=await PackerDriver._getEngineFeaturesShippedInEditor(c),o.debug("Engine features shipped in editor: "+p),{source:PackerDriver._getEngineIndexModuleSource(c,p),respectToFeatureSetting:!1}):{source:d,respectToFeatureSetting:!0};_=await h.createLoaderContext();s[i]=new PackTarget({name:i,modLo:g,sourceMaps:a.sourceMaps,quickPack:h,quickPackLoaderContext:_,logger:o,engineIndexModule:t,tentativePrerequisiteImportsMod:null!=(p=a.isEditor)&&p,userImportMap:n.config.importMap?{json:n.config.importMap.json,url:new url_1.URL(n.config.importMap.url)}:void 0})}return new PackerDriver(s,c,o,await(0,intelligence_1.getInternalCompilerOptions)(),await(0,intelligence_1.getInternalDbURLInfos)())}static async updateImportRestrictions(){if(useEditorFolderFeature){var t=await Editor.Message.request("asset-db","query-db-list"),r=PackerDriver._importRestrictions,s=(r.length=0,await getEditorPatterns());s.push(...getCCEModuleIDs(PackerDriver._cceModuleMap));for(let e=0;e<t.length;++e){var i=t[e],i=await Editor.Message.request("asset-db","query-db-info",i),a=path_1.default.join(i.target,"**/*"),i=path_1.default.join(i.target,"**","editor","**/*");r[e]={importerPatterns:[a,"!"+i],banSourcePatterns:s}}}}static queryCCEModuleMap(){var e=path_1.default.join(__dirname,"../../cce-module.jsonc"),t=json5_1.default.parse(fs_extra_1.default.readFileSync(e,"utf8"));return t.mapLocation=e,t}busy(){return this._asyncIteration.busy()}async mountDatabase(e){var t=await this._assetDbInterop.fetch(e);this._assetChangeQueue.push(...t),await this._assetDbInterop.onMountDatabase(e),await PackerDriver.updateImportRestrictions()}async unmountDatabase(e){this._assetDbInterop.onUnmountDatabase(e),await PackerDriver.updateImportRestrictions()}async resetDatabases(e=!0){const t=await this._assetDbInterop.queryAssetDomains();this._logger.debug("Reset databases. Enumerated domains: "+JSON.stringify(t,void 0,2));var r=()=>{for(const e of Object.values(this._targets))e.setAssetDatabaseDomains(t)};e?this._triggerNextBuild(r):r()}async pullAssetDb(){var e=this._logger,t=(e.debug("Pulling asset-db."),perf_hooks_1.performance.now()),r=(await this._fetchAll(),perf_hooks_1.performance.now());e.debug(`Fetch asset-db cost: ${r-t}ms.`),await this._waitForBuild()}async clearCache(){if(this._clearing)this._logger.debug("Failed to clear cache: previous clearing have not finished yet.");else if(this.busy())this._logger.error("Failed to clear cache: the building is still working in progress.");else{this._clearing=!0;for(var[e,t]of Object.entries(this._targets))this._logger.debug("Clear cache of target "+e),await t.clearCache();this._logger.debug("Request build after clearing..."),this._dispatchBuildRequest(),this._clearing=!1}}getQuickPackLoaderContext(e){if(this._warnMissingTarget(e),e in this._targets)return this._targets[e].quickPackLoaderContext}isReady(e){if(this._warnMissingTarget(e),e in this._targets)return this._targets[e].ready}async queryScriptDeps(e){return await this._transformDepsGraph(),null!=(e=this._depsGraph[e])?e:[]}async shutDown(){await this.destroyed()}constructor(e,t,r,s,i){this.beforeEditorBuildDelegate=new delegate_1.AsyncDelegate,this._clearing=!1,this._targets={},this._assetChangeQueue=[],this._featureChanged=!1,this._beforeBuildTasks=[],this._broadcastListenerMap={},this._depsGraph={},this._init=!1,this._targets=e,this._statsQuery=t,this._logger=r,this.languageService=new language_service_1.LanguageServiceAdapter(intelligence_1.realTsConfigPath,Editor.Project.path,this.beforeEditorBuildDelegate,s,i),this._assetDbInterop=new asset_db_interop_1.AssetDbInterop(this._onSomeAssetChangesWereMade.bind(this)),this._asyncIteration=new AsyncIterationConcurrency1(async()=>this._startBuildIteration())}async init(){this._init||(this._init=!0,this._broadcastListenerMap["engine:modules-changed"]=()=>this._onEngineFeaturesChanged(),Object.keys(this._broadcastListenerMap).forEach(e=>Editor.Message.__protected__.addBroadcastListener(e,this._broadcastListenerMap[e])),await this._assetDbInterop.init(),await this._syncEngineFeatures())}async destroyed(){this._init=!1,Object.keys(this._broadcastListenerMap).forEach(e=>Editor.Message.__protected__.removeBroadcastListener(e,this._broadcastListenerMap[e])),this._broadcastListenerMap={},await this._assetDbInterop.destroyed()}_warnMissingTarget(e){e in this._targets||console.warn(`Invalid pack target: ${e}. Existing targets are: `+Object.keys(this._targets))}_onSomeAssetChangesWereMade(e){this._logger.debug(`Dispatch build request for time accumulated ${e.length} asset changes.`),this._assetChangeQueue.push(...e),this._dispatchBuildRequest()}async _onEngineFeaturesChanged(){this._featureChanged=!0,this._dispatchBuildRequest()}async _startBuildIteration(){Editor.Metrics.trackTimeStart("programming:compile-start"),Editor.Message.broadcast("programming:compile-start"),this._logger.clear(),this._logger.debug("Build iteration starts.\n"+`Number of accumulated asset changes: ${this._assetChangeQueue.length}
`+"Feature changed: "+this._featureChanged),this._featureChanged&&(this._featureChanged=!1,await this._syncEngineFeatures());var e=this._assetChangeQueue,t=(this._assetChangeQueue=[],this._beforeBuildTasks.slice());this._beforeBuildTasks.length=0;for(const a of t)a();try{await this.beforeEditorBuildDelegate.dispatch(e.filter(e=>e.type===asset_db_interop_1.AssetChangeType.modified))}catch(e){console.debug(e)}var r,s=e.filter(e=>!e.filePath.endsWith(".d.ts"));for([,r]of Object.entries(this._targets)){0!==e.length&&await r.applyAssetChanges(s);var i=await r.build();this._depsGraph=i.depsGraph}Editor.Message.broadcast("programming:compiled"),Editor.Metrics.trackTimeEnd("programming:compile-start")}async _waitForBuild(){return this._asyncIteration.nextIteration()}_dispatchBuildRequest(){this._asyncIteration.nextIteration()}static async _createIncrementalRecord(e){var e=await(0,query_shared_settings_1.querySharedSettings)(e),e={version:VERSION,config:Object.assign({},e)},t=await Editor.Profile.getProject("project","script.previewBrowserslistConfigFile");return t&&(t=await readBrowserslistTarget(Editor.UI.__protected__.File.resolveToRaw(t)))&&(e.config.previewTarget=t),e}static async _validateIncrementalRecord(e,t,r,s){let i=!1;try{var a=await fs_extra_1.default.readJson(t);(i=matchObject(e,a))?s.debug("Incremental file seems great."):s.debug("[PackerDriver] Options doesn't match.\n"+`Last: ${JSON.stringify(e,void 0,2)}
`+"Current: "+JSON.stringify(a,void 0,2))}catch(e){s.debug("Packer deriver version file lost or format incorrect: "+e)}return i||(s.debug("Clearing out the targets..."),await fs_extra_1.default.emptyDir(r),await fs_extra_1.default.outputJson(t,e,{spaces:2})),i}async _fetchAll(){var e=await this._assetDbInterop.fetchAll();this._assetChangeQueue.push(...e)}static async _getEngineFeaturesShippedInEditor(e){return e.getFeatures().filter(e=>!["physics-ammo","physics-builtin","physics-cannon","physics-physx","physics-2d-box2d","physics-2d-builtin","wait-for-ammo-instantiation"].includes(e))}async _syncEngineFeatures(){var e,t=await Editor.Profile.getProject("engine","modules.includeModules")||[],r=(this._logger.debug("Sync engine features: "+t),t.findIndex(e=>e.startsWith("physics-2d-box2d"))),s=(-1!==r&&(await Editor.Profile.getConfig("engine","physics-2d-box2d")?t.splice(r,1,"physics-2d-box2d-wasm"):t.splice(r,1,"physics-2d-box2d")),PackerDriver._getEngineIndexModuleSource(this._statsQuery,t));for([,e]of Object.entries(this._targets))e.respectToEngineFeatureSetting&&e.setEngineIndexModuleSource(s)}static _getEngineIndexModuleSource(e,t){t=e.getUnitsOfFeatures(t);return e.evaluateIndexModuleSource(t,e=>""+featureUnitModulePrefix+e)}async _triggerNextBuild(e){this._beforeBuildTasks.push(e),this._dispatchBuildRequest()}async _transformDepsGraph(){var e,t,r,s={};for([t,r]of Object.entries(this._depsGraph)){var i=await this._transformFilePathToDbPath(t);if(i){var a=null!=(e=s[i])?e:s[i]=[];for(const n of r){var o=await this._transformFilePathToDbPath(n);o&&!a.includes(o)&&a.push(o)}}}this._depsGraph=s}async _transformFilePathToDbPath(e){return e.startsWith("db:")?e:e.startsWith("file:///")?(e=(0,url_1.fileURLToPath)(e),Editor.Message.request("asset-db","query-url",e)):void 0}}(exports.PackerDriver=PackerDriver)._importRestrictions=[];const engineIndexModURL="cce:/internal/x/cc",DEFAULT_PREVIEW_BROWSERS_LIST_TARGET="supports es6-module",predefinedTargets={editor:{name:"Editor",browsersListTargets:utils_1.editorBrowserslistQuery,sourceMaps:"inline",isEditor:!0},preview:{name:"Preview",sourceMaps:!0,browsersListTargets:DEFAULT_PREVIEW_BROWSERS_LIST_TARGET}};async function readBrowserslistTarget(e){let t;try{t=await fs_extra_1.default.readFile(e,"utf8")}catch(e){return}e=function(e){var t=[];for(const s of e.split("\n")){var r=s.indexOf("#"),r=(r<0?s:s.substr(0,r)).trim();0!==r.length&&t.push(r)}return t}(t);if(0!==e.length)return e.join(" or ")}class PackTarget{constructor(e){this._buildStarted=!1,this._ready=!1,this._prerequisiteAssetMods=new Set,this._uuidURLMap=new Map,this._firstBuild=!0,this._cleanResolutionNextTime=!0,this._name=e.name,this._modLo=e.modLo,this._quickPack=e.quickPack,this._quickPackLoaderContext=e.quickPackLoaderContext,this._sourceMaps=e.sourceMaps,this._logger=e.logger,this._respectToFeatureSetting=e.engineIndexModule.respectToFeatureSetting,this._tentativePrerequisiteImportsMod=e.tentativePrerequisiteImportsMod,this._userImportMap=e.userImportMap;var t=this._modLo;this._entryMod=t.addMemoryModule(prerequisite_imports_1.prerequisiteImportsModURL,(this._tentativePrerequisiteImportsMod?prerequisite_imports_1.makeTentativePrerequisiteImports:prerequisite_imports_1.makePrerequisiteImportsMod)([])),this._engineIndexMod=t.addMemoryModule(engineIndexModURL,e.engineIndexModule.source),this.setAssetDatabaseDomains([])}get quickPackLoaderContext(){return this._quickPackLoaderContext}get ready(){return this._ready}get respectToEngineFeatureSetting(){return this._respectToFeatureSetting}async build(){this._ensureIdle(),this._buildStarted=!0;var e=this._name;Editor.Message.broadcast("programming:pack-build-start",e),Editor.Metrics.trackTimeStart("programming:pack-build-start-"+e),this._logger.debug(`Target(${e}) build started.`);let t;var r=perf_hooks_1.performance.now();try{var s=await this._getPrerequisiteAssetModsWithFilter(),i=[engineIndexModURL,prerequisite_imports_1.prerequisiteImportsModURL,...s],a=this._cleanResolutionNextTime;a&&(this._cleanResolutionNextTime=!1),a&&console.debug("This build will perform a clean module resolution."),t=await this._quickPack.build(i,{retryResolutionOnUnchangedModule:this._firstBuild,cleanResolution:a}),this._firstBuild=!1}catch(e){this._logger.error(""+e)}s=perf_hooks_1.performance.now();return this._logger.debug(`Target(${e}) ends with cost ${s-r}ms.`),this._ready=!0,Editor.Message.broadcast("programming:pack-build-end",e),Editor.Metrics.trackTimeEnd("programming:pack-build-start-"+e),this._buildStarted=!1,t||(console.warn("Cannot get build result from quick pack."),{depsGraph:{}})}async clearCache(){await this._quickPack.clear(),this._firstBuild=!0}async applyAssetChanges(e){this._ensureIdle();for(const s of e){var t,r=s.uuid;s.type!==asset_db_interop_1.AssetChangeType.modified&&s.type!==asset_db_interop_1.AssetChangeType.remove||(t=this._uuidURLMap.get(r))&&(this._uuidURLMap.delete(r),this._modLo.unsetUUID(t),this._prerequisiteAssetMods.delete(t)||this._logger.warn(`Unexpected: ${t} is not in registry.`)),s.type!==asset_db_interop_1.AssetChangeType.modified&&s.type!==asset_db_interop_1.AssetChangeType.add||s.isPluginScript||(t=s.url["href"],this._uuidURLMap.set(r,t),this._modLo.setUUID(t,r),this._prerequisiteAssetMods.add(t))}e=await this._getPrerequisiteAssetModsWithFilter();this._entryMod.source=(this._tentativePrerequisiteImportsMod?prerequisite_imports_1.makeTentativePrerequisiteImports:prerequisite_imports_1.makePrerequisiteImportsMod)(e)}setEngineIndexModuleSource(e){this._ensureIdle(),this._engineIndexMod.source=e}setAssetDatabaseDomains(e){var t=(this._ensureIdle(),this)["_userImportMap"],r={},s=t?t.url:new url_1.URL("foo:/bar"),i=(r.imports={},r.imports.cc=engineIndexModURL,[]);for(const c of e){var a=(0,url_1.pathToFileURL)(path_1.default.join(c.physical,path_1.default.join(path_1.default.sep))).href;r.imports[c.root.href]=a,i.push(a)}if(t&&(t.json.imports&&(r.imports=Object.assign(Object.assign({},r.imports),t.json.imports)),t.json.scopes))for(var[o,n]of Object.entries(t.json.scopes)){var u=null!=(u=r.scopes)?u:r.scopes={};u[o]=Object.assign(Object.assign({},null!=(u=u[o])?u:{}),n)}this._logger.debug(`Our import map(${s}): `+JSON.stringify(r,void 0,2)),this._modLo.setImportMap(r,s),this._modLo.setAssetPrefixes(i),this._cleanResolutionNextTime=!0}async _getPrerequisiteAssetModsWithFilter(){let e=Array.from(this._prerequisiteAssetMods).sort();if(useEditorFolderFeature&&"editor"!==this._name){const r=await getEditorPatterns();e=Array.from(e).filter(e=>{const t=e.startsWith("file:")?(0,url_1.fileURLToPath)(e):e;return!r.some(e=>(0,minimatch_1.default)(t,e))})}return e}_ensureIdle(){(0,asserts_1.asserts)(!this._buildStarted,"Build is in progress, but a status change request is filed")}}class AsyncIterationConcurrency1{constructor(e){this._executionPromise=null,this._pendingPromise=null,this._iterate=e}busy(){return!!this._executionPromise||!!this._pendingPromise}nextIteration(){return this._executionPromise?this._pendingPromise||(this._pendingPromise=this._executionPromise.finally(()=>(this._pendingPromise=null,this.nextIteration()))):this._executionPromise=Promise.resolve(this._iterate()).finally(()=>{this._executionPromise=null})}}function matchObject(e,t){return function r(t,s){return Array.isArray(t)?Array.isArray(s)&&t.length===s.length&&t.every((e,t)=>r(e,s[t])):"object"==typeof t&&null!==t?"object"==typeof s&&null!==s&&Object.keys(t).every(e=>r(t[e],s[e])):null===t?null===s:t===s}(e,t)}