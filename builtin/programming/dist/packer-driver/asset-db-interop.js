"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AssetChangeType=exports.AssetDbInterop=void 0;const asserts_1=require("../utils/asserts"),timers_1=require("timers"),url_1=require("url"),db_module_url_1=require("../utils/db-module-url"),cache_1=require("../shared/cache"),path_1=require("../utils/path"),intelligence_1=require("../intelligence");class AssetDbInterop{constructor(e){this._assetInfoCache=cache_1.assetInfoCache,this._blockScriptUUIDSet=cache_1.blockAssetUUIDSet,this._hasInit=!1,this.broadcastListenerMap={},this._waitTimeoutMs=10,this._changeQueue=[],this._handler=e,this._assetChangeTimer=new AccumulatingTimer(this._waitTimeoutMs,()=>{this._onAssetChangeTimerArrived()})}async init(){this._hasInit||(this.broadcastListenerMap["asset-db:asset-change"]=async(...e)=>this._onAssetChange(AssetChangeType.modified,...e),this.broadcastListenerMap["asset-db:asset-add"]=async(...e)=>this._onAssetChange(AssetChangeType.add,...e),this.broadcastListenerMap["asset-db:asset-delete"]=async(...e)=>this._onAssetChange(AssetChangeType.remove,...e),Object.keys(this.broadcastListenerMap).forEach(e=>Editor.Message.__protected__.addBroadcastListener(e,this.broadcastListenerMap[e])),this._hasInit=!0)}async destroyed(){Object.keys(this.broadcastListenerMap).forEach(e=>Editor.Message.__protected__.removeBroadcastListener(e,this.broadcastListenerMap[e])),this.broadcastListenerMap={},this._hasInit=!1}async fetch(e){return this.fetchAssetDb({assetDbOptions:{ccType:"cc.Script",pattern:`db://${e}/**/*.ts`},filter:filterForAssetChange,mapper:mapperForAssetChange})}async fetchAll(){return await this.fetchAllTypescripts(),this.fetchAssetDb({assetDbOptions:{ccType:"cc.Script"},filter:filterForAssetChange,mapper:mapperForAssetChange})}async fetchAllTypescripts(){var t=await this.fetchAssetDb({assetDbOptions:{importer:"typescript"},mapper:mapperForFileInfo});for(let e=0;e<t.length;e++){var s=t[e];cache_1.assetInfoCache.set(s.filePath,s)}}async onMountDatabase(e){var t=await this.fetchAssetDb({assetDbOptions:{importer:"typescript",pattern:`db://${e}/**/*.ts`},mapper:mapperForFileInfo});for(let e=0;e<t.length;e++){var s=t[e];cache_1.assetInfoCache.set(s.filePath,s)}}async onUnmountDatabase(t){const s=(await(0,intelligence_1.getInternalDbURLInfos)()).find(e=>t===(0,path_1.getDbName)(e.dbURL));(0,asserts_1.asserts)(s),cache_1.assetInfoCache.forEach(e=>{e.filePath.startsWith(s.dbURL)&&cache_1.assetInfoCache.delete(e.filePath)})}async queryAssetDomains(){var e=[];for(const a of await Editor.Message.request("asset-db","query-db-list")){var t=await Editor.Message.request("asset-db","query-db-info",a),s=(0,db_module_url_1.getDatabaseModuleRootURL)(a),s={root:new URL(s),physical:t.target};isPackageDomain(a)&&(t=await Editor.Message.request("asset-db","query-db-info",a),s.jail=t.target),e.push(s)}return e}async fetchAssetDb(s){const a=[],i=null!=(e=null==s?void 0:s.mapper)?e:(e,t)=>({assetInfo:e,meta:t});var e=await Editor.Message.request("asset-db","query-assets",null==s?void 0:s.assetDbOptions);return e&&await Promise.all(e.map(async e=>{var t=e.uuid,t=await Editor.Message.request("asset-db","query-asset-meta",t);(null==s||!s.filter||null!=s&&s.filter(e,t))&&(e=await i(e,t),a.push(e))})),a}async _onAssetChange(e,t,s,a){var i,r={url:getURL(s,a),uuid:t,filePath:s.file,type:e,isPluginScript:isPluginScript(s,a)},n=mapperForFileInfo(s,a);if(e===AssetChangeType.modified&&!this._assetInfoCache.has(s.file))for(const h of this._assetInfoCache.values())if(h.uuid===t){this._assetInfoCache.delete(h.filePath),this._assetInfoCache.set(n.filePath,n),r.oldFilePath=h.filePath,r.newFilePath=n.filePath;break}e!==AssetChangeType.add||"typescript"!==s.importer&&!s.isDirectory||(-1!==(i=this._changeQueue.findIndex(e=>e.type===AssetChangeType.remove&&e.uuid===t))&&(r.type=AssetChangeType.modified,r.oldFilePath=(0,path_1.resolveFileName)(this._changeQueue[i].filePath),r.newFilePath=n.filePath,this._changeQueue.splice(i,1)),"typescript"!==s.importer)||this._assetInfoCache.set(n.filePath,n),e===AssetChangeType.remove&&this._assetInfoCache.delete(s.file),this._blockScriptUUIDSet.has(t)?this._blockScriptUUIDSet.delete(t):filterForAssetChange(s,a)&&(this._changeQueue.push(r),this._assetChangeTimer.refresh())}_onAssetChangeTimerArrived(){var e=this._changeQueue;this._changeQueue=[],this._handler(e)}}var AssetChangeType;exports.AssetDbInterop=AssetDbInterop,function(e){e[e.add=0]="add",e[e.remove=1]="remove",e[e.modified=2]="modified"}(AssetChangeType=exports.AssetChangeType||(exports.AssetChangeType={}));class AccumulatingTimer{constructor(e,t){this._timeout=void 0,this._waitTimeoutMs=e,this._callback=t}refresh(){this._timeout?this._timeout.refresh():this._timeout=(0,timers_1.setTimeout)(async()=>{this._callback(),(0,asserts_1.asserts)(this._timeout),clearTimeout(this._timeout),this._timeout=void 0},this._waitTimeoutMs)}}function filterForAssetChange(e,t){return!!t&&("javascript"===e.importer||"typescript"===e.importer)}function mapperForAssetChange(e,t){return(0,asserts_1.asserts)(t),{type:AssetChangeType.add,url:getURL(e,t),uuid:e.uuid,isPluginScript:isPluginScript(e,t),filePath:e.file}}function mapperForFileInfo(e,t){return e.file=(0,path_1.resolveFileName)(e.file),{uuid:e.uuid,filePath:e.file}}function isPluginScript(e,t){return!!t.userData.isPlugin}function getURL(e,t){return(0,url_1.pathToFileURL)(e.file)}function isPackageDomain(e){return!["assets","internal"].includes(e)}