"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.generateCommonTsConfig=exports.updateCustomMacro=exports.getInternalDbURLInfos=exports.getInternalCompilerOptions=exports.realTsConfigPath=void 0;const typescript_1=__importDefault(require("typescript")),path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),db_module_url_1=require("../utils/db-module-url"),ccbuild_1=require("@cocos/ccbuild"),tempDirPath=(exports.realTsConfigPath=path_1.default.join(Editor.Project.path,"tsconfig.json"),path_1.default.join(Editor.Project.path,"temp")),configFilePath=path_1.default.join(tempDirPath,"tsconfig.cocos.json"),declarationHomePath=path_1.default.join(tempDirPath,"declarations");async function updateCustomMacroJS(){var t=path_1.default.join(tempDirPath,"programming/custom-macro.js");await fs_extra_1.default.outputFile(t,await generateCustomMacroJSFile(),{encoding:"utf8"})}const internalDbURLInfos=[],internalTsConfig={};async function getInternalCompilerOptions(){return 0===Object.keys(internalTsConfig).length&&generateCommonTsConfig(),internalTsConfig}async function getInternalDbURLInfos(){var t;return 0===internalDbURLInfos.length&&(t=await getDbURLInfos(),internalDbURLInfos.length=0,internalDbURLInfos.push(...t)),internalDbURLInfos}async function updateCustomMacro(){var t=path_1.default.join(declarationHomePath,"cc.custom-macro.d.ts");await fs_extra_1.default.outputFile(t,await generateCustomMacroDeclarationFile(),{encoding:"utf8"}),await updateCustomMacroJS()}async function generateCommonTsConfig(){const a=[];var t=0===(t=[]).length?void 0:t;const n={};await Promise.all([async function(){var t=await Editor.Message.request("engine","query-engine-info"),e=path_1.default.join(declarationHomePath,"cc.d.ts");await fs_extra_1.default.outputFile(e,generateEngineDeclarationFile(t.typescript.path),{encoding:"utf8"}),a.push(o(e))}(),async function(){var t=await Editor.Message.request("engine","query-engine-info"),e=path_1.default.join(declarationHomePath,"cc.env.d.ts");await fs_extra_1.default.outputFile(e,await generateEnvDeclarationFile(t.typescript.path),{encoding:"utf8"}),a.push(o(e))}(),async function(){var t=path_1.default.join(declarationHomePath,"cc.custom-macro.d.ts");await fs_extra_1.default.outputFile(t,await generateCustomMacroDeclarationFile(),{encoding:"utf8"}),a.push(o(t))}(),async function(){var t=await Editor.Message.request("engine","query-engine-info"),e=path_1.default.join(declarationHomePath,"jsb.d.ts");await fs_extra_1.default.outputFile(e,generateJsbDeclarationFile(t.typescript.path),{encoding:"utf8"}),a.push(o(e))}(),async function(){var t=await getDbURLInfos();internalDbURLInfos.length=0,internalDbURLInfos.push(...t);for(var{dbURL:e,target:a}of t)n[e+"*"]=[path_1.default.join(a,"*")]}()]),await updateCustomMacroJS();var e={target:"ES2015",module:"ES2015",strict:!0,types:a,libs:t,paths:n,experimentalDecorators:!0,isolatedModules:!0,moduleResolution:"node",noEmit:!0,forceConsistentCasingInFileNames:!0},t={$schema:"https://json.schemastore.org/tsconfig",compilerOptions:e};for(const r in e)internalTsConfig[r]=e[r];function o(t){t=path_1.default.relative(path_1.default.dirname(exports.realTsConfigPath),t),t=(t.endsWith(".d.ts")?t.substr(0,t.length-5):t).replace(/\\/g,"/");return t.startsWith("./")||t.startsWith("../")?t:"./"+t}internalTsConfig.target=typescript_1.default.ScriptTarget.ES2015,internalTsConfig.module=typescript_1.default.ModuleKind.ES2015,internalTsConfig.moduleResolution=typescript_1.default.ModuleResolutionKind.NodeJs,await fs_extra_1.default.outputJson(configFilePath,t,{spaces:2})}async function getDbURLInfos(){var t=[];for(const n of await Editor.Message.request("asset-db","query-db-list")){var e=await Editor.Message.request("asset-db","query-db-info",n),a=(0,db_module_url_1.getDatabaseModuleRootURL)(n);t.push({dbURL:a,target:e.target})}return t}function generateEngineDeclarationFile(t){const e=path_1.default.join(__dirname,"../../editor-export/");var a=(fs_extra_1.default.existsSync(e)?fs_extra_1.default.readdirSync(e):[]).map(t=>`/// <reference path="${path_1.default.join(e,t)}"/>`).join("\n");return`
    /// <reference path="${path_1.default.join(t,"bin/.declarations/cc.d.ts")}"/>
    ${a}
    /**
     * @deprecated Global variable \`cc\` was dropped since 3.0. Use ES6 module syntax to import Cocos Creator APIs.
     */
    declare const cc: never;
    `}function generateJsbDeclarationFile(t){return`/// <reference path="${path_1.default.join(t,"./@types/jsb.d.ts")}"/>
`}async function generateEnvDeclarationFile(t){return(await ccbuild_1.StatsQuery.create(t)).constantManager.genCCEnv()}async function generateCustomMacroDeclarationFile(){return`declare module "cc/userland/macro" {
${(await Editor.Profile.getProject("engine","macroCustom")).map(t=>`	export const ${t.key}: boolean;`).join("\n")}
}
`}async function generateCustomMacroJSFile(){return`System.register([], function (_export, _context) {      
    return {
        setters: [],
        execute: function () {
${(await Editor.Profile.getProject("engine","macroCustom")).map(t=>`_export("${t.key}", ${t.value});`).join("\n")}
        }
    };
});
`}exports.getInternalCompilerOptions=getInternalCompilerOptions,exports.getInternalDbURLInfos=getInternalDbURLInfos,exports.updateCustomMacro=updateCustomMacro,exports.generateCommonTsConfig=generateCommonTsConfig;