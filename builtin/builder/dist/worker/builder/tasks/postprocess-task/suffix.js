"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.name=exports.title=void 0;const path_1=require("path"),script_1=require("../../asset-handler/script"),crypto_1=require("crypto"),fs_extra_1=require("fs-extra"),md5_cache_handler_1=require("./md5-cache-handler"),asset_library_1=require("../../manager/asset-library");async function handle(t,a,s){if(t.md5Cache){t.md5CacheOptions.includes.push((0,path_1.join)(a.paths.dir,"*"),(0,path_1.join)(a.paths.dir,"src","*"));var e=new md5_cache_handler_1.md5CacheHandler(a.paths.dir,t.md5CacheOptions);for(let t=0;t<a.settings.plugins.jsList.length;t++){var i=a.settings.plugins.jsList[t],p=asset_library_1.buildAssetLibrary.url2uuid("db://"+i),p=a.paths.plugins[p],r=await e.addMd5ToPath(p);a.settings.plugins.jsList[t]=i.replace((0,path_1.basename)(p),(0,path_1.basename)(r))}for(const u of Object.keys(a.importMap.imports)){var h=(0,path_1.dirname)(a.paths.importMap),n=a.importMap.imports[u];n.startsWith(".")&&(n=(0,path_1.join)(h,n),n=await e.addMd5ToPath(n),a.importMap.imports[u]="./"+Build.Utils.relativeUrl(h,n))}await script_1.ScriptBuilder.outputImportMap(a.importMap,{dest:a.paths.importMap,importMapFormat:t.buildScriptParam.importMapFormat,debug:t.debug}),a.paths.importMap=await e.addMd5ToPath(a.paths.importMap),a.paths.polyfillsJs&&(a.paths.polyfillsJs=await e.addMd5ToPath(a.paths.polyfillsJs)),a.paths.systemJs&&(a.paths.systemJs=await e.addMd5ToPath(a.paths.systemJs));for(let t=0;t<a.scriptPackages.length;t++){var d=a.scriptPackages[t],o=await e.addMd5ToPath(d);a.scriptPackages[t]=o,a.settings.scripting.scriptPackages[t]=a.settings.scripting.scriptPackages[t].replace((0,path_1.basename)(d),(0,path_1.basename)(o))}var l=a.settings;for(const m of this.bundleManager.bundles.filter(t=>t.output).sort((t,a)=>t.name.localeCompare(a.name)))l.assets.bundleVers[m.name]=m.version;var c=(0,crypto_1.createHash)("md5");c.update(JSON.stringify(a.settings)),e.hashedPathMap[a.paths.settings]=(0,path_1.join)((0,path_1.dirname)(a.paths.settings),`settings.${c.digest("hex").slice(0,5)}.json`),await(0,fs_extra_1.remove)(a.paths.settings),a.paths.settings=e.hashedPathMap[a.paths.settings],(0,fs_extra_1.outputFileSync)(a.paths.settings,JSON.stringify(l,null,t.debug?4:0)),await e.run(),a.paths.hashedMap=e.hashedPathMap,a.paths.applicationJS=e.hashedPathMap[a.paths.applicationJS],console.debug(`add suffix to assets(${Object.keys(e.hashedPathMap).length}) success!`)}}exports.title="i18n:builder.tasks.build_suffix",exports.name="build-task/suffix",exports.handle=handle;