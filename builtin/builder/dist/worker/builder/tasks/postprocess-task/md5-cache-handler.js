"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.md5CacheHandler=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("../../utils"),minimatch_1=__importDefault(require("minimatch")),textFiles=[".js",".ts",".html"];class md5CacheHandler{constructor(t,e){this.hashedPathMap={},this._files=[],this._waitingMd5Files=[],this._waitingReplaceFiles=[],this.waitUpdateFiles={},this.options=e,this._root=t}async initFiles(){var t=require("globby"),t=(this.options.excludes.push("**/*.map"),this.options.excludes.push((0,path_1.join)(this._root,"**.ico")),this.options.excludes.push((0,path_1.join)(this._root,"**.icns")),this.options.includes=[...this.options.replaceOnly,...this.options.includes],await t(this.options.includes,{nodir:!0,ignore:this.options.excludes,deep:!1}));const e=Object.values(this.hashedPathMap).map(t=>(0,path_1.resolve)(t));this._files=t.map(t=>(0,path_1.resolve)(t)).filter(t=>!e.includes(t)),this.options.replaceOnly.length?this._files.forEach(e=>{(this.options.replaceOnly.find(t=>(0,minimatch_1.default)(e,t))?this._waitingReplaceFiles:this._waitingMd5Files).push(e)}):this._waitingMd5Files=this._files}async run(){await this.initFiles(),await this.addMD5ToFiles(),this._waitingMd5Files.length&&await Promise.all(this._waitingReplaceFiles.map(t=>this.replacePath(t)))}async replacePath(t){var e=await this.readFileDepends(t);e&&e.depends.length&&(await this.replacePathInCode(t,e),await(0,fs_extra_1.outputFile)(t,e.code))}async addMd5ToPath(t,e){var i=(0,utils_1.calcMd5)(e||(0,fs_extra_1.readFileSync)(t,"utf-8")),i=(0,utils_1.patchMd5ToPath)(t,i);return e?(await(0,fs_extra_1.remove)(t),await(0,fs_extra_1.outputFile)(i,e)):await(0,fs_extra_1.rename)(t,i),this.hashedPathMap[t]=i}findFile(t,e){var i;if((0,path_1.extname)(e))return i=(0,path_1.join)(t,e),this.checkPathExist(i)||!e.startsWith(".")&&(i=(0,path_1.join)(this._root,e),this.checkPathExist(i))?i:"";for(const s of[".js",".json","/index.js","/index.json"]){var a=this._joinPath(t,e,s);if(this.checkPathExist(a))return a;if(!e.startsWith(".")&&(a=this._joinPath(this._root,e,s),this.checkPathExist(a)))return a}return""}checkPathExist(t){return this._files.includes(t)||this.hashedPathMap[t]}_joinPath(t,e,i){return i.startsWith(".")?(0,path_1.join)(t,e+i):(0,path_1.join)(t,e,i)}async addMD5ToFiles(){var t=this._waitingMd5Files;await Promise.all(t.map(async t=>{var e;this.hashedPathMap[t]||((e=await this.readFileDepends(t))&&e.depends.length?(await this.replacePathInCode(t,e),e.depends.length?this.waitUpdateFiles[t]=e:await this.addMd5ToPath(t,e.code)):await this.addMd5ToPath(t,null==e?void 0:e.code))})),await new Promise(async(t,e)=>{try{for(var i=Object.keys(this.waitUpdateFiles);i.length;){var a=i.shift();if(!a)return;var s=this.waitUpdateFiles[a];await this.replacePathInCode(a,s),0===s.depends.length?(await this.addMd5ToPath(a,s.code),delete this.waitUpdateFiles[a]):i.push(a)}}catch(t){e(t)}t()})}replacePathInCode(i,a){const s=[];return a.depends.forEach((t,e)=>{this.hashedPathMap[t.path]?a.code=a.code.replaceAll(t.matchStr,t.matchStr.replace((0,path_1.basename)(t.fileName),(0,path_1.basename)(this.hashedPathMap[t.path]))):this.waitUpdateFiles[t.path]&&this.waitUpdateFiles[t.path].depends.find(t=>t.path===i)||!this._waitingMd5Files.includes(t.path)||s.push(t)}),a.depends=s,a}async readFileDepends(t){var e=(0,path_1.extname)(t);if(!textFiles.includes(e))return null;var e=(0,fs_extra_1.readFileSync)(t,"utf-8"),i=e.matchAll(/(?:'|\")([^\s'"]+)(?:'|\")/g),a=[],s=(0,path_1.dirname)(t);for(const n of i){var h=this.findFile(s,n[1]);h&&a.push({path:h,matchStr:n[0],fileName:n[1]})}return{depends:a,code:e}}}exports.md5CacheHandler=md5CacheHandler;