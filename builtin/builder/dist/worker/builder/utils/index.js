"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,s){void 0===s&&(s=t);var o=Object.getOwnPropertyDescriptor(r,t);o&&("get"in o?r.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,s,o)}:function(e,r,t,s){e[s=void 0===s?t:s]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__exportStar=this&&this.__exportStar||function(e,r){for(var t in e)"default"===t||Object.prototype.hasOwnProperty.call(r,t)||__createBinding(r,e,t)},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.queryImageAssetFromSubAssetByUuid=exports.quickSpawn=exports.patchMd5ToPath=exports.calcMd5=exports.appendMd5ToPaths=exports.createBundle=exports.compileJS=exports.transformCode=exports.toBabelModules=exports.getResRawAssetsPath=exports.getResImportPath=exports.nameToSubId=exports.getUuidFromPath=exports.decompressUuid=exports.compressUuid=exports.transI18nName=exports.copyDirSync=exports.getFileSizeDeep=exports.isInstallNodeJs=exports.relativeUrl=exports.dbUrlToRawPath=exports.removeDbHeader=exports.recursively=exports.copyPaths=void 0;const path_1=require("path"),child_process_1=require("child_process"),fs_1=require("fs"),fs_extra_1=require("fs-extra"),babel=__importStar(require("@babel/core")),preset_env_1=__importDefault(require("@babel/preset-env")),sub_process_manager_1=require("../../worker-pools/sub-process-manager"),EditorExtends=require("@base/electron-module").require("EditorExtends"),babelify=require("babelify"),browserify=require("browserify"),{I18n,Project,Utils}=require("editor");function copyPaths(e){return Promise.all(e.map(e=>(0,fs_extra_1.copy)(e.src,e.dest)))}function recursively(r,t){r.subAssets&&(t&&t(r),Object.keys(r.subAssets).forEach(e=>{recursively(r.subAssets[e],t)}))}exports.copyPaths=copyPaths,exports.recursively=recursively;const DB_PROTOCOL_HEADER="db://";function removeDbHeader(e){return e?e.startsWith(DB_PROTOCOL_HEADER)?e.slice(DB_PROTOCOL_HEADER.length):(console.error("unknown path to build: "+e),e):""}function dbUrlToRawPath(e){return(0,path_1.join)(Project.path,removeDbHeader(e))}function relativeUrl(e,r){return(0,path_1.relative)(e,r).replace(/\\/g,"/")}function isInstallNodeJs(){return new Promise((r,e)=>{(0,child_process_1.exec)("node -v",{env:process.env},e=>{e?(console.error(e),"win32"===process.platform?console.error(new Error(I18n.t("builder.window_default_npm_path_error"))):console.error(new Error(I18n.t("builder.mac_default_npm_path_error"))),r(!1)):r(!0)})})}function getFileSizeDeep(r){if(!(0,fs_1.existsSync)(r))return 0;var e=(0,fs_1.statSync)(r);if(!e.isDirectory())return e.size;let t=0;return(0,fs_1.readdirSync)(r).forEach(e=>{t+=getFileSizeDeep((0,path_1.join)(r,e))}),t}function copyDirSync(r,t){var e;return(0,fs_1.existsSync)(r)?(0,fs_1.statSync)(r).isDirectory()?(e=(0,fs_1.readdirSync)(r),(0,fs_extra_1.ensureDirSync)(t),void e.forEach(e=>{copyDirSync((0,path_1.join)(r,e),(0,path_1.join)(t,e))})):((0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(t)),(0,fs_1.copyFileSync)(r,t)):0}function transI18nName(e){return"string"!=typeof e?"":e.startsWith("i18n:")&&(e=e.replace("i18n:",""),I18n.t(e)||console.debug(e+" is not defined in i18n"),I18n.t(e))||e}function compressUuid(e,r=!0){return EditorExtends.UuidUtils.compressUuid(e,r)}function decompressUuid(e){return EditorExtends.UuidUtils.decompressUuid(e)}function getUuidFromPath(e){return EditorExtends.UuidUtils.getUuidFromLibPath(e)}function nameToSubId(e){return EditorExtends.UuidUtils.nameToSubId(e)}function getResImportPath(e,r,t=".json"){return(0,path_1.join)(e,Build.IMPORT_HEADER,r.substr(0,2),r+t)}function getResRawAssetsPath(e,r,t){return(0,path_1.join)(e,Build.NATIVE_HEADER,r.substr(0,2),r+t)}function toBabelModules(e){return"esm"!==e&&e}async function transformCode(e,r){return null==(e=await babel.transformAsync(e,{presets:[[preset_env_1.default,{modules:r.importMapFormat?toBabelModules(r.importMapFormat):void 0}]],plugins:r.plugins}))?void 0:e.code}function compileJS(e,r){let t;try{var s=require("@babel/core");t=s.transform(e,{ast:!1,highlightCode:!1,sourceMaps:!1,compact:!1,filename:r,presets:[require("@babel/preset-env")],plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")],[require("@babel/plugin-proposal-export-default-from")]]})}catch(e){throw e.stack=`Compile ${r} error: `+e.stack,e}return t.code}async function createBundle(e,o,a){return new Promise((t,s)=>{const r=browserify(e);a&&a.excludes&&a.excludes.forEach(function(e){r.exclude(e)}),(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(o)),r.transform(babelify,{presets:[require("@babel/preset-env")],plugins:[require("@babel/plugin-proposal-class-properties")]}).bundle((e,r)=>{e?(console.error(e),s(e)):((0,fs_1.writeFileSync)(o,r,"utf8"),t())})})}exports.removeDbHeader=removeDbHeader,exports.dbUrlToRawPath=dbUrlToRawPath,exports.relativeUrl=relativeUrl,exports.isInstallNodeJs=isInstallNodeJs,exports.getFileSizeDeep=getFileSizeDeep,exports.copyDirSync=copyDirSync,exports.transI18nName=transI18nName,exports.compressUuid=compressUuid,exports.decompressUuid=decompressUuid,exports.getUuidFromPath=getUuidFromPath,exports.nameToSubId=nameToSubId,exports.getResImportPath=getResImportPath,exports.getResRawAssetsPath=getResRawAssetsPath,exports.toBabelModules=toBabelModules,exports.transformCode=transformCode,exports.compileJS=compileJS,exports.createBundle=createBundle;const HASH_LEN=5;async function appendMd5ToPaths(e){if(!Array.isArray(e))return null;var r,t=[];for(const a of e=e.sort())try{r=await(0,fs_extra_1.readFile)(a),t.push(r)}catch(e){console.error(e),console.error(`readFile {link(${a})}`);continue}const s=calcMd5(t),o=[];return await Promise.all(e.map((e,r)=>(o[r]=patchMd5ToPath(e,s),(0,fs_extra_1.rename)(e,o[r])))),{paths:o,hash:s}}function calcMd5(e){e=Array.isArray(e)?e:[e];var r=require("crypto")["createHash"];const t=r("md5");return e.forEach(e=>{t.update(e)}),t.digest("hex").slice(0,HASH_LEN)}function patchMd5ToPath(e,r){e=(0,path_1.parse)(e);return e.base="",e.name+="."+r,(0,path_1.format)(e)}function queryImageAssetFromSubAssetByUuid(e){return""}exports.appendMd5ToPaths=appendMd5ToPaths,exports.calcMd5=calcMd5,exports.patchMd5ToPath=patchMd5ToPath,exports.quickSpawn=sub_process_manager_1.workerManager.quickSpawn.bind(sub_process_manager_1.workerManager),exports.queryImageAssetFromSubAssetByUuid=queryImageAssetFromSubAssetByUuid,__exportStar(require("./memory-track"),exports);