"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuilderAssetCache=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("../utils/index"),asset_library_1=require("./asset-library"),cconb_1=require("../utils/cconb");class BuilderAssetCache{constructor(s){this.scenes=[],this.scriptUuids=[],this.assetUuids=[],this.instanceMap={},this._task=s}async init(){await asset_library_1.buildAssetLibrary.init()}async hasAsset(e){return!!(this.assetUuids.includes(e)||this.scriptUuids.includes(e)||this.scenes.find(s=>s.uuid===e))}addAsset(s,e){if(!s.invalid&&!s.url.startsWith("db://internal/default_file_content"))switch(s._assetDB||(console.warn("The addAsset method no longer supports the AssetInfo type, so please pass parameters that conform to the IAsset interface definition."),s=asset_library_1.buildAssetLibrary.getAsset(s.uuid)),e||asset_library_1.buildAssetLibrary.getAssetProperty(s,"type")){case"cc.SceneAsset":this.scenes.push({uuid:s.uuid,url:s.url});break;case"cc.Script":s.url.toLowerCase().endsWith(".d.ts")||this.scriptUuids.push(s.uuid);break;default:(s.meta.files.includes(".json")||(0,cconb_1.hasCCONFormatAssetInLibrary)(s))&&this.assetUuids.push(s.uuid)}}removeAsset(e,s){var t=asset_library_1.buildAssetLibrary.getAsset(e);if(t)switch(s||asset_library_1.buildAssetLibrary.getAssetProperty(t,"type")){case"cc.SceneAsset":for(let s=0;s<this.scenes.length;s++)if(this.scenes[s].uuid===e)return void this.scenes.splice(s,1);break;case"cc.Script":for(let s=0;s<this.scriptUuids.length;s++)if(this.scriptUuids[s]===e)return void this.scriptUuids.splice(s,1);break;default:(0,index_1.recursively)(t,e=>{if(e.meta.files.includes(".json")||(0,cconb_1.hasCCONFormatAssetInLibrary)(e))for(let s=0;s<this.assetUuids.length;s++)if(this.assetUuids[s]===e.uuid)return void this.assetUuids.splice(s,1)})}}getAssetInfo(s){return asset_library_1.buildAssetLibrary.getAssetInfo(s)}addInstance(s){s&&s._uuid&&(this.instanceMap[s._uuid]=s)}clearAsset(s){this.scenes.length=0,this.scriptUuids.length=0,this.assetUuids.length=0,delete this.instanceMap[s]}getMeta(s){return asset_library_1.buildAssetLibrary.getMeta(s)}async addMeta(s,e){asset_library_1.buildAssetLibrary.addMeta(s,e)}async getDependUuids(s){return asset_library_1.buildAssetLibrary.getDependUuids(s)}async getDependUuidsDeep(s){return asset_library_1.buildAssetLibrary.getDependUuidsDeep(s)}async getLibraryJSON(s){s=asset_library_1.buildAssetLibrary.getAsset(s);return s&&s.meta.files.includes(".json")?(0,fs_extra_1.readJSON)(s.library+".json"):null}async getSerializedJSON(s,e){var t=this.instanceMap[s];let i;return(i=t?asset_library_1.buildAssetLibrary.serialize(t,e):await asset_library_1.buildAssetLibrary.getSerializedJSON(s,e))||null}async outputAssetJson(s,e,t){var i=asset_library_1.buildAssetLibrary.getAsset(s),r=this.instanceMap[s];(r||i)&&(r?(i=(0,path_1.join)(e,i.library.replace((0,path_1.join)(Editor.Project.path,"library"),"")+".json"),r=asset_library_1.buildAssetLibrary.serialize(r,{debug:t.debug}),await(0,fs_extra_1.outputJSON)(i,r)):(i=(0,path_1.join)(e,s.substr(0,2),s+".json"),await asset_library_1.buildAssetLibrary.outputAssets(s,i,t.debug)))}async forEach(s,e){if(this[s]){var t=Object.keys(this[s]);if(t)for(let s=0;s<t.length;s++){var i=t[s];e&&await e(i,s)}}}async getInstance(s){return this.instanceMap[s]||(s=await asset_library_1.buildAssetLibrary.getAsset(s),asset_library_1.buildAssetLibrary.getInstance(s))}__addStaticsInfo(s){this._task&&(console.warn(Editor.I18n.t("builder.warn.deprecatedTip",{oldName:"cache.__addStaticsInfo",newName:"result.staticsInfo"})),Object.assign(this._task.result.staticsInfo,s))}}exports.BuilderAssetCache=BuilderAssetCache;