"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildTaskBase=void 0;const events_1=__importDefault(require("events"));class BuildTaskBase extends events_1.default{constructor(e){super(),this.progress=0,this.hookWeight=.4,this.name=e}async break(e){return new Promise(e=>{this.breakResolve=e})}onError(e,t=!0){if(this.error=e,t)throw e}updateProcess(e,t=0){this.progress=Editor.Utils.Math.clamp01(this.progress+t),this.emit("update",e,this.progress)}async runPluginTask(r,e){var t;if(!(!Object.keys(this.hookMap).length||this.error||null!=(t=this.options)&&t.preview)){var s=this.hookWeight/Object.keys(this.hookMap).length;for(let e=0;e<this.hooksInfo.pkgNameOrder.length;e++){if(this.breakResolve){this.breakResolve(),this.onError(new Error(this.name+" task is break!"));break}if(this.error)return;var o=this.hooksInfo.pkgNameOrder[e],i=this.hooksInfo.infos[o];let t;try{var a,h=`// ---- build task ${o}：${r} ----`;Editor.Metrics.trackTimeStart(h),(t=Editor.Module.__protected__.requireFile(i.path))[r]&&(this.updateProcess(o+`:(${r}) start...`),console.debug(h),await this.handleHook(t[r],i.internal),a=await Editor.Metrics.trackTimeEnd(h,{output:!0}),this.updateProcess(o+`:(${r}) in ${a} ms ✓`,s))}catch(e){o=Editor.I18n.t("builder.error.run_hooks_failed",{pkgName:o,funcName:r});this.updateProcess(o,s),this.updateProcess(e+"",s),(t&&t.throwError||i.internal)&&this.onError(e)}}}}}exports.BuildTaskBase=BuildTaskBase;