"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,s,t,r){void 0===r&&(r=t);var a=Object.getOwnPropertyDescriptor(s,t);a&&("get"in a?s.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return s[t]}}),Object.defineProperty(e,r,a)}:function(e,s,t,r){e[r=void 0===r?t:r]=s[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,s){Object.defineProperty(e,"default",{enumerable:!0,value:s})}:function(e,s){e.default=s}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(s,e,t);return __setModuleDefault(s,e),s};Object.defineProperty(exports,"__esModule",{value:!0}),exports.outputJsonGroup=exports.handleJsonGroup=void 0;const path_1=require("path"),bundle_utils_1=require("../../../../share/bundle-utils"),asset_library_1=require("../../manager/asset-library"),json_group_1=require("../json-group"),HashUuid=__importStar(require("../../utils/hash-uuid")),fs_extra_1=require("fs-extra"),utils_1=require("../../../../share/utils"),EditorExtends=require("@base/electron-module").require("EditorExtends");async function handleJsonGroup(t){if(console.debug("handle json group in bundle "+t.name),t.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE){if(t.compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON)t.addGroup("NORMAL",t.assetsWithoutRedirect);else{const r={},a=[];var e=[];for(const i of t.assetsWithoutRedirect){var s=asset_library_1.buildAssetLibrary.getAsset(i);if("cc.Texture2D"==asset_library_1.buildAssetLibrary.getAssetProperty(s,"type"))e.push(s.uuid);else{let e=await(0,json_group_1.walk)(s,t);e.length<=1||(e=e.filter(e=>!a.includes(e))).length<=1||(a.push(...e),r[i]=e)}}1<e.length&&(e.sort(utils_1.compareUUID),t.addGroup("TEXTURE",e)),Object.keys(r).forEach(s=>{var e=r[s];e&&JSON.parse(JSON.stringify(e)).forEach(e=>{s!==e&&r[e]&&(console.debug("remove group uuid "+e),delete r[e])})}),Object.values(r).forEach((e,s)=>{e.length<=1||t.addGroup("NORMAL",e)})}console.debug(`handle json group in bundle ${t.name} success`)}}async function outputJsonGroup(s,t){var r=(0,path_1.join)(s.dest,s.importBase);console.debug("Handle all json groups in bundle "+s.name);let a=[];const i=[];s.groups.forEach(e=>{i.push(e.uuids),e.uuids.length<=1||(a=a.concat(e.uuids))});var o=new Set(a),u=HashUuid.calculate(i,HashUuid.BuiltinHashType.PackedAssets);console.debug("handle json group");const n=Object.assign({debug:t.options.debug},t.options.assetSerializeOptions);for(let e=0;e<s.groups.length;e++){var l=s.groups[e];if(!(l.uuids.length<=1))if(l.name=u[e],l.uuids.sort(utils_1.compareUUID),s.addAssetWithUuid(l.name),o.add(l.name),"TEXTURE"===l.type){p=c=d=void 0;var d=r,c=u[e],p=l;p=(p=await Promise.all(p.uuids.map(async e=>{var s=await t.cache.getSerializedJSON(e,n);return s||console.error(`Can't get SerializedJSON of asset {asset(${e})}`),s}))).map(e=>{var{base:e,mipmaps:s}=EditorExtends.serializeCompiled.getRootData(e);return[e,s]}),p={type:cc.js.getClassId(cc.Texture2D),data:p},!await y(d,c,p)}else if("IMAGE"===l.type){p=c=d=void 0;d=r,c=u[e],p=l;p=await Promise.all(p.uuids.map(async e=>{var s=await t.cache.getSerializedJSON(e,n);return s||console.error(`Can't get SerializedJSON of asset {asset(${e})}`),s})),p={type:cc.js.getClassId(cc.ImageAsset),data:p},!await y(d,c,p)}else if("NORMAL"===l.type){let s=[];var _=[];l.uuids.sort();for(let e=0;e<l.uuids.length;e++){var g,h=asset_library_1.buildAssetLibrary.getAsset(l.uuids[e]);h&&!h.meta.files.includes(".json")||((g=await t.cache.getSerializedJSON(l.uuids[e],n))?(_.push(l.uuids[e]),s.push(g)):console.error(Editor.I18n.t("builder.error.get_asset_json_failed",{url:h.url,type:asset_library_1.buildAssetLibrary.getAssetProperty(h,"type")})))}l.uuids=_,s=JSON.parse(JSON.stringify(s)),s=EditorExtends.serializeCompiled.packJSONs(s),await y(r,u[e],s),console.debug(`Json group(${l.name}) compile successï¼Œjson number: `+s.length)}}console.debug("handle single json");for(const m of s.assetsWithoutRedirect)if(!o.has(m)){var b=await t.cache.getSerializedJSON(m,n);if(b){var f=asset_library_1.buildAssetLibrary.getAsset(m);let e=m;await y(r,e=f&&f.library&&f.meta.files.includes(".json")?(0,path_1.basename)(f.library):e,b)}}async function y(e,s,t){e=(0,path_1.join)(e,s.substr(0,2),s+".json");await(0,fs_extra_1.outputJSON)(e,t)}s.groups.forEach(e=>{e.name&&s.addAssetWithUuid(e.name)})}exports.handleJsonGroup=handleJsonGroup,exports.outputJsonGroup=outputJsonGroup;