"use strict";function Rect(t,e,i,h){this.x=t||0,this.y=e||0,this.width=i||0,this.height=h||0}Rect.prototype={constructor:Rect,clone:function(){return new Rect(this.x,this.y,this.width,this.height)}},Rect.isContainedIn=function(t,e){return t.x>=e.x&&t.y>=e.y&&t.x+t.width<=e.x+e.width&&t.y+t.height<=e.y+e.height};var BestShortSideFit=0,BestLongSideFit=1,BestAreaFit=2,BottomLeftRule=3,ContactPointRule=4,LeftoverArea=5;function MaxRectsBinPack(t,e,i){this.binWidth=0,this.binHeight=0,this.allowRotate=!1,this.usedRectangles=[],this.freeRectangles=[],this.init(t,e,i)}MaxRectsBinPack.prototype={constructor:MaxRectsBinPack,init:function(t,e,i){this.binWidth=t,this.binHeight=e,this.allowRotate=i||!1,this.usedRectangles.length=0,this.freeRectangles.length=0,this.freeRectangles.push(new Rect(0,0,t,e))},insertRects:function(t,e){for(var i=[];0<t.length;){for(var h=1/0,a=1/0,n=-1,o=new Rect,s=0;s<t.length;s++){var l={value:0},r={value:0},u=this._scoreRectangle(t[s].width,t[s].height,e,l,r);(l.value<h||l.value===h&&r.value<a)&&(h=l.value,a=r.value,o=u,n=s)}if(-1===n)return i;this._placeRectangle(o);var c=t.splice(n,1)[0];c.x=o.x,c.y=o.y,c.width!==c.height&&c.width===o.height&&c.height===o.width&&(c.rotated=!c.rotated),i.push(c)}return i},_placeRectangle:function(t){for(var e=0;e<this.freeRectangles.length;e++)this._splitFreeNode(this.freeRectangles[e],t)&&(this.freeRectangles.splice(e,1),e--);this._pruneFreeList(),this.usedRectangles.push(t)},_scoreRectangle:function(t,e,i,h,a){var n=new Rect;switch(h.value=1/0,a.value=1/0,i){case BestShortSideFit:n=this._findPositionForNewNodeBestShortSideFit(t,e,h,a);break;case BottomLeftRule:n=this._findPositionForNewNodeBottomLeft(t,e,h,a);break;case ContactPointRule:n=this._findPositionForNewNodeContactPoint(t,e,h),h=-h;break;case BestLongSideFit:n=this._findPositionForNewNodeBestLongSideFit(t,e,a,h);break;case BestAreaFit:n=this._findPositionForNewNodeBestAreaFit(t,e,h,a);break;case LeftoverArea:n=this._findPositionForNewNodeLeftoverArea(t,e,h,a)}return 0===n.height&&(h.value=1/0,a.value=1/0),n},_findPositionForNewNodeBottomLeft:function(t,e,i,h){var a,n,o=this.freeRectangles,s=new Rect;i.value=1/0;for(var l=0;l<o.length;l++)(a=o[l]).width>=t&&a.height>=e&&((n=a.y+e)<i.value||n===i.value&&a.x<h.value)&&(s.x=a.x,s.y=a.y,s.width=t,s.height=e,i.value=n,h.value=a.x),this.allowRotate&&a.width>=e&&a.height>=t&&((n=a.y+t)<i.value||n===i.value&&a.x<h.value)&&(s.x=a.x,s.y=a.y,s.width=e,s.height=t,i.value=n,h.value=a.x);return s},_findPositionForNewNodeBestShortSideFit:function(t,e,i,h){var a=this.freeRectangles,n=new Rect;i.value=1/0;for(var o,s,l,r,u,c=0;c<a.length;c++)(u=a[c]).width>=t&&u.height>=e&&(l=Math.abs(u.width-t),o=Math.abs(u.height-e),s=Math.min(l,o),l=Math.max(l,o),s<i.value||s===i.value&&l<h.value)&&(n.x=u.x,n.y=u.y,n.width=t,n.height=e,i.value=s,h.value=l),this.allowRotate&&u.width>=e&&u.height>=t&&(o=Math.abs(u.width-e),s=Math.abs(u.height-t),l=Math.min(o,s),r=Math.max(o,s),l<i.value||l===i.value&&r<h.value)&&(n.x=u.x,n.y=u.y,n.width=e,n.height=t,i.value=l,h.value=r);return n},_findPositionForNewNodeBestLongSideFit:function(t,e,i,h){var a,n,o,s,l,r=this.freeRectangles,u=new Rect;h.value=1/0;for(var c=0;c<r.length;c++)(a=r[c]).width>=t&&a.height>=e&&(n=Math.abs(a.width-t),o=Math.abs(a.height-e),s=Math.min(n,o),(l=Math.max(n,o))<h.value||l===h.value&&s<i.value)&&(u.x=a.x,u.y=a.y,u.width=t,u.height=e,i.value=s,h.value=l),this.allowRotate&&a.width>=e&&a.height>=t&&(n=Math.abs(a.width-e),o=Math.abs(a.height-t),s=Math.min(n,o),(l=Math.max(n,o))<h.value||l===h.value&&s<i.value)&&(u.x=a.x,u.y=a.y,u.width=e,u.height=t,i.value=s,h.value=l);return u},_findPositionForNewNodeBestAreaFit:function(t,e,i,h){var a,n,o,s=this.freeRectangles,l=new Rect,r=t*e;i.value=1/0;for(var u=0;u<s.length;u++){var c=s[u],d=c.width*c.height-r;c.width>=t&&c.height>=e&&(a=c.width-t,n=c.height-e,o=Math.min(a,n),d<i.value||d===i.value&&o<h.value)&&(l.x=c.x,l.y=c.y,l.width=t,l.height=e,h.value=o,i.value=d),this.allowRotate&&c.width>=e&&c.height>=t&&(a=c.width-e,n=c.height-t,o=Math.min(a,n),d<i.value||d===i.value&&o<h.value)&&(l.x=c.x,l.y=c.y,l.width=e,l.height=t,h.value=o,i.value=d)}return l},_findPositionForNewNodeLeftoverArea:function(t,e,i,h){var a,n,o,s,l,r=this.freeRectangles,u=new Rect;i.value=0;for(var c=h.value=0;c<r.length;c++)l=(a=r[c]).width*a.height-t*e,a.width>=t&&a.height>=e&&(n=Math.abs(a.width-t),o=Math.abs(a.height-e),s=Math.min(n,o),l>i.value||l===i.value&&s>h.value)&&(u.x=a.x,u.y=a.y,u.width=t,u.height=e,h.value=s,i.value=l),this.allowRotate&&a.width>=e&&a.height>=t&&(n=Math.abs(a.width-e),o=Math.abs(a.height-t),s=Math.min(n,o),l>i.value||l===i.value&&s>h.value)&&(u.x=a.x,u.y=a.y,u.width=e,u.height=t,h.value=s,i.value=l);return i.value=this.binWidth*this.binHeight-i.value,h.value=Math.min(this.binWidth,this.binHeight)-h.value,u},_commonIntervalLength:function(t,e,i,h){return e<i||h<t?0:Math.min(e,h)-Math.max(t,i)},_contactPointScoreNode:function(t,e,i,h){var a,n=this.usedRectangles,o=0;0!==t&&t+i!==this.binWidth||(o+=h),0!==e&&e+h!==this.binHeight||(o+=i);for(var s=0;s<n.length;s++)(a=n[s]).x!==t+i&&a.x+a.width!==t||(o+=this._commonIntervalLength(a.y,a.y+a.height,e,e+h)),a.y!==e+h&&a.y+a.height!==e||(o+=this._commonIntervalLength(a.x,a.x+a.width,t,t+i));return o},_findPositionForNewNodeContactPoint:function(t,e,i){var h,a,n=this.freeRectangles,o=new Rect;i.value=-1;for(var s=0;s<n.length;s++)(h=n[s]).width>=t&&h.height>=e&&(a=this._contactPointScoreNode(h.x,h.y,t,e))>i.value&&(o.x=h.x,o.y=h.y,o.width=t,o.height=e,i=a),this.allowRotate&&h.width>=e&&h.height>=t&&(a=this._contactPointScoreNode(h.x,h.y,e,t))>i.value&&(o.x=h.x,o.y=h.y,o.width=e,o.height=t,i.value=a);return o},_splitFreeNode:function(t,e){var i,h=this.freeRectangles;return!(e.x>=t.x+t.width||e.x+e.width<=t.x||e.y>=t.y+t.height||e.y+e.height<=t.y||(e.y>t.y&&e.y<t.y+t.height&&((i=t.clone()).height=e.y-t.y,h.push(i)),e.y+e.height<t.y+t.height&&((i=t.clone()).y=e.y+e.height,i.height=t.y+t.height-i.y,h.push(i)),e.x>t.x&&e.x<t.x+t.width&&((i=t.clone()).width=e.x-t.x,h.push(i)),e.x+e.width<t.x+t.width&&((i=t.clone()).x=e.x+e.width,i.width=t.x+t.width-i.x,h.push(i)),0))},_pruneFreeList:function(){for(var t=this.freeRectangles,e=0;e<t.length;e++)for(var i=e+1;i<t.length;i++){if(Rect.isContainedIn(t[e],t[i])){t.splice(e,1),e--;break}Rect.isContainedIn(t[i],t[e])&&(t.splice(i,1),i--)}}},MaxRectsBinPack.heuristices={BestShortSideFit:BestShortSideFit,BestLongSideFit:BestLongSideFit,BestAreaFit:BestAreaFit,BottomLeftRule:BottomLeftRule,ContactPointRule:ContactPointRule,LeftoverArea:LeftoverArea},module.exports=MaxRectsBinPack;