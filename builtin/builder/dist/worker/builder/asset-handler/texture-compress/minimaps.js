"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compressMipmapFiles=exports.checkHasMipMaps=exports.genMipmapFiles=exports.getMipLevel=exports.isPowerOfTwo=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),Sharp=require("sharp");function isPowerOfTwo(e){return 0<e&&0==(e&e-1)}function getMipLevel(e,t){let a=Math.max(e,t),s=0;for(;a;)a>>=1,s++;return s}async function genMipmapFiles(e,t,a){var s=Sharp(e),i=await s.metadata();if(!isPowerOfTwo(i.width)||!isPowerOfTwo(i.height))throw new Error(Editor.I18n.t("builder.project.texture_compress.mipmap.noPowerOfTwo"));let p=i.width,r=i.height;t=t||(0,path_1.dirname)(e);var o=(0,path_1.extname)(e),n=(0,path_1.basename)(e,o),m=[];for(let e=getMipLevel(p,r);0<e&&(1!==p||1!==r);e--){p=Math.max(p/2,1),r=Math.max(r/2,1);var c=(0,path_1.join)(t,"mipmaps",n+"@mipmap_"+(e-1)+o);m.push(c),(0,fs_extra_1.existsSync)(c)||((0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(c)),await s.resize(p,r).toFile(c))}return m}function checkHasMipMaps(e){let t;return e.subMetas["6c48a"]?t=e.subMetas["6c48a"].userData.mipfilter:e.userData.textureSetting&&(t=e.userData.textureSetting.mipfilter),!!["nearest","linear"].includes(t)}async function compressMipmapFiles(t,a){if(!t.mipmapFiles||!t.mipmapFiles.length||["png","jpg","webp"].includes(t.format))return[];console.debug("Start merge mipmaps file of asset "+t.uuid);var s=[];for(let e=0;e<t.mipmapFiles.length;e++){var i=t.mipmapFiles[e],p=(0,path_1.join)((0,path_1.dirname)(t.dest),"mipmaps",(0,path_1.basename)(i,(0,path_1.extname)(i))+(0,path_1.extname)(t.dest));await a(Object.assign(Object.assign({},t),{src:i,dest:p})),s.push((0,fs_extra_1.readFileSync)(p))}return console.debug(`Merge mipmaps file of asset ${t.uuid} success`),s}exports.isPowerOfTwo=isPowerOfTwo,exports.getMipLevel=getMipLevel,exports.genMipmapFiles=genMipmapFiles,exports.checkHasMipMaps=checkHasMipMaps,exports.compressMipmapFiles=compressMipmapFiles;