"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.newConsole=exports.NewConsole=exports.rawConsole=void 0;const fs_1=require("fs"),path_1=require("path"),utils_1=require("../share/utils"),electron_logger_1=__importDefault(require("@base/electron-logger")),memory_track_1=require("./builder/utils/memory-track"),fs_extra_1=require("fs-extra"),logLevelMap={error:1,warn:2,log:3,debug:4};class NewConsole{static async updateLogLevel(e){((e=e||await Editor.Profile.getConfig("builder","log.level"))||Object.values(logLevelMap).includes(Number(e)))&&electron_logger_1.default.setLevel(3)}constructor(){this.command=!1,this.messages=[],this._groupNames=[],this.memoryTrackMap=new Map,this.id="default",this.logDest=(0,path_1.join)(NewConsole.logDest,"normal.log"),this._start=!1,this._writeStream=null,this._updateLogFileTimer=null,console.__rawConsole?exports.rawConsole=console.__rawConsole:exports.rawConsole=console,this.__proto__.__proto__=exports.rawConsole}switchConsole(e){this._start?this._console=e:e.record()}record(e,t){try{this.logDest=Editor.UI.__protected__.File.resolveToRaw(t),(0,fs_1.existsSync)(this.logDest)||(0,fs_extra_1.outputFileSync)(this.logDest,""),this._writeStream=(0,fs_1.createWriteStream)(this.logDest,{flags:"a"})}catch(e){return console.debug(e),console.debug(`Create log file failed. {file(${this.logDest})}`),void(this._writeStream=null)}this._start=!0,this._updateLogFileTimer=null,this._groupNames.length=0,this.id=e,window.console=this,exports.rawConsole.debug(`Start record console... {file(${this.logDest})}`)}async stopRecord(){var e;this.messages.length&&(this._updateLogFileTimer&&clearTimeout(this._updateLogFileTimer),await this.saveLog(),this._updateLogFileTimer=null),null!=(e=this._writeStream)&&e.end(),this._writeStream=null,this._start=!1,this._groupNames.length=0,exports.rawConsole.debug(`Stop record console. {file(${this.logDest})}`),window.console=exports.rawConsole,this.id="",this._console&&(this._console.record(),delete this._console)}log(...e){exports.rawConsole.log(...e),this&&this.addMessage("log",e)}error(e){filterErrorToConsole(e)?exports.rawConsole.error(e):exports.rawConsole.debug(e),this&&this.addMessage("error",e)}warn(...e){exports.rawConsole.warn(...e),this&&this.addMessage("warn",e)}debug(...e){exports.rawConsole.debug(...e),this&&this.addMessage("debug",e)}group(e){exports.rawConsole.group(e),this._groupNames.push(e),this&&this.addMessage("group",[e])}groupEnd(){exports.rawConsole.groupEnd();var e=this._groupNames.pop();this&&this.addMessage("groupEnd",[e])}groupCollapsed(e){exports.rawConsole.groupCollapsed(e),this._groupNames.push(e),this&&this.addMessage("groupCollapsed",[e])}async addMessage(e,t){try{var s=translate(t),r=this.messages[this.messages.length-1];r&&s===r.value?r.num++:this.messages.push({type:e,value:s,time:(0,utils_1.getCurrentTime)(),num:1}),await this.save()}catch(e){exports.rawConsole.log(e)}}async save(){this.messages.length&&this._start&&!this._updateLogFileTimer&&(await this.saveLog(),this._updateLogFileTimer=setTimeout(()=>{this._updateLogFileTimer=null,this.saveLog()},500))}async saveLog(){var e=this.messages;this.messages=[];let s="";if(e.forEach(e=>{var t=`${e.time} - ${e.type}${1<e.num?"("+e.num+")":""}: ${e.value}\n`;s+=t,this.command&&Worker.Ipc.send("build-worker:stdout",e.type,t)}),this._writeStream)try{await this._writeStream.write(s)}catch(e){exports.rawConsole.debug(e),this._writeStream.end(),this._writeStream=null}}trackMemoryStart(e){var t=process.memoryUsage().heapUsed;return this.memoryTrackMap.set(e,t),t}trackMemoryEnd(e,t=!0){var s,r,o=this.memoryTrackMap.get(e);return o?(s=process.memoryUsage().heapUsed,this.memoryTrackMap.delete(e),r=s-o,t?(console.debug(`[Build Memory track]: ${e} start:${(0,memory_track_1.formateBytes)(o)}, end ${(0,memory_track_1.formateBytes)(s)}, increase: `+(0,memory_track_1.formateBytes)(r)),t):r):0}}function filterErrorToConsole(e){return!(e.toString()||"").match(/^\[build-script\]\[BABEL\].*?it exceeds the max of 500KB.\n$/g)}function translate(e){if("string"==typeof e&&!e.includes("\n")||"number"==typeof e)return String(e);if("string"==typeof e&&e.includes("\n"))return translate(e.split("\n"));if("object"==typeof e){if(Array.isArray(e)){let t="";return e.forEach(e=>{t+=translate(e)+"\r"}),t}try{return e.stack?translate(e.stack):JSON.stringify(e)}catch(e){}}return e&&e.toString&&e.toString()}(exports.NewConsole=NewConsole).logDest=(0,path_1.join)(Editor.Project.path,"temp","builder","log"),exports.newConsole=new NewConsole;