"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,i,a)}:function(e,t,s,i){e[i=void 0===i?s:i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkOptionsBeforeCommand=exports.buildWithCommand=exports.manager=exports.TaskManager=void 0;const events_1=require("events"),path_1=require("path"),fs_extra_1=require("fs-extra"),plugin_1=require("./plugin"),utils_1=require("../share/utils"),migration_1=require("./migration"),os=__importStar(require("os")),worker_1=require("./worker"),electron_windows_1=__importDefault(require("@base/electron-windows"));let MainWin;const CRASH_LOG_DIR=(0,path_1.join)(Editor.Project.tmpDir,"builder","crash-log");class TaskItemBase extends events_1.EventEmitter{constructor(e){super(),this.state="waiting",this.progress=0,this.message="",this.detailMessage="",this.time="",this.isCommand=!1,this.free=!0,this.stage="build",this.breakType="",this.dirty=!1,this.id=e||String(Date.now())}async break(e="interrupted"){["waiting","processing"].includes(this.state)&&(this.update(1,"failure","The build task was "+(this.breakType||"interrupted")),"interrupted"!==(this.breakType=e)&&"cancel"!==e||await worker_1.workerManager.send("build-worker:break",this.id,e),Editor.Message.send("asset-db","resume"))}reset(){this.progress=0,this.state="waiting",this.message="",this.detailMessage="",this.breakType="",this.emitChange()}update(e,t,s,i){this.breakType||(this.progress=Editor.Utils.Math.clamp01(e),this.state="string"==typeof t?t:this.state,this.message="string"==typeof s?s:this.message,this.detailMessage="string"==typeof i?i:this.detailMessage,["success","failure"].includes(this.state)&&(this.free=!0,"success"!==this.state?this.resolve&&this.resolve(34):this.resolve&&this.resolve(36)),this.emitChange())}updateDetailMessage(e){this.breakType||(this.detailMessage="string"==typeof e?e:this.detailMessage,this.emitChange())}emitChange(){this.emit("update",this.id,this.toJSON(),this.free)}}class BuildTaskItem extends TaskItemBase{constructor(e,t,s){super(e),this.dirty=!1,this.type="build",this.options=t,s&&(this.resolve=s)}run(s){return new Promise(async e=>{if("build"!==s)await this.runBuildStageTask(s);else{this.stage="build",this.time=(0,utils_1.getCurrentTime)(),console.debug("Check and complete build options",this.options),this.options.taskName||(this.options.taskName=this.options.outputName);let e;try{e=await plugin_1.pluginManager.checkOptions(this.options)}catch(e){console.error(e)}var t;e?(this.options=e,plugin_1.pluginManager.platformMap[this.options.platform]?(this.dirty=!1,this.options.logDest||(this.options.logDest=(0,utils_1.getTaskLogDest)(this.options.platform,this.id)),t=await worker_1.workerManager.send("build-worker:build",this.id,Object.assign({nextStages:this.options.buildStageGroup&&this.options.buildStageGroup.build},this.options),!!this.isCommand),this.state=t?"success":"failure",this.free=!0,this.resolve&&this.resolve(t?36:34)):(this.update(0,"failure",Editor.I18n.t("builder.error.platformRegisterError",{platform:this.options.platform})),this.resolve&&this.resolve(50))):(this.update(0,"failure",Editor.I18n.t("builder.error.check_options_failed")),this.resolve&&this.resolve(32))}e()})}async runBuildStageTask(e){var t=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(this.options.buildPath),this.options.outputName),t=(this.currentStageTask=new StageTaskItem(this.id,e,{root:t,nextStages:this.options.buildStageGroup&&this.options.buildStageGroup[e],platform:this.options.platform,buildTaskOptions:this.options},this.resolve),this.stage=e,await this.currentStageTask.run(e));this.state=t?"success":"failure",this.free=!0}toJSON(){return{type:"build",id:this.id,progress:this.progress,state:this.state,stage:this.stage,message:this.message,detailMessage:this.detailMessage,options:this.options,time:this.time,dirty:this.dirty}}updateFromJSON(e){this.id=e.id,this.progress=e.progress,this.state=e.state||"waiting",this.stage=e.stage,this.message=e.message,this.detailMessage=e.detailMessage||"",this.options=e.options,this.time=e.time||(0,utils_1.changeToLocalTime)(e.id),this.dirty=e.dirty}}class StageTaskItem extends TaskItemBase{constructor(e,t,s,i,a=!1){super(e),this.type="stage",this.stage=t,this.options=s,this.isCommand=a,i&&(this.resolve=i)}async run(e){if(this.stage=e,this.options.taskId=this.id,this.options.taskName||(this.options.taskName=this.stage+" build"),plugin_1.pluginManager.platformMap[this.options.platform])return e=await worker_1.workerManager.send("build-worker:execute-build-stage",this.stage,this.options),this.resolve&&this.resolve(e?36:34),e;this.update(0,"failure",Editor.I18n.t("builder.error.platformRegisterError",{platform:this.options.platform})),this.resolve&&this.resolve(50)}toJSON(){return{type:"build-stage",id:this.id,progress:this.progress,state:this.state,stage:this.stage,message:this.message,detailMessage:this.detailMessage,options:this.options,time:this.time}}updateFromJSON(e){this.id=e.id,this.progress=e.progress,this.state=e.state||"waiting",this.stage=e.stage,this.message=e.message,this.detailMessage=e.detailMessage||"",this.options=e.options,this.time=e.time||(0,utils_1.changeToLocalTime)(e.id)}}class BundleTaskItem extends TaskItemBase{constructor(e,t,s){super(e),this.type="bundle",this.options=t,s&&(this.resolve=s)}async run(){if(this.options.optionList&&this.options.optionList.length){this.options.taskName||(this.options.taskName="Build Bundle");var e=this.options.logDest||(0,utils_1.getTaskLogDest)("build-bundle-",Date.now()),t=[];for(const i of this.options.optionList){if(!plugin_1.pluginManager.platformMap[i.platform])return this.update(0,"failure",Editor.I18n.t("builder.error.platformRegisterError",{platform:i.platform})),void(this.resolve&&this.resolve(50));t.push(Object.assign(Object.assign({},i),{dest:(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(this.options.dest),i.outputName),bundleConfigs:this.options.bundleConfigs,buildBundleOnly:!0,taskName:this.options.taskName,id:this.id,logDest:e}))}var s=await worker_1.workerManager.send("build-worker:build-bundles",t);this.resolve&&this.resolve(s?36:34)}else console.error("Invalid bundle options "+JSON.stringify(this.options)),this.resolve&&this.resolve(32)}toJSON(){return{id:this.id,progress:this.progress,state:this.state,message:this.message,detailMessage:this.detailMessage,options:{dest:this.options.dest,buildTaskIds:this.options.buildTaskIds,taskName:this.options.taskName,bundleConfigs:this.options.bundleConfigs},time:this.time,type:"bundle"}}updateFromJSON(e){this.id=e.id,this.progress=e.progress,this.state=e.state||"waiting",this.message=e.message,this.detailMessage=e.detailMessage||"",this.options=e.options,this.time=e.time||(0,utils_1.changeToLocalTime)(e.id)}update(e,t,s){super.update(e,t,s)}}class TaskManager extends events_1.EventEmitter{constructor(){super(...arguments),this.command=!1,this.currentTaskId="",this.worker=null,this._workerReady=!1,this._dbReady=!1,this._scriptReady=!1,this.map={},this.waitingTaskIDs=[],this.crashNum=0,this.dbPauseNoticeId=0,this.hasInit=!1,this._crashInfo={}}get ready(){return this._workerReady&&this._dbReady&&this._scriptReady}get free(){return TaskManager.supportTaskQueue||!this.waitingTaskIDs.length}set workerReady(e){e!==this._workerReady&&(this._workerReady=e,this.step())}get workerReady(){return this._workerReady}set scriptReady(e){e!==this._scriptReady&&(this._scriptReady=e,this.step())}get scriptReady(){return this._scriptReady}set dbReady(e){e!==this._dbReady&&(this._dbReady=e)&&worker_1.workerManager.init()}get dbReady(){return this._dbReady}async init(){if(!this.hasInit){this.dbReady=await Editor.Message.request("asset-db","query-ready"),this.scriptReady=await Editor.Message.request("programming","packer-driver/ready","editor");const s=await Editor.Profile.getConfig("builder","BuildTaskManager.taskMap")||{};Object.keys(s).sort(utils_1.compareNumeric).forEach(e=>{e=s[e];let t;e.options?"build-stage"!==e.type&&"bundle"!==e.type&&((t=new BuildTaskItem(e.id,e.options)).updateFromJSON(e),t.addListener("update",this._onTaskProgress),1!==e.progress&&(t.state="failure"),1===e.progress&&"processing"===t.state&&(t.state="success"),this.map[e.id]?console.warn("The same task name has exists!"):this.map[e.id]=t):console.debug("Invalid build task with empty options!")}),plugin_1.pluginManager.packageRegisterInfo.forEach(e=>{this.onAfterPackageRegister(e)}),plugin_1.pluginManager.on("register",this.onAfterPackageRegister),plugin_1.pluginManager.on("unregister",this.onAfterPackageUnRegister),MainWin=electron_windows_1.default.uuid2win[electron_windows_1.default.uuids[0]],this.hasInit=!0}}destroy(){this.hasInit=!1,plugin_1.pluginManager.removeListener("register",this.onAfterPackageRegister),plugin_1.pluginManager.removeListener("unregister",this.onAfterPackageUnRegister)}initWorker(e){!this.worker&&e&&(this.worker=e,this.worker.on("refresh",()=>{console.debug("builder refresh"),this.breakAll("refreshed"),Editor.Message.broadcast("build-worker:closed")}),this.worker.on("closed",()=>{this.workerReady=!1,Editor.Message.broadcast("build-worker:closed")}),this.worker.ipc.on("build-worker:update-progress",async(e,t,s,i,a)=>{t=this.map[t];t&&(t.update(s,i,a),await this.save(),t.isCommand)&&console.log(`building ${i} ${(100*t.progress).toFixed(2)}% `+a)}),this.worker.ipc.on("builder-worker:store-crash-info",(e,t,s)=>{this.map[t]&&s&&(this._crashInfo=s)}),this.worker.ipc.on("build-worker:update-build-stage-progress",async(e,t,s,i,a)=>{t&&this.map[t]&&((t=this.map[t]).update(s,i,a),await this.save(),t.isCommand)&&console.log(`building ${i} ${(100*t.progress).toFixed(2)}% `+a)}),this.worker.ipc.on("build-worker:update-detail-message",async(e,t,s)=>{t&&this.map[t]&&t===this.currentTaskId&&(this.map[t].updateDetailMessage(s),await this.save())}),this.worker.ipc.on("build-worker:stdout",(e,t,s)=>{t.startsWith("group")&&(t="debug"),console[t](s)}),this.worker.on("render-process-gone",(e,t)=>{this.onProcessGone(e,t)}))}onProcessGone(e,t){if((!this.currentTaskId||this.free)&&(console.error(Editor.I18n.t("builder.error.builder_crash")),console.error(e,t),this.workerReady)){worker_1.workerManager.reset();var s=this.map[this.currentTaskId];if(s){var i="crashed"===t.reason||"oom"===t.reason;if(s.break(i?"crashed":"refreshed"),i){this.crashNum++;i="Builder Process Creashed when build platform: "+s.options.platform;try{var a=s.options,r=this._crashInfo,o={B100000:a.platform||"",B100002:Editor.Project.uuid,B100003:a.name||"",B100004:r.B100004||"",B100005:a.scenes.length||0,B100006:r.B100006||0,B100007:r.B100007||0,B100008:a.includeModules||[],B100009:r.B100009||""},n=(Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"editorBuildCrash",value:Object.assign({},o)}),(0,path_1.join)(CRASH_LOG_DIR,String(Date.now())));(0,fs_extra_1.outputJSONSync)(n,{type:"render-process-gone",event:e,detail:t,message:i,sysInfo:{freemem:formatByteSize(os.freemem()),totalmem:formatByteSize(os.totalmem())}})}catch(e){console.log(e)}3<this.crashNum?Editor.Dialog.error(Editor.I18n.t("builder.error.builder_crash")):(Editor.Task.addNotice({title:s.options.taskName,message:i,source:"builder",type:"error"}),console.error(i))}}}}updateTaskInfo(e){var t;e&&e.id&&e.options&&this.map[e.id]&&((t=this.map[e.id]).options=e.options,t.dirty=e.dirty,Editor.Message.broadcast("builder:task-changed",t.id,t.toJSON(),TaskManager.supportTaskQueue||t.free))}async checkCanAddTask(e){return e&&this.waitingTaskIDs.includes(e)?(console.log(Editor.I18n.t("builder.tips.task_exist")),!1):!(this.waitingTaskIDs.length&&!TaskManager.supportTaskQueue&&(console.warn(Editor.I18n.t("builder.tips.task_busy")),1))}async save(){if(!this.command){var e={};for(const t of Object.values(this.map)){if(t.options.packages)for(const s of Object.keys(t.options.packages))await Editor.Profile.setConfig(s,"builder.taskOptionsMap."+t.id,t.options.packages[s],"local"),await Editor.Profile.setConfig(s,"builder.__version__",require("../../package.json").version,"local");e[t.id]=JSON.parse(JSON.stringify(t.toJSON())),e[t.id].options.packages={}}await Editor.Profile.setConfig("builder","BuildTaskManager.taskMap",e,"local"),await new Promise(e=>{setTimeout(()=>{e()},800)})}}async add(e,t,s){return Editor.App.args.build?this._addTaskInCommand(e,t,s):"build"===e?this._addBuildTask(t,s):"bundle"===e?this._addBundleTask(t,s):this._addStageTask(e,t,s)}async _addBundleTask(e,t){var s=e.id||"buildBundle";if(!await this.checkCanAddTask())return t&&t(37),0;let i=this.map[s];return i&&i instanceof BundleTaskItem?"processing"===i.state&&await i.break("interrupted"):((i=new BundleTaskItem(s,e,t)).addListener("update",(e,t,s)=>{this._onTaskProgress(e,t,s,"builder:bundle-task-changed")}),Editor.Message.broadcast("builder:task-add",i.id,i.toJSON())),i.options=e,i.resolve=t,this._initBundleTaskOption(i),i.options.optionList.length?(this._addTaskToQueue(i),1):(t&&t(32),2)}_initBundleTaskOption(e){const t=[];e.options.buildTaskIds&&(e.options.buildTaskIds.forEach(e=>{this.map[e]?t.push(this.map[e].options):console.warn(`Invalid task ${e} in bundle build options`)}),e.options.optionList=JSON.parse(JSON.stringify(t)))}async _addBuildTask(e,t){if(!await this.checkCanAddTask())return t&&t(37),0;let s=e.taskId||this._getId();-1!==this.waitingTaskIDs.indexOf(s)&&(s=this._getId(),console.debug(`duplicate build id ${e.taskId} has be overwrite with `+s),e.taskId=s);e=new BuildTaskItem(s,e,t);return e.addListener("update",this._onTaskProgress),this._addTaskToQueue(e),Editor.Message.broadcast("builder:task-add",e.id,e.toJSON()),1}async _addStageTask(e,t,s){var t=t.taskId;return t&&this.map[t]?this.waitingTaskIDs.includes(t)?(console.error("Build task is busy!"),s&&s(37),0):((t=this.map[t]).stage=e,this.executeTask(t),1):(console.error("Please run build task first!"),s&&s(32),2)}async _addTaskInCommand(e,t,s){var i=t.taskId||this._getId(),a=this.waitingTaskIDs.indexOf(i);-1!==a&&(console.debug("duplicate build id will be remove from this.waitingTaskIDs"),this.waitingTaskIDs.splice(a,1));let r;if("build"===e){var a=t.platform;if(!await plugin_1.pluginManager.checkPlatformsInformation(a,exports.manager.command))return console.warn(Editor.I18n.t("builder.tips.platformInformationInvalid",{platform:a})),s&&s(34),2;(r=new BuildTaskItem(i,t,s)).addListener("update",this._onTaskProgress)}else"bundle"===e?((r=new BundleTaskItem("buildBundle",t,s)).addListener("update",(e,t,s)=>{this._onTaskProgress(e,t,s,"builder:bundle-task-changed")}),this._initBundleTaskOption(r)):(a=t.taskId,(r=a&&this.map[a])||(a=a||this._getId(),(r=new StageTaskItem(a,e,t,s)).addListener("update",this._onTaskProgress),this.map[a]=r),r.stage=e);return this._addTaskToQueue(r),1}_addTaskToQueue(e){this.waitingTaskIDs.push(e.id),(this.map[e.id]=e).update(0,"waiting","Wait a moment, build task is busy",""),this.step()}async remove(e,t){if(!this.map[e])return!1;var s=this.map[e];if(this.currentTaskId===e&&await this.break(e,"interrupted"),t)try{var{buildPath:i,outputName:a}=this.map[e].options;i&&a?(0,fs_extra_1.removeSync)((0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(i),a)):console.warn(`Package ${a} has invalid options.`)}catch(e){return console.error("Remove build task failed!"),console.error(e),!1}delete this.map[e],Editor.Message.broadcast("builder:task-delete",s.id,s.toJSON());t=this.waitingTaskIDs.indexOf(e);-1!==t&&this.waitingTaskIDs.splice(t,1),await this.save();try{var r=Editor.UI.__protected__.File.resolveToRaw(s.options.logDest||(0,utils_1.getTaskLogDest)(s.options.platform,s.id));(0,fs_extra_1.existsSync)(r)&&(0,fs_extra_1.removeSync)(r)}catch(e){console.debug(e)}return!0}queryTaskInfo(e){e=this.map[e];return e?e.toJSON():null}async recompile(e,t,s){var i=this.map[e];return i?await this.checkCanAddTask(e)?(i.removeAllListeners(),i.addListener("update",this._onTaskProgress),i.breakType="",i.resolve=s,i.options=t||i.options,i.stage="build",i.update(0,"waiting","Wait a moment, build task is busy",""),this.waitingTaskIDs.push(e),this.currentTaskId?void 0:this.step()):37:32}async break(t,e){this.currentTaskId===t?(this.currentTaskId="",await this.map[t].break(e)):this.waitingTaskIDs.includes(t)?(this.waitingTaskIDs.splice(this.waitingTaskIDs.findIndex(e=>t===e),1),this.map[t].update(0,"cancel",Editor.I18n.t("builder.tips.buildTaskCanceled"),"")):this.map[t]&&await this.map[t].break(e)}async breakAll(t){await Promise.all(this.waitingTaskIDs.map(e=>{e=this.map[e];return e.free=!0,"processing"===e.state&&(!this.command||this.currentTaskId===e.id&&this.command)?e.break(t):void 0})),this.currentTaskId="",this.waitingTaskIDs=[],Editor.Message.broadcast("builder:task-changed")}async step(){var e;0!==this.waitingTaskIDs.length&&(e=this.waitingTaskIDs[0],e=this.map[e],this.ready?await this.executeTask(e)&&("success"===e.state&&(this.crashNum=0),this._crashInfo={},this.waitingTaskIDs.shift(),await this.step()):e.update(0,"waiting","Wait Asset DB or Builder worker ready",""))}async executeTask(e){return!(!e||!e.free||(this.currentTaskId=e.id,e.free=!1,e.reset(),await e.run(e.stage),await this.save(),e.free=!0,this.currentTaskId=""))}_getId(){return String((new Date).getTime())}_onTaskProgress(e,t,s,i="builder:task-changed"){var a;MainWin&&MainWin.setProgressBar(t.progress),["success","failure"].includes(t.state)&&(MainWin&&MainWin.setProgressBar(-1),Editor.Task.removeNotice(this.dbPauseNoticeId),a=[{label:"i18n:builder.notice.copyMessage",target:"builder",message:{name:"copy-build-notice",target:"builder",params:[t.message]}}],"build"===t.type&&a.unshift({label:"i18n:builder.notice.open",target:"builder",message:{name:"open",target:"builder",params:["","highlight",t.id]}}),Editor.Task.addNotice({title:t.options.taskName,message:t.message,source:"i18n:builder.title",type:"success"===t.state?"success":"error",buttons:a})),Editor.Message.broadcast(i,e,t,TaskManager.supportTaskQueue||s)}async onAfterPackageRegister(e){var t=await Editor.Profile.getConfig(e.name,"","local");t.builder=t.builder||{};let s=!1;if(t.common&&!t.builder.common&&(t.builder.common=t.common,delete t.common,s=!0),t.options&&!t.builder.options&&(t.builder.options=t.options,delete t.options,s=!0),s&&await Editor.Profile.setConfig(e.name,"",t,"local"),t.builder.taskOptionsMap&&Object.keys(t.builder.taskOptionsMap).length)for(const r of Object.keys(t.builder.taskOptionsMap)){var i,a=exports.manager.map[r];a?(i=t.builder.taskOptionsMap[r])&&(a.options.packages=a.options.packages||{},a.options.packages[e.name]=i,Editor.Message.broadcast("builder:task-changed",r,a.toJSON(),TaskManager.supportTaskQueue||this.free)):delete exports.manager.map[r]}}async onAfterPackageUnRegister(e){for(const s of Object.keys(exports.manager.map)){var t=exports.manager.map[s];t.options.packages&&t.options.packages[e.name]&&(await Editor.Profile.setConfig(e.name,`builder.taskOptionsMap.${s}}`,t.options.packages[e.name]),await Editor.Profile.setConfig(e.name,"builder.__version__",require("../../package.json").version),delete t.options.packages[e.name],Editor.Message.broadcast("builder:task-changed",s,t.toJSON(),TaskManager.supportTaskQueue||this.free))}}}async function buildWithCommand(e,t){console.debug("Start enter command build with options "+JSON.stringify(e));var s=await checkOptionsBeforeCommand(e);s?plugin_1.pluginManager.disablePlatforms.includes(s.platform)?(console.error(Editor.I18n.t("builder.tips.disablePlatformForBuildCommand",{platform:s.platform})),t(34)):(await checkProjectSettingsBeforeCommand(e),"bundle"===e.stage?exports.manager.add("bundle",e,t):e.stage&&"build"!==e.stage?(s=e.root||(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(e.buildPath),e.outputName),exports.manager.add(e.stage,{platform:e.platform,root:s,nextStages:e.nextStages||e.buildStageGroup&&e.buildStageGroup[e.stage],buildTaskOptions:e},t)):(exports.manager.command=!0,exports.manager.add("build",e,t))):t(32)}async function checkProjectSettingsBeforeCommand(t){if(t.projectSettingsPath)if((0,fs_extra_1.existsSync)(t.projectSettingsPath)){var e,s=await Editor.Message.request("project","query-configs-from-path",t.projectSettingsPath);if(!t.includeModules&&null!=(e=null==(e=s.engine)?void 0:e.modules)&&e.includeModules&&(t.includeModules=s.engine.modules.includeModules||[]),!t.designResolution&&null!=(e=null==(e=s.project)?void 0:e.general)&&e.designResolution&&(t.designResolution=s.project.general.designResolution),!t.renderPipeline&&null!=(e=null==(e=s.project)?void 0:e.general)&&e.renderPipeline&&(t.renderPipeline=s.project.general.renderPipeline),!t.physicsConfig&&null!=(e=s.project)&&e.physics&&(t.physicsConfig=s.project.physics,t.physicsConfig.defaultMaterial||(t.physicsConfig.defaultMaterial="ba21476f-2866-4f81-9c4d-6e359316e448")),!t.flags&&null!=(e=null==(e=s.engine)?void 0:e.modules)&&e.flags){t.flags={};const i=null==(e=null==(e=s.engine)?void 0:e.modules)?void 0:e.flags;i&&Object.keys(i).length&&Object.keys(i).forEach(e=>{t.includeModules&&t.includeModules.includes(e)&&t.flags&&Object.assign(t.flags,i[e])})}!t.customLayers&&null!=(e=s.project)&&e.layer&&(t.customLayers=s.project.layer),!t.sortingLayers&&s.project&&s.project["sorting-layer"]&&(e=s.project["sorting-layer"]||{},t.sortingLayers=e.layers||[])}else console.error(t.projectSettingsPath+" is not exist!")}async function checkOptionsBeforeCommand(t){if("string"==typeof t.scenes){t.scenes=t.scenes.split(",");var e=[];for(const a of t.scenes){var s=await Editor.Message.request("asset-db","query-asset-info",a.trim());s&&e.push({uuid:a,url:s.url})}t.scenes=e}if(t.configPath){if(!(0,fs_extra_1.existsSync)(t.configPath))return console.error(t.configPath+" is not exist!"),null;console.debug(`Read config from path ${t.configPath}...`);var i=(0,fs_extra_1.readJSONSync)(t.configPath),i=Object.assign(i,t);Object.assign(t,i),delete t.configPath}if(t.packages&&"string"==typeof t.packages)try{t.packages=JSON.parse(t.packages)}catch(e){t.packages={}}return!1===t.migrate||t.stage&&"build"!==t.stage||await(0,migration_1.migrateOptions)(t,!0),t.platform||(t.platform=await Editor.Profile.getConfig("builder","common.platform")),t.outputName||(t.outputName=t.platform),t.taskName||(t.taskName=t.outputName),t}function formatByteSize(e){return(e/1024/1024).toFixed(2)+"MB"}(exports.TaskManager=TaskManager).supportTaskQueue=!0,exports.manager=new TaskManager,exports.buildWithCommand=buildWithCommand,exports.checkOptionsBeforeCommand=checkOptionsBeforeCommand;