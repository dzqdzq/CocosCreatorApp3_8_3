"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,o,n)}:function(e,t,i,o){e[o=void 0===o?i:o]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.importConfig=exports.exportConfig=exports.ready=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path"),bundle_utils_1=require("../../share/bundle-utils"),utils_1=require("../../share/utils"),BundleConfigGroup=__importStar(require("./bundle-config-group")),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm;const vueTemplate=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../static/contributions/bundle-config.html"),"utf8"),ProjectPanelVM=Vue.extend({name:"ProjectPanelVM",components:{"config-group":BundleConfigGroup},data(){return{configID:"",renderConfigs:{},customConfigs:{},renameState:{},mousedownHandle(e){},defaultConfig:JSON.parse(JSON.stringify(bundle_utils_1.DefaultBundleConfig))}},async mounted(){await this.initData(),this.mousedownHandle=this.onMouseDown.bind(this),document.addEventListener("mousedown",this.mousedownHandle),this.configID&&Vue.nextTick(()=>{this.jumpToConfig(this.configID)})},destroyed(){document.removeEventListener("mousedown",this.mousedownHandle)},methods:{async initData(){var e=await Editor.Message.request("builder","query-bundle-config"),e=(this.renderConfigs=Object.freeze(e),await Editor.Profile.getProject("builder","bundleConfig.custom"));this.customConfigs=e,this.customConfigs.default&&(this.defaultConfig=this.customConfigs.default)},onRename(e,t,i){i.displayName=e||i.displayName,this.$set(this.renameState,t,!1),this.saveConfig()},configMenu(e,t,i){Editor.Menu.popup({x:e.x,y:e.y,menu:[{label:"i18n:builder.copyConfig",click:()=>{this.newConfig(i)}},{label:"i18n:builder.copyID",click:()=>{Editor.Clipboard.write("text",t)}},{label:"i18n:builder.rename",enabled:"default"!==t,click:()=>{this.$set(this.renameState,t,!0),this.$nextTick(()=>{let e=this.$refs["renameInput"+t];e&&((e=Array.isArray(e)?e[0]:e).focus({preventScroll:!0}),e.$input.setSelectionRange(0,i.displayName.length))})}},{label:"i18n:builder.delete",enabled:"default"!==t,click:()=>{this.deleteConfig(t)}}]})},newConfig(e){let t=(e=e||bundle_utils_1.DefaultBundleConfig).displayName;t.startsWith("i18n")&&(t=(0,utils_1.transI18nName)(t));const i=Editor.Utils.UUID.generate();this.$set(this.customConfigs,i,Object.assign(Object.assign({},JSON.parse(JSON.stringify(e))),{displayName:t+" Copy"})),this.saveConfig(),Vue.nextTick(()=>{this.jumpToConfig(i)})},saveDefaultConfig(){this.$set(this.customConfigs,"default",this.defaultConfig),this.saveConfig()},saveConfig(){Editor.Profile.setProject("builder","bundleConfig.custom",this.customConfigs)},deleteConfig(e){this.$set(this.customConfigs,e,null),delete this.customConfigs[e],this.saveConfig()},async importConfig(){var t,i=(await Editor.Dialog.select({title:Editor.I18n.t("builder.asset_bundle.importConfig"),path:Editor.Project.path,filters:[{name:"JSON",extensions:["json"]}]})).filePaths[0];if(i){let e=!0;this.customConfigs&&(t=await Editor.Dialog.warn(Editor.I18n.t("builder.project.texture_compress.import_config_options"),{buttons:[Editor.I18n.t("builder.asset_bundle.overwrite"),Editor.I18n.t("builder.asset_bundle.merge")],default:1}),e=1===t.response);try{var o=(0,fs_extra_1.readJSONSync)(i);if(e)for(const n of Object.keys(o))this.$set(this.customConfigs,n,o[n]);else this.customConfigs=o;this.customConfigs.default&&(this.defaultConfig=this.customConfigs.default),this.saveConfig()}catch(e){console.error(e)}}},async exportConfig(){var e=await Editor.Dialog.save({title:Editor.I18n.t("builder.asset_bundle.exportConfig"),path:(0,path_1.join)(Editor.Project.path,"bundle-config.json"),filters:[{name:"JSON",extensions:["json"]}]});e.filePath&&(await(0,fs_extra_1.outputFile)(e.filePath,JSON.stringify(this.customConfigs,null,2)),console.log(`Texture compress config has export in {link(${e.filePath})}.`))},onMouseDown(){this.renameState={}},jumpToConfig(e){const t=Array.isArray(this.$refs[e])?this.$refs[e][0]:this.$refs[e];t&&(t.scrollIntoView(),t.setAttribute("twinkle","shake"),setTimeout(()=>{t.setAttribute("twinkle","")},900))}},template:vueTemplate});function ready(e){panel=this,null!==vm&&void 0!==vm&&vm.$destroy(),(vm=new ProjectPanelVM({data:{configID:e}})).$mount(panel.$.container)}function exportConfig(){if(vm)return{bundleConfig:vm.customConfigs}}function importConfig(e){vm&&(vm.customConfigs=e.bundleConfig)}function close(){null!==vm&&void 0!==vm&&vm.$destroy(),vm=null,panel=null}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../dist/bundle-config.css"),"utf8"),exports.template=`
<div class="container"></div>
`,exports.$={container:".container"},exports.ready=ready,exports.exportConfig=exportConfig,exports.importConfig=importConfig,exports.close=close;