"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.importConfig=exports.exportConfig=exports.close=exports.ready=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),fs_extra_1=require("fs-extra"),preview_container_1=require("./preview-container"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm;const SELECT_IMAGE="i18n:builder.splashSetting.selectImage",SPLASH_DIR=(0,path_1.join)(Editor.Project.path,"settings");function jointWatermarkPosLabel(t,e){return Editor.I18n.t("builder.splashSetting.watermarkLocationConfig."+t)+" - "+Editor.I18n.t("builder.splashSetting.watermarkLocationConfig."+e)}const vueTemplate=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../static/contributions/splash-setting.html"),"utf8"),SplashSettingVM=Vue.extend({name:"SplashSettingVM",components:{PreviewContainer:preview_container_1.PreviewContainer},data(){return{settings:{},defaultSettings:null,watermarkLocationConfig:[{label:Editor.I18n.t("builder.splashSetting.default"),value:"default"},{label:jointWatermarkPosLabel("top","left"),value:"topLeft"},{label:jointWatermarkPosLabel("top","center"),value:"topCenter"},{label:jointWatermarkPosLabel("top","right"),value:"topRight"},{label:jointWatermarkPosLabel("bottom","left"),value:"bottomLeft"},{label:jointWatermarkPosLabel("bottom","center"),value:"bottomCenter"},{label:jointWatermarkPosLabel("bottom","right"),value:"bottomRight"}],previewContainer:{width:1280,height:720},showMask:!1}},computed:{displayRatio(){return this.settings.displayRatio?(100*this.settings.displayRatio).toFixed():"100"},logoType(){var t;return(null==(t=this.settings.logo)?void 0:t.type)||"default"},backgroundType(){var t;return(null==(t=this.settings.background)?void 0:t.type)||"default"},backgroundColor(){var t;return null!=(t=this.settings.background)&&t.color?(t=["x","y","z","w"].map(t=>255*this.settings.background.color[t]),JSON.stringify(t)):"[4,9,10,255]"},customLogoSrcLabel(){var t;return null!=(t=this.settings.logo)&&t.image&&null!=(t=this.defaultSettings)&&t.logo&&this.settings.logo.image!==this.defaultSettings.logo.image?(0,path_1.basename)(this.settings.logo.image):SELECT_IMAGE},customBackgroundSrcLabel(){var t;return null!=(t=this.settings.background)&&t.image?(0,path_1.basename)(this.settings.background.image):SELECT_IMAGE},customLogoDisable(){return this.customLogoSrcLabel===SELECT_IMAGE},customBackgroundDisable(){return this.customBackgroundSrcLabel===SELECT_IMAGE}},async mounted(){await this.initData()},methods:{async onConfirm(e){var s=e.target.getAttribute("name");if(s){let t=e.target.value;"displayRatio"===s&&t&&(t/=100),this.saveSettings(s,t)}},async saveSettings(t,e){this.$set(this.settings,t,e),await Editor.Profile.setProject("builder","splash-setting."+t,e)},async onTypeChange(t,e){e=e.target.value;this.$set(this.settings[t],"type",e),await Editor.Profile.setProject("builder",`splash-setting.${t}.type`,e),"logo"===t?this.handleLogoSrc():this.handleBackgroundSrc()},async onBackgroundColorConfirm(t){t=t.target.value,t={x:t[0]/255,y:t[1]/255,z:t[2]/255,w:t[3]/255};this.$set(this.settings.background,"color",t),await Editor.Profile.setProject("builder","splash-setting.background.color",t),this.handleBackgroundSrc()},async initData(){await checkCustomSplash()&&(this.showMask=!0),this.defaultSettings=await Editor.Profile.getProject("builder","splash-setting","default"),this.settings=await Editor.Profile.getProject("builder","splash-setting");var t=await Editor.Profile.getProject("project","general.designResolution");this.previewContainer.width=t.width,this.previewContainer.height=t.height,this.handleBackgroundSrc(),this.handleLogoSrc()},async reset(){this.settings=JSON.parse(JSON.stringify(this.defaultSettings)),await Editor.Profile.removeProject("builder","splash-setting","project"),this.handleBackgroundSrc(),this.handleLogoSrc()},async selectImage(t){var e=(await Editor.Dialog.select({type:"file",multi:!1,filters:[{extensions:["png","jpg","jpeg"],name:"Image"}]})).filePaths[0];e&&await this.updateImageSrc(t,e)},async updateImageSrc(t,e){let s;if((0,fs_1.existsSync)(e))s=e;else{var i=await Editor.Message.request("asset-db","query-asset-info",e);if(!i)return void console.error(`Can't get asset info(${e}) from uuid`);s=i.file}i=(0,path_1.join)(SPLASH_DIR,(0,path_1.basename)(s));s!==i&&(await(0,fs_extra_1.copy)(s,i,{overwrite:!0}),e=Editor.UI.__protected__.File.resolveToUrl(i,"project"),this.$set(this.settings[t],"image",e),await Editor.Profile.setProject("builder",`splash-setting.${t}.image`,e),"logo"===t?this.handleLogoSrc():this.handleBackgroundSrc())},handleLogoSrc(){var t;"none"===this.settings.logo.type?this.$delete(this.settings,"logoSrc"):(t="custom"===this.settings.logo.type?this.settings.logo.image:null==(t=this.defaultSettings)?void 0:t.logo.image,this.$set(this.settings,"logoSrc",Editor.UI.__protected__.File.resolveToRaw(t)+("?timestamp="+Date.now())))},handleBackgroundSrc(){var t;"custom"!==this.settings.background.type?this.$delete(this.settings,"backgroundSrc"):(t=this.settings.background.image,this.$set(this.settings,"backgroundSrc",Editor.UI.__protected__.File.resolveToRaw(t)+("?timestamp="+Date.now())))},async enableCustomSplash(){try{if(!await Editor.Message.request("information","has-dialog","customSplash"))switch((await Editor.Message.request("information","open-information-dialog","customSplash")).action){case"resolve":this.showMask=!1;break;case"unusual":console.warn(Editor.I18n.t("builder.splashSetting.informationDialogUnusual"))}}catch(t){console.debug(t)}},async previewInBrowser(){Editor.Message.send("preview","open-terminal",{openMode:"browser",splashPreview:!0})}},template:vueTemplate});function ready(){panel=this,null!==vm&&void 0!==vm&&vm.$destroy(),(vm=new SplashSettingVM).$mount(panel.$.container)}function close(){null!==vm&&void 0!==vm&&vm.$destroy(),vm=null,panel=null}async function exportConfig(){var t={};return t["splash-setting"]=await Editor.Message.request("project","query-config","builder","splash-setting")||{},t}async function importConfig(t){t["splash-setting"]&&await Editor.Message.request("project","set-config","builder","splash-setting",t["splash-setting"])}async function checkCustomSplash(){try{var t=await Editor.Message.request("information","query-information","customSplash");if(t&&("network_failure"===t.status||"network_exception"===t.status||t.data&&t.data.enable&&!t.data[t.data.id].complete))return!0}catch(t){console.debug(t)}return!1}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../dist/splash-setting.css"),"utf8"),exports.template=`
<div class="container"></div>
`,exports.$={container:".container"},exports.ready=ready,exports.close=close,exports.exportConfig=exportConfig,exports.importConfig=importConfig;