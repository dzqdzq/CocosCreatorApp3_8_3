"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.initBundleConfig=exports.searchAssets=exports.encodeAsset=exports.recursively=exports.queryAssetsByOptions=exports.queryAllAssets=void 0;const message_1=require("./../worker/message"),bundle_1=require("../worker/builder/utils/bundle"),minimatch=(exports.methods={async queryAllAssets(){var s,t=await Manager.assetManager.queryAssetInfos(),a=[];for(let e=0;e<t.length;e++){var r=t[e];r.isDirectory||"database"===r.importer||(r.mtime=null==(s=Manager.assetDBManager.assetDBMap.assets.infoManager.get(r.file))?void 0:s.time,a.push(r))}return a},async queryAssetInfo(e){var s,e=await Manager.assetManager.queryAssetInfo(e);return e&&(e.mtime=null==(s=Manager.assetDBManager.assetDBMap.assets.infoManager.get(e.file))?void 0:s.time),e},queryAssetsByOptions:queryAssetsByOptions,initWorkerMessage:message_1.init,initBundleConfig:initBundleConfig,async queryAssetsInBundle(e){var e=Manager.assetManager.queryAsset(e),s=queryAssetsByOptions({pattern:e.url+"/**/*",deep:!0}),e=await initBundleConfig(JSON.parse(JSON.stringify(e.meta.userData.bundleFilterConfig)));return(0,bundle_1.filterAssetWithBundleConfig)(s,e).map(e=>e.url)}},require("minimatch"));async function queryAllAssets(){var s,t=await queryAssetsByOptions();const a=[];for(let e=0;e<t.length;e++){var r=t[e];r.isDirectory||"database"===r.importer||(r.mtime=null==(s=Manager.assetDBManager.assetDBMap.assets.infoManager.get(r.file))?void 0:s.time,recursively(r,e=>{a.push(e)}))}return a}function queryAssetsByOptions(e={}){const s=[];for(const a in Manager.assetDBManager.assetDBMap){var t;a in Manager.assetDBManager.assetDBMap&&(t=Manager.assetDBManager.assetDBMap[a],"string"==typeof e.pattern&&!e.pattern.startsWith("db://"+a)||(t=searchAssets(Array.from(t.uuid2asset.values()),e),e.deep?t.forEach(e=>{recursively(e,e=>{s.push(encodeAsset(e))})}):s.push(...t.map(e=>encodeAsset(e)))))}return s}function recursively(s,t){s.subAssets&&(t&&t(s),Object.keys(s.subAssets).forEach(e=>{recursively(s.subAssets[e],t)}))}function encodeAsset(e){var s=Manager.assetManager.encodeAsset(e),t=(e._parent?(t=Manager.assetManager.encodeAsset(e._parent),s.fatherInfo={source:t.source,library:t.library,uuid:t.uuid},s.mtime=null==(t=Manager.assetDBManager.assetDBMap.assets.infoManager.get(e._parent.source))?void 0:t.time):s.mtime=null==(t=Manager.assetDBManager.assetDBMap.assets.infoManager.get(e.source))?void 0:t.time,s.userData=e.meta.userData,e._assetDB.dataManager.dataMap[e.uuid]);return t&&t.value&&t.value.depends?s.depends=t.value.depends:s.depends=[],s}function searchAssets(e,s){let t=[];return(t=t.concat(e)).filter(e=>!(s.pattern&&"string"==typeof s.pattern&&!minimatch(e.url,s.pattern)||s.importer&&"string"==typeof s.importer&&e.meta.importer!==s.importer))}function initBundleConfig(e){if(!e||!e.length)return[];var s=[];for(const r of JSON.parse(JSON.stringify(e)))if("url"!==r.type&&r.assets&&r.assets.length){const n=new Set,i=new Set;for(const u of r.assets){var t,a=u&&Manager.assetManager.queryAsset(u);a&&(a.isDirectory()?(s.push({type:"url",range:r.range,patchOption:{patchType:"glob",value:a.url+"/**/*"}}),i.add(a.uuid)):("cc.Texture2D"===Manager.assetManager.queryAssetProperty(a,"type")&&(t=Manager.assetManager.queryAsset(u.replace("@6c48a","")),"cc.ImageAsset"===Manager.assetManager.queryAssetProperty(t,"type"))&&n.add(t.uuid),a.subAssets&&Object.values(a.subAssets).forEach(e=>{n.add(e.uuid)})))}r.assets=r.assets.filter(e=>!i.has(e)),r.assets.push(...Array.from(n)),r.assets.length&&s.push(r)}else s.push(r);return s}exports.queryAllAssets=queryAllAssets,exports.queryAssetsByOptions=queryAssetsByOptions,exports.recursively=recursively,exports.encodeAsset=encodeAsset,exports.searchAssets=searchAssets,exports.initBundleConfig=initBundleConfig;