"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ready=exports.listeners=exports.update=exports.template=void 0;const utils_1=require("../../share/utils"),validator_manager_1=require("../../share/validator-manager"),lodash=require("lodash"),MessageTypeMap={warn:"warn",error:"danger",log:"",debug:""};async function update(a){var e;if(a&&(a.itemConfigs||a.render)){const i=this.$this;a.render&&a.render.ui&&a.render.ui.toLocaleLowerCase()!==(null==(e=i.$ui)?void 0:e.tagName.toLocaleLowerCase())&&(Build.debugMode&&console.debug("ui-prop need reload",a.label),i.$ui&&i.removeChild(i.$ui),e=initRenderUI(a))&&(i.$ui=e,i.appendChild(e)),a.itemConfigs?Object.keys(a.itemConfigs).forEach(e=>{var r=a.itemConfigs[e],t=lodash.get(a.value,e);i.$items[e]?([null,void 0].includes(t)||(r.value=t,i.valueDirty=!0),r.verifyLevel=r.verifyLevel||"error",i.$items[e].dump=r,i.$items[e].render(r)):console.debug(e+" has not init")}):([null,void 0].includes(a.value)||(i.$ui.value=a.value),updateRenderUI(i.$ui,a),await checkTargetValue(i,a)),a.verifyLevel=a.verifyLevel||"error",i.dump=a,i.removeAttribute("dump"),i.valueDirty&&(i.dispatch("change"),i.valueDirty=!1)}}async function ready(){const a=this.$this,i=a.dump;if(a.className="build-prop",[void 0,null].includes(i.value)&&![void 0,null].includes(i.default)&&(i.value=i.default),i.verifyRules&&i.verifyRules.includes("required")&&(a.innerHTML='<span class="required">*</span>'),i.label&&((e=initLabel(i)).setAttribute("slot","label"),a.appendChild(e)),i.itemConfigs){const n=document.createElement("div");n.setAttribute("slot","content"),a.appendChild(n),a.$items={},Object.keys(i.itemConfigs).forEach(r=>{var e=i.itemConfigs[r];const t=document.createElement("ui-prop");n.appendChild(t),t.customInfo=a.customInfo,t.setAttribute("type","build"),t.className="build-prop",a.$items[r]=t,e.verifyLevel=e.verifyLevel||"error",t.dump=e,t.addEventListener("change",e=>{e.stopPropagation(),e.stopImmediatePropagation(),lodash.set(a.dump.value,r,t.dump.value),a.dispatch("change")}),t.render(e)})}else{i.verifyLevel=i.verifyLevel||"error";var e=initRenderUI(i);e&&(a.$ui=e,a.appendChild(e)),await checkTargetValue(a,a.dump)}a.valueDirty&&(a.dispatch("change"),a.valueDirty=!1)}function checkDisabledWhen(e,r){try{return new Function("options",`with(options) { return ${e}}`)(r)}catch(e){console.error(e)}return null}function toggleErrorState(e,r,t){var a;e.$errorMap=e.$errorMap||{},!(t=t||"")&&!e.$errorMap[r]||!t&&e.$errorMap[r]&&"none"===e.$errorMap[r].style.display||(e.$errorMap[r]||(e.$errorMap[r]=document.createElement("ui-prop"),e.$errorMap[r].innerHTML=`<ui-label slot="content" value="${t}" tooltip="${t}"></ui-label>`),a=e.$errorMap[r],e.$errorMap[r].setAttribute("value",t||""),e.$errorMap[r].setAttribute("tooltip",null!=t?t:""),a.className="error",a.setAttribute("error",""),t?(e.setAttribute("error",""),a.style.display="block"):(e.removeAttribute("error"),a.style.display="none"),e.appendChild(a),e.$errorMap[r]=a)}async function onChange(e,r){r!==e.dump.value&&(e.dump.value=r,await checkTargetValue(e,e.dump),e.dispatch("change"),e.valueDirty=!1)}async function checkTargetValue(e,r){var t,a;e.customInfo?({options:t,pkgKey:a}=e.customInfo,r.message=await checkValue(r,r.value,t,a)):r.message=await checkValue(r,r.value),e.message!==r.message&&(e.message||r.message)&&(e.valueDirty=!0),e.message=r.message,e.message?e.classList.add(null!=(t=r.verifyLevel&&MessageTypeMap[r.verifyLevel])?t:"danger"):e.classList.remove(null!=(a=r.verifyLevel&&MessageTypeMap[r.verifyLevel])?a:"danger")}async function checkValue(e,r,t,a){var{verifyRules:e,render:i}=e;return e&&i&&(validator_manager_1.validator.checkWithInternalRule("valid",r)||!validator_manager_1.validator.checkWithInternalRule("required",r)||e.includes("required"))&&await validator_manager_1.validatorManager.check(r,e,t,a)||null}function initLabel(e){var r=document.createElement("ui-label");return r.value=e.label,e.description&&r.setAttribute("tooltip",e.description),e.experiment?((e=document.createElement("div")).appendChild(r),e.innerHTML+='<ui-icon color tooltip="i18n:builder.experiment" value="experiment"></ui-icon>',e):r}function initRenderUI(e){if(!e.render)return null;var t=document.createElement(e.render.ui);if(t.setAttribute("slot","content"),"ui-select"===e.render.ui&&e.render.items){let r="";e.render.items.forEach(e=>{e.label=(0,utils_1.transI18nName)(e.label),r+=`<option value="${e.value}">${e.label}</option>`}),t.innerHTML=r}return t}function updateRenderUI(t,a){var e;if(a.render.attributes&&Object.keys(a.render.attributes).forEach(e=>{!1===a.render.attributes[e]?t.removeAttribute(e):t.setAttribute(e,String(a.render.attributes[e]))}),"ui-select"===a.render.ui&&a.render.items){let r="";a.render.items.forEach(e=>{r+=`<option value="${e.value}">${e.label}</option>`}),t.innerHTML=r,t.setAttribute("value",null!=(e=null!=(e=null!=(e=a.value)?e:a.default)?e:a.render.items[0].value)?e:"")}}exports.template="",exports.update=update,exports.listeners={change(e){var r=this.$this,t=e.target;t!==r&&(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault(),onChange(r,t.value))},confirm(e){var r=this.$this;e.target!==r&&(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault(),r.dispatch("confirm"))}},exports.ready=ready;