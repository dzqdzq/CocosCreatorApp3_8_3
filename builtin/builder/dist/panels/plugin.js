"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkBundleCompressionSetting=exports.pluginManager=void 0;const path_1=require("path"),bundle_utils_1=require("../share/bundle-utils"),common_options_validator_1=require("../share/common-options-validator"),platforms_options_1=require("../share/platforms-options"),plugin_manager_1=require("../share/plugin-manager");class PluginManager extends plugin_manager_1.PluginManagerBase{constructor(){super(),this.customBuildButton={};const e={};platforms_options_1.builtinPlugins.forEach(t=>{e[t]={}}),this.compsMap=e}async unregister(e){super.unregister(e),Object.keys(this.compsMap).forEach(t=>{delete this.compsMap[t][e.name]})}async internalRegister(t,e){var{platform:o,config:s}=t,{name:i,buildPath:r,displayName:n}=e;super.internalRegister(t,e),!Editor.App.dev&&"win32"===process.platform&&["mac","ios","ios-app-clip"].includes(i)||(Editor.App.dev||"darwin"!==process.platform||"windows"!==i)&&(s.doc&&!s.doc.startsWith("http")&&(s.doc=Editor.Utils.Url.getDocUrl(s.doc)),e={options:s.options,displayName:n,wrapWithFold:null==(t=s.wrapWithFold)||t,doc:s.doc},this.compsMap[o][i]=Object.assign(this.compsMap[o][i]||{},e),s.panel)&&(n=(0,path_1.dirname)(r),(t=Editor.Module.__protected__.requireFile(s.panel,{root:n})).template&&(this.compsMap[o][i].panelInfo=t),t.customButton)&&(this.customBuildButton[o]=t.customButton)}getSupportPlatformMap(){const e={};return Object.keys(this.platformMap).forEach(t=>{!Editor.App.dev&&"win32"===process.platform&&["mac","ios","ios-app-clip"].includes(t)||!Editor.App.dev&&"darwin"===process.platform&&"windows"===t||(e[t]=this.platformMap[t])}),e}getPanelComponent(){const s={};return Object.keys(this.compsMap).forEach(t=>{const o=this.compsMap[t];Object.keys(o).forEach(t=>{var e=o[t].options,e=(e&&(s[e.name]=e),o[t].custom);e&&(s[e.name]=e)})}),s}getPlatformCompInfos(i){if(!i)return[];var t=this.compsMap[i];if(0===Object.keys(t).length)return[];t=Object.keys(t);t.sort((t,e)=>this.pkgPriorities[e]-this.pkgPriorities[t]);const r=[];return t.forEach(t=>{if(Editor.Package.getPackages({name:t,enable:!0}).length){const o=this.compsMap[i][t].options;var e=this.compsMap[i][t].panelInfo;const s={};o&&Object.keys(o).forEach(t=>{(o[t].render||o[t].itemConfigs)&&(s[t]=o[t])}),(Object.keys(s).length||e)&&r.push(Object.assign(this.compsMap[i][t],{pkgName:t,options:s}))}}),r}getButtonsConfig(e){if(!this.customBuildStages[e])return null;const o={};var t;return this.customBuildStages[e]&&(o.buttons=[],(t=Object.keys(this.customBuildStages[e])).length)&&(t.sort((t,e)=>this.pkgPriorities[e]-this.pkgPriorities[t]),t.forEach(t=>{o.buttons.push(...this.customBuildStages[e][t].filter(t=>!t.hidden))})),o}async getOptionsByPlatform(t,e=!1){var o,s=await(0,common_options_validator_1.getCommonOptions)(t,e);for(const r of Object.keys(this.compsMap[t]))s.packages[r]=await Editor.Profile.getConfig(r,"builder.options."+t,e?"default":void 0),s.packages[r]&&(s.packages[r].__version__=null==(o=this.packageRegisterInfo.get(r))?void 0:o.version);var i=JSON.parse(JSON.stringify(s));return i.platform=t,i.outputName=await(0,common_options_validator_1.calcValidOutputName)(i.buildPath,t,t),i.taskName||(i.taskName=i.outputName),i.__version__=require((0,path_1.join)(__dirname,"../../package.json")).version,i}}function checkBundleCompressionSetting(t,e){var o={error:"",newValue:t};return e&&-1===e.indexOf(t)&&(o.newValue=bundle_utils_1.BundleCompressionTypes.MERGE_DEP,o.error=` compression type(${t}) is invalid for this platform!`),o}function transI18nName(t){return"string"!=typeof t?"":t.startsWith("i18n:")&&(t=t.replace("i18n:",""),Editor.I18n.t(t)||console.debug(t+" is not defined in i18n"),Editor.I18n.t(t))||t}exports.pluginManager=new PluginManager,exports.checkBundleCompressionSetting=checkBundleCompressionSetting;