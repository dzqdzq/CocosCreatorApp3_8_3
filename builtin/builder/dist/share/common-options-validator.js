"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkPreferenceSetting=exports.handleOverwriteProjectSettings=exports.checkProjectSetting=exports.checkBuildCommonOptions=exports.checkBuildCommonOptionsByKey=exports.getCommonOptionDefaultByKey=exports.getCommonOptions=exports.commonOptionConfigs=exports.checkBuildPathIsInvalid=exports.generateNewOutputName=exports.checkConflict=exports.resolveOutputNameConflict=exports.calcValidOutputName=exports.checkStartScene=exports.overwriteModuleConfig=void 0;const path_1=require("path"),bundle_utils_1=require("./bundle-utils"),platforms_options_1=require("./platforms-options"),validator_1=require("./validator"),validator_manager_1=require("./validator-manager"),platforms_options_2=require("./platforms-options");function supportPlatform(e){return e&&!!platforms_options_1.builtinPlugins.includes(e)}async function checkScenes(e){if(!Array.isArray(e)||!e.length)return new Error("Scenes is empty");for(const t of e){if(!t||!t.uuid)return!1;if(!await checkAssetExist(t.uuid))return new Error(Editor.I18n.t("builder.error.missingScenes",{url:t.url||t.uuid}))}return!0}async function checkSceneBundle(r,o){var e=await Editor.Message.request("asset-db","query-assets",{ccType:"cc.SceneAsset",pattern:"!db://internal/default_file_content/**/*"});if(!e)return[];const n=await Editor.Message.request("asset-db","query-assets",{isBundle:!0});return e.forEach(t=>{var e;const i=null==(e=n.find(e=>t.url.startsWith(e.url+"/")))?void 0:e.url;!i||o.bundleConfigs&&o.bundleConfigs.length&&!o.bundleConfigs.find(e=>e.root===i)||r.find(e=>e.uuid===t.uuid)||r.push({url:t.url,uuid:t.uuid,bundle:i})}),r}async function checkAssetExist(e){return"string"==typeof e&&!!await Editor.Message.request("asset-db","query-asset-info",e)}async function checkStartScene(e){if("string"!=typeof e||!e)return!1;const t=await Editor.Message.request("asset-db","query-asset-info",e);return!!t&&!(await Editor.Message.request("asset-db","query-assets",{isBundle:!0})).find(e=>t.url.startsWith(e.url+"/"))}async function calcValidOutputName(e,t,i,r){return e&&t?(e=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(e),t),await resolveOutputNameConflict(e=Editor.Utils.File.getName(e),i,r)):""}async function resolveOutputNameConflict(e,t,i){let r=(0,path_1.basename)(e);var o=(await Editor.Message.request("builder","query-tasks-info"))["queue"];const n={};Object.values(o).forEach(e=>{"build"===e.type&&e.options.buildPath&&i&&i===e.id&&(n[e.id]=e)});var o=createBuildPathDict(n),{dir:e,name:s}=(0,path_1.parse)(e);return r=checkConflict(e,s,o)?generateNewOutputName(e,t,o):r}function createBuildPathDict(e){var t={};for(const o in e){var i=e[o],r=Editor.UI.__protected__.File.resolveToRaw(i.options.buildPath);t[r]||(t[r]=[]),t[r].push(i.options.outputName)}return t}function checkConflict(e,t,i){for(const r of i[e]||[])if(t===r)return!0;return!1}function generateNewOutputName(e,t,i){var r;let o=0;for(const n of i[e]||[])n.startsWith(t+"-")&&(r=parseInt(n.substring(t.length+1),10),!isNaN(r))&&r>o&&(o=r);return t+"-"+(o+1).toString().padStart(3,"0")}function checkBuildPathIsInvalid(e){if(e)if(e.startsWith("project://")){var t=e.match(/^([a-zA-z]*):\/\/(.*)$/);if(t){t=t[2].replace(/\\/g,"/");if((0,path_1.isAbsolute)(t)||t.includes("../")||t.startsWith("/"))return!0}}else if(!(0,path_1.isAbsolute)(e))return!0;return!1}function checkIncludeModules(e){return!!Array.isArray(e)||` includeModules(${e}) should be an array!`}async function getCommonOptions(e,t=!1){const i=JSON.parse(JSON.stringify(await Editor.Profile.getConfig("builder","common","default")));if(!t){const r=await Editor.Profile.getConfig(e,"builder.common",t?"default":void 0);r&&Object.keys(r).forEach(e=>{void 0!==r[e]&&(i[e]=r[e])})}return i.scenes=await getCommonOptionDefaultByKey("scenes"),await checkStartScene(i.startScene)||(i.startScene=await getCommonOptionDefaultByKey("startScene")),i.startScene||console.error(Editor.I18n.t("builder.error.invalidStartScene")),i.packages={},i.platform=e,i}async function getCommonOptionDefaultByKey(e,t){switch(e){case"scenes":{var i=await Editor.Message.request("asset-db","query-assets",{ccType:"cc.SceneAsset",pattern:"!db://internal/default_file_content/**/*"});if(!i)return[];const r=await Editor.Message.request("asset-db","query-assets",{isBundle:!0});return i.map(t=>{var e;return{url:t.url,uuid:t.uuid,bundle:null==(e=r.find(e=>t.url.startsWith(e.url+"/")))?void 0:e.url}})}case"startScene":i=(await getCommonOptionDefaultByKey("scenes")).filter(e=>!e.bundle);return i[0]&&i[0].uuid;default:return Editor.Profile.getConfig("builder","common."+e)}}async function checkBuildCommonOptionsByKey(e,t,i){var r={error:"",newValue:t,level:"error"};switch(e){case"scenes":var o=await checkScenes(t)||!1;return o instanceof Error?(r.error=o.message,r.newValue=await getCommonOptionDefaultByKey("scenes")):await checkSceneBundle(t,i),r;case"startScene":return await checkStartScene(t)||!1||(r.error="i18n:builder.error.invalidStartScene"),r.error&&(r.newValue=await getCommonOptionDefaultByKey("startScene")),r;case"platform":platforms_options_1.PLATFORMS.includes(t)||(r.error="InValid platform!",r.newValue=null);break;case"mainBundleIsRemote":return t&&i.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?(r.newValue=!1,r.error=" bundle can not be remote when compression type is subpackage!"):t||i.mainBundleCompressionType!==bundle_utils_1.BundleCompressionTypes.ZIP||(r.newValue=!0,r.error=" bundle must be remote when compression type is zip!"),r;case"outputName":t?platforms_options_2.NATIVE_PLATFORM.includes(i.platform)&&/[`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、\u4e00-\u9fa5]/im.test(t)&&(r.error="i18n:builder.error.buildPathContainsChineseAndSymbol"):(r.error=" outputName can not be empty",r.newValue=await calcValidOutputName(i.buildPath,i.platform,i.platform));break;case"taskName":t||(r.error=" taskName can not be empty",r.newValue=i.outputName);break;case"buildPath":t&&"project://"!==t?checkBuildPathIsInvalid(t)?(r.error="buildPath is invalid!",r.newValue="project://build"):((t="string"==typeof t&&t.startsWith(".")?"project://"+t:t)&&(0,path_1.isAbsolute)(Editor.UI.__protected__.File.resolveToRaw(t))||(r.error=`buildPath(${t}) is invalid!`,r.newValue="project://build"),platforms_options_2.NATIVE_PLATFORM.includes(i.platform)&&/[`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、\u4e00-\u9fa5]/im.test(t)&&(r.error="i18n:builder.error.buildPathContainsChineseAndSymbol")):(r.error=" buildPath can not be empty",r.newValue="project://build");break;case"md5Cache":case"debug":case"sourceMaps":case"useSplashScreen":case"mergeStartScene":case"experimentalEraseModules":case"useBuiltinServer":"boolean"!=typeof t?(r.error=`typeof ${e} should be boolean but get `+t,r.newValue="true"===t||"false"!==t&&await getCommonOptionDefaultByKey(e)):r.newValue=!!t;break;case"server":i.useBuiltinServer||(r.error=await validator_manager_1.validatorManager.check(t,exports.commonOptionConfigs.server.verifyRules||[],i,i.platform+i.platform));break;default:return null}return r}async function checkBuildCommonOptions(e){var t=await Editor.Profile.getConfig("builder","common","default"),i={};for(const r of Object.keys(t))i[r]=await checkBuildCommonOptionsByKey(r,e[r],e)||{newValue:e[r],error:"",level:"error"};return i}async function checkProjectSetting(t){if(t.includeModules||(t.includeModules=await Editor.Profile.getProject("engine","modules.includeModules")||[]),t.designResolution||(t.designResolution=await Editor.Profile.getProject("project","general.designResolution")),t.renderPipeline||(t.renderPipeline=await Editor.Profile.getProject("project","general.renderPipeline")),t.physicsConfig||(e=await Editor.Profile.getProject("project","physics"))&&(t.physicsConfig=e,t.physicsConfig.defaultMaterial||(t.physicsConfig.defaultMaterial="ba21476f-2866-4f81-9c4d-6e359316e448")),!t.flags){t.flags={};const i=await Editor.Profile.getProject("engine","modules.flags");i&&Object.keys(i).length&&Object.keys(i).forEach(e=>{t.includeModules&&t.includeModules.includes(e)&&t.flags&&Object.assign(t.flags,i[e])})}t.customLayers||(t.customLayers=await Editor.Profile.getProject("project","layer")||[]),t.sortingLayers||(e=await Editor.Profile.getProject("project","sorting-layer")||{},t.sortingLayers=e.layers||[]),t.macroConfig||(t.macroConfig=await Editor.Profile.getProject("engine","macroConfig","project")||{});var e=null==(e=null==(e=t.overwriteProjectSettings)?void 0:e.macroConfig)?void 0:e.cleanupImageCache;e&&"inherit-project-setting"!==e&&(t.macroConfig=t.macroConfig||{},t.macroConfig.CLEANUP_IMAGE_CACHE="on"===e),handleOverwriteProjectSettings(t),await Editor.Profile.getConfig("engine","physics-2d-box2d")&&t.includeModules.includes("physics-2d-box2d")&&t.includeModules.splice(t.includeModules.findIndex(e=>"physics-2d-box2d"===e),1,"physics-2d-box2d-wasm")}function handleOverwriteProjectSettings(i){var e;const r=null==(e=i.overwriteProjectSettings)?void 0:e.includeModules;r&&null!=(e=i.includeModules)&&e.length&&(Object.keys(r).forEach(t=>{if("inherit-project-setting"!==r[t])switch(r[t]){case"on":i.includeModules.push(t);break;case"off":i.includeModules=i.includeModules.filter(e=>e!==t);break;default:var e;exports.overwriteModuleConfig[t]?-1!==(e=i.includeModules.findIndex(exports.overwriteModuleConfig[t].match))&&i.includeModules.splice(e,1,r[t]):console.warn("Invalid overwrite config of engine")}}),i.includeModules=Array.from(new Set(i.includeModules)))}async function checkPreferenceSetting(e,t=!1){"boolean"==typeof e.useBuildAssetCache&&t||(e.useBuildAssetCache=await Editor.Profile.getConfig("builder","useBuildAssetCache")),"boolean"==typeof e.useBuildEngineCache&&t||(e.useBuildEngineCache=await Editor.Profile.getConfig("builder","useBuildEngineCache")),"boolean"==typeof e.useBuildTextureCompressCache&&t||(e.useBuildTextureCompressCache=await Editor.Profile.getConfig("builder","useBuildTextureCompressCache")),"boolean"==typeof e.useBuildAutoAtlasCache&&t||(e.useBuildAutoAtlasCache=await Editor.Profile.getConfig("builder","useBuildAutoAtlasCache"))}exports.overwriteModuleConfig={physics:{match:e=>e.startsWith("physics-")&&!e.startsWith("physics-2d"),default:"inherit-project-setting"},"physics-2d":{match:e=>e.startsWith("physics-2d-"),default:"inherit-project-setting"}},exports.checkStartScene=checkStartScene,exports.calcValidOutputName=calcValidOutputName,exports.resolveOutputNameConflict=resolveOutputNameConflict,exports.checkConflict=checkConflict,exports.generateNewOutputName=generateNewOutputName,exports.checkBuildPathIsInvalid=checkBuildPathIsInvalid,validator_1.Validator.addRule("supportPlatform",{func:supportPlatform,message:"i18n:builder.error.unknown_platform"}),exports.commonOptionConfigs={platform:{label:"i18n:builder.options.platform",default:"web-desktop",verifyRules:["required","supportPlatform"]},name:{label:"i18n:builder.options.name",render:{ui:"ui-input"},default:Editor.Project.name||(0,path_1.basename)(Editor.Project.path),verifyRules:["required"]},polyfills:{label:"i18n:builder.options.polyfills",description:"i18n:builder.options.polyfills_tips",type:"object",hidden:!0,default:{asyncFunctions:!1},itemConfigs:{asyncFunctions:{label:"i18n:builder.options.async_functions",description:"i18n:builder.options.async_functions_tips",render:{ui:"ui-checkbox"}},coreJs:{label:"i18n:builder.options.core_js",description:"i18n:builder.options.core_js_tips",render:{ui:"ui-checkbox"}}}},buildScriptTargets:{label:"i18n:builder.options.buildScriptTargets",description:"i18n:builder.options.buildScriptTargetsTips",hidden:!0,render:{ui:"ui-input",attributes:{placeholder:Editor.I18n.t("builder.example",{example:"> 0.4%"})}}},server:{label:"i18n:builder.options.remote_server_address",description:"i18n:builder.options.remote_server_address_tips",default:"",render:{ui:"ui-input"},verifyRules:["http"]},sourceMaps:{label:"Source Maps",default:!1,render:{ui:"ui-checkbox"}},experimentalEraseModules:{label:"i18n:builder.options.experimental_erase_modules",description:"i18n:builder.options.experimental_erase_modules_tips",default:!1,experiment:!0,render:{ui:"ui-checkbox"}},startSceneAssetBundle:{label:"i18n:builder.options.start_scene_asset_bundle",description:"i18n:builder.options.start_scene_asset_bundle_tips",default:!1,hidden:!0,render:{ui:"ui-checkbox"}},bundleConfigs:{label:"i18n:builder.options.includeBundles",default:[],verifyLevel:"warn"},buildPath:{label:"i18n:builder.options.build_path",default:"project://build",verifyRules:["required"]},debug:{label:"i18n:builder.options.debug",default:!1,render:{ui:"ui-checkbox"}},useBuiltinServer:{label:"i18n:builder.options.use_builtin_server",default:!1,description:"i18n:builder.options.use_builtin_server_tips",hidden:!0,render:{ui:"ui-checkbox"}},md5Cache:{label:"i18n:builder.options.md5_cache",default:!1,render:{ui:"ui-checkbox"}},mainBundleIsRemote:{label:"i18n:builder.options.main_bundle_is_remote",default:!1,render:{ui:"ui-checkbox"}},mainBundleCompressionType:{label:"i18n:builder.options.main_bundle_compression_type",default:"merge_dep"},useSplashScreen:{label:"i18n:builder.use_splash_screen",default:!0,render:{ui:"ui-checkbox"}},bundleCommonChunk:{label:"i18n:builder.bundleCommonChunk",default:!1,render:{ui:"ui-checkbox"}},skipCompressTexture:{label:"i18n:builder.options.skip_compress_texture",default:!1,render:{ui:"ui-checkbox"}},packAutoAtlas:{label:"i18n:builder.options.pack_autoAtlas",default:!0},startScene:{label:"i18n:builder.options.start_scene",default:""},outputName:{description:"构建的输出目录名，将会作为后续构建任务上的名称",default:"",verifyRules:["required","normalName"]},taskName:{default:"",verifyRules:["required"]},scenes:{label:"i18n:builder.options.scenes",default:[]},overwriteProjectSettings:{default:{macroConfig:{cleanupImageCache:"inherit-project-setting"},includeModules:{physics:"inherit-project-setting","physics-2d":"inherit-project-setting","gfx-webgl2":"off"}}},nativeCodeBundleMode:{default:"asmjs"},wasmCompressionMode:{hidden:!0,default:!1}},exports.getCommonOptions=getCommonOptions,exports.getCommonOptionDefaultByKey=getCommonOptionDefaultByKey,exports.checkBuildCommonOptionsByKey=checkBuildCommonOptionsByKey,exports.checkBuildCommonOptions=checkBuildCommonOptions,exports.checkProjectSetting=checkProjectSetting,exports.handleOverwriteProjectSettings=handleOverwriteProjectSettings,exports.checkPreferenceSetting=checkPreferenceSetting;