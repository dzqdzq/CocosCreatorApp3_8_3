"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.load=exports.methods=void 0;const electron_1=require("electron"),utils_1=require("./utils");async function load(){try{await initInformationCache()}catch(t){console.error(t),console.error("Init information cache failed!")}}async function initInformationCache(){var t=await Editor.Profile.getProject("information","information"),o=await Editor.Profile.getConfig("utils","information.timestamp");if(t){if(!o||await(0,utils_1.isExpired)(o)){o=await exports.methods.queryAllInformation();if(Object.keys(o).length)await Editor.Profile.setProject("information","information",o);else for(const r in t){var i=await exports.methods.queryInformation(r);i&&"success"===i.status&&i.data&&await Editor.Profile.setProject("information","information."+r,i.data)}await Editor.Profile.setConfig("utils","information.timestamp",Date.now(),"global")}}else{o=await exports.methods.queryAllInformation();if(Object.keys(o).length)await Editor.Profile.setProject("information","information",o),await Editor.Profile.setConfig("utils","information.timestamp",Date.now(),"global");else{var e,a=await Editor.Profile.getConfig("utils","information.features");let t=!1;for(const n in a)a[n]&&(e=await exports.methods.queryInformation(n))&&"success"===e.status&&e.data&&(await Editor.Profile.setProject("information","information."+n,e.data),t=!0);t&&await Editor.Profile.setConfig("utils","information.timestamp",Date.now(),"global")}}!await Editor.Profile.getConfig("utils","network_connected")&&await(0,utils_1.checkInternetConnection)()&&Editor.Profile.setConfig("utils","network_connected",!0,"global")}exports.methods={async queryAllInformation(){var t={};for(const i in await Editor.Profile.getProject("information","information")){var o=await(0,utils_1.queryInfo)(i);t[i]={id:i,label:o.result.label||i,enable:!!o.result.enable,[i]:{complete:!!o.result.complete,form:o.result.form||""}}}return t},async queryInformation(t,o){var i,e;return!1!==(await Editor.Profile.getConfig("utils","information.features"))[t]&&(e=await(0,utils_1.checkInternetConnection)(),i=await Editor.Profile.getConfig("utils","network_connected"),e||i)?e?(i=await(0,utils_1.queryInfo)(t))?{status:"success",data:{id:e=i.result.id||t,label:i.result.label||t,enable:!!i.result.enable,[e]:{complete:!!i.result.complete,form:i.result.form||""}}}:{status:"network_exception"}:(e=await Editor.Profile.getProject("information","information."+t),null!=o&&o.force||!e?{status:"network_failure",data:e||void 0}:{status:"cache",data:e}):null},async openInformationDialog(t,o){let i=await Editor.Profile.getProject("information","information."+t);var e=await exports.methods.queryInformation(t,{force:!0});if(!i){if(!e)return{action:"resolve"};if(("network_failure"===e.status||"network_exception"===e.status)&&(await Editor.Profile.getConfig("utils","information.features"))[t])return(0,utils_1.handleNetworkStatus)(e,t);if(!e.data)return{action:"resolve"};i=e.data,await Editor.Profile.setProject("information","information."+t,i),await Editor.Profile.setConfig("utils","information.timestamp",Date.now(),"global")}if(!(!i.enable||i[i.id]&&i[i.id].complete)){if(e){if("network_failure"===e.status)return await Editor.Profile.removeProject("information",`information.${t}.passByNetworkFailure`),"resolve"===(a=await(0,utils_1.handleNetworkStatus)(e,t)).action&&await Editor.Profile.setProject("information",`information.${t}.passByNetworkFailure`,!0),a;if("network_exception"===e.status)return await(0,utils_1.handleNetworkStatus)(e,t)}await(0,utils_1.openDialog)(i[i.id].form,o,i.id||t);var a=await exports.methods.queryInformation(t,{force:!0});if("network_failure"===a.status||"network_exception"===a.status)return{action:"unusual"};e=a.data;if(e&&e.enable&&!e[e.id].complete)return{action:"reject"};await(0,utils_1.updateCachedFormInfos)(e),await Editor.Profile.setConfig("utils","information.timestamp",Date.now(),"global")}return{action:"resolve"}},async hasDialog(t){var o=await exports.methods.queryInformation(t);let i=t;return!!((i=o&&o.data&&o.data.id?o.data.id:i)&&utils_1.dialogMap[i]&&utils_1.dialogMap[i].length)},async closeDialog(o){if(o){var i=await exports.methods.queryInformation(o);let t=o;i&&i.data&&i.data.id&&(t=i.data.id),utils_1.dialogMap[t]&&(o=utils_1.dialogMap[t],utils_1.dialogMap[t]=[],o.forEach(t=>{t=electron_1.BrowserWindow.fromId(t);null!=t&&t.close()}))}}},exports.load=load;