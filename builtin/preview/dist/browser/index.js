"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=void 0;const electron_1=require("electron"),fs_extra_1=require("fs-extra"),path_1=require("path"),FacetInstance_1=require("../programming/FacetInstance"),simulator_1=require("./simulator"),build_native_engine_1=require("./build-native-engine"),plugin_1=require("./plugin"),preview_manager_1=require("./preview-manager"),server_1=require("../contributions/server");let pkg=null,currMode="browser",firstMetrics=!1;async function load(){pkg=this,Editor.Startup.__protected__.ready.package?await plugin_1.pluginManager.init():Editor.Startup.__protected__.once("package-ready",async()=>{await plugin_1.pluginManager.init()}),await preview_manager_1.browserPreviewManager.init(),(0,FacetInstance_1.createProgrammingFacet)().catch(e=>{console.error(e)})}function unload(){preview_manager_1.browserPreviewManager.destroyed()}exports.methods={async ready(){firstMetrics&&(firstMetrics=!1,Editor.Metrics.trackTimeEnd("preview:ready-browser"))},open(){Editor.Panel.open("preview.panel")},async generateSettings(e){var r=await Editor.Message.request("builder","generate-preview-setting",{debug:!0,platform:e.platform||"web-desktop",preview:!0,startScene:e.startScene||""});if(r&&r.settings)return r.settings.engine.engineModules=await Editor.Profile.getProject("engine","modules.includeModules"),await plugin_1.pluginManager.runHooks(e.type,"settings",r.settings),r},buildNativeEngine:build_native_engine_1.buildNativeEngine,previewSceneInBrowser(e){e&&preview_manager_1.browserPreviewManager.load({scene:e})},async"open-terminal"(e){var{openMode:e,splashPreview:r}=e||{};if(e&&"browser"===e&&r)await preview_manager_1.browserPreviewManager.load({splashPreview:!0});else switch(currMode){case"browser":firstMetrics=!0,Editor.Metrics.trackTimeStart("preview:ready-browser"),await preview_manager_1.browserPreviewManager.load();break;case"simulator":Editor.Metrics.trackTimeStart("preview:ready-simulator"),await(0,simulator_1.runSimulator)(()=>{Editor.Metrics.trackTimeEnd("preview:ready-simulator")})}},async"restart-simulator"(){await(0,simulator_1.runSimulator)()},async"pause-terminal"(e){await Editor.Message.request("scene","editor-preview-call-method","pause",e)},async"step-terminal"(){Editor.Message.request("scene","editor-preview-call-method","step")},async"on-pack-build-end"(e){"preview"===e&&await(null==(e=(0,FacetInstance_1.getPreviewFacet)())?void 0:e.notifyPackDriverUpdated())},"change-platform"(e){currMode=e,Editor.Message.request("scene","editor-preview-call-method","setPlatform",e)},"reload-terminal"(){preview_manager_1.browserPreviewManager.reload()},async queryPreviewUrl(){return preview_manager_1.browserPreviewManager.queryPreviewUrl()},queryConnectNum(){return(0,server_1.queryConnectNum)()},async"get-preview-ip"(){return preview_manager_1.browserPreviewManager.queryPreviewIp()},"set-preview-ip"(e){preview_manager_1.browserPreviewManager.setPreviewIp(e)},async"create-template"(e){var r=(0,path_1.join)(__dirname,"./../../static/views/index.ejs").replace("app.asar","app.asar.unpacked"),a=(0,path_1.join)(Editor.Project.path,"preview-template","index.ejs");if((0,fs_extra_1.existsSync)(a)&&!e&&1===(await Editor.Dialog.warn("Template already exists, do you want to overwrite source file?",{buttons:["Yes","Cancel"],default:0,cancel:1})).response)return!1;return await(0,fs_extra_1.copy)(r,a,{overwrite:!0}),console.log(Editor.I18n.t("preview.creat_template_success")+`( ${a} )`),electron_1.shell.showItemInFolder(a),!0},async writeSettingFile(e){return(0,simulator_1.writeSettingFile)(e)},async"asset-db:asset-change"(e){e===preview_manager_1.browserPreviewManager.currentSceneUuid&&(preview_manager_1.browserPreviewManager.sceneChanged=!0)},async currentSceneSave(e){preview_manager_1.browserPreviewManager.currentScene!==preview_manager_1.CURRENT_SCENE&&preview_manager_1.browserPreviewManager.currentSceneUuid!==preview_manager_1.CURRENT_SCENE||(preview_manager_1.browserPreviewManager.sceneChanged=!0,preview_manager_1.browserPreviewManager.currentSceneUuid=e)},async"programming:compiled"(){preview_manager_1.browserPreviewManager.scriptCompiled=!0},async"programming:compiled-start"(){preview_manager_1.browserPreviewManager.scriptCompiled=!1},"query-preview-scene"(){return preview_manager_1.browserPreviewManager.queryCurrentScene()}},exports.load=load,exports.unload=unload;