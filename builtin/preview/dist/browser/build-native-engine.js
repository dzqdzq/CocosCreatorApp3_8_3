"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildNativeEngine=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),build_polyfills_1=__importDefault(require("@editor/build-polyfills")),module_system_1=require("@cocos/module-system"),ccbuild_1=require("@cocos/ccbuild");async function buildNativeEngine(e){console.log("compiling native simulator engine, please wait..."),console.time("compile native engine");let i;e?i=(0,path_1.join)(__dirname,"../../../../../resources/3d/engine"):(i=(await Editor.Message.request("engine","query-engine-info")).typescript.path,await Editor.Profile.getProject("engine","modules.flags"));var e=(0,path_1.join)(__dirname,"../../static/simulator").replace("app.asar","app.asar.unpacked"),t=(0,path_1.join)(i,"bin/native-preview");try{(0,fs_extra_1.emptyDirSync)(t)}catch(e){}var o=await ccbuild_1.StatsQuery.create(i),t={engine:i,out:t,moduleFormat:"system",compress:!1,targets:"chrome 80",split:!0,nativeCodeBundleMode:"asmjs",platform:"NATIVE",mode:"PREVIEW",flags:{DEBUG:!0,SERVER_MODE:!1}},a=(await(0,ccbuild_1.buildEngine)(t),{imports:{"cc/env":"./builtin/cce.env.js","cce.env":"./builtin/cce.env.js","wait-for-ammo-instantiation":"./cocos-js/wait-for-ammo-instantiation.js"}});for(const s of o.getFeatureUnits())a.imports["cce:/internal/x/cc-fu/"+s]=`./cocos-js/${s}.js`;await(0,fs_extra_1.writeFile)((0,path_1.join)(e,"import-map.json"),JSON.stringify(a,void 0,2),"utf8"),await(0,build_polyfills_1.default)({debug:!1,sourceMap:!1,file:(0,path_1.join)(e,"polyfills.bundle.js"),coreJs:{modules:["es.global-this"],blacklist:[]},asyncFunctions:!0,fetch:!0}),await(0,module_system_1.build)({out:(0,path_1.join)(e,"system.bundle.js"),minify:!1,sourceMap:!1,platform:"mac",editor:!1}),console.log("compile finished!"),console.timeEnd("compile native engine")}exports.buildNativeEngine=buildNativeEngine;