"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateSimulatorConfig = exports.getSimulatorPreference = exports.getJsEnginePath = exports.getNativeEnginePath = exports.formatPath = exports.copyDirSync = void 0;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
function copyDirSync(path, dest) {
    if (!(0, fs_extra_1.existsSync)(path)) {
        return 0;
    }
    const stat = (0, fs_extra_1.statSync)(path);
    if (!stat.isDirectory()) {
        (0, fs_extra_1.ensureDirSync)((0, path_1.dirname)(dest));
        return (0, fs_extra_1.copyFileSync)(path, dest);
    }
    // 文件夹
    const files = (0, fs_extra_1.readdirSync)(path);
    (0, fs_extra_1.ensureDirSync)(dest);
    files.forEach((fileName) => {
        const file = (0, path_1.join)(path, fileName);
        const fileDest = (0, path_1.join)(dest, fileName);
        copyDirSync(file, fileDest);
    });
}
exports.copyDirSync = copyDirSync;
function formatPath(pathToFormat) {
    return pathToFormat.replace(/\\/g, '/');
}
exports.formatPath = formatPath;
async function getNativeEnginePath() {
    return (await Editor.Message.request('engine', 'query-engine-info')).native.path;
}
exports.getNativeEnginePath = getNativeEnginePath;
async function getJsEnginePath() {
    return (await Editor.Message.request('engine', 'query-engine-info')).typescript.path;
}
exports.getJsEnginePath = getJsEnginePath;
async function getSimulatorPreference() {
    var _a;
    const showDebugPanel = await Editor.Profile.getConfig('preview', 'preview.simulator_debugger');
    let waitForConnect = false;
    if (showDebugPanel) {
        waitForConnect = await Editor.Profile.getConfig('preview', 'preview.wait_for_connect');
    }
    const orientation = await Editor.Profile.getConfig('preview', 'preview.simulator_orientation');
    const device = await Editor.Message.request('device', 'query');
    const resolutionIndex = await Editor.Profile.getConfig('preview', 'preview.simulator_resolution');
    const resolution = (_a = device[resolutionIndex]) !== null && _a !== void 0 ? _a : device[0];
    return {
        showDebugPanel,
        waitForConnect,
        orientation,
        resolution,
    };
}
exports.getSimulatorPreference = getSimulatorPreference;
/**
 * 生成模拟器 config.json 配置文件，模拟器启动阶段会去解析这份配置
 */
async function generateSimulatorConfig() {
    // 路径处理
    const isDarwin = process.platform === 'darwin';
    const nativeEnginePath = await getNativeEnginePath();
    const simulatorResourcesMac = (0, path_1.join)(nativeEnginePath, 'simulator/Release/SimulatorApp-Mac.app/Contents/Resources');
    const simulatorWritablePath = isDarwin ? simulatorResourcesMac : (0, path_1.join)(process.env.LOCALAPPDATA, 'SimulatorApp-Win32/debugruntime');
    // 偏好设置
    const preference = await getSimulatorPreference();
    // 写入 JSON
    (0, fs_extra_1.ensureDirSync)(simulatorWritablePath);
    const simulatorConfigPath = (0, path_1.join)(simulatorWritablePath, 'config.json');
    const simulatorConfigData = {
        name: 'Simulator',
        entry: 'main.js',
        isLandscape: preference.orientation === 'landscape',
        isWindowTop: false,
        waitForConnect: preference.waitForConnect,
        width: preference.resolution.width,
        height: preference.resolution.height,
        consolePort: 6050,
        uploadPort: 6060,
        debugPort: 5086,
    };
    await (0, fs_extra_1.writeFile)(simulatorConfigPath, JSON.stringify(simulatorConfigData, undefined, 2), 'utf8');
}
exports.generateSimulatorConfig = generateSimulatorConfig;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2ltdWxhdG9yLXV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc291cmNlL2Jyb3dzZXIvc2ltdWxhdG9yLXV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHVDQUFxRztBQUNyRywrQkFBcUM7QUFTckMsU0FBZ0IsV0FBVyxDQUFDLElBQVksRUFBRSxJQUFZO0lBQ2xELElBQUksQ0FBQyxJQUFBLHFCQUFVLEVBQUMsSUFBSSxDQUFDLEVBQUU7UUFDbkIsT0FBTyxDQUFDLENBQUM7S0FDWjtJQUNELE1BQU0sSUFBSSxHQUFHLElBQUEsbUJBQVEsRUFBQyxJQUFJLENBQUMsQ0FBQztJQUM1QixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFO1FBQ3JCLElBQUEsd0JBQWEsRUFBQyxJQUFBLGNBQU8sRUFBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzdCLE9BQU8sSUFBQSx1QkFBWSxFQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztLQUNuQztJQUNELE1BQU07SUFDTixNQUFNLEtBQUssR0FBRyxJQUFBLHNCQUFXLEVBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEMsSUFBQSx3QkFBYSxFQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BCLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtRQUN2QixNQUFNLElBQUksR0FBRyxJQUFBLFdBQUksRUFBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDbEMsTUFBTSxRQUFRLEdBQUcsSUFBQSxXQUFJLEVBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3RDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDaEMsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBakJELGtDQWlCQztBQUVELFNBQWdCLFVBQVUsQ0FBQyxZQUFvQjtJQUMzQyxPQUFPLFlBQVksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdB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LElBQUEsb0JBQVMsRUFBQyxtQkFBbUIsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUNwRyxDQUFDO0FBMUJELDBEQTBCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvcHlGaWxlU3luYywgZW5zdXJlRGlyU3luYywgZXhpc3RzU3luYywgcmVhZGRpclN5bmMsIHN0YXRTeW5jLCB3cml0ZUZpbGUgfSBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyBqb2luLCBkaXJuYW1lIH0gZnJvbSAncGF0aCc7XG5cbmludGVyZmFjZSBSZXNvbHV0aW9uSW5mbyB7XG4gICAgbmFtZTogc3RyaW5nLFxuICAgIHdpZHRoOiBudW1iZXIsXG4gICAgaGVpZ2h0OiBudW1iZXIsXG4gICAgcmF0aW86IG51bWJlcixcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvcHlEaXJTeW5jKHBhdGg6IHN0cmluZywgZGVzdDogc3RyaW5nKSB7XG4gICAgaWYgKCFleGlzdHNTeW5jKHBhdGgpKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgICBjb25zdCBzdGF0ID0gc3RhdFN5bmMocGF0aCk7XG4gICAgaWYgKCFzdGF0LmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgZW5zdXJlRGlyU3luYyhkaXJuYW1lKGRlc3QpKTtcbiAgICAgICAgcmV0dXJuIGNvcHlGaWxlU3luYyhwYXRoLCBkZXN0KTtcbiAgICB9XG4gICAgLy8g5paH5Lu25aS5XG4gICAgY29uc3QgZmlsZXMgPSByZWFkZGlyU3luYyhwYXRoKTtcbiAgICBlbnN1cmVEaXJTeW5jKGRlc3QpO1xuICAgIGZpbGVzLmZvckVhY2goKGZpbGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGUgPSBqb2luKHBhdGgsIGZpbGVOYW1lKTtcbiAgICAgICAgY29uc3QgZmlsZURlc3QgPSBqb2luKGRlc3QsIGZpbGVOYW1lKTtcbiAgICAgICAgY29weURpclN5bmMoZmlsZSwgZmlsZURlc3QpO1xuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0UGF0aChwYXRoVG9Gb3JtYXQ6IHN0cmluZykge1xuICAgIHJldHVybiBwYXRoVG9Gb3JtYXQucmVwbGFjZSgvXFxcXC9nLCAnLycpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0TmF0aXZlRW5naW5lUGF0aCgpIHtcbiAgICByZXR1cm4gKGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ2VuZ2luZScsICdxdWVyeS1lbmdpbmUtaW5mbycpKS5uYXRpdmUucGF0aDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEpzRW5naW5lUGF0aCgpIHtcbiAgICByZXR1cm4gKGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ2VuZ2luZScsICdxdWVyeS1lbmdpbmUtaW5mbycpKS50eXBlc2NyaXB0LnBhdGg7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRTaW11bGF0b3JQcmVmZXJlbmNlKCkge1xuICAgIGNvbnN0IHNob3dEZWJ1Z1BhbmVsID0gYXdhaXQgRWRpdG9yLlByb2ZpbGUuZ2V0Q29uZmlnKCdwcmV2aWV3JywgJ3ByZXZpZXcuc2ltdWxhdG9yX2RlYnVnZ2VyJyk7XG4gICAgbGV0IHdhaXRGb3JDb25uZWN0ID0gZmFsc2U7XG4gICAgaWYgKHNob3dEZWJ1Z1BhbmVsKSB7XG4gICAgICAgIHdhaXRGb3JDb25uZWN0ID0gYXdhaXQgRWRpdG9yLlByb2ZpbGUuZ2V0Q29uZmlnKCdwcmV2aWV3JywgJ3ByZXZpZXcud2FpdF9mb3JfY29ubmVjdCcpO1xuICAgIH1cbiAgICBjb25zdCBvcmllbnRhdGlvbiA9IGF3YWl0IEVkaXRvci5Qcm9maWxlLmdldENvbmZpZygncHJldmlldycsICdwcmV2aWV3LnNpbXVsYXRvcl9vcmllbnRhdGlvbicpO1xuICAgIGNvbnN0IGRldmljZSA9IGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ2RldmljZScsICdxdWVyeScpO1xuICAgIGNvbnN0IHJlc29sdXRpb25JbmRleDogbnVtYmVyID0gYXdhaXQgRWRpdG9yLlByb2ZpbGUuZ2V0Q29uZmlnKCdwcmV2aWV3JywgJ3ByZXZpZXcuc2ltdWxhdG9yX3Jlc29sdXRpb24nKTtcbiAgICBjb25zdCByZXNvbHV0aW9uID0gZGV2aWNlW3Jlc29sdXRpb25JbmRleF0gPz8gZGV2aWNlWzBdO1xuICAgIHJldHVybiB7XG4gICAgICAgIHNob3dEZWJ1Z1BhbmVsLFxuICAgICAgICB3YWl0Rm9yQ29ubmVjdCxcbiAgICAgICAgb3JpZW50YXRpb24sXG4gICAgICAgIHJlc29sdXRpb24sXG4gICAgfTtcbn1cblxuLyoqXG4gKiDnlJ/miJDmqKHmi5/lmaggY29uZmlnLmpzb24g6YWN572u5paH5Lu277yM5qih5ouf5Zmo5ZCv5Yqo6Zi25q615Lya5Y676Kej5p6Q6L+Z5Lu96YWN572uXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZW5lcmF0ZVNpbXVsYXRvckNvbmZpZygpIHtcbiAgICAvLyDot6/lvoTlpITnkIZcbiAgICBjb25zdCBpc0RhcndpbiA9IHByb2Nlc3MucGxhdGZvcm0gPT09ICdkYXJ3aW4nO1xuICAgIGNvbnN0IG5hdGl2ZUVuZ2luZVBhdGggPSBhd2FpdCBnZXROYXRpdmVFbmdpbmVQYXRoKCk7XG4gICAgY29uc3Qgc2ltdWxhdG9yUmVzb3VyY2VzTWFjID0gam9pbihuYXRpdmVFbmdpbmVQYXRoLCAnc2ltdWxhdG9yL1JlbGVhc2UvU2ltdWxhdG9yQXBwLU1hYy5hcHAvQ29udGVudHMvUmVzb3VyY2VzJyk7XG4gICAgY29uc3Qgc2ltdWxhdG9yV3JpdGFibGVQYXRoID0gaXNEYXJ3aW4gPyBzaW11bGF0b3JSZXNvdXJjZXNNYWMgOiBqb2luKHByb2Nlc3MuZW52LkxPQ0FMQVBQREFUQSBhcyBzdHJpbmcsICdTaW11bGF0b3JBcHAtV2luMzIvZGVidWdydW50aW1lJyk7XG4gICAgXG4gICAgLy8g5YGP5aW96K6+572uXG4gICAgY29uc3QgcHJlZmVyZW5jZSA9IGF3YWl0IGdldFNpbXVsYXRvclByZWZlcmVuY2UoKTtcbiAgICBcbiAgICAvLyDlhpnlhaUgSlNPTlxuICAgIGVuc3VyZURpclN5bmMoc2ltdWxhdG9yV3JpdGFibGVQYXRoKTtcbiAgICBjb25zdCBzaW11bGF0b3JDb25maWdQYXRoID0gam9pbihzaW11bGF0b3JXcml0YWJsZVBhdGgsICdjb25maWcuanNvbicpO1xuICAgIGNvbnN0IHNpbXVsYXRvckNvbmZpZ0RhdGEgPSB7XG4gICAgICAgIG5hbWU6ICdTaW11bGF0b3InLFxuICAgICAgICBlbnRyeTogJ21haW4uanMnLFxuICAgICAgICBpc0xhbmRzY2FwZTogcHJlZmVyZW5jZS5vcmllbnRhdGlvbiA9PT0gJ2xhbmRzY2FwZScsXG4gICAgICAgIGlzV2luZG93VG9wOiBmYWxzZSxcbiAgICAgICAgd2FpdEZvckNvbm5lY3Q6IHByZWZlcmVuY2Uud2FpdEZvckNvbm5lY3QsXG4gICAgICAgIHdpZHRoOiBwcmVmZXJlbmNlLnJlc29sdXRpb24ud2lkdGgsXG4gICAgICAgIGhlaWdodDogcHJlZmVyZW5jZS5yZXNvbHV0aW9uLmhlaWdodCxcbiAgICAgICAgY29uc29sZVBvcnQ6IDYwNTAsXG4gICAgICAgIHVwbG9hZFBvcnQ6IDYwNjAsXG4gICAgICAgIGRlYnVnUG9ydDogNTA4NixcbiAgICB9O1xuICAgIGF3YWl0IHdyaXRlRmlsZShzaW11bGF0b3JDb25maWdQYXRoLCBKU09OLnN0cmluZ2lmeShzaW11bGF0b3JDb25maWdEYXRhLCB1bmRlZmluZWQsIDIpLCAndXRmOCcpO1xufSJdfQ==