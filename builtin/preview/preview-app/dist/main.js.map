{"version":3,"file":"main.js","sourceRoot":"","sources":["../src/main.ts"],"names":[],"mappings":"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","sourcesContent":["import { Ui } from './ui.js';\nimport { bootstrap } from './index.js';\n\nexport async function main(ui: Ui, options: bootstrap.Options) {\n    const cc = await System.import('cc');\n\n    const debugMode = cc.DebugMode[ui.debugMode] ?? cc.DebugMode.INFO;\n\n    // 引擎启动选项\n    const option: { debugMode: boolean; overrideSettings: Record<string, any>;} = {\n        debugMode,\n        overrideSettings: {},\n    };\n    let launchScene = options.settings.launch.launchScene;\n\n    Object.assign(option.overrideSettings, options.settings);\n\n    option.overrideSettings.profiling = option.overrideSettings.profiling || {};\n    option.overrideSettings.profiling.showFPS = ui.showFps;\n    option.overrideSettings.screen = option.overrideSettings.screen || {};\n    option.overrideSettings.screen.frameRate = ui.frameRate;\n    option.overrideSettings.screen.exactFitScreen = ui.isFullscreen() ? true : false;\n    option.overrideSettings.assets = option.overrideSettings.assets || {};\n    option.overrideSettings.assets.importBase = 'assets/general/import';\n    option.overrideSettings.assets.nativeBase = 'assets/general/native';\n    option.overrideSettings.assets.remoteBundles = [];\n    option.overrideSettings.assets.subpackages = [];\n    option.overrideSettings.launch = option.overrideSettings.launch || {};\n    option.overrideSettings.launch.launchScene = '';\n    // 等待引擎启动\n    await cc.game.init(option);\n    cc.assetManager.onAssetMissing(async (parentAsset: any, owner: any, propName: string, uuid: string) => {\n        let assetPathOrUuid = uuid;\n        let errorInfo = `The asset ${uuid} used by ${parentAsset.name}{${cc.js.getClassName(parentAsset)}(${parentAsset.uuid})} is missing! \\n`;\n        try {\n            const info = await getData(`/missing-asset/${uuid}`);\n            if (info) {\n                errorInfo = `The asset ${info.path} used by ${parentAsset.name}{${cc.js.getClassName(parentAsset)}(${parentAsset.uuid})} is missing! \\n`;\n            }\n            assetPathOrUuid = info.path;\n            info && (errorInfo += `asset ${info.path}(${uuid}) has been deleted at ${new Date(info.removeTime).toLocaleString()}. \\n`);\n        } catch (error) {\n            console.debug(`query missing asset ${uuid} failed`);\n        }\n        if (owner && owner.node instanceof cc.Node) {\n            errorInfo += `Node path: ${owner.node.getPathInHierarchy()}\\n`;\n        }\n        propName && (errorInfo += `PropName: ${propName}`);\n        console.error(errorInfo);\n    });\n\n    await cc.game.run(async () => {\n        cc.director.once(cc.Director.EVENT_AFTER_SCENE_LAUNCH, () => {\n            ui.hideSplash();\n            if (isCurrentSceneEmpty(cc)) {\n                ui.hintEmptyScene();\n            }\n        });\n        ui.showLoading();\n        cc.game.pause();\n        const json = await getCurrentScene(launchScene);\n        try {\n            launchScene = json[1]._id;\n        } catch (error) {\n            console.debug(error);\n        }\n        // load scene\n        cc.assetManager.loadWithJson(\n            json,\n            { assetId: launchScene },\n            // 进度条\n            (completedCount: number, totalCount: number) => {\n                const progress = ((100 * completedCount) / totalCount) * 0.6; // 划分加载进度，场景加载 60%\n                ui.reportLoadProgress(progress);\n            },\n            (error: null | Error, sceneAsset: any) => {\n                if (error) {\n                    ui.showError(error);\n                    cc.error(error);\n                    return;\n                }\n                const scene = sceneAsset.scene;\n                scene._name = sceneAsset._name;\n                cc.director.runSceneImmediate(scene, () => {\n                    cc.game.resume();\n                });\n            },\n        );\n    });\n\n    await new Promise((resolve) => {\n        setTimeout(resolve, 100);\n    });\n}\n\n/**\n * Check if current scene is empty.\n */\nfunction isCurrentSceneEmpty(cc: any) {\n    const scene = cc.director.getScene();\n    if (!scene || scene.children.length === 0) {\n        return true;\n    } else if (scene.children.length > 1) {\n        return false;\n    } else {\n        const child0 = scene.children[0];\n        if (\n            child0.children.length > 0 ||\n            child0._components.length > 1 ||\n            (child0._components.length > 0 && !(child0._components[0] instanceof cc.Canvas))\n        ) {\n            return false;\n        } else {\n            return true;\n        }\n    }\n}\n\n/**\n * 读取当前场景 json 数据\n */\nfunction getCurrentScene(launchScene?: string) {\n    return getData(`scene/${launchScene}.json`);\n}\n\n/**\n * 根据 url 获取数据\n * @param url \n * @returns \n */\nfunction getData(url: string) {\n    return new Promise<any>((resolve, reject) => {\n        const request = new XMLHttpRequest();\n        request.responseType = 'text';\n        request.addEventListener('load', () => {\n            if (request.status === 200) {\n                resolve(JSON.parse(request.response));\n            }\n        });\n        request.open('GET', url, true);\n        request.send();\n    });\n}"]}