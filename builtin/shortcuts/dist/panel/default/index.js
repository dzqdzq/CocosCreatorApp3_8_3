"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.ready=exports.methods=exports.$=exports.template=exports.style=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),utils_1=require("../../utils"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel,vm;const vueTemplate=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../static","./default/index.html"),"utf8"),ShortcutPanelVM=Vue.extend({data(){return{map:{},active:"",msg:null,left:[],right:[],editInfo:null,checkEditInfoTimer:null,dirty:!0,editFlag:{hasHandle:!1}}},async mounted(){var t=require("../../../static/keyboard/qwerty.json"),t=(this.left=t.left,this.right=t.right,await Editor.Message.request("shortcuts","query-packages-shortcut-list"));this.map=t,this.active||(this.active=Object.keys(t)[0])},methods:{t(t){return Editor.I18n.t("shortcuts."+t)},async startEditShortcuts(t,e){clearTimeout(this.checkEditInfoTimer),await this._changeShortcuts(),e.missing?1===await this.checkShouldRemove()&&this.clearShortcuts(e.key):((t=t.currentTarget)&&t.focus(),this.editInfo={key:e.key,shortcut:"",searches:[],conflict:!1,when:e.when,showSearches:!1})},async checkShouldRemove(){return(await Editor.Dialog.info(Editor.I18n.t("shortcuts.invalid_shortcut.message"),{title:Editor.I18n.t("shortcuts.invalid_shortcut.title"),buttons:[Editor.I18n.t("shortcuts.invalid_shortcut.cancel"),Editor.I18n.t("shortcuts.invalid_shortcut.remove")],default:-1,cancel:-1})).response},async changeShortcuts(){this.editFlag.hasHandle||(this.checkEditInfoTimer=setTimeout(()=>{this._changeShortcuts()},300))},async _changeShortcuts(){var t;await this.checkEditShortcutChanged()?this.editInfo&&((t=this.map[this.active][this.editInfo.key])?vm.editInfo.searches&&(vm.editInfo.searches=[],vm.editInfo.conflict)?vm.editInfo=null:(await Editor.Message.request("shortcuts","change-shortcut",t,this.editInfo.shortcut)&&(t.rawShortcut=t.rawShortcut||t.shortcut,t.shortcut=this.editInfo.shortcut),this.editInfo=null,vm.dirty=!0):this.editInfo=null):this.editInfo=null},checkEditShortcutChanged(){var t;return!!(this.editInfo&&this.editInfo.key&&this.editInfo.shortcut&&(t=this.editInfo.key,t=this.map[this.active][t])&&t.shortcut!==this.editInfo.shortcut)},async resetShortcuts(t,e){this.editFlag.hasHandle=!0,clearTimeout(this.checkEditInfoTimer);var e=this.map[this.active][e],s=await Editor.Message.request("shortcuts","reset-shortcut",e);e.shortcut=s||e.rawShortcut,this.dirty=!0,this.editInfo=null,this.editFlag.hasHandle=!1},async clearShortcuts(t){this.editFlag.hasHandle=!0;t=this.map[this.active][t];await Editor.Message.request("shortcuts","change-shortcut",t,"")&&(t.rawShortcut=t.rawShortcut||t.shortcut,t.shortcut="",this.editInfo=null,vm.dirty=!0),this.editFlag.hasHandle=!1},async checkApplyShortcut(){await this.checkEditShortcutChanged()&&(await Editor.Dialog.info(Editor.I18n.t("shortcuts.tips.is_apply"),{buttons:["cancel","save"],default:0})).response&&this.changeShortcuts()},async onItemClick(t,e){this.msg=this.map[this.active][e],this.editInfo&&this.editInfo.key!==e&&await this.checkApplyShortcut()},async onEditKeyDown(t){clearTimeout(vm.checkEditInfoTimer),t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation(),vm.editFlag.hasHandle=!1;const e=vm.editInfo;e.shortcut=(0,utils_1.handleEventKey)(t),await vm.updateShortCutList();t=panel.shortcutList[vm.editInfo.shortcut]||[];e.searches=t.filter(t=>t.key!==e.key),e.conflict=!!e.searches.find(t=>t.when===vm.editInfo.when)},async jumpToItem(t,e){clearTimeout(vm.checkEditInfoTimer),await vm._changeShortcuts(),vm.editFlag.hasHandle=!0,vm.active=e.pkgName,vm.map[vm.active][e.key]&&(vm.msg=vm.map[vm.active][e.key]),vm.editFlag.hasHandle=!1},async updateShortCutList(){vm.dirty&&(panel.shortcutList=await Editor.Message.request("shortcuts","query-shortcut-map"),vm.dirty=!1)},getEditInfoState(){return this.editInfo&&this.editInfo.searches&&this.editInfo.searches.length?this.editInfo.conflict?"error":"warn":""}},template:vueTemplate});function ready(t=""){panel=this,null!==vm&&void 0!==vm&&vm.$destroy(),vm=new ShortcutPanelVM,t&&(vm.active=t),vm.$mount(panel.$.container)}function close(){null!==vm&&void 0!==vm&&vm.$destroy(),vm=null,panel=null}exports.style=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"./index.css"),"utf8"),exports.template='<div class="container"></div>',exports.$={container:".container"},exports.methods={changeTab(t,e){vm&&(vm.active=t,vm.map[vm.active][e])&&(vm.msg=vm.map[vm.active][e])}},exports.ready=ready,exports.close=close;