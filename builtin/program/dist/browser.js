"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=void 0;const child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=require("path"),electron_1=require("electron"),simple_plist_1=require("simple-plist");let programConfig={};function executeProgram(n,i){return new Promise((e,o)=>{i=i||[];let r="";if("darwin"===process.platform){if(n.endsWith(".app"))try{n=(0,path_1.join)(n,"/Contents/MacOS/");var t=(0,simple_plist_1.readFileSync)((0,path_1.join)(n,"../Info.plist")),a=(0,path_1.join)(n,t.CFBundleExecutable);n=a}catch(r){return o("[execute program error] Probably the program's Info.plist error: "+r)}r="open",i?(i.splice(0,0,n),i.splice(0,0,"-a")):i=["-a",n]}else r=n;console.debug(`program command : ${r} `+i.join(" "));t=(0,child_process_1.spawn)(r,i,{detached:!0,stdio:"ignore"});null!=(a=t.stdout)&&a.on("data",r=>{console.log("[execute program] "+r)}),null!=(a=t.stderr)&&a.on("data",r=>{console.error("[execute program error] "+r)}),t.on("error",r=>{o(n+" exit with error: "+r.message)}),t.on("close",r=>{0!==r?o(n+" exit width code "+r):e()}),t.unref()})}function handleArguments(r,e){if(!e||"object"!=typeof e)return[];if(Array.isArray(e))return e;let o=r.commandArgument?r.commandArgument.replace(/}\s+/g,"}@#").replace(/\s+\${/g,"@#${"):"";var t=r.arguments||{};let a=[];for(const n in e)t[n]&&("boolean"==typeof e[n]?o=o.replace(`\${${n}}`,e[n]?n:""):o.includes(`\${${n}}`)?o=o.replace(`\${${n}}`,""+e[n]):o+="@#"+e[n]);return o&&(a=o.replace(/\${(.+?)}/g,"@#").replace(/(@#){2,}/g,"@#").replace(/^(\s|@#)+|(\s|@#)+$/g,"").split("@#")),e._args&&a.push(...e._args),a}async function load(){Editor.Package.getPackages({enable:!0}).forEach(exports.methods.attach),Editor.Package.__protected__.on("enable",exports.methods.attach)}function unload(){Editor.Package.__protected__.removeListener("enable",exports.methods.attach)}exports.methods={async queryProgramInfo(r){if(r){"browser"===r&&(r+="V2");for(const t in programConfig)if(programConfig[t].properties[r]){var e=null!=(e=await Editor.Profile.getConfig(t,r+".path","local"))?e:await Editor.Profile.getConfig(t,r+".path","global"),o=null!=(o=await Editor.Profile.getConfig(t,r+".commandArgument","local"))?o:await Editor.Profile.getConfig(t,r+".commandArgument","global");if(null!=e||null!=o)return{path:e||"",commandArgument:o||""}}}return null},queryProgramConfig(){return programConfig||{}},async openProgram(o,t){if(!o||"string"!=typeof o)return console.log(Editor.I18n.t("program.console.programErr")),!1;try{let r=null,e=o;for(const s in programConfig)if(programConfig[s].properties){for(const l in programConfig[s].properties){if("browser"===o&&(e=o+"V2"),l===e){var a=programConfig[s].properties[l];r={label:a.label,description:a.description,arguments:a.arguments};break}if(r)break}if(r)break}if(!r)return console.debug(Editor.I18n.t("program.console.noProgram",{program:o})),!1;var n=await exports.methods.queryProgramInfo(o);if(null==n||!n.path)return console.debug(Editor.I18n.t("program.console.noProgramPath",{program:null!==r&&void 0!==r&&r.label?Editor.I18n.t(r.label.split("i18n:")[1]):o})),!1;if(!(0,fs_extra_1.existsSync)(n.path))return console.log(Editor.I18n.t("program.console.programPathErr",{program:null!==r&&void 0!==r&&r.label?Editor.I18n.t(r.label.split("i18n:")[1]):o,path:n.path||""})),!1;var i=handleArguments(r=Object.assign({},r,n),t);await executeProgram(n.path,i)}catch(r){return console.error(r),!1}return!0},async openUrl(r,e){if(!r||"string"!=typeof r)return console.log(Editor.I18n.t("program.console.urlErr")),!1;try{if(r.startsWith("http"))if(await exports.methods.openProgram("browser",{_args:[r]}))return!0;(0,path_1.isAbsolute)(r)?await electron_1.shell.openPath(r):await electron_1.shell.openExternal(r,e)}catch(r){return console.error(r),!1}return!0},async attach(e){if(!e.invalid&&e.info.contributions&&e.info.contributions.program)try{var r=e.info.contributions.program,o={title:e.info.title||e.name,properties:null,custom:r.custom?(0,path_1.join)(e.path,r.custom):""};if(r.properties)for(const t in r.properties)o.properties=o.properties||{},o.properties[t]={label:r.properties[t].label,description:r.properties[t].description,render:r.properties[t].render,arguments:r.properties[t].arguments};programConfig=Object.assign({},programConfig,{[e.name]:o})}catch(r){console.error(`[program] ${e.name} register program failed.`),console.error(r)}}},exports.load=load,exports.unload=unload;