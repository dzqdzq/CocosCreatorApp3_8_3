"use strict";const join=require("path")["join"],{existsSync,readdirSync,readJSONSync,appendFile,outputFileSync,readdir}=require("fs-extra"),TEST_CONFIG_NAME="test.config.js";async function testNativeScene(u,s=!1){const g=`场景测试失败,useNative=${u} :`,d=join(Editor.Project.tmpDir,"testScene",Date.now()+".log");return outputFileSync(d,""),console.log("testScene log path",d),new Promise((e,t)=>{let a="success";const r=setTimeout(()=>{a=g+" 超时",c()},3e5);function c(){clearTimeout(r),Editor.Message.removeBroadcastListener("crash-reporter:report",o),collectLog(d,a).then(()=>{e(a)})}function o(e){console.error(g,e.details),a=g+" 场景崩溃,原生堆栈文件在工程temp/crash目录下",c()}async function l(){Editor.Message.removeBroadcastListener("scene:ready",l);var e=await Editor.Message.request("scene","is-native");if(u&&!e)a=g+",编译未通过,无法正常启动原生场景";else{var t=require(join(__dirname,"../panel/tester")),r=(t.on("print",async e=>(await collectLog(d,e),"log"===e.type?console.log(e.message):"error"===e.type?(a=g+" 存在测试例未通过，请查看日志"+d,console.error(e.message)):void console.log(e))),join(Editor.App.path,"builtin/scene/test")),o=await readdir(r);for(let e=0;e<o.length;e++){var s=o[e];if(s.endsWith("spec.js")){var n=join(r,s);try{var i="run test:"+s;await collectLog(d,i,console.log),require(n),await t.run()}catch(e){a=g+" 存在测试例未通过，请查看日志"+d;s=n+`测试异常
`+e;await collectLog(d,s,console.error)}delete require.cache[n]}}}c()}Editor.Message.addBroadcastListener("crash-reporter:report",o),Editor.Message.addBroadcastListener("scene:ready",l),s&&l()})}async function autoTest(t){if(void 0!==t.useNative)return e=(t.nativeConfig||{})["immediately"],testNativeScene(t.useNative,e);var e=sortTestInfos();if(!e.length)return!1;var r=require(join(__dirname,"../panel/tester"));let o=!0,s=0,n=0;var i=Date.now().toString();const a=join(Editor.Project.tmpDir,"test",i,"report.ext");t.outputReport&&!existsSync(a)&&outputFileSync(a,""),r.on("print",async e=>(t.outputReport&&collectLog(a,e),"log"===e.type?console.log(e.message):"error"===e.type?(o=!1,s++,console.error(e.message)):void console.log(e)));for(const u of e)if(u.list&&u.list.length){n+=u.list.length;var c=saveReadConfig(join(u.dir,TEST_CONFIG_NAME));try{c&&c.wait&&await c.wait()}catch(e){console.error(e),o=!1,s+=u.list.length;continue}for(const g of u.list){t.outputReport&&collectLog(a,`======== ${g} ========`);var l=join(u.dir,g);try{require(l),await r.run()}catch(e){console.error(e)}delete require.cache[l]}}return console.log(`output test report in ${a}, success: ${n-s} / `+n),o}function sortTestInfos(){var e=Editor.Package.getPackages();const n=saveReadConfig(join(Editor.Project.path,TEST_CONFIG_NAME));if(!n)return[];0===n.packages.length&&delete n.packages;const i=[];return e.forEach(t=>{if(!n.packages||n.packages.includes(t.name)){var r=join(t.path,"test");if(existsSync(r)){var o=readdirSync(r);if(0!==o.length){const s=saveReadConfig(join(r,TEST_CONFIG_NAME));let e;s&&(s.includes?e=e=>s.includes.includes(e):s.excludes&&(e=e=>!s.excludes.includes(e)&&/\.spec\.js$/.test(e))),i.push({dir:r,list:e?o.filter(e):o,name:t.name})}}}}),i}function saveReadConfig(e){try{return existsSync(e)?require(e):null}catch(e){return console.error(e),null}}async function collectLog(e,t,r){let o=t,s=!1;"object"==typeof t&&(s="error"===t.type,o=t.message);var n=(s?"[X]":"   ")+` ${translateLogMsg(o)}
`;await appendFile(e,n),r&&r(t)}function translateLogMsg(e){if("string"!=typeof e||e.includes("\n")){if("string"==typeof e&&e.includes("\n"))return translateLogMsg(e.split("\n"));if(Array.isArray(e)){let t="";return e.forEach(e=>{t+=translateLogMsg(e)+"\r"}),t}try{return JSON.stringify(e)}catch(e){}}return e}module.exports={autoTest:autoTest};