"use strict";const{join,relative}=require("path"),{readdirSync,existsSync}=require("fs"),globby=require("globby"),tester=require("../tester"),profileManager=require("@base/electron-profile"),profile=profileManager.load("local://tester.json");exports.data=function(){return{language:"",auto:!!profile.get("auto"),autoAll:!!profile.get("autoAll"),running:!1,package:"",path:"",test:"",packages:[],tests:[],logs:[]}},exports.watch={package(e){if(this.packages.some(t=>{if(t.info.name===e)return this.path=t.info.path,!0}),!this.path)return this.test="",this.tests=[];const s=join(this.path,"test");if(!existsSync(s))return this.test="",this.tests=[];var t=globby.sync(join(s,"**/**.spec.js"),{nodir:!0});this.tests=t.map(t=>relative(s,t)),this.tests.includes(this.test)||(this.test=this.tests[0])}},exports.methods={t(t,e){return Editor.I18n.t("tester."+t)},_onAutoClick(t){this.auto=!this.auto,profile.set("auto",this.auto),profile.save()},_onAutoAllClick(){this.autoAll=!this.autoAll,profile.set("autoAll",this.autoAll),profile.save()},_onPakcageConfirm(t){t=t.target.value;this.package=t,profile.set("package",t),profile.save()},_onTestConfirm(t){this.test=t.target.value,profile.set("test",t.target.value),profile.save()},async _onTestButtonClick(t){if(this.package&&this.test&&!this.running){console.clear(),this.running=!0,this.logs=[];const s=[];this.auto?this.tests.forEach(t=>{s.push(t)}):s.push(this.test);for(let t=0;t<s.length;t++){var e=s[t],e=(this.logs.push({type:"info",message:`======== ${e} ========`}),join(this.path,"test",e));try{Editor.Module.requireFile(e),await tester.run()}catch(t){console.error(t)}Editor.Module.removeCache(e)}this.running=!1}}},exports.mounted=async function(){var t=Editor.Package.getPackages();this.packages=t.map(t=>{let e=!1;var s=join(t.path,"test");return{info:t,disabled:e=existsSync(s)&&0!==readdirSync(s).length?e:!0}}),this.package=profile.get("package"),this.test=profile.get("test"),tester.on("print",t=>{this.logs.push(t)}),tester.on("rollback",()=>{this.logs.pop()})};