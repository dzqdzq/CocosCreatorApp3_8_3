"use strict";const logger=require("./logger");class Info{get prefix(){let r=this,t="";for(var s=[];r.parent;){let e;var i=(e=r instanceof Describe?r.parent.subDescribes:r.parent.subIts).indexOf(r);t=i+1+"."+t,r=r.parent,s.push("  ")}return s.pop(),s.join("")+t}constructor(e,r){this.parent=null,this.message=e,this.handle=r}}class It extends Info{constructor(e,r){super(e,r),this._reject=null,this._timer=null}async run(){if((exports.current=this).handle){try{logger.log(this.prefix+" "+(this.message||"")),await new Promise((e,r)=>{this.timeout(5e3);var t=this.handle.call(this);t instanceof Promise?(this._reject=r,t.then(()=>{clearTimeout(this._timer),e()}).catch(e=>{clearTimeout(this._timer),r(e)})):e()})}catch(e){logger.rollback(),logger.error(new Error(this.prefix+" "+(this.message||""))),console.log(""),console.log("%c"+(this.prefix+" "+(this.message||"")).trim(),"color: red;"),console.log("%c"+e.stack,"color: red;")}exports.current=this.parent}}timeout(e){clearTimeout(this._timer),this._timer=setTimeout(()=>{this._reject&&this._reject(new Error(`操作超时 ${e}ms`))},e)}}class Describe extends Info{constructor(e,r){super(e,r),this.parent=null,this.subDescribes=[],this.subIts=[],this.before=null,this.after=null}addBefore(e){this.before=e}addAfter(e){this.after=e}addDescribe(e){(e.parent=this).subDescribes.push(e)}addIt(e){(e.parent=this).subIts.push(e)}async run(){if((exports.current=this).handle)try{await this.handle(),this.parent&&logger.log(this.prefix+" "+(this.message||""))}catch(e){this.parent&&(logger.error(new Error(this.prefix+" "+(this.message||""))),console.error(this.prefix+" "+(this.message||"")),console.error(e))}try{this.before&&await this.before()}catch(e){this.parent&&(logger.error(new Error(this.prefix+" "+(this.message||""))),console.error(this.prefix+" "+(this.message||"")),console.error(e))}for(let e=0;e<this.subIts.length;e++)await this.subIts[e].run(e);for(let e=0;e<this.subDescribes.length;e++)await this.subDescribes[e].run(e);try{this.after&&await this.after()}catch(e){this.parent&&(logger.error(new Error(this.prefix+" "+(this.message||""))),console.error(this.prefix+" "+(this.message||"")),console.error(e))}this.parent?exports.current=this.parent:exports.current=new Describe}}global.describe=async function(e,r){exports.current.addDescribe(new Describe(e,r))},global.it=function(e,r){exports.current.addIt(new It(e,r))},global.before=function(e){exports.current.addBefore(e)},global.after=function(e){exports.current.addAfter(e)},exports.current=new Describe,exports.Describe=Describe,exports.It=It;