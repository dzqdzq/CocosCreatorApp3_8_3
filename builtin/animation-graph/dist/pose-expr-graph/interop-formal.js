"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.isPoseExprState=exports.addPoseExprState=exports.PoseExprGraphInterop=void 0;const assert_1=__importDefault(require("assert")),cc_1=require("cc"),new_gen_anim_1=require("cc/editor/new-gen-anim"),env_type_1=require("../env-type"),new_gen_anim_2=require("cc/editor/new-gen-anim"),id_manager_1=require("./utils/id-manager"),globalIDManager=new id_manager_1.IDManager,typeInfos=Object.freeze({[new_gen_anim_1.poseGraphOp.PoseGraphType.INTEGER]:{displayName:"i18n:animation-graph.pose.type.integer.displayName",themeColor:"#2A90DC"},[new_gen_anim_1.poseGraphOp.PoseGraphType.FLOAT]:{displayName:"i18n:animation-graph.pose.type.float.displayName",themeColor:"#8471CF"},[new_gen_anim_1.poseGraphOp.PoseGraphType.BOOLEAN]:{displayName:"i18n:animation-graph.pose.type.boolean.displayName",themeColor:"#D07979"},[new_gen_anim_1.poseGraphOp.PoseGraphType.VEC3]:{displayName:"i18n:animation-graph.pose.type.vec3.displayName",themeColor:"#D97721"},[new_gen_anim_1.poseGraphOp.PoseGraphType.QUAT]:{displayName:"i18n:animation-graph.pose.type.quat.displayName",themeColor:"#B169C4"},[new_gen_anim_1.poseGraphOp.PoseGraphType.POSE]:{displayName:"i18n:animation-graph.pose.type.pose.displayName",themeColor:"#227F9B"}});class PoseGraphInterop_Formal{constructor(e,t,n){this._context=n,this._idManager=globalIDManager,this._animationGraph=e,this._poseGraph=(0 instanceof new_gen_anim_1.ProceduralPoseState,t.graph),this._rootOutputNodeID=this._idManager.getOrCreate(this._poseGraph.outputNode)}query(){var e=[],t=[],n=this._rootOutputNodeID,a=new Map;for(const y of this._poseGraph.nodes()){var r=this._getNodeId(y),o=this.queryNodeDump(r),s=null!=(s=y[cc_1.editorExtrasTag])?s:y[cc_1.editorExtrasTag]={};const f=[];var i=new_gen_anim_1.poseGraphOp.getInputKeys(y).map(e=>{var t,n,a=(0,new_gen_anim_1.getPoseGraphNodeInputAttrs)(y,e);if(new_gen_anim_1.poseGraphOp.getInputBinding(this._poseGraph,y,e)||isInputVisible(y,a))return t=new_gen_anim_1.poseGraphOp.getInputMetadata(y,e),(0,assert_1.default)(t),n=new_gen_anim_1.poseGraphOp.getInputConstantValue(y,e),n=cce.Dump.encode.encodeObject(n,a,y),f.push(e),{id:encodeNodeInputKey(e),name:getNodeInputName(y,e,t),value:n,deletable:t.deletable,type:t.type}}).filter(e=>!!e),p=(a.set(y,f),new_gen_anim_1.poseGraphOp.getInputInsertInfos(y)),d=new_gen_anim_1.poseGraphOp.getOutputKeys(y).map(e=>({id:e,name:"",type:new_gen_anim_1.poseGraphOp.getOutputType(y,e)})),_=getNodeTitle(y),u=(0,new_gen_anim_2.getNodeAppearanceOptions)(y),h=!(null==(h=y.getEnterInfo)||!h.call(y));e.push({id:r,name:_,inputs:i,outputs:d,inputInsertInfos:p,enterable:h,data:o,editorData:s,appearance:u})}for(const I of this._poseGraph.nodes()){var g=a.get(I);(0,assert_1.default)(g);for(const G of g){var l=new_gen_anim_1.poseGraphOp.getInputBinding(this._poseGraph,I,G);l&&t.push({sourceID:this._getNodeId(l.producer),sourceOutputID:l.outputIndex,destinationID:this._getNodeId(I),destinationInputID:encodeNodeInputKey(G)})}}var c,m,N={};for([c,m]of(0,new_gen_anim_2.getPoseGraphAssetDragHandlersMap)())N[cc_1.js.getClassId(c)]=m;return{nodes:e,links:t,rootOutputNode:n,addNodeInfos:this.queryAddNodeInfos(),inputOutputTypeInfos:this.queryTypeInfos(),editorData:this._poseGraph[cc_1.editorExtrasTag],assetDragHandlersMap:N}}queryTypeInfos(){return typeInfos}get TYPE_ID_POSE(){return new_gen_anim_1.poseGraphOp.PoseGraphType.POSE}queryAddNodeInfos(){return[...function*(){var e={animationGraph:this._animationGraph,layerIndex:this._context.layerIndex};for(var[t,n]of Object.entries(cc_1.js._idToClass))if(cc_1.js.isChildClassOf(n,new_gen_anim_1.poseGraphOp.Node))for(const a of(0,new_gen_anim_1.getCreatePoseGraphNodeEntries)(n,e))yield[{typeId:t,args:a.arg},{menu:composeCreateNodeMenu(n,a)}]}.call(this)]}getNodeName(e){var t=this._findNode(e);if(t)return getNodeTitle(t);this._reportMissingNode(e)}getNodeEditorData(e){var t,n=this._findNode(e);if(n)return null!=(t=n[cc_1.editorExtrasTag])?t:n[cc_1.editorExtrasTag]={};this._reportMissingNode(e)}addNode(e,t){var n=cc_1.js.getClassById(e.typeId);if(n&&cc_1.js.isChildClassOf(n,new_gen_anim_1.poseGraphOp.Node))return n=(0,new_gen_anim_1.createPoseGraphNode)(n,e.args),this._emplaceNode(n,t)}removeNode(e){var t;if(e!==this._rootOutputNodeID)return(t=this._findNode(e))?void this._poseGraph.removeNode(t):this._reportMissingNode(e);console.error("根节点不可删除。")}addLink(e,t,n,a){var r,o,s,i,p=this._findNode(e);return p?void 0===(r=this._findOutput(p,t))?this._reportMissingNodeOutput(p,e,t):(t=this._findNode(n))?(s=(o=this._findInput(t,a))?new_gen_anim_1.poseGraphOp.getInputMetadata(t,o):void 0,o&&s?new_gen_anim_1.poseGraphOp.hasInputBinding(this._poseGraph,t,o,p,r)?console.error(`源结点 ${p} 的输出 ${r} 和目标结点 ${t} 的输入 ${o} 之间已经存在了链接。不能重复链接。`):(null==(i=new_gen_anim_1.poseGraphOp.getInputMetadata(t,o))?void 0:i.type)!==(i=new_gen_anim_1.poseGraphOp.getOutputType(p,r))?this._reportTypeMismatch(t,o,s.type,p,r,i):void new_gen_anim_1.poseGraphOp.connectNode(this._poseGraph,t,o,p,r):this._reportMissingNodeInput(t,n,a)):this._reportMissingNode(n):this._reportMissingNode(e)}removeLink(e,t,n,a){var r,o,s,i=this._findNode(e);return i?void 0===(r=this._findOutput(i,t))?this._reportMissingNodeOutput(i,e,t):(o=this._findNode(n))?(s=this._findInput(o,a))?new_gen_anim_1.poseGraphOp.hasInputBinding(this._poseGraph,o,s,i,r)?void new_gen_anim_1.poseGraphOp.disconnectNode(this._poseGraph,o,s):console.error(`源结点 ${e} 的输出 ${t} 和目标结点 ${n} 的输入 ${a} 之间并不存在连接。`):this._reportMissingNodeInput(o,n,a):this._reportMissingNode(n):this._reportMissingNode(e)}insertInput(e,t){var n=this._findNode(e);return n?t in new_gen_anim_1.poseGraphOp.getInputInsertInfos(n)?void new_gen_anim_1.poseGraphOp.insertInput(this._poseGraph,n,t):console.error(`结点 ${e} 的插入信息ID ${t} 无效。`):this._reportMissingNode(e)}deleteInput(e,t){var n,a,r=this._findNode(e);return r?(a=this._findInput(r,t))?null!=(n=null==(n=new_gen_anim_1.poseGraphOp.getInputMetadata(r,a))?void 0:n.deletable)&&n?console.error(`结点 ${e} 的输入 ${t} 不可删除。`):void new_gen_anim_1.poseGraphOp.deleteInput(this._poseGraph,r,a):this._reportMissingNodeInput(r,e,t):this._reportMissingNode(e)}getNodeEnterInfo(e){var t,n=this._findNode(e);if(n){var a=null==(t=n.getEnterInfo)?void 0:t.call(n);if(a)switch(a.type){case"animation-blend":return{type:env_type_1.EnvType.PoseExprAnimationBlend,target:a.target};case"state-machine":return{type:env_type_1.EnvType.StateMachine,target:a.target};case"stash":return{type:env_type_1.EnvType.LayerStash,target:{layerIndex:this._context.layerIndex,stashName:a.stashName}};default:return}}else this._reportMissingNode(e)}updateNodeEditorData(e,t){var n=this._findNode(e);if(!n)return this._reportMissingNode(e);Object.assign(null!=(e=n[cc_1.editorExtrasTag])?e:n[cc_1.editorExtrasTag]={},t)}async updateNodeInputValue(e,t,n){if(e===this._rootOutputNodeID)return console.error("不能主动设置根输出结点的输入值。");var a=this._findNode(e);if(!a)return this._reportMissingNode(e);var r=this._findInput(a,t);if(!r)return this._reportMissingNodeInput(a,e,t);var o={value:new_gen_anim_1.poseGraphOp.getInputConstantValue(a,r)};await cce.Dump.decode.decodePatch("value",n,o);for(let e=a,t=0;t<r.length;++t){var s=r[t];if("string"==typeof s){if("object"!=typeof e||!e)return void console.error("错误的 Dump 数据！期望是对象但不是");if(!(s in e))return void console.error(`错误的 Dump 数据！期望对象存在属性 ${s} 但没有`)}else{if((0,assert_1.default)("number"==typeof s),!Array.isArray(e))return void console.error("错误的 Dump 数据！期望是数组但不是");if(s<0||s>=e.length)return void console.error(`错误的 Dump 数据！数组长度不匹配 ${s}/`+r.length)}t===r.length-1?e[s]=o.value:e=e[s]}}updateGraphEditorData(e){var t,n;Object.assign(null!=(t=(n=this._poseGraph)[cc_1.editorExtrasTag])?t:n[cc_1.editorExtrasTag]={},e)}queryNodeDump(e){var t=this._findNode(e);return t?cce.Dump.encode.encodeObject(t,{}):this._reportMissingNode(e)}async updateNodeDump(e,t,n){var a=this._findNode(e);if(!a)return this._reportMissingNode(e);await cce.Dump.decode.decodePatch(t,n,a)}copyNodes(e){let t=!1;var n=[];for(const r of e){if(r===this._rootOutputNodeID){console.error("Root output node is not copyable."),t=!0;break}var a=this._findNode(r);if(!a){this._reportMissingNode(r),t=!0;break}n.push(a)}if(!t){e=(0,new_gen_anim_1.copyPoseGraphNodes)(this._poseGraph,n);if(e)return{serialized:EditorExtends.serialize(e)}}}async pasteNodes(e){e=await cce.Utils.deserializeFull(e.serialized),e=(0,new_gen_anim_1.pastePoseGraphNodes)(this._poseGraph,e).addedNodes;return e.map(e=>this._collectNode(e))}async pasteStateMachine(e){e=(0,new_gen_anim_2.copyStateMachineAsPoseGraphNode)(e),e={serialized:EditorExtends.serialize(e)};return this.pasteNodes(e)}handleDropAssetIntoPoseGraph(e,t,n){e=(0,new_gen_anim_2.createPoseNodeOnAssetDrag)(e,n);return!!e&&(this._emplaceNode(e,{centerX:t.x,centerY:t.y}),!0)}stash(e,t,n){e=(0,new_gen_anim_1.stashPoseGraph)(e,this._poseGraph,t);e&&(t=e.useStashNode,n)&&(t[cc_1.editorExtrasTag]=n,this._collectNode(t))}_getNodeId(e){return this._idManager.getOrCreate(e)}_emplaceNode(e,t){return this._poseGraph.addNode(e),t&&(e[cc_1.editorExtrasTag]=t),this._collectNode(e)}_collectNode(e){return(0,assert_1.default)([...this._poseGraph.nodes()].includes(e)),this._idManager.add(e)}_findNode(e){for(const t of this._poseGraph.nodes())if(this._idManager.getOrCreate(t)===e)return t}_findInput(e,t){t=decodeNodeInputKey(t);return t&&new_gen_anim_1.poseGraphOp.isValidInputKey(e,t)?t:void 0}_findOutput(e,t){return new_gen_anim_1.poseGraphOp.getOutputKeys(e).includes(t)?t:void 0}_reportMissingNode(e){console.warn(`结点 ${e} 不在图中。`)}_reportMissingNodeInput(e,t,n){console.warn(`结点 ${t} 不存在输入 ${n}。`)}_reportMissingNodeOutput(e,t,n){console.warn(`结点 ${t} 不存在输出 ${n}。`)}_reportTypeMismatch(e,t,n,a,r,o){t=1===new_gen_anim_1.poseGraphOp.getInputKeys(e).length?Editor.I18n.t("animation-graph.pose.type_mismatch_message.unique_input"):Editor.I18n.t("animation-graph.pose.type_mismatch_message.named_input",{name:getNodeInputName(e,t)}),r=1===new_gen_anim_1.poseGraphOp.getOutputKeys(a).length?Editor.I18n.t("animation-graph.pose.type_mismatch_message.unique_output"):Editor.I18n.t("animation-graph.pose.type_mismatch_message.named_output",{name:""+r});console.error(Editor.I18n.t("animation-graph.pose.type_mismatch_message.message",{consumerNode:getNodeTitle(e),input:t,inputType:this._getTypeNameI18N(n),producerNode:getNodeTitle(a),output:r,outputType:this._getTypeNameI18N(o)}))}_getTypeNameI18N(e){e=typeInfos[e].displayName;return e.startsWith("i18n:")?Editor.I18n.t(e.slice("i18n:".length)):e}}exports.PoseExprGraphInterop=PoseGraphInterop_Formal;const addPoseState_Formal=(e,{rootOutputNodeEditorData:t,poseGraphEditorData:n})=>{var a,r,e=e.addProceduralPoseState();return t&&(r=e.graph.outputNode,Object.assign(null!=(a=r[cc_1.editorExtrasTag])?a:r[cc_1.editorExtrasTag]={},t)),Object.assign(null!=(r=(a=e.graph)[cc_1.editorExtrasTag])?r:a[cc_1.editorExtrasTag]={},n),e},isPoseState_Formal=(exports.addPoseExprState=addPoseState_Formal,e=>e instanceof new_gen_anim_1.ProceduralPoseState);function getNodeTitle(e){if(e.getTitle){var t=e.getTitle();if(void 0!==t)return"string"==typeof t?t:tryTranslate(...t)}var n,t=e.constructor,e=cc_1.js.getClassName(e);return e?(n=getClassConventionalI18nKey(e))?`i18n:${n}.displayName`:e:t.name}function getNodeInputName(e,t,n){if(n){if("string"==typeof n.displayName)return n.displayName;if(Array.isArray(n.displayName))return tryTranslate(...n.displayName)}n=getClassConventionalI18nKey(cc_1.js.getClassName(e.constructor));if(n){e=(0,new_gen_anim_1.getInputConventionalI18nInfo)(t);if(e){n=Editor.I18n.t(`${n}.${e[0]}.displayName`,e[1]);if(n)return n}}return(0,new_gen_anim_1.getInputDefaultDisplayName)(t)}function composeCreateNodeMenu(e,t){var n=[],e=(t.category&&n.push(t.category),getClassDisplayNameMayBeI18N(e));return n.push(e),t.subMenu&&n.push(t.subMenu),n.join("/")}function getClassDisplayNameMayBeI18N(e){var t,n=cc_1.js.getClassName(e);return n?(t=getClassConventionalI18nKey(n))?`i18n:${t}.displayName`:n:e.name}function getClassConventionalI18nKey(e){return e?e.startsWith("cc.")?"ENGINE.classes."+e:e:""}function tryTranslate(e,t){return Editor.I18n.t(e,t)||e}function encodeNodeInputKey(e){return JSON.stringify(e)}function decodeNodeInputKey(e){let t;try{t=JSON.parse(e)}catch(e){return}if(new_gen_anim_1.poseGraphOp.isWellFormedInputKey(t))return t}function isInputVisible(e,t){t=t.visible;return void 0===t||("boolean"==typeof t?t:t.call(e))}exports.isPoseExprState=isPoseState_Formal;