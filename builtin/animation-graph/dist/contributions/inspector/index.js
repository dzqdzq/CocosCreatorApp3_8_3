"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,a)}:function(e,t,n,i){e[i=void 0===i?n:i]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.ready=exports.methods=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),Vue=require("vue/dist/vue.js"),variable_selection_1=(Vue.config.productionTip=!1,Vue.config.devtools=!1,__importDefault(require("./variable-selection"))),condition_grid_1=__importDefault(require("./condition/condition-grid")),event_bindings_area_1=__importDefault(require("./event-bindings-area")),layer_stashes_area_1=__importDefault(require("./layer-stash/layer-stashes-area")),MotionProp=__importStar(require("../../components/motion-prop")),ComponentProp=__importStar(require("../../components/component-prop")),transitionPreview=__importStar(require("../../components/transition-preview")),motionPreview=__importStar(require("../../components/motion-preview")),vueTemplate=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../static/template/inspector.html"),"utf8"),AnimationGraphInspectorVM=Vue.extend({name:"AnimationGraphInspectorVM",components:{"variable-selection":variable_selection_1.default,"motion-prop":MotionProp,"component-prop":ComponentProp,"transition-preview":transitionPreview,"motion-preview":motionPreview,"condition-grid":condition_grid_1.default,"event-bindings-area":event_bindings_area_1.default,"layer-stashes-area":layer_stashes_area_1.default},directives:{focus:{inserted(e){e.focus()}}},data(){return{sceneReady:!1,poseExprExperiment:!0,active:"layer",variableNameValue:"",queryData:{assetInfo:{uuid:""},isDirty:!1,pasteInfo:{type:"none"},envType:{SubStateMachine:"SubStateMachine",ClipMotion:"ClipMotion",AnimationBlend1D:"AnimationBlend1D",AnimationBlend2D:"AnimationBlend2D"},view:{crumbs:[],stateMachine:{states:[],transitions:[]},layerIndex:-1,stateIndex:-1,motionLevel:[],transitionIndex:-1,motion:void 0,poseExpr:void 0,poseExprNodeId:-1},layers:[],variables:{},variableType:0,previewState:{},unaryConditionOperator:{},binaryConditionOperator:{},binaryConditionOperatorI18n:{},unaryConditionOperatorI18n:{},conditionVariableType:[],cannotAddMotionStateType:[],cannotRemoveStateType:[],cannotAddComponentStateType:[],motionType:[],animationBlendType:[],AnimationBlend2DAlgorithm:{},TCBindingValueType:{},tcBindingTypeInfos:{}}}},watch:{queryData(){1===this.queryData.view.crumbs.length?this.active="layer":this.active="state"}},async mounted(){this.poseExprExperiment=await this.getPoseExprExperiment(),this.sceneReady=await Editor.Message.request("scene","query-is-ready"),this.sceneReady&&await this.refresh()},methods:{t(e){return Editor.I18n.t("animation-graph."+e)},async refresh(){var e=await Editor.Message.request("scene","execute-scene-script",{name:"animation-graph",method:"query",args:[]});this.queryData=e},twinkle(){Editor.Message.request("assets","ui-kit:touch-asset",this.queryData.assetInfo.uuid)},getLastCrumb(){var e=this.queryData.view.crumbs.length-1;return this.queryData.view.crumbs[e]},viewLayer(){return this.queryData.layers[this.queryData.view.layerIndex]},changeLayer(e,t){var e=e.target;e&&(e="string"==typeof e.value?e.value.trim():e.value,Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeLayer",args:[this.queryData.view.layerIndex,t,e]}))},viewStateMachine(){return this.queryData.view.stateMachine},viewState(){var e=this.viewStateMachine();if(e){e=e.states;if(Array.isArray(e)){const t=this.queryData.view.stateIndex;return e.find(e=>e.index===t)}}},stateMenu(){const e=this.viewState();var t;e&&!this.queryData.cannotRemoveStateType.includes(e.type)&&((t=[]).unshift({label:Editor.I18n.t("animation-graph.state.rename"),click:()=>{this.$set(e,"rename",!0)}},{type:"separator"},{label:Editor.I18n.t("animation-graph.state.remove"),click:()=>{this.removeState(this.queryData.view.stateIndex)}},{type:"separator"}),Editor.Menu.popup({menu:t}))},removeState(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeState",args:[e]})},changeState(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeState",args:[this.queryData.view.stateIndex,t,e]})},renameStateSubmit(e){var t,e=e.target;e&&(t=this.viewState())&&((e=e.value.trim())&&e!==t.name&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"renameState",args:[this.queryData.view.stateIndex,e]}),t.rename=!1)},renameStateCancel(){var e=this.viewState();e&&(e.rename=!1)},componentMenu(e){var t=[{label:Editor.I18n.t("animation-graph.component.remove"),click:()=>{Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeComponent",args:[this.queryData.view.stateIndex,e]})}}];Editor.Menu.popup({menu:t})},addComponent(t,e){Date.now();Editor.Panel.__protected__.openKit("ui-kit.searcher",{elem:e,params:[{type:"script",droppable:"cc.animation.StateMachineComponent"}],listeners:{confirm(e){e&&(e={name:e.info.name},Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addComponent",args:[t,e]}))}}})},changeComponent(e,t,n){void 0===n&&(n=this.queryData.view.stateIndex),Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeComponent",args:[n,t,e]})},currentMotion(){return this.queryData.view.motion},viewMotion(){var e=this.currentMotion();if(e){var n=this.queryData.view.motionLevel;if(0!==n.length){let t=e;for(let e=1;e<n.length;e++){var i=n[e];t=t.children[i]}return t}}},getAddMotionMenu(){return[{label:Editor.I18n.t("animation-graph.motion.ClipMotion"),click:()=>{this.addMotionToState({type:this.queryData.envType.ClipMotion})}},{label:Editor.I18n.t("animation-graph.motion.AnimationBlend1D"),click:()=>{this.addMotionToState({type:this.queryData.envType.AnimationBlend1D})}},{label:Editor.I18n.t("animation-graph.motion.AnimationBlend2D"),click:()=>{this.addMotionToState({type:this.queryData.envType.AnimationBlend2D})}}]},getReplaceMotionMenu(){return[{label:Editor.I18n.t("animation-graph.motion.replaceWithAnim"),click:()=>{this.addMotionToState({type:this.queryData.envType.ClipMotion})}},{label:Editor.I18n.t("animation-graph.motion.replaceWith1D"),click:()=>{this.addMotionToState({type:this.queryData.envType.AnimationBlend1D})}},{label:Editor.I18n.t("animation-graph.motion.replaceWith2D"),click:()=>{this.addMotionToState({type:this.queryData.envType.AnimationBlend2D})}}]},motionMenuInState(){var e=[{label:Editor.I18n.t("animation-graph.motion.remove"),click:()=>{Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotion",args:[this.queryData.view.stateIndex]})}}];e.unshift(...this.getReplaceMotionMenu(),{type:"separator"}),Editor.Menu.popup({menu:e})},motionAddMenuInState(){var e=this.getAddMotionMenu();Editor.Menu.popup({menu:e})},motionMenuInMotion(e){var t=[{label:Editor.I18n.t("animation-graph.motion.remove"),click:()=>{Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotionInMotion",args:[this.queryData.view.motionLevel]})}}];e.type!==this.queryData.envType.AnimationBlend1D&&e.type!==this.queryData.envType.AnimationBlend2D||t.unshift({label:Editor.I18n.t("animation-graph.motion.rename"),click:()=>{this.$set(e,"rename",!0)}},{type:"separator"}),Editor.Menu.popup({menu:t})},addMotionToState(e){var t=(e&&e.stateIndex?e:this.queryData.view).stateIndex,n="state-"+t,i=this.$refs[n],n=this.$refs[n+"-motion"];i&&(i.setAttribute("expand",""),n.setAttribute("expand","")),Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addMotionToState",args:[t,e]})},changeClipMotion(e){e=e.target.value;Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeClipMotion",args:[this.queryData.view.stateIndex,e]})},crumbMotion(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbMotion",args:[this.queryData.view.stateIndex]})},crumbMotionInMotion(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbMotionInMotion",args:[this.queryData.view.motionLevel]})},moveMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"moveMotion",args:[e,t]})},addMotionToMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addMotionToMotion",args:[e,t]})},renameMotionSubmit(e){var t,e=e.target;e&&(t=this.viewMotion())&&((e=e.value.trim())&&e!==t.name&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"renameMotionInMotion",args:[this.queryData.view.motionLevel,e]}),t.rename=!1)},renameMotionCancel(){var e=this.viewMotion();e&&(e.rename=!1)},removeMotionInMotion(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotionInMotion",args:[e]})},changeMotionAutoThreshold(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionAutoThreshold",args:[e,t]})},changeMotionThreshold1D(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionThreshold1D",args:[e,t,n]})},changeMotionThreshold2D(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionThreshold2D",args:[e,t,n]})},changeMotionProp(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionProp",args:[e,t,n]})},changeClipMotionInMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeClipMotionInMotion",args:[e,t]})},changeAnimationBlend1DInMotion(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeAnimationBlend1DInMotion",args:[e,t,n]})},changeAnimationBlend2DInMotion(e,t,n,i){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeAnimationBlend2DInMotion",args:[e,t,n,i]})},updateMotionPreview(e){var t=this.$refs.motionPreview;t&&t.update(e)},selectTransition(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"viewTransition",args:[e]})},viewTransition(){var e=this.viewStateMachine();if(e){e=e.transitions;if(Array.isArray(e)){const t=this.queryData.view.transitionIndex;return e.find(e=>e.index===t)}}},viewTransitions(){var e=this.viewStateMachine();if(!e)return[];const t=[];e=e.transitions;if(!Array.isArray(e))return[];const n=this.viewTransition();return n&&e.forEach(e=>{e.from.index===n.from.index&&e.to.index===n.to.index&&t.push(e)}),t},outGoingsTransitions(){var e=this.viewState();if(e){var t=this.viewStateMachine();const n=[];t=t.transitions;if(Array.isArray(t)){const i=e.outGoings;return t.forEach(e=>{i.includes(e.index)&&n.push(e)}),n}}},dragResetTransition(){var e=this.$refs.transitionList;e&&e.hasAttribute("dragging")&&e.removeAttribute("dragging")},dragStartTransition(e,t,n){e.stopPropagation();var i=this.$refs.transitionList;i&&i.setAttribute("dragging",""),null!=(i=e.dataTransfer)&&i.setData("_animation_graph_transition_drag_data_",t+","+n)},dragOverTransition(e){e.preventDefault();var t,n,i=this.$refs.transitionList;i&&i.hasAttribute("dragging")&&(n=(t=(i=e.currentTarget).getBoundingClientRect()).height/2,e.clientY-t.top<=n?i.setAttribute("drag-over","top"):t.bottom-e.clientY<=n&&i.setAttribute("drag-over","bottom"))},dragLeaveTransition(e){e.currentTarget.removeAttribute("drag-over")},dropTransition(t,n){if(t.dataTransfer){var i=t.dataTransfer.getData("_animation_graph_transition_drag_data_");if(i){var a=this.$refs.transitionList;if(a&&a.hasAttribute("dragging")){a.removeAttribute("dragging");var[a,i]=i.split(",").map(Number),t=t.currentTarget,o=t.getAttribute("drag-over");t.removeAttribute("drag-over");let e=n-i;0!==e&&(e<0&&(e+=1),"top"===o&&--e,Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"adjustTransitionPriority",args:[a,e]}))}}}},transitionMenu(e){var t=[{label:Editor.I18n.t("animation-graph.transition.removeAll"),click:()=>{this.removeTransition(e,!0)}}];Editor.Menu.popup({menu:t})},removeTransition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeTransition",args:[e,t]})},changeTransitionProp(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeTransitionProp",args:[e,t,n]})},getTransitionUnit(e){return e.relativeDuration?this.t("transition.unitTimes"):this.t("transition.unitSeconds")},getDestinationStartUnit(e){return e.relativeDestinationStart?this.t("transition.unitTimes"):this.t("transition.unitSeconds")},async getPoseExprExperiment(){return await Editor.Profile.getConfig("animation-graph","animation-graph.pose-expr")},updateTransitionPreview(e){var t=this.$refs.transitionPreview;t&&t.update(e)},conditionMenu(e){var t=[{label:Editor.I18n.t("animation-graph.condition.addUnary"),click:()=>{this.addCondition(e,{type:"UnaryCondition"})}},{label:Editor.I18n.t("animation-graph.condition.addBinary"),click:()=>{this.addCondition(e,{type:"BinaryCondition"})}},{label:Editor.I18n.t("animation-graph.condition.addTrigger"),click:()=>{this.addCondition(e,{type:"TriggerCondition"})}}];Editor.Menu.popup({menu:t})},addCondition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addCondition",args:[e,t]})},conditionTypeMenu(t,n){var e=this.queryData.conditionVariableType.map(e=>({label:e,type:"radio",checked:n[t].type===e,click:()=>{n[t].type=e}}));Editor.Menu.popup({menu:e})},conditionPropChange(e,t,n,i){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeConditionProps",args:[e,t,n,i]})},conditionBindingPropChange(e,t,n,i){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeConditionBindingProps",args:[e,t,n,i]})},conditionBindingTypeChange(e,t,n,i){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeConditionBindingType",args:[e,t,n,i]})},conditionVariableChange(e,t,n,i,a){n[i].value.variable=a,this.conditionSubmitChange(e,t,n)},conditionOperatorChange(e,t,n,i){n.operator=+i,this.conditionSubmitChange(e,t,n)},conditionConstantChange(e,t,n,i,a){n[i].value.constant=Number(a),this.conditionSubmitChange(e,t,n)},conditionSubmitChange(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeCondition",args:[e,t,n]})},removeCondition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeCondition",args:[e,t]})},currentPose(){return this.queryData.view.poseExpr},viewPoseNode(){var e=this.currentPose();if(e){e=e.nodes.find(e=>e.id===this.queryData.view.poseExprNodeId);if(e)return e.inputs.forEach(e=>{e.value&&"object"==typeof e.value&&(e.value.name=e.name)}),e}},getPoseNodeData(){var e=this.viewPoseNode();if(e&&e.data)return e.data.value},updatePoseNodeData(e,t,n){e=e.currentTarget;e&&e.dump&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"updatePoseNodeData",args:[n,t,e.dump]})},getPoseNodeInputs(){return[]},updatePoseNodeInput(e,t,n){e=e.target;e&&e.dump&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"updatePoseNodeInput",args:[t,n,e.dump]})},metric(e,t){e&&Editor.Metrics._trackEventWithTimer({category:"animationStateMachine",id:e,value:1})}},template:vueTemplate}),Elements=(exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../inspector.css"),"utf8"),exports.template='<div class="container"></div>',exports.$={container:".container"},{panel:{ready(){const n=this;let e;n.__animationGraphChanged__=()=>{window.cancelAnimationFrame(e),e=window.requestAnimationFrame(()=>{var e;null!=(e=n.vm)&&e.refresh()})},Editor.Message.__protected__.addBroadcastListener("animation-graph:changed",n.__animationGraphChanged__),n.__updateTransitionPreview__=e=>{var t;null!=(t=n.vm)&&t.updateTransitionPreview(e)},Editor.Message.__protected__.addBroadcastListener("scene:update-transition-preview",n.__updateTransitionPreview__),n.__updateMotionPreview__=e=>{var t;null!=(t=n.vm)&&t.updateMotionPreview(e)},Editor.Message.__protected__.addBroadcastListener("scene:update-motion-preview",n.__updateMotionPreview__),Editor.Profile.__protected__.on("change",exports.methods.profileChanged)},close(){Editor.Message.__protected__.removeBroadcastListener("animation-graph:changed",this.__animationGraphChanged__),Editor.Message.__protected__.removeBroadcastListener("scene:update-transition-preview",this.__updateTransitionPreview__),Editor.Message.__protected__.removeBroadcastListener("scene:update-motion-preview",this.__updateMotionPreview__),Editor.Profile.__protected__.removeListener("change",exports.methods.profileChanged)}}});function ready(){var e,t=this;for(const i in Elements){var n=Elements[i];n.ready&&n.ready.call(t)}null!=(e=t.vm)&&e.$destroy(),t.vm=new AnimationGraphInspectorVM,t.vm.$mount(t.$.container)}function close(){var e;for(const n in Elements){var t=Elements[n];t.close&&t.close.call(this)}null!=(e=this.vm)&&e.$destroy(),this.vm=null}exports.methods={apply(){var e;null!=(e=this.vm)&&e.apply()},refresh(){var e;null!=(e=this.vm)&&e.refresh()},unselect(){var e;null!=(e=this.vm)&&e.select({type:""})},delete(){var e=this.vm;if(e){var t=e.getLastCrumb();if(t)switch(t.type){case e.queryData.envType.state:e.removeState(t.value);break;case e.queryData.envType.transition:e.removeTransition(t.value,!0);break;case e.queryData.envType.MotionState:e.removeMotionInMotion(t.value)}}},profileChanged(e,t,n,i){this.vm&&t.includes("animation-graph")&&"animation-graph.pose-expr"===n&&(this.vm.poseExprExperiment=i)}},exports.ready=ready,exports.close=close;