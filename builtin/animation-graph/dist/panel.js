"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,n){void 0===n&&(n=a);var i=Object.getOwnPropertyDescriptor(t,a);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,n,i)}:function(e,t,a,n){e[n=void 0===n?a:n]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),throttle_debounce_1=require("throttle-debounce"),Vue=require("vue/dist/vue.js"),Layer=(Vue.config.productionTip=!1,Vue.config.devtools=!1,__importStar(require("./components/layer"))),MotionProp=__importStar(require("./components/motion-prop")),ComponentProp=__importStar(require("./components/component-prop"));let panel=null,vm=null;const vueTemplate=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../static","/template/index.html"),"utf8"),AnimationGraphPanelVM=Vue.extend({name:"AnimationGraphPanelVM",components:{layer:Layer,"motion-prop":MotionProp,"component-prop":ComponentProp},directives:{focus:{inserted(e){e.focus()}}},data(){return{sceneReady:!1,poseExprExperiment:!0,active:"",layerState:{readyAdd:!1,readyRenameIndex:-1,confirmRenameIndex:-1},variableState:{readyAdd:!1,readyRenameVariableName:"",confirmRenameVariableName:""},variableNameValue:"",queryData:{assetInfo:{uuid:""},isDirty:!1,pasteInfo:{type:"none"},envType:{SubStateMachine:"SubStateMachine",ClipMotion:"ClipMotion",AnimationBlend1D:"AnimationBlend1D",AnimationBlend2D:"AnimationBlend2D"},view:{crumbs:[],stateMachine:{states:[],transitions:[]},layerIndex:-1,stateIndex:-1,motionLevel:[],transitionIndex:-1,motion:void 0,poseExpr:void 0},layers:[],variables:{},variableType:0,previewState:{},unaryConditionOperator:{},binaryConditionOperator:{},binaryConditionOperatorI18n:{},unaryConditionOperatorI18n:{},conditionVariableType:[],cannotAddMotionStateType:[],cannotRemoveStateType:[],cannotAddComponentStateType:[],motionType:[],animationBlendType:[],AnimationBlend2DAlgorithm:{},TCBindingValueType:{},tcBindingTypeInfos:{}}}},watch:{queryData(){var e=this.$refs.layer,t=this.queryData.view;e&&t&&(t.motion?e.refresh("motion",t.motion):t.poseExpr?e.refresh("pose",t.poseExpr):t.stateMachine?e.refresh("state",t.stateMachine):e.clear())}},async mounted(){this.poseExprExperiment=await this.getPoseExprExperiment(),this.sceneReady=await Editor.Message.request("scene","query-is-ready"),this.sceneReady&&await this.refresh()},methods:{t(e){return Editor.I18n.t("animation-graph."+e)||"i18n:animation-graph."+e},async refresh(){var e=await Editor.Message.request("scene","execute-scene-script",{name:"animation-graph",method:"query",args:[]});this.queryData=e},twinkle(){Editor.Message.send("assets","ui-kit:touch-asset",this.queryData.assetInfo.uuid)},apply(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"apply",args:[]})},reset(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"reset",args:[]})},select(e){var t=this.viewState(),t=(null!=t&&t.rename&&(t.rename=!1),this.viewMotion());null!=t&&t.rename&&(t.rename=!1),Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeView",args:[e.type,e.index,e.level]})},async getPoseExprExperiment(){return await Editor.Profile.getConfig("animation-graph","animation-graph.pose-expr")},activeTab(e){this.active===e?this.active="":this.active=e},cancelTab(){this.active=""},crumbView(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbView",args:[e]})},getLastCrumb(){var e=this.queryData.view.crumbs.length-1;return this.queryData.view.crumbs[e]},crumbHasSubStateMachine(){var e=this.queryData.view.crumbs;return!!Array.isArray(e)&&e.some(e=>e.type===this.queryData.envType.SubStateMachine)},viewLayer(){return this.queryData.layers[this.queryData.view.layerIndex]},crumbLayer(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbLayer",args:[e]})},addLayer(e){var t,a=e.target;a&&(t=a.value.trim(),a.value="",this.addLayerSubmit(t),this.addLayerCancel(e))},addLayerSubmit:(0,throttle_debounce_1.debounce)(100,e=>{e&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addLayer",args:[e]})},{atBegin:!0}),addLayerReady(){this.layerState.readyAdd=!this.layerState.readyAdd},addLayerCancel(e){e=e.target;e&&(e.value="",this.layerState.readyAdd=!1)},removeLayer(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeLayer",args:[e]})},dragResetLayer(){var e=this.$refs.layerList;e&&e.hasAttribute("dragging")&&e.removeAttribute("dragging")},dragStartLayer(e,t){e.stopPropagation();var a=this.$refs.layerList;a&&(a.setAttribute("dragging",""),null!=(a=e.dataTransfer))&&a.setData("_animation_graph_layer_drag_data_",t.toString())},dragOverLayer(e){e.preventDefault();var t,a,n=this.$refs.layerList;n&&n.hasAttribute("dragging")&&(a=(t=(n=e.currentTarget).getBoundingClientRect()).height/2,e.clientY-t.top<=a?n.setAttribute("drag-over","top"):t.bottom-e.clientY<=a&&n.setAttribute("drag-over","bottom"))},dragLeaveLayer(e){e.currentTarget.removeAttribute("drag-over")},dropLayer(t,a){if(t.dataTransfer){var n=t.dataTransfer.getData("_animation_graph_layer_drag_data_");if(n){var i=this.$refs.layerList;if(i&&i.hasAttribute("dragging")){i.removeAttribute("dragging");i=Number(n),n=t.currentTarget,t=n.getAttribute("drag-over");n.removeAttribute("drag-over");let e=a-i;0!==e&&(e<0&&(e+=1),"top"===t&&--e,Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"moveLayer",args:[i,i+e]}))}}}},renameLayerReady(e){this.layerState.readyRenameIndex===e?(this.layerState.readyRenameIndex=-1,this.layerState.confirmRenameIndex=e):this.layerState.readyRenameIndex=e},renameLayerSubmit(e,t){var e=e.target;e&&((e=e.value.trim())&&e!==t.name&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"renameLayer",args:[t.index,e]}),this.renameLayerCancel())},renameLayerCancel(){this.layerState.readyRenameIndex=-1,this.layerState.confirmRenameIndex=-1},crumbStateMachine(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbStateMachine",args:[e]})},viewStateMachine(){return this.queryData.view.stateMachine},viewState(){var e=this.viewStateMachine();if(e){e=e.states;if(Array.isArray(e)){const t=this.queryData.view.stateIndex;return e.find(e=>e.index===t)}}},getState(t){var e=this.viewStateMachine();if(e){e=e.states;if(Array.isArray(e))return e.find(e=>e.index===t)}},generateStateId(e){return this.queryData.assetInfo.uuid+"-"+e},addState(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addState",args:[e]})},removeState(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeState",args:[e]})},crumbState(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbState",args:[e]})},moveState(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"moveState",args:[e,t]})},copyState(e){var t=this.getState(e);if(t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"copyState",args:[e]});const a=this.$refs.layer;if(a){const n=this.generateStateId(t.editorData.id);a.twinkle("state",n,"light"),setTimeout(()=>{a.twinkle("state",n,"")},1e3)}}},duplicateState(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"duplicateState",args:[e]})},pasteState(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"pasteState",args:[e,t]})},turnMotionStateIntoSubStateMachine(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"turnMotionStateIntoSubStateMachine",args:[e]})},stateCanNotAddComponent(e){return this.queryData.cannotAddComponentStateType.includes(e)},stateCanNotRemove(e){return this.queryData.cannotRemoveStateType.includes(e)},stateCanNotCopy(e){return this.queryData.cannotRemoveStateType.includes(e)},componentMenu(e){var t=[{label:Editor.I18n.t("animation-graph.component.remove"),click:()=>{Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeComponent",args:[this.queryData.view.stateIndex,e]})}}];Editor.Menu.popup({menu:t})},addComponent(t,e){Editor.Panel.__protected__.openKit("ui-kit.searcher",{elem:e,params:[{type:"script",droppable:"cc.animation.StateMachineComponent"}],listeners:{confirm(e){e&&(e={name:e.info.name},Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addComponent",args:[t,e]}))}}})},changeComponent(e,t,a){void 0===a&&(a=this.queryData.view.stateIndex),Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeComponent",args:[a,t,e]})},currentMotion(){return this.queryData.view.motion},viewMotion(){var e=this.currentMotion();if(e){var a=this.queryData.view.motionLevel;if(a&&0!==a.length){let t=e;for(let e=1;e<a.length;e++){var n=a[e];t=t.children[n]}return t}}},getAddMotionMenu(){return[{label:Editor.I18n.t("animation-graph.motion.ClipMotion"),click:()=>{this.addMotionToState({type:this.queryData.envType.ClipMotion})}},{label:Editor.I18n.t("animation-graph.motion.AnimationBlend1D"),click:()=>{this.addMotionToState({type:this.queryData.envType.AnimationBlend1D})}},{label:Editor.I18n.t("animation-graph.motion.AnimationBlend2D"),click:()=>{this.addMotionToState({type:this.queryData.envType.AnimationBlend2D})}}]},getReplaceMotionMenu(){return[{label:Editor.I18n.t("animation-graph.motion.replaceWithAnim"),click:()=>{this.addMotionToState({type:this.queryData.envType.ClipMotion})}},{label:Editor.I18n.t("animation-graph.motion.replaceWith1D"),click:()=>{this.addMotionToState({type:this.queryData.envType.AnimationBlend1D})}},{label:Editor.I18n.t("animation-graph.motion.replaceWith2D"),click:()=>{this.addMotionToState({type:this.queryData.envType.AnimationBlend2D})}}]},motionMenuInState(){var e=[{label:Editor.I18n.t("animation-graph.motion.remove"),click:()=>{Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotion",args:[this.queryData.view.stateIndex]})}}];Editor.Menu.popup({menu:e})},motionAddMenuInState(){var e=this.getAddMotionMenu();Editor.Menu.popup({menu:e})},motionMenuInMotion(e){var t=[{label:Editor.I18n.t("animation-graph.motion.remove"),click:()=>{Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotionInMotion",args:[this.queryData.view.motionLevel]})}}];e.type!==this.queryData.envType.AnimationBlend1D&&e.type!==this.queryData.envType.AnimationBlend2D||t.unshift({label:Editor.I18n.t("animation-graph.motion.rename"),click:()=>{this.$set(e,"rename",!0)}},{type:"separator"}),Editor.Menu.popup({menu:t})},addMotionToState(e){var t=(e&&e.stateIndex?e:this.queryData.view).stateIndex,a="state-"+t,n=this.$refs[a],a=this.$refs[a+"-motion"];n&&(n.setAttribute("expand",""),a.setAttribute("expand","")),Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addMotionToState",args:[t,e]})},changeClipMotion(e){e=e.target.value;Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeClipMotion",args:[this.queryData.view.stateIndex,e]})},crumbMotion(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbMotion",args:[this.queryData.view.stateIndex]})},crumbMotionInMotion(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbMotionInMotion",args:[this.queryData.view.motionLevel]})},moveMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"moveMotion",args:[e,t]})},addMotionToMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addMotionToMotion",args:[e,t]})},renameMotionSubmit(e){var t,e=e.target;e&&(t=this.viewMotion())&&((e=e.value.trim())&&e!==t.name&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"renameMotionInMotion",args:[this.queryData.view.motionLevel,e]}),t.rename=!1)},renameMotionCancel(){var e=this.viewMotion();e&&(e.rename=!1)},removeMotionInMotion(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotionInMotion",args:[e]})},changeMotionAutoThreshold(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionAutoThreshold",args:[e,t]})},changeMotionThreshold1D(e,t,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionThreshold1D",args:[e,t,a]})},changeMotionThreshold2D(e,t,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionThreshold2D",args:[e,t,a]})},changeMotionProp(e,t,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionProp",args:[e,t,a]})},changeClipMotionInMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeClipMotionInMotion",args:[e,t]})},changeAnimationBlend1DInMotion(e,t,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeAnimationBlend1DInMotion",args:[e,t,a]})},changeAnimationBlend2DInMotion(e,t,a,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeAnimationBlend2DInMotion",args:[e,t,a,n]})},transitionMenu(e){var t=[{label:Editor.I18n.t("animation-graph.condition.addUnary"),click:()=>{this.addCondition(e,{type:"UnaryCondition"})}},{label:Editor.I18n.t("animation-graph.condition.addBinary"),click:()=>{this.addCondition(e,{type:"BinaryCondition"})}},{label:Editor.I18n.t("animation-graph.condition.addTrigger"),click:()=>{this.addCondition(e,{type:"TriggerCondition"})}},{type:"separator"},{label:Editor.I18n.t("animation-graph.transition.remove"),click:()=>{this.removeTransition(e,!1)}}];Editor.Menu.popup({menu:t})},removeTransition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeTransition",args:[e,t]})},conditionMenu(e,t){var a=[{label:Editor.I18n.t("animation-graph.condition.remove"),click:()=>{this.removeCondition(e,t)}}];Editor.Menu.popup({menu:a})},addCondition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addCondition",args:[e,t]})},conditionTypeMenu(t,a){var e=this.queryData.conditionVariableType.map(e=>({label:e,type:"radio",checked:a[t].type===e,click:()=>{a[t].type=e}}));Editor.Menu.popup({menu:e})},conditionVariableChange(e,t,a,n,i){a[n].value.variable=i,this.conditionSubmitChange(e,t,a)},conditionOperatorChange(e,t,a,n){a.operator=+n,this.conditionSubmitChange(e,t,a)},conditionConstantChange(e,t,a,n,i){a[n].value.constant=Number(i),this.conditionSubmitChange(e,t,a)},conditionSubmitChange(e,t,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeCondition",args:[e,t,a]})},removeCondition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeCondition",args:[e,t]})},async addVariable(e,t){e&&(e=e.slice(0,1).toUpperCase()+e.slice(1).toLowerCase(),e=await Editor.Message.request("scene","execute-scene-script",{name:"animation-graph",method:"addVariable",args:[e,t]}),this.variableState.confirmRenameVariableName=e,this.variableState.readyAdd=!1)},addVariableReady(){this.variableState.readyAdd=!this.variableState.readyAdd},renameVariableReady(e){this.variableState.readyRenameVariableName===e?(this.variableState.readyRenameVariableName="",this.variableState.confirmRenameVariableName=e):this.variableState.readyRenameVariableName=e},renameVariableSubmit(e,t){var e=e.target;e&&((e=e.value.trim())&&e!==t&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"renameVariable",args:[t,e]}),this.renameVariableCancel())},renameVariableCancel(){this.variableState.readyRenameVariableName="",this.variableState.confirmRenameVariableName=""},changeVariable(e,t){t=t.currentTarget.dump;Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeVariable",args:[e,t]})},changeTriggerResetMode(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeTriggerResetMode",args:[e,t]})},removeVariable(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeVariable",args:[e]})},addPoseNode(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addPoseNode",args:[e]})},removePoseNode(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removePoseNode",args:[e]})},movePoseNode(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"movePoseNode",args:[e,t]})},crumbPoseNode(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbPoseNode",args:[e]})},copyPoseNode(e){const t=this.$refs.layer;if(t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"copyPoseNode",args:[e]});const a="node-"+e;t.twinkle("pose",a,"light"),setTimeout(()=>{t.twinkle("pose",a,"")},1e3)}},duplicatePoseNode(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"duplicatePoseNode",args:[e]})},pasteIntoPoseGraph(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"pasteIntoPoseGraph",args:[e]})},addPoseNodeInput(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addPoseNodeInput",args:[e,t]})},updatePoseNodeInput(e,t,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"updatePoseNodeInput",args:[e,t,a]})},getPoseLinkColor(e){var t=this.queryData.view.poseExpr;return t&&t.inputOutputTypeInfos&&t.inputOutputTypeInfos[e]&&t.inputOutputTypeInfos[e].themeColor||"#fafafa"},addPoseLink(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addPoseLink",args:[...e]})},removePoseLink(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removePoseLink",args:[...e]})},toggleCollapsePoseNode(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"toggleCollapsePoseNode",args:[e,t]})},stashCurrentPoseGraph(...e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"stashCurrentPoseGraph",args:e})}},template:vueTemplate});function ready(){panel=this,null!==vm&&void 0!==vm&&vm.$destroy(),(vm=new AnimationGraphPanelVM).$mount(panel.$.container),Editor.Profile.__protected__.on("change",exports.methods.profileChanged)}async function beforeClose(){return Editor.Message.request("scene","execute-scene-script",{name:"animation-graph",method:"beforeClose",args:[]})}function close(){Editor.Profile.__protected__.removeListener("change",exports.methods.profileChanged),null!==vm&&void 0!==vm&&vm.$destroy(),vm=null,panel=null}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../dist/index.css"),"utf8"),exports.template='<div class="container"></div>',exports.$={container:".container"},exports.methods={apply(){vm&&vm.apply()},refresh(){vm&&vm.refresh()},unselect(){vm&&vm.select({type:""})},delete(){if(vm){var e=vm.getLastCrumb();if(e)switch(e.type){case vm.queryData.envType.state:vm.removeState(e.value);break;case vm.queryData.envType.transition:vm.removeTransition(e.value,!0);break;case vm.queryData.envType.MotionState:vm.removeMotionInMotion(e.value);break;case vm.queryData.envType.PoseExprNode:vm.removePoseNode(e.value)}}},copy(){if(vm){var e=vm.getLastCrumb();if(e)switch(e.type){case vm.queryData.envType.state:vm.copyState(e.value);break;case vm.queryData.envType.PoseExprNode:vm.copyPoseNode(e.value)}}},duplicate(){if(vm){var e=vm.getLastCrumb();if(e)switch(e.type){case vm.queryData.envType.state:vm.duplicateState(e.value);break;case vm.queryData.envType.PoseExprNode:vm.duplicatePoseNode(e.value)}}},paste(){if(vm){var e=vm.getLastCrumb();if(e)switch(e.type){case vm.queryData.envType.layer:case vm.queryData.envType.state:vm.pasteState(!1);break;case vm.queryData.envType.PoseExprState:case vm.queryData.envType.PoseExprNode:vm.pasteIntoPoseGraph()}}},profileChanged(e,t,a,n){vm&&t.includes("animation-graph")&&"animation-graph.pose-expr"===a&&(vm.poseExprExperiment=n)}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;