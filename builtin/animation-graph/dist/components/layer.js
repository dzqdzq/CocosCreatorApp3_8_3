"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.destroyed=exports.mounted=exports.methods=exports.watch=exports.computed=exports.data=exports.components=exports.template=void 0;const validation_1=require("../clip-related/validation"),defaultType="state";function data(){return{clipAssetType:"cc.AnimationClip",graphData:{},graph:{scale:1,top:0,left:0,centerX:0,centerY:0,type:defaultType},minScale:.05,maxScale:2,mouseDownPoint:null}}function mounted(){const e=this;e.observer=new window.ResizeObserver(()=>{e.resize()}),e.observer.observe(e.$el),e.resize()}function destroyed(){this.observer&&this.observer.unobserve(this.$el)}exports.template=`
    <ui-drag-area class="layer"
        :droppable="clipAssetType"
        @mousedown="mouseDown($event)"
        @wheel="wheel($event)"
        @drop="drop($event)"
    >
        <grid class="grid" ref="grid"></grid>
        <transition name="component-fade" mode="out-in"
            v-on:before-enter="beforeEnter"
            v-on:before-leave="beforeLeave"
        >
            <component class="graph" ref="component"
                :is="graph.type"
                :type="graph.type"
                :style="graphStyle"
                :graph="graphData"
            ></component>
        </transition>
    </ui-drag-area>
`,exports.components={grid:require("./grid"),state:require("./state"),motion:require("./motion"),pose:require("./pose")},exports.data=data,exports.computed={graphStyle(){var e=this;return{top:Math.ceil(e.graph.top)+"px",left:Math.ceil(e.graph.left)+"px",transform:`scale(${e.graph.scale})`}}},exports.watch={"graph.scale"(){this.moveViewport()},"graph.top"(){this.moveViewport()},"graph.left"(){this.moveViewport()},"graph.centerX"(){this.$refs.component&&this.$refs.component.resize()},"graph.centerY"(){this.$refs.component&&this.$refs.component.resize()}},exports.methods={beforeEnter(){this.$refs.grid.$el.classList.remove("animationOut"),this.$refs.grid.$el.classList.add("animationIn")},beforeLeave(){this.$refs.grid.$el.classList.remove("animationIn"),this.$refs.grid.$el.classList.add("animationOut")},async refresh(e,t){var r=this;r.graph.type=e,await r.refreshViewport(t),r.graphData=t},resize(){var e=this;e.graph.centerX=e.$el.offsetWidth/2,e.graph.centerY=e.$el.offsetHeight/2},clear(){var e=this;e.graph.type=defaultType,e.graphData={},e.viewport()},viewport(){var e=this;e.graph.scale=1,e.graph.top=0,e.graph.left=0},async bestViewport(){var e=this,t=e.$el.clientWidth,r=e.$el.clientHeight,o=e.calcComponentRect(),i=t/o.width,a=r/o.height,i=.95*(Math.min(i,a,1)||1);e.graph.scale=i,e.graph.left=(t-o.width*i)/2-o.minX*i-t*(1-i)/2,e.graph.top=(r-o.height*i)/2-o.minY*i-r*(1-i)/2,e.saveViewport()},moveViewport(){const e=this;window.cancelAnimationFrame(e.viewportAnimationId),e.viewportAnimationId=window.requestAnimationFrame(()=>{e.saveViewport()})},getViewportKey(e){var t,r=this,o=["viewport"];if(r.$root.queryData.assetInfo&&o.push(r.$root.queryData.assetInfo.uuid),null!=(t=(e=e||r.graphData).editorData)&&t.id)o.push(e.editorData.id);else{const i=[];r.$root.queryData.view.crumbs.slice(0,-1).forEach(e=>{e.type&&i.push(e.type+"-"+e.value)}),o.push(i.join("-"))}return o.join(".")},async refreshViewport(e){var t=this;try{var r=await Editor.Profile.getTemp("animation-graph",t.getViewportKey(e));r?Object.assign(t.graph,r):t.viewport()}catch(e){console.error("animation-graph get local viewport data error: "+e)}},async saveViewport(){var e=this;await Editor.Profile.setTemp("animation-graph",e.getViewportKey(),{scale:e.graph.scale,top:e.graph.top,left:e.graph.left})},select(e){this.$refs.component.select(e)},wheel(e){var t,r,o,i,a,n=this;e.stopPropagation(),e.preventDefault(),n.$refs.component&&(o=n.$refs.component.$el.getBoundingClientRect(),i=n.graph.scale,t=0-(e.deltaX||e.deltaY)/5e3,r=0-(e.clientY-(o.y+o.height/2))*t/i,e=0-(e.clientX-(o.x+o.width/2))*t/i,o=i,i=n.graph.top,a=n.graph.left,(o+=t)<n.minScale||o>n.maxScale||(i+=r,a+=e,n.graph.scale=o,n.graph.top=i,n.graph.left=a))},mouseDown(e){const s=this;var t,r,o;function i(e){var t,r,o,i,a,n;s.mouseDownPoint&&"right"===s.mouseDownPoint.button&&(e.stopPropagation(),e.preventDefault(),{clientX:n,clientY:t,gridStartX:r,gridStartY:o,graphLeft:i,graphTop:a}=s.mouseDownPoint,n=e.clientX-n,e=e.clientY-t,0==n&&0==e||(s.mouseDownPoint.hasMoved=!0,s.$refs.grid.startX=r+n,s.$refs.grid.startY=o+e,s.$refs.grid.render(),s.graph.left=i+n,s.graph.top=a+e))}s.$refs.component&&(o=s.$el.getBoundingClientRect(),t=s.$refs.component.$el.getBoundingClientRect(),r=o.width+(e.clientX-t.x-t.width)/s.graph.scale,o=o.height+(e.clientY-t.y-t.height)/s.graph.scale,s.mouseDownPoint={hasMoved:!1,clientX:e.clientX,clientY:e.clientY,offsetX:r,offsetY:o,button:0===e.button?"left":"right",gridStartX:s.$refs.grid.startX,gridStartY:s.$refs.grid.startY,graphLeft:s.graph.left,graphTop:s.graph.top},document.addEventListener("mousemove",i),document.addEventListener("mouseup",function e(t){s.mouseDownPoint&&"right"===s.mouseDownPoint.button&&!s.mouseDownPoint.hasMoved&&s.contextMenu(s.mouseDownPoint),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",e),s.mouseDownPoint=null}))},contextMenu(e){this.$refs.component.contextMenu(e)},drop(r){const o=this,i=(o.$el.click(),[]);var e=(JSON.parse(JSON.stringify(Editor.UI.__protected__.DragArea.currentDragInfo))||{})["additional"];if(e&&e.forEach(e=>{e.type===o.clipAssetType&&((0,validation_1.isValidAnimationClipForGraph)(e.value)?i.push(e.value):console.warn(`${Editor.I18n.t("animation-graph.motion.invalidCipInfo")} {asset(${e.value})}`))}),i.length&&o.$refs.component){var e=o.$el.getBoundingClientRect(),a=o.$refs.component.$el.getBoundingClientRect(),n=e.width+(r.clientX-a.x-a.width)/o.graph.scale;let t=e.height+(r.clientY-a.y-a.height)/o.graph.scale-48;var s=i.length;for(let e=0;e<s;e++){var p=i[e];t+=32,o.$refs.component.drop(r,{offsetX:n,offsetY:t,uuid:p})}}},twinkle(e,t,r){this.$refs.component&&this.$refs.component.$attrs.type===e&&(this.$refs.component.$refs[t][0].twinkle=r)},getCenterXY(e,t=!0){let r=e.left-this.graph.centerX,o=e.top-this.graph.centerY;return t&&(r+=e.width/2,o+=e.height/2),{centerX:r,centerY:o}},getPosition(e,t=!0){let r=e.centerX+this.graph.centerX,o=e.centerY+this.graph.centerY;return t&&(r-=e.width/2,o-=e.height/2),{top:o,left:r}},calcComponentRect(){var e=this.$refs.component.nodes,t=[],r=[],o={},i={};for(const m in e){var a=e[m];0!==a.width&&0!==a.height&&(t.push(a.left),r.push(a.top),(void 0===o[a.left]||o[a.left]<a.width)&&(o[a.left]=a.width),void 0===i[a.top]||i[a.top]<a.height)&&(i[a.top]=a.height)}var n=Math.min(...t),s=Math.max(...t),p=Math.min(...r),h=Math.max(...r),l=Math.abs(s-n)+o[s],c=Math.abs(h-p)+i[h],g=s+o[s],d=h+i[h];return{minX:n,maxX:s,minY:p,maxY:h,centerX:(n+g)/2,centerY:(p+d)/2,left:n,right:g,top:p,bottom:d,width:l,height:c}}},exports.mounted=mounted,exports.destroyed=destroyed;