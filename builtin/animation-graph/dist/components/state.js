"use strict";function data(){return{addingLine:!1,nodes:{},lines:{},lineHeight:16,minStateWidth:35,minStateHeight:21,mouseDownPoint:null}}function mounted(){this.refresh()}Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.watch=exports.data=exports.props=exports.components=exports.template=void 0,exports.template=`
<section
    :adding-line="addingLine"
>
    <state-node
        v-for="(dump,id) in nodes" 
        :key="id"
        :ref="id"
        :type="dump.type"
        :active="dump.index===$root.queryData.view.stateIndex"
        :dump="dump"
    ></state-node>
    <state-line
        v-for="(dump,id) in lines" 
        :key="id"
        :ref="id"
        :dump="dump"
        :active="dump.indexes.includes($root.queryData.view.transitionIndex)"
    ></state-line>
    <div class="line shadow" ref="shadowLine"
        v-show="addingLine"
    >
        <ui-icon class="triangle" value="arrow-triangle-sharp" ref="triangle"></ui-icon>
    </div>
</section>
`,exports.components={"state-node":require("./state-node"),"state-line":require("./state-line")},exports.props=["graph"],exports.data=data,exports.watch={graph(){this.refresh()}},exports.methods={refresh(){var t=this;if(t.nodes={},t.graph&&t.graph.states)for(const e of t.graph.states)this.mergeNode(e);if(t.lines={},t.graph&&t.graph.transitions)for(const a of t.graph.transitions)this.mergeLine(a)},resize(){var t=this;for(const e in t.$refs)Array.isArray(t.$refs[e])&&t.$refs[e].forEach(t=>{t.resize&&t.resize()})},select(e){const a=this;a.$children.forEach(t=>{t.dump.id===e.id&&a.$root.select(e)})},mergeNode(t){var e=this,a=e.$parent.graph,o=e.$root.generateStateId(t.editorData.id);e.$set(e.nodes,o,Object.assign({id:o,top:a.centerY,left:a.centerX},t))},mergeLine(t){var e=this,a=e.graph.states[t.from.index],o=e.graph.states[t.to.index],a=e.$root.generateStateId(a.editorData.id),o=e.$root.generateStateId(o.editorData.id),i=a+"_to_"+o,n=o+"_to_"+a;e.lines[i]?(e.lines[i].siblings.push(t.index),e.lines[i].indexes.push(t.index)):e.$set(e.lines,i,Object.assign({id:i,reverseId:n,fromStateId:a,toStateId:o,siblings:[],indexes:[t.index]},t))},addLine(t,e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addTransition",args:[t,e]})},addShadowLine(t){const n=this;n.addingLine=!0;t=n.$refs[t][0];const r=t.dump.index;var e=t.getCenter();function s(t){var e,a,o;n.addingLine&&(t.stopPropagation(),t.preventDefault(),{clientX:t,clientY:a}=t,e=(o=n.mouseDownPoint.$el.getBoundingClientRect()).x+o.width/2,o=o.y+o.height/2,e=(t-e)/(t=n.$parent.graph.scale),a=(a-o)/t,o=Math.sqrt(e**2+a**2),t=Math.atan2(a,e)*(180/Math.PI),n.$refs.shadowLine.style.width=o+"px",n.$refs.shadowLine.style.transform=`rotate(${t}deg)`)}n.$refs.shadowLine.style.top=e.top-n.lineHeight/2+"px",n.$refs.shadowLine.style.left=e.left+"px",n.mouseDownPoint={$el:t.$el},n.$parent.$el.addEventListener("mousemove",s),n.$parent.$el.addEventListener("mouseup",function e(a){if(0===a.button){n.$parent.$el.removeEventListener("mousemove",s),n.$parent.$el.removeEventListener("mouseup",e),setTimeout(()=>{n.addingLine=!1}),n.mouseDownPoint=null,n.$refs.shadowLine.style.width=0;var o,{clientX:a,clientY:i}=a;let t=n.$el.getRootNode().elementFromPoint(a,i);for(;t;){if(t.classList.contains("state"))return t.__vue__&&t.__vue__.dump?(o=t.__vue__.dump.index,void n.addLine(r,o)):void 0;t=t.parentElement}}})},crumbState(t){this.addingLine||this.$root.crumbState(t)},contextMenu(e){const a=this,t=a.$root.queryData.envType;var o=a.$root.poseExprExperiment?[{type:"separator"},{label:Editor.I18n.t("animation-graph.state.addProceduralPoseState"),click(){a.$root.addState({type:t.PoseExprState,editorData:a.getCenterXY({width:70,height:30,left:e.offsetX,top:e.offsetY})})}}]:[],o=[{label:Editor.I18n.t("animation-graph.state.paste"),enabled:"state"===a.$root.queryData.pasteInfo.type,click(){var t=a.getCenterXY({width:1,height:1,left:e.offsetX,top:e.offsetY});a.$root.pasteState(!1,t)}},{label:Editor.I18n.t("animation-graph.state.pasteWithTransition"),enabled:"state"===a.$root.queryData.pasteInfo.type&&a.$root.queryData.pasteInfo.withTransitions,click(){var t=a.getCenterXY({width:1,height:1,left:e.offsetX,top:e.offsetY});a.$root.pasteState(!0,t)}},...o,{type:"separator"},{label:Editor.I18n.t("animation-graph.state.addAnim"),click(){a.$root.addState({type:t.MotionState,motion:{type:t.ClipMotion},editorData:a.getCenterXY({width:80,height:30,left:e.offsetX,top:e.offsetY})})}},{label:Editor.I18n.t("animation-graph.state.add1D"),click(){a.$root.addState({type:t.MotionState,motion:{type:t.AnimationBlend1D},editorData:a.getCenterXY({width:70,height:30,left:e.offsetX,top:e.offsetY})})}},{label:Editor.I18n.t("animation-graph.state.add2D"),click(){a.$root.addState({type:t.MotionState,motion:{type:t.AnimationBlend2D},editorData:a.getCenterXY({width:70,height:30,left:e.offsetX,top:e.offsetY})})}},{type:"separator"},{label:Editor.I18n.t("animation-graph.layer.addSubStateMachine"),click(){a.$root.addState({type:t.SubStateMachine,subStateMachine:{},editorData:a.getCenterXY({width:130,height:30,left:e.offsetX,top:e.offsetY})})}},...a.graph.allowEmptyStates?[{label:Editor.I18n.t("animation-graph.state.addEmpty"),click(){a.$root.addState({type:t.EmptyState,editorData:a.getCenterXY({width:80,height:30,left:e.offsetX,top:e.offsetY})})}}]:[],{type:"separator"},{label:"i18n:animation-graph.state.copyThisStateMachine",click(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"copyCurrentStateMachine",args:[]})}},{type:"separator"},{label:Editor.I18n.t("animation-graph.layer.bestViewport"),click(){a.$parent.bestViewport()}}];let i=-1;for(let t=a.$root.queryData.view.crumbs.length-1;0<=t;t--)if(a.$root.queryData.view.crumbs[t].type===a.$root.queryData.envType.SubStateMachine){i=t-1;break}0<=i&&o.push({type:"separator"},{label:Editor.I18n.t("animation-graph.crumbs.back"),click(){a.$root.crumbView(i)}}),Editor.Menu.popup({menu:o})},drop(t,e){var a=this.$root.queryData.envType;this.$root.addState({type:a.MotionState,motion:{type:a.ClipMotion,uuid:e.uuid},editorData:this.getCenterXY({width:50,height:30,left:e.offsetX,top:e.offsetY})})},getCenterXY(t){return this.$parent.getCenterXY(t)},getPosition(t){return this.$parent.getPosition(t)}},exports.mounted=mounted;