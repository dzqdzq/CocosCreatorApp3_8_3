"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=void 0;const Profile=require("@base/electron-profile");let hasOnProfileChange=!1;function load(){}function unload(){}exports.methods={async open(e){e&&await Editor.Message.request("scene","execute-scene-script",{name:"animation-graph",method:"edit",args:[e]}),await Editor.Panel.has("scene")&&!await Editor.Task.__protected__.hasSyncTask()?Editor.Panel.openBeside("scene","animation-graph"):Editor.Panel.open("animation-graph")},async dialogWarn(){return(await Editor.Dialog.warn(Editor.I18n.t("animation-graph.warningCaption"),{title:Editor.I18n.t("animation-graph.warning"),detail:Editor.I18n.t("animation-graph.warningDetail"),default:0,cancel:2,buttons:[Editor.I18n.t("animation-graph.save"),Editor.I18n.t("animation-graph.abort"),Editor.I18n.t("animation-graph.cancel")]})).response},async profileBindWatchWhenSceneReady(){if(!hasOnProfileChange){const i=Profile.load("global://packages/animation-graph.json"),t="animation-graph.pose-expr";const r={moduleCache:await Editor.Profile.getProject("engine","modules.cache")};Profile.on("change",async(e,a,n,o)=>{"global"!==e||"packages/animation-graph.json"!==a||n!==t||!0!==o||await exports.methods.profileCheckConfigIsLegal(null,i.get(t))||0===await exports.methods.profileDialogWarn(Editor.I18n.t("animation-graph.configEngineWarn"))&&(await exports.methods.profileEnsureEngineIsLegal(),Editor.Message.broadcast("project:engine-modules-changed")),"project"!==e||"packages/engine.json"!==a||"modules.cache"!==n||await exports.methods.profileCheckConfigIsLegal(r,i.get(t))||0===await exports.methods.profileDialogWarn(Editor.I18n.t("animation-graph.configPreferencesWarn"))&&(await exports.methods.profileEnsureEngineIsLegal(),i.set(t,!0),i.save(),Editor.Message.broadcast("preferences:packages-changed"))}),hasOnProfileChange=!0}},async profileCheckConfigIsLegal(a,e){var n=await Editor.Profile.getProject("engine","modules.cache");if(!n)return!0;if(a){let e=!1;if(a.moduleCache["procedural-animation"]._value!==n["procedural-animation"]._value&&(e=!0),!(e=a.moduleCache.marionette._value!==n.marionette._value?!0:e))return!0;a.moduleCache=n}return!(!a&&e&&!1===n["procedural-animation"]._value||e&&!1===n.marionette._value||!e&&!0===n["procedural-animation"]._value)},async profileEnsureEngineIsLegal(){var a=await Editor.Profile.getProject("engine","modules.cache"),n=await Editor.Profile.getProject("engine","modules.includeModules");if(a&&Array.isArray(n)){let e=!1;return n.includes("marionette")||(n.push("marionette"),e=!0),n.includes("procedural-animation")||(n.push("procedural-animation"),e=!0),a.marionette._value||(a.marionette._value=!0,e=!0),a["procedural-animation"]._value||(a["procedural-animation"]._value=!0,e=!0),e&&(await Editor.Profile.setProject("engine","modules.cache",a),await Editor.Profile.setProject("engine","modules.includeModules",n.sort()),Editor.Message.broadcast("engine:modules-changed"),Editor.Message.broadcast("project:engine-modules-changed")),!0}},async profileDialogWarn(e){return(await Editor.Dialog.warn(Editor.I18n.t("animation-graph.configInvalidTitle"),{title:Editor.I18n.t("animation-graph.warning"),detail:e,default:0,cancel:1,buttons:[Editor.I18n.t("animation-graph.ok"),Editor.I18n.t("animation-graph.cancel")]})).response}},exports.load=load,exports.unload=unload;