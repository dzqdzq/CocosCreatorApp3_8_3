"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var a=Object.getOwnPropertyDescriptor(t,i);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,a)}:function(e,t,i,n){e[n=void 0===n?i:n]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__decorate=this&&this.__decorate||function(e,t,i,n){var a,r=arguments.length,o=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,n);else for(var s=e.length-1;0<=s;s--)(a=e[s])&&(o=(r<3?a(o):3<r?a(t,i,o):a(t,i))||o);return 3<r&&o&&Object.defineProperty(t,i,o),o},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),scene_state_component_1=__importDefault(require("./scene-state-component")),animationApi=__importStar(require("cc/editor/new-gen-anim")),env_type_1=require("./env-type"),make_life_easier_utils_1=require("./make-life-easier-utils"),variable_value_dump_1=require("./variable-value-dump"),interop_formal_1=require("./pose-expr-graph/interop-formal"),assert_1=__importDefault(require("assert")),state_machine_env_1=require("./envs/state-machine-env"),motion_env_1=require("./envs/motion-env"),pose_graph_env_1=require("./envs/pose-graph-env"),binaryConditionOperatorI18n={EQUAL_TO:"=",NOT_EQUAL_TO:"≠",LESS_THAN:"<",LESS_THAN_OR_EQUAL_TO:"≤",GREATER_THAN:">",GREATER_THAN_OR_EQUAL_TO:"≥"},unaryConditionOperatorI18n={TRUTHY:"true",FALSY:"false"},Utils={editorDataCloneMethod(e){let t;return e instanceof animationApi.MotionState&&e.motion instanceof animationApi.ClipMotion&&(t=""),Object.assign(Object.assign({},this),{name:t,id:Utils.produceEditorDataId(),clone:Utils.editorDataCloneMethod})},produceEditorDataId(){return EditorExtends.UuidUtils.generate(!1)},checkEditorData(e){return e&&(void 0===e.name&&(e.name=""),e.id||(e.id=Utils.produceEditorDataId()),e.clone||(e.clone=Utils.editorDataCloneMethod)),e},getInitialEditorData(e={}){return Object.assign(Utils.checkEditorData({name:""}),e)},getStateType(e,t){switch(e){case t.entryState:return env_type_1.EnvType.entryState;case t.anyState:return env_type_1.EnvType.anyState;case t.exitState:return env_type_1.EnvType.exitState;default:if(e instanceof animationApi.MotionState)return env_type_1.EnvType.MotionState;if((0,interop_formal_1.isPoseExprState)(e))return env_type_1.EnvType.PoseExprState;if(e instanceof animationApi.EmptyState)return env_type_1.EnvType.EmptyState;if(e instanceof animationApi.SubStateMachine)return env_type_1.EnvType.SubStateMachine}return""},canNotAddMotionToState(e){return state_machine_env_1.cannotAddMotionStateType.includes(e)},canNotAddComponentToState(e){return state_machine_env_1.cannotAddComponentStateType.includes(e)},canNotRemoveState(e){return state_machine_env_1.cannotRemoveStateType.includes(e)},canNotCopyState(e){return state_machine_env_1.cannotRemoveStateType.includes(e)},getMotionType(e){let t="";return e instanceof animationApi.ClipMotion?t=env_type_1.EnvType.ClipMotion:e instanceof animationApi.AnimationBlend1D?t=env_type_1.EnvType.AnimationBlend1D:e instanceof animationApi.AnimationBlend2D&&(t=env_type_1.EnvType.AnimationBlend2D),t},getMotionValue(e){let t=null;return e instanceof animationApi.ClipMotion&&(t={uuid:e.clip?e.clip._uuid:""}),e instanceof animationApi.AnimationBlend1D&&(t={variable:e.param.variable,value:e.param.value}),t=e instanceof animationApi.AnimationBlend2D?[{variable:e.paramX.variable,value:e.paramX.value},{variable:e.paramY.variable,value:e.paramY.value}]:t},getMotionName(e,t){let i="";if(t){t=t[cc_1.editorExtrasTag];if(t&&t.name)return t.name}return e instanceof animationApi.ClipMotion?i=e.clip?e.clip.name:env_type_1.EnvType.clipMotionName:e instanceof animationApi.AnimationBlend1D?i=e.name||env_type_1.EnvType.animationBlend1DName:e instanceof animationApi.AnimationBlend2D&&(i=e.name||env_type_1.EnvType.animationBlend2DName),i},getDefaultMotionLevel(){return[0]},changeCrumb(e,t,i,n,a){var r=e[e.length-1];a||r.type===env_type_1.EnvType.layer?e.push({type:t,value:n,name:i}):(r.type=t,r.value=n,r.name=i)},getTransitionType(e){let t="";return t=e?animationApi.isAnimationTransition(e)?env_type_1.EnvType.AnimationTransition:e instanceof animationApi.EmptyStateTransition?env_type_1.EnvType.EmptyStateTransition:env_type_1.EnvType.Transition:""},getTransitionName(e){let t="";return t=e?e.from.name+" , "+e.to.name:""},hasSubStateMachineCrumb(e){for(const t of e)if(t.type===env_type_1.EnvType.SubStateMachine)return!0;return!1},getValidName(e,t){for(var i=Array.from(t.states()).filter(e=>e!==t.anyState&&e!==t.entryState&&e!==t.exitState).map(e=>e&&e.name||"");i.includes(e);)isFinite(Number(e))&&(e+="-"),/(\d+)$/.test(e)?e=e.replace(/(\d+)$/,(e,t)=>{var i=parseInt(t,10);return(i+=1).toString().padStart(t.length,"0")}):(e.endsWith("-")||(e+="-"),e+="001");return e}},DefaultValue={minThreshold:0,maxThreshold:1};class SceneAnimationGraph{get variables(){return this.animationGraph?Array.from(this.animationGraph.variables):[]}get stateMachine(){var e=this._getIfIsStateMachineEnv();return null==e?void 0:e.stateMachine}constructor(){this.assetUuid="",this.animationGraph=null,this.crumbs=[],this.layerIndex=-1,this.layer=null,this._currentEnv=void 0,this.dirtyData={origin:"",realtime:"",isDirty(){return this.origin!==this.realtime}},this.queryDataTemplate={assetInfo:null,isDirty:!1,pasteInfo:{type:"none"},envType:env_type_1.EnvType,view:{stateMachine:{allowEmptyStates:!1,states:[],transitions:[]},crumbs:[],layerIndex:-1,stateIndex:-1,transitionIndex:-1,motion:void 0,motionLevel:[],poseExpr:void 0},layers:[],variables:{},variableType:animationApi.VariableType,previewState:cce.Preview.motionPreview.PreviewState,conditionVariableType:[env_type_1.EnvType.conditionVariable,env_type_1.EnvType.conditionConstant],unaryConditionOperator:animationApi.UnaryCondition.Operator,binaryConditionOperator:animationApi.BinaryCondition.Operator,binaryConditionOperatorI18n:binaryConditionOperatorI18n,unaryConditionOperatorI18n:unaryConditionOperatorI18n,cannotAddMotionStateType:state_machine_env_1.cannotAddMotionStateType,cannotAddComponentStateType:state_machine_env_1.cannotAddComponentStateType,cannotRemoveStateType:state_machine_env_1.cannotRemoveStateType,motionType:motion_env_1.motionType,animationBlendType:motion_env_1.animationBlendType,AnimationBlend2DAlgorithm:animationApi.AnimationBlend2D.Algorithm,TCBindingValueType:animationApi.TCBindingValueType,tcBindingTypeInfos:getTCBindingTypeInfos()},this.clipBoard={type:"none"},this.userDefinedPreviewModelUuid={},this.resetData()}async init(e){if(e)try{var t;await this.resetData(),this.assetUuid=e,this.queryData.assetInfo=await Editor.Message.request("asset-db","query-asset-info",e),this.queryData.assetInfo&&(t=await loadAssetUncached(e),this.ensureEditorData(t),this.animationGraph=t,this.crumbLayer(0))}catch(e){console.error(e)}}ensureEditorData(e){for(const i of animationApi.visitAnimationGraphEditorExtras(e))"object"==typeof(t=i)&&t&&"conditions"in t||(i[cc_1.editorExtrasTag]?Utils.checkEditorData(i[cc_1.editorExtrasTag]):i[cc_1.editorExtrasTag]=Utils.getInitialEditorData());var t}async dialog(){return Editor.Message.request("animation-graph","dialog-warn")}async edit(e){if(this.dirtyData.isDirty()){var t=await this.dialog();if(0===t)await this.apply();else if(2===t)return}await this.init(e)}async reset(){if(this.assetUuid)if(await Editor.Message.request("asset-db","query-asset-info",this.assetUuid))await this.init(this.assetUuid);else{let e=Editor.I18n.t("animation-graph.resetError");e=e.replace("${uuid}",this.assetUuid),console.error(e)}else await this.resetData(),this.refresh()}async resetData(){this.assetUuid="",this.animationGraph=null,this.layer=null,this._currentEnv=void 0,this.clipBoard={type:"none"};var e=await Editor.Profile.getTemp("animation-graph","preview-model");e&&(this.userDefinedPreviewModelUuid=e),this.queryData=JSON.parse(JSON.stringify(this.queryDataTemplate)),this.dirtyData.origin=this.dirtyData.realtime="",this.resetViewData(),this.unselect()}query(){return this.queryLayers(),this.queryVariables(),this.queryView(),this.queryData}async apply(){var e,t,i;this.animationGraph&&(e=cce.Utils.serialize(this.animationGraph),this.queryData.assetInfo)&&({uuid:i,url:t}=this.queryData.assetInfo,(i=await Editor.Message.request("asset-db","query-asset-info",i))?await cce.Ipc.send("save-asset",i.uuid,e):(i=await Editor.Message.request("asset-db","create-asset",t,e))&&(this.assetUuid=i.uuid,this.queryData.assetInfo=i),this.dirtyData.origin="",this.refresh())}refresh(){switch(this.dirtyData.realtime=cce.Utils.serialize(this.animationGraph),this.dirtyData.origin||(this.dirtyData.origin=this.dirtyData.realtime),this.queryData.isDirty=this.dirtyData.isDirty(),this.clipBoard.type){default:this.queryData.pasteInfo={type:"none"};break;case"pose-nodes":this.queryData.pasteInfo={type:"pose-nodes"};break;case"state":this.queryData.pasteInfo={type:"state",withTransitions:this._currentEnv instanceof state_machine_env_1.StateMachineEnv&&this.clipBoard.stateMachine===this._currentEnv.stateMachine};break;case"state-machine":this.queryData.pasteInfo={type:"state-machine"}}Editor.Message.broadcast("animation-graph:changed")}unselect(){Editor.Selection.clear("animation-graph")}reselect(){Editor.Selection.clear("animation-graph"),Editor.Selection.select("animation-graph",this.assetUuid)}queryView(){this.queryData.view.crumbs=this.crumbs,this.queryData.view.layerIndex=this.layerIndex,this.queryData.view.stateMachine=void 0,this.queryData.view.stateIndex=-1,this.queryData.view.transitionIndex=-1,this._currentEnv instanceof state_machine_env_1.StateMachineEnv&&(this.queryData.view.stateMachine=this.queryStateMachine(this._currentEnv.stateMachine),this.queryData.view.stateIndex=this._currentEnv.stateIndex,this.queryData.view.transitionIndex=this._currentEnv.transitionIndex),this.queryData.view.motion=void 0,this.queryData.view.motionLevel=[],this._currentEnv instanceof motion_env_1.MotionEnv&&(this.queryData.view.motion=this.queryMotion(Utils.getDefaultMotionLevel(),this._currentEnv.motion),this.queryData.view.motionLevel=this._currentEnv.motionLevel),this._currentEnv&&this._currentEnv instanceof motion_env_1.MotionEnv&&(this.queryData.view.motion=this.queryMotion(Utils.getDefaultMotionLevel(),this._currentEnv.motion,void 0,!0)),this.queryData.view.poseExpr=void 0,this.queryData.view.poseExprNodeId=void 0,this._currentEnv instanceof pose_graph_env_1.PoseGraphEnv&&(this.queryData.view.poseExpr=this._currentEnv.poseGraphInterop.query(),this.queryData.view.poseExprNodeId=this._currentEnv.poseExprNodeId)}changeView(e,t,i){switch(e){case env_type_1.EnvType.layer:this.crumbLayer(t);break;case env_type_1.EnvType.entryState:case env_type_1.EnvType.anyState:case env_type_1.EnvType.exitState:case env_type_1.EnvType.MotionState:case env_type_1.EnvType.SubStateMachine:case env_type_1.EnvType.EmptyState:case env_type_1.EnvType.PoseExprState:this.viewState(t);break;case env_type_1.EnvType.Transition:case env_type_1.EnvType.AnimationTransition:case env_type_1.EnvType.EmptyStateTransition:this.viewTransition(t);break;case env_type_1.EnvType.ClipMotion:case env_type_1.EnvType.AnimationBlend1D:case env_type_1.EnvType.AnimationBlend2D:this.viewMotion(i);break;case env_type_1.EnvType.PoseExprNode:this.viewPoseNode(t);break;default:this.crumbView()}}crumbView(i){if(this.animationGraph){let e,t;if(void 0!==i)this.crumbs.splice(i+1),e=this.crumbs.length-1,t=this.crumbs[e];else{e=this.crumbs.length-1,t=this.crumbs[e];for(var n=[env_type_1.EnvType.layer,env_type_1.EnvType.SubStateMachine,env_type_1.EnvType.MotionState,env_type_1.EnvType.PoseExprState,env_type_1.EnvType.StateMachine,env_type_1.EnvType.LayerStash];t&&!n.includes(t.type);)e--,t=this.crumbs[e],this.crumbs.pop()}if(t.type!==env_type_1.EnvType.SubStateMachine&&t.type!==env_type_1.EnvType.StateMachine&&t.type!==env_type_1.EnvType.PoseExprState&&t.type!==env_type_1.EnvType.MotionState&&t.type!==env_type_1.EnvType.LayerStash&&t.type!==env_type_1.EnvType.PoseExprNode||Utils.changeCrumb(this.crumbs,"","",null,!0),this.resetViewData(),this.layer){this._currentEnv=new state_machine_env_1.StateMachineEnv(this.layer.stateMachine);for(let e=1;e<this.crumbs.length;e++){var a,r,o,s=this.crumbs[e];if(s.type===env_type_1.EnvType.SubStateMachine&&((0,assert_1.default)(this._currentEnv instanceof state_machine_env_1.StateMachineEnv),r=this._currentEnv,a=Array.from(r.stateMachine.states()),r.stateIndex=s.value,r.state=a[r.stateIndex],r.state instanceof animationApi.SubStateMachine)&&(r.stateMachine=r.state.stateMachine),s.type===env_type_1.EnvType.state&&((0,assert_1.default)(this._currentEnv instanceof state_machine_env_1.StateMachineEnv),a=this._currentEnv,r=Array.from(a.stateMachine.states()),a.stateIndex=s.value,a.state=r[a.stateIndex]),s.type===env_type_1.EnvType.transition&&((0,assert_1.default)(this._currentEnv instanceof state_machine_env_1.StateMachineEnv),p=this._currentEnv,h=Array.from(p.stateMachine.transitions()),p.transitionIndex=s.value,p.transition=h[p.transitionIndex]),s.type===env_type_1.EnvType.MotionState){var h=this._currentEnv;if(h instanceof state_machine_env_1.StateMachineEnv){if(h.stateIndex=-1,h.transitionIndex=-1,h.state instanceof animationApi.MotionState){var p=h.state.motion;if(!p)return;this._currentEnv=new motion_env_1.MotionEnv(p,Utils.getDefaultMotionLevel()),t.name=Utils.getMotionName(p,h.state),p&&isAnimationBlend(p)&&(p.name=h.state.name)}}else{if((0,assert_1.default)(h instanceof motion_env_1.MotionEnv),h.motion instanceof animationApi.AnimationBlend1D){var l=Array.from(h.motion.items);if(l.length){(0,assert_1.default)("number"==typeof s.value);l=l[s.value].motion;if(!l)return;this._currentEnv=new motion_env_1.MotionEnv(l,h.motionLevel)}}if(h.motion instanceof animationApi.AnimationBlend2D){l=Array.from(h.motion.items);if(l.length){(0,assert_1.default)("number"==typeof s.value);var c=l[s.value].motion;if(!c)return;this._currentEnv=new motion_env_1.MotionEnv(c,h.motionLevel)}}}}s.type===env_type_1.EnvType.PoseExprState&&((0,assert_1.default)(this._currentEnv instanceof state_machine_env_1.StateMachineEnv),c=this._currentEnv,o=Array.from(c.stateMachine.states())[s.value])&&(0,interop_formal_1.isPoseExprState)(o)&&this.editPoseGraph(o),s.type===env_type_1.EnvType.PoseExprNode&&this._enterPoseNode(s.value,!1),s.type===env_type_1.EnvType.LayerStash&&this._enterLayerStash(s.value.layerIndex,s.value.stashId),s.type===env_type_1.EnvType.StateMachine&&this._enterPoseNode(s.value,!1)}}this.reselect(),this.refresh()}}resetViewData(){this._currentEnv=void 0}queryLayers(){this.animationGraph&&(this.queryData.layers=this.animationGraph.layers.map((i,e)=>{return{index:e,name:i.name||env_type_1.EnvType.layer,props:{mask:{uuid:null==(e=i.mask)?void 0:e._uuid},weight:void 0===i.weight?1:i.weight,additive:i.additive},stashes:[...i.stashes()].reduce((e,[t])=>(e[t]={referenceCount:[...animationApi.visitStashReferences(i,t)].length},e),{})}}))}addLayer(e){var t;this.animationGraph&&(t=this.animationGraph.addLayer(),e&&(t.name=e),this.ensureEditorData(this.animationGraph),Metric("A100008"),this.crumbLayer(this.animationGraph.layers.length-1))}removeLayer(e){!this.animationGraph||e<0||(this.animationGraph.removeLayer(e),e===this.layerIndex?this.crumbLayer(0===e?0:e-1):this.refresh())}crumbLayer(e){this.animationGraph&&(this.resetViewData(),this.layerIndex=e,this.layer=this.animationGraph.layers[this.layerIndex],this.layer)&&(this._currentEnv=new state_machine_env_1.StateMachineEnv(this.layer.stateMachine),this.crumbs=[{type:env_type_1.EnvType.layer,name:this.layer.name,value:e}],this.reselect(),this.refresh())}renameLayer(e,t){var i;this.animationGraph&&(i=this.animationGraph.layers[e])&&(i.name=t,(i=this.crumbs[0])&&i.value===e&&(i.name=t),this.refresh())}async changeLayer(e,t,i){var n;this.animationGraph&&(e=this.animationGraph.layers[e])&&("mask"===t?i?(n=await loadAssetUncached(i),e.mask=n):e.mask=null:"weight"===t?e.weight=i:"additive"===t&&(e.additive=i),this.reselect(),this.refresh())}moveLayer(e,t){this.animationGraph&&this.animationGraph.layers[e]&&(this.animationGraph.moveLayer(e,t),this.reselect(),this.refresh())}queryStateMachine(l,c=Utils.hasSubStateMachineCrumb(this.crumbs)){const o=Array.from(l.states()),m=Array.from(l.transitions());var e=o.map((e,t)=>{var i,n=e.name,a=Utils.getStateType(e,l),r=Array.from(l.getOutgoings(e)).map(t=>m.findIndex(e=>e===t)),o=Array.from(l.getIncomings(e)).map(t=>m.findIndex(e=>e===t)),s=(e[cc_1.editorExtrasTag]?Utils.checkEditorData(e[cc_1.editorExtrasTag]):e[cc_1.editorExtrasTag]=Utils.getInitialEditorData(),e[cc_1.editorExtrasTag]),h=void 0===s.centerX,p={index:t,name:n,type:a,outGoings:r,inComings:o,editorData:s};switch(a){case env_type_1.EnvType.entryState:h&&(p.editorData.centerX=-125,p.editorData.centerY=0);break;case env_type_1.EnvType.exitState:h&&(p.editorData.centerX=125,p.editorData.centerY=0);break;case env_type_1.EnvType.anyState:h&&(p.editorData.centerX=c?0:125,p.editorData.centerY=c?75:0);break;default:h&&(p.editorData.centerX=0,p.editorData.centerY=0),(e instanceof animationApi.MotionState||(0,interop_formal_1.isPoseExprState)(e))&&(p.eventBindings={transitionInEventBinding:e.transitionInEventBinding.methodName,transitionOutEventBinding:e.transitionOutEventBinding.methodName}),e instanceof animationApi.MotionState?p.props={speed:e.speed,speedMultiplier:e.speedMultiplier,speedMultiplierEnabled:e.speedMultiplierEnabled,motion:{type:Utils.getMotionType(e.motion),name:Utils.getMotionName(e.motion,e),level:Utils.getDefaultMotionLevel(),value:Utils.getMotionValue(e.motion),min:[],max:[]}}:e instanceof animationApi.SubStateMachine&&(p.stateMachine=this.queryStateMachine(e.stateMachine,!0)),(e instanceof animationApi.MotionState||e instanceof animationApi.SubStateMachine)&&(i=this.getComponents(e),p.components=i.map((e,t)=>({name:e.constructor.name,index:t,value:scene_state_component_1.default.encode(e)})))}return p}),t=m.map((t,e)=>{var i=[];for(const r of t.conditions)r instanceof animationApi.BinaryCondition&&i.push({type:env_type_1.EnvType.BinaryCondition,operator:r.operator,lhs:0,lhsBinding:dumpTCBinding(r.lhsBinding),rhs:r.rhs,isRhsInteger:r.lhsBinding.getValueType()===animationApi.TCBindingValueType.INTEGER}),r instanceof animationApi.UnaryCondition&&i.push({type:env_type_1.EnvType.UnaryCondition,operator:r.operator,operand:r.operand.variable}),r instanceof animationApi.TriggerCondition&&i.push({type:env_type_1.EnvType.TriggerCondition,trigger:r.trigger});var n=o.findIndex(e=>e===t.from),a=o.findIndex(e=>e===t.to),e={type:Utils.getTransitionType(t),index:e,priority:Array.from(l.getOutgoings(t.from)).findIndex(e=>e===t),from:{index:n,name:t.from.name,type:Utils.getStateType(t.from,l)},to:{index:a,name:t.to.name,type:Utils.getStateType(t.to,l)},removable:!0,duration:-1,relativeDuration:!1,exitConditionEnabled:void 0,exitCondition:0,destinationStart:void 0,relativeDestinationStart:!1,editorData:t[cc_1.editorExtrasTag]||{},conditions:i,eventBindings:void 0};return(animationApi.isAnimationTransition(t)||t instanceof animationApi.EmptyStateTransition||t instanceof animationApi.ProceduralPoseTransition)&&(e.destinationStart=t.destinationStart,e.relativeDestinationStart=t.relativeDestinationStart,e.eventBindings={startEventBinding:t.startEventBinding.methodName,endEventBinding:t.endEventBinding.methodName}),animationApi.isAnimationTransition(t)?(e.duration=t.duration,e.relativeDuration=t.relativeDuration,e.exitConditionEnabled=t.exitConditionEnabled,e.exitCondition=t.exitCondition):(t instanceof animationApi.EmptyStateTransition||t instanceof animationApi.ProceduralPoseTransition)&&(e.duration=t.duration),e}).sort((e,t)=>e.priority-t.priority);return{allowEmptyStates:l.allowEmptyStates,states:e,transitions:t,editorData:l[cc_1.editorExtrasTag]}}crumbStateMachine(e){var t=this._getIfIsStateMachineEnv();t&&(this.resetViewData(),(t=t.getState(e))&&t instanceof animationApi.SubStateMachine&&(this._currentEnv=new state_machine_env_1.StateMachineEnv(t.stateMachine)),Utils.changeCrumb(this.crumbs,env_type_1.EnvType.SubStateMachine,t.name,e),Utils.changeCrumb(this.crumbs,"","",null,!0),this.reselect(),this.refresh())}async addState(t){if(this.animationGraph){var i=this._getIfIsStateMachineEnv();if(i){t=t||{type:env_type_1.EnvType.MotionState,editorData:{centerX:0,centerY:0}};var n=i.getStates().length;let e;switch(t.type){case env_type_1.EnvType.SubStateMachine:(e=i.stateMachine.addSubStateMachine()).name=env_type_1.EnvType.subStateMachineName;break;case env_type_1.EnvType.EmptyState:(e=i.stateMachine.addEmpty()).name=env_type_1.EnvType.EmptyStateName;break;case env_type_1.EnvType.PoseExprState:(e=(0,interop_formal_1.addPoseExprState)(i.stateMachine,{poseGraphEditorData:{id:Utils.produceEditorDataId()},rootOutputNodeEditorData:{centerX:-51,centerY:-13.5}})).name="Pose";break;default:(e=await i.stateMachine.addMotion()).name=env_type_1.EnvType.stateName}var a=Utils.getInitialEditorData(t.editorData);if(e[cc_1.editorExtrasTag]=Object.assign(a,e[cc_1.editorExtrasTag]),t.type===env_type_1.EnvType.MotionState&&t.motion){switch(t.motion.type){case env_type_1.EnvType.AnimationBlend1D:case env_type_1.EnvType.AnimationBlend2D:t.motion.editorData={centerX:0,centerY:0}}this.addMotionToState(n,t.motion)}else this.ensureEditorData(this.animationGraph),this.viewState(n)}}}removeState(e){var t=this._getIfIsStateMachineEnv();t&&(e=t.getState(e))&&(t.stateMachine.remove(e),this.crumbView())}crumbState(e){var t=this._getIfIsStateMachineEnv();t&&((t=t.getState(e))instanceof animationApi.SubStateMachine?this.crumbStateMachine(e):t instanceof animationApi.MotionState?t.motion&&isAnimationBlend(t.motion)&&this.crumbMotion(e):(0,interop_formal_1.isPoseExprState)(t)&&this.crumbPoseExpr(e))}viewState(e){var t=this._getIfIsStateMachineEnv();t&&(t.stateIndex=e,t.state=t.getState(e),Utils.changeCrumb(this.crumbs,env_type_1.EnvType.state,t.state.name,e),t.transition=null,t.transitionIndex=-1,this.reselect(),this.refresh())}moveState(e,t){var i=this._getIfIsStateMachineEnv();i&&(i=i.getState(e))&&(t.editorData&&(i[cc_1.editorExtrasTag]=Object.assign(i[cc_1.editorExtrasTag]||{},t.editorData)),this.refresh())}renameState(e,t){var i=this._getIfIsStateMachineEnv();i&&(i=i.getState(e))&&(i.name=t,i[cc_1.editorExtrasTag].name=t,Metric("A100012"),this.refresh())}changeState(e,t,i){var n=this._getIfIsStateMachineEnv();if(n){var a=n.getState(e);if(a){switch(t){case"transitionInEventBinding":case"transitionOutEventBinding":return void((a instanceof animationApi.MotionState||(0,interop_formal_1.isPoseExprState)(a))&&(a[t].methodName=i,this.refresh()))}if(a[t]instanceof animationApi.BindableNumber)a[t].value=i;else if(a instanceof animationApi.MotionState)switch(t){case"speed":a.speed=Number(i);break;case"speedMultiplier":a.speedMultiplier=i.toString();break;case"speedMultiplierEnabled":a.speedMultiplierEnabled=!!i}else a[t]=i;this.refresh()}}}copyState(e){var t,i=this._getIfIsStateMachineEnv();i&&(e=i.getState(e))&&(t=Utils.getStateType(e,i.stateMachine),Utils.canNotCopyState(t)||(this.clipBoard={type:"state",state:e,stateMachine:i.stateMachine},this.refresh()))}duplicateState(t){var i=this._getIfIsStateMachineEnv();if(i){t=i.getState(t);if(t){var n=Utils.getStateType(t,i.stateMachine);if(!Utils.canNotCopyState(n)&&(t instanceof animationApi.MotionState||t instanceof animationApi.SubStateMachine||t instanceof animationApi.EmptyState||(0,interop_formal_1.isPoseExprState)(t))){var n=i.getStates().length,a=animationApi.cloneState(i.stateMachine,t,!0);let e=t.name;a instanceof animationApi.MotionState&&a.motion instanceof animationApi.ClipMotion&&(e=Utils.getValidName(a.name,i.stateMachine)),a&&(a.name=e,(t=a[cc_1.editorExtrasTag]).centerX+=20,t.centerY+=20),this.viewState(n)}}}}pasteState(i,n){if(this.animationGraph){var a=this._getIfIsStateMachineEnv();if(a&&"state"===this.clipBoard.type){var r=this.clipBoard.stateMachine,o=this.clipBoard.state;if(o&&(o instanceof animationApi.MotionState||o instanceof animationApi.SubStateMachine||o instanceof animationApi.EmptyState||(0,interop_formal_1.isPoseExprState)(o))){let e;var s,h=a.getStates().length;let t=o.name;o instanceof animationApi.MotionState&&o.motion instanceof animationApi.ClipMotion&&(t=Utils.getValidName(o.name,a.stateMachine)),r===a.stateMachine?(n||(n={centerX:(s=o[cc_1.editorExtrasTag]).centerX+20,centerY:s.centerY+20}),e=animationApi.cloneState(r,o,i)):r&&(n=n||{centerX:0,centerY:0},e=animationApi.cloneState(r,o,a.stateMachine)),e&&(e.name=t,Object.assign(null!=(s=e[cc_1.editorExtrasTag])?s:e[cc_1.editorExtrasTag]={},n)),this.ensureEditorData(this.animationGraph),this.viewState(h)}}}}turnMotionStateIntoSubStateMachine(e){var t=this._getIfIsStateMachineEnv();t&&(e=t.getState(e))&&e instanceof animationApi.MotionState&&(animationApi.turnMotionStateIntoSubStateMachine(t.stateMachine,e),this.refresh())}async addMotion(e){let t=null,i;switch(e.type){case env_type_1.EnvType.ClipMotion:var n;t=new animationApi.ClipMotion,e.uuid&&(n=await loadAssetUncached(e.uuid),t instanceof animationApi.ClipMotion)&&(t.clip=n),t[cc_1.editorExtrasTag]=Object.assign(Utils.getInitialEditorData(),e.editorData),Metric("A100002");break;case env_type_1.EnvType.AnimationBlend1D:t=new animationApi.AnimationBlend1D,(i=this.getFirstNumberVariable())&&(t.param.variable=i[0]),t[cc_1.editorExtrasTag]=Object.assign(Utils.getInitialEditorData({autoThreshold:!0}),e.editorData),Metric("A100003");break;case env_type_1.EnvType.AnimationBlend2D:t=new animationApi.AnimationBlend2D,(i=this.getFirstNumberVariable())&&(t.paramX.variable=i[0],t.paramY.variable=i[0]),t[cc_1.editorExtrasTag]=Object.assign(Utils.getInitialEditorData(),e.editorData),Metric("A100004")}return t}async addMotionToState(t,i){if(this.animationGraph){var n=this._getIfIsStateMachineEnv();if(n){var a=n.getState(t);if(a&&a instanceof animationApi.MotionState){let e=env_type_1.EnvType.stateName;var r=await this.addMotion(i);switch(a.motion=r,i.type){case env_type_1.EnvType.ClipMotion:e=env_type_1.EnvType.clipMotionName,r&&(e=Utils.getMotionName(r,a)),e=Utils.getValidName(e,n.stateMachine);break;case env_type_1.EnvType.AnimationBlend1D:e=env_type_1.EnvType.animationBlend1DName;break;case env_type_1.EnvType.AnimationBlend2D:e=env_type_1.EnvType.animationBlend2DName}a.name=e,this.ensureEditorData(this.animationGraph),this.viewState(t)}}}}async changeClipMotion(e,t){var i=this._getIfIsStateMachineEnv();i&&(i=i.getState(e))&&(t?(e=await loadAssetUncached(t),i instanceof animationApi.MotionState&&i.motion instanceof animationApi.ClipMotion&&(i.motion.clip=e)):i instanceof animationApi.MotionState&&i.motion instanceof animationApi.ClipMotion&&(i.motion.clip=null),this.reselect(),this.refresh())}crumbMotion(t){var i=this._currentEnv;if(i&&(i instanceof state_machine_env_1.StateMachineEnv||i instanceof motion_env_1.MotionEnv)){let e=null;if(i instanceof state_machine_env_1.StateMachineEnv){var n=i.getState(t);if(!(n&&n instanceof animationApi.MotionState))return;if(!n.motion||n.motion instanceof animationApi.ClipMotion)return;(e=n.motion)&&isAnimationBlend(e)&&(e.name=n.name)}else isAnimationBlend(i.motion)&&(n=[...i.motion.items]).length&&(i=n[t].motion)&&(e=i);e&&(n=Utils.getDefaultMotionLevel(),this._currentEnv=new motion_env_1.MotionEnv(e,n),Utils.changeCrumb(this.crumbs,env_type_1.EnvType.MotionState,Utils.getMotionName(e,null),n,!0),this.reselect(),this.refresh())}}crumbMotionInMotion(i){var e=this._currentEnv;if(e&&e instanceof motion_env_1.MotionEnv){let t=e.motion;for(let e=1;e<i.length;e++){var n,a=i[e];if(!(t=isAnimationBlend(t)&&(n=[...t.items])[a]?n[a].motion:t))break;Utils.changeCrumb(this.crumbs,env_type_1.EnvType.MotionState,Utils.getMotionName(t,null),a,!0)}e.motion!==t&&(this._currentEnv=new motion_env_1.MotionEnv(t,e.motionLevel),this.reselect(),this.refresh())}}getMotionByLevel(i){var e=this._currentEnv;if(e&&e instanceof motion_env_1.MotionEnv){let t=e.motion;for(let e=1;e<i.length;e++){var n=i[e];if(t&&isAnimationBlend(t)){var a=[...t.items];if(a[n]){a=a[n].motion;if(!a)return;t=a}}}return t}}getFirstNumberVariable(){return this.animationGraph?(this.variables.find(e=>0===e[1]._type)||this.animationGraph.addVariable(this.uniqueVariableName("Float Number"),animationApi.VariableType.FLOAT,0),this.variables.find(e=>0===e[1]._type)):null}removeMotion(e){var t=this._getIfIsStateMachineEnv();t&&(t=t.getState(e))&&(t instanceof animationApi.MotionState&&(t.motion=null),this.reselect(),this.refresh())}getCurrentMotion(){var e=this._currentEnv;if(e&&(e instanceof state_machine_env_1.StateMachineEnv||e instanceof motion_env_1.MotionEnv))return e instanceof motion_env_1.MotionEnv?e.motionLevel.length?this.getMotionByLevel(e.motionLevel):void 0:e.state instanceof animationApi.MotionState?e.state.motion:null}viewMotion(e){var t,i,n=this._currentEnv;n&&n instanceof motion_env_1.MotionEnv&&(t=this.getMotionByLevel(e))&&(i=Utils.getMotionType(t))&&(n.motionLevel.length=0,n.motionLevel.push(...e),Utils.changeCrumb(this.crumbs,i,Utils.getMotionName(t,null),e),this.reselect(),this.refresh())}moveMotion(e,t){e=this.getMotionByLevel(e);e&&t.editorData&&(e[cc_1.editorExtrasTag]=Object.assign(e[cc_1.editorExtrasTag]||{},t.editorData)),this.refresh()}queryMotion(t,e,i,n){var a={type:Utils.getMotionType(e),name:Utils.getMotionName(e,null),level:t,value:Utils.getMotionValue(e),threshold:i,min:[],max:[]};if(i instanceof cc_1.Vec2&&(a.threshold={x:i.x,y:i.y}),e[cc_1.editorExtrasTag]?Utils.checkEditorData(e[cc_1.editorExtrasTag]):e[cc_1.editorExtrasTag]=Utils.getInitialEditorData({centerX:0,centerY:0}),e instanceof animationApi.ClipMotion&&(a.editorData=e[cc_1.editorExtrasTag]),e instanceof animationApi.AnimationBlend1D){a.editorData=e[cc_1.editorExtrasTag];var r=Array.from(e.items);if(Array.isArray(r)){a.children=[];var o=[];for(let e=0;e<r.length;e++){var s,h=r[e];h&&h.motion&&((s=t.slice()).push(e),o.push(h.threshold),s=this.queryMotion(s,h.motion,h.threshold),a.children.push(s))}o.length&&(a.min[0]=Math.min(...o),a.max[0]=Math.max(...o))}}if(e instanceof animationApi.AnimationBlend2D){a.props={algorithm:e.algorithm},a.editorData=e[cc_1.editorExtrasTag];var p=Array.from(e.items);if(Array.isArray(p)){a.children=[];var l=[],c=[];for(let e=0;e<p.length;e++){var m,_=p[e];_&&_.motion&&((m=t.slice()).push(e),l.push(_.threshold.x),c.push(_.threshold.y),m=this.queryMotion(m,_.motion,_.threshold),a.children.push(m))}l.length&&(a.min=[Math.min(...l),Math.min(...c)],a.max=[Math.max(...l),Math.max(...c)])}}if(n&&e&&isAnimationBlend(e)&&this.animationGraph){var d,u,v,i=getInvolvedBlendParamVariablesOfMotion(e);a.involvedBlendParamVariables={};for([d,{min:u,max:v}]of Object.entries(i)){let e=0,t=!1;var y=this.animationGraph.getVariable(d);(null==y?void 0:y.type)===animationApi.VariableType.FLOAT&&(e=y.value,t=!0),a.involvedBlendParamVariables[d]={value:e,valid:t,min:u,max:v}}}return a}async addMotionToMotion(e,t){if(this.animationGraph){var i=this.getMotionByLevel(e);if(i){t=await this.addMotion(t);if(i instanceof animationApi.AnimationBlend1D){var n=new animationApi.AnimationBlend1D.Item,a=(n.motion=t,Array.from(i.items)),r=a.length;if(0===r)n.threshold=DefaultValue.minThreshold;else if(1===r)n.threshold=DefaultValue.maxThreshold;else{var o=i[cc_1.editorExtrasTag];const h=[],p=(a.forEach(e=>{h.push(e.threshold)}),Math.min(...h));var s=Math.max(...h);const l=(s-p)/r;o&&!0===o.autoThreshold&&a.forEach((e,t)=>{e.threshold=p+l*t}),n.threshold=s}r=Array.from(i.items);r.push(n),i.items=r,e.push(r.length-1)}else i instanceof animationApi.AnimationBlend2D&&(o=Array.from(i.items),(a=new animationApi.AnimationBlend2D.Item).motion=t,a.threshold=new cc_1.Vec2(0,0),o.push(a),i.items=o,e.push(o.length-1));this.ensureEditorData(this.animationGraph),this.viewMotion(e)}}}renameMotionInMotion(e,t){e=this.getMotionByLevel(e);e&&isAnimationBlend(e)&&(e.name=t,this.refresh())}removeMotionInMotion(e){var t=e.pop();if(void 0!==t&&e.length){e=this.getMotionByLevel(e);if(e)if(e instanceof animationApi.AnimationBlend1D){var i=Array.from(e.items),n=(i.splice(t,1),i.length);if(2<n){var a=e[cc_1.editorExtrasTag];const r=[],o=(i.forEach(e=>{r.push(e.threshold)}),Math.min(...r)),s=(Math.max(...r)-o)/(n-1);a&&!0===a.autoThreshold&&i.forEach((e,t)=>{e.threshold=o+s*t})}e.items=i}else e instanceof animationApi.AnimationBlend2D&&((n=Array.from(e.items)).splice(t,1),e.items=n);this.refresh()}}changeMotionAutoThreshold(e,t){e=this.getMotionByLevel(e);e instanceof animationApi.AnimationBlend1D&&(e[cc_1.editorExtrasTag].autoThreshold=t,Metric("A100007"),this.refresh())}changeMotionThreshold1D(e,t,i){var n,e=this.getMotionByLevel(e);e instanceof animationApi.AnimationBlend1D&&(t=(n=Array.from(e.items))[t])&&(t.threshold=i,e.items=n,Metric("A100007"),this.refresh())}changeMotionThreshold2D(e,t,i){e=this.getMotionByLevel(e);if(e instanceof animationApi.AnimationBlend2D){var n=Array.from(e.items)[t];if(n){for(const a in i)"x"!==a&&"y"!==a||(n.threshold[a]=i[a]);Metric("A100007"),this.refresh()}}}changeMotionProp(e,t,i){e=this.getMotionByLevel(e);if("algorithm"===t){if(!(e instanceof animationApi.AnimationBlend2D))return;t=i;if(!(t in animationApi.AnimationBlend2D.Algorithm))return;e.algorithm=t}Metric("A100007"),this.refresh()}async changeClipMotionInMotion(e,t){e=this.getMotionByLevel(e);e instanceof animationApi.ClipMotion&&(t?(t=await loadAssetUncached(t),e.clip=t):e.clip=null,Metric("A100007"),this.refresh())}changeAnimationBlend1DInMotion(e,t,i){e=this.getMotionByLevel(e);e instanceof animationApi.AnimationBlend1D&&(t===env_type_1.EnvType.animationBlendVariable&&(e.param.variable=i),t===env_type_1.EnvType.animationBlendValue&&(e.param.value=i),Metric("A100007"),this.refresh())}changeAnimationBlend2DInMotion(e,t,i,n){e=this.getMotionByLevel(e);e instanceof animationApi.AnimationBlend2D&&(t=1===t?e.paramY:e.paramX,i===env_type_1.EnvType.animationBlendVariable&&(t.variable=n),i===env_type_1.EnvType.animationBlendValue&&(t.value=n),Metric("A100007"),this.refresh())}updateMotionEditData(t,i){if(this._currentEnv instanceof motion_env_1.MotionEnv){if(isAnimationBlend(this._currentEnv.motion)){let e=this._currentEnv.motion[cc_1.editorExtrasTag];e=e||(this._currentEnv.motion[cc_1.editorExtrasTag]={}),"threshold"===t&&(e[t]=i)}this.refresh()}}getComponents(e){return(e instanceof animationApi.MotionState||e instanceof animationApi.SubStateMachine)&&e.components?Array.from(e.components):[]}getComponent(e,t=null){return!t&&this._currentEnv instanceof state_machine_env_1.StateMachineEnv&&(t=this._currentEnv.state),this.getComponents(t)[e]||null}addComponent(e,t){var i=this._getIfIsStateMachineEnv();i&&((i=i.getState(e))instanceof animationApi.MotionState||i instanceof animationApi.SubStateMachine)&&((e=cc_1.js.getClassByName(t.name))&&i.addComponent(e),this.refresh())}removeComponent(e,t){var i=this._getIfIsStateMachineEnv();i&&(((i=i.getState(e))instanceof animationApi.MotionState||i instanceof animationApi.SubStateMachine)&&(e=this.getComponent(t,i),i.removeComponent(e)),this.refresh())}async changeComponent(e,t,i){var n=this._getIfIsStateMachineEnv();n&&(((n=n.getState(e))instanceof animationApi.MotionState||n instanceof animationApi.SubStateMachine)&&(e=this.getComponent(t,n),await scene_state_component_1.default.change(e,i)),this.refresh())}getTransitions(){var e=this._getIfIsStateMachineEnv();return e?Array.from(e.stateMachine.transitions()):[]}getTransition(e){return this.getTransitions()[e]||null}addTransition(e,t){var i,n=this._getIfIsStateMachineEnv();if(n)return e=(i=n.getStates())[e],(i=i[t])===n.stateMachine.anyState?(console.warn(Editor.I18n.t("animation-graph.transition.toAnyIsInvalid")),null):(t=this.getTransitions().length,n.stateMachine.connect(e,i),Metric("A100005"),this.viewTransition(t),this.getTransition(t))}removeTransition(e,t){var i=this._getIfIsStateMachineEnv();if(i){var n=this.getTransition(e);if(n){t?i.stateMachine.disconnect(n.from,n.to):i.stateMachine.removeTransition(n);var a=this.getTransitions();for(let e=0;e<a.length;e++)if(a[e].from===n.from&&a[e].to===n.to)return void this.viewTransition(e);this.crumbView()}}}viewTransition(e){var t=this._getIfIsStateMachineEnv();t&&(t.transition=this.getTransition(e),t.transitionIndex=e,Utils.changeCrumb(this.crumbs,env_type_1.EnvType.transition,Utils.getTransitionName(t.transition),e),t.stateIndex=-1,t.state=null,this.reselect(),this.refresh())}changeTransitionProp(e,t,i){e=this.getTransition(e);e&&("relativeDuration"===t&&animationApi.isAnimationTransition(e)?e.relativeDuration=!e.relativeDuration:"relativeDestinationStart"===t&&animationApi.isAnimationTransition(e)?e.relativeDestinationStart=!e.relativeDestinationStart:"startEventBinding"===t||"endEventBinding"===t?(animationApi.isAnimationTransition(e)||e instanceof animationApi.EmptyStateTransition||e instanceof animationApi.ProceduralPoseTransition)&&(e[t].methodName=i):e[t]=i,Metric("A100006"),this.refresh())}adjustTransitionPriority(e,t){var i=this._getIfIsStateMachineEnv();i&&(e=this.getTransition(e),i.stateMachine)&&e&&(i.stateMachine.adjustTransitionPriority(e,t),this.refresh())}addCondition(e,t){var i="add"+t.type;i in this&&this[i](e,t),this.refresh()}addBinaryCondition(e,t){var i,e=this.getTransition(e);e&&(e.conditions.length,i=new animationApi.BinaryCondition,e.conditions.push(i),t)&&i&&(i[cc_1.editorExtrasTag]=Object.assign(i[cc_1.editorExtrasTag]||{},t))}addUnaryCondition(e,t){var i,n,a=this.getTransition(e);a&&(i=a.conditions.length,n=new animationApi.UnaryCondition,a.conditions.push(n),t)&&n&&(n[cc_1.editorExtrasTag]=Object.assign(n[cc_1.editorExtrasTag]||{},t),this.changeUnaryCondition(e,i,t))}addTriggerCondition(e,t){var i,n,a=this.getTransition(e);a&&(i=a.conditions.length,n=new animationApi.TriggerCondition,a.conditions.push(n),t)&&n&&(n[cc_1.editorExtrasTag]=Object.assign(n[cc_1.editorExtrasTag]||{},t),this.changeTriggerCondition(e,i,t))}getCondition(e,t){e=this.getTransition(e);return e&&e.conditions[t]||null}removeCondition(e,t){e=this.getTransition(e);e&&(e.conditions.splice(t,1),this.refresh())}changeConditionProps(i,e,n,a){i=this.getCondition(i,e);if(i){for(let e=i,t=0;t<n.length;++t){if("object"!=typeof e||!e)return;var r=n[t];if(!(r in e))return;t===n.length-1?e[r]=a:e=e[r]}this.refresh()}}changeConditionBindingProps(e,t,i,n){var a=this.getCondition(e,t);if(a&&i in a){for(var[r,o]of n)for(let e=a[i],t=0;t<r.length;++t){if("object"!=typeof e||!e)return;var s=r[t];if(!(s in e))return;t===r.length-1?e[s]=o:e=e[s]}this.refresh()}}changeConditionBindingType(e,t,i,n){e=this.getCondition(e,t);e&&i in e&&((t=cc_1.js.getClassById(n))?(t=new t,e[i]=t,this.refresh()):console.warn(`绑定类型 ${n} 不存在！`))}changeUnaryCondition(e,t,i){e=this.getCondition(e,t);e&&i&&e instanceof animationApi.UnaryCondition&&(i.lhs&&i.lhs.type===env_type_1.EnvType.conditionVariable&&(e.operand.variable=i.lhs.value.variable),void 0!==i.operator)&&(e.operator=+i.operator)}changeTriggerCondition(e,t,i){e=this.getCondition(e,t);e&&i&&e instanceof animationApi.TriggerCondition&&i.lhs&&i.lhs.type===env_type_1.EnvType.conditionVariable&&(e.trigger=i.lhs.value.variable)}queryVariables(){if(this.animationGraph){this.queryData.variables={};for(var[e,t]of this.variables){var i=(0,variable_value_dump_1.dumpVariableValue)(t);this.queryData.variables[e]={type:animationApi.VariableType[t.type],value:i},t.type===animationApi.VariableType.TRIGGER&&(this.queryData.variables[e].resetMode=t.resetMode)}}}addVariable(e,t){if(this.animationGraph)return e=this.uniqueVariableName(e),(t=parseInt(t))in animationApi.VariableType&&this.animationGraph.addVariable(e,t),Metric("A100009"),this.refresh(),e}renameVariable(e,t){if(this.animationGraph){this.animationGraph.renameVariable(e,t);for(const i of animationApi.viewVariableBindings(this.animationGraph))i.name===e&&i.rebind(t);Metric("A100013"),this.refresh()}}async changeVariable(e,t){this.animationGraph&&(e=this.animationGraph.getVariable(e))&&(await(0,variable_value_dump_1.applyVariableValueDumpPatch)(e,t),this.refresh())}changeTriggerResetMode(e,t){this.animationGraph&&(e=this.animationGraph.getVariable(e))&&e.type===animationApi.VariableType.TRIGGER&&(e.resetMode=t?animationApi.TriggerResetMode.NEXT_FRAME_OR_AFTER_CONSUMED:animationApi.TriggerResetMode.AFTER_CONSUMED,this.refresh())}async removeVariable(e){if(this.animationGraph){if(this.checkVariableIsUsed(this.animationGraph,e))if(0!==(await Editor.Dialog.warn(Editor.I18n.t("animation-graph.variable.removeUsedTip",{variableName:e}),{buttons:[Editor.I18n.t("animation-graph.ok"),Editor.I18n.t("animation-graph.cancel")],default:1,cancel:1})).response)return;this.animationGraph.removeVariable(e),this.refresh()}}uniqueVariableName(e){var t=[];for(const i of this.variables)t.push(i[0]);for(;e&&t.includes(e);)/(\d+)$/.test(e)?e=e.replace(/(\d+)$/,(e,t)=>{t=parseInt(t,10);return(t+=1).toString()}):e+="1";return e}checkVariableIsUsed(e,t){for(const i of animationApi.viewVariableBindings(e))if(i.name===t)return!0;return!1}queryPreviewMotion(){return this._currentEnv instanceof motion_env_1.MotionEnv?this._currentEnv.motion:this._currentEnv instanceof state_machine_env_1.StateMachineEnv&&this._currentEnv.state instanceof animationApi.MotionState?this._currentEnv.state.motion:void 0}async setPreviewModel(e){this.userDefinedPreviewModelUuid[this.assetUuid]=e,await Editor.Profile.setTemp("animation-graph","preview-model",this.userDefinedPreviewModelUuid)}async queryPreviewModel(){if(this.userDefinedPreviewModelUuid[this.assetUuid])return this.userDefinedPreviewModelUuid[this.assetUuid];var e=this["animationGraph"];if(e)for(const i of iterateAllAnimationClips(e)){var t=await queryPreviewModelOfAnimationClip(i);if(t)return t}return""}queryBlend2DThresholdsWeights(e,t){var i=new Array(e.length).fill(0);return animationApi.blendSimpleDirectional(i,e,t),i}crumbPoseExpr(e){var t=this._getIfIsStateMachineEnv();t&&(t=t.getState(e),(0,interop_formal_1.isPoseExprState)(t))&&(this.editPoseGraph(t),Utils.changeCrumb(this.crumbs,env_type_1.EnvType.PoseExprState,t.name,e),Utils.changeCrumb(this.crumbs,"","",null,!0),this.reselect(),this.refresh())}addPoseNode(e){var t=this._getIfIsPoseGraphEnv();t&&(t.poseGraphInterop.addNode(e.key,e.editorData),this.reselect(),this.refresh())}removePoseNode(e){var t=this._getIfIsPoseGraphEnv();t&&(t.poseGraphInterop.removeNode(e),this.crumbView())}movePoseNode(e,t){var i=this._getIfIsPoseGraphEnv();i&&(i.poseGraphInterop.updateNodeEditorData(e,t),this.refresh())}crumbPoseNode(e){this._enterPoseNode(e,!0),this.reselect(),this.refresh()}_enterPoseNode(e,t){var i,n=this._getIfIsPoseGraphEnv();n&&(i=n.poseGraphInterop.getNodeEnterInfo(e))&&(i.type===env_type_1.EnvType.PoseExprAnimationBlend?(this._currentEnv=new motion_env_1.MotionEnv(i.target,Utils.getDefaultMotionLevel()),t&&(Utils.changeCrumb(this.crumbs,env_type_1.EnvType.MotionState,Utils.getMotionName(this._currentEnv.motion,null),this._currentEnv.motionLevel),Utils.changeCrumb(this.crumbs,"","",null,!0))):i.type===env_type_1.EnvType.StateMachine?(this._currentEnv=new state_machine_env_1.StateMachineEnv(i.target),t&&(Utils.changeCrumb(this.crumbs,env_type_1.EnvType.StateMachine,n.poseGraphInterop.getNodeName(e)||env_type_1.EnvType.StateMachine,e),Utils.changeCrumb(this.crumbs,"","",null,!0))):i.type===env_type_1.EnvType.LayerStash&&(t?this.editLayerStash(i.target.layerIndex,i.target.stashName,!0):this._enterLayerStash(i.target.layerIndex,i.target.stashName,!0)))}copyPoseNode(e){var t=this._getIfIsPoseGraphEnv();t&&(t=t.poseGraphInterop.copyNodes([e]))&&(this.clipBoard={type:"pose-nodes",copyPoseNodes:t},this.refresh())}async duplicatePoseNode(e){var t=this._getIfIsPoseGraphEnv();if(t){e=t.poseGraphInterop.copyNodes([e]);if(e){var i=await t.poseGraphInterop.pasteNodes(e);for(let e=0;e<i.length;e++){var n=i[e],a=t.poseGraphInterop.getNodeEditorData(n);a&&(a.centerX+=20,a.centerY+=20),a&&t.poseGraphInterop.updateNodeEditorData(n,a)}this.viewPoseNode(i[0])}}}copyCurrentStateMachine(){var e=this._getIfIsStateMachineEnv();e&&(this.clipBoard={type:"state-machine",stateMachine:(0,cc_1.instantiate)(e.stateMachine)},this.refresh())}async pasteIntoPoseGraph(e){var t=this._getIfIsPoseGraphEnv();if(t)switch(this.clipBoard.type){default:return;case"pose-nodes":var i=await t.poseGraphInterop.pasteNodes(this.clipBoard.copyPoseNodes);return void this._onAfterPasteNodes(i,e);case"state-machine":i=await t.poseGraphInterop.pasteStateMachine(this.clipBoard.stateMachine);this._onAfterPasteNodes(i,e)}}_onAfterPasteNodes(t,i){var n=this._getIfIsPoseGraphEnv();if(n){for(let e=0;e<t.length;e++){var a=t[e];i||(i=n.poseGraphInterop.getNodeEditorData(a))&&(i.centerX+=20,i.centerY+=20),i&&n.poseGraphInterop.updateNodeEditorData(a,i)}this.viewPoseNode(t[0])}}addPoseNodeInput(e,t){var i=this._getIfIsPoseGraphEnv();i&&(i.poseGraphInterop.insertInput(e,t),this.refresh())}async updatePoseNodeInput(e,t,i){var n=this._getIfIsPoseGraphEnv();n&&(await n.poseGraphInterop.updateNodeInputValue(e,t,i),this.refresh())}async updatePoseNodeData(e,t,i){var n=this._getIfIsPoseGraphEnv();n&&(await n.poseGraphInterop.updateNodeDump(e,t,i),this.refresh())}async handleDropAssetIntoPoseGraph(e,t,i){var n=this._getIfIsPoseGraphEnv();n&&(e=await loadAssetUncached(e),n.poseGraphInterop.handleDropAssetIntoPoseGraph(e,{x:t.centerX,y:t.centerY},i))&&this.refresh()}addPoseLink(e,t,i,n){var a=this._getIfIsPoseGraphEnv();a&&(a.poseGraphInterop.addLink(e,t,i,n),this.reselect(),this.refresh())}removePoseLink(e,t,i,n){var a=this._getIfIsPoseGraphEnv();a&&(a.poseGraphInterop.removeLink(e,t,i,n),this.reselect(),this.refresh())}toggleCollapsePoseNode(e,t){var i=this._getIfIsPoseGraphEnv();i&&(i.poseGraphInterop.updateNodeEditorData(e,{collapse:t}),this.refresh())}viewPoseNode(e){var t=this._getIfIsPoseGraphEnv();t&&(t.poseExprNodeId=e,Utils.changeCrumb(this.crumbs,env_type_1.EnvType.PoseExprNode,null!=(e=t.poseGraphInterop.getNodeName(e))?e:"<Unnamed pose node>",t.poseExprNodeId),this.reselect(),this.refresh())}addLayerStash(e){if(this.animationGraph)if(e<0||e>=this.animationGraph.layers.length)console.error("Layer index out of bounds.");else{var e=this.animationGraph.layers[e],i=[...e.stashes()].map(([e])=>e);let t="NewStash";for(let e=0;i.includes(t);++e)t="NewStash_"+e;e=e.addStash(t);e.graph[cc_1.editorExtrasTag]={id:Utils.produceEditorDataId()},e.graph.outputNode[cc_1.editorExtrasTag]={centerX:-51,centerY:-13.5},this.refresh()}}removeLayerStash(e,t){this.animationGraph&&(e<0||e>=this.animationGraph.layers.length?console.error("Layer index out of bounds."):(this.animationGraph.layers[e].removeStash(t),this.refresh()))}renameLayerStash(e,t,i){if(this.animationGraph)if(e<0||e>=this.animationGraph.layers.length)console.error("Layer index out of bounds.");else{e=this.animationGraph.layers[e];e.renameStash(t,i);for(const n of animationApi.visitStashReferences(e,t))n.alterReference(i);this.refresh()}}editLayerStash(e,t,i){this.animationGraph&&this._enterLayerStash(e,t,i)&&(this.crumbs=[{type:env_type_1.EnvType.layer,name:this.animationGraph.layers[e].name,value:e}],Utils.changeCrumb(this.crumbs,env_type_1.EnvType.LayerStash,""+t,{layerIndex:e,stashId:t}),Utils.changeCrumb(this.crumbs,"","",null,!0),this.reselect(),this.refresh())}stashCurrentPoseGraph(i){var n=this._getIfIsPoseGraphEnv();if(n){var a=null==(a=this.animationGraph)?void 0:a.layers[this.layerIndex];if(a){var r=[...a.stashes()].map(([e])=>e);let e="",t=0;for(;++t,e="Stash"+t,r.includes(e););n.poseGraphInterop.stash(a,e,i),this.refresh()}}}_enterLayerStash(e,t,i){var n;return!(!this.animationGraph||(e<0||e>=this.animationGraph.layers.length?(i||console.error("Layer index out of bounds."),1):(e=[...this.animationGraph.layers[e].stashes()].find(([e])=>e===t))?([n,e]=e,this.editPoseGraph(e),this.reselect(),this.refresh(),0):(i||console.error("Layer stash does not exist."),1)))}editPoseGraph(e){this.animationGraph&&(e=new interop_formal_1.PoseExprGraphInterop(this.animationGraph,e,{layerIndex:this.layerIndex}),this._currentEnv=new pose_graph_env_1.PoseGraphEnv(e))}_getIfIsStateMachineEnv(){if(this._currentEnv&&this._currentEnv instanceof state_machine_env_1.StateMachineEnv)return this._currentEnv}_getIfIsMotionEnv(){if(this._currentEnv&&this._currentEnv instanceof motion_env_1.MotionEnv)return this._currentEnv}_getIfIsPoseGraphEnv(){if(this._currentEnv&&this._currentEnv instanceof pose_graph_env_1.PoseGraphEnv)return this._currentEnv}}async function queryPreviewModelOfAnimationClip(e){e=e._uuid;if(!e)return"";let t="";e=e.split("@");if(!(t=Array.isArray(e)?e[0]:t))return"";var i,n,e=await Editor.Message.request("asset-db","query-asset-info",t);if(!e)return"";let a=!1,r="";for([i,n]of Object.entries(e.subAssets))if(n.type){var o=cc_1.js.getClassByName(n.type);if(!a&&cc_1.js.isChildClassOf(o,cc_1.Mesh)&&(a=!0),!r&&cc_1.js.isChildClassOf(o,cc_1.Prefab)&&(r=i),a&&r)break}return a&&r?e.subAssets[r].uuid:""}function*iterateAllAnimationClips(e){function*i(e){for(const t of e.states())t instanceof animationApi.MotionState?t.motion&&(yield*function*e(t){if(t instanceof animationApi.ClipMotion)t.clip&&(yield t.clip);else if(isAnimationBlend(t))for(var{motion:i}of t.items)i&&(yield*e(i))}(t.motion)):t instanceof animationApi.SubStateMachine&&(yield*i(t.stateMachine))}for(const t of e.layers)yield*i(t.stateMachine)}function Metric(e,t){e&&Editor.Metrics._trackEventWithTimer({category:"animationStateMachine",id:e,value:1})}function isAnimationBlend(e){return e instanceof animationApi.AnimationBlend1D||e instanceof animationApi.AnimationBlend2D}async function loadAsset(e){return new Promise((i,n)=>{cc_1.assetManager.loadAny(e,(e,t)=>{e?n(e):i(t)})})}async function loadAssetUncached(e){return cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(e)),loadAsset(e)}function getInvolvedBlendParamVariablesOfMotion(e){const n={},r=(e,t,i)=>{e&&(e in n?(n[e].min=Math.min(n[e].min,t),n[e].max=Math.max(n[e].max,i)):n[e]={min:t,max:i})},o=e=>{if(e instanceof animationApi.AnimationBlend1D){var t=[...e.items].map(e=>e.threshold);r(e.param.variable,Math.min(...t),Math.max(...t))}else if(e instanceof animationApi.AnimationBlend2D){var t=[...e.items].map(e=>e.threshold.x),i=[...e.items].map(e=>e.threshold.y);r(e.paramX.variable,Math.min(...t),Math.max(...t)),r(e.paramY.variable,Math.min(...i),Math.max(...i))}else if(e instanceof animationApi.AnimationBlendDirect)for(const n of e.items)r(n.weight.variable,0,1);if(isAnimationBlend(e))for(const a of e.items)a.motion&&o(a.motion)};return o(e),n}function getTCBindingTypeInfos(){var e,t,i,n,a=[];for([t,i]of Object.entries(cc_1.js._idToClass))cc_1.js.isChildClassOf(i,animationApi.TCBinding)&&(n=animationApi.getTCBindingTypeInfo(i),a.push({id:t,menu:null!=(e=null==n?void 0:n.menu)?e:t,provisions:null!=(e=null==n?void 0:n.provisions)?e:[],transitionSourceFilter:null!=n&&n.transitionSourceFilter?parseEngineTCBindingTransitionSourceFilter(n.transitionSourceFilter):void 0}));return a}function parseEngineTCBindingTransitionSourceFilter(e){var t=[];return e&animationApi.TCBindingTransitionSourceFilter.MOTION&&t.push(env_type_1.EnvType.MotionState),e&animationApi.TCBindingTransitionSourceFilter.POSE&&t.push(env_type_1.EnvType.PoseExprState),e&animationApi.TCBindingTransitionSourceFilter.EMPTY&&t.push(env_type_1.EnvType.EmptyState),t}__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"reset",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"query",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"apply",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbView",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addLayer",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removeLayer",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbLayer",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"renameLayer",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeLayer",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"moveLayer",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbStateMachine",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removeState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"moveState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"renameState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"copyState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"duplicateState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"pasteState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"turnMotionStateIntoSubStateMachine",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addMotionToState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeClipMotion",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbMotion",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbMotionInMotion",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removeMotion",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"moveMotion",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addMotionToMotion",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"renameMotionInMotion",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"updateMotionEditData",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addComponent",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removeComponent",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeComponent",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"adjustTransitionPriority",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addCondition",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removeCondition",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeConditionProps",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeConditionBindingProps",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeConditionBindingType",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addVariable",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"renameVariable",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeVariable",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeTriggerResetMode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removeVariable",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"queryBlend2DThresholdsWeights",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbPoseExpr",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addPoseNode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removePoseNode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"movePoseNode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbPoseNode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"copyPoseNode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"duplicatePoseNode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"copyCurrentStateMachine",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"pasteIntoPoseGraph",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addPoseNodeInput",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"updatePoseNodeInput",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"updatePoseNodeData",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"handleDropAssetIntoPoseGraph",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addPoseLink",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removePoseLink",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"toggleCollapsePoseNode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addLayerStash",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removeLayerStash",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"renameLayerStash",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"editLayerStash",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"stashCurrentPoseGraph",null),exports.default=new SceneAnimationGraph;const dumpTCBinding=e=>{var t=cc_1.js.getClassId(e.constructor);if(!t)throw new Error(e.constructor.name+" 不是一个有效的 cc 类，无法 dump。");var i=e.constructor.__props__;if(!Array.isArray(i)||!i.every(e=>"string"==typeof e))throw new Error(e.constructor.name+" 不是一个有效的 cc 类，无法 dump。");var n={__type__:t};for(const a of i)n[a]=e[a];return n};