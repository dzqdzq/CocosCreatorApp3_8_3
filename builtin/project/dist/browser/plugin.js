"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0;const path_1=require("path"),lodash_1=require("lodash");class PluginManager{constructor(){this.configs={},this.customHandlers={},this.hasRegisterPackages=new Set}async init(){var e=Editor.Package.getPackages({enable:!0});await Promise.all(e.map(e=>register(e))),Editor.Package.__protected__.on("enable",register),Editor.Package.__protected__.on("disable",unRegister)}async handleExportConfigs(){var e={};for(const r in this.configs){e[r]={__version__:this.configs[r].version};for(const i in this.configs[r].tabs)if(this.configs[r].tabs[i].content){var t={};for(const s in this.configs[r].tabs[i].content||{})t[s]=await Editor.Profile.getProject(r,s);e[r][i]={content:t}}}for(const a in this.customHandlers){e[a]&&e[a].__version__||(e[a]={__version__:this.configs[a].version});for(const c in this.customHandlers[a]){var o=this.customHandlers[a][c];if(o.exportConfig)try{var n=await o.exportConfig.call(o)||{};Array.isArray(n)||"object"!=typeof n||(e[a][c]=Object.assign({},e[a][c],{custom:n}))}catch(e){console.debug(`[Export Project Configs] Handle custom export error in ${a}.`+c,e)}}}return e}async handleImportConfigs(e){for(const r in e)if("object"==typeof e[r])if(e[r].__version__){var t,o;e[r].__version__!==this.configs[r].version&&(t=e[r].__version__,o=convertToProfileConfigs(e[r]),await Editor.Profile.__protected__.migrateProject(r,t,o),syncMigrateConfigs(e[r],o));for(const i in e[r]){if(e[r][i].content)for(const s in e[r][i].content)"object"==typeof e[r][i].content&&this.configs[r].tabs[i].content&&this.configs[r].tabs[i].content[s]&&await Editor.Profile.setProject(r,s,e[r][i].content[s],"project");if(e[r][i].custom){var n=this.customHandlers[r][i];if("object"==typeof e[r][i].custom&&n.importConfig)try{await n.importConfig.call(n,e[r][i].custom)}catch(e){console.debug(`[Import Project Configs] Handle custom import error in ${r}.`+i,e)}}}}else console.warn(`[${r}] Plugin config without version`)}async handleQueryConfigs(e){var t,o,n={};for(const r in e)"object"==typeof e[r]&&(e[r].__version__?(t=convertToProfileConfigs(e[r]),e[r].__version__!==this.configs[r].version&&(o=e[r].__version__,await Editor.Profile.__protected__.migrateProject(r,o,t)),n[r]=t):console.warn(`[${r}] Plugin config without version`));return n}destroy(){Editor.Package.__protected__.removeListener("enable",register),Editor.Package.__protected__.removeListener("disable",unRegister)}}exports.pluginManager=new PluginManager;const register=async function(t){if(!t||t.invalid||!t.info||!t.info.contributions||!t.info.contributions.project)return!1;exports.pluginManager.hasRegisterPackages.add(t.name);try{var e=t.info.contributions.project,o=t.info.contributions.profile,n={title:t.info.title||t.name,tabs:{},version:t.version};for(const s in e){var r=n.tabs[s]={label:e[s].label,content:null,custom:e[s].custom?(0,path_1.join)(t.path,e[s].custom):""};if(e[s].content)for(const a in e[s].content)r.content=r.content||{},r.content[a]={label:o&&o.project&&o.project[a].label||e[s].content[a].label||a,description:o&&o.project&&o.project[a].description||e[s].content[a].description,render:e[s].content[a]};if(e[s].custom)try{var i=Editor.Module.__protected__.requireFile((0,path_1.join)(t.path,e[s].custom));(i.exportConfig||i.importConfig)&&(exports.pluginManager.customHandlers[t.name]=exports.pluginManager.customHandlers[t.name]||{},exports.pluginManager.customHandlers[t.name][s]=i)}catch(e){console.log(t.name+": register custom project failed."),console.error(e)}}exports.pluginManager.configs[t.name]=n,await Editor.Panel.has("project.settings")&&Editor.Message.broadcast("project:packages-changed")}catch(e){console.log(t.name+": register default project failed."),console.error(e)}},unRegister=async function(e){if(!exports.pluginManager.hasRegisterPackages.has(e.name))return!1;exports.pluginManager.hasRegisterPackages.delete(e.name),delete exports.pluginManager.configs[e.name],delete exports.pluginManager.customHandlers[e.name],await Editor.Panel.has("project.settings")&&Editor.Message.broadcast("project:packages-changed")},convertToProfileConfigs=function(e){let r={__version:e.__version__};for(const o in e){if(e[o].content)for(const n in e[o].content)t(n,e[o].content[n]);if(e[o].custom)for(const i in e[o].custom)t(i,e[o].custom[i])}function t(e,t){var o=e.split(".").reverse();let n={[o[0]]:t};for(let e=1;e<o.length;e++)n={[o[e]]:n};r=(0,lodash_1.merge)(r,n)}return r},syncMigrateConfigs=function(a,e){for(const o in a){if(a[o].content)for(const n in a[o].content)t(o,n,"content");if(a[o].custom)for(const r in a[o].custom)t(o,r,"custom")}function t(t,o,n){var r=o.split(".");let i=e,s=!0;for(let e=0;e<r.length;e++){if(void 0===i[r[e]]||null==i[r[e]]){delete a[t][n][o],s=!1;break}i=i[r[e]]}s&&i!==a[t][n][o]&&(a[t][n][o]=i)}};