"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,n,r,t){void 0===t&&(t=r);var s=Object.getOwnPropertyDescriptor(n,r);s&&("get"in s?n.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return n[r]}}),Object.defineProperty(e,t,s)}:function(e,n,r,t){void 0===t&&(t=r),e[t]=n[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,n){Object.defineProperty(e,"default",{enumerable:!0,value:n})}:function(e,n){e.default=n}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(n,e,r);return __setModuleDefault(n,e),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.sendToChannel=exports.unregisterChannel=exports.registerChannel=exports.removeAllListeners=exports.removeListener=exports.once=exports.on=exports.sendToContent=exports.sendToWin=exports.emit=exports.broadcast=exports._events=void 0;const events_1=require("events"),electron_1=require("electron"),sender_1=require("./sender"),event_1=require("./event"),channelPool=__importStar(require("v-electron-channel")),utils_1=require("./utils"),pkg=require("../package.json"),ipcFlag=`${pkg.name}@${pkg.version}`,eventBus=new events_1.EventEmitter;function broadcast(e,...n){let r={message:e,arguments:n},t=electron_1.webContents.getAllWebContents();t&&t.forEach(e=>{e.isDestroyed()||e.send(`${ipcFlag}:broadcast`,r)})}function emit(e,...n){let r=eventBus._events[e];return r||(r=[]),Array.isArray(r)||(r=[r]),new sender_1.EventSender(r,{message:e.toString(),arguments:n})}function sendToWin(e,n,...r){if(e&&e.webContents)return new sender_1.WindowSender(e.webContents,{message:n,arguments:r})}function sendToContent(e,n,...r){const t=electron_1.webContents.fromId(e);if(!t)throw new Error("The specified webContent does not exist");return new sender_1.WindowSender(t,{message:n,arguments:r})}function on(e,n){return eventBus.on(e,n)}function once(e,n){return eventBus.once(e,n)}function removeListener(e,n){return eventBus.removeListener(e,n)}function removeAllListeners(e){return eventBus.removeAllListeners(e)}function registerChannel(e){channelPool.register(`${ipcFlag}:${e}`)}function unregisterChannel(e){channelPool.clear(`${ipcFlag}:${e}`)}function sendToChannel(e,n,...r){const t=channelPool.query(`${ipcFlag}:${e}`);if(!t)throw new Error(`Channel does not exist: ${e}`);const s=t[t.length-1];if(-1===s)return emit(n,...r);const o=electron_1.webContents.fromId(s);if(!o)throw new Error(`Channel does not exist: ${e}`);return new sender_1.WindowSender(o,{message:n,arguments:r})}exports._events=eventBus._events,exports.broadcast=broadcast,exports.emit=emit,exports.sendToWin=sendToWin,exports.sendToContent=sendToContent,exports.on=on,exports.once=once,exports.removeListener=removeListener,exports.removeAllListeners=removeAllListeners,exports.registerChannel=registerChannel,exports.unregisterChannel=unregisterChannel,exports.sendToChannel=sendToChannel,electron_1.ipcMain.on(`${ipcFlag}:send`,(e,n)=>{let r=new event_1.MessageEvent("renderer");r.sender=e.sender,n.needCallback&&(r.needCallback=!0,r.reply=function(r,...t){if(!r||r instanceof Error||console.log(`${n.message} - The first parameter of event.reply must be 'Error'`),e.sender.isDestroyed())return;const s=n.original?t:(0,utils_1.encodeArgs)(t);e.sender.send(`${ipcFlag}:send-reply`,n.cid,(0,event_1.serializeError)(r),s)}),eventBus.emit(n.message,r,...n.arguments)}),electron_1.ipcMain.on(`${ipcFlag}:sendSync`,async(e,n)=>{let r=new event_1.MessageEvent("renderer");r.sender=e.sender;let t=eventBus._events[n.message];if(t){Array.isArray(t)||(t=[t]);try{const s=await t[0](r,...n.arguments);e.returnValue={error:null,value:s}}catch(n){e.returnValue={error:(0,event_1.serializeError)(n),value:null}}for(let e=1;e<t.length;e++){let s=t[e];await s(r,...n.arguments)}}else e.returnValue={error:null,value:void 0}}),electron_1.ipcMain.on(`${ipcFlag}:send-reply`,(e,n,r,t)=>{let s=sender_1.WindowSender.query(n);if(s){if(clearTimeout(s._timer),s._callback){const e=s.options.original?t:(0,utils_1.decodeArgs)(t);s._callback((0,event_1.deserializeError)(r),...e)}sender_1.WindowSender.remove(n)}else r&&console.warn(r)});