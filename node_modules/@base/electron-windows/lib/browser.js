"use strict";const ipc=require("@base/electron-base-ipc"),uuidV4=require("uuid/v4"),{EventEmitter:EventEmitter}=require("events"),{app:app,BrowserWindow:BrowserWindow,shell:shell}=require("electron"),{join:join,isAbsolute:isAbsolute,normalize:normalize}=require("path"),pkg=require("../package.json"),ipcFlag=`${pkg.name}@${pkg.version}`;function awaitAppReady(){if(!app.isReady())return new Promise(e=>{app.once("ready",e)})}class WindowManager extends EventEmitter{constructor(){super(),this._waitClosedWindows=Object.create(null),this._waitClosedMain=!1,this._allowClosedMain=!1,this.uuids=[],this.uuid2win=Object.create(null),this.uuid2info=Object.create(null),this._focusWindow=null}focus(e){const i=this.uuid2win[e];i&&i.focus()}_close(e){return new Promise(i=>{this._waitClosedWindows[e]=function(e){i(e)};let t=this.uuid2win[e],s=this.uuid2info[e];t&&!t.isDestroyed()?(s.options.fullscreen=t.isFullScreen(),t.close()):i()})}async _closedOthers(){let e=!0;for(let i=this.uuids.length-1;i>0;i--){const t=this.uuids[i];await this._close(t)||(e=!1)}return!1===e&&(this.uuids=this.uuids.filter(e=>{let i=this.uuid2win[e];return!(!i||i.isDestroyed())||(delete this.uuid2win[e],delete this.uuid2info[e],!1)})),e}normalizeURL(e,i){return`file://${encodeURI(e).replace(/[!'()#\?*]/g,function(e){return"%"+e.charCodeAt(0).toString(16)}).replace(/%5C/gi,"/")}#${i}`}async open(e,i,t,s={}){await awaitAppReady(),/^file\:\//.test(e)&&(e=e.substr(6)),isAbsolute(e)||(e=join(process.cwd(),e)),i=i||{},t=t||{};let n=uuidV4(),o=!1;"show"in i&&!i.show||(o=!0,i.show=!1);for(let e in i)e in s||(s[e]=i[e]);if(void 0!==s.x&&void 0!==s.y){let e=require("electron").screen,i=e.getAllDisplays(),t=!1;for(let e=0;e<i.length;e++){const n=i[e];if(n.bounds.x<=s.x&&n.bounds.x+n.bounds.width>=s.x&&n.bounds.y<=s.y&&n.bounds.y+n.bounds.height>=s.y){t=!0;break}}if(!t){let i=e.getPrimaryDisplay().bounds;s.x=i.x,s.y=i.y,s.width>i.width&&(s.width=i.width),s.height>i.height&&(s.height=i.height)}}let r=new BrowserWindow(s),u={uuid:n,url:e,userData:t,options:JSON.parse(JSON.stringify(i)),bounds:r.getBounds()};r.webContents.on("will-navigate",(e,i)=>{i=(i=i.replace(/^file\:\/+/,"")).replace(/#.*/,""),i=normalize(i),"darwin"===process.platform&&(i=`/${i}`),u.url!==i&&(e.preventDefault(),shell.openExternal(i))}),!1===i.menuBarVisibility&&(r.setAutoHideMenuBar(!1),r.setMenuBarVisibility(!1)),this.uuid2win[n]=r,this.uuid2info[n]=u,this.uuids.push(n);let a=null,l=()=>{null===a&&(a=setTimeout(()=>{a=null,r&&!r.isDestroyed()&&(u.bounds=r.getBounds(),this.emit("change"))},500))};r.on("move",()=>{l()}),r.on("resize",()=>{l()}),r.on("close",async e=>{if(0===this.uuids.indexOf(n))return this._allowClosedMain?void r.send(`${ipcFlag}:close`):(this._waitClosedMain=!0,e.preventDefault(),this._allowClosedMain=await this._closedOthers(),this._allowClosedMain?r.close():this._waitClosedMain=!1,void this.emit("change"));r.send(`${ipcFlag}:close`)});const d=()=>{let e=this.uuids.indexOf(n);if(this._waitClosedMain){if(0===e)try{this.emit("clear")}catch(e){console.error(e)}}else if(0!==e){delete this.uuid2info[n],delete this.uuid2win[n],-1!==e&&this.uuids.splice(e,1);try{this.emit("change")}catch(e){console.error(e)}}else try{this.emit("change")}catch(e){console.error(e)}};return r.on("destroy",d),r.on("closed",d),this.emit("change"),r.on("focus",()=>{null===this._focusWindow?(this._focusWindow=r,this.emit("focus")):this._focusWindow=r}),r.on("blur",()=>{setImmediate(()=>{this._focusWindow===r&&(this._focusWindow=null,this.emit("blur"))})}),new Promise(i=>{const t=this.normalizeURL(e,n);r.loadURL(t),r.load;let s=!1;setTimeout(()=>{s||(s=!0,o&&r.show(),i(n))},2e3),r.once("dom-ready",()=>{setTimeout(()=>{s||(s=!0,o&&r.show(),i(n))},100)})})}async restore(e){await awaitAppReady();let i=e.windows;const t=[];for(let e=0;e<i.length;e++){let s=i[e];const n=await this.open(s.url,s.options,s.userData,{x:s.bounds.x,y:s.bounds.y,width:s.bounds.width,height:s.bounds.height});t.push(n)}return t}dump(){return{version:1,windows:this.uuids.map(e=>{return this.uuid2info[e]})}}async quit(){await this._close(this.uuids[0])}}let manager=module.exports=new WindowManager;ipc.on(`${ipcFlag}:query-user-data`,(e,i)=>{let t=manager.uuid2info[i];return t&&t.userData||{}}),ipc.on(`${ipcFlag}:sync-user-date`,(e,i,t)=>{let s=manager.uuid2info[i];s&&JSON.stringify(s.userData)!==JSON.stringify(t)&&(s.userData=t,manager.emit("change"))}),ipc.on(`${ipcFlag}:sync-closed`,(e,i,t)=>{let s=manager._waitClosedWindows[i];s&&s.call(manager,t)}),ipc.on(`${ipcFlag}:ask-win`,e=>{let i=BrowserWindow.fromWebContents(e.sender),t=manager.uuids.some(e=>i===manager.uuid2win[e]);e.reply(null,t)}),ipc.on(`${ipcFlag}:set-min-size`,(e,i,t)=>{i=Math.round(i),t=Math.round(t);const s=BrowserWindow.fromWebContents(e.sender);if(!s||s.isDestroyed())return;const n=s.getSize(),o=s.getContentSize();if(0===o[0]&&0===o[1])return;(i>o[0]||t>o[1])&&s.setContentSize(Math.max(o[0],i),Math.max(o[1],t));const r=s.getMinimumSize();t+=n[1]-o[1],r[0]===i&&r[1]===t||s.setMinimumSize(i,t)});