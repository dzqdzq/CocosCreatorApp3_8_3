"use strict";const ipc=require("@base/electron-base-ipc"),{EventEmitter:EventEmitter}=require("events"),{BrowserWindow:BrowserWindow}=require("electron"),{join:join}=require("path"),vStacks=require("v-stacks"),pkg=require("../package.json"),ipcFlag=`${pkg.name}@${pkg.version}`,name2worker={};class Worker extends EventEmitter{get isReady(){return!!this.win}constructor(e){super(),this.name=e,this.files=[],this.ipc=new EventEmitter}async init(e){return this.win=new BrowserWindow({width:300,height:300,show:!1,autoHideMenuBar:!0,webPreferences:{nodeIntegration:!0,contextIsolation:!1,preload:e.preload,enableRemoteModule:!0}}),new Promise((e,i)=>{this.win.webContents.on("dom-ready",()=>{ipc.sendToWin(this.win,`${ipcFlag}:init`,{name:this.name,files:this.files}),e()});const n="file://"+join(__dirname,"../static/worker.html"),r=encodeURI(n).replace(/[!'()#\?*]/g,function(e){return"%"+e.charCodeAt(0).toString(16)}).replace(/%5C/gi,"/");this.win.loadURL(r),this.win.webContents.on("did-start-loading",()=>{this.emit("refresh")}),this.win.webContents.on("render-process-gone",(e,i)=>{this.emit("render-process-gone",e,i)}),this.win.webContents.on("crashed",(e,i)=>{this.emit("crashed",-1)}),this.win.on("close",e=>{this._allowClose||(e.preventDefault(),this.win.hide())}),this.win.on("closed",()=>{this.win=null,this.emit("closed")})})}debug(e){e?(this.win.show(),this.win.openDevTools()):(this.win.hide(),this.win.closeDevTools())}async close(){this._allowClose=!0,this.win&&this.win.close()}send(e,...i){return new Promise((n,r)=>{ipc.sendToWin(this.win,`${ipcFlag}:message`,e,i).callback((e,i)=>{if(e)return r(e);n(i)})})}require(e){this.files.push(e),ipc.sendToWin(this.win,`${ipcFlag}:require`,e)}}class Manager{create(e){return name2worker[e]=new Worker(e)}close(e){let i=name2worker[e];delete name2worker[e],i&&i.close()}clear(){for(const e in name2worker)this.close(e)}query(e){return name2worker[e]||null}queryAll(){let e=[];for(const i in name2worker){const n=name2worker[i];n&&e.push(n)}return e}async forEach(e){for(let i in name2worker)await e(name2worker[i])}}module.exports=new Manager,ipc.on(`${ipcFlag}:message`,(e,i,n,r)=>{let t=module.exports.query(i);t&&t.ipc.emit(n,e,...r)});