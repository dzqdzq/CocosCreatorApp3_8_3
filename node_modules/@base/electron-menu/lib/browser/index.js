"use strict";const{app:app,BrowserWindow:BrowserWindow,Menu:Menu}=require("electron"),ipc=require("@base/electron-base-ipc"),BaseMenu=require("./menu"),pkg=require("../../package.json"),ipcFlag=`${pkg.name}@${pkg.version}`;class MenuManager{constructor(){this.waitReady=!1,this.menu=new BaseMenu("base")}clear(){this.menu=new BaseMenu("base")}add(e,n){let p=e.split("/");p=p.filter(e=>!!e);let u=this.menu;return p.forEach((e,l)=>{l<p.length-1?u.add(e):u.add(e,n),u=u.get(e)}),this}remove(e){let n=e.split("/");n=n.filter(e=>!!e);let p=function(e,n){let u=n.shift(),l=e.get(u)||null;if(l){let u=0===n.length;p(l,n),(l.isEmpty()||u)&&e.remove(l.name)}};return p(this.menu,n),this}get(e){let n=(e||"").split("/");n=n.filter(e=>!!e);let p=this.menu;return n.forEach(e=>{if(!p)return null;p=p.get(e)||null}),p}apply(){if(!app.isReady())return void(this.waitReady=!0);menuManager.waitReady=!1;let e=this.menu.toJson().submenu;if(e){let n=Menu.buildFromTemplate(e);Menu.setApplicationMenu(n)}}setParseHandler(e){BaseMenu.setParseHandler(e)}}let menuManager=module.exports=new MenuManager;app.once("ready",()=>{menuManager.waitReady&&menuManager.apply()});let _popupMenuTemplate=null,_popupMenu=null;ipc.on(`${ipcFlag}:popup`,(e,n)=>{n.separator=n.separator||"/";let p=n.menu,u=function(p,l){p.click=function(){e.reply(null,l)},p.submenu&&p.submenu.forEach(e=>{u(e,`${l}${n.separator}${e.label}`)})};p.forEach(e=>{u(e,e.label)});let l=Menu.buildFromTemplate(p),t=BrowserWindow.fromWebContents(e.sender);l.popup({window:t,x:n.x,y:n.y}),_popupMenuTemplate=p,_popupMenu=l,l.once("menu-will-close",()=>{_popupMenuTemplate=null,_popupMenu=null})}),ipc.on(`${ipcFlag}:click-popup`,(e,n)=>{if(!_popupMenuTemplate)return e.reply(null,!1),!1;const p=n.split(".");let u={submenu:_popupMenuTemplate};for(let n=0;n<p.length;n++){const l=p[n];if(!(u=u.submenu[l]))return e.reply(null,!1),!1}return u.click(),_popupMenu.closePopup(),_popupMenuTemplate=null,_popupMenu=null,e.reply(null,!0),!0}),ipc.on(`${ipcFlag}:query-popup`,e=>_popupMenuTemplate?(e.reply(null,_popupMenuTemplate),_popupMenuTemplate):(e.reply(null,null),null));