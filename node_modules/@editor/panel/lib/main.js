"use strict";const ps=require("path"),ipc=require("@base/electron-base-ipc"),{BrowserWindow:BrowserWindow}=require("electron"),{EventEmitter:EventEmitter}=require("events"),electronSync=require("v-electron-sync"),pkg=require("../package.json"),ipcFlag=`${pkg.name}@${pkg.version}`;let panel2win=Object.create(null),windows=[],name2info=Object.create(null),focusPanelName="",lastFocusPanelName="";function isSame(e,n,i){for(let o=n-1;o>=0;o--)if(e===i[o])return!0;return!1}class PanelManager extends EventEmitter{register(e,n,i){ps.isAbsolute(n)||(n=ps.join(process.cwd(),n)),i=i||{},name2info[e]={name:e,userData:i,file:n,dirname:ps.dirname(n)},this.emit("register",e),ipc.broadcast(`${ipcFlag}:emit`,"register",e)}unregister(e){delete name2info[e],this.emit("unregister",e),ipc.broadcast(`${ipcFlag}:emit`,"unregister",e)}async exec(e,n,...i){const o=panel2win[e];if(void 0===o)return;const s=[];for(let a=0;a<o.length;a++){const t=o[a];isSame(t,a,o)||s.push(new Promise((o,s)=>{const a=BrowserWindow.fromId(t);a&&ipc.sendToWin(a,`${ipcFlag}:exec`,e,n,...i).callback((e,n)=>{if(e)return s(e);o(n)})}))}let a;return(await Promise.all(s)).some(e=>{if(void 0!==e&&null!==e)return a=e,!0}),a}execWithoutReply(e,n,...i){const o=panel2win[e];if(void 0!==o)for(let s=0;s<o.length;s++){const a=o[s];if(isSame(a,s,o))continue;const t=BrowserWindow.fromId(a);if(!t)return;ipc.sendToWin(t,`${ipcFlag}:exec`,e,n,...i)}}queryInfo(e){return name2info[e]||null}changeUserData(e,n){const i=name2info[e]||null;i&&(i.userData=n,ipc.broadcast(`${ipcFlag}:emit`,"change",e))}focus(e){const n=panel2win[e];if(void 0===n)return!1;const i=n[0];if(void 0===i)return!1;if(focusPanelName===e)return!0;if(panel2win[focusPanelName]){panel2win[focusPanelName].forEach(e=>{const n=BrowserWindow.fromId(e);n&&ipc.sendToWin(n,`${ipcFlag}:blur`,focusPanelName)})}let o=BrowserWindow.fromId(i);return o?(o.focus(),ipc.sendToWin(o,`${ipcFlag}:focus`,e),!0):void 0}getFocusPanel(){return{current:focusPanelName,last:lastFocusPanelName}}getPanelsFromWindow(e){return Object.keys(panel2win).filter(n=>-1!==panel2win[n].indexOf(e.id))}getWindow(e){return panel2win[e]||null}}module.exports=new PanelManager,ipc.on(`${ipcFlag}:call`,async(e,n,...i)=>module.exports[n](...i)),ipc.on(`${ipcFlag}:call-send`,(e,...n)=>{let i=module.exports.send(...n);i&&e.needCallback&&i.callback(e.reply)});const listenDestroy=function(e){const n=e.id,i=windows.indexOf(n);if(-1!==i)return;const o=()=>{Object.keys(panel2win).forEach(e=>{const i=panel2win[e].indexOf(n);-1!==i&&(panel2win[e].splice(i,1),0===panel2win[e].length&&delete panel2win[e])})};e.webContents.on("dom-ready",o),e.once("closed",()=>{windows.splice(i,1),o()})};ipc.on(`${ipcFlag}:connected`,(e,n,i)=>{const o=BrowserWindow.fromWebContents(e.sender);if(!o)return;const s=o.id,a=name2info[n];a&&a.userData.flags&&a.userData.flags.alwaysOnTop&&!o.isAlwaysOnTop()&&o.setAlwaysOnTop(!0),panel2win[n]=panel2win[n]||[],panel2win[n].push(s),-1===windows.indexOf(o.id)&&(listenDestroy(o),windows.push(s)),ipc.broadcast(`${ipcFlag}:emit`,"connected",n,i)}),ipc.on(`${ipcFlag}:disconnected`,(e,n,i)=>{const o=BrowserWindow.fromWebContents(e.sender);if(!o){if(panel2win[n])for(let e=0;e<panel2win[n].length;e++){const i=panel2win[n][e],o=BrowserWindow.fromId(i);!o&&o.isDestroyed()&&panel2win[n].splice(e--,1)}return}const s=o.id;if(!panel2win[n])return;const a=panel2win[n].indexOf(s);-1!==a&&(panel2win[n].splice(a,1),0===panel2win[n].length&&delete panel2win[n]);const t=module.exports.getPanelsFromWindow(s);if(t){!t.some(e=>{const n=name2info[e];return n&&n.userData.flags&&n.userData.flags.alwaysOnTop})&&o.isAlwaysOnTop()&&o.setAlwaysOnTop(!1)}ipc.broadcast(`${ipcFlag}:emit`,"disconnected",n,i)}),ipc.on(`${ipcFlag}:ready`,(e,n)=>{module.exports.emit("ready",n)}),ipc.on(`${ipcFlag}:close`,(e,n)=>{module.exports.emit("close",n)}),ipc.on(`${ipcFlag}:focus`,(e,n,i)=>{focusPanelName=n,lastFocusPanelName=n,module.exports.emit("focus",n,i),ipc.broadcast(`${ipcFlag}:emit`,"focus",n,i)}),ipc.on(`${ipcFlag}:blur`,(e,n)=>{n===focusPanelName&&(focusPanelName=""),module.exports.emit("blur",n),ipc.broadcast(`${ipcFlag}:emit`,"blur",n)}),ipc.on(`${ipcFlag}:pause`,(e,n)=>{module.exports.emit("pause",n)}),ipc.on(`${ipcFlag}:resume`,(e,n)=>{module.exports.emit("resume",n)});