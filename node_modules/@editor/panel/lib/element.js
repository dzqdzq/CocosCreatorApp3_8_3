"use strict";const fs=require("fs"),ipc=require("@base/electron-base-ipc"),pkg=require("../package.json"),ipcFlag=`${pkg.name}@${pkg.version}`;let name2panel=Object.create(null),operateRecord={name:"",time:-1};setInterval(()=>{const e=Date.now();operateRecord.time&&operateRecord.time+3e5<e&&(ipc.send(`${ipcFlag}:pause`,operateRecord.name,process.pid),operateRecord.time=0)},6e4);let baseStyle="\nbody, ul, h1, h2, h3, h4, h5, h6 { margin: 0; padding: 0; }\nli { list-style: none; }\n:host { display: block; position: relative; overflow: hidden; box-sizing: border-box; outline: none; }\n:host([hidden]) { display: none; }\n#creator-resizer { border: none; position: absolute; top: 0; right: 0; bottom: 0; left: 0; width: 100%; height: 100%; pointer-events: none; visibility: hidden; }\n",customStyle="",listeners=[];class PanelFrame extends window.HTMLElement{static importStyle(e){fs.existsSync(e)&&(customStyle=fs.readFileSync(e,"utf8"),Object.keys(name2panel).forEach(e=>{name2panel[e].forEach(e=>{let t=e.hidden;e.hidden=!0;const n=e.shadowRoot.querySelector("#base-style");n&&(n.textContent=baseStyle+"\n"+customStyle),requestAnimationFrame(()=>{e.hidden=t})})}))}static addLoadListener(e){"function"==typeof e&&listeners.push(e)}static removeLoadListener(e){let t=listeners.indexOf(e);-1!==t&&listeners.splice(t,1)}static get panels(){const e=[];for(let t in name2panel){name2panel[t].forEach(t=>{e.push(t)})}return e}static query(e){const t=name2panel[e];return t?0===t.length?t[0]:t:null}static queryAll(){return Object.keys(name2panel)}static load(e){const t=name2panel[e];t&&t.forEach(e=>{e.load()})}static close(e){const t=name2panel[e];t&&t.forEach(e=>{e.close(),e.isLoaded=!1})}constructor(){super(),this.isLoaded=!1,this.userData=Object.create(null),this.attachShadow({mode:"open"}),this.load(),this.addEventListener("focus",()=>{this.setAttribute("focused","");let e=document.createEvent("HTMLEvents");e.initEvent("panel-focus",!0,!0),this.dispatchEvent(e),operateRecord.name=this.name,operateRecord.time=Date.now(),ipc.send(`${ipcFlag}:focus`,this.name,process.pid)}),this.addEventListener("blur",e=>{if(!e.relatedTarget&&e.path[0]!==this)return void this.focus();this.removeAttribute("focused");let t=document.createEvent("HTMLEvents");t.initEvent("panel-blur",!0,!0),this.dispatchEvent(t),ipc.send(`${ipcFlag}:blur`,this.name,process.pid)}),this.addEventListener("mousedown",()=>{operateRecord.name===this.name&&0===operateRecord.time&&ipc.send(`${ipcFlag}:resume`,operateRecord.name,process.pid),operateRecord.name=this.name,operateRecord.time=Date.now()}),this.addEventListener("drop",()=>{let e=document.createEvent("HTMLEvents");e.initEvent("panel-drop",!0,!0),this.dispatchEvent(e)},!0)}get name(){return this.getAttribute("name")}set name(e){this.setAttribute("name",e)}connectedCallback(e){if(!(e=e||this.name))return;ipc.send(`${ipcFlag}:connected`,e,process.pid),this.setAttribute("tabindex","0"),e&&(name2panel[e]=name2panel[e]||[],-1===name2panel[e].indexOf(this)&&name2panel[e].push(this));let t=document.createEvent("HTMLEvents");t.initEvent("panel-ready",!0,!0),this.dispatchEvent(t)}disconnectedCallback(e){if(!(e=e||this.name))return;ipc.send(`${ipcFlag}:disconnected`,e,process.pid);const t=name2panel[e];if(!t)return;const n=t.indexOf(this);-1!==n&&(t.splice(n,1),0===t.length&&delete name2panel[e])}static get observedAttributes(){return["name","min-width","min-height","width","height","hidden"]}attributeChangedCallback(e,t,n){switch(e){case"name":this.isConnected&&(t&&this.disconnectedCallback(t),n&&this.connectedCallback(n)),updateName(this,t,n);break;case"hidden":let a=document.createEvent("HTMLEvents");a.initEvent(null===n?"show":"hide",!1,!1),this.dispatchEvent(a)}}query(e){return this.root.querySelector(e)}async close(e){let t=!0;try{t=!1!==await this.emit("beforeClose",{move:e})}catch(e){console.error(e),t=!1}if(this.isLoaded){if(this.isLoaded=!0,t){ipc.unregisterChannel(`${ipcFlag}:${this.name}`);try{await this.emit("close");let e=document.getElementById(`${this.name}-fonts`);e&&e.remove()}catch(e){console.error(e)}let e=document.createEvent("HTMLEvents");e.initEvent("panel-close",!0,!0),this.dispatchEvent(e),ipc.send(`${ipcFlag}:close`,this.name)}return t}}load(){this._loadLock||(this._loadLock=!0,requestAnimationFrame(async()=>{this._loadLock=!1;let e=ipc.sendSync(`${ipcFlag}:call`,"queryInfo",this.name);if(e)try{await loadPanel(this,e)}catch(e){console.error(e)}}))}setData(e,t){this.userData[e]=t}getData(e){return this.userData[e]}async emit(e,...t){if(!this.panel)return;let n=this.panel[e];return"function"==typeof n?new Promise(async(e,a)=>{let s;try{s=await n.call(this.option,...t)}catch(e){return console.error(e),a(e)}e(s)}):void 0}}module.exports=PanelFrame,ipc.on(`${ipcFlag}:exec`,async(e,t,n,...a)=>{const s=name2panel[t];if(!s||0===s.length)return;let i;for(let e=0;e<s.length;e++){const o=s[e];try{const e=o.option?o.option[n]:null;if(!e){console.warn(`Message does not exist: ${t}.${n}`);continue}(i=i||[]).push(new Promise(async(t,n)=>{try{t(await e.call(o.option,...a))}catch(e){e instanceof Error||(console.warn(e),e=new Error("The exception needs to be 'Error'\n  You have thrown a normal data in a message.\n  The exception needs to be an error object.")),n(e)}}))}catch(e){console.warn(e)}}try{if(!i)return e.reply(null);const t=await Promise.all(i);for(let n=0;n<t.length;n++)if(void 0!==t[n]&&null!==t[n])return e.reply(null,t[n]);return e.reply(null,t[0])}catch(t){return e.needCallback?e.reply(t):console.error(t)}});let loadPanel=function(e,t){if(e.isLoaded)return;let n;e.isLoaded=!0;try{"string"!=typeof(n=require(t.file)).template&&(n.template=""),"string"!=typeof n.style&&(n.style="")}catch(t){return t.message=`Panel[${e.name}] cannot be loaded - ${t.message}`,void console.error(t)}try{e.shadowRoot.innerHTML=n.template;let a=document.createElement("style");if(a.id="base-style",a.type="text/css",a.textContent=baseStyle+"\n"+customStyle,e.shadowRoot.insertBefore(a,e.shadowRoot.firstChild),n.style){let t=document.createElement("style");t.type="text/css",t.textContent=n.style,e.shadowRoot.insertBefore(t,a.nextSibling)}if(n.fonts&&Array.isArray(n.fonts)){let e=`${t.name}-fonts`,a=document.getElementById(e)||document.createElement("style");a.type="text/css",a.id=e,a.rel="stylesheet";let s="";n.fonts.forEach(e=>{s+="@font-face {\n",s+=`    font-family: "${e.name}";\n`,s+=`    src: url("${e.file}") format('woff');\n`,s+="}"}),a.textContent=s,a.parentElement||document.head.appendChild(a)}e.option={get hidden(){return e.hidden},get clientHeight(){return e.clientHeight},get clientWidth(){return e.clientWidth}};for(let t in n.methods)e.option[t]=n.methods[t];n.$&&(e.option.$=Object.create(null),Object.keys(n.$).forEach(t=>{let a=n.$[t];e.option.$[t]=e.shadowRoot.querySelector(a)})),n.listeners&&Object.keys(n.listeners).forEach(t=>{e.addEventListener(t,n.listeners[t].bind(e.option))}),e.panel=n,Object.keys(t.userData).forEach(n=>{e.setData(n,t.userData[n])})}catch(t){t.message=`Panel[${e.name}] cannot be loaded - ${t.message}`,console.error(t)}let a=document.createEvent("HTMLEvents");a.initEvent("load",!1,!1),e.dispatchEvent(a),ipc.registerChannel(`${ipcFlag}:${e.name}`);try{e.emit("ready",...t.args||[])}catch(e){console.error(e)}ipc.send(`${ipcFlag}:ready`,e.name);for(let n=0;n<listeners.length;n++){listeners[n].call(e,e,t.userData)}},updateName=function(e,t,n){if(n!==t){if(t){const n=name2panel[t],a=n.indexOf(e);-1!==a&&(n.splice(a,1),0===n.length&&delete name2panel[t])}e.load(),n&&(name2panel[n]=name2panel[n]||[],-1===name2panel[n].indexOf(e)&&name2panel[n].push(e))}};