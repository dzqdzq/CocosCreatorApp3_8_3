"use strict";const ipc=require("@base/electron-base-ipc"),windows=require("@base/electron-windows"),{EventEmitter:EventEmitter}=require("events"),pkg=require("../package.json"),ipcFlag=`${pkg.name}@${pkg.version}`,element=require("./element");try{window.customElements.define("panel-frame",element)}catch(e){console.warn(e)}const messageMap={};ipc.on(`${ipcFlag}:send-message-listener`,async(e,t,...n)=>{const r=messageMap[t];let l;try{l=await r(...n)}catch(t){return e.needCallback?void e.reply(new Error(`Message response error: ${t.message}`)):console.error(t)}e.reply(null,l)});class PanelManager extends EventEmitter{exec(e,t,...n){return ipc.send(`${ipcFlag}:call`,"exec",e,t,...n)}execWithoutReply(){ipc.send(`${ipcFlag}:call`,"execWithoutReply",name,method,...args)}queryInfo(e){return ipc.sendSync(`${ipcFlag}:call`,"queryInfo",e)}changeUserData(e,t){return ipc.sendSync(`${ipcFlag}:call`,"changeUserData",e,t)}query(e){return element.query(e)}queryAll(){return element.queryAll()}addLoadListener(e){element.addLoadListener(e)}removeLoadListener(e){element.removeLoadListener(e)}importStyle(e){element.importStyle(e)}getFocusPanel(){return ipc.sendSync(`${ipcFlag}:call`,"getFocusPanel")}}module.exports=new PanelManager,module.exports.on("register",e=>{element.load(e)}),module.exports.on("unregister",e=>{element.close(e)}),ipc.on(`${ipcFlag}:emit`,(e,t,...n)=>{module.exports.emit(t,...n)}),windows.on("close",async()=>{let e=element.panels;document.activeElement&&document.activeElement.blur&&document.activeElement.blur();for(let t=0;t<e.length;t++){let n=e[t];if(!n.parentElement)continue;let r=!0;try{r=!1!==await n.emit("beforeClose")}catch(e){console.error(e)}if(!r)return!1}for(let t=0;t<e.length;t++){let n=e[t];if(n.parentElement)try{await n.emit("close")}catch(e){console.log(e)}}return!0}),ipc.on(`${ipcFlag}:focus`,(e,t)=>{const n=element.query(t);if(!n||n.length<1)return;const r=n[0];r.hidden=!1,r.focus();const l=document.createEvent("HTMLEvents");l.initEvent("focus",!0,!0),r.dispatchEvent(l)}),ipc.on(`${ipcFlag}:blur`,(e,t)=>{const n=element.query(t);n&&n.forEach(e=>{e.blur();const t=document.createEvent("HTMLEvents");t.initEvent("blur",!0,!0),e.dispatchEvent(t)})});