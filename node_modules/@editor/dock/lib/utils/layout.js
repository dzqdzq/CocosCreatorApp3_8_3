"use stirct";const element=require("./element"),Resize=require("../renderer/element/dock-resize");let handler={minimize:e=>!!e,percent:e=>(e-=0,isNaN(e)&&(e=1),e),minHeight:e=>(e-=0,isNaN(e)&&(e=150),e),minWidth:e=>(e-=0,isNaN(e)&&(e=200),e),direction:e=>"column"===e||"row"===e?e:"none",children:e=>e&&Array.isArray(e)&&0!==e.length?e:null},completion=function(e){if(e.minimize=handler.minimize(e.minimize),e.percent=handler.percent(e.percent),e.direction=handler.direction(e.direction),e["min-height"]=handler.minHeight(e.minHeight),e["min-width"]=handler.minHeight(e.minWidth),e.children=handler.children(e.children),e.children&&e.children.length>0){let t=0,i=0,n=0;"column"===e.direction?i=e["min-width"]:"row"===e.direction&&(n=e["min-height"]),e.children.forEach(e=>{completion(e),e.minimize||(t+=e.percent)}),e.children.forEach(l=>{l.minimize||(l.percent/=t),"column"===e.direction?(i=Math.max(i,l["min-width"]),n+=l["min-height"]+Resize.line):"row"===e.direction&&(n=Math.max(n,l["min-height"]),i+=l["min-width"]+Resize.line)}),"column"===e.direction?n-=Resize.line:"row"===e.direction&&(i-=Resize.line),e["min-width"]=i,e["min-height"]=n}};class Snapshot{constructor(e,t){this.reference=t;let i=e.parentElement;this.$parent=i,this.offset=0,this.direction=i.direction,this.total="column"===this.direction?i.offsetHeight:i.offsetWidth,this.total-=Resize.line,this.nextSiblingList=[],this.prevSiblingList=[];let n=null;for(n=e;n.nextElementSibling;){if("DOCK-LAYOUT"!==(n=n.nextElementSibling).tagName){this.total-=Resize.line;continue}if(n.data.minimize){this.total-="column"===this.direction?n.offsetHeight:n.offsetWidth;continue}let e=parseFloat(n.style.flex);this.nextSiblingList.push({element:n,percent:e,current:"column"===this.direction?n.offsetHeight:n.offsetWidth,min:parseInt("column"===this.direction?n.style.minHeight:n.style.minWidth)})}for(n=e;n.previousElementSibling;){if("DOCK-LAYOUT"!==(n=n.previousElementSibling).tagName){this.total-=Resize.line;continue}if(n.data.minimize){this.total-="column"===this.direction?n.offsetHeight:n.offsetWidth;continue}let e=parseFloat(n.style.flex);this.prevSiblingList.push({element:n,percent:e,current:"column"===this.direction?n.offsetHeight:n.offsetWidth,min:parseInt("column"===this.direction?n.style.minHeight:n.style.minWidth)})}}translateNumber(){if(0===this.prevSiblingList.length||0===this.nextSiblingList.length)return;let e=this.total;this.prevSiblingList.forEach(t=>{let i=t.element,n=Math.ceil(t.current);e-=n,i.style.flex=`0 0  ${n}px`}),this.nextSiblingList.forEach(t=>{let i=t.element,n=Math.ceil(t.current);(e-=n)<0&&(n+=e),i.style.flex=`0 0  ${n}px`})}translatePercent(){0!==this.prevSiblingList.length&&0!==this.nextSiblingList.length&&(this.nextSiblingList.forEach(e=>{e.element.style.flex=`${e.percent}`}),this.prevSiblingList.forEach(e=>{e.element.style.flex=`${e.percent}`}))}move(e){if(0===this.prevSiblingList.length||0===this.nextSiblingList.length)return;let t,i,n="column"===this.direction?e.y-this.reference.y:e.x-this.reference.x;if(this.offset=n,n>0)t=n,i=[this.nextSiblingList,this.prevSiblingList];else{if(!(n<0))return;t=-n,i=[this.prevSiblingList,this.nextSiblingList]}i.forEach((e,i)=>{for(let n=0;n<e.length;n++){let l=e[n],r=l.current;0===i?r-=t:r+=t,r<l.min?(t=l.min-r,r=l.min,l.element.lock=!0,requestAnimationFrame(()=>{l.element.lock=!1;let e=document.createEvent("HTMLEvents");e.initEvent("move",!1,!1),l.element.dispatchEvent(e)})):t=0,l._num===r||l.element.lock||(l.element.lock=!0,requestAnimationFrame(()=>{l.element.lock=!1;let e=document.createEvent("HTMLEvents");e.initEvent("resize",!1,!1),l.element.dispatchEvent(e)})),l.element.style.flex=`0 0  ${r}px`,l._num=r}t=Math.abs(n)-t})}apply(){if(0===this.prevSiblingList.length||0===this.nextSiblingList.length)return;let e=this.total;this.nextSiblingList.forEach(t=>{t.current=t._num,t.percent=t.current/e,t.element.data.percent=t.percent}),this.prevSiblingList.forEach(t=>{t.current=t._num,t.percent=t.current/e,t.element.data.percent=t.percent}),element.emit(this.$parent)}}let _snapshotData=null,snapshot=function(e,t,i){(_snapshotData=new Snapshot(e,{x:t,y:i})).translateNumber()},dragLayout=function(e){_snapshotData.move(e)},clear=function(){_snapshotData.apply(),_snapshotData.translatePercent()};exports.completion=completion,exports.snapshot=snapshot,exports.dragLayout=dragLayout,exports.clear=clear;