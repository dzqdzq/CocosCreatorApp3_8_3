"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.queryMissingInfo=exports.importAssociatedAssets=exports.recursiveCheckAssociatedAssets=exports.recursiveGetAssociatedAssets=exports.getAssociatedAssets=exports.refresh=exports.reimport=exports.queryUUID=exports.queryPath=exports.queryUrl=exports.queryAsset=exports.get=exports.map=void 0;const utils_1=require("./utils"),dependency_1=require("./dependency"),path_1=require("path"),url_1=require("url");function get(t){return exports.map[t]||null}function queryAsset(t){if(t.startsWith("db://")){t=encodeURI(t);const e=(0,url_1.parse)(t);if(e.host&&exports.map[e.host]){const t=exports.map[e.host||""],s=(0,path_1.join)(t.options.target,decodeURIComponent((e.path||"")+(e.hash||""))).split("@");let r=t.path2asset.get(s[0]);for(;!r&&s.length>1;)s[0]+="@"+s[1],s.splice(1,1),r=t.path2asset.get(s[0]);for(let t=1;t<s.length;t++){let e=r.subAssets[s[t]];if(!e)return null;r=e}return r||null}return null}if((0,path_1.isAbsolute)(t)){for(let e in exports.map){const s=t.split("@"),r=exports.map[e];let o=r.path2asset.get(s[0]);for(;!o&&s.length>1;)s[0]+="@"+s[1],s.splice(1,1),o=r.path2asset.get(s[0]);if(o){let t=r.path2asset.get(s[0]);for(let e=1;e<s.length;e++){let r=t.subAssets[s[e]];if(!r)return null;t=r}return t||null}}return null}for(let e in exports.map){const s=exports.map[e].getAsset(t);if(s)return s}return null}function queryUrl(t){if((0,path_1.isAbsolute)(t)){for(let e in exports.map){const s=exports.map[e];if((0,utils_1.isSubPath)(t,s.options.target)){let r=(0,path_1.relative)(s.options.target,t);return`db://${e}/${r=r.replace(/\\/g,"/")}`}}return""}const e=t.split("@");for(let t in exports.map){const s=exports.map[t].getAsset(e[0]);if(s){let t=s.url;if(e.length>1)for(let s=1;s<e.length;s++)t+=`@${e[s]}`;return t}}return""}function queryPath(t){if(t.startsWith("db://")){t=encodeURI(t);const e=(0,url_1.parse)(t);if(e.host&&exports.map[e.host]){const t=exports.map[e.host||""];return(0,path_1.join)(t.options.target,decodeURIComponent((e.path||"")+(e.hash||"")))}return""}const e=t.split("@");for(let t in exports.map){let s=exports.map[t].uuidToPath(e[0]);if(s){if(e.length>1)for(let t=1;t<e.length;t++)s+=`@${e[t]}`;return s}}return""}function queryUUID(t){if(t.startsWith("db://")){t=encodeURI(t);const e=(0,url_1.parse)(t);if(e.host&&exports.map[e.host]){const t=exports.map[e.host||""],s=(0,path_1.join)(t.options.target,decodeURIComponent((e.path||"")+(e.hash||""))).split("@");let r=t.pathToUuid(s[0])||"";for(;!r&&s.length>1;)s[0]+="@"+s[1],s.splice(1,1),r=t.pathToUuid(s[0])||"";if(r&&s.length>1)for(let t=1;t<s.length;t++)r+=`@${s[t]}`;return r}return""}for(let e in exports.map){const s=exports.map[e],r=t.split("@");let o=s.pathToUuid(r[0])||"";for(;!o&&r.length>1;)r[0]+="@"+r[1],r.splice(1,1),o=s.pathToUuid(r[0])||"";if(o){if(r.length>1)for(let t=1;t<r.length;t++)o+=`@${r[t]}`;return o}}return""}async function reimport(t){if((0,path_1.isAbsolute)(t))for(let e in exports.map){const s=exports.map[e];if((0,utils_1.isSubPath)(t,s.options.target)){s.path2asset.get(t)&&await s.reimport(t);break}}else if(t.startsWith("db://")){t=encodeURI(t);const e=(0,url_1.parse)(t);if(e.host&&exports.map[e.host]){const t=exports.map[e.host||""],s=(0,path_1.join)(t.options.target,decodeURIComponent((e.path||"")+(e.hash||"")));t.path2asset.get(s)&&await t.reimport(s)}}else for(let e in exports.map){const s=exports.map[e];if(s.getAsset(t)){await s.reimport(t);break}}}async function refresh(t){if((0,path_1.isAbsolute)(t))for(let e in exports.map){const s=exports.map[e];if((0,utils_1.isSubPath)(t,s.options.target)){await s.refresh(t);break}}else if(t.startsWith("db://")){t=encodeURI(t);const e=(0,url_1.parse)(t);if(e.host&&exports.map[e.host]){const t=exports.map[e.host||""],s=(0,path_1.join)(t.options.target,decodeURIComponent((e.path||"")+(e.hash||"")));await t.refresh(s)}}else for(let e in exports.map){const s=exports.map[e],r=s.getAsset(t);if(r){await s.refresh(r.source);break}}}function getAssociatedAssets(t){const e=[],s=t=>{-1===e.indexOf(t)&&e.push(t)};return(0,dependency_1.getAssociatedFiles)(t.source).forEach(s),(0,dependency_1.getAssociatedFiles)(t.uuid).forEach(s),(0,dependency_1.getAssociatedFiles)(t.url).forEach(s),e}function recursiveGetAssociatedAssets(t,e){e(t);const s=getAssociatedAssets(t),r=[];return s.forEach(t=>{const s=queryAsset(t);s&&(e(s),r.push(...recursiveGetAssociatedAssets(s,e)))}),[...s,...r]}function recursiveCheckAssociatedAssets(t,e){return recursiveGetAssociatedAssets(e,function(e){e.source===t&&e.url===t&&e.uuid}),!0}function importAssociatedAssets(t,e){getAssociatedAssets(e).forEach(t=>{reimport(t)})}function queryMissingInfo(t){for(let e in exports.map){const s=exports.map[e].infoManager.getMissingInfo(t);if(s)return s}return null}exports.map={},exports.get=get,exports.queryAsset=queryAsset,exports.queryUrl=queryUrl,exports.queryPath=queryPath,exports.queryUUID=queryUUID,exports.reimport=reimport,exports.refresh=refresh,exports.getAssociatedAssets=getAssociatedAssets,exports.recursiveGetAssociatedAssets=recursiveGetAssociatedAssets,exports.recursiveCheckAssociatedAssets=recursiveCheckAssociatedAssets,exports.importAssociatedAssets=importAssociatedAssets,exports.queryMissingInfo=queryMissingInfo;