"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAssociatedFiles=exports.DependencyManager=void 0;const fs_extra_1=require("fs-extra"),associatedMap={};class DependencyManager{constructor(e){this.dependMap={},this._saveTimer=null,this.console=e||console}async setRecordJSON(e){if(this.file=e,(0,fs_extra_1.existsSync)(e))try{this.dependMap=(0,fs_extra_1.readJSONSync)(this.file)}catch(e){this.console.error(e),this.dependMap={}}else this.dependMap={};for(let e in this.dependMap){const s=this.dependMap[e];for(let e in s){s[e].forEach(s=>{associatedMap[s]=associatedMap[s]||[],-1===associatedMap[s].indexOf(e)&&associatedMap[s].push(e)})}}}save(){clearTimeout(this._saveTimer),this._saveTimer=setTimeout(()=>{this.saveImmediate()},400)}saveImmediate(){clearTimeout(this._saveTimer),this.file&&(0,fs_extra_1.outputJSONSync)(this.file,this.dependMap,{spaces:2})}add(e,s,a){const t=this.dependMap[e]=this.dependMap[e]||{},i=t[s]=t[s]||[];Array.isArray(a)||(a=[a]),a.forEach(e=>{if(e&&-1!==i.indexOf(e))return;i.push(e);const a=associatedMap[e]=associatedMap[e]||[];-1===a.indexOf(s)&&a.push(s)}),this.save()}remove(e,s){this.dependMap[e]&&this.dependMap[e][s]&&(this.dependMap[e][s].forEach(e=>{const a=associatedMap[e],t=a.indexOf(s);-1!==t&&a.splice(t,1),0===a.length&&delete associatedMap[e]}),delete this.dependMap[e][s],this.save())}destroy(){for(let e in this.dependMap){const s=this.dependMap[e];for(let e in s){s[e].forEach(s=>{if(!associatedMap[s])return;const a=associatedMap[s].indexOf(e);-1!==a&&associatedMap[s].splice(a,1),0===associatedMap[s].length&&delete associatedMap[s]})}}}}function getAssociatedFiles(e){return associatedMap[e]||[]}exports.DependencyManager=DependencyManager,exports.getAssociatedFiles=getAssociatedFiles;