"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.InfoManager=void 0;const fs_extra_1=require("fs-extra");class InfoManager{constructor(e){this.recordInfo={version:InfoManager.version,map:{},missing:{}},this._saveTimer=null,this.console=e||console}setRecordJSON(e){if(this.file=e.replace(".json",`${InfoManager.version}.json`),(0,fs_extra_1.existsSync)(this.file))try{const e=(0,fs_extra_1.readJSONSync)(this.file);this.loadRecordJson(e)}catch(e){this.console.error(e)}else if((0,fs_extra_1.existsSync)(e))try{const s=(0,fs_extra_1.readJSONSync)(e);this.loadRecordJson(s),(0,fs_extra_1.outputJSONSync)(this.file,this.recordInfo,{spaces:2})}catch(e){this.console.error(e)}}loadRecordJson(e){e.version?this.recordInfo=e:Object.keys(e).forEach(s=>{const i=e[s];i.missing?(delete i.missing,i.uuid&&(this.recordInfo.missing[i.uuid]={path:s,time:i.time,removeTime:Date.now()})):(delete i.missing,this.recordInfo.map[s]=i)})}destroy(){this.recordInfo.map={},this.recordInfo.missing={}}save(){this._saveTimer&&clearTimeout(this._saveTimer),this._saveTimer=setTimeout(()=>{this.saveImmediate()},400)}saveImmediate(){this._saveTimer&&clearTimeout(this._saveTimer),this.file&&(0,fs_extra_1.outputJSONSync)(this.file,this.recordInfo,{spaces:2})}add(e,s,i){this.recordInfo.map[e]&&this.recordInfo.map[e].uuid===i&&this.recordInfo.map[e].time===s||(this.recordInfo.map[e]=i?{time:s,uuid:i}:{time:s},this.save())}remove(e){if(!this.recordInfo.map[e])return;const s=this.recordInfo.map[e];this.addMissing(e,s),delete this.recordInfo.map[e],this.save()}get(e){return this.recordInfo.map[e]||null}addMissing(e,s){s.uuid&&(this.recordInfo.missing[s.uuid]={path:e,time:s.time,removeTime:Date.now()})}getMissingInfo(e){return this.recordInfo.missing[e]||null}compare(e,s){const i=this.recordInfo.map[e];return!!i&&i.time===s}async forEach(e){for(const s in this.recordInfo.map)await e(s,this.recordInfo.map[s])}}exports.InfoManager=InfoManager,InfoManager.version="1.0.0";