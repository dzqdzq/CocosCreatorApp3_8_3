"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Executor = void 0;
const path_1 = __importDefault(require("path"));
const editor_systemjs_1 = require("../editor-systemjs");
const url_1 = require("url");
const loader_1 = require("@cocos/creator-programming-quick-pack/lib/loader");
const pack_mod_instantiation_1 = require("./pack-mod-instantiation");
// `'cc'` 的 URL
const engineIndexURL = `cce:/internal/x/cc`;
// 引擎功能单元模块的 URL 前缀
const engineFeatureUnitsPrefix = `cce:/internal/x/cc-fu/`;
// 引擎公开至编辑器的模块的 URL 前缀
const engineExportToEditorPrefix = `cce:/internal/x/engine-export-to-editor/`;
// 编辑器公开给项目的模块的 URL 前缀
const editorExportToProjectPrefix = `cce:/internal/x/editor-export-to-project/`;
// 项目路径相关 URL 前缀
const projectUrlPrefix = 'cce:/internal/x/project/';
const packResourceBaseURL = new url_1.URL('pack:///');
const defaultImportExceptionHandler = (err) => {
    console.warn(err);
};
class Executor {
    constructor(quickPackLoaderContext, packModuleEvaluator, importExceptionHandler) {
        this._cachedExceptions = new Map();
        this._classUuidMap = {};
        this._builtinMods = {};
        this._modules = Object.create(null);
        this._registeredClasses = [];
        this._plugins = [];
        this._fixedImportMap = { imports: {} };
        this._engineImportMapURL = '';
        this._instantiatedPackMods = [];
        this._cceModuleMap = {};
        this._editorSystem = editor_systemjs_1.globalEditorSystem;
        this._logger = {};
        const quickPackLoader = new loader_1.QuickPackLoader(quickPackLoaderContext);
        this._packLoader = quickPackLoader;
        this._packModInstantiation = new pack_mod_instantiation_1.PackModInstantiation(quickPackLoader, this._editorSystem, packModuleEvaluator);
        this._importExceptionHandler = importExceptionHandler !== null && importExceptionHandler !== void 0 ? importExceptionHandler : defaultImportExceptionHandler;
    }
    static async create(options) {
        if (Executor._inst) {
            return Executor._inst;
        }
        const executor = Executor._inst = new Executor(options.quickPackLoaderContext, options.packModuleEvaluator, options.importExceptionHandler);
        await executor._initialize(options);
        return executor;
    }
    async _initialize(options) {
        if (options.beforeUnregisterClass) {
            this._beforeUnregisterClass = options.beforeUnregisterClass;
        }
        this._addInstantiationHandlers(options.importEngineMod);
        this._cceModuleMap = options.cceModuleMap;
        this._fixedImportMap.imports['cc'] = engineIndexURL;
        this._fixedImportMap.imports['cc/env'] = `${engineExportToEditorPrefix}cc/editor/populate-internal-constants`;
        // TODO: deprecated cce.env is only live in 3.0-preview
        this._fixedImportMap.imports['cce.env'] = this._fixedImportMap.imports['cc/env'];
        const projectCustomMacroURL = new url_1.URL('./temp/programming/custom-macro.js', projectUrlPrefix);
        this._fixedImportMap.imports['cc/userland/macro'] = projectCustomMacroURL.href;
        for (const [moduleName, moduleConfig] of Object.entries(this._cceModuleMap)) {
            if (moduleName === 'mapLocation') {
                continue;
            }
            this._fixedImportMap.imports[moduleName] = `${editorExportToProjectPrefix}${moduleName}`;
        }
        const venderOnLoad = System.constructor.prototype.onload;
        const self = this;
        System.constructor.prototype.onload = function (...args) {
            self._onModuleLoaded(...args);
            if (typeof venderOnLoad === 'function') {
                venderOnLoad.apply(this, arguments);
            }
        };
        this._logger = options.logger || {};
    }
    _addInstantiationHandlers(importer) {
        // 处理项目里的自定义配置模块，比如 custom-macro 模块
        this._editorSystem.addInstantiationHandler((url) => {
            if (url.startsWith(projectUrlPrefix)) {
                let quickCompilerRequest = url.substr(projectUrlPrefix.length);
                quickCompilerRequest = path_1.default.join(Editor.Project.path, quickCompilerRequest);
                require(quickCompilerRequest);
                return this._editorSystem.getRegister();
            }
        });
        // 处理引擎模块的实例化
        this._editorSystem.addInstantiationHandler(async (url) => {
            let quickCompilerRequest = '';
            if (url.startsWith(engineFeatureUnitsPrefix)) {
                quickCompilerRequest = url;
            }
            else if (url.startsWith(engineExportToEditorPrefix)) {
                quickCompilerRequest = url.substr(engineExportToEditorPrefix.length);
            }
            if (quickCompilerRequest) {
                return [[], (_export) => {
                        return {
                            execute: async () => {
                                const exports = await importer(quickCompilerRequest);
                                _export(exports);
                            },
                        };
                    }];
            }
        });
        // 处理 Packer 里的模块的实例化
        const packResourceBaseURLString = packResourceBaseURL.href;
        this._editorSystem.addInstantiationHandler(async (url) => {
            if (url.startsWith(packResourceBaseURLString)) {
                const link = url.slice(packResourceBaseURLString.length);
                const register = await this._packModInstantiation.instantiate(link);
                this._instantiatedPackMods.push(url);
                return register;
            }
        });
        this._editorSystem.addInstantiationHandler(async (url) => {
            if (url.startsWith(editorExportToProjectPrefix)) {
                const moduleName = url.slice(editorExportToProjectPrefix.length);
                const moduleConfig = this._cceModuleMap[moduleName];
                const mapLocation = this._cceModuleMap.mapLocation;
                if (moduleConfig) {
                    const exportedObj = require(path_1.default.join(path_1.default.dirname(mapLocation), moduleConfig.main));
                    return [[], (_export) => {
                            return {
                                execute: async () => {
                                    _export(exportedObj);
                                },
                            };
                        }];
                }
            }
        });
    }
    addPolyfillFile(file) {
        require(file);
    }
    async prepare() {
        await this._reloadPackMods();
    }
    async import(url) {
        return await this._editorSystem.import(url);
    }
    /**
     * 重新读取 Packer 的内容并重新执行所有项目脚本和插件脚本。
     */
    async reload() {
        const onClassRegistered = (classConstructor, metadata) => {
            var _a;
            var _b, _c;
            this._registeredClasses.push(classConstructor);
            console.debug(`[[Executor]] Register ${classConstructor.name}`);
            if (metadata) {
                ((_a = (_b = this._classUuidMap)[_c = metadata.uuid]) !== null && _a !== void 0 ? _a : (_b[_c] = [])).push(classConstructor);
            }
        };
        EditorExtends.on('class-registered', onClassRegistered);
        try {
            await this._reloadPackMods();
            console.groupCollapsed(`Invalidate all modules`);
            await this._invalidateAllModules();
            console.groupEnd();
            this._invalidateAllPlugins();
            this._loadAllPlugins();
            console.groupCollapsed(`Imports all modules`);
            await this._importPrerequisiteModules();
            console.groupEnd();
        }
        catch (e) {
            console.error(`Executor failed to reload.`, e);
            throw e;
        }
        finally {
            EditorExtends.removeListener('class-registered', onClassRegistered);
        }
    }
    async hotReloadPluginScripts(info) {
        if (info) {
            if (Object.keys(info.changes).length === 0 && info.removals.length === 0) {
                return;
            }
        }
        this._invalidateAllPlugins();
        if (info) {
            for (let i = 0; i < this._plugins.length; i++) {
                const plugin = this._plugins[i];
                // 应用修改
                if (info.removals.includes(plugin.uuid)) {
                    this._plugins.splice(i, 1);
                    i--;
                }
                if (info.changes[plugin.uuid]) {
                    Object.assign(plugin, info.changes[plugin.uuid]);
                }
            }
        }
        await this._loadAllPlugins();
    }
    isModule(id) {
        return id in this._modules;
    }
    async clear() {
        this._invalidateAllPlugins();
        this._plugins = [];
        await this._invalidateAllModules();
    }
    setPluginScripts(plugins) {
        this._invalidateAllPlugins();
        this._plugins = plugins;
    }
    /**
     * 查找指定脚本模块中注册的所有 cc 类。
     * @param uuid 模块的 uuid。
     * @returns 指定脚本模块中注册的所有 cc 类；如果 [uuid] 并不对应一个模块或模块中未注册任何类则返回 `undefined`。
     */
    queryClassesInModule(uuid) {
        return this._classUuidMap[uuid];
    }
    async _reloadPackMods() {
        // 多进程操作同一个资源。如果不给文件加锁，会导致文件读写冲突
        await this._packModInstantiation.lock();
        await this._packModInstantiation.reload();
        this._editorSystem.clearImportMap();
        const quickPackLoaderImportMap = await this._packModInstantiation.getImportMap();
        this._editorSystem.extendImportMap(quickPackLoaderImportMap, new url_1.URL(this._packLoader.importMapURL, packResourceBaseURL).href);
        await this._packModInstantiation.unlock();
        this._editorSystem.extendImportMap(this._fixedImportMap, this._engineImportMapURL);
        const resolutionDetailMap = await this._packLoader.loadResolutionDetailMap();
        this._editorSystem.setResolutionDetailMap(resolutionDetailMap, new url_1.URL(this._packLoader.resolutionDetailMapURL, packResourceBaseURL).href);
    }
    async _invalidateAllModules() {
        const cc = await System.import('cc');
        for (const registeredClass of this._registeredClasses) {
            if (this._beforeUnregisterClass) {
                this._beforeUnregisterClass(registeredClass);
            }
            cc.js.unregisterClass(registeredClass);
            console.debug(`Unregister ${registeredClass.name}`);
        }
        this._registeredClasses = [];
        this._classUuidMap = {};
        cc.cclegacy._RF.reset();
        this._invalidateAllPackMods();
    }
    _invalidateAllPackMods() {
        for (const packModId of this._instantiatedPackMods) {
            console.debug(`Invalidating '${packModId}'`);
            const result = System.delete(packModId);
            if (result === false) {
                console.debug(`Note: failed to delete ${packModId}, maybe it's being executing?`);
            }
        }
        this._instantiatedPackMods.length = 0;
    }
    async _importPrerequisiteModules() {
        const cc = await System.import('cc');
        try {
            await System.import('cce:/internal/x/prerequisite-imports');
        }
        catch (err) {
            this._importExceptionHandler(err);
        }
        finally {
            this._cachedExceptions.clear();
            // 项目脚本可能在执行的时候会抛出异常，这导致 `cc._RF` 没有正确弹出。
            // 我们在最后清理一下。
            cc.cclegacy._RF.reset();
        }
    }
    async _loadAllPlugins() {
        const sortedMapped = this._plugins.map((pluginScript) => pluginScript.file);
        for (const file of sortedMapped) {
            try {
                require(file);
            }
            catch (error) {
                console.error(error);
            }
        }
    }
    _invalidateAllPlugins() {
        for (const [, pluginScriptInfo] of Object.entries(this._plugins)) {
            delete require.cache[pluginScriptInfo.file];
        }
    }
    _tryLog(cat, ...args) {
        // @ts-ignore
        return (cat in this._logger) ? this._logger[cat](...args) : this._defaultLog(...args);
    }
    _defaultLog(...args) {
        console.log(...args);
    }
    _onModuleLoaded(error, id) {
        const cachedExceptions = this._cachedExceptions;
        if (!error) {
            console.debug(`[[Executor]] Module "${id}" loaded.`);
        }
        else {
            if (!cachedExceptions.has(error)) {
                this._importExceptionHandler(error);
            }
            this._tryLog('loadException', id, error, cachedExceptions.has(error));
            cachedExceptions.set(error, id);
        }
    }
}
exports.Executor = Executor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZXhlY3V0b3IvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsZ0RBQXNCO0FBQ3RCLHdEQUF3RTtBQUN4RSw2QkFBMEI7QUFFMUIsNkVBQW1GO0FBQ25GLHFFQUFxRjtBQUlyRixlQUFlO0FBQ2YsTUFBTSxjQUFjLEdBQUcsb0JBQW9CLENBQUM7QUFDNUMsbUJBQW1CO0FBQ25CLE1BQU0sd0JBQXdCLEdBQUcsd0JBQXdCLENBQUM7QUFDMUQsc0JBQXNCO0FBQ3RCLE1BQU0sMEJBQTBCLEdBQUcsMENBQTBDLENBQUM7QUFDOUUsc0JBQXNCO0FBQ3RCLE1BQU0sMkJBQTJCLEdBQUcsMkNBQTJDLENBQUM7QUFDaEYsZ0JBQWdCO0FBQ2hCLE1BQU0sZ0JBQWdCLEdBQUcsMEJBQTBCLENBQUM7QUFFcEQsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLFNBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUloRCxNQUFNLDZCQUE2QixHQUEyQixDQUFDLEdBQVksRUFBRSxFQUFFO0lBQzNFLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDdEIsQ0FBQyxDQUFDO0FBYUYsTUFBYSxRQUFRO0lBZWpCLFlBQ0ksc0JBQXFDLEVBQ3JDLG1CQUFvRCxFQUNwRCxzQkFBMEQ7UUFzVHRELHNCQUFpQixHQUFxQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2hELGtCQUFhLEdBQStCLEVBQUUsQ0FBQztRQUUvQyxpQkFBWSxHQUEyQixFQUFFLENBQUM7UUFLMUMsYUFBUSxHQUFxQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pFLHVCQUFrQixHQUFlLEVBQUUsQ0FBQztRQUVwQyxhQUFRLEdBQXVCLEVBQUUsQ0FBQztRQUVsQyxvQkFBZSxHQUF3QyxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsQ0FBQztRQUN2RSx3QkFBbUIsR0FBRyxF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QUFJLENBQUMsS0FBSyxFQUFFO1lBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsRUFBRSxXQUFXLENBQUMsQ0FBQztTQUN4RDthQUFNO1lBQ0gsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDOUIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ3ZDO1lBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUN0RSxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQ25DO0lBQ0wsQ0FBQztDQXdCSjtBQTNWRCw0QkEyVkMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCBwcyBmcm9tICdwYXRoJztcbmltcG9ydCB7IEV4ZWN1dG9yU3lzdGVtLCBnbG9iYWxFZGl0b3JTeXN0ZW0gfSBmcm9tICcuLi9lZGl0b3Itc3lzdGVtanMnO1xuaW1wb3J0IHsgVVJMIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IExvYWRlckNvbnRleHQgfSBmcm9tICdAY29jb3MvY3JlYXRvci1wcm9ncmFtbWluZy1xdWljay1wYWNrL2xpYi91dGlscy9sb2FkZXItY29udGV4dCc7XG5pbXBvcnQgeyBRdWlja1BhY2tMb2FkZXIgfSBmcm9tICdAY29jb3MvY3JlYXRvci1wcm9ncmFtbWluZy1xdWljay1wYWNrL2xpYi9sb2FkZXInO1xuaW1wb3J0IHsgUGFja01vZEluc3RhbnRpYXRpb24sIFBhY2tNb2R1bGVFdmFsdWF0b3IgfSBmcm9tICcuL3BhY2stbW9kLWluc3RhbnRpYXRpb24nO1xuXG50eXBlIEltcG9ydEVuZ2luZU1vZCA9IChpZDogc3RyaW5nKSA9PiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiB8IFByb21pc2U8UmVjb3JkPHN0cmluZywgdW5rbm93bj4+O1xuXG4vLyBgJ2NjJ2Ag55qEIFVSTFxuY29uc3QgZW5naW5lSW5kZXhVUkwgPSBgY2NlOi9pbnRlcm5hbC94L2NjYDtcbi8vIOW8leaTjuWKn+iDveWNleWFg+aooeWdl+eahCBVUkwg5YmN57yAXG5jb25zdCBlbmdpbmVGZWF0dXJlVW5pdHNQcmVmaXggPSBgY2NlOi9pbnRlcm5hbC94L2NjLWZ1L2A7XG4vLyDlvJXmk47lhazlvIDoh7PnvJbovpHlmajnmoTmqKHlnZfnmoQgVVJMIOWJjee8gFxuY29uc3QgZW5naW5lRXhwb3J0VG9FZGl0b3JQcmVmaXggPSBgY2NlOi9pbnRlcm5hbC94L2VuZ2luZS1leHBvcnQtdG8tZWRpdG9yL2A7XG4vLyDnvJbovpHlmajlhazlvIDnu5npobnnm67nmoTmqKHlnZfnmoQgVVJMIOWJjee8gFxuY29uc3QgZWRpdG9yRXhwb3J0VG9Qcm9qZWN0UHJlZml4ID0gYGNjZTovaW50ZXJuYWwveC9lZGl0b3ItZXhwb3J0LXRvLXByb2plY3QvYDtcbi8vIOmhueebrui3r+W+hOebuOWFsyBVUkwg5YmN57yAXG5jb25zdCBwcm9qZWN0VXJsUHJlZml4ID0gJ2NjZTovaW50ZXJuYWwveC9wcm9qZWN0Lyc7XG5cbmNvbnN0IHBhY2tSZXNvdXJjZUJhc2VVUkwgPSBuZXcgVVJMKCdwYWNrOi8vLycpO1xuXG50eXBlIEltcG9ydEV4Y2VwdGlvbkhhbmRsZXIgPSAoZXJyOiB1bmtub3duKSA9PiB2b2lkO1xuXG5jb25zdCBkZWZhdWx0SW1wb3J0RXhjZXB0aW9uSGFuZGxlcjogSW1wb3J0RXhjZXB0aW9uSGFuZGxlciA9IChlcnI6IHVua25vd24pID0+IHtcbiAgICBjb25zb2xlLndhcm4oZXJyKTtcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVBsdWdpbkNoYW5nZWRJbmZvIHtcbiAgICAvKipcbiAgICAgKiDmiYDmnInopoHkv67mlLnnmoTvvIjmiJbmlrDlop7nmoTvvInmj5Lku7bohJrmnKzjgIJcbiAgICAgKi9cbiAgICBjaGFuZ2VzOiBSZWNvcmQ8UGx1Z2luU2NyaXB0SWQsIFBsdWdpblNjcmlwdEluZm8+XG4gICAgLyoqXG4gICAgICog5omA5pyJ6KaB56e76Zmk55qE5o+S5Lu26ISa5pys44CCXG4gICAgICovXG4gICAgcmVtb3ZhbHM6IFBsdWdpblNjcmlwdElkW107XG59XG5cbmV4cG9ydCBjbGFzcyBFeGVjdXRvciB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgX2luc3Q6IEV4ZWN1dG9yO1xuICAgIHB1YmxpYyBzdGF0aWMgYXN5bmMgY3JlYXRlKG9wdGlvbnM6IEV4ZWN1dG9yLk9wdGlvbnMpIHtcbiAgICAgICAgaWYgKEV4ZWN1dG9yLl9pbnN0KSB7XG4gICAgICAgICAgICByZXR1cm4gRXhlY3V0b3IuX2luc3Q7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZXhlY3V0b3IgPSBFeGVjdXRvci5faW5zdCA9IG5ldyBFeGVjdXRvcihcbiAgICAgICAgICAgIG9wdGlvbnMucXVpY2tQYWNrTG9hZGVyQ29udGV4dCxcbiAgICAgICAgICAgIG9wdGlvbnMucGFja01vZHVsZUV2YWx1YXRvcixcbiAgICAgICAgICAgIG9wdGlvbnMuaW1wb3J0RXhjZXB0aW9uSGFuZGxlcixcbiAgICAgICAgKTtcbiAgICAgICAgYXdhaXQgZXhlY3V0b3IuX2luaXRpYWxpemUob3B0aW9ucyk7XG4gICAgICAgIHJldHVybiBleGVjdXRvcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbnN0cnVjdG9yKFxuICAgICAgICBxdWlja1BhY2tMb2FkZXJDb250ZXh0OiBMb2FkZXJDb250ZXh0LFxuICAgICAgICBwYWNrTW9kdWxlRXZhbHVhdG9yOiBQYWNrTW9kdWxlRXZhbHVhdG9yIHwgdW5kZWZpbmVkLFxuICAgICAgICBpbXBvcnRFeGNlcHRpb25IYW5kbGVyOiBJbXBvcnRFeGNlcHRpb25IYW5kbGVyIHwgdW5kZWZpbmVkLFxuICAgICkge1xuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0gPSBnbG9iYWxFZGl0b3JTeXN0ZW07XG4gICAgICAgIHRoaXMuX2xvZ2dlciA9IHt9O1xuXG4gICAgICAgIGNvbnN0IHF1aWNrUGFja0xvYWRlciA9IG5ldyBRdWlja1BhY2tMb2FkZXIocXVpY2tQYWNrTG9hZGVyQ29udGV4dCk7XG4gICAgICAgIHRoaXMuX3BhY2tMb2FkZXIgPSBxdWlja1BhY2tMb2FkZXI7XG4gICAgICAgIHRoaXMuX3BhY2tNb2RJbnN0YW50aWF0aW9uID0gbmV3IFBhY2tNb2RJbnN0YW50aWF0aW9uKHF1aWNrUGFja0xvYWRlciwgdGhpcy5fZWRpdG9yU3lzdGVtLCBwYWNrTW9kdWxlRXZhbHVhdG9yKTtcblxuICAgICAgICB0aGlzLl9pbXBvcnRFeGNlcHRpb25IYW5kbGVyID0gaW1wb3J0RXhjZXB0aW9uSGFuZGxlciA/PyBkZWZhdWx0SW1wb3J0RXhjZXB0aW9uSGFuZGxlcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9pbml0aWFsaXplKG9wdGlvbnM6IEV4ZWN1dG9yLk9wdGlvbnMpIHtcbiAgICAgICAgaWYgKG9wdGlvbnMuYmVmb3JlVW5yZWdpc3RlckNsYXNzKSB7XG4gICAgICAgICAgICB0aGlzLl9iZWZvcmVVbnJlZ2lzdGVyQ2xhc3MgPSBvcHRpb25zLmJlZm9yZVVucmVnaXN0ZXJDbGFzcztcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2FkZEluc3RhbnRpYXRpb25IYW5kbGVycyhvcHRpb25zLmltcG9ydEVuZ2luZU1vZCk7XG5cbiAgICAgICAgdGhpcy5fY2NlTW9kdWxlTWFwID0gb3B0aW9ucy5jY2VNb2R1bGVNYXA7XG4gICAgICAgIHRoaXMuX2ZpeGVkSW1wb3J0TWFwLmltcG9ydHNbJ2NjJ10gPSBlbmdpbmVJbmRleFVSTDtcbiAgICAgICAgdGhpcy5fZml4ZWRJbXBvcnRNYXAuaW1wb3J0c1snY2MvZW52J10gPSBgJHtlbmdpbmVFeHBvcnRUb0VkaXRvclByZWZpeH1jYy9lZGl0b3IvcG9wdWxhdGUtaW50ZXJuYWwtY29uc3RhbnRzYDtcbiAgICAgICAgLy8gVE9ETzogZGVwcmVjYXRlZCBjY2UuZW52IGlzIG9ubHkgbGl2ZSBpbiAzLjAtcHJldmlld1xuICAgICAgICB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjY2UuZW52J10gPSB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjYy9lbnYnXTtcbiAgICAgICAgY29uc3QgcHJvamVjdEN1c3RvbU1hY3JvVVJMID0gbmV3IFVSTCgnLi90ZW1wL3Byb2dyYW1taW5nL2N1c3RvbS1tYWNyby5qcycsIHByb2plY3RVcmxQcmVmaXgpO1xuICAgICAgICB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjYy91c2VybGFuZC9tYWNybyddID0gcHJvamVjdEN1c3RvbU1hY3JvVVJMLmhyZWY7XG5cbiAgICAgICAgZm9yIChjb25zdCBbbW9kdWxlTmFtZSwgbW9kdWxlQ29uZmlnXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLl9jY2VNb2R1bGVNYXApKSB7XG4gICAgICAgICAgICBpZiAobW9kdWxlTmFtZSA9PT0gJ21hcExvY2F0aW9uJykge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5fZml4ZWRJbXBvcnRNYXAuaW1wb3J0c1ttb2R1bGVOYW1lXSA9IGAke2VkaXRvckV4cG9ydFRvUHJvamVjdFByZWZpeH0ke21vZHVsZU5hbWV9YDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHZlbmRlck9uTG9hZCA9IFN5c3RlbS5jb25zdHJ1Y3Rvci5wcm90b3R5cGUub25sb2FkO1xuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICAgICAgU3lzdGVtLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5vbmxvYWQgPSBmdW5jdGlvbiAoLi4uYXJnczogUGFyYW1ldGVyczxFeGVjdXRvclsnX29uTW9kdWxlTG9hZGVkJ10+KSB7XG4gICAgICAgICAgICBzZWxmLl9vbk1vZHVsZUxvYWRlZCguLi5hcmdzKTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdmVuZGVyT25Mb2FkID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgdmVuZGVyT25Mb2FkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5fbG9nZ2VyID0gb3B0aW9ucy5sb2dnZXIgfHwge307XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfYWRkSW5zdGFudGlhdGlvbkhhbmRsZXJzKGltcG9ydGVyOiBJbXBvcnRFbmdpbmVNb2QpIHtcbiAgICAgICAgLy8g5aSE55CG6aG555uu6YeM55qE6Ieq5a6a5LmJ6YWN572u5qih5Z2X77yM5q+U5aaCIGN1c3RvbS1tYWNybyDmqKHlnZdcbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLmFkZEluc3RhbnRpYXRpb25IYW5kbGVyKCh1cmwpID0+IHtcbiAgICAgICAgICAgIGlmICh1cmwuc3RhcnRzV2l0aChwcm9qZWN0VXJsUHJlZml4KSkge1xuICAgICAgICAgICAgICAgIGxldCBxdWlja0NvbXBpbGVyUmVxdWVzdCA9IHVybC5zdWJzdHIocHJvamVjdFVybFByZWZpeC5sZW5ndGgpO1xuICAgICAgICAgICAgICAgIHF1aWNrQ29tcGlsZXJSZXF1ZXN0ID0gcHMuam9pbihFZGl0b3IuUHJvamVjdC5wYXRoLCBxdWlja0NvbXBpbGVyUmVxdWVzdCk7XG4gICAgICAgICAgICAgICAgcmVxdWlyZShxdWlja0NvbXBpbGVyUmVxdWVzdCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VkaXRvclN5c3RlbS5nZXRSZWdpc3RlcigpIGFzIE1vZHVsZVJlZ2lzdGVyO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgLy8g5aSE55CG5byV5pOO5qih5Z2X55qE5a6e5L6L5YyWXG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbS5hZGRJbnN0YW50aWF0aW9uSGFuZGxlcihhc3luYyAodXJsKSA9PiB7XG4gICAgICAgICAgICBsZXQgcXVpY2tDb21waWxlclJlcXVlc3QgPSAnJztcbiAgICAgICAgICAgIGlmICh1cmwuc3RhcnRzV2l0aChlbmdpbmVGZWF0dXJlVW5pdHNQcmVmaXgpKSB7XG4gICAgICAgICAgICAgICAgcXVpY2tDb21waWxlclJlcXVlc3QgPSB1cmw7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHVybC5zdGFydHNXaXRoKGVuZ2luZUV4cG9ydFRvRWRpdG9yUHJlZml4KSkge1xuICAgICAgICAgICAgICAgIHF1aWNrQ29tcGlsZXJSZXF1ZXN0ID0gdXJsLnN1YnN0cihlbmdpbmVFeHBvcnRUb0VkaXRvclByZWZpeC5sZW5ndGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHF1aWNrQ29tcGlsZXJSZXF1ZXN0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFtbXSwgKF9leHBvcnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWN1dGU6IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBleHBvcnRzID0gYXdhaXQgaW1wb3J0ZXIocXVpY2tDb21waWxlclJlcXVlc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9leHBvcnQoZXhwb3J0cyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH1dO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyDlpITnkIYgUGFja2VyIOmHjOeahOaooeWdl+eahOWunuS+i+WMllxuICAgICAgICBjb25zdCBwYWNrUmVzb3VyY2VCYXNlVVJMU3RyaW5nID0gcGFja1Jlc291cmNlQmFzZVVSTC5ocmVmO1xuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uYWRkSW5zdGFudGlhdGlvbkhhbmRsZXIoYXN5bmMgKHVybCkgPT4ge1xuICAgICAgICAgICAgaWYgKHVybC5zdGFydHNXaXRoKHBhY2tSZXNvdXJjZUJhc2VVUkxTdHJpbmcpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbGluayA9IHVybC5zbGljZShwYWNrUmVzb3VyY2VCYXNlVVJMU3RyaW5nLmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVnaXN0ZXIgPSBhd2FpdCB0aGlzLl9wYWNrTW9kSW5zdGFudGlhdGlvbi5pbnN0YW50aWF0ZShsaW5rKTtcbiAgICAgICAgICAgICAgICB0aGlzLl9pbnN0YW50aWF0ZWRQYWNrTW9kcy5wdXNoKHVybCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlZ2lzdGVyO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uYWRkSW5zdGFudGlhdGlvbkhhbmRsZXIoYXN5bmMgKHVybCkgPT4ge1xuICAgICAgICAgICAgaWYgKHVybC5zdGFydHNXaXRoKGVkaXRvckV4cG9ydFRvUHJvamVjdFByZWZpeCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtb2R1bGVOYW1lID0gdXJsLnNsaWNlKGVkaXRvckV4cG9ydFRvUHJvamVjdFByZWZpeC5sZW5ndGgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG1vZHVsZUNvbmZpZyA9IHRoaXMuX2NjZU1vZHVsZU1hcFttb2R1bGVOYW1lXTtcbiAgICAgICAgICAgICAgICBjb25zdCBtYXBMb2NhdGlvbiA9IHRoaXMuX2NjZU1vZHVsZU1hcC5tYXBMb2NhdGlvbjtcbiAgICAgICAgICAgICAgICBpZiAobW9kdWxlQ29uZmlnKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4cG9ydGVkT2JqID0gcmVxdWlyZShwcy5qb2luKHBzLmRpcm5hbWUobWFwTG9jYXRpb24pLCBtb2R1bGVDb25maWcubWFpbikpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gW1tdLCAoX2V4cG9ydCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGVjdXRlOiBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9leHBvcnQoZXhwb3J0ZWRPYmopO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB9XTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRQb2x5ZmlsbEZpbGUoZmlsZTogc3RyaW5nKSB7XG4gICAgICAgIHJlcXVpcmUoZmlsZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHByZXBhcmUoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX3JlbG9hZFBhY2tNb2RzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGltcG9ydCh1cmw6IHN0cmluZyk6IFByb21pc2U8dW5rbm93bj4ge1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZWRpdG9yU3lzdGVtLmltcG9ydCh1cmwpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOmHjeaWsOivu+WPliBQYWNrZXIg55qE5YaF5a655bm26YeN5paw5omn6KGM5omA5pyJ6aG555uu6ISa5pys5ZKM5o+S5Lu26ISa5pys44CCXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIHJlbG9hZCgpIHtcbiAgICAgICAgY29uc3Qgb25DbGFzc1JlZ2lzdGVyZWQ6IEVkaXRvckV4dGVuZHMuTGlzdGVuZXI8J2NsYXNzLXJlZ2lzdGVyZWQnPiA9IChjbGFzc0NvbnN0cnVjdG9yLCBtZXRhZGF0YSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fcmVnaXN0ZXJlZENsYXNzZXMucHVzaChjbGFzc0NvbnN0cnVjdG9yKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYFtbRXhlY3V0b3JdXSBSZWdpc3RlciAke2NsYXNzQ29uc3RydWN0b3IubmFtZX1gKTtcbiAgICAgICAgICAgIGlmIChtZXRhZGF0YSkge1xuICAgICAgICAgICAgICAgICh0aGlzLl9jbGFzc1V1aWRNYXBbbWV0YWRhdGEudXVpZF0gPz89IFtdKS5wdXNoKGNsYXNzQ29uc3RydWN0b3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIEVkaXRvckV4dGVuZHMub24oJ2NsYXNzLXJlZ2lzdGVyZWQnLCBvbkNsYXNzUmVnaXN0ZXJlZCk7XG4gICAgICAgIFxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5fcmVsb2FkUGFja01vZHMoKTtcbiAgICBcbiAgICAgICAgICAgIGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQoYEludmFsaWRhdGUgYWxsIG1vZHVsZXNgKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2ludmFsaWRhdGVBbGxNb2R1bGVzKCk7XG4gICAgICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgXG4gICAgICAgICAgICB0aGlzLl9pbnZhbGlkYXRlQWxsUGx1Z2lucygpO1xuICAgIFxuICAgICAgICAgICAgdGhpcy5fbG9hZEFsbFBsdWdpbnMoKTtcbiAgICBcbiAgICAgICAgICAgIGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQoYEltcG9ydHMgYWxsIG1vZHVsZXNgKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2ltcG9ydFByZXJlcXVpc2l0ZU1vZHVsZXMoKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICAgICAgfSBjYXRjaCAoZTogYW55KSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBFeGVjdXRvciBmYWlsZWQgdG8gcmVsb2FkLmAsIGUpO1xuICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIEVkaXRvckV4dGVuZHMucmVtb3ZlTGlzdGVuZXIoJ2NsYXNzLXJlZ2lzdGVyZWQnLCBvbkNsYXNzUmVnaXN0ZXJlZCk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBob3RSZWxvYWRQbHVnaW5TY3JpcHRzKGluZm8/OiBJUGx1Z2luQ2hhbmdlZEluZm8pIHtcbiAgICAgICAgaWYgKGluZm8pIHtcbiAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhpbmZvLmNoYW5nZXMpLmxlbmd0aCA9PT0gMCAmJiBpbmZvLnJlbW92YWxzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2ludmFsaWRhdGVBbGxQbHVnaW5zKCk7XG5cbiAgICAgICAgaWYgKGluZm8pIHtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fcGx1Z2lucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBsdWdpbiA9IHRoaXMuX3BsdWdpbnNbaV07XG4gICAgICAgICAgICAgICAgLy8g5bqU55So5L+u5pS5XG4gICAgICAgICAgICAgICAgaWYgKGluZm8ucmVtb3ZhbHMuaW5jbHVkZXMocGx1Z2luLnV1aWQpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3BsdWdpbnMuc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgICAgICAgICBpLS07XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGluZm8uY2hhbmdlc1twbHVnaW4udXVpZF0pIHtcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihwbHVnaW4sIGluZm8uY2hhbmdlc1twbHVnaW4udXVpZF0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMuX2xvYWRBbGxQbHVnaW5zKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGlzTW9kdWxlKGlkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIGlkIGluIHRoaXMuX21vZHVsZXM7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGNsZWFyKCkge1xuICAgICAgICB0aGlzLl9pbnZhbGlkYXRlQWxsUGx1Z2lucygpO1xuICAgICAgICB0aGlzLl9wbHVnaW5zID0gW107XG4gICAgICAgIGF3YWl0IHRoaXMuX2ludmFsaWRhdGVBbGxNb2R1bGVzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIHNldFBsdWdpblNjcmlwdHMgKHBsdWdpbnM6IFBsdWdpblNjcmlwdEluZm9bXSkge1xuICAgICAgICB0aGlzLl9pbnZhbGlkYXRlQWxsUGx1Z2lucygpO1xuICAgICAgICB0aGlzLl9wbHVnaW5zID0gcGx1Z2lucztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDmn6Xmib7mjIflrprohJrmnKzmqKHlnZfkuK3ms6jlhoznmoTmiYDmnIkgY2Mg57G744CCXG4gICAgICogQHBhcmFtIHV1aWQg5qih5Z2X55qEIHV1aWTjgIJcbiAgICAgKiBAcmV0dXJucyDmjIflrprohJrmnKzmqKHlnZfkuK3ms6jlhoznmoTmiYDmnIkgY2Mg57G777yb5aaC5p6cIFt1dWlkXSDlubbkuI3lr7nlupTkuIDkuKrmqKHlnZfmiJbmqKHlnZfkuK3mnKrms6jlhozku7vkvZXnsbvliJnov5Tlm54gYHVuZGVmaW5lZGDjgIJcbiAgICAgKi9cbiAgICBwdWJsaWMgcXVlcnlDbGFzc2VzSW5Nb2R1bGUodXVpZDogc3RyaW5nKTogdW5kZWZpbmVkIHwgUmVhZG9ubHlBcnJheTxSZWFkb25seTxGdW5jdGlvbj4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NsYXNzVXVpZE1hcFt1dWlkXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9yZWxvYWRQYWNrTW9kcygpIHtcbiAgICAgICAgLy8g5aSa6L+b56iL5pON5L2c5ZCM5LiA5Liq6LWE5rqQ44CC5aaC5p6c5LiN57uZ5paH5Lu25Yqg6ZSB77yM5Lya5a+86Ie05paH5Lu26K+75YaZ5Yay56qBXG4gICAgICAgIGF3YWl0IHRoaXMuX3BhY2tNb2RJbnN0YW50aWF0aW9uLmxvY2soKTtcbiAgICAgICAgYXdhaXQgdGhpcy5fcGFja01vZEluc3RhbnRpYXRpb24ucmVsb2FkKCk7XG5cbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLmNsZWFySW1wb3J0TWFwKCk7XG5cbiAgICAgICAgY29uc3QgcXVpY2tQYWNrTG9hZGVySW1wb3J0TWFwID0gYXdhaXQgdGhpcy5fcGFja01vZEluc3RhbnRpYXRpb24uZ2V0SW1wb3J0TWFwKCk7XG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbS5leHRlbmRJbXBvcnRNYXAocXVpY2tQYWNrTG9hZGVySW1wb3J0TWFwLCBuZXcgVVJMKHRoaXMuX3BhY2tMb2FkZXIuaW1wb3J0TWFwVVJMLCBwYWNrUmVzb3VyY2VCYXNlVVJMKS5ocmVmKTtcbiAgICAgICAgYXdhaXQgdGhpcy5fcGFja01vZEluc3RhbnRpYXRpb24udW5sb2NrKCk7XG5cbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLmV4dGVuZEltcG9ydE1hcCh0aGlzLl9maXhlZEltcG9ydE1hcCwgdGhpcy5fZW5naW5lSW1wb3J0TWFwVVJMKTtcblxuICAgICAgICBjb25zdCByZXNvbHV0aW9uRGV0YWlsTWFwID0gYXdhaXQgdGhpcy5fcGFja0xvYWRlci5sb2FkUmVzb2x1dGlvbkRldGFpbE1hcCgpO1xuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uc2V0UmVzb2x1dGlvbkRldGFpbE1hcChyZXNvbHV0aW9uRGV0YWlsTWFwLCBuZXcgVVJMKHRoaXMuX3BhY2tMb2FkZXIucmVzb2x1dGlvbkRldGFpbE1hcFVSTCwgcGFja1Jlc291cmNlQmFzZVVSTCkuaHJlZik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfaW52YWxpZGF0ZUFsbE1vZHVsZXMoKSB7XG4gICAgICAgIGNvbnN0IGNjID0gYXdhaXQgU3lzdGVtLmltcG9ydCgnY2MnKSBhcyBFbmdpbmVFeHBvcnRzO1xuXG4gICAgICAgIGZvciAoY29uc3QgcmVnaXN0ZXJlZENsYXNzIG9mIHRoaXMuX3JlZ2lzdGVyZWRDbGFzc2VzKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5fYmVmb3JlVW5yZWdpc3RlckNsYXNzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fYmVmb3JlVW5yZWdpc3RlckNsYXNzKHJlZ2lzdGVyZWRDbGFzcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYy5qcy51bnJlZ2lzdGVyQ2xhc3MocmVnaXN0ZXJlZENsYXNzKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYFVucmVnaXN0ZXIgJHtyZWdpc3RlcmVkQ2xhc3MubmFtZX1gKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9yZWdpc3RlcmVkQ2xhc3NlcyA9IFtdO1xuXG4gICAgICAgIHRoaXMuX2NsYXNzVXVpZE1hcCA9IHt9O1xuXG4gICAgICAgIGNjLmNjbGVnYWN5Ll9SRi5yZXNldCgpO1xuXG4gICAgICAgIHRoaXMuX2ludmFsaWRhdGVBbGxQYWNrTW9kcygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2ludmFsaWRhdGVBbGxQYWNrTW9kcygpIHtcbiAgICAgICAgZm9yIChjb25zdCBwYWNrTW9kSWQgb2YgdGhpcy5faW5zdGFudGlhdGVkUGFja01vZHMpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYEludmFsaWRhdGluZyAnJHtwYWNrTW9kSWR9J2ApO1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gU3lzdGVtLmRlbGV0ZShwYWNrTW9kSWQpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBOb3RlOiBmYWlsZWQgdG8gZGVsZXRlICR7cGFja01vZElkfSwgbWF5YmUgaXQncyBiZWluZyBleGVjdXRpbmc/YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5faW5zdGFudGlhdGVkUGFja01vZHMubGVuZ3RoID0gMDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9pbXBvcnRQcmVyZXF1aXNpdGVNb2R1bGVzKCkge1xuICAgICAgICBjb25zdCBjYyA9IGF3YWl0IFN5c3RlbS5pbXBvcnQoJ2NjJykgYXMgRW5naW5lRXhwb3J0cztcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgU3lzdGVtLmltcG9ydCgnY2NlOi9pbnRlcm5hbC94L3ByZXJlcXVpc2l0ZS1pbXBvcnRzJyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycjogdW5rbm93bikge1xuICAgICAgICAgICAgdGhpcy5faW1wb3J0RXhjZXB0aW9uSGFuZGxlcihlcnIpO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgdGhpcy5fY2FjaGVkRXhjZXB0aW9ucy5jbGVhcigpO1xuICAgICAgICAgICAgLy8g6aG555uu6ISa5pys5Y+v6IO95Zyo5omn6KGM55qE5pe25YCZ5Lya5oqb5Ye65byC5bi477yM6L+Z5a+86Ie0IGBjYy5fUkZgIOayoeacieato+ehruW8ueWHuuOAglxuICAgICAgICAgICAgLy8g5oiR5Lus5Zyo5pyA5ZCO5riF55CG5LiA5LiL44CCXG4gICAgICAgICAgICBjYy5jY2xlZ2FjeS5fUkYucmVzZXQoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2xvYWRBbGxQbHVnaW5zKCkge1xuICAgICAgICBjb25zdCBzb3J0ZWRNYXBwZWQgPSB0aGlzLl9wbHVnaW5zLm1hcCgocGx1Z2luU2NyaXB0KSA9PiBwbHVnaW5TY3JpcHQuZmlsZSk7XG4gICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBzb3J0ZWRNYXBwZWQpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgcmVxdWlyZShmaWxlKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9pbnZhbGlkYXRlQWxsUGx1Z2lucygpIHtcbiAgICAgICAgZm9yIChjb25zdCBbLCBwbHVnaW5TY3JpcHRJbmZvXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLl9wbHVnaW5zKSkge1xuICAgICAgICAgICAgZGVsZXRlIHJlcXVpcmUuY2FjaGVbcGx1Z2luU2NyaXB0SW5mby5maWxlXTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX3RyeUxvZzxDYXQgZXh0ZW5kcyBrZXlvZiBFeGVjdXRvci5Mb2dnZXI+KGNhdDogQ2F0LCAuLi5hcmdzOiBQYXJhbWV0ZXJzPE5vbk51bGxhYmxlPEV4ZWN1dG9yLkxvZ2dlcltDYXRdPj4pIHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICByZXR1cm4gKGNhdCBpbiB0aGlzLl9sb2dnZXIpID8gdGhpcy5fbG9nZ2VyW2NhdF0hKC4uLmFyZ3MpIDogdGhpcy5fZGVmYXVsdExvZyguLi5hcmdzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9kZWZhdWx0TG9nKC4uLmFyZ3M6IGFueSkge1xuICAgICAgICBjb25zb2xlLmxvZyguLi5hcmdzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9vbk1vZHVsZUxvYWRlZChlcnJvcjogRXJyb3IsIGlkOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgY2FjaGVkRXhjZXB0aW9ucyA9IHRoaXMuX2NhY2hlZEV4Y2VwdGlvbnM7XG4gICAgICAgIGlmICghZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYFtbRXhlY3V0b3JdXSBNb2R1bGUgXCIke2lkfVwiIGxvYWRlZC5gKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICghY2FjaGVkRXhjZXB0aW9ucy5oYXMoZXJyb3IpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5faW1wb3J0RXhjZXB0aW9uSGFuZGxlcihlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLl90cnlMb2coJ2xvYWRFeGNlcHRpb24nLCBpZCwgZXJyb3IsIGNhY2hlZEV4Y2VwdGlvbnMuaGFzKGVycm9yKSk7XG4gICAgICAgICAgICBjYWNoZWRFeGNlcHRpb25zLnNldChlcnJvciwgaWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZWNsYXJlIF9wYWNrTW9kSW5zdGFudGlhdGlvbjogUGFja01vZEluc3RhbnRpYXRpb247XG5cbiAgICBwcml2YXRlIF9iZWZvcmVVbnJlZ2lzdGVyQ2xhc3M/OiBFeGVjdXRvci5CZWZvcmVVbnJlZ2lzdGVyQ2xhc3M7XG4gICAgcHJpdmF0ZSBfY2FjaGVkRXhjZXB0aW9uczogTWFwPGFueSwgc3RyaW5nPiA9IG5ldyBNYXAoKTtcbiAgICBwcml2YXRlIF9jbGFzc1V1aWRNYXA6IFJlY29yZDxzdHJpbmcsIEZ1bmN0aW9uW10+ID0ge307XG4gICAgcHJpdmF0ZSBfbG9nZ2VyOiBQYXJ0aWFsPEV4ZWN1dG9yLkxvZ2dlcj47XG4gICAgcHJpdmF0ZSBfYnVpbHRpbk1vZHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcblxuICAgIHByaXZhdGUgX2ltcG9ydEV4Y2VwdGlvbkhhbmRsZXI6IEltcG9ydEV4Y2VwdGlvbkhhbmRsZXI7XG5cbiAgICBwcml2YXRlIF9lZGl0b3JTeXN0ZW06IEV4ZWN1dG9yU3lzdGVtO1xuICAgIHByaXZhdGUgX21vZHVsZXM6IFJlY29yZDxzdHJpbmcsIE1vZHVsZVNjcmlwdEluZm8+ID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgICBwcml2YXRlIF9yZWdpc3RlcmVkQ2xhc3NlczogRnVuY3Rpb25bXSA9IFtdO1xuXG4gICAgcHJpdmF0ZSBfcGx1Z2luczogUGx1Z2luU2NyaXB0SW5mb1tdID0gW107XG5cbiAgICBwcml2YXRlIF9maXhlZEltcG9ydE1hcDogeyBpbXBvcnRzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+IH0gPSB7IGltcG9ydHM6IHt9IH07XG4gICAgcHJpdmF0ZSBfZW5naW5lSW1wb3J0TWFwVVJMID0gJyc7XG5cbiAgICBwcml2YXRlIF9wYWNrTG9hZGVyOiBRdWlja1BhY2tMb2FkZXI7XG4gICAgcHJpdmF0ZSBfaW5zdGFudGlhdGVkUGFja01vZHM6IHN0cmluZ1tdID0gW107XG4gICAgcHJpdmF0ZSBfY2NlTW9kdWxlTWFwOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG59XG5cbmV4cG9ydCBuYW1lc3BhY2UgRXhlY3V0b3Ige1xuICAgIGV4cG9ydCB0eXBlIEJlZm9yZVVucmVnaXN0ZXJDbGFzcyA9IChjbGFzc0NvbnN0cnVjdG9yOiBGdW5jdGlvbikgPT4gdm9pZDtcblxuICAgIGV4cG9ydCBpbnRlcmZhY2UgUmVwb3J0ZXJNYXAge1xuICAgICAgICBbJ3Bvc3NpYmxlLWNyLXVzZSddOiB7XG4gICAgICAgICAgICBpbXBvcnRlZDogc3RyaW5nO1xuICAgICAgICAgICAgbW9kdWxlUmVxdWVzdDogc3RyaW5nO1xuICAgICAgICAgICAgaW1wb3J0TWV0YTogYW55O1xuICAgICAgICAgICAgZXh0cmFzOiBhbnk7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgZXhwb3J0IHR5cGUgTG9nZ2VyID0gUGFydGlhbDx7XG4gICAgICAgIHBvc3NpYmxlQ2lyY3VsYXJSZWZlcmVuY2U6IChcbiAgICAgICAgICAgIGltcG9ydGVkOiBzdHJpbmcsXG4gICAgICAgICAgICBtb2R1bGVSZXF1ZXN0OiBzdHJpbmcsXG4gICAgICAgICAgICBpbXBvcnRNZXRhOiBhbnksXG4gICAgICAgICAgICBleHRyYXM6IGFueVxuICAgICAgICApID0+IHZvaWQ7XG5cbiAgICAgICAgbG9hZEV4Y2VwdGlvbjogKFxuICAgICAgICAgICAgbW9kdWxlVXJsOiBzdHJpbmcsXG4gICAgICAgICAgICBlcnJvcj86IGFueSxcbiAgICAgICAgICAgIGhhc0JlZW5UaHJvd24/OiBib29sZWFuLFxuICAgICAgICApID0+IHZvaWQ7XG4gICAgfT47XG5cbiAgICBleHBvcnQgaW50ZXJmYWNlIE9wdGlvbnMge1xuICAgICAgICBpbXBvcnRFbmdpbmVNb2Q6IEltcG9ydEVuZ2luZU1vZDtcbiAgICAgICAgcXVpY2tQYWNrTG9hZGVyQ29udGV4dDogTG9hZGVyQ29udGV4dDtcbiAgICAgICAgYmVmb3JlVW5yZWdpc3RlckNsYXNzPzogQmVmb3JlVW5yZWdpc3RlckNsYXNzO1xuICAgICAgICBwYWNrTW9kdWxlRXZhbHVhdG9yPzogUGFja01vZHVsZUV2YWx1YXRvcjtcbiAgICAgICAgbG9nZ2VyPzogTG9nZ2VyO1xuICAgICAgICBpbXBvcnRFeGNlcHRpb25IYW5kbGVyPzogKGVycjogdW5rbm93bikgPT4gdm9pZDtcbiAgICAgICAgY2NlTW9kdWxlTWFwOiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICAgIH1cblxuICAgIGV4cG9ydCBpbnRlcmZhY2UgRXhlY3V0ZUluZm8ge1xuICAgICAgICBwb2x5ZmlsbHM6IHN0cmluZ1tdO1xuICAgICAgICBtb2R1bGVzOiBzdHJpbmdbXTtcbiAgICAgICAgYmFyZVNwZWNpZmllclJlc29sdmVNYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gICAgICAgIGluc3RhbnRpYXRlTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICAgIH1cbn1cblxudHlwZSBQbHVnaW5TY3JpcHRJZCA9IHN0cmluZztcblxuZXhwb3J0IGludGVyZmFjZSBQbHVnaW5TY3JpcHRJbmZvIHtcbiAgICAvKipcbiAgICAgKiDohJrmnKzmlofku7bjgIJcbiAgICAgKi9cbiAgICBmaWxlOiBzdHJpbmc7XG5cbiAgICB1dWlkOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBNb2R1bGVTY3JpcHRJbmZvIHtcbiAgICAvKipcbiAgICAgKiDmqKHlnZcgVVJM44CCXG4gICAgICovXG4gICAgbW9kdWxlVXJsOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiDku6PnoIHmlofku7bjgIJcbiAgICAgKi9cbiAgICBmaWxlOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBFbmdpbmVFeHBvcnRzIHtcbiAgICBjY2xlZ2FjeTogeyBfUkY6IHsgcmVzZXQoKTogdm9pZDsgfSB9O1xuICAgIGpzOiB7IHVucmVnaXN0ZXJDbGFzcyhmOiBGdW5jdGlvbik6IHZvaWQ7IH07XG59XG5cbmRlY2xhcmUgbmFtZXNwYWNlIEVkaXRvckV4dGVuZHMge1xuICAgIGludGVyZmFjZSBFdmVudE1hcCB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDYWxsZWQgd2hlbiBhIGNjLWNsYXNzIGlzIHJlZ2lzdGVyZWQuXG4gICAgICAgICAqIEBwYXJhbSBjbGFzc0NvbnN0cnVjdG9yIFJlZ2lzdGVyaW5nIGNsYXNzLlxuICAgICAgICAgKi9cbiAgICAgICAgJ2NsYXNzLXJlZ2lzdGVyZWQnKGNsYXNzQ29uc3RydWN0b3I6IEZ1bmN0aW9uLCBtZXRhZGF0YT86IFJlYWRvbmx5PGFueT4pOiB2b2lkO1xuICAgIH1cblxuICAgIHR5cGUgRXZlbnRBcmdzPEV2ZW50TmFtZSBleHRlbmRzIGtleW9mIEV2ZW50TWFwPiA9IFBhcmFtZXRlcnM8RXZlbnRNYXBbRXZlbnROYW1lXT47XG5cbiAgICB0eXBlIExpc3RlbmVyPEV2ZW50TmFtZSBleHRlbmRzIGtleW9mIEV2ZW50TWFwPiA9ICguLi5hcmdzOiBFdmVudEFyZ3M8RXZlbnROYW1lPikgPT4gdm9pZDtcblxuICAgIGZ1bmN0aW9uIGVtaXQ8RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+KG5hbWU6IEV2ZW50TmFtZSwgLi4uYXJnczogRXZlbnRBcmdzPEV2ZW50TmFtZT4pOiB2b2lkO1xuXG4gICAgZnVuY3Rpb24gb248RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+KG5hbWU6IEV2ZW50TmFtZSwgbGlzdGVuZXI6IExpc3RlbmVyPEV2ZW50TmFtZT4pOiB2b2lkO1xuXG4gICAgZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXI8RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+KG5hbWU6IEV2ZW50TmFtZSwgbGlzdGVuZXI6IExpc3RlbmVyPEV2ZW50TmFtZT4pOiB2b2lkO1xufVxuIl19