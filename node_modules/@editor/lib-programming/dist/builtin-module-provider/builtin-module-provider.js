"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.BuiltinModuleProvider = void 0;
const build_time_constants_1 = require("./build-time-constants");
const babel = __importStar(require("@babel/core"));
// import babelPresetCC from '@cocos/babel-preset-cc';
// @ts-ignore
// import babelPresetEnv from '@babel/preset-env';
const plugin_transform_modules_systemjs_1 = __importDefault(require("@babel/plugin-transform-modules-systemjs"));
const url_1 = __importDefault(require("url"));
/**
 * `BuiltinModuleProvider` 用于提供项目脚本用到的所有“内置”模块，例如：
 * - `"cc.base"` 等引擎模块
 * - 模块 `"cc/env"` —— 提供了构建时常量
 *
 * 它提供的内置模块可以用于在**编辑器环境**中、**预览环境**中以及**构建时打包工具**的环境中运行。
 */
class BuiltinModuleProvider {
    constructor(options) {
        var _a;
        this._modules = {};
        this._format = (_a = options.format) !== null && _a !== void 0 ? _a : 'esm';
    }
    static async create(options) {
        const provider = new BuiltinModuleProvider(options);
        await provider._initialize(options);
        return provider;
    }
    async addEngineIndexMod(url, xSourceKind) {
        if (Array.isArray(url)) {
            this._modules['cc'] = await this._transform(makeModuleCCSource(url));
        }
        else {
            this._modules['cc'] = await this._makeModuleAlias(url, xSourceKind);
        }
    }
    async addEngineMods(ccMods, xSourceKind) {
        await Promise.all(Object.entries(ccMods).map(async ([id, alias]) => {
            this._modules[id] = await this._makeModuleAlias(alias, xSourceKind);
        }));
    }
    async addBuildTimeConstantsMod(constants, xSourceKind) {
        if (typeof constants === 'object') {
            this._modules[ModuleNames.buildTimeConstants] =
                await this._transform(await build_time_constants_1.makeBuildTimeConstantModule(constants));
        }
        else {
            this._modules[ModuleNames.buildTimeConstants] =
                await this._makeModuleAlias(constants !== null && constants !== void 0 ? constants : this.getBTCMappingSource(), xSourceKind);
        }
        // Deprecated: use 'cc/env'
        this._modules['cce.env'] = this._modules[ModuleNames.buildTimeConstants];
    }
    getBTCMappingSource() {
        return `cc/editor/populate-internal-constants`;
    }
    /**
     * 当前提供的所有模块以及它们的源码。
     */
    get modules() {
        return this._modules;
    }
    async _initialize(options) {
    }
    async _makeModuleAlias(alias, targetKind) {
        if (targetKind === 'commonjs') {
            let moduleName;
            try {
                moduleName = url_1.default.fileURLToPath(alias);
            }
            catch (_a) {
                moduleName = alias;
            }
            return `\
System.register([], (_export) => {
    return {
        execute: () => { _export(require('${moduleName.replace(/\\/g, '\\\\')}')); },
    };
});
`;
        }
        else if (targetKind === 'amd') {
            return `\
System.register(['${alias}'], (_export) => {
    let m;
    return {
        setters: [(mAmd) => { m = mAmd.default; }],
        execute: () => { _export(m); },
    };
});
`;
        }
        else {
            return await this._transform(`export * from '${alias}';`);
        }
    }
    async _transform(code) {
        if (this._format === 'esm') {
            return code;
        }
        const babelFileResult = await babel.transformAsync(code, {
            plugins: [[plugin_transform_modules_systemjs_1.default]],
            presets: [
            // [babelPresetEnv, {
            //     modules: 'systemjs',
            // }],
            // [babelPresetCC, {
            //     useDefineForClassFields: true,
            //     allowDeclareFields: true,
            // }],
            ],
        });
        if (!babelFileResult) {
            throw new Error(`Failed to transform code in PreviewFacet: ${code}`);
        }
        return babelFileResult.code;
    }
}
exports.BuiltinModuleProvider = BuiltinModuleProvider;
function makeModuleCCSource(dependencies) {
    const source = dependencies.map((dependency) => `export * from '${dependency}';`).join('\n');
    return source;
}
var ModuleNames;
(function (ModuleNames) {
    ModuleNames["codeQualityCr"] = "cce:code-quality/cr";
    ModuleNames["buildTimeConstants"] = "cc/env";
})(ModuleNames || (ModuleNames = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbHRpbi1tb2R1bGUtcHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYnVpbHRpbi1tb2R1bGUtcHJvdmlkZXIvYnVpbHRpbi1tb2R1bGUtcHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBLGlFQUE4RjtBQUM5RixtREFBcUM7QUFDckMsc0RBQXNEO0FBQ3RELGFBQWE7QUFDYixrREFBa0Q7QUFDbEQsaUhBQTJGO0FBQzNGLDhDQUFzQjtBQWV0Qjs7Ozs7O0dBTUc7QUFDSCxNQUFhLHFCQUFxQjtJQW9FOUIsWUFBb0IsT0FBNkI7O1FBSHpDLGFBQVEsR0FBMkIsRUFBRSxDQUFDO1FBSTFDLElBQUksQ0FBQyxPQUFPLFNBQUcsT0FBTyxDQUFDLE1BQU0sbUNBQUksS0FBSyxDQUFDO0lBQzNDLENBQUM7SUFyRU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBNkI7UUFDcEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNwRCxNQUFNLFFBQVEsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDcEMsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQztJQVVNLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxHQUFzQixFQUFFLFdBQXdCO1FBQzNFLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNwQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ3hFO2FBQU07WUFDSCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxXQUFXLENBQUMsQ0FBQztTQUN2RTtJQUNMLENB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Q2pDLENBQUM7Q0FDSjtBQTlIRCxzREE4SEM7QUFFRCxTQUFTLGtCQUFrQixDQUFDLFlBQXNCO0lBQzlDLE1BQU0sTUFBTSxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixVQUFVLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3RixPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDO0FBRUQsSUFBSyxXQUdKO0FBSEQsV0FBSyxXQUFXO0lBQ1osb0RBQXFDLENBQUE7SUFDckMsNENBQTZCLENBQUE7QUFDakMsQ0FBQyxFQUhJLFdBQVcsS0FBWCxXQUFXLFFBR2YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHBzIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgSUJ1aWxkVGltZUNvbnN0YW50VmFsdWUsIG1ha2VCdWlsZFRpbWVDb25zdGFudE1vZHVsZSB9IGZyb20gJy4vYnVpbGQtdGltZS1jb25zdGFudHMnO1xuaW1wb3J0ICogYXMgYmFiZWwgZnJvbSAnQGJhYmVsL2NvcmUnO1xuLy8gaW1wb3J0IGJhYmVsUHJlc2V0Q0MgZnJvbSAnQGNvY29zL2JhYmVsLXByZXNldC1jYyc7XG4vLyBAdHMtaWdub3JlXG4vLyBpbXBvcnQgYmFiZWxQcmVzZXRFbnYgZnJvbSAnQGJhYmVsL3ByZXNldC1lbnYnO1xuaW1wb3J0IGJhYmVsUGx1Z2luVHJhbnNmb3JtTW9kdWxlc1N5c3RlbUpzIGZyb20gJ0BiYWJlbC9wbHVnaW4tdHJhbnNmb3JtLW1vZHVsZXMtc3lzdGVtanMnO1xuaW1wb3J0IFVSTCBmcm9tICd1cmwnO1xuXG5pbnRlcmZhY2UgQnVpbHRpbk1vZHVsZU9wdGlvbnMge1xuICAgIC8qKlxuICAgICAqIGBCdWlsdGluTW9kdWxlUHJvdmlkZXJgIOS4reaPkOS+m+eahOaooeWdl+eahOagvOW8j+OAglxuICAgICAqL1xuICAgIGZvcm1hdD86ICdzeXN0ZW1qcycgfCAnZXNtJztcbn1cblxuLyoqXG4gKiDlvojlpJrml7blgJkgYEJ1aWx0aW5Nb2R1bGVQcm92aWRlcmAg5Lit55qE5qih5Z2X6ZyA6KaB5pig5bCE5Yiw5YW25a6D5qih5Z2X44CCXG4gKiBgVGFyZ2V0S2luZGAg5Luj6KGo5LqG55uu5qCH5qih5Z2X55qE5qih5Z2X5qC85byP44CCXG4gKi9cbnR5cGUgVGFyZ2V0S2luZCA9ICdjb21tb25qcycgfCAnYW1kJztcblxuLyoqXG4gKiBgQnVpbHRpbk1vZHVsZVByb3ZpZGVyYCDnlKjkuo7mj5Dkvpvpobnnm67ohJrmnKznlKjliLDnmoTmiYDmnInigJzlhoXnva7igJ3mqKHlnZfvvIzkvovlpoLvvJpcbiAqIC0gYFwiY2MuYmFzZVwiYCDnrYnlvJXmk47mqKHlnZdcbiAqIC0g5qih5Z2XIGBcImNjL2VudlwiYCDigJTigJQg5o+Q5L6b5LqG5p6E5bu65pe25bi46YePXG4gKiBcbiAqIOWug+aPkOS+m+eahOWGhee9ruaooeWdl+WPr+S7peeUqOS6juWcqCoq57yW6L6R5Zmo546v5aKDKirkuK3jgIEqKumihOiniOeOr+Wigyoq5Lit5Lul5Y+KKirmnoTlu7rml7bmiZPljIXlt6XlhbcqKueahOeOr+Wig+S4rei/kOihjOOAglxuICovXG5leHBvcnQgY2xhc3MgQnVpbHRpbk1vZHVsZVByb3ZpZGVyIHtcbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIGNyZWF0ZShvcHRpb25zOiBCdWlsdGluTW9kdWxlT3B0aW9ucyk6IFByb21pc2U8QnVpbHRpbk1vZHVsZVByb3ZpZGVyPiB7XG4gICAgICAgIGNvbnN0IHByb3ZpZGVyID0gbmV3IEJ1aWx0aW5Nb2R1bGVQcm92aWRlcihvcHRpb25zKTtcbiAgICAgICAgYXdhaXQgcHJvdmlkZXIuX2luaXRpYWxpemUob3B0aW9ucyk7XG4gICAgICAgIHJldHVybiBwcm92aWRlcjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDmt7vliqAgYCdjYydgIOaooeWdl+OAglxuICAgICAqIEBwYXJhbSBtb2RzIGAnY2MnYCDmqKHlnZflr7zlh7rnmoTmiYDmnInlrZDmqKHlnZfjgIJcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgYWRkRW5naW5lSW5kZXhNb2QobW9kczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+O1xuXG4gICAgcHVibGljIGFzeW5jIGFkZEVuZ2luZUluZGV4TW9kKHVybDogc3RyaW5nLCB4U291cmNlS2luZD86IFRhcmdldEtpbmQpOiBQcm9taXNlPHZvaWQ+O1xuXG4gICAgcHVibGljIGFzeW5jIGFkZEVuZ2luZUluZGV4TW9kKHVybDogc3RyaW5nW10gfCBzdHJpbmcsIHhTb3VyY2VLaW5kPzogVGFyZ2V0S2luZCkge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh1cmwpKSB7XG4gICAgICAgICAgICB0aGlzLl9tb2R1bGVzWydjYyddID0gYXdhaXQgdGhpcy5fdHJhbnNmb3JtKG1ha2VNb2R1bGVDQ1NvdXJjZSh1cmwpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX21vZHVsZXNbJ2NjJ10gPSBhd2FpdCB0aGlzLl9tYWtlTW9kdWxlQWxpYXModXJsLCB4U291cmNlS2luZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgYWRkRW5naW5lTW9kcyhjY01vZHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4sIHhTb3VyY2VLaW5kPzogVGFyZ2V0S2luZCkge1xuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChPYmplY3QuZW50cmllcyhjY01vZHMpLm1hcChhc3luYyAoW2lkLCBhbGlhc10pID0+IHtcbiAgICAgICAgICAgIHRoaXMuX21vZHVsZXNbaWRdID0gYXdhaXQgdGhpcy5fbWFrZU1vZHVsZUFsaWFzKGFsaWFzLCB4U291cmNlS2luZCk7XG4gICAgICAgIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDmt7vliqAgYCdjYy9lbnYnYCDmqKHlnZfjgIJcbiAgICAgKiBAcGFyYW0gY29uc3RhbnRzIGAnY2MvZW52J2Ag5qih5Z2X5Lit55qE5bi46YeP5Lul5Y+K5a6D5Lus55qE5YC844CCXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIGFkZEJ1aWxkVGltZUNvbnN0YW50c01vZChjb25zdGFudHM6IFJlY29yZDxzdHJpbmcsIElCdWlsZFRpbWVDb25zdGFudFZhbHVlPik6IFByb21pc2U8dm9pZD47XG5cbiAgICAvKipcbiAgICAgKiDmt7vliqAgYCdjYy9lbnYnYCDmqKHlnZfjgILorqkgYCdjYy9lbnYnYCDmmKDlsITkuLrmjIflrprnmoTmqKHlnZcuXG4gICAgICogQHBhcmFtIHVybCDmjIflrprnmoTmqKHlnZfjgILoi6XmnKrmjIflrprliJnkuLogYHRoaXMuZ2V0QlRDTWFwcGluZ1NvdXJjZSgpYOOAglxuICAgICAqIEBwYXJhbSB4U291cmNlS2luZCDmjIflrprmqKHlnZfnmoTmoLzlvI/jgIJcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgYWRkQnVpbGRUaW1lQ29uc3RhbnRzTW9kKHVybD86IHN0cmluZywgeFNvdXJjZUtpbmQ/OiBUYXJnZXRLaW5kKTogUHJvbWlzZTx2b2lkPjtcblxuICAgIHB1YmxpYyBhc3luYyBhZGRCdWlsZFRpbWVDb25zdGFudHNNb2QoY29uc3RhbnRzOiBzdHJpbmcgfCB1bmRlZmluZWQgfCBSZWNvcmQ8c3RyaW5nLCBJQnVpbGRUaW1lQ29uc3RhbnRWYWx1ZT4sIHhTb3VyY2VLaW5kPzogVGFyZ2V0S2luZCkge1xuICAgICAgICBpZiAodHlwZW9mIGNvbnN0YW50cyA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgIHRoaXMuX21vZHVsZXNbTW9kdWxlTmFtZXMuYnVpbGRUaW1lQ29uc3RhbnRzXSA9XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fdHJhbnNmb3JtKGF3YWl0IG1ha2VCdWlsZFRpbWVDb25zdGFudE1vZHVsZShjb25zdGFudHMpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX21vZHVsZXNbTW9kdWxlTmFtZXMuYnVpbGRUaW1lQ29uc3RhbnRzXSA9XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fbWFrZU1vZHVsZUFsaWFzKGNvbnN0YW50cyA/PyB0aGlzLmdldEJUQ01hcHBpbmdTb3VyY2UoKSwgeFNvdXJjZUtpbmQpO1xuICAgICAgICB9XG4gICAgICAgIC8vIERlcHJlY2F0ZWQ6IHVzZSAnY2MvZW52J1xuICAgICAgICB0aGlzLl9tb2R1bGVzWydjY2UuZW52J10gPSB0aGlzLl9tb2R1bGVzW01vZHVsZU5hbWVzLmJ1aWxkVGltZUNvbnN0YW50c107XG4gICAgfVxuXG4gICAgcHVibGljIGdldEJUQ01hcHBpbmdTb3VyY2UoKSB7XG4gICAgICAgIHJldHVybiBgY2MvZWRpdG9yL3BvcHVsYXRlLWludGVybmFsLWNvbnN0YW50c2A7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5b2T5YmN5o+Q5L6b55qE5omA5pyJ5qih5Z2X5Lul5Y+K5a6D5Lus55qE5rqQ56CB44CCXG4gICAgICovXG4gICAgZ2V0IG1vZHVsZXMoKTogUmVhZG9ubHk8UmVjb3JkPHN0cmluZywgc3RyaW5nPj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fbW9kdWxlcztcbiAgICB9XG5cbiAgICBwcml2YXRlIF9tb2R1bGVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG4gICAgcHJpdmF0ZSBfZm9ybWF0OiBOb25OdWxsYWJsZTxCdWlsdGluTW9kdWxlT3B0aW9uc1snZm9ybWF0J10+O1xuXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3RvcihvcHRpb25zOiBCdWlsdGluTW9kdWxlT3B0aW9ucykge1xuICAgICAgICB0aGlzLl9mb3JtYXQgPSBvcHRpb25zLmZvcm1hdCA/PyAnZXNtJztcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9pbml0aWFsaXplKG9wdGlvbnM6IEJ1aWx0aW5Nb2R1bGVPcHRpb25zKSB7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfbWFrZU1vZHVsZUFsaWFzKGFsaWFzOiBzdHJpbmcsIHRhcmdldEtpbmQ6IFRhcmdldEtpbmQgfCB1bmRlZmluZWQpIHtcbiAgICAgICAgaWYgKHRhcmdldEtpbmQgPT09ICdjb21tb25qcycpIHtcbiAgICAgICAgICAgIGxldCBtb2R1bGVOYW1lOiBzdHJpbmc7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIG1vZHVsZU5hbWUgPSBVUkwuZmlsZVVSTFRvUGF0aChhbGlhcyk7XG4gICAgICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICAgICAgICBtb2R1bGVOYW1lID0gYWxpYXM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYFxcXG5TeXN0ZW0ucmVnaXN0ZXIoW10sIChfZXhwb3J0KSA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgZXhlY3V0ZTogKCkgPT4geyBfZXhwb3J0KHJlcXVpcmUoJyR7bW9kdWxlTmFtZS5yZXBsYWNlKC9cXFxcL2csICdcXFxcXFxcXCcpfScpKTsgfSxcbiAgICB9O1xufSk7XG5gO1xuICAgICAgICB9IGVsc2UgaWYgKHRhcmdldEtpbmQgPT09ICdhbWQnKSB7XG4gICAgICAgICAgICByZXR1cm4gYFxcXG5TeXN0ZW0ucmVnaXN0ZXIoWycke2FsaWFzfSddLCAoX2V4cG9ydCkgPT4ge1xuICAgIGxldCBtO1xuICAgIHJldHVybiB7XG4gICAgICAgIHNldHRlcnM6IFsobUFtZCkgPT4geyBtID0gbUFtZC5kZWZhdWx0OyB9XSxcbiAgICAgICAgZXhlY3V0ZTogKCkgPT4geyBfZXhwb3J0KG0pOyB9LFxuICAgIH07XG59KTtcbmA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fdHJhbnNmb3JtKGBleHBvcnQgKiBmcm9tICcke2FsaWFzfSc7YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF90cmFuc2Zvcm0oY29kZTogc3RyaW5nKSB7XG4gICAgICAgIGlmICh0aGlzLl9mb3JtYXQgPT09ICdlc20nKSB7XG4gICAgICAgICAgICByZXR1cm4gY29kZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBiYWJlbEZpbGVSZXN1bHQgPSBhd2FpdCBiYWJlbC50cmFuc2Zvcm1Bc3luYyhjb2RlLCB7XG4gICAgICAgICAgICBwbHVnaW5zOiBbW2JhYmVsUGx1Z2luVHJhbnNmb3JtTW9kdWxlc1N5c3RlbUpzXV0sXG4gICAgICAgICAgICBwcmVzZXRzOiBbXG4gICAgICAgICAgICAgICAgLy8gW2JhYmVsUHJlc2V0RW52LCB7XG4gICAgICAgICAgICAgICAgLy8gICAgIG1vZHVsZXM6ICdzeXN0ZW1qcycsXG4gICAgICAgICAgICAgICAgLy8gfV0sXG4gICAgICAgICAgICAgICAgLy8gW2JhYmVsUHJlc2V0Q0MsIHtcbiAgICAgICAgICAgICAgICAvLyAgICAgdXNlRGVmaW5lRm9yQ2xhc3NGaWVsZHM6IHRydWUsXG4gICAgICAgICAgICAgICAgLy8gICAgIGFsbG93RGVjbGFyZUZpZWxkczogdHJ1ZSxcbiAgICAgICAgICAgICAgICAvLyB9XSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoIWJhYmVsRmlsZVJlc3VsdCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gdHJhbnNmb3JtIGNvZGUgaW4gUHJldmlld0ZhY2V0OiAke2NvZGV9YCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGJhYmVsRmlsZVJlc3VsdC5jb2RlITtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIG1ha2VNb2R1bGVDQ1NvdXJjZShkZXBlbmRlbmNpZXM6IHN0cmluZ1tdKSB7XG4gICAgY29uc3Qgc291cmNlID0gZGVwZW5kZW5jaWVzLm1hcCgoZGVwZW5kZW5jeSkgPT4gYGV4cG9ydCAqIGZyb20gJyR7ZGVwZW5kZW5jeX0nO2ApLmpvaW4oJ1xcbicpO1xuICAgIHJldHVybiBzb3VyY2U7XG59XG5cbmVudW0gTW9kdWxlTmFtZXMge1xuICAgIGNvZGVRdWFsaXR5Q3IgPSAnY2NlOmNvZGUtcXVhbGl0eS9jcicsXG4gICAgYnVpbGRUaW1lQ29uc3RhbnRzID0gJ2NjL2VudicsXG59XG4iXX0=