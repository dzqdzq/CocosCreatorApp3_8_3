"use strict";
/// <reference path="../../@types/systemjs/systemjs.d.ts"/>
/// <reference path="../../@types/systemjs/extras/named-register.d.ts"/>
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.globalEditorSystem = exports.ExecutorSystem = void 0;
const out_1 = require("../../static/executor/systemjs-bridge/out");
const url_1 = __importDefault(require("url"));
const i18n_1 = require("../utils/i18n");
class ExecutorSystem {
    constructor() {
        this._registry = Object.create(null);
        this._lastRegister = null;
        this._baseUrl = 'project:///';
        this._instantiationHandlers = [];
        this._importMap = {
            imports: {},
            scopes: {},
        };
        const me = this;
        if (!out_1.systemJSPrototype.prepareImport) {
            out_1.systemJSPrototype.prepareImport = () => { };
        }
        out_1.systemJSPrototype.resolve = function (...args) {
            // @ts-ignore
            return me._resolve(this, ...args);
        };
        out_1.systemJSPrototype.instantiate = function (...args) {
            // @ts-ignore
            return me._instantiate(this, ...args);
        };
        this._vendorRegisterFn = out_1.systemJSPrototype.register;
        out_1.systemJSPrototype.register = function (...args) {
            if (typeof args[0] === 'string') {
                // @ts-ignore
                return me.setRegister(...args);
            }
            // @ts-ignore
            return me._register(this, ...args);
        };
        this._detailResolve = out_1.createDetailResolver(undefined, // logger,
        undefined);
        // TODO: merge systemjs implementation
        const upvalueMap = {};
        const vendorCreateContext = out_1.systemJSPrototype.createContext;
        out_1.systemJSPrototype.createContext = function (id) {
            const name2class = {};
            const context = vendorCreateContext.call(this, id);
            upvalueMap[context.url] = name2class;
            return Object.assign(Object.assign({}, context), { upvalue(name) {
                    return function (target) {
                        name2class[name] = target;
                    };
                } });
        };
    }
    get importMap() {
        return this._importMap;
    }
    async import(url) {
        return await System.import(url);
    }
    /**
     * Provides the last anonymous `System.register` call.
     */
    getRegister() {
        const lastRegister = this._lastRegister;
        this._lastRegister = null;
        return lastRegister;
    }
    clearImportMap() {
        this._importMap.imports = {};
        this._importMap.scopes = {};
    }
    extendImportMap(importMap, baseUrl) {
        out_1.systemJsCommon.resolveAndComposeImportMap(importMap, baseUrl, this._importMap);
    }
    setRegister(id, dependencies, declare) {
        this._registry[id] = [dependencies, declare];
    }
    deleteRegister(id) {
        delete this._registry[id];
    }
    encodeModsMgrRequest(id) {
        const url = `${ExecutorSystem.protocolHeadModsMgr}${encodeURIComponent(id)}`;
        return url;
    }
    addInstantiationHandler(handler) {
        this._instantiationHandlers.push(handler);
    }
    setResolutionDetailMap(resolutionDetailMap, url) {
        console.debug(`Set detail map ${url}: ${JSON.stringify(resolutionDetailMap, undefined, 2)}`);
        out_1.setResolutionDetailMap(resolutionDetailMap, url);
    }
    _resolve(systemJSPrototype, id, parentURL) {
        parentURL = parentURL !== null && parentURL !== void 0 ? parentURL : this._baseUrl;
        this._detailResolve(id, parentURL);
        const result = out_1.systemJsCommon.resolveImportMap(this._importMap, out_1.systemJsCommon.resolveIfNotPlainOrUrl(id, parentURL) || id, parentURL);
        if (result) {
            return result;
        }
        if (id in this._registry) {
            return id;
        }
        return this._throwUnresolved(id, parentURL);
    }
    async _instantiate(systemJSPrototype, url, firstParentUrl) {
        if (url in this._registry) {
            // TODO: this._registry[url] = null;
            return this._registry[url];
        }
        for (const handler of this._instantiationHandlers) {
            const register = await handler(url);
            if (register) {
                return register;
            }
        }
        let path;
        if (url.startsWith('file:')) {
            try {
                path = url_1.default.fileURLToPath(url);
            }
            catch (_a) { }
        }
        if (url.startsWith(ExecutorSystem.protocolHeadModsMgr)) {
            const urlObject = new URL(url);
            const pathname = urlObject.pathname;
            const id = decodeURIComponent(pathname);
            return [[], (exportBindings) => {
                    return {
                        execute: () => {
                            const modsMgr = require('cc/mods-mgr');
                            const mod = modsMgr.syncImport(id);
                            exportBindings(mod);
                        },
                    };
                }];
        }
        if (path) {
            require(path);
            const register = this.getRegister();
            if (!register) {
                throw new Error(i18n_1.i18nTranslate('executor_system_js_no_module_registered', { url }));
            }
            return register;
        }
        return this._throwInstantiationError(url, firstParentUrl);
    }
    /**
     * 处理 `System.register()` 调用。
     */
    _register(systemJSPrototype, deps, declare) {
        this._lastRegister = [deps, declare];
    }
    _throwUnresolved(id, parentUrl) {
        throw Error(i18n_1.i18nTranslate('executor_failed_to_resolve', { specifier: id, parentURL: parentUrl !== null && parentUrl !== void 0 ? parentUrl : i18n_1.i18nTranslate('executor_system_js_origin') }));
    }
    _throwInstantiationError(url, firstParentUrl) {
        throw Error(i18n_1.i18nTranslate('executor_failed_to_instantiate', { url, firstParentURL: firstParentUrl !== null && firstParentUrl !== void 0 ? firstParentUrl : i18n_1.i18nTranslate('executor_system_js_origin') }));
    }
}
exports.ExecutorSystem = ExecutorSystem;
ExecutorSystem.protocolHeadModsMgr = 'mods-mgr:';
exports.globalEditorSystem = new ExecutorSystem();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZWRpdG9yLXN5c3RlbWpzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSwyREFBMkQ7QUFDM0Qsd0VBQXdFOzs7Ozs7QUFFeEUsbUVBTW1EO0FBQ25ELDhDQUEwQjtBQUMxQix3Q0FBOEM7QUFPOUMsTUFBYSxjQUFjO0lBVXZCO1FBUFEsY0FBUyxHQUFxQixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWxELGtCQUFhLEdBQTBCLElBQUksQ0FBQztRQUM1QyxhQUFRLEdBQUcsYUFBYSxDQUFDO1FBQ3pCLDJCQUFzQixHQUEyQixFQUFFLENBQUM7UUFnR3BELGVBQVUsR0FHZDtZQUNBLE9BQU8sRUFBRSxFQUFFO1lBQ1gsTUFBTSxFQUFFLEVBQUU7U0FDYixDQUFDO1FBbEdFLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQztRQUNoQixJQUFJLENBQUMsdUJBQWlCLENBQUMsYUFBYSxFQUFFO1lBQ2xDLHVCQUFpQixDQUFDLGFBQWEsR0FBRyxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUM7U0FDOUM7UUFDRCx1QkFBaUIsQ0FBQyxPQUFPLEdBQUcsVUFBVSxHQUFHLElBQVM7WUFDOUMsYUFBYTtZQUNiLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUN0QyxDQUFDLENBQUM7UUFDRix1QkFBaUIsQ0FBQyxXQUFXLEdBQUcsVUFBVSxHQUFHLElBQVM7WUFDbEQsYUFBYTtZQUNiLE9BQU8sRUFBRSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUMxQyxDQUFDLENBQUM7UUFDRixJQUFJLENBQUMsaUJBQWlCLEdBQUcsdUJBQWlCLENBQUMsUUFBUSxDQUFDO1FBQ3BELHVCQUFpQixDQUFDLFFBQVEsR0FBRyxVQUFVLEdBQUcsSUFBUztZQUMvQyxJQUFJ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Q3BGLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVPLGdCQUFnQixDQUFDLEVBQVUsRUFBRSxTQUFrQjtRQUNuRCxNQUFNLEtBQUssQ0FBQyxvQkFBYSxDQUFDLDRCQUE0QixFQUNsRCxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLFNBQVMsYUFBVCxTQUFTLGNBQVQsU0FBUyxHQUFJLG9CQUFhLENBQUMsMkJBQTJCLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNoRyxDQUFDO0lBRU8sd0JBQXdCLENBQUMsR0FBVyxFQUFFLGNBQXNCO1FBQ2hFLE1BQU0sS0FBSyxDQUFDLG9CQUFhLENBQUMsZ0NBQWdDLEVBQ3RELEVBQUUsR0FBRyxFQUFFLGNBQWMsRUFBRSxjQUFjLGFBQWQsY0FBYyxjQUFkLGNBQWMsR0FBSSxvQkFBYSxDQUFDLDJCQUEyQixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDaEcsQ0FBQzs7QUEzTUwsd0NBNE1DO0FBM00wQixrQ0FBbUIsR0FBRyxXQUFXLENBQUM7QUFrTmhELFFBQUEsa0JBQWtCLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9AdHlwZXMvc3lzdGVtanMvc3lzdGVtanMuZC50c1wiLz5cbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9AdHlwZXMvc3lzdGVtanMvZXh0cmFzL25hbWVkLXJlZ2lzdGVyLmQudHNcIi8+XG5cbmltcG9ydCB7XG4gICAgc3lzdGVtSlNQcm90b3R5cGUsXG4gICAgc3lzdGVtSnNDb21tb24sXG4gICAgc2V0UmVzb2x1dGlvbkRldGFpbE1hcCxcbiAgICBjcmVhdGVEZXRhaWxSZXNvbHZlcixcbiAgICAvLyBAdHMtaWdub3JlXG59IGZyb20gJy4uLy4uL3N0YXRpYy9leGVjdXRvci9zeXN0ZW1qcy1icmlkZ2Uvb3V0JztcbmltcG9ydCBOb2RlVXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgeyBpMThuVHJhbnNsYXRlIH0gZnJvbSAnLi4vdXRpbHMvaTE4bic7XG5pbXBvcnQgdHlwZSB7IFJlc29sdXRpb25EZXRhaWxNYXAgfSBmcm9tICdAY29jb3MvY3JlYXRvci1wcm9ncmFtbWluZy1xdWljay1wYWNrL2xpYi9yZXNvbHV0aW9uLWRldGFpbC1tYXAnO1xuXG50eXBlIFN5c3RlbUpzUmVnaXN0cnkgPSBSZWNvcmQ8c3RyaW5nLCBNb2R1bGVSZWdpc3Rlcj47XG5cbnR5cGUgSW5zdGFudGlhdGlvbkhhbmRsZXIgPSAodXJsOiBzdHJpbmcpID0+IE1vZHVsZVJlZ2lzdGVyIHwgdW5kZWZpbmVkIHwgUHJvbWlzZTxNb2R1bGVSZWdpc3RlciB8IHVuZGVmaW5lZD47XG5cbmV4cG9ydCBjbGFzcyBFeGVjdXRvclN5c3RlbSB7XG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBwcm90b2NvbEhlYWRNb2RzTWdyID0gJ21vZHMtbWdyOic7XG5cbiAgICBwcml2YXRlIF9yZWdpc3RyeTogU3lzdGVtSnNSZWdpc3RyeSA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgcHJpdmF0ZSBfdmVuZG9yUmVnaXN0ZXJGbjogRnVuY3Rpb247XG4gICAgcHJpdmF0ZSBfbGFzdFJlZ2lzdGVyOiBNb2R1bGVSZWdpc3RlciB8IG51bGwgPSBudWxsO1xuICAgIHByaXZhdGUgX2Jhc2VVcmwgPSAncHJvamVjdDovLy8nO1xuICAgIHByaXZhdGUgX2luc3RhbnRpYXRpb25IYW5kbGVyczogSW5zdGFudGlhdGlvbkhhbmRsZXJbXSA9IFtdO1xuICAgIHByaXZhdGUgX2RldGFpbFJlc29sdmU6IChzcGVjaWZpZXI6IHN0cmluZywgaW1wb3J0ZXI/OiBzdHJpbmcpID0+IHZvaWQ7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgY29uc3QgbWUgPSB0aGlzO1xuICAgICAgICBpZiAoIXN5c3RlbUpTUHJvdG90eXBlLnByZXBhcmVJbXBvcnQpIHtcbiAgICAgICAgICAgIHN5c3RlbUpTUHJvdG90eXBlLnByZXBhcmVJbXBvcnQgPSAoKSA9PiB7fTtcbiAgICAgICAgfVxuICAgICAgICBzeXN0ZW1KU1Byb3RvdHlwZS5yZXNvbHZlID0gZnVuY3Rpb24gKC4uLmFyZ3M6IGFueSkge1xuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgcmV0dXJuIG1lLl9yZXNvbHZlKHRoaXMsIC4uLmFyZ3MpO1xuICAgICAgICB9O1xuICAgICAgICBzeXN0ZW1KU1Byb3RvdHlwZS5pbnN0YW50aWF0ZSA9IGZ1bmN0aW9uICguLi5hcmdzOiBhbnkpIHtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIHJldHVybiBtZS5faW5zdGFudGlhdGUodGhpcywgLi4uYXJncyk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuX3ZlbmRvclJlZ2lzdGVyRm4gPSBzeXN0ZW1KU1Byb3RvdHlwZS5yZWdpc3RlcjtcbiAgICAgICAgc3lzdGVtSlNQcm90b3R5cGUucmVnaXN0ZXIgPSBmdW5jdGlvbiAoLi4uYXJnczogYW55KSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgIHJldHVybiBtZS5zZXRSZWdpc3RlciguLi5hcmdzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIHJldHVybiBtZS5fcmVnaXN0ZXIodGhpcywgLi4uYXJncyk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuX2RldGFpbFJlc29sdmUgPSBjcmVhdGVEZXRhaWxSZXNvbHZlcihcbiAgICAgICAgICAgIHVuZGVmaW5lZCwgLy8gbG9nZ2VyLFxuICAgICAgICAgICAgdW5kZWZpbmVkLCAvLyByZWplY3RvclxuICAgICAgICApO1xuXG4gICAgICAgIC8vIFRPRE86IG1lcmdlIHN5c3RlbWpzIGltcGxlbWVudGF0aW9uXG4gICAgICAgIGNvbnN0IHVwdmFsdWVNYXA6IGFueSA9IHt9O1xuICAgICAgICBjb25zdCB2ZW5kb3JDcmVhdGVDb250ZXh0ID0gc3lzdGVtSlNQcm90b3R5cGUuY3JlYXRlQ29udGV4dDtcbiAgICAgICAgc3lzdGVtSlNQcm90b3R5cGUuY3JlYXRlQ29udGV4dCA9IGZ1bmN0aW9uIChpZDogc3RyaW5nKTogYW55IHtcbiAgICAgICAgICAgIGNvbnN0IG5hbWUyY2xhc3M6IGFueSA9IHt9O1xuICAgICAgICAgICAgY29uc3QgY29udGV4dCA9IHZlbmRvckNyZWF0ZUNvbnRleHQuY2FsbCh0aGlzLCBpZCk7XG4gICAgICAgICAgICB1cHZhbHVlTWFwW2NvbnRleHQudXJsXSA9IG5hbWUyY2xhc3M7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIC4uLmNvbnRleHQsXG4gICAgICAgICAgICAgICAgdXB2YWx1ZSAobmFtZTogc3RyaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0OiBhbnkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUyY2xhc3NbbmFtZV0gPSB0YXJnZXQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIGdldCBpbXBvcnRNYXAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9pbXBvcnRNYXA7XG4gICAgfVxuXG4gICAgYXN5bmMgaW1wb3J0KHVybDogc3RyaW5nKTogUHJvbWlzZTx1bmtub3duPiB7XG4gICAgICAgIHJldHVybiBhd2FpdCBTeXN0ZW0uaW1wb3J0KHVybCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUHJvdmlkZXMgdGhlIGxhc3QgYW5vbnltb3VzIGBTeXN0ZW0ucmVnaXN0ZXJgIGNhbGwuXG4gICAgICovXG4gICAgZ2V0UmVnaXN0ZXIoKSB7XG4gICAgICAgIGNvbnN0IGxhc3RSZWdpc3RlciA9IHRoaXMuX2xhc3RSZWdpc3RlcjtcbiAgICAgICAgdGhpcy5fbGFzdFJlZ2lzdGVyID0gbnVsbDtcbiAgICAgICAgcmV0dXJuIGxhc3RSZWdpc3RlcjtcbiAgICB9XG5cbiAgICBjbGVhckltcG9ydE1hcCgpIHtcbiAgICAgICAgdGhpcy5faW1wb3J0TWFwLmltcG9ydHMgPSB7fTtcbiAgICAgICAgdGhpcy5faW1wb3J0TWFwLnNjb3BlcyA9IHt9O1xuICAgIH1cblxuICAgIGV4dGVuZEltcG9ydE1hcChpbXBvcnRNYXA6IEltcG9ydE1hcCwgYmFzZVVybDogc3RyaW5nKSB7XG4gICAgICAgIHN5c3RlbUpzQ29tbW9uLnJlc29sdmVBbmRDb21wb3NlSW1wb3J0TWFwKGltcG9ydE1hcCwgYmFzZVVybCwgdGhpcy5faW1wb3J0TWFwKTtcbiAgICB9XG5cbiAgICBzZXRSZWdpc3RlcihpZDogc3RyaW5nLCBkZXBlbmRlbmNpZXM6IHN0cmluZ1tdLCBkZWNsYXJlOiBEZWNsYXJlKSB7XG4gICAgICAgIHRoaXMuX3JlZ2lzdHJ5W2lkXSA9IFtkZXBlbmRlbmNpZXMsIGRlY2xhcmVdO1xuICAgIH1cblxuICAgIGRlbGV0ZVJlZ2lzdGVyKGlkOiBzdHJpbmcpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMuX3JlZ2lzdHJ5W2lkXTtcbiAgICB9XG5cbiAgICBlbmNvZGVNb2RzTWdyUmVxdWVzdChpZDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke0V4ZWN1dG9yU3lzdGVtLnByb3RvY29sSGVhZE1vZHNNZ3J9JHtlbmNvZGVVUklDb21wb25lbnQoaWQpfWA7XG4gICAgICAgIHJldHVybiB1cmw7XG4gICAgfVxuXG4gICAgYWRkSW5zdGFudGlhdGlvbkhhbmRsZXIoaGFuZGxlcjogSW5zdGFudGlhdGlvbkhhbmRsZXIpIHtcbiAgICAgICAgdGhpcy5faW5zdGFudGlhdGlvbkhhbmRsZXJzLnB1c2goaGFuZGxlcik7XG4gICAgfVxuXG4gICAgc2V0UmVzb2x1dGlvbkRldGFpbE1hcChyZXNvbHV0aW9uRGV0YWlsTWFwOiBSZXNvbHV0aW9uRGV0YWlsTWFwLCB1cmw6IHN0cmluZykge1xuICAgICAgICBjb25zb2xlLmRlYnVnKGBTZXQgZGV0YWlsIG1hcCAke3VybH06ICR7SlNPTi5zdHJpbmdpZnkocmVzb2x1dGlvbkRldGFpbE1hcCwgdW5kZWZpbmVkLCAyKX1gKTtcbiAgICAgICAgc2V0UmVzb2x1dGlvbkRldGFpbE1hcChyZXNvbHV0aW9uRGV0YWlsTWFwLCB1cmwpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2ltcG9ydE1hcDogSW1wb3J0TWFwICYge1xuICAgICAgICBpbXBvcnRzOiBOb25OdWxsYWJsZTxJbXBvcnRNYXBbJ2ltcG9ydHMnXT47XG4gICAgICAgIHNjb3BlczogTm9uTnVsbGFibGU8SW1wb3J0TWFwWydzY29wZXMnXT47XG4gICAgfSA9IHtcbiAgICAgICAgaW1wb3J0czoge30sXG4gICAgICAgIHNjb3Blczoge30sXG4gICAgfTtcblxuICAgIHByaXZhdGUgX3Jlc29sdmUoXG4gICAgICAgIHN5c3RlbUpTUHJvdG90eXBlOiBTeXN0ZW1Kc1Byb3RvdHlwZSxcbiAgICAgICAgaWQ6IHN0cmluZyxcbiAgICAgICAgcGFyZW50VVJMPzogc3RyaW5nLFxuICAgICk6IHN0cmluZyB7XG4gICAgICAgIHBhcmVudFVSTCA9IHBhcmVudFVSTCA/PyB0aGlzLl9iYXNlVXJsO1xuXG4gICAgICAgIHRoaXMuX2RldGFpbFJlc29sdmUoaWQsIHBhcmVudFVSTCk7XG5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0gc3lzdGVtSnNDb21tb24ucmVzb2x2ZUltcG9ydE1hcChcbiAgICAgICAgICAgIHRoaXMuX2ltcG9ydE1hcCxcbiAgICAgICAgICAgIHN5c3RlbUpzQ29tbW9uLnJlc29sdmVJZk5vdFBsYWluT3JVcmwoaWQsIHBhcmVudFVSTCkgfHwgaWQsXG4gICAgICAgICAgICBwYXJlbnRVUkwsXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpZCBpbiB0aGlzLl9yZWdpc3RyeSkge1xuICAgICAgICAgICAgcmV0dXJuIGlkO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX3Rocm93VW5yZXNvbHZlZChpZCwgcGFyZW50VVJMKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9pbnN0YW50aWF0ZShcbiAgICAgICAgc3lzdGVtSlNQcm90b3R5cGU6IFN5c3RlbUpzUHJvdG90eXBlLFxuICAgICAgICB1cmw6IHN0cmluZyxcbiAgICAgICAgZmlyc3RQYXJlbnRVcmw6IHN0cmluZyxcbiAgICApOiBQcm9taXNlPE1vZHVsZVJlZ2lzdGVyPiB7XG4gICAgICAgIGlmICh1cmwgaW4gdGhpcy5fcmVnaXN0cnkpIHtcbiAgICAgICAgICAgIC8vIFRPRE86IHRoaXMuX3JlZ2lzdHJ5W3VybF0gPSBudWxsO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlZ2lzdHJ5W3VybF07XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGNvbnN0IGhhbmRsZXIgb2YgdGhpcy5faW5zdGFudGlhdGlvbkhhbmRsZXJzKSB7XG4gICAgICAgICAgICBjb25zdCByZWdpc3RlciA9IGF3YWl0IGhhbmRsZXIodXJsKTtcbiAgICAgICAgICAgIGlmIChyZWdpc3Rlcikge1xuICAgICAgICAgICAgICAgIHJldHVybiByZWdpc3RlcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBwYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICAgIGlmICh1cmwuc3RhcnRzV2l0aCgnZmlsZTonKSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBwYXRoID0gTm9kZVVybC5maWxlVVJMVG9QYXRoKHVybCk7XG4gICAgICAgICAgICB9IGNhdGNoIHsgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHVybC5zdGFydHNXaXRoKEV4ZWN1dG9yU3lzdGVtLnByb3RvY29sSGVhZE1vZHNNZ3IpKSB7XG4gICAgICAgICAgICBjb25zdCB1cmxPYmplY3QgPSBuZXcgVVJMKHVybCk7XG4gICAgICAgICAgICBjb25zdCBwYXRobmFtZSA9IHVybE9iamVjdC5wYXRobmFtZTtcbiAgICAgICAgICAgIGNvbnN0IGlkID0gZGVjb2RlVVJJQ29tcG9uZW50KHBhdGhuYW1lKTtcbiAgICAgICAgICAgIHJldHVybiBbW10sIChleHBvcnRCaW5kaW5ncyk6IERlY2xhcmVSZXN1bHQgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGV4ZWN1dGU6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1vZHNNZ3IgPSByZXF1aXJlKCdjYy9tb2RzLW1ncicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbW9kID0gbW9kc01nci5zeW5jSW1wb3J0KGlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4cG9ydEJpbmRpbmdzKG1vZCk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1dO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBhdGgpIHtcbiAgICAgICAgICAgIHJlcXVpcmUocGF0aCk7XG4gICAgICAgICAgICBjb25zdCByZWdpc3RlciA9IHRoaXMuZ2V0UmVnaXN0ZXIoKTtcbiAgICAgICAgICAgIGlmICghcmVnaXN0ZXIpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoaTE4blRyYW5zbGF0ZSgnZXhlY3V0b3Jfc3lzdGVtX2pzX25vX21vZHVsZV9yZWdpc3RlcmVkJywgeyB1cmwgfSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlZ2lzdGVyO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX3Rocm93SW5zdGFudGlhdGlvbkVycm9yKHVybCwgZmlyc3RQYXJlbnRVcmwpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWkhOeQhiBgU3lzdGVtLnJlZ2lzdGVyKClgIOiwg+eUqOOAglxuICAgICAqL1xuICAgIHByaXZhdGUgX3JlZ2lzdGVyKHN5c3RlbUpTUHJvdG90eXBlOiBTeXN0ZW1Kc1Byb3RvdHlwZSwgZGVwczogc3RyaW5nW10sIGRlY2xhcmU6IERlY2xhcmUpIHtcbiAgICAgICAgdGhpcy5fbGFzdFJlZ2lzdGVyID0gW2RlcHMsIGRlY2xhcmVdO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3Rocm93VW5yZXNvbHZlZChpZDogc3RyaW5nLCBwYXJlbnRVcmw/OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICB0aHJvdyBFcnJvcihpMThuVHJhbnNsYXRlKCdleGVjdXRvcl9mYWlsZWRfdG9fcmVzb2x2ZScsXG4gICAgICAgICAgICB7IHNwZWNpZmllcjogaWQsIHBhcmVudFVSTDogcGFyZW50VXJsID8/IGkxOG5UcmFuc2xhdGUoJ2V4ZWN1dG9yX3N5c3RlbV9qc19vcmlnaW4nKSB9KSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfdGhyb3dJbnN0YW50aWF0aW9uRXJyb3IodXJsOiBzdHJpbmcsIGZpcnN0UGFyZW50VXJsOiBzdHJpbmcpOiBNb2R1bGVSZWdpc3RlciB7XG4gICAgICAgIHRocm93IEVycm9yKGkxOG5UcmFuc2xhdGUoJ2V4ZWN1dG9yX2ZhaWxlZF90b19pbnN0YW50aWF0ZScsXG4gICAgICAgICAgICB7IHVybCwgZmlyc3RQYXJlbnRVUkw6IGZpcnN0UGFyZW50VXJsID8/IGkxOG5UcmFuc2xhdGUoJ2V4ZWN1dG9yX3N5c3RlbV9qc19vcmlnaW4nKSB9KSk7XG4gICAgfVxufVxuXG5pbnRlcmZhY2UgSW1wb3J0TWFwIHtcbiAgICBpbXBvcnRzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgICBzY29wZXM/OiBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+Pjtcbn1cblxuZXhwb3J0IGNvbnN0IGdsb2JhbEVkaXRvclN5c3RlbSA9IG5ldyBFeGVjdXRvclN5c3RlbSgpO1xuXG4iXX0=