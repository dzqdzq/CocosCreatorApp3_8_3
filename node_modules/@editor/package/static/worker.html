<html>
    <head>
        <title>Package Debugger</title>
    </head>

    <body></body>

    <script>
        let ps = require('path');
        let ipc = require('@base/electron-base-ipc');

        let pkg = {};

        // 初始化
        ipc.on('init', (event, path, dependencies) => {
            // 加载依赖的文件
            Object.keys(dependencies || {}).forEach((name) => {
                let file = dependencies[name];
                try {
                    require(file);
                } catch (error) {
                    console.log(error);
                }
            });
            try {
                pkg = require(path);
                event.reply(null);
            } catch(error) {
                console.error(error);
                event.reply(error);
            }
        });

        // 发送消息给 package
        ipc.on('method', async (event, name, ...args) => {
            const handle = pkg.methods[name];
            try {
                if (handle) {
                    const data = await handle.call(pkg, event, ...args);
                    event.reply(null, data);
                } else {
                    const error = new Error(`${method} method doesn't exist.`);
                    event.reply(error);
                }
            } catch (error) {
                event.reply(new Error(`Message response error: ${error.message}`));
            }
        });

        // 插件 load 成功
        ipc.on('load', async (event, ...args) => {
            debugger;
            if (typeof pkg.load !== 'function') {
                return event.reply(null);
            }
            try {
                const result = await pkg.load(...args);
                event.reply(null, result);
            } catch(error) {
                event.reply(error);
            }
            
        });

        // 插件 unload 成功
        ipc.on('unload', async (event, ...args) => {
            if (typeof pkg.unload !== 'function') {
                return event.reply(null);
            }
            try {
                const result = await pkg.unload(...args);
                event.reply(null, result);
            } catch(error) {
                event.reply(error);
            }
        });

        ipc.on('contributions', async (event, method, ...args) => {
            if (!pkg.contributions) {
                return event.reply(null);
            }
            if (typeof pkg.contributions[method] !== 'function') {
                return event.reply(null);
            }
            try {
                const result = await pkg.contributions[method](...args);
                event.reply(null, result);
            } catch(error) {
                event.reply(error);
            }
        });

        ipc.on('hooks', async (event, name, ...args) => {
            try {
                if (pkg.creator && pkg.creator.hooks && pkg.creator.hooks) {
                    const file = join(pkg.path, pkg.json.creator.hooks);
                    const hookMod = require(file);
                    hookMod[name] && hookMod[name].call(pkg, pkg.json);
                }
                return event.reply(null);
            } catch(error) {
                console.error(error);
                return event.reply(error);
            }
        });
    </script>
</html>