"use strict";var __awaiter=this&&this.__awaiter||function(e,o,n,t){return new(n||(n=Promise))(function(i,r){function s(e){try{d(t.next(e))}catch(e){r(e)}}function a(e){try{d(t.throw(e))}catch(e){r(e)}}function d(e){var o;e.done?i(e.value):(o=e.value,o instanceof n?o:new n(function(e){e(o)})).then(s,a)}d((t=t.apply(e,o||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.minimize=exports.maximize=exports.open=exports.startup=exports.openSimpleWindow=exports.openSubWindow=exports.generateBlank=exports.changeMinSize=exports.changeUserData=exports.queryUserData=exports.setAfterOpenHook=exports.setBeforeOpenHook=exports.hooks=void 0;const electron_1=require("electron"),ipc=require("@base/electron-base-ipc"),windows=require("@base/electron-windows"),panel=require("@editor/panel"),worker=require("@base/electron-worker"),fs_extra_1=require("fs-extra"),path_1=require("path"),constant_1=require("../constant");function setBeforeOpenHook(e){return __awaiter(this,void 0,void 0,function*(){exports.hooks.beforeOpen=e})}function setAfterOpenHook(e){return __awaiter(this,void 0,void 0,function*(){exports.hooks.afterOpen=e})}function queryUserData(e){return __awaiter(this,void 0,void 0,function*(){return windows.uuid2info[e]})}function changeUserData(e,o){return __awaiter(this,void 0,void 0,function*(){let n=windows.uuid2info[o];n&&JSON.stringify(n.userData)!==JSON.stringify(e)&&(n.userData=e,windows.emit("change"))})}function changeMinSize(e,o,n){return __awaiter(this,void 0,void 0,function*(){console.warn("ChangeMinSize needs to be done in a window.")})}let cacheWinID;function generateBlank(){return __awaiter(this,void 0,void 0,function*(){cacheWinID=yield open(constant_1.BLANK_HTML,{show:!1},{})})}function openSubWindow(e,o){return __awaiter(this,void 0,void 0,function*(){const n=windows.normalizeURL(constant_1.SUB_HTML,cacheWinID),t=windows.uuid2win[cacheWinID];if(!t||t.isDestroyed())console.warn("The cache window is destroyed. Try to reopen it"),open(constant_1.SUB_HTML,{width:e.width,height:e.height,center:!0},o);else{const i=windows.uuid2info[cacheWinID];i.userData=o,i.url=constant_1.SUB_HTML,t.setSize(e.width,e.height),t.once("ready-to-show",()=>{t.show(),t.focus()}),t.loadURL(n)}yield generateBlank()})}function openSimpleWindow(e,o){var n;return __awaiter(this,void 0,void 0,function*(){const t=windows.normalizeURL(constant_1.SIMPLE_HTML,cacheWinID),i=windows.uuid2win[cacheWinID];if(!i||i.isDestroyed())console.warn("The cache window is destroyed. Try to reopen it"),open(constant_1.SIMPLE_HTML,{minWidth:e["min-width"]||200,minHeight:e["min-height"]||200,width:e.width,height:e.height,resizable:null===(n=null===o||void 0===o?void 0:o.flags)||void 0===n?void 0:n.resizable,center:!0},o);else{const n=windows.uuid2info[cacheWinID];n.userData=o,n.url=constant_1.SIMPLE_HTML,i.setSize(e.width,e.height),i.once("ready-to-show",()=>{i.show(),i.focus()}),i.loadURL(t)}generateBlank()})}function startup(){return __awaiter(this,void 0,void 0,function*(){if(!(0,fs_extra_1.existsSync)(constant_1.SAVE_FILE)){const e={frame:!1,titleBarStyle:"hiddenInset",titleBarOverlay:48,autoHideMenuBar:!0,menuBarVisibility:!1};yield fillWindowOptions(e);const o={layout:yield Editor.Layout.query("default")};exports.hooks.beforeOpen&&exports.hooks.beforeOpen(e,o);const n=yield open(constant_1.MAIN_HTML,e,o);return windows.focus(n),exports.hooks.afterOpen&&exports.hooks.afterOpen(windows),yield generateBlank(),[n]}try{const e=yield(0,fs_extra_1.readJSON)(constant_1.SAVE_FILE);if(!e||!Array.isArray(e.windows)||0===e.windows.length)throw new Error("The window data is invalid.");const o=e.windows[0];o&&(o.options.frame=!1,o.options.titleBarStyle="hiddenInset",o.options.titleBarOverlay=48,o.options.autoHideMenuBar=!1,o.options.menuBarVisibility=!0);for(let o of e.windows)o&&(o.options.show=!0,o.options=o.options||{},o.options.webPreferences=o.options.webPreferences||{},yield fillWindowOptions(o.options),exports.hooks.beforeOpen&&exports.hooks.beforeOpen(o.options,o.userData),o.url=(0,path_1.join)(__dirname,"../../../static/windows",(0,path_1.basename)(o.url)));const n=yield windows.restore(e);windows.focus(n[0]);try{exports.hooks.afterOpen&&(yield exports.hooks.afterOpen(windows))}catch(e){console.warn(e)}return yield generateBlank(),n}catch(e){console.warn("Recovery window failed."),console.warn(e),yield(0,fs_extra_1.copyFile)(constant_1.SAVE_FILE,constant_1.SAVE_FILE+".backup");const o={frame:!1,titleBarStyle:"hiddenInset",titleBarOverlay:48,autoHideMenuBar:!1,menuBarVisibility:!0};yield fillWindowOptions(o);const n={layout:yield Editor.Layout.query("default")};exports.hooks.beforeOpen&&exports.hooks.beforeOpen(o,n);const t=yield open(constant_1.MAIN_HTML,o,n);windows.focus(t);try{exports.hooks.afterOpen&&(yield exports.hooks.afterOpen(windows))}catch(e){console.warn(e)}return yield generateBlank(),[t]}})}function open(e,o={},n={}){return __awaiter(this,void 0,void 0,function*(){return fillWindowOptions(o),yield windows.open(e,o,n)})}function maximize(){console.warn("Maximization needs to be done in a window.")}function minimize(){console.warn("Minimization needs to be done in a window.")}function close(){console.warn("Close needs to be done in a window.")}function save(){return __awaiter(this,void 0,void 0,function*(){const e=JSON.parse(JSON.stringify(windows.dump()));for(let n=0;n<e.windows.length;n++){const t=e.windows[n];if(t.url=(0,path_1.basename)(t.url),cuttingWindowOptions(t.options),t.userData)if(t.userData.panel){const o=panel.queryInfo(t.userData.panel);o&&o.userData.flags&&o.userData.flags.save||(e.windows.splice(n,1),n--)}else t.userData.layout&&o(t.userData.layout.layout)||(e.windows.splice(n,1),n--);else e.windows.splice(n,1),n--;function o(e){if(e.panels){return e.panels.some(e=>{const o=panel.queryInfo(e);return!(!o||!o.userData.flags)&&!!o.userData.flags.save})}return e.children.some(e=>o(e))}}if(0!==e.windows.length)try{yield(0,fs_extra_1.outputJSON)(constant_1.SAVE_FILE,e,{spaces:2})}catch(e){}})}function fillOption(e,o,n,t){!t&&o in e||(e[o]=n)}function fillWindowOptions(e){return __awaiter(this,void 0,void 0,function*(){fillOption(e,"center",!0),fillOption(e,"width",1100),fillOption(e,"height",700),fillOption(e,"autoHideMenuBar",!0),fillOption(e,"menuBarVisibility",!1),fillOption(e,"transparent",!1),fillOption(e,"resizable",!0),fillOption(e,"show",!0),fillOption(e,"webPreferences",{}),fillOption(e.webPreferences,"nodeIntegration",!0,!0),fillOption(e.webPreferences,"webviewTag",!0,!0),fillOption(e.webPreferences,"enableRemoteModule",!0,!0),fillOption(e.webPreferences,"contextIsolation",!1,!0),fillOption(e.webPreferences,"backgroundThrottling",!1,!0)})}function cuttingWindowOptions(e){return __awaiter(this,void 0,void 0,function*(){delete e.frame,delete e.transparent,delete e.resizable,delete e.minimizable,delete e.titleBarStyle,delete e.titleBarOverlay,delete e.fullscreen,delete e.show,delete e.autoHideMenuBar,e.menuBarVisibility=!0})}exports.hooks={beforeOpen:null,afterOpen:null},exports.setBeforeOpenHook=setBeforeOpenHook,exports.setAfterOpenHook=setAfterOpenHook,exports.queryUserData=queryUserData,exports.changeUserData=changeUserData,exports.changeMinSize=changeMinSize,exports.generateBlank=generateBlank,exports.openSubWindow=openSubWindow,exports.openSimpleWindow=openSimpleWindow,exports.startup=startup,exports.open=open,exports.maximize=maximize,exports.minimize=minimize,exports.close=close,windows.on("change",save),windows.on("close",save);const startUpTime=Date.now();let activeTime=startUpTime;setInterval(()=>{try{const e=Date.now();Editor.Metrics._trackEventWithTimer({category:"editor",id:"A100002",value:((e-activeTime)/1e3/60*100|0)/100}),activeTime=e}catch(e){}},6e4),windows.on("clear",()=>{const e=String((Date.now()-startUpTime)/1e3|0);Editor.Metrics.trackEvent({sendToCocosAnalyticsOnly:!0,eventId:"CreatorLogout",projectId:Editor.Project.uuid,onlineDuration:e}),Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"editor",value:{A100001:1}}),Editor.Metrics.trackEvent({category:"logout",exitTag:"successed",onlineDuration:e}),Editor.Metrics.__protected__._sendEventGroup(),Editor.Metrics.close(),setTimeout(()=>{process.exit(0)},1e3)}),windows.on("clear",()=>{worker.clear()}),ipc.on("editor-lib-windows:focus",e=>{const o=electron_1.BrowserWindow.fromWebContents(e.sender);if(o){o!==electron_1.BrowserWindow.getFocusedWindow()&&o.focus()}}),ipc.on("editor-lib-windows:maximize",e=>{const o=electron_1.BrowserWindow.fromWebContents(e.sender);o&&(o.isMaximized()?o.unmaximize():o.maximize())}),ipc.on("editor-lib-windows:minimize",e=>{const o=electron_1.BrowserWindow.fromWebContents(e.sender);o&&o.minimizable&&o.minimize()}),ipc.on("editor-lib-windows:isMaximized",e=>{const o=electron_1.BrowserWindow.fromWebContents(e.sender);return!(!o||!o.isMaximized())}),ipc.on("editor-lib-windows:open",(e,o,n,t)=>{open(o,n,t)}),ipc.on("editor-lib-windows:close",e=>{const o=electron_1.BrowserWindow.fromWebContents(e.sender);o&&o.closable&&o.close()}),ipc.on("editor-lib-windows:generateBlank",(e,o,n)=>{openSimpleWindow(o,n)}),ipc.on("editor-lib-windows:openSubWindow",(e,o,n)=>{openSubWindow(o,n)}),ipc.on("editor-lib-windows:openSimpleWindow",(e,o,n)=>{openSimpleWindow(o,n)});