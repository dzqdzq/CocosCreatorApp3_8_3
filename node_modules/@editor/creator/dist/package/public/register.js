"use strict";var __awaiter=this&&this.__awaiter||function(e,o,r,t){return new(r||(r=Promise))(function(i,a){function n(e){try{c(t.next(e))}catch(e){a(e)}}function s(e){try{c(t.throw(e))}catch(e){a(e)}}function c(e){var o;e.done?i(e.value):(o=e.value,o instanceof r?o:new r(function(e){e(o)})).then(n,s)}c((t=t.apply(e,o||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.profile=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),utils_1=require("../utils"),Profile=require("@base/electron-profile"),data={global:Profile.load("global://editor/package.json"),local:Profile.load("local://editor/package.json"),project:Profile.load("project://editor/package.json")},MigrationType={global:"migrateGlobal",local:"migrateLocal",project:"migrateProject"};function getJsonPath(e,o){switch(e){case"local":return(0,path_1.join)(Editor.Project.path,"profiles","v2","packages",o+".json");case"project":return(0,path_1.join)(Editor.Project.path,"settings","v2","packages",o+".json");case"global":return(0,path_1.join)(Editor.App.home,"profiles","v2","packages",o+".json")}}function profile(e){return __awaiter(this,void 0,void 0,function*(){const o=e.info;let r=[];Array.isArray(o.migrations)&&(o.migrations.forEach(o=>{o.profile&&(o.profile=(0,path_1.join)(e.path,o.profile)),o.custom&&(o.custom=(0,path_1.join)(e.path,o.custom))}),o.migrations.sort((e,o)=>(0,utils_1.compareVersion)(e.version,o.version||"")),Editor.Profile.__protected__._registerMigration(e.name,o.migrations),r=o.migrations.filter(e=>e.version&&e.custom));const t=["global","local","project"].map(t=>__awaiter(this,void 0,void 0,function*(){const i=Editor.Profile.__protected__.ensureProfiles(e.name),a=i[t].get("__version__");if(e.version!==a&&i[t].set("__version__",e.version),!Array.isArray(o.migrations)||e.version===a)return;const n=getJsonPath(t,e.name);if(n&&(0,fs_extra_1.existsSync)(n)){console.debug(`[Package] Profile Migrate ${t}: [${a} -> ${e.version}]: ${e.name}@${o.author}...`);const n=i[t].get("")||{};try{yield Editor.Profile.__protected__[MigrationType[t]](e.name,a,n,e.version),i[t].set("",n)}catch(r){console.error(`[Package] Custom Migrate error [${a} -> ${e.version}] (${t} profile): ${e.name}@${o.author}(${e.version})`),console.error(r)}for(const i of r){if((0,utils_1.compareVersion)(i.version,e.version||"")<=0)try{console.debug(`[Package] Custom Migrate ${t} [${a} -> ${e.version}]: ${e.name}@${o.author}(${i.version})`);const r=require(i.custom);r[MigrationType[t]]&&(yield r[MigrationType[t]](e.name,a,n,e.version))}catch(r){return console.error(`[Package] Custom Migrate ${t} [${a} -> ${e.version}] error(${t}): ${e.name}@${o.author}(${i.version})`),void console.error(r)}}}else{const r=i[t].get("")||{};try{if(!o.migrations.find(e=>"0.0.0"===e.version))return;const a=yield Editor.Profile.__protected__[MigrationType[t]](e.name,"0.0.0",r,e.version);i[t].set("",r),a&&i[t].save()}catch(r){console.error(`[Package] Custom Migrate error(${t} profile): ${e.name}@${o.author}(0.0.0)`),console.error(r)}}i[t].save()}));return Promise.all(t)})}exports.profile=profile;