"use strict";var __awaiter=this&&this.__awaiter||function(e,a,r,t){return new(r||(r=Promise))(function(n,o){function i(e){try{s(t.next(e))}catch(e){o(e)}}function c(e){try{s(t.throw(e))}catch(e){o(e)}}function s(e){var a;e.done?n(e.value):(a=e.value,a instanceof r?a:new r(function(e){e(a)})).then(i,c)}s((t=t.apply(e,a||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getPath=exports.disable=exports.enable=exports.unregister=exports.register=exports.getPackages=void 0;const electron_1=require("electron"),url_1=require("url"),path_1=require("path"),register_1=require("./register"),ipc=require("@base/electron-base-ipc"),packageManager=require("@editor/package"),protectedModule=require("../protected");function getPackages(e){e=e||{};const a=[];return Object.keys(packageManager.path2pkg).forEach(r=>{const t=packageManager.path2pkg[r];"name"in e&&e.name!==t.name||"debug"in e&&e.debug!==t.debug||"path"in e&&e.path!==t.path||"enable"in e&&e.enable!==t.enabled||t.invalid||a.push(t.generateInfo())}),a}function register(e){if(e=protectedModule.adapter.normalizePath(e),packageManager.path2pkg[e])return!1;try{const a=packageManager.register(e);return"string"!=typeof a.name?(console.warn(`Invalid name: The extension name is not defined \n  ${e}.`),!1):(a.name=a.name.toLowerCase(),(0,register_1.profile)(a),!0)}catch(a){return console.error(`[Extension] Register error: ${e}`),console.error(a),!1}}function unregister(e){return __awaiter(this,void 0,void 0,function*(){e=protectedModule.adapter.normalizePath(e);const a=packageManager.path2pkg[e];if(a){a.enabled&&(yield disable(e));try{yield packageManager.unregister(e)}catch(e){console.error(e)}}})}function enable(e){return __awaiter(this,void 0,void 0,function*(){e=protectedModule.adapter.normalizePath(e);const a=packageManager.path2pkg[e];if(a){if(!a.enabled)if(/\./.test(a.name))console.warn(`[Package] The extension name is invalid: ${a.name}\n  ${e}`);else if(!a.json.editor||protectedModule.adapter.checkVersion(a.json.editor)){if(a.json.package_version){if(2!==a.json.package_version)return void console.warn(`[Package] Skip ${a.json.name}: The package_version does not match.`)}else console.warn(`[Package] ${a.json.name}: package_version is not defined`);protectedModule.adapter.checkReload(e)&&(yield unregister(e),yield register(e));try{yield protectedModule.adapter.disableOther(e),yield packageManager.enable(e),yield protectedModule.adapter.removeDisableInfo(e)}catch(a){console.error(`[Package] Enable error: ${e}`),console.error(a)}}else console.warn(`[Package] Skip ${a.json.name}: Require the editor version ${a.json.editor}`)}else console.warn(`[Package] Unknown and unable to start\n  ${e}`)})}function disable(e,a={}){return __awaiter(this,void 0,void 0,function*(){e=protectedModule.adapter.normalizePath(e);const r=packageManager.path2pkg[e];if(r){r.panels.forEach(e=>{Editor.Panel.close(e)});try{yield packageManager.disable(e)}catch(e){console.error(`[Package] Disable error: ${r.path}`),console.error(e)}protectedModule.adapter.addDisableInfo(e),!1!==a.replacement&&(yield protectedModule.adapter.enableOther(e))}})}function getPath(e){const a=this.getPackages({name:e,enable:!0});return a[0]?a[0].path:""}exports.getPackages=getPackages,exports.register=register,exports.unregister=unregister,exports.enable=enable,exports.disable=disable,exports.getPath=getPath,electron_1.protocol.registerSchemesAsPrivileged([{scheme:"packages",privileges:{standard:!0,secure:!1}}]),electron_1.app.once("ready",()=>{electron_1.protocol.registerFileProtocol("packages",(e,a)=>{const r=(0,url_1.parse)(e.url),t=packageManager.find(r.host);a(t?(0,path_1.join)(t.path,r.pathname||""):"")})}),ipc.on("editor3d-lib-package:call",(e,a,...r)=>__awaiter(void 0,void 0,void 0,function*(){try{const t=yield module.exports[a](...r),n=JSON.stringify(t);return e.reply(null,n),n}catch(a){throw e.reply(a,null),a}}));