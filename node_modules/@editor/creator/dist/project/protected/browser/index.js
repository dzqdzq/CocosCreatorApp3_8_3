"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))(function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}c((o=o.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.add=exports.open=exports.create=exports.init=exports.getLastEditorVersion=exports.tmpDir=exports.name=exports.uuid=exports.path=exports.type=void 0;const fs_extra_1=require("fs-extra"),node_uuid_1=require("node-uuid"),path_1=require("path"),setting=require("@editor/setting"),ipc=require("@base/electron-base-ipc"),project=require("@editor/project"),configFile=(0,path_1.join)(setting.PATH.HOME,"editor/project.json");function save(){const e=project.dump();(0,fs_extra_1.outputJSONSync)(configFile,e,{spaces:2}),ipc.broadcast("editor3d-lib-project:update")}function checkProjectJson(e){return e.projects&&e.projects.forEach((t,r)=>{(0,fs_extra_1.existsSync)(t.path)||e.projects.splice(r,1)}),e}(()=>{if(!(0,fs_extra_1.existsSync)(configFile))return;let e;try{e=(0,fs_extra_1.readJSONSync)(configFile)}catch(t){console.error(t),e={}}e=checkProjectJson(e),(0,fs_extra_1.outputJSONSync)(configFile,e),project.init(e)})(),project.on("add",save).on("remove",save).on("open",save),exports.type="3d",exports.path="",exports.uuid="",exports.name="",exports.tmpDir="";let lastEditorVersion=null;function getLastEditorVersion(){return __awaiter(this,void 0,void 0,function*(){return lastEditorVersion})}function init(){var e;return __awaiter(this,void 0,void 0,function*(){if(!setting.PATH.PROJECT)return;const t=(0,path_1.join)(setting.PATH.PROJECT,"package.json");"darwin"===process.platform&&Editor.App.path.startsWith("/private")&&(yield Editor.Dialog.error(Editor.I18n.t("project.macSandbox")),process.exit(1)),(0,fs_extra_1.existsSync)(setting.PATH.PROJECT)&&(0,fs_extra_1.existsSync)(t)||(yield Editor.Dialog.error(Editor.I18n.t("project.notExists")),process.exit(1));const r=(0,fs_extra_1.readJSONSync)(t);let o=!1;lastEditorVersion=(null===(e=r.creator)||void 0===e?void 0:e.version)||r.version,r.creator=r.creator||{},r.creator.version!==Editor.App.version&&(r.creator.version=Editor.App.version,o=!0),r.uuid||(o=!0,r.uuid=(0,node_uuid_1.v4)()),o&&(0,fs_extra_1.outputJSONSync)(t,r,{spaces:2}),exports.path=(0,path_1.normalize)(setting.PATH.PROJECT),exports.uuid=r.uuid,exports.name=r.name||"",exports.tmpDir=(0,path_1.join)(exports.path,"temp"),(0,fs_extra_1.ensureDirSync)(exports.tmpDir)})}function create(){process.send?process.send({channel:"show-dashboard",options:{host:"creator-project"}}):Editor.Dialog.error("Project warnning",{detail:Editor.I18n.t("menu.dashboard_missing"),default:0,cancel:0,buttons:["Cancel"]})}function open(e){process.send?process.send({channel:"open-project",options:{path:e,tab:0,type:"3d"}}):Editor.Dialog.error("Project warnning",{detail:Editor.I18n.t("menu.dashboard_missing"),default:0,cancel:0,buttons:["Cancel"]})}function add(e){project.add(e)}exports.getLastEditorVersion=getLastEditorVersion,project.setOpenHandler(e=>{if(!process.send)return Editor.Dialog.error("Project warnning",{detail:Editor.I18n.t("menu.dashboard_missing"),default:0,cancel:0,buttons:["Cancel"]});process.send({channel:"open-project",path:e})}),exports.init=init,exports.create=create,exports.open=open,exports.add=add,ipc.on("editor3d-lib-project:call",(e,t,...r)=>__awaiter(void 0,void 0,void 0,function*(){const o=yield module.exports[t](...r);return e.reply(null,o),o})),ipc.on("editor3d-lib-project:get",(e,t)=>module.exports[t]);