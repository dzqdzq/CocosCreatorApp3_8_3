"use strict";var __awaiter=this&&this.__awaiter||function(r,e,t,i){return new(t||(t=Promise))(function(o,n){function a(r){try{c(i.next(r))}catch(r){n(r)}}function s(r){try{c(i.throw(r))}catch(r){n(r)}}function c(r){var e;r.done?o(r.value):(e=r.value,e instanceof t?e:new t(function(r){r(e)})).then(a,s)}c((i=i.apply(r,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrateProject=exports.migrateLocal=exports.migrateGlobal=exports._unregisterMigration=exports._registerMigration=void 0;const migrationsMap={},StartVerison="0.0.0";function _registerMigration(r,e){e=e.filter(r=>r.profile),migrationsMap[r]=e}function _unregisterMigration(r){migrationsMap[r]&&(migrationsMap[r].forEach(r=>{Editor.Module.__protected__.removeCache(r.profile)}),delete migrationsMap[r])}function migrateGlobal(r,e,t,i){return __awaiter(this,void 0,void 0,function*(){return!!migrationsMap[r]&&(yield runMigrateHandle("migrateGlobal",r,e,t,i))})}function migrateLocal(r,e,t,i){return __awaiter(this,void 0,void 0,function*(){return!!migrationsMap[r]&&(yield runMigrateHandle("migrateLocal",r,e,t,i))})}function migrateProject(r,e,t,i){return __awaiter(this,void 0,void 0,function*(){return!!migrationsMap[r]&&(yield runMigrateHandle("migrateProject",r,e,t,i))})}function runMigrateHandle(r,e,t,i,o){return __awaiter(this,void 0,void 0,function*(){let n=[];if(t===StartVerison){const r=migrationsMap[e].find(r=>r.version===StartVerison);if(!r)return;n=[r]}else n=t?migrationsMap[e].filter(r=>Editor.Package.__protected__.compareVersion(r.version,t)>0&&(!o||Editor.Package.__protected__.compareVersion(r.version,o)<=0)):migrationsMap[e].filter(r=>r.version!==StartVerison&&(!o||Editor.Package.__protected__.compareVersion(r.version,o)<=0));if(!n.length)return!1;for(const t of n){const o=Editor.Module.__protected__.requireFile(t.profile);if(o[r])try{yield o[r](i),console.debug(`[Package] Profile ${r}: ${e}(${t.version})...`)}catch(i){console.error(i),console.error(`[Package] Profile ${r}: ${e}(${t.version}) failed!`)}}return!0})}exports._registerMigration=_registerMigration,exports._unregisterMigration=_unregisterMigration,exports.migrateGlobal=migrateGlobal,exports.migrateLocal=migrateLocal,exports.migrateProject=migrateProject;