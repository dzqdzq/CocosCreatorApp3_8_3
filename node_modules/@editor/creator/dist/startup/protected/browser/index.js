"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))(function(a,n){function o(e){try{c(i.next(e))}catch(e){n(e)}}function s(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((i=i.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeListener=exports.once=exports.on=exports.test=exports.build=exports.startPackage=exports.manager=exports.window=exports.init=exports._builtinJSON=exports.ready=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),app_1=require("../../../app"),task_1=require("../../../task"),i18n_1=require("../../../i18n"),package_1=require("../../../package"),browser_1=require("../../../project/protected/browser"),windows_1=require("../../../windows"),layout_1=require("../../../layout"),path_2=require("path"),init_1=require("./init"),events_1=require("events"),ipc=require("@base/electron-base-ipc"),windows=require("@base/electron-windows"),pkg=require("@editor/package"),Metrics=require("../../../metrics/protected/browser"),emitter=new events_1.EventEmitter;function init(e){return(0,init_1.init)(e)}function window(e){return __awaiter(this,void 0,void 0,function*(){task_1.Task.addSyncTask("Waiting windows");try{e.beforeOpen&&windows_1.Windows.__protected__.setBeforeOpenHook(e.beforeOpen),e.afterOpen&&windows_1.Windows.__protected__.setAfterOpenHook(e.afterOpen);const t=yield windows_1.Windows.__protected__.startup(),r=windows.uuid2win[t[0]];r&&(app_1.App.__userAgent=r.webContents.getUserAgent())}catch(e){console.error(e)}finally{exports.ready.window=!0,emitter.emit("window-ready"),ipc.broadcast("editor3d-lib-startup:emit","window")}task_1.Task.removeSyncTask("Waiting windows")})}function manager(e,t){var r,i;return __awaiter(this,void 0,void 0,function*(){if(task_1.Task.addSyncTask("Starting Manager"),yield(0,browser_1.init)(),e?Editor.User.skip():yield Editor.User.__protected__.init(),null===(r=exports._builtinJSON.env)||void 0===r?void 0:r.LAYOUT)try{const e=(0,fs_extra_1.readJSONSync)(exports._builtinJSON.env.LAYOUT);layout_1.Layout.__protected__.init(e)}catch(e){console.warn(e)}(null===(i=exports._builtinJSON.env)||void 0===i?void 0:i.LANGUAGE)&&i18n_1.I18n.select(exports._builtinJSON.env.LANGUAGE);try{yield Metrics.init(t)}catch(e){console.error(e)}Metrics.trackEvent({category:"Editor",action:"Cocos Creator Open"}),Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"editor",value:{A100000:1}}),task_1.Task.removeSyncTask("Starting Manager")})}function startPackage(e={}){return __awaiter(this,void 0,void 0,function*(){task_1.Task.addSyncTask("Starting Package");let t=init_1.builtin.disableBuiltin;try{if(Array.isArray(init_1.builtin.extensions))for(let e of init_1.builtin.extensions)(0,path_2.isAbsolute)(e)||(e=(0,path_1.join)(app_1.App.path,"..",e)),yield package_1.Package.register(e)}catch(e){console.error(e)}Array.isArray(t)||(t=[]);try{e.preList=e.preList||[],e.list=e.list||[];for(let r=0;r<e.preList.length;r++){const i=e.preList[r],a=(0,path_1.basename)(i);if(!t.includes(a)){task_1.Task.addSyncTask(`startup.${a}`,i18n_1.I18n.t("startup.load_package",{name:a}));try{yield package_1.Package.register(i),yield package_1.Package.enable(i)}catch(e){console.error(`[Package] Register error: ${i}`),console.error(e)}task_1.Task.removeSyncTask(`startup.${a}`)}}for(let t=0;t<e.list.length;t++){const r=e.list[t];try{yield package_1.Package.register(r)}catch(e){console.error(`[Package] Register error: ${r}`),console.error(e)}}task_1.Task.addSyncTask("startup.PckageManager","Scan Extensions"),yield package_1.Package.__protected__.startup((r,i)=>__awaiter(this,void 0,void 0,function*(){if(!e.preList.includes(i)&&!t.includes(r)){task_1.Task.addSyncTask(`startup.${r}`,i18n_1.I18n.t("startup.load_package",{name:r}));try{yield new Promise(e=>{setTimeout(e,20)}),yield package_1.Package.enable(i)}catch(e){console.error(`[Package] Enable error: ${i}`),console.error(e)}task_1.Task.removeSyncTask(`startup.${r}`)}})),task_1.Task.removeSyncTask("startup.PckageManager")}catch(e){console.error(e)}finally{exports.ready.package=!0,emitter.emit("package-ready"),ipc.broadcast("editor3d-lib-startup:emit","package")}task_1.Task.removeSyncTask("Starting Package")})}function build(e,t){return __awaiter(this,void 0,void 0,function*(){return new Promise((r,i)=>{pkg.exec("builder","command-build",e,t).callback((e,t)=>{if(e)return i(e);r(t)})})})}function test(e,t){return __awaiter(this,void 0,void 0,function*(){return new Promise((r,i)=>{pkg.exec("tester","auto-test",e,t).callback((e,t)=>{if(e)return i(e);r(t)})})})}function on(e,t){emitter.on(e,t)}function once(e,t){emitter.once(e,t)}function removeListener(e,t){emitter.removeListener(e,t)}exports.ready={window:!1,package:!1},exports._builtinJSON=init_1.builtin,exports.init=init,exports.window=window,exports.manager=manager,exports.startPackage=startPackage,exports.build=build,exports.test=test,exports.on=on,exports.once=once,exports.removeListener=removeListener,ipc.on("editor3d-lib-startup:get",(e,t)=>module.exports[t]);