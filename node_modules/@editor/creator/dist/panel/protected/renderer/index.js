"use strict";var __awaiter=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))(function(i,r){function l(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(l,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports._openDevTools=exports.querySelector=exports.has=exports.focus=exports.close=exports.openBeside=exports.open=exports.openKit=exports.preloadKit=exports.closeKit=exports.holdKit=void 0;const ipc=require("@base/electron-base-ipc"),panel=require("@editor/panel"),path_1=require("path"),electron_1=require("electron");let kitID=1;const cache={id:0,listeners:{}};function holdKit(){return new Promise(e=>{ipc.send("editor-lib-panel:call","holdKit").callback(()=>{e()})})}function closeKit(e){return new Promise(t=>{ipc.send("editor-lib-panel:call","closeKit",e).callback(()=>{t()})})}function preloadKit(){return new Promise(e=>{ipc.send("editor-lib-panel:call","preload").callback(()=>{e()})})}function openKit(e,t){return __awaiter(this,void 0,void 0,function*(){const o=t.elem.getBoundingClientRect(),n={params:t.params,listeners:Object.keys(t.listeners||t.events||{}),kitID:kitID++,screen:{x:globalThis.screen.availLeft,y:globalThis.screen.availTop,width:globalThis.screen.availWidth,height:globalThis.screen.availHeight},position:{x:o.x,y:o.y+o.height}};return cache.id=n.kitID,cache.listeners=t.listeners,new Promise((t,o)=>{ipc.send("editor-lib-panel:open-kit",e,n).callback((e,n)=>{if(e)return o(e);t(!!n)})})})}function open(e,...t){return new Promise(o=>{ipc.send("editor-lib-panel:call","open",e,...t).callback((e,t)=>{o(!!t)})})}function openBeside(e,t,...o){return new Promise(n=>{ipc.send("editor-lib-panel:call","openBeside",e,t,...o).callback((e,t)=>{n(!!t)})})}function close(e){return ipc.send("editor-lib-panel:call","close",e),Promise.resolve(void 0)}function focus(e){return new Promise(t=>{ipc.send("editor-lib-panel:call","focus",e).callback((e,o)=>{t(!!o)})})}function has(e){return __awaiter(this,void 0,void 0,function*(){return new Promise((t,o)=>{ipc.send("editor-lib-panel:call","has",e).callback((e,n)=>{if(e)return o();t(!!n)})})})}function querySelector(e,t){return __awaiter(this,void 0,void 0,function*(){return panel.query(e).map(e=>Array.from(e.shadowRoot.querySelectorAll(t)))})}function _openDevTools(e){ipc.send("editor-lib-panel:call","_openDevTools",e)}exports.holdKit=holdKit,exports.closeKit=closeKit,exports.preloadKit=preloadKit,exports.openKit=openKit,exports.open=open,exports.openBeside=openBeside,exports.close=close,exports.focus=focus,exports.has=has,exports.querySelector=querySelector,ipc.on("editor-lib-panel:close",(e,t)=>__awaiter(void 0,void 0,void 0,function*(){const o=panel.query(t);if(!o||!o[0])return e.reply(null,!0);const n=o[0];if(!n.parentElement||!n.parentElement.$groups)return e.reply(null,!0),void("kit"!==document.body.getAttribute("name")&&window.close());if(o.length<=1&&n.userData&&n.userData.panel){const e=(0,path_1.join)(n.userData.packageDir,n.userData.panel);Editor.Module.__protected__.removeCache(e)}const i=yield n.parentElement.$groups.removePanel(t);return e.reply(null,!(!1===i))})),exports._openDevTools=_openDevTools,ipc.on("editor-lib-panel:close",(e,t)=>__awaiter(void 0,void 0,void 0,function*(){const o=panel.query(t);if(!o||!o[0])return e.reply(null,!0);const n=o[0];if(!n.parentElement||!n.parentElement.$groups)return e.reply(null,!0),void("kit"!==document.body.getAttribute("name")&&window.close());if(o.length<=1&&n.userData&&n.userData.panel){const e=(0,path_1.join)(n.userData.packageDir,n.userData.panel);Editor.Module.__protected__.removeCache(e)}const i=yield n.parentElement.$groups.removePanel(t);return e.reply(null,!(!1===i))})),ipc.on("editor-lib-panel:query-selection-text",e=>{const t=(window.getSelection()||"").toString();e.reply(null,t)}),ipc.on("editor-lib-panel:query-active-element-tag",(e,t)=>{const o=function e(t){return t&&t.shadowRoot?e(t.shadowRoot.activeElement):t}(document.activeElement);e.reply(null,o?o.tagName.toLowerCase():"")}),ipc.on("editor-lib-panel:open-beside",(e,t,o)=>{const n=document.querySelector("dock-frame");n&&n.appendPanel&&n.appendPanel(t,o)}),electron_1.ipcRenderer.on("editor-lib-panel:kit-panel-emit",(e,t,o,n)=>{t===cache.id&&cache.listeners[o]&&cache.listeners[o](n)});