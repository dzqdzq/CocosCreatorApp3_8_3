"use strict";var __awaiter=this&&this.__awaiter||function(e,i,t,n){return new(t||(t=Promise))(function(r,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function u(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var i;e.done?r(e.value):(i=e.value,i instanceof t?i:new t(function(e){e(i)})).then(s,u)}l((n=n.apply(e,i||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.unregister=exports.register=exports.hide=exports.show=exports.transform=exports.open=exports.destroy=exports.preload=exports.init=exports.getBlurTimeout=exports.setBlurTimeout=exports.setKitHoldFlag=void 0;const panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),electron_1=require("electron"),path_1=require("path"),kitHTML=(0,path_1.join)(__dirname,"../../../../static/windows/kit.html");let holdKitFlag=!1;function setKitHoldFlag(e){holdKitFlag=e}exports.setKitHoldFlag=setKitHoldFlag;let closeTimer,currentParentWindow=null,win=null,blurTimeout=100,blurTimer=null;function setBlurTimeout(e){blurTimeout=e}function getBlurTimeout(){return blurTimeout}function init(){return __awaiter(this,void 0,void 0,function*(){if(!win||win.isDestroyed())return(win=new electron_1.BrowserWindow({x:0,y:0,width:100,height:100,show:!1,autoHideMenuBar:!0,frame:!1,resizable:!1,skipTaskbar:!0,webPreferences:{nodeIntegration:!0,webviewTag:!0,enableRemoteModule:!0,contextIsolation:!1,backgroundThrottling:!1},fullscreenable:!1})).loadFile(kitHTML),win.addListener("blur",()=>{clearTimeout(blurTimer),clearTimeout(closeTimer),blurTimer=setTimeout(()=>{holdKitFlag?holdKitFlag=!1:hide()},blurTimeout)}),win.addListener("focus",()=>{clearTimeout(blurTimer),clearTimeout(closeTimer)}),new Promise(e=>{win.once("ready-to-show",e)})})}function preload(){return __awaiter(this,void 0,void 0,function*(){win&&!win.isDestroyed()||(yield init())})}function destroy(){return __awaiter(this,void 0,void 0,function*(){win&&(win.destroy(),win=null)})}function open(e,i,t){return __awaiter(this,void 0,void 0,function*(){if(win&&!win.isDestroyed()||(yield init()),!e||!i||!t)return void console.error("Invalid argument");const n=panel.queryInfo(e);n?(currentParentWindow=t,clearTimeout(blurTimer),clearTimeout(closeTimer),win.setAlwaysOnTop(!0),win.setParentWindow(t),transform({x:i.position.x,y:i.position.y,width:n.userData.size.width,height:n.userData.size.height},i.screen,t),show(),ipc.sendToWin(win,"editor-lib-panel:open-kit-panel",e,i),transform({x:i.position.x,y:i.position.y,width:n.userData.size.width,height:n.userData.size.height},i.screen,t),win.setParentWindow(null),win.setAlwaysOnTop(!1)):console.error(`Panel ${e} is not exist.`)})}function transform(e,i,t){return __awaiter(this,void 0,void 0,function*(){if(!win||win.isDestroyed())return;if(!e.width||!e.height)return;const n=0|e.width,r=0|e.height;win.setContentSize(n,r);const o=t.getContentBounds();let s=o.x+e.x,u=o.y+e.y;return s<i.x&&(s=i.x),s+n>i.x+i.width&&(s=i.x+i.width-n),u<i.y&&(u=i.y),u+r>i.y+i.height&&(u=i.y+i.height-r),s|=0,u|=0,win.setPosition(s,u),!0})}function show(){return __awaiter(this,void 0,void 0,function*(){win&&!win.isDestroyed()&&(clearTimeout(blurTimer),clearTimeout(closeTimer),win.show())})}function hide(){return __awaiter(this,void 0,void 0,function*(){win&&!win.isDestroyed()&&(ipc.sendToWin(win,"editor-lib-panel:hide-kit-panel"),win.hide(),closeTimer=setTimeout(()=>{clearTimeout(closeTimer),currentParentWindow&&!currentParentWindow.isDestroyed()&&currentParentWindow.focus()},50))})}function register(e){return __awaiter(this,void 0,void 0,function*(){ipc.sendToWin(win,"editor-lib-panel:register-kit-panel",e)})}function unregister(e){return __awaiter(this,void 0,void 0,function*(){ipc.sendToWin(win,"editor-lib-panel:unregister-kit-panel",e)})}exports.setBlurTimeout=setBlurTimeout,exports.getBlurTimeout=getBlurTimeout,exports.init=init,exports.preload=preload,exports.destroy=destroy,exports.open=open,exports.transform=transform,exports.show=show,exports.hide=hide,exports.register=register,exports.unregister=unregister,ipc.on("editor-lib-panel:open-kit",(e,i,t)=>__awaiter(void 0,void 0,void 0,function*(){const n=electron_1.BrowserWindow.fromWebContents(e.sender),r=yield open(i,Object.assign({webContentID:n.webContents.id},t),n);e.reply(null,r)}));