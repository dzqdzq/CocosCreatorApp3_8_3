"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(i,r){function s(e){try{l(o.next(e))}catch(e){r(e)}}function a(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,a)}l((o=o.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports._openDevTools=exports.has=exports.focus=exports.close=exports.openBeside=exports.open=exports.preloadKit=exports.closeKit=exports.holdKit=exports.openKit=void 0;const metrics_1=require("../../../metrics"),electron_1=require("electron"),ipc=require("@base/electron-base-ipc"),panel=require("@editor/panel"),kit_1=require("./kit"),waitPanels=[];function openKit(e,t){console.warn("The kit panel needs to be opened from a window.")}function holdKit(){(0,kit_1.setKitHoldFlag)(!0)}function closeKit(e){(0,kit_1.hide)()}function preloadKit(){(0,kit_1.preload)()}function open(e,...t){return __awaiter(this,void 0,void 0,function*(){const n=panel.queryInfo(e);if(!n)return console.warn(`Panel(${e}) is not defined.`),!1;if("kit"===n.userData.type)return!1;const o=n.userData&&n.userData.flags&&n.userData.flags.multiple;try{metrics_1.Metrics._trackEventWithTimer({category:"extension",id:`A100000_${e}`,value:1})}catch(e){}if(!o){if(waitPanels.includes(e))return console.warn(`A panel(${e}) is currently open. Please try again later.`),!1;if(panel.focus(e)){const t=panel.getWindow(e)||[];if(t.length>0)return!1;const n=electron_1.BrowserWindow.fromId(t[t.length-1]);return!!n&&(n.show(),!0)}}n.args=t||[],waitPanels.push(e);try{const t=(n.userData||{}).size||{};t.width||(t.width=t["min-width"]||200),t.height||(t.height=t["min-height"]||200),"simple"===n.userData.type?Editor.Windows.__protected__.openSimpleWindow(t,{panel:e}):Editor.Windows.__protected__.openSubWindow(t,{layout:{version:1,"min-width":t["min-width"]||200,"min-height":t["min-height"]||200,layout:{percent:1,panels:[e]}}}),yield new Promise(t=>{const n=setTimeout(()=>{panel.removeListener("ready",o),t()},5e3);function o(i){i===e&&(clearTimeout(n),panel.removeListener("ready",o),t())}panel.on("ready",o)})}catch(t){console.error(t);const n=waitPanels.indexOf(e);return-1!==n&&waitPanels.splice(n,1),!1}const i=waitPanels.indexOf(e);return-1!==i&&waitPanels.splice(i,1),!0})}function openBeside(e,t,...n){return __awaiter(this,void 0,void 0,function*(){const o=panel.queryInfo(t);if(!o)return console.warn(`Panel(${t}) is not defined.`),!1;if("kit"===o.userData.type)return!1;const i=o.userData&&o.userData.flags&&o.userData.flags.multiple;try{metrics_1.Metrics._trackEventWithTimer({category:"extension",id:`A100000_${t}`,value:1})}catch(e){}if("simple"===o.userData.type)return console.log(`Simple type panel${t} cannot be mounted in windows`),!1;if(!i){if(waitPanels.includes(t))return console.warn(`A panel(${t}) is currently open. Please try again later.`),!1;if(panel.focus(t)){const e=panel.getWindow(t)||[];if(e.length>0)return!1;const n=electron_1.BrowserWindow.fromId(e[e.length-1]);return!!n&&(n.show(),!0)}}o.args=n||[],waitPanels.push(t);try{const n=(o.userData||{}).size||{};n.width||(n.width=n["min-width"]||200),n.height||(n.height=n["min-height"]||200);const i=panel.getWindow(e);ipc.sendToWin(electron_1.BrowserWindow.fromId(i[0]),"editor-lib-panel:open-beside",e,t),yield new Promise(e=>{const n=setTimeout(()=>{panel.removeListener("ready",o),e()},5e3);function o(i){i===t&&(clearTimeout(n),panel.removeListener("ready",o),e())}panel.on("ready",o)})}catch(e){console.error(e);const n=waitPanels.indexOf(t);return-1!==n&&waitPanels.splice(n,1),!1}const r=waitPanels.indexOf(t);return-1!==r&&waitPanels.splice(r,1),!0})}function close(e){return __awaiter(this,void 0,void 0,function*(){const t=panel.getWindow(e)||[];if(0===t.length)return!0;const n=t.map(t=>{const n=electron_1.BrowserWindow.fromId(t);return ipc.sendToWin(n,"editor-lib-panel:close",e)});return(yield Promise.all(n)).every(Boolean)})}function focus(e){return __awaiter(this,void 0,void 0,function*(){if(!panel.queryInfo(e))return console.warn(`Panel(${e}) is not defined.`),!1;if(panel.focus(e)){const t=panel.getWindow(e)||[];if(t.length>0)return!1;const n=electron_1.BrowserWindow.fromId(t[t.length-1]);return!!n&&(n.show(),!0)}return!1})}function has(e){return __awaiter(this,void 0,void 0,function*(){const t=panel.getWindow(e);return!!(t&&t.length>0)})}function _openDevTools(e){const t=_getBrowserWindow(e);t&&t.webContents.openDevTools()}function _getBrowserWindow(e){const t=panel.getWindow(e)||[];if(!t.length)return null;const n=electron_1.BrowserWindow.fromId(t[t.length-1]);return n||null}exports.openKit=openKit,exports.holdKit=holdKit,exports.closeKit=closeKit,exports.preloadKit=preloadKit,exports.open=open,exports.openBeside=openBeside,exports.close=close,exports.focus=focus,exports.has=has,exports._openDevTools=_openDevTools,ipc.on("editor-lib-panel:call",(e,t,...n)=>__awaiter(void 0,void 0,void 0,function*(){const o=exports[t];if(!o)return;const i=yield o.call(exports,...n);e.reply(null,i)}));const UsageTimeMap=new Map;panel.on("focus",e=>{UsageTimeMap.set(e,Date.now())}),panel.on("blur",e=>{if(UsageTimeMap.has(e)){const t=UsageTimeMap.get(e),n=Date.now();metrics_1.Metrics._trackEventWithTimer({category:"extension",id:`B100001_${e}`,value:((n-t)/1e3/60*100|0)/100}),UsageTimeMap.delete(e)}}),panel.on("pause",e=>{if(UsageTimeMap.has(e)){const t=UsageTimeMap.get(e),n=Date.now();metrics_1.Metrics._trackEventWithTimer({category:"extension",id:`B100001_${e}`,value:((n-t)/1e3/60*100|0)/100}),UsageTimeMap.delete(e)}}),panel.on("resume",e=>{UsageTimeMap.set(e,Date.now())}),setInterval(()=>{const e=Date.now();UsageTimeMap.forEach((t,n)=>{metrics_1.Metrics._trackEventWithTimer({category:"extension",id:`B100001_${n}`,value:((e-t)/1e3/60*100|0)/100}),UsageTimeMap.set(n,e)})},6e4);