"use strict";var __awaiter=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))(function(n,r){function a(e){try{l(i.next(e))}catch(e){r(e)}}function o(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(a,o)}l((i=i.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.licenseManager=void 0;const utils_1=require("./utils"),electron_base_ipc_1=require("@base/electron-base-ipc"),md5=require("md5"),user=process.send?require("@editor/user/dist/platform/child"):require("@editor/user");class LicenseManager{constructor(){this.licenseNames=["NintendoSwitchBuild"],this.licenses=new Map,this.licenses=new Map}getLicenseInOffline(e){return __awaiter(this,void 0,void 0,function*(){const{licenseName:t,pluginName:s}=e;let i,n=t||s;if(!n)return;try{i=utils_1.default.readCacheLicense(n)}catch(e){throw utils_1.default.newError({status:utils_1.code.no_permission,message:utils_1.default.getMessage(utils_1.code.no_permission)})}let{d:r,i:a,l:o,m:l}=i;if(a!==utils_1.default.getMID())throw utils_1.default.newError({status:utils_1.code.no_permission,message:utils_1.default.getMessage(utils_1.code.no_permission)});let u=utils_1.default.convertToPublicDecrypt(n,o,l);if(Math.round((new Date).getTime()/1e3)>u.grant_e_time)throw utils_1.default.newError({status:utils_1.code.license_expired,message:utils_1.default.getMessage(utils_1.code.license_expired)});(0,electron_base_ipc_1.broadcast)("license:pass");const c={status:utils_1.code.ok,message:utils_1.default.getMessage(utils_1.code.ok),data:u};return this.licenses.set(n,c),c})}getLicenseInOnline(e){return __awaiter(this,void 0,void 0,function*(){const{cocos_uid:t,session_id:s}=yield user.getData(),{pluginName:i,licenseName:n,client_type:r,enableCompanyMember:a}=e;let o=n||i,l="";o?l=`COCOS_UID::${t}::${o}`:(o="Creator",l=`COCOS_UID::${t}`);const u=new URL("api/account/get_license","https://creator-api.cocos.com").toString();let c={session_id:s,client_type:r||1,terminal_id:md5(l)};i&&(c.plugin_name=i),n&&(c.license_name=n);const _=yield Editor.Network.post(u,c);let d;try{d=JSON.parse(_.toString())}catch(e){throw utils_1.default.newError({status:utils_1.code.no_permission,message:utils_1.default.getMessage(utils_1.code.no_permission)})}const g=d&&d.data;if(g&&0!==d.status)throw utils_1.default.newError({status:g.status,message:g.msg});if(a&&0===g.company_member)throw utils_1.default.newError({status:utils_1.code.not_add,message:utils_1.default.getMessage(utils_1.code.not_add)});if(!g.license)throw utils_1.default.newError({status:utils_1.code.no_permission,message:utils_1.default.getMessage(utils_1.code.no_permission)});const m=utils_1.default.convertToPublicDecrypt(o,g.license,g.license_mark);if(m.terminal_info!==l)throw utils_1.default.newError({status:utils_1.code.no_permission,message:utils_1.default.getMessage(utils_1.code.no_permission)});if(Math.round((new Date).getTime()/1e3)>m.grant_e_time)throw utils_1.default.newError({status:utils_1.code.license_expired,message:utils_1.default.getMessage(utils_1.code.license_expired)});utils_1.default.saveCacheLicense(o,g),(0,electron_base_ipc_1.broadcast)("license:pass");const f={status:utils_1.code.ok,message:utils_1.default.getMessage(utils_1.code.ok),data:m};return this.licenses.set(o,f),f})}queryLicenseByPluginName(e,t=!1){return __awaiter(this,void 0,void 0,function*(){const s=yield Editor.Network.__protected__.testConnectServer();return this.licenses.delete(e),s?yield this.getLicenseInOnline({pluginName:e,enableCompanyMember:t}):yield this.getLicenseInOffline({pluginName:e})})}queryLicenseByName(e){return __awaiter(this,void 0,void 0,function*(){const t=yield Editor.Network.__protected__.testConnectServer();return this.licenses.delete(e),t?yield this.getLicenseInOnline({licenseName:e,enableCompanyMember:!0}):yield this.getLicenseInOffline({licenseName:e})})}}exports.default=LicenseManager,exports.licenseManager=new LicenseManager;