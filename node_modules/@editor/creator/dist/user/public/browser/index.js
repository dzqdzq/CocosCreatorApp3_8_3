"use strict";var __awaiter=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))(function(r,n){function s(e){try{u(i.next(e))}catch(e){n(e)}}function a(e){try{u(i.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(s,a)}u((i=i.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeListener=exports.once=exports.on=exports.getSessionCode=exports.getUserToken=exports.logout=exports.login=exports.isLoggedIn=exports.getData=exports.hideMask=exports.showMask=exports.skip=void 0;const events_1=require("events"),ipc=require("@base/electron-base-ipc"),Profile=require("@base/electron-profile"),flag="editor-lib-user",user=process.send?require("@editor/user/dist/platform/child"):require("@editor/user"),emitter=new events_1.EventEmitter;if(!process.send){const e=Profile.load("global://editor/user.json"),t=require("@editor/user"),o=e.get();t.setData(o),t.on("info-update",()=>__awaiter(void 0,void 0,void 0,function*(){const o=yield t.getData();e.set("session_id",o.session_id),e.set("session_key",o.session_key),e.set("cocos_uid",o.cocos_uid),e.set("email",o.email),e.set("nickname",o.nickname),e.save()}))}user.on("login",()=>{emitter.emit("login"),ipc.broadcast(`${flag}:emit`,"login")}),user.on("logout",()=>{emitter.emit("logout"),ipc.broadcast(`${flag}:emit`,"logout"),Editor.Menu.__protected__.remove("i18n:menu.develop",{label:"i18n:menu.logout"}),Editor.Menu.__protected__.apply()});let _skip=!1;function skip(){_skip=!0,ipc.broadcast(`${flag}:hideMask`),emitter.emit("skip"),ipc.broadcast(`${flag}:emit`,"skip"),Editor.Menu.__protected__.apply()}function showMask(){ipc.broadcast(`${flag}:showMask`)}function hideMask(){ipc.broadcast(`${flag}:hideMask`)}function getData(){return __awaiter(this,void 0,void 0,function*(){return user.getData()})}function isLoggedIn(){return __awaiter(this,void 0,void 0,function*(){if(!0===_skip)return!1;try{return yield user.isLoggedIn()}catch(e){return!1}})}function login(e,t){return __awaiter(this,void 0,void 0,function*(){return _skip=!1,user.login(e,t)})}function logout(){return __awaiter(this,void 0,void 0,function*(){return user.logout()})}function getUserToken(){return __awaiter(this,void 0,void 0,function*(){return user.getUserToken()})}function getSessionCode(e){return __awaiter(this,void 0,void 0,function*(){return yield user.getSessionCode(e)})}function on(e,t){emitter.on(e,t)}function once(e,t){emitter.once(e,t)}function removeListener(e,t){emitter.removeListener(e,t)}exports.skip=skip,exports.showMask=showMask,exports.hideMask=hideMask,exports.getData=getData,exports.isLoggedIn=isLoggedIn,exports.login=login,exports.logout=logout,exports.getUserToken=getUserToken,exports.getSessionCode=getSessionCode,exports.on=on,exports.once=once,exports.removeListener=removeListener,ipc.on(`${flag}:call`,(e,t,...o)=>__awaiter(void 0,void 0,void 0,function*(){const i=module.exports[t];let r;try{r=yield i(...o)}catch(t){return void e.reply(t,null)}e.reply(null,r)})),ipc.on(`${flag}:check-skip-init`,(e,t,...o)=>__awaiter(void 0,void 0,void 0,function*(){return e.reply(null,_skip),_skip}));