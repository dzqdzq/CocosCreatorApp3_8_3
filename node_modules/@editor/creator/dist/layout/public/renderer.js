"use strict";var __awaiter=this&&this.__awaiter||function(e,t,o,a){return new(o||(o=Promise))(function(i,n){function r(e){try{u(a.next(e))}catch(e){n(e)}}function l(e){try{u(a.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(r,l)}u((a=a.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.query=exports.init=exports.apply=void 0;const path_1=require("path"),dock=require("@editor/dock"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),i18n=require("@base/electron-i18n"),$dock=document.querySelector("dock-frame");function apply(e){$dock&&$dock.layout(e)}function init(e){return __awaiter(this,void 0,void 0,function*(){if($dock){const t=yield Editor.Windows.__protected__.queryUserData();(e=t.layout||e)&&module.exports.apply(e);let o=null;$dock.addEventListener("layout",function(){clearTimeout(o),o=setTimeout(function(){const e=$dock.getBoundingClientRect(),o=e.left+e.right-e.width,a=e.top+e.bottom-e.height,i=t.layout=$dock.dump();Editor.Windows.__protected__.changeMinSize(o+i.layout["min-width"],a+i.layout["min-height"]),Editor.Windows.__protected__.changeUserData(t)},300),requestAnimationFrame(()=>{const e=$dock.$layout.firstElementChild;if(!e||"DOCK-GROUPS"===e.tagName&&0===e.panels.length)return clearTimeout(o),void Editor.Windows.__protected__.close()})}),$dock.shadowRoot.addEventListener("panel-close",e=>{Editor.Module.__protected__.removeCache((0,path_1.join)(e.target.getData("packageDir")||"",e.target.getData("main")||""))}),$dock.shadowRoot.addEventListener("panel-drop",e=>{e.target.focus()}),dock.registerMenuParser(function(e,t){return __awaiter(this,void 0,void 0,function*(){const o=panel.queryInfo(t),a=panel.queryAll();let i=!0;o&&o.userData&&o.userData.flags&&!1===o.userData.flags.popup&&(i=!1);let n=!0;o&&o.userData&&o.userData.flags&&!1===o.userData.flags.close&&(n=!1);const r=[{label:i18n.translation("menu.panel_popup"),enabled:i&&a.length>1,click(){return __awaiter(this,void 0,void 0,function*(){!1!==(yield e.removePanel(t))&&Editor.Panel.open(t)})}},{label:i18n.translation("menu.panel_close"),enabled:n,click(){return __awaiter(this,void 0,void 0,function*(){e.removePanel(t)})}}];if(o&&o.userData&&o.userData.menu){if(!Array.isArray(o.userData.menu))return void console.warn(`Panel menu data must be an array - ${t}`);r.push({type:"separator"}),o.userData.menu.forEach(e=>{e.click=function(){Editor.Message.send(o.userData.package,e.message,...e.params||[])},delete e.icon,e.label=e.label.startsWith("i18n:")?Editor.I18n.t(e.label.substr(5)):e.label,r.push(e)})}return r})})}})}function query(e){return __awaiter(this,void 0,void 0,function*(){return Editor.Layout.__protected__.query(e)})}exports.apply=apply,exports.init=init,exports.query=query,window.__MAIN__&&ipc.send("editor-lib-layout:main"),ipc.on("editor-lib-layout:apply",(e,t)=>__awaiter(void 0,void 0,void 0,function*(){window.__MAIN__&&module.exports.apply(t)})),ipc.on("editor-lib-layout:try-close",(e,t)=>__awaiter(void 0,void 0,void 0,function*(){const o=panel.query(t);if(!o||o.length<=0)return e.reply(null,!0);const a=yield Promise.all(o.map(e=>__awaiter(void 0,void 0,void 0,function*(){return yield e.emit("beforeClose")})));return e.reply(null,!a.some(e=>!1===e))}));