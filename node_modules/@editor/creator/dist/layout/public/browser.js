"use strict";var __awaiter=this&&this.__awaiter||function(e,n,o,t){return new(o||(o=Promise))(function(r,i){function l(e){try{c(t.next(e))}catch(e){i(e)}}function a(e){try{c(t.throw(e))}catch(e){i(e)}}function c(e){var n;e.done?r(e.value):(n=e.value,n instanceof o?n:new o(function(e){e(n)})).then(l,a)}c((t=t.apply(e,n||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.query=exports.apply=void 0;const electron_1=require("electron"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc");let mainID=null;function apply(e){return __awaiter(this,void 0,void 0,function*(){if(null===mainID)return;const n=[];!function e(o){o.panels&&o.panels.forEach(e=>{n.push(e)}),o.children&&o.children.forEach(e)}(e.layout);for(let e=0;e<n.length;e++){const o=n[e],t=panel.getWindow(o)||[];if(!(yield tryClose(o,t)))return void console.warn(`Failed to change layout: ${o} Panels are not allowed to close`);1!==t.length||t[0]!==mainID||n.splice(e--,1)}for(let e=0;e<n.length;e++){const o=n[e];if(!(yield Editor.Panel.close(o)))return void console.warn(`Failed to change layout: ${o} Panels are not allowed to close`)}const o=electron_1.BrowserWindow.fromId(mainID);ipc.sendToWin(o,"editor-lib-layout:apply",e)})}function query(e){return __awaiter(this,void 0,void 0,function*(){return Editor.Layout.__protected__.query(e)})}function tryClose(e,n){return __awaiter(this,void 0,void 0,function*(){if(null===n||void 0===n)return!0;const o=n.map(n=>new Promise((o,t)=>{const r=electron_1.BrowserWindow.fromId(n);ipc.sendToWin(r,"editor-lib-layout:try-close",e).callback((e,n)=>{o(n)})}));return(yield Promise.all(o)).every(Boolean)})}exports.apply=apply,exports.query=query,ipc.on("editor-lib-layout:main",e=>{if(!e.sender)return void(mainID=null);const n=electron_1.BrowserWindow.fromWebContents(e.sender);mainID=n&&"number"==typeof n.id?n.id:null});