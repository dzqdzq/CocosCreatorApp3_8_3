"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(o,i){function a(e){try{u(n.next(e))}catch(e){i(e)}}function s(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(a,s)}u((n=n.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeListener=exports.emit=exports.once=exports.on=exports.queryList=exports.remove=exports.query=exports.add=exports.init=void 0;const events_1=require("events"),ipc=require("@base/electron-base-ipc"),dock=require("@editor/dock"),panel=require("@editor/panel"),i18n=require("@base/electron-i18n"),path_1=require("path");function send(e,...t){return new Promise((r,n)=>{ipc.send("editor-lib-layout:call",e,...t).callback((e,t)=>{e?n(e):r(t)})})}const emitter=new events_1.EventEmitter,$dock=document.querySelector("dock-frame");function init(e){return __awaiter(this,void 0,void 0,function*(){if($dock){const t=yield Editor.Windows.__protected__.queryUserData();(e=t.layout||e)&&Editor.Layout.apply(e);let r=null;$dock.addEventListener("layout",function(){clearTimeout(r),r=setTimeout(function(){const e=$dock.getBoundingClientRect(),r=e.left+e.right-e.width,n=e.top+e.bottom-e.height,o=t.layout=$dock.dump();Editor.Windows.__protected__.changeMinSize(r+o.layout["min-width"],n+o.layout["min-height"]),Editor.Windows.__protected__.changeUserData(t)},300),requestAnimationFrame(()=>{const e=$dock.$layout.firstElementChild;if(!e||"DOCK-GROUPS"===e.tagName&&0===e.panels.length)return clearTimeout(r),void Editor.Windows.__protected__.close()})}),$dock.shadowRoot.addEventListener("panel-close",e=>{Editor.Module.__protected__.removeCache((0,path_1.join)(e.target.getData("packageDir")||"",e.target.getData("main")||""))}),$dock.shadowRoot.addEventListener("panel-drop",e=>{e.target.focus()}),dock.registerMenuParser(function(e,t){return __awaiter(this,void 0,void 0,function*(){const r=panel.queryInfo(t),n=panel.queryAll();let o=!0;r&&r.userData&&r.userData.flags&&!1===r.userData.flags.popup&&(o=!1);let i=!0;r&&r.userData&&r.userData.flags&&!1===r.userData.flags.close&&(i=!1);const a=[{label:i18n.translation("menu.panel_popup"),enabled:o&&n.length>1,click(){return __awaiter(this,void 0,void 0,function*(){!1!==(yield e.removePanel(t))&&Editor.Panel.open(t)})}},{label:i18n.translation("menu.panel_close"),enabled:i,click(){return __awaiter(this,void 0,void 0,function*(){e.removePanel(t)})}}];if(r&&r.userData&&r.userData.menu){if(!Array.isArray(r.userData.menu))return void console.warn(`Panel menu data must be an array - ${t}`);a.push({type:"separator"}),r.userData.menu.forEach(e=>{e.click=function(){Editor.Message.send(r.userData.package,e.message,...e.params||[])},delete e.icon,e.label=e.label.startsWith("i18n:")?Editor.I18n.t(e.label.substr(5)):e.label,a.push(e)})}return a})})}})}function add(e,t){return __awaiter(this,void 0,void 0,function*(){return send("add",e,t)})}function query(e){return __awaiter(this,void 0,void 0,function*(){return send("query",e)})}function remove(e){return __awaiter(this,void 0,void 0,function*(){return send("remove",e)})}function queryList(){return __awaiter(this,void 0,void 0,function*(){return send("queryList")})}function on(e,t){return emitter.on(e,t)}function once(e,t){return emitter.once(e,t)}function emit(e,...t){return send("emit",e,...t)}function removeListener(e,t){return emitter.removeListener(e,t)}exports.init=init,exports.add=add,exports.query=query,exports.remove=remove,exports.queryList=queryList,exports.on=on,exports.once=once,exports.emit=emit,exports.removeListener=removeListener,ipc.on("editor-lib-layout:emit",(e,t,...r)=>{emitter.emit(t,...r)});