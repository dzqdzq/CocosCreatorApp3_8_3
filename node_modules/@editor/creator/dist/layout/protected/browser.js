"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))(function(o,n){function a(e){try{s(i.next(e))}catch(e){n(e)}}function u(e){try{s(i.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(a,u)}s((i=i.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeListener=exports.emit=exports.once=exports.on=exports.queryList=exports.remove=exports.add=exports.query=exports.init=void 0;const fs_extra_1=require("fs-extra"),events_1=require("events"),path_1=require("path"),app_1=require("../../app");require("@editor/dock");const ipc=require("@base/electron-base-ipc"),windows=require("@base/electron-windows"),LAYOUT_CACHE_PATH=(0,path_1.join)(app_1.App.home,"editor","layout.json");let LAYOUT_INFO={version:"1.0.0",layoutMap:{}};const emitter=new events_1.EventEmitter;function init(e){return __awaiter(this,void 0,void 0,function*(){if((0,fs_extra_1.existsSync)(LAYOUT_CACHE_PATH))try{LAYOUT_INFO=yield(0,fs_extra_1.readJSON)(LAYOUT_CACHE_PATH)}catch(e){console.warn(e)}e&&add("default",e)})}function query(e){return __awaiter(this,void 0,void 0,function*(){if(!e){const e=windows.uuids[0],t=windows.uuid2info[e];return t&&t.userData?t.userData.layout:null}return LAYOUT_INFO.layoutMap[e]})}function save(){return __awaiter(this,void 0,void 0,function*(){Object.keys(LAYOUT_INFO.layoutMap).length&&(yield(0,fs_extra_1.outputJSON)(LAYOUT_CACHE_PATH,LAYOUT_INFO))})}function add(e,t){return __awaiter(this,void 0,void 0,function*(){t=t||(yield this.query()),LAYOUT_INFO.layoutMap[e]=t,emit("layout-added"),save()})}function remove(e){return __awaiter(this,void 0,void 0,function*(){delete LAYOUT_INFO.layoutMap[e],emit("layout-deleted"),save()})}function queryList(){return __awaiter(this,void 0,void 0,function*(){return JSON.parse(JSON.stringify(LAYOUT_INFO.layoutMap))})}function on(e,t){return emitter.on(e,t)}function once(e,t){return emitter.once(e,t)}function emit(e){return ipc.broadcast("editor3d-lib-layout:emit",e),emitter.emit(e)}function removeListener(e,t){return emitter.removeListener(e,t)}exports.init=init,exports.query=query,exports.add=add,exports.remove=remove,exports.queryList=queryList,exports.on=on,exports.once=once,exports.emit=emit,exports.removeListener=removeListener,ipc.on("editor-lib-layout:call",(e,t,...r)=>__awaiter(void 0,void 0,void 0,function*(){try{const i=yield exports[t](...r);e.reply(null,i)}catch(t){e.reply(t)}}));