'use strict';
// @ts-check
var __importDefault = (this && this.__importDefault) || function(mod) {
    return (mod && mod.__esModule) ? mod : { 'default': mod };
};
Object.defineProperty(exports, '__esModule', { value: true });
exports.loadDynamic = void 0;
const module_1 = __importDefault(require('module'));
const path_1 = __importDefault(require('path'));
let hasPreload = false;
let loader = null;
/**
 * 初始化引擎加载器。预先引擎模块，并将其映射为在编辑器内可用的 CommonJS 模块。
 * @param options 选项。
 */
async function preload(options) {
    var _a, _b;
    function isEngineModule(request) {
        return request === 'cc' || (request.startsWith('cc/') && !request.startsWith('cc/preload')) || request.startsWith('cce:/internal/');
    }
    try {
        if (hasPreload) {
            throw new Error('You can only preload engine once.');
        }
        hasPreload = true;
        const { requiredModules, editorExtensions = true, editorPath } = options;
        const root = (_a = options.root) !== null && _a !== void 0 ? _a : (await (async () => {
            const ipc = require('@base/electron-base-ipc');
            const info = ipc.sendSync('packages-engine:query-engine-info');
            return info.path;
        })());
        const dist = (_b = options.dist) !== null && _b !== void 0 ? _b : path_1.default.join(root, 'bin', '.cache', 'dev', 'editor');
        // 设置 CC_EDITOR 标记，引擎加载的时候会使用标记进行部分判断
        // @ts-ignore
        globalThis.CC_EDITOR = true;
        if (editorExtensions) {
            const ipc = require('@base/electron-base-ipc');
            // 向 engine 插件查询信息
            const info = ipc.sendSync('packages-engine:query-engine-info');
            // 加载编辑器扩展
            // @ts-ignore
            globalThis.EditorExtends = require(path_1.default.join(info.editor, './builtin/engine/dist/editor-extends'));
        }
        const engineModules = {};
        const loaderModule = require(path_1.default.resolve(dist, 'loader'));
        loader = loaderModule.default;
        for (const requiredModule of requiredModules) {
            engineModules[requiredModule] = await loader.import(requiredModule);
        }
        const ModuleInternal = module_1.default;
        const vendorResolveFilename = ModuleInternal._resolveFilename;
        ModuleInternal._resolveFilename = function(request) {
            if (isEngineModule(request)) {
                return request;
            }
            else {
                // @ts-ignore
                // eslint-disable-next-line prefer-rest-params
                return vendorResolveFilename.apply(this, arguments);
            }
        };
        const vendorLoad = ModuleInternal._load;
        ModuleInternal._load = function(request) {
            if (isEngineModule(request)) {
                const module = engineModules[request];
                if (module) {
                    return module;
                }
                else {
                    throw new Error(`Can not load engine module: ${request}. Valid engine modules are: ${Object.keys(engineModules).join(',')}`);
                }
            }
            else {
                // @ts-ignore
                // eslint-disable-next-line prefer-rest-params
                return vendorLoad.apply(this, arguments);
            }
        };
        if (requiredModules.includes('cc')) {
            postProcess(editorPath);
        }
    }
    catch (error) {
        let msg = 'preload engine failed!';
        console.error(msg);
        console.error(error);
        if (error instanceof Error) {
            msg += '\n' + error.stack ? error.stack : error.toString();
        }
        // @ts-ignore
        Editor.Message.send('engine', 'import-engine-error', msg);
        throw error;
    }
}
exports.default = preload;
/**
 * 动态加载指定模块。应确保引擎加载器已经初始化过。
 * @param id 引擎模块 ID。
 * @returns 引擎模块。
 */
async function loadDynamic(id) {
    if (!loader) {
        throw new Error(`Failed to load engine module ${id}. ` + 'Loader has not been initialized. You should call preload() first.');
    }
    return await loader.import(id);
}
exports.loadDynamic = loadDynamic;
function postProcess(editorPath) {
    let info;
    if (!editorPath) {
        const ipc = require('@base/electron-base-ipc');
        info = ipc.sendSync('packages-engine:query-engine-info');
    }
    else {
        info = {
            editor: editorPath,
        };
    }
    const vStacks = require('v-stacks');
    if ('__MAIN__' in window) {
        const error = new Error('Try not to run the engine in the window process.');
        error.stack = vStacks.ignoreStack(error.stack, 1);
        console.warn(error);
    }
    const timeLabel = 'Import engine';
    console.time(timeLabel);
    let ccm;
    try {
        ccm = require('cc');
    }
    catch (error) {
        let msg = 'require cc failed!';
        if (error instanceof Error) {
            msg += '\n' + error.stack ? error.stack : error.toString();
        }
        // @ts-ignore
        Editor.Message.send('engine', 'import-engine-error', msg);
        throw error;
    }
    console.timeEnd(timeLabel);
    // ---- 加载引擎主体 ----
    // @ts-ignore
    window.ccm = ccm;
    // ---- hack creator 使用的一些 engine 参数
    require('./polyfill/engine');
    // @ts-ignore
    globalThis.EditorExtends.init();
    const handle = require('./overwrite');
    handle(ccm, info);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlbG9hZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInByZWxvYWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLFlBQVk7Ozs7OztBQUVaLG9EQUE0QjtBQUM1QixnREFBc0I7QUFZdEIsSUFBSSxVQUFVLEdBQUcsS0FBSyxDQUFDO0FBRXZCLElBQUksTUFBTSxHQUF3QixJQUFJLENBQUM7QUFFdkM7OztHQUdHO0FBQ0gsS0FBSyxVQUFVLE9BQU8sQ0FBQyxPQXVCdEI7O0lBQ0csU0FBUyxjQUFjLENBQUMsT0FBZTtRQUNuQyxPQUFPLE9BQU8sS0FBSyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUN4SSxDQUFDO0lBRUQsSUFBSTtRQUNBLElBQUksVUFBVSxFQUFFO1lBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO1NBQ3hEO1FBQ0QsVUFBVSxHQUFHLElBQUksQ0FBQztRQUVsQixNQUFNLEVBQUUsZUFBZSxFQUFFLGdCQUFnQixHQUFHLElBQUksRUFBRSxVQUFVLEVBQUUsR0FBRyxPQUFPLENBQUM7UUFFekUsTUFBTSxJQUFJLEdBQ04sTUFBQSxPQUFPLENBQUMsSUFBSSxtQ0FDWixDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNmLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsbUNBQW1DLENBQUMsQ0FBQztZQUMvRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDckIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRVYsTUFBTSxJQUFJLEdBQUcsTUFBQSxPQUFPLENBQUMsSUFBSSxtQ0FB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QUFDO0lBQ1IsSUFBSTtRQUNBLEdBQUcsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDdkI7SUFBQyxPQUFPLEtBQUssRUFBRTtRQUNaLElBQUksR0FBRyxHQUFHLG9CQUFvQixDQUFDO1FBQy9CLElBQUksS0FBSyxZQUFZLEtBQUssRUFBRTtZQUN4QixHQUFHLElBQUksSUFBSSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztTQUM5RDtRQUNELGFBQWE7UUFDYixNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUscUJBQXFCLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDMUQsTUFBTSxLQUFLLENBQUM7S0FDZjtJQUVELE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7SUFFM0IsbUJBQW1CO0lBQ25CLGFBQWE7SUFDYixNQUFNLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztJQUVqQixvQ0FBb0M7SUFDcEMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUM7SUFFN0IsYUFBYTtJQUNiLFVBQVUsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLENBQUM7SUFFaEMsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ3RDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDdEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEB0cy1jaGVja1xuXG5pbXBvcnQgTW9kdWxlIGZyb20gJ21vZHVsZSc7XG5pbXBvcnQgcHMgZnJvbSAncGF0aCc7XG5cbi8vIGRlY2xhcmUgbW9kdWxlIFwibW9kdWxlXCIge1xuLy8gICAgIG5hbWVzcGFjZSBNb2R1bGUge1xuLy8gICAgICAgICBleHBvcnQgZnVuY3Rpb24gX3Jlc29sdmVGaWxlbmFtZShyZXF1ZXN0OiBzdHJpbmcpOiB2b2lkO1xuLy8gICAgIH1cbi8vIH1cblxuaW50ZXJmYWNlIEVuZ2luZUxvYWRlciB7XG4gICAgaW1wb3J0KGlkOiBzdHJpbmcpOiBQcm9taXNlPHVua25vd24+O1xufVxuXG5sZXQgaGFzUHJlbG9hZCA9IGZhbHNlO1xuXG5sZXQgbG9hZGVyOiBFbmdpbmVMb2FkZXIgfCBudWxsID0gbnVsbDtcblxuLyoqXG4gKiDliJ3lp4vljJblvJXmk47liqDovb3lmajjgILpooTlhYjlvJXmk47mqKHlnZfvvIzlubblsIblhbbmmKDlsITkuLrlnKjnvJbovpHlmajlhoXlj6/nlKjnmoQgQ29tbW9uSlMg5qih5Z2X44CCXG4gKiBAcGFyYW0gb3B0aW9ucyDpgInpobnjgIJcbiAqL1xuYXN5bmMgZnVuY3Rpb24gcHJlbG9hZChvcHRpb25zOiB7XG4gICAgLyoqXG4gICAgICog5byV5pOO5qC555uu5b2V44CC5aaC5p6c5pyq5oyH5a6a5YiZ55SoIElQQyDmtojmga/mn6Xor6LlvZPliY3kvb/nlKjnmoTjgIJcbiAgICAgKi9cbiAgICByb290Pzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICog5byV5pOO5YiG5Y+R55uu5b2V77yI5byV5pOO57yW6K+R5ZCO55qE55uu5b2V77yJ44CCXG4gICAgICovXG4gICAgZGlzdD86IHN0cmluZztcblxuICAgIGVkaXRvclBhdGg/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiDmmK/lkKbopoHms6jlhaXlhajlsYDlj5jph48gYEVkaXRvckV4dGVuZHNg44CC5Li76L+b56iL5LiN5Y+v5L2/55So44CCXG4gICAgICogQGRlZmF1bHQgdHJ1ZVxuICAgICAqL1xuICAgIGVkaXRvckV4dGVuc2lvbnM/OiBib29sZWFuO1xuXG4gICAgLyoqXG4gICAgICog6ZyA6KaB6aKE5Yqg6L2955qE5qih5Z2X44CCXG4gICAgICovXG4gICAgcmVxdWlyZWRNb2R1bGVzOiBzdHJpbmdbXTtcbn0pIHtcbiAgICBmdW5jdGlvbiBpc0VuZ2luZU1vZHVsZShyZXF1ZXN0OiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHJlcXVlc3QgPT09ICdjYycgfHwgKHJlcXVlc3Quc3RhcnRzV2l0aCgnY2MvJykgJiYgIXJlcXVlc3Quc3RhcnRzV2l0aCgnY2MvcHJlbG9hZCcpKSB8fCByZXF1ZXN0LnN0YXJ0c1dpdGgoJ2NjZTovaW50ZXJuYWwvJyk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgICAgaWYgKGhhc1ByZWxvYWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignWW91IGNhbiBvbmx5IHByZWxvYWQgZW5naW5lIG9uY2UuJyk7XG4gICAgICAgIH1cbiAgICAgICAgaGFzUHJlbG9hZCA9IHRydWU7XG4gICAgXG4gICAgICAgIGNvbnN0IHsgcmVxdWlyZWRNb2R1bGVzLCBlZGl0b3JFeHRlbnNpb25zID0gdHJ1ZSwgZWRpdG9yUGF0aCB9ID0gb3B0aW9ucztcbiAgICBcbiAgICAgICAgY29uc3Qgcm9vdCA9XG4gICAgICAgICAgICBvcHRpb25zLnJvb3QgPz9cbiAgICAgICAgICAgIChhd2FpdCAoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGlwYyA9IHJlcXVpcmUoJ0BiYXNlL2VsZWN0cm9uLWJhc2UtaXBjJyk7XG4gICAgICAgICAgICAgICAgY29uc3QgaW5mbyA9IGlwYy5zZW5kU3luYygncGFja2FnZXMtZW5naW5lOnF1ZXJ5LWVuZ2luZS1pbmZvJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGluZm8ucGF0aDtcbiAgICAgICAgICAgIH0pKCkpO1xuICAgIFxuICAgICAgICBjb25zdCBkaXN0ID0gb3B0aW9ucy5kaXN0ID8/IHBzLmpvaW4ocm9vdCwgJ2JpbicsICcuY2FjaGUnLCAnZGV2JywgJ2VkaXRvcicpO1xuICAgIFxuICAgICAgICAvLyDorr7nva4gQ0NfRURJVE9SIOagh+iusO+8jOW8leaTjuWKoOi9veeahOaXtuWAmeS8muS9v+eUqOagh+iusOi/m+ihjOmDqOWIhuWIpOaWrVxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGdsb2JhbFRoaXMuQ0NfRURJVE9SID0gdHJ1ZTtcbiAgICBcbiAgICAgICAgaWYgKGVkaXRvckV4dGVuc2lvbnMpIHtcbiAgICAgICAgICAgIGNvbnN0IGlwYyA9IHJlcXVpcmUoJ0BiYXNlL2VsZWN0cm9uLWJhc2UtaXBjJyk7XG4gICAgXG4gICAgICAgICAgICAvLyDlkJEgZW5naW5lIOaPkuS7tuafpeivouS/oeaBr1xuICAgICAgICAgICAgY29uc3QgaW5mbyA9IGlwYy5zZW5kU3luYygncGFja2FnZXMtZW5naW5lOnF1ZXJ5LWVuZ2luZS1pbmZvJyk7XG4gICAgXG4gICAgICAgICAgICAvLyDliqDovb3nvJbovpHlmajmianlsZVcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIGdsb2JhbFRoaXMuRWRpdG9yRXh0ZW5kcyA9IHJlcXVpcmUocHMuam9pbihpbmZvLmVkaXRvciwgJy4vYnVpbHRpbi9lbmdpbmUvZGlzdC9lZGl0b3ItZXh0ZW5kcycpKTtcbiAgICAgICAgfVxuICAgIFxuICAgICAgICBjb25zdCBlbmdpbmVNb2R1bGVzOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiA9IHt9O1xuICAgIFxuICAgICAgICBjb25zdCBsb2FkZXJNb2R1bGUgPSByZXF1aXJlKHBzLnJlc29sdmUoZGlzdCwgJ2xvYWRlcicpKSBhcyB7XG4gICAgICAgICAgICBkZWZhdWx0OiBFbmdpbmVMb2FkZXI7XG4gICAgICAgIH07XG4gICAgXG4gICAgICAgIGxvYWRlciA9IGxvYWRlck1vZHVsZS5kZWZhdWx0O1xuICAgIFxuICAgICAgICBmb3IgKGNvbnN0IHJlcXVpcmVkTW9kdWxlIG9mIHJlcXVpcmVkTW9kdWxlcykge1xuICAgICAgICAgICAgZW5naW5lTW9kdWxlc1tyZXF1aXJlZE1vZHVsZV0gPSBhd2FpdCBsb2FkZXIuaW1wb3J0KHJlcXVpcmVkTW9kdWxlKTtcbiAgICAgICAgfVxuICAgIFxuICAgICAgICBjb25zdCBNb2R1bGVJbnRlcm5hbCA9IE1vZHVsZSBhcyB0eXBlb2YgTW9kdWxlICYge1xuICAgICAgICAgICAgX3Jlc29sdmVGaWxlbmFtZSh0aGlzOiBNb2R1bGUsIHJlcXVlc3Q6IHN0cmluZyk6IHZvaWQ7XG4gICAgICAgICAgICBfbG9hZCh0aGlzOiBNb2R1bGUsIHJlcXVlc3Q6IHN0cmluZyk6IHZvaWQ7XG4gICAgICAgIH07XG4gICAgXG4gICAgICAgIGNvbnN0IHZlbmRvclJlc29sdmVGaWxlbmFtZSA9IE1vZHVsZUludGVybmFsLl9yZXNvbHZlRmlsZW5hbWU7XG4gICAgICAgIE1vZHVsZUludGVybmFsLl9yZXNvbHZlRmlsZW5hbWUgPSBmdW5jdGlvbihyZXF1ZXN0OiBzdHJpbmcpIHtcbiAgICAgICAgICAgIGlmIChpc0VuZ2luZU1vZHVsZShyZXF1ZXN0KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXF1ZXN0O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci1yZXN0LXBhcmFtc1xuICAgICAgICAgICAgICAgIHJldHVybiB2ZW5kb3JSZXNvbHZlRmlsZW5hbWUuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICBcbiAgICAgICAgY29uc3QgdmVuZG9yTG9hZCA9IE1vZHVsZUludGVybmFsLl9sb2FkO1xuICAgICAgICBNb2R1bGVJbnRlcm5hbC5fbG9hZCA9IGZ1bmN0aW9uKHJlcXVlc3Q6IHN0cmluZykge1xuICAgICAgICAgICAgaWYgKGlzRW5naW5lTW9kdWxlKHJlcXVlc3QpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbW9kdWxlID0gZW5naW5lTW9kdWxlc1tyZXF1ZXN0XTtcbiAgICAgICAgICAgICAgICBpZiAobW9kdWxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBtb2R1bGU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgYENhbiBub3QgbG9hZCBlbmdpbmUgbW9kdWxlOiAke3JlcXVlc3R9LiBWYWxpZCBlbmdpbmUgbW9kdWxlcyBhcmU6ICR7T2JqZWN0LmtleXMoZW5naW5lTW9kdWxlcykuam9pbignLCcpfWAsXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci1yZXN0LXBhcmFtc1xuICAgICAgICAgICAgICAgIHJldHVybiB2ZW5kb3JMb2FkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgXG4gICAgICAgIGlmIChyZXF1aXJlZE1vZHVsZXMuaW5jbHVkZXMoJ2NjJykpIHtcbiAgICAgICAgICAgIHBvc3RQcm9jZXNzKGVkaXRvclBhdGgpO1xuICAgICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbGV0IG1zZyA9ICdwcmVsb2FkIGVuZ2luZSBmYWlsZWQhJztcbiAgICAgICAgY29uc29sZS5lcnJvcihtc2cpO1xuICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgICAgIG1zZyArPSAnXFxuJyArIGVycm9yLnN0YWNrID8gZXJyb3Iuc3RhY2sgOiBlcnJvci50b1N0cmluZygpO1xuICAgICAgICB9XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgRWRpdG9yLk1lc3NhZ2Uuc2VuZCgnZW5naW5lJywgJ2ltcG9ydC1lbmdpbmUtZXJyb3InLCBtc2cpO1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IHByZWxvYWQ7XG5cbi8qKlxuICog5Yqo5oCB5Yqg6L295oyH5a6a5qih5Z2X44CC5bqU56Gu5L+d5byV5pOO5Yqg6L295Zmo5bey57uP5Yid5aeL5YyW6L+H44CCXG4gKiBAcGFyYW0gaWQg5byV5pOO5qih5Z2XIElE44CCXG4gKiBAcmV0dXJucyDlvJXmk47mqKHlnZfjgIJcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxvYWREeW5hbWljKGlkOiBzdHJpbmcpIHtcbiAgICBpZiAoIWxvYWRlcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBsb2FkIGVuZ2luZSBtb2R1bGUgJHtpZH0uIGAgKyAnTG9hZGVyIGhhcyBub3QgYmVlbiBpbml0aWFsaXplZC4gWW91IHNob3VsZCBjYWxsIHByZWxvYWQoKSBmaXJzdC4nKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IGxvYWRlci5pbXBvcnQoaWQpO1xufVxuXG5mdW5jdGlvbiBwb3N0UHJvY2VzcyhlZGl0b3JQYXRoPzogc3RyaW5nKSB7XG4gICAgbGV0IGluZm87XG5cbiAgICBpZiAoIWVkaXRvclBhdGgpIHtcbiAgICAgICAgY29uc3QgaXBjID0gcmVxdWlyZSgnQGJhc2UvZWxlY3Ryb24tYmFzZS1pcGMnKTtcblxuICAgICAgICBpbmZvID0gaXBjLnNlbmRTeW5jKCdwYWNrYWdlcy1lbmdpbmU6cXVlcnktZW5naW5lLWluZm8nKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBpbmZvID0ge1xuICAgICAgICAgICAgZWRpdG9yOiBlZGl0b3JQYXRoLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGNvbnN0IHZTdGFja3MgPSByZXF1aXJlKCd2LXN0YWNrcycpO1xuICAgIGlmICgnX19NQUlOX18nIGluIHdpbmRvdykge1xuICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignVHJ5IG5vdCB0byBydW4gdGhlIGVuZ2luZSBpbiB0aGUgd2luZG93IHByb2Nlc3MuJyk7XG4gICAgICAgIGVycm9yLnN0YWNrID0gdlN0YWNrcy5pZ25vcmVTdGFjayhlcnJvci5zdGFjaywgMSk7XG4gICAgICAgIGNvbnNvbGUud2FybihlcnJvcik7XG4gICAgfVxuXG4gICAgY29uc3QgdGltZUxhYmVsID0gJ0ltcG9ydCBlbmdpbmUnO1xuICAgIGNvbnNvbGUudGltZSh0aW1lTGFiZWwpO1xuXG4gICAgbGV0IGNjbTtcbiAgICB0cnkge1xuICAgICAgICBjY20gPSByZXF1aXJlKCdjYycpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGxldCBtc2cgPSAncmVxdWlyZSBjYyBmYWlsZWQhJztcbiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgICAgIG1zZyArPSAnXFxuJyArIGVycm9yLnN0YWNrID8gZXJyb3Iuc3RhY2sgOiBlcnJvci50b1N0cmluZygpO1xuICAgICAgICB9XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgRWRpdG9yLk1lc3NhZ2Uuc2VuZCgnZW5naW5lJywgJ2ltcG9ydC1lbmdpbmUtZXJyb3InLCBtc2cpO1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG5cbiAgICBjb25zb2xlLnRpbWVFbmQodGltZUxhYmVsKTtcblxuICAgIC8vIC0tLS0g5Yqg6L295byV5pOO5Li75L2TIC0tLS1cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgd2luZG93LmNjbSA9IGNjbTtcblxuICAgIC8vIC0tLS0gaGFjayBjcmVhdG9yIOS9v+eUqOeahOS4gOS6myBlbmdpbmUg5Y+C5pWwXG4gICAgcmVxdWlyZSgnLi9wb2x5ZmlsbC9lbmdpbmUnKTtcblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBnbG9iYWxUaGlzLkVkaXRvckV4dGVuZHMuaW5pdCgpO1xuXG4gICAgY29uc3QgaGFuZGxlID0gcmVxdWlyZSgnLi9vdmVyd3JpdGUnKTtcbiAgICBoYW5kbGUoY2NtLCBpbmZvKTtcbn1cbiJdfQ==