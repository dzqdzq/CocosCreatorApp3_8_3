"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,a){void 0===a&&(a=i),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,a){e[a=void 0===a?i:a]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,s,o,p){return new(o=o||Promise)(function(i,t){function a(e){try{n(p.next(e))}catch(e){t(e)}}function r(e){try{n(p.throw(e))}catch(e){t(e)}}function n(e){var t;e.done?i(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(a,r)}n((p=p.apply(e,s||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.make=exports.onAfterBuild=exports.onBeforeBuildAssets=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=__importStar(require("path")),ejs_1=__importDefault(require("ejs")),globby=require("globby"),subpackagePrefix="usr_",Paths={temp:path_1.join(Editor.Project.path,"temp","builder","huawei","tempTinyRes"),packPath:path_1.join(Editor.App.path,"../tools/huawei-rpk-tools"),buildDir:path_1.join(Editor.App.path,"../tools/huawei-rpk-tools","build")},SUB_PACKAGE_JS_NAME="game.js";function getTemplatePath(e){return path_1.join(__dirname,"../static/",e)}function getResPath(e){return path_1.join(__dirname,"../static/","build-template/res",e)}function onAfterInit(a,r,n){return __awaiter(this,void 0,void 0,function*(){window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(r.paths.dir);var e=a.packages["huawei-quick-game"];a.generateCompileConfig=!0,a.nextTasks=["make"],-1!==a.includeModules.indexOf("gfx-webgl2")&&(a.includeModules.splice(a.includeModules.indexOf("gfx-webgl2"),1),a.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),a.assetSerializeOptions.exportCCON=!0,a.moveRemoteBundleScript=!0;let t=a.packages["huawei-quick-game"].tinyPackageServer||"";t&&!t.endsWith("/")&&(t+="/"),Object.assign(a.appTemplateData,{showFPS:!1,server:t}),Object.assign(a.buildEngineParam,{platform:"HUAWEI"}),a.buildScriptParam.system={preset:"commonjs-like"};var i,e={orientation:e.deviceOrientation,remoteServerAddress:e.tinyPackageServer,packageName:e.package};n.__addStaticsInfo(e),fs_extra_1.existsSync(Paths.packPath)||(console.debug("start unzip pack tools"),e=require("v-unzip"),i=Paths.packPath+".zip",yield e.unzip(i,Paths.packPath))})}function onBeforeBuildAssets(e,t,i){return __awaiter(this,void 0,void 0,function*(){for(var e of t.bundles)e.isSubpackage&&(e.scriptDest=path_1.default.join(e.dest,"game.js"))})}function onAfterBuild(t,i,e,a){return __awaiter(this,void 0,void 0,function*(){var e;i.paths.dir&&(e=t.packages["huawei-quick-game"],yield renderGameJs(t,i),yield generateAdapter(t,i.paths.dir),writeConfigFile(i.paths.dir,t,i),handleSign(i.paths.dir,e.useDebugKey,e.privatePemPath,e.certificatePemPath),fs_extra_1.copySync(e.icon,path_1.join(i.paths.dir,path_1.basename(e.icon))))})}function make(t,i){return __awaiter(this,void 0,void 0,function*(){var e={name:i.name,tinyPackageServer:i.packages["huawei-quick-game"].tinyPackageServer};if(!(yield Build.Utils.isInstallNodeJs()))throw new Error("Please install nodejs in global first!");yield copyFileFromOptionsDest(t,i),yield buildRpk(t,e)})}function generateAdapter(n,s){return __awaiter(this,void 0,void 0,function*(){var e=path_1.join(s,"runtime-adapter"),t=(yield Editor.Message.request("engine","query-info")).path,i=n.platform,a=path_1.join(t,"platforms","runtime","platforms",i),a=path_1.join(a,"engine","index.js"),r=path_1.join(e,"engine-adapter.js"),a=(yield Build.Utils.createBundle(a,r,{debug:n.debug}),path_1.join(t,"platforms/runtime/common/web-adapter.js")),r=path_1.join(e,"web-adapter.js"),a=(fs_extra_1.copySync(a,r),path_1.join(t,"platforms/runtime")),r=path_1.join(a,"platforms",i,`ral${n.debug?"":".min"}.js`),t=path_1.join(e,"ral.js");fs_extra_1.copySync(r,t)})}function copyFileFromOptionsDest(r,e){return __awaiter(this,void 0,void 0,function*(){fs_extra_1.emptyDirSync(Paths.buildDir),fs_extra_1.ensureDirSync(Paths.buildDir);const t=[Build.SUBPACKAGES_HEADER,"cocos.compile.config.json","dist"];e.packages["huawei-quick-game"].tinyPackageServer&&t.push("remote");const i=[],a=(fs_extra_1.readdirSync(r).forEach(e=>{t.includes(e)||i.push({src:path_1.join(r,e),dest:path_1.join(Paths.buildDir,e)})}),path_1.join(r,Build.SUBPACKAGES_HEADER));fs_extra_1.existsSync(a)&&fs_extra_1.readdirSync(a).forEach(e=>{i.push({src:path_1.join(a,e),dest:path_1.join(Paths.buildDir,""+subpackagePrefix+e)})}),yield Promise.all(i.map(e=>{if(fs_extra_1.existsSync(e.src))return fs_extra_1.ensureDirSync(path_1.dirname(e.dest)),fs_extra_1.copySync(e.src,e.dest)}))})}function renderGameJs(t,i){return __awaiter(this,void 0,void 0,function*(){var e={optionDebug:t.debug,polyfillsBundleFile:i.paths.polyfillsJs&&Build.Utils.relativeUrl(i.paths.dir,i.paths.polyfillsJs)||!1,systemJsBundleFile:i.paths.systemJs&&Build.Utils.relativeUrl(i.paths.dir,i.paths.systemJs),importMapFile:Build.Utils.relativeUrl(i.paths.dir,i.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(i.paths.dir,i.paths.applicationJS)},e=yield ejs_1.default.renderFile(path_1.join(__dirname,"../static/build-template/game.ejs"),e);fs_extra_1.writeFileSync(path_1.join(i.paths.dir,"game.js"),e,"utf8")})}function buildRpk(n,s){return __awaiter(this,void 0,void 0,function*(){var e=path_1.join(n,"dist"),t=path_1.join(n,"sign/release/private.pem"),i=path_1.join(n,"sign/release/certificate.pem"),a=(console.log(Editor.I18n.t("builder.rpk_installing")),path_1.join(Paths.packPath,"lib","bin")),r=JSON.parse(JSON.stringify(process.env)),a=(r.PATH+=":"+a,[path_1.join(Paths.packPath,"index.js"),Paths.buildDir,e,s.name,t,i]),e=yield Build.Utils.quickSpawn("node",a,{cwd:n,env:r,downGradeError:!0});if(!0===e)return t=path_1.join(n,"dist",s.name+".rpk"),console.log(Editor.I18n.t("builder.huawei-quick-game.rpk_install_success")+`{link(${t})}`),t;throw new Error(Editor.I18n.t("builder.huawei-quick-game.rpk_install_fail")+e)})}function writeConfigFile(e,t,i){var a=t.packages["huawei-quick-game"],e=path_1.join(e,"manifest.json");const r={package:a.package,appType:"fastgame",name:t.name,versionName:a.versionName,versionCode:a.versionCode,minPlatformVersion:a.minPlatformVersion,icon:"/"+path_1.basename(a.icon),router:{},permissions:[{origin:"*"}]};let n;if(a.manifestPath&&fs_extra_1.existsSync(a.manifestPath))try{n=fs_extra_1.readJSONSync(a.manifestPath),console.debug("custom_manifest_data",JSON.stringify(n));const p=["package","appType","name","versionName","versionCode","icon","minPlatformVersion","permissions"];Object.keys(n).forEach(e=>{p.includes(e)||(r[e]=n[e])})}catch(e){console.log(Editor.I18n.t("builder.custom_manifest_data_error"))}var s,o=[];for(const l of i.bundles)l.isSubpackage&&(s=""+subpackagePrefix+l.name,o.push({name:s,resource:s+"/"}));0<o.length&&(r.subpackages=o),r.config||(r.config={}),r.display||(r.display={}),r.config.logLevel=a.logLevel,r.display.orientation=a.deviceOrientation,r.display.fullScreen=a.fullScreen,fs_extra_1.writeJSONSync(e,r)}function handleSign(e,t,i,a){e=path_1.join(e,"sign"),fs_extra_1.emptyDirSync(e),e=path_1.join(e,"release");fs_extra_1.ensureDirSync(e),t?(fs_extra_1.writeFileSync(path_1.join(e,"private.pem"),fs_extra_1.readFileSync(getResPath("private.pem"))),fs_extra_1.writeFileSync(path_1.join(e,"certificate.pem"),fs_extra_1.readFileSync(getResPath("certificate.pem")))):(fs_extra_1.existsSync(i)&&fs_extra_1.writeFileSync(path_1.join(e,"private.pem"),fs_extra_1.readFileSync(i)),fs_extra_1.existsSync(a)&&fs_extra_1.writeFileSync(path_1.join(e,"certificate.pem"),fs_extra_1.readFileSync(a)))}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBuildAssets=onBeforeBuildAssets,exports.onAfterBuild=onAfterBuild,exports.make=make;