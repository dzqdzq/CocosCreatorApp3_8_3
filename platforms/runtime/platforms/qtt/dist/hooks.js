"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){e[n=void 0===n?i:n]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,o,s,_){return new(s=s||Promise)(function(i,t){function n(e){try{a(_.next(e))}catch(e){t(e)}}function r(e){try{a(_.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?i(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(n,r)}a((_=_.apply(e,o||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.make=exports.onAfterBuild=exports.onBeforeBuildAssets=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=__importStar(require("fs-extra")),path_1=__importStar(require("path")),ejs_1=__importDefault(require("ejs")),cpk_utils_1=require("./utils/cpk-utils"),const_1=require("./utils/const"),hashes_1=require("./utils/hashes"),fs_1=require("fs"),_PROJECT_TEMPLATE_DIR=path_1.default.join(Editor.Project.path,"build-templates",const_1.PLATFORM_NAME),_SUBPACKAGE_PREFIX="usr_";function onAfterInit(i,n,r){return __awaiter(this,void 0,void 0,function*(){window.__manager.taskManager.debug||fs_extra_1.default.emptyDirSync(n.paths.dir),i.nextTasks=["make"],i.generateCompileConfig=!0,i.moveRemoteBundleScript=!0,i.assetSerializeOptions.exportCCON=!0;var e=i.packages[const_1.PLATFORM_NAME];let t=e.resourceURL||"";t&&!t.endsWith("/")&&(t+="/"),Object.assign(i.appTemplateData,{showFPS:!1,server:t}),Object.assign(i.buildEngineParam,{platform:const_1.PLATFORM}),i.buildScriptParam.system={preset:"commonjs-like"};e={orientation:e.deviceOrientation,remoteServerAddress:e.resourceURL};r.__addStaticsInfo(e)})}function onBeforeBuildAssets(e,t){return __awaiter(this,void 0,void 0,function*(){for(var e of t.bundles)e.isSubpackage&&(e.scriptDest=path_1.default.join(e.dest,"main.js"))})}function onAfterBuild(n,r,e,t){return __awaiter(this,void 0,void 0,function*(){var e,t=n.packages[const_1.PLATFORM_NAME],i=r.paths.dir,t=(fs_extra_1.default.existsSync(_PROJECT_TEMPLATE_DIR)&&(fs_extra_1.default.copySync(_PROJECT_TEMPLATE_DIR,i),console.debug(`Use build-template {link(${_PROJECT_TEMPLATE_DIR})}.`)),yield _generate_adapter_by_gulp(n,i),yield _render_main_js(n,r),_generate_game_config_json(i,n,r),t.workerPath);t&&(e=path_1.default.join(Editor.Project.path,t),i=path_1.default.join(i,t),fs_extra_1.default.existsSync(e)?fs_extra_1.default.copySync(e,i):console.warn(_get_string_i18n("tips.not_empty")+" "+_get_string_i18n("option.worker_path")+" "+t))})}function make(r,a){return __awaiter(this,void 0,void 0,function*(){let e=path_1.default.join(r,"dist",a.name+".cpk");fs_extra_1.emptyDirSync(path_1.dirname(e)),fs_extra_1.ensureDirSync(path_1.dirname(e));var t=["subpackages","dist","cocos.compile.config.json"],i=path_1.default.join(r,Build.SUBPACKAGES_HEADER);if(fs_1.existsSync(i))for(var n of fs_1.readdirSync(i)){t.push(n),n=_SUBPACKAGE_PREFIX+n;const e=path_1.default.join(i,n+"."+hashes_1.CRC32(n)+".cpk");yield _generate_zip(path_1.default.join(i,n),e)}a.packages.qtt.resourceURL&&t.push("remote"),yield _generate_zip(r,e,t)})}function _get_string_i18n(e){return Editor.I18n.t(const_1.PLATFORM_NAME+"."+e)}function _generate_zip(n,r,a=[]){return __awaiter(this,void 0,void 0,function*(){const t=new cpk_utils_1.JsZip;t.directory(n);for(var e of a)t.remove(e);const i=fs_extra_1.default.createWriteStream(r);return new Promise(e=>{t.generateNodeStream({type:"nodebuffer",base64:!1,compression:"DEFLATE"}).pipe(i).on("finish",()=>{e()})})})}function _generate_adapter_by_gulp(a,o){return __awaiter(this,void 0,void 0,function*(){var e=(yield Editor.Message.request("engine","query-info")).path,t=path_1.default.join(e,"platforms","runtime","platforms",a.platform),i=path_1.default.join(o,"runtime-adapter"),n=path_1.default.join(t,"engine","index.js"),r=path_1.default.join(i,"engine-adapter.js"),n=(yield Build.Utils.createBundle(n,r,{debug:a.debug}),path_1.default.join(e,"platforms/runtime/common/web-adapter.js")),r=path_1.default.join(i,"web-adapter.js"),e=(fs_extra_1.default.copyFileSync(n,r),path_1.default.join(t,`ral${a.debug?"":".min"}.js`)),n=path_1.default.join(i,"ral.js");fs_extra_1.default.copyFileSync(e,n)})}function _render_main_js(i,n){return __awaiter(this,void 0,void 0,function*(){var e=n.paths,t=e.dir,e={optionDebug:i.debug,polyfillsBundleFile:e.polyfillsJs&&Build.Utils.relativeUrl(t,e.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t,e.systemJs),importMapFile:Build.Utils.relativeUrl(t,e.importMap),orientationNum:"landscape"===i.packages[const_1.PLATFORM_NAME].deviceOrientation?0:1,applicationJs:"./"+Build.Utils.relativeUrl(t,e.applicationJS)},e=yield ejs_1.default.renderFile(path_1.default.join(__dirname,"../static/build-template/main.ejs"),e);fs_extra_1.default.writeFileSync(path_1.default.join(t,"main.js"),e)})}function _generate_game_config_json(e,t,i){var n=t.packages[const_1.PLATFORM_NAME],t={package:n.package,name:t.name,versionName:n.versionName,versionCode:n.versionCode,icon:path_1.basename(n.icon)},r=(n.workerPath&&(t.workers=n.workerPath),{});if(""!==n.cameraPermissionHint&&(r["scope.userLocation"]=n.cameraPermissionHint),""!==n.userInfoPermissionHint&&(r["scope.userInfo"]=n.userInfoPermissionHint),""!==n.locationPermissionHint&&(r["scope.userLocation"]=n.locationPermissionHint),""!==n.albumPermissionHint&&(r["scope.writePhotosAlbum"]=n.albumPermissionHint),Object.keys(r).length&&(t.permission=r),i.bundles.length){var a=[];for(const o of i.bundles)o.isSubpackage&&a.push({name:_SUBPACKAGE_PREFIX+o.name,root:""+_SUBPACKAGE_PREFIX+o.name+"/"});t.subpackages=a}n=path_1.default.join(_PROJECT_TEMPLATE_DIR,"game.config.json"),fs_extra_1.default.existsSync(n)&&(r=fs_extra_1.default.readJSONSync(n),Object.assign(t,r)),i=path_1.default.join(e,"game.config.json");fs_extra_1.default.writeJSONSync(i,t)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBuildAssets=onBeforeBuildAssets,exports.onAfterBuild=onAfterBuild,exports.make=make;