"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,a){void 0===a&&(a=i),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,a){e[a=void 0===a?i:a]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,n,o,p){return new(o=o||Promise)(function(i,t){function a(e){try{s(p.next(e))}catch(e){t(e)}}function r(e){try{s(p.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?i(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(a,r)}s((p=p.apply(e,n||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),Editor=__importStar(require("editor")),globby=require("globby"),templateDir=path_1.join(__dirname,"../static"),OPEN_DATA_CONTEXT_ROOT="openDataContext";function onAfterInit(s,n,o){return __awaiter(this,void 0,void 0,function*(){var e=s.packages["bytedance-mini-game"];-1!==s.includeModules.indexOf("gfx-webgl2")&&s.includeModules.splice(s.includeModules.indexOf("gfx-webgl2"),1,"gfx-webgl"),s.assetSerializeOptions.exportCCON=!0,"physX"===e.physX.use&&-1!==(i=s.includeModules.findIndex(e=>e.startsWith("physics-")&&!e.startsWith("physics-2d")))&&s.includeModules.splice(i,1,"physics-physx"),s.includeModules.includes("physics-physx")&&!e.appid&&console.error(Editor.I18n.t("bytedance-mini-game.tips.require_appid")),s.moveRemoteBundleScript=!0,s.includeModules=Array.from(new Set(s.includeModules));let t=e.remoteServerAddress||"";t&&!t.endsWith("/")&&(t+="/"),Object.assign(s.appTemplateData,{showFPS:!1,server:t}),Object.assign(s.buildEngineParam,{platform:"BYTEDANCE",moduleStyle:"cjs"}),s.buildScriptParam.importMapFormat="commonjs",s.buildScriptParam.system={preset:"commonjs-like"},s.buildScriptParam.flags.NOT_PACK_PHYSX_LIBS=!!e.physX.notPackPhysXLibs,Object.assign(s.physicsConfig,{physX:e.physX}),delete s.physicsConfig.physX.use;var i=path_1.join(n.paths.dir,OPEN_DATA_CONTEXT_ROOT),a=path_1.join(Editor.Project.tmpDir,"builder/bytedance-mini-game",OPEN_DATA_CONTEXT_ROOT),r=(fs_extra_1.existsSync(i)&&(fs_extra_1.existsSync(a)&&fs_extra_1.removeSync(a),fs_extra_1.copySync(i,a)),{orientation:e.orientation,appid:e.appid,remoteServerAddress:e.remoteServerAddress});o.__addStaticsInfo(r),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(n.paths.dir),fs_extra_1.existsSync(a)?fs_extra_1.moveSync(a,i):e.buildOpenDataContextTemplate&&(r=(yield Editor.Message.request("engine","query-info")).path,a=path_1.join(r,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT),fs_extra_1.copySync(a,i))})}function onBeforeCompressSettings(e,t){return __awaiter(this,void 0,void 0,function*(){t.paths.dir&&(yield buildAdapters(t.paths.dir))})}function onAfterBuild(t,i,e,a){return __awaiter(this,void 0,void 0,function*(){var e=path_1.join(i.paths.dir,"src/"+t.buildScriptParam.outputName);fs_extra_1.existsSync(e)||fs_extra_1.outputFileSync(e,"console.log('There is no script in project.')","utf-8"),yield copyResFiles(t,i,a)})}function buildAdapters(a){return __awaiter(this,void 0,void 0,function*(){var e=(yield Editor.Message.request("engine","query-info")).path;const i=path_1.join(e,"platforms/minigame");e=yield globby(path_1.join(i,"common/**/*"),{nodir:!0}),yield Promise.all(e.map(e=>{var t=compileJS(fs_extra_1.readFileSync(e,"utf-8"),e),e=path_1.relative(i,e),e=path_1.join(a,"libs",e);fs_extra_1.outputFileSync(e,t,"utf-8")})).catch(e=>{e.stack="BuildWechatLibTemplate error: "+e.stack,console.error(e)}),e=yield globby(path_1.join(i,"platforms/bytedance/wrapper/**/*"),{nodir:!0});yield Promise.all(e.map(e=>{var t=compileJS(fs_extra_1.readFileSync(e,"utf-8"),e),e=path_1.relative(path_1.join(i,"platforms/bytedance/"),e),e=path_1.join(a,"libs",e);fs_extra_1.outputFileSync(e,t,"utf-8")})).catch(e=>{e.stack="BuildByteDanceLibTemplate error: "+e.stack,console.error(e)})})}function copyResFiles(r,s,n){return __awaiter(this,void 0,void 0,function*(){var e=r.packages["bytedance-mini-game"],t=r.buildEngineParam.engineName,i=path_1.join(templateDir,"build-template"),a=path_1.join(i,"game.ejs"),t={engineName:t,polyfillsBundleFile:s.paths.polyfillsJs&&Build.Utils.relativeUrl(s.paths.dir,s.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(s.paths.dir,s.paths.systemJs),importMapFile:Build.Utils.relativeUrl(s.paths.dir,s.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(s.paths.dir,s.paths.applicationJS),appid:e.appid,isUsePhysX:r.includeModules.includes("physics-physx")},e=yield ejs_1.default.renderFile(a,t),a=(fs_extra_1.writeFileSync(path_1.join(s.paths.dir,"game.js"),e,"utf-8"),path_1.join(Build.buildTemplateDir,r.platform));fs_extra_1.existsSync(a)&&fs_extra_1.copySync(a,s.paths.dir),buildGameJson(i,s,r,n,a),buildProjectJson(i,s.paths.dir,r,a)})}function buildGameJson(e,t,i,a,r){var s,n=t.paths.dir,i=i.packages["bytedance-mini-game"],e=fs_extra_1.readJSONSync(path_1.join(e,"game.json")),i=("landscapeRight"!==i.orientation&&"landscapeLeft"!==i.orientation||(i.orientation="landscape"),e.deviceOrientation=i.orientation,i.buildOpenDataContextTemplate?e.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete e.openDataContext,path_1.join(r,"game.json")),o=(fs_extra_1.existsSync(i)&&(r=fs_extra_1.readJSONSync(i),Object.assign(e,r)),[]);for(const p of t.bundles)p.isSubpackage&&(s=path_1.join(path_1.dirname(p.scriptDest),"game.js"),fs_extra_1.existsSync(p.scriptDest)?fs_extra_1.renameSync(p.scriptDest,s):fs_extra_1.outputFileSync(s,`console.log('${name}: no script in subPackage.')`,"utf8"),p.scriptDest=s,o.push({name:p.name,root:`subpackages/${p.name}/`}));0<o.length&&(e.subpackages=o);i=path_1.join(n,"game.json");fs_extra_1.outputJSONSync(i,e,{spaces:4})}function buildProjectJson(e,t,i,a){e=fs_extra_1.readJSONSync(path_1.join(e,"project.config.json")),e.appid=i.packages["bytedance-mini-game"].appid||"testappid",e.projectname=i.name,i=path_1.join(t,"project.config.json"),t=path_1.join(a,"project.config.json");fs_extra_1.existsSync(t)&&(a=fs_extra_1.readJSONSync(t),Object.assign(e,a)),fs_extra_1.outputJSONSync(i,e)}function compileJS(e,t){let i;try{var a=require("@babel/core");i=a.transform(e,{ast:!1,highlightCode:!1,sourceMaps:!1,compact:!1,filename:t,presets:[require("@babel/preset-env")],plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")],[require("@babel/plugin-proposal-export-default-from")]]})}catch(e){throw e.stack=`Compile ${name} error: `+e.stack,e}return i.code}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;