"use strict";var __awaiter=this&&this.__awaiter||function(e,n,s,l){return new(s=s||Promise)(function(r,t){function i(e){try{a(l.next(e))}catch(e){t(e)}}function o(e){try{a(l.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?r(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(i,o)}a((l=l.apply(e,n||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.load=exports.methods=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),server_1=require("./server"),electron_1=require("electron"),lodash=require("lodash");function load(){return __awaiter(this,void 0,void 0,function*(){var e=(yield Editor.Profile.getConfig("builder","BuildTaskManager.taskMap"))||{};Object.values(e).forEach(e=>{var t,r;1===e.progress&&(r=lodash.get(e,"options.platform"),t=lodash.get(e,"options.buildPath"),"web-mobile"===r)&&"string"==typeof t&&(r=path_1.join(Editor.UI.File.resolveToRaw(t),e.options.outputName),server_1.setRootPath(r))})})}function getPreviewUrl(t){return __awaiter(this,void 0,void 0,function*(){var e=yield Editor.Message.request("server","query-port");return`http://${yield Editor.Message.request("preview","get-preview-ip")}:${e}/web-mobile/${t}/index.html`})}exports.methods={"create-build-template"(){return __awaiter(this,void 0,void 0,function*(){var e=path_1.join(__dirname,"../static/build-template/index.ejs").replace("app.asar","app.asar.unpacked"),t=path_1.join(Editor.Project.path,"build-templates","web-mobile",path_1.basename(e));if(fs_extra_1.existsSync(t)&&1===(yield Editor.Dialog.warn("Do you want to overwrite the source file?",{buttons:["Yes","Cancel"],default:0,cancel:1})).response)return!1;fs_extra_1.copySync(e,t),console.log(`web-mobile ${Editor.I18n.t("web-mobile.tips.creat_template_success")}({link(${t})})`)})},preview(t){return __awaiter(this,void 0,void 0,function*(){server_1.setRootPath(t);var e=yield getPreviewUrl(path_1.basename(t));return electron_1.shell.openExternal(e),e})},"set-preview-path"(t){return __awaiter(this,void 0,void 0,function*(){server_1.setRootPath(t);var e=yield getPreviewUrl(path_1.basename(t));return fs_extra_1.existsSync(t),e})}},exports.load=load;