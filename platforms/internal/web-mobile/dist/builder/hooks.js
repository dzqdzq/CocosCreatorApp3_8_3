"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){e[r=void 0===r?i:r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,o,n,l){return new(n=n||Promise)(function(i,t){function r(e){try{a(l.next(e))}catch(e){t(e)}}function s(e){try{a(l.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?i(e.value):((t=e.value)instanceof n?t:new n(function(e){e(t)})).then(r,s)}a((l=l.apply(e,o||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onBeforeBuildAssets=exports.onAfterInit=exports.throwError=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path"),Editor=__importStar(require("editor")),babel=__importStar(require("@babel/core")),preset_env_1=__importDefault(require("@babel/preset-env")),buildStaticDir=path_1.join(__dirname,"../../static/build-template");function onAfterInit(i,r,s){return __awaiter(this,void 0,void 0,function*(){window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(r.paths.dir);var e=i.packages["web-mobile"],e={orientation:e.orientation,remoteServerAddress:e.remoteServerAddress};s.__addStaticsInfo(e),i.buildScriptParam.polyfills=i.packages["web-mobile"].polyfills,i.buildScriptParam.system={preset:"web"},i.buildEngineParam.split=!1,i.buildEngineParam.ammoJsWasm="fallback",i.buildEngineParam.assetURLFormat="runtime-resolved";let t=i.packages["web-mobile"].remoteServerAddress||"";t&&!t.endsWith("/")&&(t+="/"),Object.assign(i.appTemplateData,{server:t})})}function onBeforeBuildAssets(e,r,s){return __awaiter(this,void 0,void 0,function*(){for(const i of s.scriptUuids){var e=s.getAssetInfo(i),t=yield s.getMeta(i);e?t?t.userData.isPlugin&&t.userData.loadPluginInWeb&&r.addPlugin(e):console.error(`Get meta of script {asset(${e.url})} failed!`):console.error(`Get asset info of script {asset(${i})} failed!`)}})}function onBeforeCompressSettings(t,r,e){return __awaiter(this,void 0,void 0,function*(){if(r.paths.dir){var e=t.packages["web-mobile"];const i=r.settings;i.orientation=e.orientation,i.jsList.forEach((e,t)=>{i.jsList[t]=e.split("/").map(encodeURIComponent).join("/")})}})}function onAfterBuild(n,l){return __awaiter(this,void 0,void 0,function*(){var e=n.packages["web-mobile"],t=yield ejs_1.default.renderFile(path_1.join(buildStaticDir,"index.js.ejs"),{applicationJS:"./"+Build.Utils.relativeUrl(l.paths.dir,l.paths.applicationJS)}),t=yield babel.transformAsync(t,{presets:[[preset_env_1.default,{modules:"systemjs"}]]});if(!t||!t.code)throw new Error("无法生成 index.js");let i="";n.md5Cache&&(i="."+Build.Utils.calcMd5(t.code));var r=path_1.join(l.paths.dir,`index${i}.js`);fs_extra_1.outputFileSync(r,t.code,"utf-8");let s=path_1.join(l.paths.dir,"style.css");fs_extra_1.copyFileSync(path_1.join(buildStaticDir,"style.css"),s),n.md5Cache&&(t=yield Build.Utils.appendMd5ToPaths([s]),s=t.paths[0]);t={polyfillsBundleFile:l.paths.polyfillsJs&&Build.Utils.relativeUrl(l.paths.dir,l.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(l.paths.dir,l.paths.systemJs),projectName:n.name,orientation:e.orientation,engineName:n.buildEngineParam.engineName,webDebuggerSrc:"",cocosTemplate:path_1.join(buildStaticDir,"index-plugin.ejs"),importMapFile:Build.Utils.relativeUrl(l.paths.dir,l.paths.importMap),indexJsName:path_1.basename(r),cssUrl:path_1.basename(s)};if(e.embedWebDebugger){t.webDebuggerSrc="./vconsole.min.js";try{fs_extra_1.copySync(path_1.join(buildStaticDir,"vconsole.min.js"),path_1.join(l.paths.dir,"vconsole.min.js"))}catch(e){console.warn("Copy vconsole failed.")}}let a=!0,o=path_1.join(Build.buildTemplateDir,n.platform,"index.ejs");fs_extra_1.existsSync(o)||(o=path_1.join(buildStaticDir,"index.ejs"),a=!1);r=yield ejs_1.default.renderFile(o,t),fs_extra_1.outputFileSync(path_1.join(l.paths.dir,"index.html"),r,"utf8"),e=path_1.join(Editor.Project.path,"build-templates",n.platform);fs_extra_1.existsSync(e)&&(fs_extra_1.copySync(e,l.paths.dir),console.debug(`Use build-template {link(${e})}.`)),a&&fs_extra_1.removeSync(path_1.join(l.paths.dir,"index.ejs")),Editor.Message.request("web-mobile","set-preview-path",l.paths.dir)})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBuildAssets=onBeforeBuildAssets,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;