"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createBundle=exports.checkLiteVersion=exports.compileJsbAdapter=exports.outputJSBAdapter=exports.clearDest=exports.cocos=exports.NATIVE_MODULES=exports.PATH=exports.Path=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),child_process_1=require("child_process"),fs_1=require("fs"),plist=require("plist"),babelify=require("babelify"),browserify=require("browserify");class Path{get COCOS2DX(){return Path._root}get COCOS(){return path_1.join(Path._root,"tools/cocos-console/bin")}get TEMPLATE(){return path_1.join(Path._root,"templates")}get COCOS_CMD(){return path_1.join(this.COCOS,"win32"===process.platform?"cocos_cli.js":"cocos")}get NODEJS(){return"node"}static async queryNativeEnginePath(){var e=await Editor.Message.request("engine","query-info",Editor.Project.type);return e&&e.nativePath}}async function cocos(s,e){if(-1!==exports.PATH.COCOS_CMD.indexOf(" "))throw new Error(`Cocos2dx root [${exports.PATH.COCOS_CMD}] can't include space.`);var t=[exports.PATH.COCOS_CMD,...s];console.warn("cocos "+t.join(" "));const n=child_process_1.spawn("win32"===process.platform?exports.PATH.NODEJS:"sh",t,e);n.stdout.on("data",e=>{let t;(t=1<(t=e.toString()).length?t.replace(/\n*$/g,""):t).split("\n").forEach(e=>{console.log("[Cocos]: "+e)})}),n.stderr.on("data",e=>{e.toString().split("\n").forEach(e=>{-1!==(e="[Cocos]: "+e).toLowerCase().indexOf("warning")?console.warn(e):console.error(e)})}),await new Promise((r,o)=>{n.on("close",(e,t)=>{0!==e?(console.error(`[error] run cocos ${exports.PATH.NODEJS} ${exports.PATH.COCOS_CMD} `+s.join(" ")),console.error(`[error] return code ${e}, signal `+t),o(new Error("cocos 命令执行失败，详情请查看构建控制台。"))):r(e)}),n.on("error",e=>{o(e)})})}async function clearDest(e){try{await fs_extra_1.remove(path_1.join(e,"assets"))}catch(e){console.error(e)}}async function outputJSBAdapter(e,t){var t=(t||{})["targets"],r=await Editor.Message.request("engine","query-info",Editor.Project.type),o=path_1.join(r.path,"platforms/native/builtin/index.js"),r=path_1.join(r.path,"platforms/native/engine/index.js");await createBundle(o,path_1.join(e,"jsb-adapter","jsb-builtin.js"),{targets:t}),await createBundle(r,path_1.join(e,"jsb-adapter","jsb-engine.js"),{targets:t})}async function compileJsbAdapter(){var e,t=await Editor.Message.request("engine","query-info",Editor.Project.type),r=path_1.join(t.path,"platforms/native"),t=path_1.join(t.path,"bin/.cache/dev/native-preview-adapter");hasChanged(r,t)&&(e=path_1.join(r,"builtin/index.js"),r=path_1.join(r,"engine/index.js"),await createBundle(e,path_1.join(t,"jsb-builtin.js"),{targets:"chrome 80"}),await createBundle(r,path_1.join(t,"jsb-engine.js"),{targets:"chrome 80"}))}async function checkLiteVersion(e){e=path_1.join(e,".cocos-project.json");fs_extra_1.existsSync(e)?(await fs_extra_1.readJSON(e)).engine_version:console.error(`Can't find project json [{link(${e})}]`)}function checkFileStat(r,o){return fs_1.readdirSync(r).some(e=>{var e=path_1.join(r,e),t=fs_1.statSync(e);return t.isDirectory()?checkFileStat(e,o):t.mtime.getTime()>o||void 0})}function hasChanged(e,t){var r,o;return!fs_extra_1.existsSync(t)||(o=path_1.join(t,"jsb-builtin.js"),r=path_1.join(t,"jsb-engine.js"),!fs_extra_1.existsSync(o))||!fs_extra_1.existsSync(r)||(o=fs_1.statSync(t),checkFileStat(path_1.dirname(e),o.mtime.getTime()))}async function createBundle(e,s,t){let r,n;Array.isArray(t)?r=t:t&&(r=t.excludes,n=t.targets);const a=browserify(e);return r&&r.forEach(function(e){a.exclude(e)}),await fs_extra_1.ensureDir(path_1.dirname(s)),new Promise((r,o)=>{a.transform(babelify,{presets:[[require("@babel/preset-env"),{targets:n}]]}).bundle((e,t)=>{e?(console.error(e),o(e)):(fs_extra_1.writeFileSync(s,t,"utf8"),r())})})}(exports.Path=Path)._root=path_1.join(Editor.App.path,"../resources/3d/engine/native"),exports.PATH=new Path,exports.NATIVE_MODULES=[["USE_VIDEO","VideoPlayer"],["USE_WEBVIEW","WebView"],["USE_EDIT_BOX","EditorBox"],["USE_AUDIO","AudioSource"],["USE_SPINE","Spine Skeleton"],["USE_DRAGONBONES","DragonBones"],["USE_SOCKET","Native Socket"]],exports.cocos=cocos,exports.clearDest=clearDest,exports.outputJSBAdapter=outputJSBAdapter,exports.compileJsbAdapter=compileJsbAdapter,exports.checkLiteVersion=checkLiteVersion,exports.createBundle=createBundle;