"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){e[r=void 0===r?i:r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,n,s,l){return new(s=s||Promise)(function(i,t){function r(e){try{o(l.next(e))}catch(e){t(e)}}function a(e){try{o(l.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?i(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,a)}o((l=l.apply(e,n||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),Editor=__importStar(require("editor")),globby=require("globby");function onAfterInit(i,r,a){return __awaiter(this,void 0,void 0,function*(){Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"alipay-minigame"}),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(r.paths.dir);let e=i.packages["alipay-mini-game"].remoteUrl||"";e&&!e.endsWith("/")&&(e+="/"),Object.assign(i.appTemplateData,{showFPS:!1,server:e}),i.moveRemoteBundleScript=!0,Object.assign(i.buildEngineParam,{platform:"ALIPAY"}),i.buildScriptParam.importMapFormat="commonjs",i.buildScriptParam.polyfills=i.packages["alipay-mini-game"].polyfills,i.buildScriptParam.system={preset:"commonjs-like"},-1!==i.includeModules.indexOf("gfx-webgl2")&&(i.includeModules.splice(i.includeModules.indexOf("gfx-webgl2"),1),i.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),i.assetSerializeOptions.exportCCON=!0;var t={orientation:i.packages["alipay-mini-game"].deviceOrientation,remoteServerAddress:i.packages["alipay-mini-game"].remoteUrl};a.__addStaticsInfo(t)})}function onBeforeCompressSettings(e,t,i){return __awaiter(this,void 0,void 0,function*(){t.settings.orientation=e.packages["alipay-mini-game"].deviceOrientation})}function onAfterBuild(i,r,e){return __awaiter(this,void 0,void 0,function*(){var e,t;r.paths.dir&&(t=(yield Editor.Message.request("engine","query-info")).path,t=path_1.join(t,"platforms/minigame"),i.buildEngineParam.engineName,e=path_1.join(__dirname,"../static/build-template"),copyAdapter(t,r.paths.dir),this.getTaskResult("build-task/script"),t={polyfillsBundleFile:r.paths.polyfillsJs&&Build.Utils.relativeUrl(r.paths.dir,r.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(r.paths.dir,r.paths.systemJs),importMapFile:Build.Utils.relativeUrl(r.paths.dir,r.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(r.paths.dir,r.paths.applicationJS)},t=yield ejs_1.default.renderFile(path_1.join(e,"game.ejs"),t),fs_extra_1.writeFileSync(path_1.join(r.paths.dir,"game.js"),t),t=path_1.join(Build.buildTemplateDir,i.platform),fs_extra_1.existsSync(t)&&(fs_extra_1.copySync(t,r.paths.dir),console.debug(`Use build-template {link(${t})}.`)),(e=fs_extra_1.readJSONSync(path_1.join(e,"game.json"))).screenOrientation=i.packages["alipay-mini-game"].deviceOrientation,t=path_1.join(t,"game.json"),fs_extra_1.existsSync(t)&&(t=fs_extra_1.readJSONSync(t),Object.assign(e,t)),t=path_1.join(r.paths.dir,"game.json"),fs_extra_1.writeJSONSync(t,e))})}function copyAdapter(i,r){return __awaiter(this,void 0,void 0,function*(){var e=yield globby(path_1.join(i,"common/**/*"),{nodir:!0}),e=(yield Promise.all(e.map(e=>{var t=compileJS(fs_extra_1.readFileSync(e,"utf8"),e),e=path_1.relative(i,e),e=path_1.join(r,"libs",e);fs_extra_1.outputFileSync(e,t,"utf8")})).catch(e=>{e.stack="BuildWechatLibTemplate error: "+e.stack,console.error(e)}),yield globby(path_1.join(i,"platforms/alipay/wrapper/**/*"),{nodir:!0}));yield Promise.all(e.map(e=>{var t=compileJS(fs_extra_1.readFileSync(e,"utf8"),e),e=path_1.relative(path_1.join(i,"platforms/alipay/"),e),e=path_1.join(r,"libs",e);fs_extra_1.outputFileSync(e,t,"utf8")})).catch(e=>{e.stack="BuildWechatLibTemplate error: "+e.stack,console.error(e)})})}function compileJS(e,t){let i;try{var r=require("@babel/core");i=r.transform(e,{ast:!1,highlightCode:!1,sourceMaps:!1,compact:!1,filename:t,presets:[require("@babel/preset-env")],plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")],[require("@babel/plugin-proposal-export-default-from")]]})}catch(e){throw e.stack=`Compile ${name} error: `+e.stack,e}return i.code}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;