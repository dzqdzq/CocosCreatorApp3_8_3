"use strict";var childProcess=require("child_process"),spawn=childProcess.spawn,exec=childProcess.exec,execSync=childProcess.execSync,spawnSync=childProcess.spawnSync;function killAll(n,e,i){var r={};try{Object.keys(n).forEach(function(c){n[c].forEach(function(c){r[c]||(killPid(c,e),r[c]=1)}),r[c]||(killPid(c,e),r[c]=1)})}catch(c){if(i)return i(c);throw c}if(i)return i()}function killPid(c,n){try{process.kill(parseInt(c,10),n)}catch(c){if("ESRCH"!==c.code)throw c}}function Uint8ArrayToString(c){for(var n="",e=0;e<c.length;e++)n+=String.fromCharCode(c[e]);return n}function killInMac(c){var n;Uint8ArrayToString(spawnSync("lsof",["-i",":"+c]).stdout).split(/[\n|\r]/).forEach(c=>{-1===c.indexOf("LISTEN")||n||(c=c.split(/\s+/),/\d+/.test(c[1])&&(n=c[1]))}),n?execSync("kill -9 "+n):Editor.log(`port:${c} close!`)}function buildProcessTree(n,e,i,r,t){var c=r(n),o="";c.stdout.on("data",function(c){c=c.toString("ascii");o+=c});c.on("close",function(c){delete i[n],0!=c?0==Object.keys(i).length&&t():o.match(/\d+/g).forEach(function(c){c=parseInt(c,10),e[n].push(c),e[c]=[],i[c]=1,buildProcessTree(c,e,i,r,t)})})}module.exports=function(c,n,e,i){var r={},t={};switch(r[c]=[],t[c]=1,"function"==typeof e&&void 0===i&&(i=e,e=void 0),process.platform){case"win32":execSync("taskkill /pid "+c+" /T /F");break;case"darwin":killInMac(n);break;default:buildProcessTree(c,r,t,function(c){return spawn("ps",["-o","pid","--no-headers","--ppid",c])},function(){killAll(r,e,i)})}};