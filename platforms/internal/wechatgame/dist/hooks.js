"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,i){e[i=void 0===i?a:i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,s,o,p){return new(o=o||Promise)(function(a,t){function i(e){try{n(p.next(e))}catch(e){t(e)}}function r(e){try{n(p.throw(e))}catch(e){t(e)}}function n(e){var t;e.done?a(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(i,r)}n((p=p.apply(e,s||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),Editor=__importStar(require("editor")),separate_engine_1=require("./separate-engine"),stats_query_1=require("@cocos/build-engine/dist/stats-query"),index_1=require("@cocos/build-engine/dist/index"),ccBuild=__importStar(require("@cocos/build-engine")),enumerate_dependent_chunks_js_1=require("@cocos/build-engine/dist/enumerate-dependent-chunks.js"),fs_1=require("fs"),globby=require("globby"),templateDir=path_1.join(__dirname,"../static"),userTemplateDir=path_1.join(Build.buildTemplateDir,"wechatgame"),OPEN_DATA_CONTEXT_ROOT="openDataContext";function onAfterInit(n,s,o){return __awaiter(this,void 0,void 0,function*(){var e=n.packages.wechatgame;-1!==n.includeModules.indexOf("gfx-webgl2")&&"sameAsProjectSetting"!==e.enabelWebGL2&&(n.includeModules.splice(n.includeModules.indexOf("gfx-webgl2"),1),n.assetSerializeOptions["cc.EffectAsset"].glsl3=!1);let t=e.remoteServerAddress||"";t&&!t.endsWith("/")&&(t+="/"),Object.assign(n.appTemplateData,{showFPS:!1,server:t}),n.moveRemoteBundleScript=!0,n.assetSerializeOptions.exportCCON=!0,e.separateEngine&&(/\d*\.\d*\.\d*$/.test(Editor.App.version)||Editor.App.dev?(e.separateEngine&&n.debug&&console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_with_debug")),a=yield Editor.Message.request("engine","query-info"),path_1.join(Editor.App.path,"../resources",Editor.Project.type,"engine")===a.path?e.separateEngine=e.separateEngine&&!n.debug:console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_with_custom_engine"))):console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_only_in_normal_version"))),"js"===e.wasm?e.wasm=!1:"wasm"===e.wasm&&(-1!==(a=n.includeModules.findIndex(e=>e.startsWith("physics-")&&!e.startsWith("physics-2d")))?(n.includeModules.splice(a,1,"physics-ammo"),e.wasm=!0):e.wasm=!1),Object.assign(n.buildEngineParam,{platform:"WECHAT",sourceMaps:!e.separateEngine&&n.sourceMaps,split:e.separateEngine,skip:e.separateEngine,ammoJsWasm:e.wasm}),n.buildEngineParam.assetURLFormat="relative-from-out",n.buildScriptParam.importMapFormat="commonjs",n.buildScriptParam.system={preset:"commonjs-like"};var a=path_1.join(s.paths.dir,OPEN_DATA_CONTEXT_ROOT),i=path_1.join(Editor.Project.tmpDir,"builder/wechatagame",OPEN_DATA_CONTEXT_ROOT),r=(fs_extra_1.existsSync(a)&&(fs_extra_1.existsSync(i)&&fs_extra_1.removeSync(i),fs_extra_1.copySync(a,i)),{orientation:e.orientation,appid:e.appid,remoteServerAddress:e.remoteServerAddress});o.__addStaticsInfo(r),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(s.paths.dir),fs_extra_1.existsSync(i)?fs_extra_1.moveSync(i,a):e.buildOpenDataContextTemplate&&(r=(yield Editor.Message.request("engine","query-info")).path,i=path_1.join(r,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT),fs_extra_1.copySync(i,a))})}function onBeforeCompressSettings(e,t,a){return __awaiter(this,void 0,void 0,function*(){t.paths.dir&&(e.packages.wechatgame.separateEngine&&(yield buildSeparateEngine(e,t)),sortSubPackage(e,t,a))})}function onAfterBuild(e,t,a,i){return __awaiter(this,void 0,void 0,function*(){yield _buildWeChatTemplate(e,t,i)})}function buildSeparateEngine(d,h){return __awaiter(this,void 0,void 0,function*(){fs_extra_1.ensureDirSync(h.paths.engineDir),yield separate_engine_1.buildCocos(!Editor.App.dev);var e=d.buildEngineParam.includeModules,t=yield stats_query_1.StatsQuery.create(separate_engine_1.separateEnginPaths.internalEngine),a=t.getUnitsOfFeatures(e);const i=separate_engine_1.getWechatPluginFeatures(),r=t.getUnitsOfFeatures(i),n=fs_extra_1.readJSONSync(path_1.join(separate_engine_1.separateEnginPaths.outDir,"meta.json")),s=[];var o=path_1.join(h.paths.engineDir,"cc.js"),t=yield index_1.build.transform(t.evaluateIndexModuleSource(a,e=>r.includes(e)?(s.push(e),`plugin:cocos/${e}.js`):(fs_extra_1.copySync(path_1.join(separate_engine_1.separateEnginPaths.cacheCocos,e+".js"),path_1.join(h.paths.engineDir,e+".js")),`./${e}.js`)),ccBuild.ModuleOption.system);fs_extra_1.writeFileSync(o,t.code,"utf8");const p=enumerate_dependent_chunks_js_1.enumerateDependentChunks(n,i);o=a.filter(e=>!i.includes(e)),t=enumerate_dependent_chunks_js_1.enumerateDependentChunks(n,o);const l=new Set(enumerate_dependent_chunks_js_1.enumerateDependentChunks(n,s)),c={},u=e=>e in n.chunkAliases,_=e=>{var t;return null!=(t=n.chunkAliases[e])?t:e};t.forEach(e=>{var t,a;p.includes(e)?(t=e,a=_(t),l.add(a),t=u(t)?t:`../${path_1.basename(h.paths.engineDir)}/`+a,a="plugin:cocos/"+a,c[t]=a):(t=e,a=_(t),e=path_1.join(h.paths.engineDir,a),fs_extra_1.ensureDirSync(path_1.dirname(e)),fs_extra_1.copyFileSync(path_1.join(separate_engine_1.separateEnginPaths.cacheCocos,a),e),u(t)&&(c[t]=`../${path_1.basename(h.paths.engineDir)}/`+a))}),e.includes("physics-ammo")&&(c["wait-for-ammo-instantiation"]=`./${Build.Utils.relativeUrl(path_1.dirname(h.paths.importMap),h.paths.engineDir)}/wait-for-ammo-instantiation.js`),c.cc=`./${Build.Utils.relativeUrl(path_1.dirname(h.paths.importMap),h.paths.engineDir)}/cc.js`,h.importMap.imports=c;a=path_1.join(h.paths.dir,"cocos");yield separate_engine_1.generateCocos(Array.from(l),a)})}function sortSubPackage(e,t,a){for(const r of t.bundles){var i;r.isSubpackage&&(i=path_1.join(path_1.dirname(r.scriptDest),"game.js"),fs_extra_1.existsSync(r.scriptDest)?fs_extra_1.renameSync(r.scriptDest,i):fs_extra_1.outputFileSync(i,`console.log('${name}: no script in subPackage.')`,"utf8"),r.scriptDest=i)}}function readAllFilesDeep(e){if(!fs_extra_1.statSync(e).isDirectory())return[e];var t=[];for(const r of fs_1.readdirSync(e)){var a=path_1.join(e,r),i=readAllFilesDeep(a);i.length?t.push(...i):t.push(a)}return t}function _buildWeChatTemplate(c,u,e){var _;return __awaiter(this,void 0,void 0,function*(){var e=(yield Editor.Message.request("engine","query-info")).path;const a=path_1.join(e,"platforms/minigame");e=c.buildEngineParam.engineName;const i=path_1.join(u.paths.dir,"libs");fs_extra_1.ensureDirSync(i),console.debug(`start compile libs from ${a} to `+i);let t=yield globby(path_1.join(a,"common/**/*"),{nodir:!0});if(!t.length){if(!(t=readAllFilesDeep(path_1.join(a,"common"))).length)throw new Error(`生成 libs 文件失败: ${path_1.join(a,"common")} 文件夹文件缺失，请检查安装包或自定义引擎代码是否完整`);console.debug("globby 匹配 common 文件夹失败，已使用内置文件匹配方法")}console.debug(t),yield Promise.all(t.map(e=>{var t=compileJS(fs_extra_1.readFileSync(e,"utf8"),e),e=path_1.relative(a,e),e=path_1.join(i,e);fs_extra_1.outputFileSync(e,t,"utf8")})).catch(e=>{e.stack="BuildWechatLibTemplate error: "+e.stack,console.error(e)}),console.debug("Compile common adapter success!");let r=yield globby(path_1.join(a,"platforms/wechat/wrapper/**/*"),{nodir:!0});if(!r.length){if(!(r=readAllFilesDeep(path_1.join(a,"platforms/wechat/wrapper"))).length)throw new Error(`生成 libs 文件失败: ${path_1.join(a,"platforms/wechat/wrapper")} 文件夹下文件缺失，请检查安装包或自定义引擎代码是否完整`);console.debug("globby 匹配 platforms/wechat/wrapper 文件夹失败，已使用内置文件匹配方法")}console.debug(r),yield Promise.all(r.map(e=>{var t=compileJS(fs_extra_1.readFileSync(e,"utf8"),e),e=path_1.relative(path_1.join(a,"platforms/wechat/"),e),e=path_1.join(i,e);fs_extra_1.outputFileSync(e,t,"utf8")})).catch(e=>{e.stack="BuildWechatLibTemplate error: "+e.stack,console.error(e)}),console.debug("Compile wrapper adapter success!");var n=path_1.join(templateDir,"build-template");let s=path_1.join(Build.buildTemplateDir,c.platform,"game.ejs"),o=!0;if(fs_extra_1.existsSync(s)){var p=path_1.join(Build.buildTemplateDir,".wechatgame");try{fs_extra_1.readJSONSync(p).version!==Editor.App.version&&console.warn("The version of build-template is not equal to this editor, that may cause some error, please update your build template.")}catch(e){console.debug(e)}}else s=path_1.join(n,"game.ejs"),o=!1;var p=null==(_=u.settings.macros)?void 0:_.ENABLE_TRANSPARENT_CANVAS,l=null==(_=u.settings.macros)?void 0:_.ENABLE_WEBGL_ANTIALIAS,e={engineName:e,cocosTemplate:path_1.join(n,"cocos-script.ejs"),polyfillsBundleFile:u.paths.polyfillsJs&&Build.Utils.relativeUrl(u.paths.dir,u.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(u.paths.dir,u.paths.systemJs),importMapFile:Build.Utils.relativeUrl(u.paths.dir,u.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(u.paths.dir,u.paths.applicationJS),engineDir:Build.Utils.relativeUrl(u.paths.dir,u.paths.engineDir),alpha:void 0===p?"default":p,antialias:void 0===l?"default":l,useWebgl2:"sameAsProjectSetting"===c.packages.wechatgame.enabelWebGL2&&-1!==c.includeModules.indexOf("gfx-webgl2")},p=yield ejs_1.default.renderFile(s,e);fs_extra_1.writeFileSync(path_1.join(u.paths.dir,"game.js"),p,"utf8"),fs_extra_1.copyFileSync(path_1.join(n,"first-screen.js"),path_1.join(u.paths.dir,"first-screen.js")),fs_extra_1.copyFileSync(path_1.join(n,"splash.png"),path_1.join(u.paths.dir,"splash.png")),fs_extra_1.existsSync(userTemplateDir)&&(fs_extra_1.copySync(userTemplateDir,u.paths.dir),console.debug(`Use build-template {link(${userTemplateDir})}.`)),o&&fs_extra_1.removeSync(path_1.join(u.paths.dir,"game.ejs")),buildGameJson(n,u.paths.dir,c,u),buildProjectConfig(n,u.paths.dir,c)})}function buildProjectConfig(e,t,a){var i=a.packages.wechatgame,e=fs_extra_1.readJSONSync(path_1.join(e,"project.config.json")),i=(e.appid=i.appid||"wx6ac3f5090a6b99c5",e.projectname=a.name,path_1.join(userTemplateDir,"project.config.json")),i=(fs_extra_1.existsSync(i)&&(a=fs_extra_1.readJSONSync(i),Object.assign(e,a)),path_1.join(t,"project.config.json"));fs_extra_1.outputJSONSync(i,e)}function buildGameJson(t,e,a,i){var a=a.packages.wechatgame,r=fs_extra_1.readJSONSync(path_1.join(t,"game.json"));if(r.deviceOrientation=a.orientation,a.separateEngine){var t=path_1.join(t,"patch.json");let e=Editor.App.version;fs_extra_1.existsSync(t)&&(t=fs_extra_1.readJSONSync(t),e=t["plugin-version"]||Editor.App.version),r.plugins={cocos:{version:e,provider:require(path_1.join(__dirname,"../static/cocos/signature.json")).provider,path:"cocos"}}}a.buildOpenDataContextTemplate?r.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete r.openDataContext;var n=[];for(const s of i.bundles)s.isSubpackage&&n.push({name:s.name,root:`subpackages/${s.name}/`});0<n.length&&(r.subpackages=n);t=path_1.join(userTemplateDir,"game.json"),fs_extra_1.existsSync(t)&&(a=fs_extra_1.readJSONSync(t),Object.assign(r,a)),i=path_1.join(e,"game.json");fs_extra_1.outputJSONSync(i,r,{spaces:4})}function compileJS(e,t){let a;try{var i=require("@babel/core");a=i.transform(e,{ast:!1,highlightCode:!1,sourceMaps:!1,compact:!1,filename:t,presets:[require("@babel/preset-env")],plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")],[require("@babel/plugin-proposal-export-default-from")]]})}catch(e){throw e.stack=`Compile ${name} error: `+e.stack,e}return a.code}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;