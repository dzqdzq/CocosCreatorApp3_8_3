"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeBundleInit=exports.onAfterCopyBuildTemplate=exports.onBeforeCopyBuildTemplate=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),separate_engine_1=require("./separate-engine"),ccbuild_1=require("@cocos/ccbuild"),globby=require("globby"),path=require("path");async function onAfterInit(e,a,t){Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"taobao-mini-game",value:{orientation:e.packages["taobao-mini-game"].deviceOrientation}}),e.server&&!e.server.endsWith("/")&&(e.server+="/"),e.buildEngineParam.split=!0,e.assetSerializeOptions.exportCCON=!0;var i=e.packages["taobao-mini-game"];/\d*\.\d*\.\d*$/.test(Editor.App.version)||Editor.App.dev?(i.separateEngine&&e.debug&&console.warn(Editor.I18n.t("taobao-mini-game.tips.separate_engine_with_debug")),"builtin"===e.engineInfo.typescript.type?i.separateEngine=i.separateEngine&&!e.debug:console.warn(Editor.I18n.t("taobao-mini-game.tips.separate_engine_with_custom_engine"))):console.warn(Editor.I18n.t("taobao-mini-game.tips.separate_engine_only_in_normal_version")),Object.assign(e.buildEngineParam,{sourceMaps:!i.separateEngine&&e.sourceMaps,skip:i.separateEngine}),a.staticsInfo.B100012=e.server,a.staticsInfo.B100011=e.packages["taobao-mini-game"].deviceOrientation,e.buildScriptParam.flags.WASM_SUBPACKAGE=i.wasmSubpackage&&!i.separateEngine}async function onBeforeCompressSettings(e,a,t){a.settings.screen.orientation=e.packages["taobao-mini-game"].deviceOrientation,a.settings.scripting.scriptPackages=a.scriptPackages.map(e=>"project://"+(0,path_1.relative)(a.paths.dir,e).replace(/\\/g,"/"))}async function onBeforeCopyBuildTemplate(e,t,a){var i=e.engineInfo.typescript.path;const n=(0,path_1.join)(i,"templates/taobao-mini-game");for(const o of["web-adapter","engine-adapter"])await(0,fs_extra_1.copy)((0,path_1.join)(i,"bin/adapter/minigame/taobao-mini-game",`${o}.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,o+".js"));var s=this.buildTemplate.initUrl("game.ejs")||(0,path_1.join)(n,"game.ejs"),r={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},s=await ejs_1.default.renderFile(s,r);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,"game.js"),s),e.md5CacheOptions.replaceOnly.push((0,path_1.join)(t.paths.dir,"game.js")),(await globby(["**/*","!build-template.json","!$'mini.project.json'}","!game.json","!**/*.ejs"],{cwd:n})).map(e=>path.resolve(n,e)).forEach(e=>{var a;(0,fs_extra_1.statSync)(e).isFile()&&(a=(0,path_1.relative)(n,e),e=(0,fs_extra_1.readFileSync)(e,"utf8"),(0,fs_extra_1.outputFileSync)((0,path_1.join)(t.paths.dir,a),e,{encoding:"utf8"}))})}async function onAfterCopyBuildTemplate(o,p){var e=o.engineInfo.typescript.path;const l=(0,path_1.join)(e,"templates/taobao-mini-game");["mini.project.json","game.json"].forEach(async e=>{var a=this.buildTemplate.findFile(e),a=(0,fs_extra_1.readJSONSync)(a||(0,path_1.join)(l,e));if("game.json"===e){var t=o.packages["taobao-mini-game"];if(t.separateEngine){var i=(0,path_1.join)(l,"patch.json");let e=Editor.App.version;(0,fs_extra_1.existsSync)(i)&&(e=await Editor.Profile.getConfig("utils",Editor.App.version.replace(".","_")+"_plugin-version.taobao-mini-game")||await Editor.Profile.getConfig("taobao-mini-game","plugin-version")),a.plugins={cocos:{pluginVersion:e,pluginId:require((0,path_1.join)(__dirname,"../static/cocos/signature.json")).pluginId,path:"cocos"}}}a.deviceOrientation=o.packages["taobao-mini-game"].deviceOrientation;var n,s=[];for(const r of this.bundleManager.bundles)r.isSubpackage&&(n=(0,path_1.join)((0,path_1.dirname)(r.scriptDest),"game.js"),(0,fs_extra_1.existsSync)(r.scriptDest)?(0,fs_extra_1.renameSync)(r.scriptDest,n):(0,fs_extra_1.outputFileSync)(n,`console.log('${name}: no script in subPackage.')`,"utf8"),r.scriptDest=n,s.push({name:r.name,root:`subpackages/${r.name}/`}));t.wasmSubpackage&&!t.separateEngine&&(i=(0,path_1.join)(p.paths.engineDir,"./assets/"),t=(0,path_1.join)(p.paths.engineDir,"./chunks/"),(0,fs_extra_1.existsSync)(i)&&s.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"}),(0,fs_extra_1.existsSync)(t))&&s.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"}),0<s.length&&(a.subpackages=s)}i=(0,path_1.join)(p.paths.dir,e);(0,fs_extra_1.writeJSONSync)(i,a),o.md5CacheOptions.excludes.push(i)})}function onBeforeBundleInit(e){e.polyfills&&(e.polyfills.asyncFunctions=!1),e.moveRemoteBundleScript=!0,e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.buildScriptParam.platform="TAOBAO_MINIGAME",e.assetSerializeOptions.exportCCON=!0}async function onAfterBuild(e,a,t){e.packages["taobao-mini-game"].separateEngine&&(await buildSeparateEngine(e,a),Build.ScriptBuilder.outputImportMap(a.importMap,{dest:a.paths.importMap,importMapFormat:e.buildScriptParam.importMapFormat,debug:e.debug})),await postHandleScript(e,a,t)}async function postHandleScript(e,n,a){const s=e.debug?"\n":"";let r=`var window = $global, global = $global, globalThis = $global;${s}const self = $global;`+s;["__globalAdapter","cc","canvas","localStorage","System","document","requestAnimationFrame","cancelAnimationFrame","XMLHttpRequest","performance","DOMParser","HTMLElement","HTMLImageElement","HTMLCanvasElement","Image","ImageBitmap","WebSocket"].forEach(e=>{r+=`var ${e} = window.${e};`+s});let o=r;e=e.packages["taobao-mini-game"].globalVariable,e&&e.split(",").map(e=>e.trim()).forEach(e=>{o+=`var ${e} = window.${e};`+s}),e=["game.js","**/system.bundle*.js","**/polyfills.bundle*.js","**/import-map*.js","src/assets/**/*.js"];const t=n.paths.dir;var i=await globby(["**/*.js",...e.map(e=>"!"+e)],{cwd:t});const p=/System\.register\((\[.*?\].*?\{)/g,l=/System\.register\((.*?,\s*?\[.*?\].*?\{)/g;i.map(e=>path.resolve(t,e)).forEach(e=>{var a=(0,path_1.relative)(n.paths.dir,e).replace(/\\/g,"/");let t=(0,fs_extra_1.readFileSync)(e,"utf8"),i=o;(a.startsWith("cocos/")||a.startsWith("cocos-js/"))&&(i=r);a=p.test(t);t=a?t.replace(p,"$global.System.register($1"+s+i):l.test(t)?t.replace(l,"$global.System.register($1"+s+i):i+t,(0,fs_extra_1.writeFileSync)(e,t,"utf8")});(await globby(e,{cwd:t})).map(e=>path.resolve(t,e)).forEach(e=>{var a=(0,fs_extra_1.readFileSync)(e,"utf8"),a=o+a;(0,fs_extra_1.writeFileSync)(e,a,"utf8")});i=["(function () {",'if (typeof $global !== "object") return;','const globalFuncMap = {"Int8Array": Int8Array, "Uint8Array": Uint8Array, "Int16Array": Int16Array, "Uint16Array": Uint16Array, "Int32Array": Int32Array, "Uint32Array": Uint32Array, "Float32Array": Float32Array, "Float64Array": Float64Array};',"Object.keys(globalFuncMap).forEach((funcName)=>{","$global[funcName] = globalFuncMap[funcName];","});","})();"].join(s),e=(0,path_1.join)(n.paths.dir,"game.js"),i+=(0,fs_extra_1.readFileSync)(e,"utf8");(0,fs_extra_1.writeFileSync)(e,i,"utf8");const c=(await globby(["cocos-js/base*.js"],{cwd:t})).map(e=>path.resolve(t,e));e=(await globby(["cocos-js/physics-ammo*.js","cocos-js/physics-cannon*.js","cocos-js/physics-framework*.js","cocos-js/physics-builtin*.js"],{cwd:t})).map(e=>path.resolve(t,e));1===c.length&&e.forEach(a=>{var t=c[0].replace(/\\/g,"/").lastIndexOf("/");if(-1!==t){t=c[0].substring(t+1);let e=(0,fs_extra_1.readFileSync)(a,"utf8");e=e.replace(/base.js/,t),(0,fs_extra_1.writeFileSync)(a,e,"utf8")}})}async function buildSeparateEngine(e,i){(0,fs_extra_1.ensureDirSync)(i.paths.engineDir),await(0,separate_engine_1.buildCocos)(!Editor.App.dev);var e=e.buildEngineParam.includeModules,a=await ccbuild_1.StatsQuery.create(separate_engine_1.separateEnginPaths.internalEngine),t=a.getUnitsOfFeatures(e);const n=(0,separate_engine_1.getPluginFeatures)(),s=a.getUnitsOfFeatures(n);var r=t.filter(e=>!n.includes(e));const o=(0,fs_extra_1.readJSONSync)((0,path_1.join)(separate_engine_1.separateEnginPaths.outDir,"meta.json"));var p=(0,path_1.join)(i.paths.engineDir,"cc.js"),a=await ccbuild_1.buildEngine.transform(a.evaluateIndexModuleSource(t,e=>s.includes(e)?`plugin:cocos/${e}.js`:`./${e}.js`),"system"),t=((0,fs_extra_1.writeFileSync)(p,a.code,"utf8"),ccbuild_1.buildEngine.enumerateDependentChunks(o,r));const l=ccbuild_1.buildEngine.enumerateDependentChunks(o,s);p=ccbuild_1.buildEngine.enumerateDependentAssets(o,r).concat(ccbuild_1.buildEngine.enumerateDependentAssets(o,s));const c=null!=(a=i.importMap.imports)?a:{},u=e=>e in o.chunkAliases,m=e=>{var a;return null!=(a=o.chunkAliases[e])?a:e},g=e=>{var a=m(e),t=(0,path_1.join)(i.paths.engineDir,a);(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(t)),(0,fs_extra_1.copyFileSync)((0,path_1.join)(separate_engine_1.separateEnginPaths.cacheCocos,a),t),u(e)&&(c[e]=`../${(0,path_1.basename)(i.paths.engineDir)}/`+a)};t.forEach(e=>{var a,t;l.includes(e)?(a=e,t=m(a),a=u(a)?a:`../${(0,path_1.basename)(i.paths.engineDir)}/`+t,t="plugin:cocos/"+t,c[a]=t):g(e)}),p.forEach(e=>{g(e)}),c.cc=`./${Build.Utils.relativeUrl((0,path_1.dirname)(i.paths.importMap),i.paths.engineDir)}/cc.js`,e.includes("physics-ammo")&&(c["wait-for-ammo-instantiation"]=`./${Build.Utils.relativeUrl((0,path_1.dirname)(i.paths.importMap),i.paths.engineDir)}/wait-for-ammo-instantiation.js`),i.importMap.imports=c;r=(0,path_1.join)(i.paths.dir,"cocos");await(0,separate_engine_1.generateCocos)(l,r)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterCopyBuildTemplate=onAfterCopyBuildTemplate,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBuild=onAfterBuild;