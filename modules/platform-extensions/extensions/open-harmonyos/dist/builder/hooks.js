"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path");async function generateOptions(e){var e=e.packages["open-harmonyos"],t=(e.orientation=e.orientation||{},await Editor.Message.request("program","query-program-info","ohosSDK")),r=await Editor.Message.request("program","query-program-info","ohosNDK");if(e.sdkPath=t?t.path:"",e.ndkPath=r?r.path:"",e.sdkPath&&e.ndkPath)return{packageName:e.packageName||"",orientation:{landscapeRight:null==(t=e.orientation.landscapeRight)||t,landscapeLeft:null==(r=e.orientation.landscapeLeft)||r,portrait:null!=(t=e.orientation.portrait)&&t,upsideDown:null!=(r=e.orientation.upsideDown)&&r},apiLevel:e.apiLevel||"7",sdkPath:e.sdkPath||"",ndkPath:e.ndkPath||"",renderBackEnd:{gles3:null==(r=null==(t=e.renderBackEnd)?void 0:t.gles3)||r}};throw new Error(Editor.I18n.t("ohos.tips.ohos_sdk_error"))}async function onAfterInit(e,t,r){fs_extra_1.emptyDirSync(t.paths.dir);var a=await generateOptions(e),n=(e.packages["open-harmonyos"]=a).renderBackEnd,n=(e.assetSerializeOptions["cc.EffectAsset"].glsl3=null==(n=n.gles3)||n,{packageName:a.packageName,orientation:a.orientation});r.__addStaticsInfo(n),e.assetSerializeOptions.exportCCON=!0,e.assetSerializeOptions.allowCCONExtension=!0,Object.assign(e.buildEngineParam,{platform:"NATIVE",engineName:"src/cocos-js"});let i;var a=(await Editor.Message.request("engine","query-engine-info"))["native"]["path"],r=await getBrowserslistQuery(a);(i=r?r:i)&&(e.buildEngineParam.targets=i,e.buildScriptParam.targets=i),e.buildScriptParam.system={preset:"commonjs-like"},await fs_extra_1.emptyDirSync(t.paths.dir)}async function getBrowserslistQuery(e){e=path_1.join(e,".browserslistrc");let t;try{t=await fs_extra_1.readFile(e,"utf8")}catch(e){return}e=function(e){var t=[];for(const a of e.split("\n")){var r=a.indexOf("#"),r=(r<0?a:a.substr(0,r)).trim();0!==r.length&&t.push(r)}return t}(t);if(0!==e.length)return e.join(" or ")}exports.throwError=!0,exports.onAfterInit=onAfterInit;