"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.make=exports.onAfterBuild=exports.onAfterCompressSettings=exports.onAfterBundleDataTask=exports.onAfterBundleInit=exports.onAfterInit=exports.onBeforeBuild=exports.throwError=void 0;const os_1=__importDefault(require("os")),ejs_1=__importDefault(require("ejs")),path_1=require("path"),fs_extra_1=require("fs-extra"),native_utils_1=require("./native-utils");function fixPath(e){return"win32"===os_1.default.platform()?e.replace(/\\/g,"/").replace(/\/+/,"/"):e}async function getCmakePath(){var e=await Editor.Message.request("program","query-program-info","cmake"),e=e?e.path:"";return e||(e=(0,path_1.join)(Editor.App.path,"../tools/cmake"),"win32"===process.platform?(0,path_1.join)(e,"bin/cmake.exe"):(0,path_1.join)(e,"bin/cmake"))}async function genCocosParams(t,e){var a=t.name,i=t.engineInfo,r=t.packages,n=await Editor.Profile.getProject("engine","macroConfig");const s={buildDir:(0,path_1.dirname)(e.paths.dir),buildAssetsDir:e.paths.dir,projDir:Editor.Project.path,cmakePath:await getCmakePath(),nativeEnginePath:i.native.path,enginePath:i.typescript.path,projectName:a,debug:t.debug,encrypted:t.packages.native.encrypted,xxteaKey:t.packages.native.xxteaKey,compressZip:t.packages.native.compressZip,cMakeConfig:{APP_NAME:`set(APP_NAME "${a}")`,COCOS_X_PATH:`set(COCOS_X_PATH "${fixPath(i.native.path)}")`,USE_JOB_SYSTEM_TASKFLOW:"taskFlow"===r.native.JobSystem,USE_JOB_SYSTEM_TBB:"tbb"===r.native.JobSystem,ENABLE_FLOAT_OUTPUT:n.ENABLE_FLOAT_OUTPUT},platformParams:{},platform:t.platform,packageName:t.packages[t.platform]&&t.packages[t.platform].packageName||""},o=(t.debug&&s.encrypted&&(console.warn(Editor.I18n.t("native.encrypt.disable_tips")),s.encrypted=!1),"custom"===i.native.type&&(s.cMakeConfig.BUILTIN_COCOS_X_PATH=`set(BUILTIN_COCOS_X_PATH "${fixPath(i.native.builtin)}")`),await Editor.Profile.getConfig("engine","modules.moduleConfig","default"));return Object.keys(o).forEach(e=>{o[e].native&&(s.cMakeConfig[o[e].native]=`set(${o[e].native} ${t.includeModules.includes(e)?"ON":"OFF"})`)}),(0,fs_extra_1.existsSync)(s.buildDir)||await(0,fs_extra_1.mkdir)(s.buildDir),s}async function getBrowserslistQuery(e){e=(0,path_1.join)(e,".browserslistrc");let t;try{t=await(0,fs_extra_1.readFile)(e,"utf8")}catch(e){return}e=function(e){var t=[];for(const i of e.split("\n")){var a=i.indexOf("#"),a=(a<0?i:i.substr(0,a)).trim();0!==a.length&&t.push(a)}return t}(t);if(0!==e.length)return e.join(" or ")}function onBeforeBuild(e){e.useCache=!0}async function onAfterInit(e,t){if(!(0,native_utils_1.checkName)(e.name,e))throw a=(0,native_utils_1.acceptChineseName)(e),a=Editor.I18n.t(a?"native.options.nameErrorTips":"native.options.nameErrorTips_non_chinese"),new Error(a);e.server&&!e.server.endsWith("/")&&(e.server+="/");var{native:{path:a},typescript:{path:i}}=e.engineInfo,i=(native_utils_1.packToolHandler.init(i),console.debug("Native engine root:"+a),Object.assign(e.buildEngineParam,{engineName:"src/cocos-js"}),(0,path_1.join)(t.paths.dir,"assets")),a=(t.paths.dir=(0,path_1.join)(t.paths.dir,"data"),t.paths.dir);"normal"===e.buildMode&&await(0,fs_extra_1.emptyDirSync)(a);try{(0,fs_extra_1.existsSync)(i)||(0,fs_extra_1.symlinkSync)(a,i,"junction")}catch(e){console.error("Failed to create symbolic link "+i),console.error(e)}var r=await genCocosParams(e,t);t.compileOptions=r,await(0,fs_extra_1.outputJSON)(t.paths.compileConfig,r);for(const n of["web-adapter","engine-adapter"])await(0,fs_extra_1.copy)((0,path_1.join)(r.enginePath,"bin/adapter/native",`${n}.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"jsb-adapter",n+".js"))}async function onAfterBundleInit(t){var e=(t.engineInfo||await Editor.Message.request("engine","query-engine-info"))["native"]["path"];for(let e=0;e<t.includeModules.length;e++){var a=t.includeModules[e];["gfx-webgl2","gfx-webgl"].includes(a)&&(t.includeModules.splice(e,1),e--)}t.buildScriptParam.hotModuleReload=t.packages.native.hotModuleReload,t.buildScriptParam.platform="NATIVE",t.polyfills&&(t.polyfills.asyncFunctions=!1),t.assetSerializeOptions.exportCCON=!0;let i;e=await getBrowserslistQuery(e);(i=e?e:i)&&(t.buildScriptParam.targets=i,t.buildScriptParam.polyfills||(t.buildScriptParam.polyfills={}),t.buildScriptParam.polyfills.targets=i,"asyncFunctions"in t.buildScriptParam.polyfills)&&delete t.buildScriptParam.polyfills.asyncFunctions,t.buildScriptParam.system={preset:"commonjs-like"}}async function onAfterBundleDataTask(e,t,a){for(const i of t)i.configOutPutName="cc.config"}async function onAfterCompressSettings(e,t){var a=(0,path_1.join)(e.engineInfo.typescript.path,"templates/native"),i={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},a=this.buildTemplate.initUrl("index.ejs")||(0,path_1.join)(a,"index.ejs"),a=(await ejs_1.default.renderFile(a,i)).toString(),i=(await(0,fs_extra_1.writeFile)((0,path_1.join)(t.paths.dir,"main.js"),a,"utf8"),e.md5CacheOptions.replaceOnly.push((0,path_1.join)(t.paths.dir,"main.js")),await native_utils_1.packToolHandler.runTask("create",t.compileOptions),e.server||""),a=(0,path_1.resolve)(t.paths.dir,"../remote");if((0,fs_extra_1.removeSync)(a),i&&(0,fs_extra_1.existsSync)(t.paths.remote))try{(0,fs_extra_1.moveSync)(t.paths.remote,a),t.paths.remote=a}catch(e){console.error(e)}}async function onAfterBuild(e,t){await native_utils_1.packToolHandler.runTask("generate",t.compileOptions)}async function make(e,t){await native_utils_1.packToolHandler.runTask("make",t)}async function run(e,t){await native_utils_1.packToolHandler.runTask("run",t)}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;var[a,i]=[e.split("."),t.split(".")],r=Math.max(a.length,i.length);for(let e=0;e<r;e++)if(parseInt(a[e])>parseInt(i[e]))return!0;return!1}exports.throwError=!0,exports.onBeforeBuild=onBeforeBuild,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onAfterBundleDataTask=onAfterBundleDataTask,exports.onAfterCompressSettings=onAfterCompressSettings,exports.onAfterBuild=onAfterBuild,exports.make=make,exports.run=run;