var util=require("util"),f=util.format,EventEmitter=require("events").EventEmitter,path=require("path"),uuid=require("uuid"),fork=require("child_process").fork,pbxWriter=require("./pbxWriter"),pbxFile=require("./pbxFile"),fs=require("fs"),parser=require("./parser/pbxproj"),plist=require("simple-plist"),COMMENT_KEY=/_comment$/;function pbxProject(e){if(!(this instanceof pbxProject))return new pbxProject(e);this.filepath=path.resolve(e)}function pbxBuildFileObj(e){var t=Object.create(null);return t.isa="PBXBuildFile",t.fileRef=e.fileRef,t.fileRef_comment=e.basename,e.settings&&(t.settings=e.settings),t}function pbxFileReferenceObj(e){return{isa:"PBXFileReference",name:'"'+e.basename+'"',path:'"'+e.path.replace(/\\/g,"/")+'"',sourceTree:e.sourceTree,fileEncoding:e.fileEncoding,lastKnownFileType:e.lastKnownFileType,explicitFileType:e.explicitFileType,includeInIndex:e.includeInIndex}}function pbxGroupChild(e){var t=Object.create(null);return t.value=e.fileRef,t.comment=e.basename,t}function pbxBuildPhaseObj(e){var t=Object.create(null);return t.value=e.uuid,t.comment=longComment(e),t}function pbxCopyFilesBuildPhaseObj(e,t,r,i){return e.name='"'+i+'"',e.dstPath=r||'""',e.dstSubfolderSpec={absolute_path:0,executables:6,frameworks:10,java_resources:15,plugins:13,products_directory:16,resources:7,shared_frameworks:11,shared_support:12,wrapper:1,xpc_services:0}[{application:"wrapper",app_extension:"plugins",bundle:"wrapper",command_line_tool:"wrapper",dynamic_library:"products_directory",framework:"shared_frameworks",frameworks:"frameworks",static_library:"products_directory",unit_test_bundle:"wrapper",watch_app:"wrapper",watch2_app:"products_directory",watch_extension:"plugins",watch2_extension:"plugins"}[t]],e}function pbxShellScriptBuildPhaseObj(e,t,r){return e.name='"'+r+'"',e.inputPaths=t.inputPaths||[],e.outputPaths=t.outputPaths||[],e.shellPath=t.shellPath,e.shellScript='"'+t.shellScript.replace(/"/g,'\\"')+'"',e}function pbxBuildFileComment(e){return longComment(e)}function pbxFileReferenceComment(e){return e.basename||path.basename(e.path)}function pbxNativeTargetComment(e){return e.name}function longComment(e){return f("%s in %s",e.basename,e.group)}function correctForPluginsPath(e,t){return correctForPath(e,t,"Plugins")}function correctForResourcesPath(e,t){return correctForPath(e,t,"Resources")}function correctForFrameworksPath(e,t){return correctForPath(e,t,"Frameworks")}function correctForPath(e,t,r){var i=new RegExp("^"+r+"[\\\\/]");return t.pbxGroupByName(r).path&&(e.path=e.path.replace(i,"")),e}function searchPathForFile(e,t){var r=t.pbxGroupByName("Plugins"),r=r?r.path:null,i="."==(i=path.dirname(e.path))?"":"/"+i;return e.plugin&&r?'"\\"$(SRCROOT)/'+unquote(r)+'\\""':e.customFramework&&e.dirname?'"\\"'+e.dirname+'\\""':'"\\"$(SRCROOT)/'+t.productName+i+'\\""'}function nonComments(e){for(var t=Object.keys(e),r={},i=0;i<t.length;i++)COMMENT_KEY.test(t[i])||(r[t[i]]=e[t[i]]);return r}function unquote(e){if(e)return e.replace(/^"(.*)"$/,"$1")}function buildPhaseNameForIsa(e){return(BUILDPHASENAME_BY_ISA={PBXCopyFilesBuildPhase:"Copy Files",PBXResourcesBuildPhase:"Resources",PBXSourcesBuildPhase:"Sources",PBXFrameworksBuildPhase:"Frameworks"})[e]}function producttypeForTargettype(e){return(PRODUCTTYPE_BY_TARGETTYPE={application:"com.apple.product-type.application",app_extension:"com.apple.product-type.app-extension",bundle:"com.apple.product-type.bundle",command_line_tool:"com.apple.product-type.tool",dynamic_library:"com.apple.product-type.library.dynamic",framework:"com.apple.product-type.framework",static_library:"com.apple.product-type.library.static",unit_test_bundle:"com.apple.product-type.bundle.unit-test",watch_app:"com.apple.product-type.application.watchapp",watch2_app:"com.apple.product-type.application.watchapp2",watch_extension:"com.apple.product-type.watchkit-extension",watch2_extension:"com.apple.product-type.watchkit2-extension"})[e]}function filetypeForProducttype(e){return(FILETYPE_BY_PRODUCTTYPE={"com.apple.product-type.application":'"wrapper.application"',"com.apple.product-type.app-extension":'"wrapper.app-extension"',"com.apple.product-type.bundle":'"wrapper.plug-in"',"com.apple.product-type.tool":'"compiled.mach-o.dylib"',"com.apple.product-type.library.dynamic":'"compiled.mach-o.dylib"',"com.apple.product-type.framework":'"wrapper.framework"',"com.apple.product-type.library.static":'"archive.ar"',"com.apple.product-type.bundle.unit-test":'"wrapper.cfbundle"',"com.apple.product-type.application.watchapp":'"wrapper.application"',"com.apple.product-type.application.watchapp2":'"wrapper.application"',"com.apple.product-type.watchkit-extension":'"wrapper.app-extension"',"com.apple.product-type.watchkit2-extension":'"wrapper.app-extension"'})[e]}util.inherits(pbxProject,EventEmitter),pbxProject.prototype.parse=function(e){return fork(__dirname+"/parseJob.js",[this.filepath]).on("message",function(e){"SyntaxError"==e.name||e.code?this.emit("error",e):(this.hash=e,this.emit("end",null,e))}.bind(this)),e&&(this.on("error",e),this.on("end",e)),this},pbxProject.prototype.parseSync=function(){var e=fs.readFileSync(this.filepath,"utf-8");return this.hash=parser.parse(e),this},pbxProject.prototype.writeSync=function(e){return this.writer=new pbxWriter(this.hash,e),this.writer.writeSync()},pbxProject.prototype.allUuids=function(){var e,t=this.hash.project.objects,r=[];for(key in t)e=t[key],r=r.concat(Object.keys(e));return r=r.filter(function(e){return!COMMENT_KEY.test(e)&&24==e.length})},pbxProject.prototype.generateUuid=function(){var e=uuid.v4().replace(/-/g,"").substr(0,24).toUpperCase();return 0<=this.allUuids().indexOf(e)?this.generateUuid():e},pbxProject.prototype.addPluginFile=function(e,t){e=new pbxFile(e,t);return e.plugin=!0,correctForPluginsPath(e,this),this.hasFile(e.path)?null:(e.fileRef=this.generateUuid(),this.addToPbxFileReferenceSection(e),this.addToPluginsPbxGroup(e),e)},pbxProject.prototype.removePluginFile=function(e,t){e=new pbxFile(e,t);return correctForPluginsPath(e,this),this.removeFromPbxFileReferenceSection(e),this.removeFromPluginsPbxGroup(e),e},pbxProject.prototype.addProductFile=function(e,t){e=new pbxFile(e,t);return e.includeInIndex=0,e.fileRef=this.generateUuid(),e.target=t?t.target:void 0,e.group=t?t.group:void 0,e.uuid=this.generateUuid(),e.path=e.basename,this.addToPbxFileReferenceSection(e),this.addToProductsPbxGroup(e),e},pbxProject.prototype.removeProductFile=function(e,t){e=new pbxFile(e,t);return this.removeFromProductsPbxGroup(e),e},pbxProject.prototype.addSourceFile=function(e,t,r){r=r?this.addFile(e,r,t):this.addPluginFile(e,t);return!!r&&(r.target=t?t.target:void 0,r.uuid=this.generateUuid(),this.addToPbxBuildFileSection(r),this.addToPbxSourcesBuildPhase(r),r)},pbxProject.prototype.removeSourceFile=function(e,t,r){r=r?this.removeFile(e,r,t):this.removePluginFile(e,t);return r.target=t?t.target:void 0,this.removeFromPbxBuildFileSection(r),this.removeFromPbxSourcesBuildPhase(r),r},pbxProject.prototype.addHeaderFile=function(e,t,r){return r?this.addFile(e,r,t):this.addPluginFile(e,t)},pbxProject.prototype.removeHeaderFile=function(e,t,r){return r?this.removeFile(e,r,t):this.removePluginFile(e,t)},pbxProject.prototype.addResourceFile=function(e,t,r){var i;if((t=t||{}).plugin){if(!(i=this.addPluginFile(e,t)))return!1}else if(i=new pbxFile(e,t),this.hasFile(i.path))return!1;return i.uuid=this.generateUuid(),i.target=t?t.target:void 0,t.plugin||(correctForResourcesPath(i,this),i.fileRef=this.generateUuid()),t.variantGroup||(this.addToPbxBuildFileSection(i),this.addToPbxResourcesBuildPhase(i)),t.plugin||(this.addToPbxFileReferenceSection(i),r?this.getPBXGroupByKey(r)?this.addToPbxGroup(i,r):this.getPBXVariantGroupByKey(r)&&this.addToPbxVariantGroup(i,r):this.addToResourcesPbxGroup(i)),i},pbxProject.prototype.removeResourceFile=function(e,t,r){e=new pbxFile(e,t);return e.target=t?t.target:void 0,correctForResourcesPath(e,this),this.removeFromPbxBuildFileSection(e),this.removeFromPbxFileReferenceSection(e),r?this.getPBXGroupByKey(r)?this.removeFromPbxGroup(e,r):this.getPBXVariantGroupByKey(r)&&this.removeFromPbxVariantGroup(e,r):this.removeFromResourcesPbxGroup(e),this.removeFromPbxResourcesBuildPhase(e),e},pbxProject.prototype.addFramework=function(e,t){var r=t&&1==t.customFramework,i=!t||null==t.link||t.link,o=t&&t.embed,n=(t&&delete t.embed,new pbxFile(e,t));if(n.uuid=this.generateUuid(),n.fileRef=this.generateUuid(),n.target=t?t.target:void 0,this.hasFile(n.path))return!1;if((this.addToPbxBuildFileSection(n),this.addToPbxFileReferenceSection(n),this.addToFrameworksPbxGroup(n),i&&this.addToPbxFrameworksBuildPhase(n),r)&&(this.addToFrameworkSearchPaths(n),o))return t.embed=o,(i=new pbxFile(e,t)).uuid=this.generateUuid(),i.fileRef=n.fileRef,this.addToPbxBuildFileSection(i),this.addToPbxEmbedFrameworksBuildPhase(i),i;return n},pbxProject.prototype.removeFramework=function(e,t){t&&t.embed;t&&delete t.embed;var r=new pbxFile(e,t),e=(r.target=t?t.target:void 0,this.removeFromPbxBuildFileSection(r),this.removeFromPbxFileReferenceSection(r),this.removeFromFrameworksPbxGroup(r),this.removeFromPbxFrameworksBuildPhase(r),t&&t.customFramework&&this.removeFromFrameworkSearchPaths(r),(t=t||{}).embed=!0,new pbxFile(e,t));return e.fileRef=r.fileRef,this.removeFromPbxBuildFileSection(e),this.removeFromPbxEmbedFrameworksBuildPhase(e),r},pbxProject.prototype.addCopyfile=function(e,t){e=new pbxFile(e,t);return(e=this.hasFile(e.path)?this.hasFile(e.path):e).fileRef=e.uuid=this.generateUuid(),e.target=t?t.target:void 0,this.addToPbxBuildFileSection(e),this.addToPbxFileReferenceSection(e),this.addToPbxCopyfilesBuildPhase(e),e},pbxProject.prototype.pbxCopyfilesBuildPhaseObj=function(e){return this.buildPhaseObject("PBXCopyFilesBuildPhase","Copy Files",e)},pbxProject.prototype.addToPbxCopyfilesBuildPhase=function(e){this.buildPhaseObject("PBXCopyFilesBuildPhase","Copy Files",e.target).files.push(pbxBuildPhaseObj(e))},pbxProject.prototype.removeCopyfile=function(e,t){e=new pbxFile(e,t);return e.target=t?t.target:void 0,this.removeFromPbxBuildFileSection(e),this.removeFromPbxFileReferenceSection(e),this.removeFromPbxCopyfilesBuildPhase(e),e},pbxProject.prototype.removeFromPbxCopyfilesBuildPhase=function(e){var t=this.pbxCopyfilesBuildPhaseObj(e.target);for(i in t.files)if(t.files[i].comment==longComment(e)){t.files.splice(i,1);break}},pbxProject.prototype.addStaticLibrary=function(e,t){var r;if((t=t||{}).plugin){if(!(r=this.addPluginFile(e,t)))return!1}else if(r=new pbxFile(e,t),this.hasFile(r.path))return!1;return r.uuid=this.generateUuid(),r.target=t?t.target:void 0,t.plugin||(r.fileRef=this.generateUuid(),this.addToPbxFileReferenceSection(r)),this.addToPbxBuildFileSection(r),this.addToPbxFrameworksBuildPhase(r),this.addToLibrarySearchPaths(r),r},pbxProject.prototype.addToPbxBuildFileSection=function(e){var t=f("%s_comment",e.uuid);this.pbxBuildFileSection()[e.uuid]=pbxBuildFileObj(e),this.pbxBuildFileSection()[t]=pbxBuildFileComment(e)},pbxProject.prototype.removeFromPbxBuildFileSection=function(e){var t,r;for(t in this.pbxBuildFileSection())this.pbxBuildFileSection()[t].fileRef_comment==e.basename&&(e.uuid=t,delete this.pbxBuildFileSection()[t],r=f("%s_comment",t),delete this.pbxBuildFileSection()[r])},pbxProject.prototype.addPbxGroup=function(e,t,r,i){var o,n,p=this.hash.project.objects.PBXGroup,a=this.generateUuid(),u=f("%s_comment",a),s={isa:"PBXGroup",children:[],name:t,path:r,sourceTree:i||'"<group>"'},c=this.pbxFileReferenceSection(),h={};for(o in c)COMMENT_KEY.test(o)&&(h[c[n=o.split(COMMENT_KEY)[0]].path]={fileRef:n,basename:c[o]});for(var l=0;l<e.length;l++){var d=e[l],b='"'+d+'"';h[d]?s.children.push(pbxGroupChild(h[d])):h[b]?s.children.push(pbxGroupChild(h[b])):((b=new pbxFile(d)).uuid=this.generateUuid(),b.fileRef=this.generateUuid(),this.addToPbxFileReferenceSection(b),this.addToPbxBuildFileSection(b),s.children.push(pbxGroupChild(b)))}return p&&(p[a]=s,p[u]=t),{uuid:a,pbxGroup:s}},pbxProject.prototype.removePbxGroup=function(e){var t,r=this.hash.project.objects.PBXGroup;for(t in r)COMMENT_KEY.test(t)&&r[t]==e&&delete r[t.split(COMMENT_KEY)[0]]},pbxProject.prototype.addToPbxProjectSection=function(e){e={value:e.uuid,comment:pbxNativeTargetComment(e.pbxNativeTarget)};this.pbxProjectSection()[this.getFirstProject().uuid].targets.push(e)},pbxProject.prototype.addToPbxNativeTargetSection=function(e){var t=f("%s_comment",e.uuid);this.pbxNativeTargetSection()[e.uuid]=e.pbxNativeTarget,this.pbxNativeTargetSection()[t]=e.pbxNativeTarget.name},pbxProject.prototype.addToPbxFileReferenceSection=function(e){var t=f("%s_comment",e.fileRef);this.pbxFileReferenceSection()[e.fileRef]=pbxFileReferenceObj(e),this.pbxFileReferenceSection()[t]=pbxFileReferenceComment(e)},pbxProject.prototype.removeFromPbxFileReferenceSection=function(e){var t,r=pbxFileReferenceObj(e);for(t in this.pbxFileReferenceSection())if(this.pbxFileReferenceSection()[t].name==r.name||'"'+this.pbxFileReferenceSection()[t].name+'"'==r.name||this.pbxFileReferenceSection()[t].path==r.path||'"'+this.pbxFileReferenceSection()[t].path+'"'==r.path){e.fileRef=e.uuid=t,delete this.pbxFileReferenceSection()[t];break}var i=f("%s_comment",e.fileRef);return null!=this.pbxFileReferenceSection()[i]&&delete this.pbxFileReferenceSection()[i],e},pbxProject.prototype.addToXcVersionGroupSection=function(e){if(!e.models||!e.currentModel)throw new Error("Cannot create a XCVersionGroup section from not a data model document file");var t=f("%s_comment",e.fileRef);this.xcVersionGroupSection()[e.fileRef]||(this.xcVersionGroupSection()[e.fileRef]={isa:"XCVersionGroup",children:e.models.map(function(e){return e.fileRef}),currentVersion:e.currentModel.fileRef,name:path.basename(e.path),path:e.path,sourceTree:'"<group>"',versionGroupType:"wrapper.xcdatamodel"},this.xcVersionGroupSection()[t]=path.basename(e.path))},pbxProject.prototype.addToPluginsPbxGroup=function(e){var t=this.pbxGroupByName("Plugins");t?t.children.push(pbxGroupChild(e)):this.addPbxGroup([e.path],"Plugins")},pbxProject.prototype.removeFromPluginsPbxGroup=function(e){if(!this.pbxGroupByName("Plugins"))return null;var t,r=this.pbxGroupByName("Plugins").children;for(t in r)if(pbxGroupChild(e).value==r[t].value&&pbxGroupChild(e).comment==r[t].comment){r.splice(t,1);break}},pbxProject.prototype.addToResourcesPbxGroup=function(e){var t=this.pbxGroupByName("Resources");t?t.children.push(pbxGroupChild(e)):this.addPbxGroup([e.path],"Resources")},pbxProject.prototype.removeFromResourcesPbxGroup=function(e){if(!this.pbxGroupByName("Resources"))return null;var t,r=this.pbxGroupByName("Resources").children;for(t in r)if(pbxGroupChild(e).value==r[t].value&&pbxGroupChild(e).comment==r[t].comment){r.splice(t,1);break}},pbxProject.prototype.addToFrameworksPbxGroup=function(e){var t=this.pbxGroupByName("Frameworks");t?t.children.push(pbxGroupChild(e)):this.addPbxGroup([e.path],"Frameworks")},pbxProject.prototype.removeFromFrameworksPbxGroup=function(e){if(!this.pbxGroupByName("Frameworks"))return null;var t=this.pbxGroupByName("Frameworks").children;for(i in t)if(pbxGroupChild(e).value==t[i].value&&pbxGroupChild(e).comment==t[i].comment){t.splice(i,1);break}},pbxProject.prototype.addToPbxEmbedFrameworksBuildPhase=function(e){var t=this.pbxEmbedFrameworksBuildPhaseObj(e.target);t&&t.files.push(pbxBuildPhaseObj(e))},pbxProject.prototype.removeFromPbxEmbedFrameworksBuildPhase=function(e){var t=this.pbxEmbedFrameworksBuildPhaseObj(e.target);if(t){var r=[];for(i in t.files)t.files[i].comment!=longComment(e)&&r.push(t.files[i]);t.files=r}},pbxProject.prototype.addToProductsPbxGroup=function(e){var t=this.pbxGroupByName("Products");t?t.children.push(pbxGroupChild(e)):this.addPbxGroup([e.path],"Products")},pbxProject.prototype.removeFromProductsPbxGroup=function(e){if(!this.pbxGroupByName("Products"))return null;var t,r=this.pbxGroupByName("Products").children;for(t in r)if(pbxGroupChild(e).value==r[t].value&&pbxGroupChild(e).comment==r[t].comment){r.splice(t,1);break}},pbxProject.prototype.addToPbxSourcesBuildPhase=function(e){this.pbxSourcesBuildPhaseObj(e.target).files.push(pbxBuildPhaseObj(e))},pbxProject.prototype.removeFromPbxSourcesBuildPhase=function(e){var t,r=this.pbxSourcesBuildPhaseObj(e.target);for(t in r.files)if(r.files[t].comment==longComment(e)){r.files.splice(t,1);break}},pbxProject.prototype.addToPbxResourcesBuildPhase=function(e){this.pbxResourcesBuildPhaseObj(e.target).files.push(pbxBuildPhaseObj(e))},pbxProject.prototype.removeFromPbxResourcesBuildPhase=function(e){var t,r=this.pbxResourcesBuildPhaseObj(e.target);for(t in r.files)if(r.files[t].comment==longComment(e)){r.files.splice(t,1);break}},pbxProject.prototype.addToPbxFrameworksBuildPhase=function(e){this.pbxFrameworksBuildPhaseObj(e.target).files.push(pbxBuildPhaseObj(e))},pbxProject.prototype.removeFromPbxFrameworksBuildPhase=function(e){var t=this.pbxFrameworksBuildPhaseObj(e.target);for(i in t.files)if(t.files[i].comment==longComment(e)){t.files.splice(i,1);break}},pbxProject.prototype.addXCConfigurationList=function(e,t,r){for(var i=this.pbxXCBuildConfigurationSection(),o=this.pbxXCConfigurationList(),n=this.generateUuid(),p=f("%s_comment",n),a={isa:"XCConfigurationList",buildConfigurations:[],defaultConfigurationIsVisible:0,defaultConfigurationName:t},u=0;u<e.length;u++){var s=e[u],c=this.generateUuid(),h=f("%s_comment",c);i[c]=s,i[h]=s.name,a.buildConfigurations.push({value:c,comment:s.name})}return o&&(o[n]=a,o[p]=r),{uuid:n,xcConfigurationList:a}},pbxProject.prototype.addTargetDependency=function(e,t){if(e){var r=this.pbxNativeTargetSection();if(void 0===r[e])throw new Error("Invalid target: "+e);for(var i=0;i<t.length;i++){var o=t[i];if(void 0===r[o])throw new Error("Invalid target: "+o)}for(var n="PBXTargetDependency",p="PBXContainerItemProxy",a=this.hash.project.objects[n],u=this.hash.project.objects[p],i=0;i<t.length;i++){var s=t[i],c=f("%s_comment",s),h=this.generateUuid(),l=f("%s_comment",h),d=this.generateUuid(),b=f("%s_comment",d),P={isa:p,containerPortal:this.hash.project.rootObject,containerPortal_comment:this.hash.project.rootObject_comment,proxyType:1,remoteGlobalIDString:s,remoteInfo:r[s].name},s={isa:n,target:s,target_comment:r[c],targetProxy:d,targetProxy_comment:p};u&&a&&(u[d]=P,u[b]=p,a[h]=s,a[l]=n,r[e].dependencies.push({value:h,comment:n}))}return{uuid:e,target:r[e]}}},pbxProject.prototype.addBuildPhase=function(e,t,r,i,o,n){var p,a,u,s=this.pbxFileReferenceSection(),c=this.pbxBuildFileSection(),h=this.generateUuid(),i=i||this.getFirstTarget().uuid,l=f("%s_comment",h),d={isa:t,buildActionMask:2147483647,files:[],runOnlyForDeploymentPostprocessing:0},b={};for(p in"PBXCopyFilesBuildPhase"===t?d=pbxCopyFilesBuildPhaseObj(d,o,n,r):"PBXShellScriptBuildPhase"===t&&(d=pbxShellScriptBuildPhaseObj(d,o,r)),this.hash.project.objects[t]||(this.hash.project.objects[t]=new Object),this.hash.project.objects[t][h]||(this.hash.project.objects[t][h]=d,this.hash.project.objects[t][l]=r),this.hash.project.objects.PBXNativeTarget[i].buildPhases&&this.hash.project.objects.PBXNativeTarget[i].buildPhases.push({value:h,comment:r}),c)COMMENT_KEY.test(p)&&(u=c[a=p.split(COMMENT_KEY)[0]],fileReference=s[u.fileRef])&&(u=new pbxFile(fileReference.path),b[fileReference.path]={uuid:a,basename:u.basename,group:u.group});for(var P=0;P<e.length;P++){var m=e[P],x='"'+m+'"',g=new pbxFile(m);b[m]?d.files.push(pbxBuildPhaseObj(b[m])):b[x]?d.files.push(pbxBuildPhaseObj(b[x])):(g.uuid=this.generateUuid(),g.fileRef=this.generateUuid(),this.addToPbxFileReferenceSection(g),this.addToPbxBuildFileSection(g),d.files.push(pbxBuildPhaseObj(g)))}return{uuid:h,buildPhase:d}},pbxProject.prototype.pbxProjectSection=function(){return this.hash.project.objects.PBXProject},pbxProject.prototype.pbxBuildFileSection=function(){return this.hash.project.objects.PBXBuildFile},pbxProject.prototype.pbxXCBuildConfigurationSection=function(){return this.hash.project.objects.XCBuildConfiguration},pbxProject.prototype.pbxFileReferenceSection=function(){return this.hash.project.objects.PBXFileReference},pbxProject.prototype.pbxNativeTargetSection=function(){return this.hash.project.objects.PBXNativeTarget},pbxProject.prototype.xcVersionGroupSection=function(){return"object"!=typeof this.hash.project.objects.XCVersionGroup&&(this.hash.project.objects.XCVersionGroup={}),this.hash.project.objects.XCVersionGroup},pbxProject.prototype.pbxXCConfigurationList=function(){return this.hash.project.objects.XCConfigurationList},pbxProject.prototype.pbxGroupByName=function(e){var t,r=this.hash.project.objects.PBXGroup;for(t in r)if(COMMENT_KEY.test(t)&&r[t]==e)return r[t.split(COMMENT_KEY)[0]];return null},pbxProject.prototype.pbxTargetByName=function(e){return this.pbxItemByComment(e,"PBXNativeTarget")},pbxProject.prototype.findTargetKey=function(e){var t,r=this.hash.project.objects.PBXNativeTarget;for(t in r)if(!COMMENT_KEY.test(t))if(r[t].name===e)return t;return null},pbxProject.prototype.pbxItemByComment=function(e,t){var r,i=this.hash.project.objects[t];for(r in i)if(COMMENT_KEY.test(r)&&i[r]==e)return i[r.split(COMMENT_KEY)[0]];return null},pbxProject.prototype.pbxSourcesBuildPhaseObj=function(e){return this.buildPhaseObject("PBXSourcesBuildPhase","Sources",e)},pbxProject.prototype.pbxResourcesBuildPhaseObj=function(e){return this.buildPhaseObject("PBXResourcesBuildPhase","Resources",e)},pbxProject.prototype.pbxFrameworksBuildPhaseObj=function(e){return this.buildPhaseObject("PBXFrameworksBuildPhase","Frameworks",e)},pbxProject.prototype.pbxEmbedFrameworksBuildPhaseObj=function(e){return this.buildPhaseObject("PBXCopyFilesBuildPhase","Embed Frameworks",e)},pbxProject.prototype.buildPhase=function(e,t){if(t){var r=this.pbxNativeTargetSection();if(void 0===r[t])throw new Error("Invalid target: "+t);var i,o=r[t].buildPhases;for(i in o){var n=o[i];if(n.comment==e)return n.value+"_comment"}}},pbxProject.prototype.buildPhaseObject=function(e,t,r){var i,o=this.hash.project.objects[e],n=this.buildPhase(t,r);for(i in o)if(COMMENT_KEY.test(i)&&(!n||n==i)&&o[i]==t)return o[i.split(COMMENT_KEY)[0]];return null},pbxProject.prototype.addBuildProperty=function(e,t,r){var i,o,n=nonComments(this.pbxXCBuildConfigurationSection());for(i in n)o=n[i],r&&o.name!==r||(o.buildSettings[e]=t)},pbxProject.prototype.removeBuildProperty=function(e,t){var r,i,o=nonComments(this.pbxXCBuildConfigurationSection());for(r in o)((i=o[r]).buildSettings[e]&&!t||i.name===t)&&delete i.buildSettings[e]},pbxProject.prototype.updateBuildProperty=function(e,t,r,i){var o=[];if(i){var n=this.pbxTargetByName(i),p=n&&n.buildConfigurationList,a=this.pbxXCConfigurationList();for(const u in a)if(!COMMENT_KEY.test(u)&&p===u){for(const h of a[u].buildConfigurations)o.push(h.value);break}}var u,s,c=this.pbxXCBuildConfigurationSection();for(u in c)COMMENT_KEY.test(u)||(!i||o.includes(u))&&(s=c[u],r&&s.name===r||!r)&&(s.buildSettings[e]=t)},pbxProject.prototype.updateProductName=function(e){this.updateBuildProperty("PRODUCT_NAME",'"'+e+'"')},pbxProject.prototype.removeFromFrameworkSearchPaths=function(e){var t,r,i,o=nonComments(this.pbxXCBuildConfigurationSection()),n=searchPathForFile(e,this);for(t in o)unquote((i=o[t].buildSettings).PRODUCT_NAME)==this.productName&&(r=i.FRAMEWORK_SEARCH_PATHS)&&Array.isArray(r)&&r.filter(function(e){return-1<e.indexOf(n)}).forEach(function(e){e=r.indexOf(e);r.splice(e,1)})},pbxProject.prototype.addToFrameworkSearchPaths=function(e){var t,r,i=nonComments(this.pbxXCBuildConfigurationSection()),o='"$(inherited)"';for(t in i)unquote((r=i[t].buildSettings).PRODUCT_NAME)==this.productName&&(r.FRAMEWORK_SEARCH_PATHS&&r.FRAMEWORK_SEARCH_PATHS!==o||(r.FRAMEWORK_SEARCH_PATHS=[o]),r.FRAMEWORK_SEARCH_PATHS.push(searchPathForFile(e,this)))},pbxProject.prototype.removeFromLibrarySearchPaths=function(e){var t,r,i,o=nonComments(this.pbxXCBuildConfigurationSection()),n=searchPathForFile(e,this);for(t in o)unquote((i=o[t].buildSettings).PRODUCT_NAME)==this.productName&&(r=i.LIBRARY_SEARCH_PATHS)&&Array.isArray(r)&&r.filter(function(e){return-1<e.indexOf(n)}).forEach(function(e){e=r.indexOf(e);r.splice(e,1)})},pbxProject.prototype.addToLibrarySearchPaths=function(e){var t,r,i=nonComments(this.pbxXCBuildConfigurationSection()),o='"$(inherited)"';for(t in i)unquote((r=i[t].buildSettings).PRODUCT_NAME)==this.productName&&(r.LIBRARY_SEARCH_PATHS&&r.LIBRARY_SEARCH_PATHS!==o||(r.LIBRARY_SEARCH_PATHS=[o]),"string"==typeof e?r.LIBRARY_SEARCH_PATHS.push(e):r.LIBRARY_SEARCH_PATHS.push(searchPathForFile(e,this)))},pbxProject.prototype.removeFromHeaderSearchPaths=function(e){var t,r,i=nonComments(this.pbxXCBuildConfigurationSection()),o="HEADER_SEARCH_PATHS",n=searchPathForFile(e,this);for(t in i)unquote((r=i[t].buildSettings).PRODUCT_NAME)==this.productName&&r[o]&&r[o].filter(function(e){return-1<e.indexOf(n)}).forEach(function(e){e=r[o].indexOf(e);r[o].splice(e,1)})},pbxProject.prototype.addToHeaderSearchPaths=function(e){var t,r,i=nonComments(this.pbxXCBuildConfigurationSection());for(t in i)unquote((r=i[t].buildSettings).PRODUCT_NAME)==this.productName&&(r.HEADER_SEARCH_PATHS||(r.HEADER_SEARCH_PATHS=['"$(inherited)"']),"string"==typeof e?r.HEADER_SEARCH_PATHS.push(e):r.HEADER_SEARCH_PATHS.push(searchPathForFile(e,this)))},pbxProject.prototype.addToOtherLinkerFlags=function(e){var t,r,i=nonComments(this.pbxXCBuildConfigurationSection()),o='"$(inherited)"',n="OTHER_LDFLAGS";for(t in i)unquote((r=i[t].buildSettings).PRODUCT_NAME)==this.productName&&(r[n]&&r[n]!==o||(r[n]=[o]),r[n].push(e))},pbxProject.prototype.removeFromOtherLinkerFlags=function(t){var e,r,i=nonComments(this.pbxXCBuildConfigurationSection()),o="OTHER_LDFLAGS";for(e in i)unquote((r=i[e].buildSettings).PRODUCT_NAME)==this.productName&&r[o]&&r[o].filter(function(e){return-1<e.indexOf(t)}).forEach(function(e){e=r[o].indexOf(e);r[o].splice(e,1)})},pbxProject.prototype.addToBuildSettings=function(e,t){var r,i=nonComments(this.pbxXCBuildConfigurationSection());for(r in i)i[r].buildSettings[e]=t},pbxProject.prototype.removeFromBuildSettings=function(e){var t,r,i=nonComments(this.pbxXCBuildConfigurationSection());for(t in i)(r=i[t].buildSettings)[e]&&delete r[e]},pbxProject.prototype.__defineGetter__("productName",function(){var e,t,r=nonComments(this.pbxXCBuildConfigurationSection());for(e in r)if(t=r[e].buildSettings.PRODUCT_NAME)return unquote(t)}),pbxProject.prototype.hasFile=function(e){var t,r,i=nonComments(this.pbxFileReferenceSection());for(r in i)if((t=i[r]).path==e||t.path=='"'+e+'"')return t;return!1},pbxProject.prototype.addTarget=function(e,t,r,i){var o,n,p=this.generateUuid(),r=r||e,e=e.trim(),a=i;if(!e)throw new Error("Target name missing.");if(!t)throw new Error("Target type missing.");if(producttypeForTargettype(t))return i=[{name:"Debug",isa:"XCBuildConfiguration",buildSettings:{GCC_PREPROCESSOR_DEFINITIONS:['"DEBUG=1"','"$(inherited)"'],INFOPLIST_FILE:'"'+path.join(r,r+'-Info.plist"'),LD_RUNPATH_SEARCH_PATHS:'"$(inherited) @executable_path/Frameworks @executable_path/../../Frameworks"',PRODUCT_NAME:'"'+e+'"',SKIP_INSTALL:"YES"}},{name:"Release",isa:"XCBuildConfiguration",buildSettings:{INFOPLIST_FILE:'"'+path.join(r,r+'-Info.plist"'),LD_RUNPATH_SEARCH_PATHS:'"$(inherited) @executable_path/Frameworks @executable_path/../../Frameworks"',PRODUCT_NAME:'"'+e+'"',SKIP_INSTALL:"YES"}}],a&&(i=i.map(e=>(e.buildSettings.PRODUCT_BUNDLE_IDENTIFIER='"'+a+'"',e))),r=this.addXCConfigurationList(i,"Release",'Build configuration list for PBXNativeTarget "'+e+'"'),i=e,o=filetypeForProducttype(producttypeForTargettype(t)),(i=this.addProductFile(i,{group:"Copy Files",target:p,explicitFileType:o})).basename,this.addToPbxBuildFileSection(i),o={uuid:p,pbxNativeTarget:{isa:"PBXNativeTarget",name:'"'+e+'"',productName:'"'+e+'"',productReference:i.fileRef,productType:'"'+producttypeForTargettype(t)+'"',buildConfigurationList:r.uuid,buildPhases:[],buildRules:[],dependencies:[]}},this.addToPbxNativeTargetSection(o),"app_extension"===t?(this.addBuildPhase([],"PBXCopyFilesBuildPhase","Copy Files",this.getFirstTarget().uuid,t),this.addToPbxCopyfilesBuildPhase(i)):"watch2_app"===t?this.addBuildPhase([e+".app"],"PBXCopyFilesBuildPhase","Embed Watch Content",this.getFirstTarget().uuid,t,'"$(CONTENTS_FOLDER_PATH)/Watch"'):"watch2_extension"===t&&(n=this.getTarget(producttypeForTargettype("watch2_app")))&&this.addBuildPhase([e+".appex"],"PBXCopyFilesBuildPhase","Embed App Extensions",n.uuid,t),this.addToPbxProjectSection(o),"watch2_extension"===t?(n=this.getTarget(producttypeForTargettype("watch2_app")))&&this.addTargetDependency(n.uuid,[o.uuid]):this.addTargetDependency(this.getFirstTarget().uuid,[o.uuid]),o;throw new Error("Target type invalid: "+t)},pbxProject.prototype.getFirstProject=function(){var e=this.pbxProjectSection(),t=Object.keys(e)[0];return{uuid:t,firstProject:e[t]}},pbxProject.prototype.getFirstTarget=function(){var e=this.getFirstProject().firstProject.targets[0].value;return{uuid:e,firstTarget:this.pbxNativeTargetSection()[e]}},pbxProject.prototype.getTarget=function(e){for(var t=this.getFirstProject().firstProject.targets,r=this.pbxNativeTargetSection(),i=0;i<t.length;i++){var o=t[i].value;if(r[o].productType==='"'+e+'"')return{uuid:o,target:this.pbxNativeTargetSection()[o]}}return null},pbxProject.prototype.addToPbxGroupType=function(e,t,r){t=this.getPBXGroupByKeyAndType(t,r);t&&void 0!==t.children&&("string"==typeof e?(r={value:e},this.getPBXGroupByKey(e)?r.comment=this.getPBXGroupByKey(e).name:this.getPBXVariantGroupByKey(e)&&(r.comment=this.getPBXVariantGroupByKey(e).name),t.children.push(r)):t.children.push(pbxGroupChild(e)))},pbxProject.prototype.addToPbxVariantGroup=function(e,t){this.addToPbxGroupType(e,t,"PBXVariantGroup")},pbxProject.prototype.addToPbxGroup=function(e,t){this.addToPbxGroupType(e,t,"PBXGroup")},pbxProject.prototype.pbxCreateGroupWithType=function(e,t,r){var i={isa:'"'+r+'"',children:[],name:e,sourceTree:'"<group>"'},t=(t&&(i.path=t),this.generateUuid()),o=t+"_comment",n=this.hash.project.objects[r];return(n=n||(this.hash.project.objects[r]=new Object))[o]=e,n[t]=i,t},pbxProject.prototype.pbxCreateVariantGroup=function(e){return this.pbxCreateGroupWithType(e,void 0,"PBXVariantGroup")},pbxProject.prototype.pbxCreateGroup=function(e,t){return this.pbxCreateGroupWithType(e,t,"PBXGroup")},pbxProject.prototype.removeFromPbxGroupAndType=function(e,t,r){t=this.getPBXGroupByKeyAndType(t,r);if(t){var i,o=t.children;for(i in o)if(pbxGroupChild(e).value==o[i].value&&pbxGroupChild(e).comment==o[i].comment){o.splice(i,1);break}}},pbxProject.prototype.removeFromPbxGroup=function(e,t){this.removeFromPbxGroupAndType(e,t,"PBXGroup")},pbxProject.prototype.removeFromPbxVariantGroup=function(e,t){this.removeFromPbxGroupAndType(e,t,"PBXVariantGroup")},pbxProject.prototype.getPBXGroupByKeyAndType=function(e,t){return this.hash.project.objects[t][e]},pbxProject.prototype.getPBXGroupByKey=function(e){return this.hash.project.objects.PBXGroup[e]},pbxProject.prototype.getPBXVariantGroupByKey=function(e){return this.hash.project.objects.PBXVariantGroup[e]},pbxProject.prototype.findPBXGroupKeyAndType=function(e,t){var r,i,o=this.hash.project.objects[t];for(i in o)if(!COMMENT_KEY.test(i)){var n=o[i];if(e&&e.path&&e.name){if(e.path===n.path&&e.name===n.name){r=i;break}}else if(e&&e.path){if(e.path===n.path){r=i;break}}else if(e&&e.name&&e.name===n.name){r=i;break}}return r},pbxProject.prototype.findPBXGroupKey=function(e){return this.findPBXGroupKeyAndType(e,"PBXGroup")},pbxProject.prototype.findPBXVariantGroupKey=function(e){return this.findPBXGroupKeyAndType(e,"PBXVariantGroup")},pbxProject.prototype.addLocalizationVariantGroup=function(e){var t=this.pbxCreateVariantGroup(e),r=this.findPBXGroupKey({name:"Resources"}),r=(this.addToPbxGroup(t,r),{uuid:this.generateUuid(),fileRef:t,basename:e});return this.addToPbxBuildFileSection(r),this.addToPbxResourcesBuildPhase(r),r},pbxProject.prototype.addKnownRegion=function(e){this.pbxProjectSection()[this.getFirstProject().uuid].knownRegions||(this.pbxProjectSection()[this.getFirstProject().uuid].knownRegions=[]),this.hasKnownRegion(e)||this.pbxProjectSection()[this.getFirstProject().uuid].knownRegions.push(e)},pbxProject.prototype.removeKnownRegion=function(e){var t=this.pbxProjectSection()[this.getFirstProject().uuid].knownRegions;if(t){for(var r=0;r<t.length;r++)if(t[r]===e){t.splice(r,1);break}this.pbxProjectSection()[this.getFirstProject().uuid].knownRegions=t}},pbxProject.prototype.hasKnownRegion=function(e){var t=this.pbxProjectSection()[this.getFirstProject().uuid].knownRegions;if(t)for(var r in t)if(t[r]===e)return!0;return!1},pbxProject.prototype.getPBXObject=function(e){return this.hash.project.objects[e]},pbxProject.prototype.addFile=function(e,t,r){e=new pbxFile(e,r);return this.hasFile(e.path)?null:(e.fileRef=this.generateUuid(),this.addToPbxFileReferenceSection(e),this.getPBXGroupByKey(t)?this.addToPbxGroup(e,t):this.getPBXVariantGroupByKey(t)&&this.addToPbxVariantGroup(e,t),e)},pbxProject.prototype.removeFile=function(e,t,r){e=new pbxFile(e,r);return this.removeFromPbxFileReferenceSection(e),this.getPBXGroupByKey(t)?this.removeFromPbxGroup(e,t):this.getPBXVariantGroupByKey(t)&&this.removeFromPbxVariantGroup(e,t),e},pbxProject.prototype.getBuildProperty=function(e,t,r){var i,o=[];if(r){const i=this.pbxTargetByName(r);var n=i&&i.buildConfigurationList,p=this.pbxXCConfigurationList();for(const a in p)if(!COMMENT_KEY.test(a)&&n===a){for(const c of p[a].buildConfigurations)o.push(c.value);break}}var a,u,s=this.pbxXCBuildConfigurationSection();for(a in s)COMMENT_KEY.test(a)||r&&!o.includes(a)||(u=s[a],(t&&u.name===t||void 0===t)&&void 0!==u.buildSettings[e]&&(i=u.buildSettings[e]));return i},pbxProject.prototype.getBuildConfigByName=function(e){var t,r,i={},o=this.pbxXCBuildConfigurationSection();for(t in o)COMMENT_KEY.test(t)||(r=o[t]).name===e&&(i[t]=r);return i},pbxProject.prototype.addDataModelDocument=function(e,t,r){this.getPBXGroupByKey(t=t||"Resources")||(t=this.findPBXGroupKey({name:t}));var i,o=new pbxFile(e,r);if(!o||this.hasFile(o.path))return null;if(o.fileRef=this.generateUuid(),this.addToPbxGroup(o,t),!o)return!1;o.target=r?r.target:void 0,o.uuid=this.generateUuid(),this.addToPbxBuildFileSection(o),this.addToPbxSourcesBuildPhase(o),o.models=[];var n,p=fs.readdirSync(o.path);for(n in p){var a=p[n],u=path.join(e,a);".xccurrentversion"==a?i=plist.readFileSync(u)._XCCurrentVersionName:((u=new pbxFile(u)).fileRef=this.generateUuid(),this.addToPbxFileReferenceSection(u),o.models.push(u),i&&i===a&&(o.currentModel=u))}return o.currentModel||(o.currentModel=o.models[0]),this.addToXcVersionGroupSection(o),o},pbxProject.prototype.addTargetAttribute=function(e,t,r){var i=this.getFirstProject().firstProject.attributes;void 0===i.TargetAttributes&&(i.TargetAttributes={}),r=r||this.getFirstTarget(),void 0===i.TargetAttributes[r.uuid]&&(i.TargetAttributes[r.uuid]={}),i.TargetAttributes[r.uuid][e]=t},pbxProject.prototype.removeTargetAttribute=function(e,t){var r=this.getFirstProject().firstProject.attributes;t=t||this.getFirstTarget(),r.TargetAttributes&&r.TargetAttributes[t.uuid]&&delete r.TargetAttributes[t.uuid][e]},module.exports=pbxProject;