const path=require("path"),fs=require("fs"),gulp=require("gulp"),babelify=require("babelify"),browserify=require("browserify"),source=require("vinyl-source-stream"),buffer=require("vinyl-buffer");function checkFileStat(t,i){return fs.readdirSync(t).some(e=>{var e=path.join(t,e),n=fs.statSync(e);return n.isDirectory()?checkFileStat(e,i):n.mtime.getTime()>i||void 0})}function hasChanged(e,n){return!fs.existsSync(n)||(n=fs.statSync(n),checkFileStat(path.dirname(e),n.mtime.getTime()))}function createBundleTask(e,n,t){var i=path.basename(n);n=path.dirname(n);const r=browserify(e);return t&&t.forEach(function(e){r.exclude(e)}),r.transform(babelify,{presets:[require("@babel/preset-env")]}).bundle().pipe(source(i)).pipe(buffer()).pipe(gulp.dest(n))}function createCopyTask(e,n){return gulp.src(e).pipe(gulp.dest(n))}async function prebuild(e){const{rootPath:i,dstPath:r}=e;if(!i)throw new Error("Please specify the jsbAdapter path");console.time("build jsb-adapter"),await new Promise(e=>{var n=path.join(i,"./builtin/index.js"),t=path.join(r,"./jsb-builtin.js");hasChanged(n,t)?createBundleTask(n,t).on("end",e):e()}),await new Promise(e=>{var n=path.join(i,"./engine/index.js"),t=path.join(r,"./jsb-engine.js");hasChanged(n,t)?createBundleTask(n,t).on("end",e):e()}),console.timeEnd("build jsb-adapter")}async function build(e){const{rootPath:r,dstPath:n,excludedModules:a}=e;if(!r)throw new Error("Please specify the jsbAdapter path");console.time("build jsb-adapter"),await new Promise(e=>{createCopyTask(path.join(r,"./bin/jsb-builtin.js"),n).on("end",e)}),await new Promise(e=>{if(a&&0<a.length){const t=[],i=require(Editor.url("packages://jsb-adapter/modules.json"));a.forEach(function(n){i.some(function(e){if(e.name===n&&e.entries)return e.entries.forEach(function(e){t.push(path.join(r,e))}),!0})}),createBundleTask(path.join(r,"./engine/index.js"),path.join(n,"./jsb-engine.js"),t).on("end",e)}else createCopyTask(path.join(r,"./bin/jsb-engine.js"),n).on("end",e)}),console.timeEnd("build jsb-adapter")}const jsbAdapterBuilder={prebuild:prebuild,build:build,createBundleTask:createBundleTask};module.exports=jsbAdapterBuilder;