"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.methods=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),child_process_1=require("child_process");function mapToCommandArgs(e,t=" ",r=!0){return Object.entries(e).map(([e,t])=>(r?"--":"")+e+"="+t).join(t)}function handleLaunchMethod(e,t){let r=e;if("lite"===e){t="darwin"===process.platform?(0,path_1.join)(t,"Contents/Resources/app/package.json"):(0,path_1.join)((0,path_1.dirname)(t),"resources/app/package.json");if((0,fs_extra_1.existsSync)(t))try{var o=JSON.parse((0,fs_extra_1.readFileSync)(t,"utf8"));if(Editor.Utils.Parse.compareVersion(o.version,"4.1.0"))return e;console.log(Editor.I18n.t("bytedance-mini-game.tips.client_version_err",{currVersion:o.version||"",version:"4.1.0"}))}catch(e){console.error(e)}else console.warn(Editor.I18n.t("bytedance-mini-game.tips.client_info_path_err",{path:t}));r="full"}return r}exports.methods={async run(e,t){var r=await Editor.Message.request("program","query-program-info","bytedanceDevtools"),r=r?r.path:"";if(!r||!(0,fs_extra_1.existsSync)(r))return console.warn(Editor.I18n.t("bytedance-mini-game.tips.bytedance_app_path_empty")),1===(await Editor.Dialog.warn(Editor.I18n.t("bytedance-mini-game.tips.bytedance_app_path_empty"),{buttons:[Editor.I18n.t("bytedance-mini-game.tips.cancel"),Editor.I18n.t("bytedance-mini-game.tips.setDevTools")]})).response&&Editor.Message.send("preferences","open-settings","program"),!1;if(!(0,fs_extra_1.existsSync)(r))return await Editor.Dialog.error(Editor.I18n.t("bytedance-mini-game.tips.client_path_error")),!1;let o,n="",a="";e={path:`"${e}"`,"project-type":"microgame",mode:handleLaunchMethod(t.packages["bytedance-mini-game"].devToolsLaunchMethod,r)};a="darwin"===process.platform?(o="open",n=o+` "${r}" --args `+mapToCommandArgs(e),`${o} "bytedanceide:?${mapToCommandArgs(e,"&",!1)}"`):(o="start",n=o+` "" "${r}" `+mapToCommandArgs(e),`${o} "" "bytedanceide:?${mapToCommandArgs(e,"^&",!1)}"`),console.log(`Run command: ${n} && `+a);const s=(0,child_process_1.exec)(n+" && "+a);s&&s.stdout&&s.stdout.on("data",function(e){console.log("[Douyin IDE] "+e.toString())}),s&&s.stderr&&s.stderr.on("data",function(e){console.error("[Douyin IDE stderr] "+e.toString())}),s.on("close",e=>{s.kill()})}};