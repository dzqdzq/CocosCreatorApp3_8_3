"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterCopyBuildTemplate=exports.onBeforeCopyBuildTemplate=exports.onAfterBuild=exports.onAfterBundleBuildTask=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),builtinBundleNames=["resources","main","start-scene","internal"],OPEN_DATA_CONTEXT_ROOT="openDataContext",Paths={internalTemplateDir:(0,path_1.join)(__dirname,"../../../../../../resources/3d/engine/templates/bytedance-mini-game")};async function queryEngineChunkFileList(e){let t;try{t=await(0,fs_extra_1.readJson)(e)}catch(e){throw new Error("Failed to read engine export meta, engine might not have been build correctly: "+e)}return Object.keys(t.chunkDepGraph)}async function writePreloadJsFileList(e,t,a){if(t.packages["bytedance-mini-game"].generatePreloadJsFileList){var s=a.paths.dir,i=[],n=(t.md5Cache?(n=Object.keys(a.paths.hashedMap).find(e=>"web-adapter.js"===(0,path_1.basename)(e)))&&(n=(0,path_1.basename)(a.paths.hashedMap[n]),i.push(n)):i.push("web-adapter.js"),a.paths.polyfillsJs&&i.push(Build.Utils.relativeUrl(s,a.paths.polyfillsJs)),a.paths.systemJs&&i.push(Build.Utils.relativeUrl(s,a.paths.systemJs)),await queryEngineChunkFileList(a.paths.engineMeta));if(0<n.length){var r,t=t.buildEngineParam.output,p=Build.Utils.relativeUrl(s,t);for(const l of n)l.startsWith("cc")?(r=Build.Utils.relativeUrl(s,(0,path_1.join)(s,"src",a.importMap.imports.cc)),i.push(r)):i.push(p+"/"+l)}for(const c of a.settings.plugins.jsList)i.push("src/"+c);for(const u of e.bundleManager.bundles){var o=u.scriptDest;builtinBundleNames.includes(u.name)&&(0,fs_extra_1.existsSync)(o)&&i.push(Build.Utils.relativeUrl(s,o))}(0,fs_extra_1.outputFileSync)((0,path_1.join)(s,"preload-js-list.json"),JSON.stringify(i,void 0,2))}}async function onAfterInit(e,t,a){e.server&&!e.server.endsWith("/")&&(e.server+="/"),Object.assign(e.buildEngineParam,{moduleStyle:"cjs"});var s=e.packages["bytedance-mini-game"],i=(0,path_1.join)(t.paths.dir,OPEN_DATA_CONTEXT_ROOT),n=(0,path_1.join)(Editor.Project.tmpDir,"builder/bytedance-mini-game",OPEN_DATA_CONTEXT_ROOT);(0,fs_extra_1.existsSync)(i)&&((0,fs_extra_1.existsSync)(n)&&(0,fs_extra_1.removeSync)(n),(0,fs_extra_1.copySync)(i,n)),t.staticsInfo.B100011=s.orientation,t.staticsInfo.B100013=s.appid,(0,fs_extra_1.existsSync)(n)?(0,fs_extra_1.moveSync)(n,i):s.buildOpenDataContextTemplate&&(t=e.engineInfo.typescript.path,n=(0,path_1.join)(t,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT),(0,fs_extra_1.copySync)(n,i)),e.buildScriptParam.flags.WASM_SUBPACKAGE=s.wasmSubpackage,e.buildEngineParam.enableNamedRegisterForSystemJSModuleFormat=s.generatePreloadJsFileList}function onBeforeBundleInit(e){e.polyfills&&(e.polyfills.asyncFunctions=!1);var t=e.packages["bytedance-mini-game"];e.assetSerializeOptions.exportCCON=!0,t.physX.use&&e.includeModules.includes("physics-physx")&&(delete t.physX.use,Object.assign(e.physicsConfig,{physX:t.physX}),t.appid||console.error(Editor.I18n.t("bytedance-mini-game.tips.require_appid"))),e.moveRemoteBundleScript=!0,e.buildScriptParam.platform="BYTEDANCE",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.buildScriptParam.flags.NOT_PACK_PHYSX_LIBS=!!t.physX.notPackPhysXLibs}async function onAfterBundleBuildTask(e,t,a){const s=[];t.forEach(e=>{var t;e.isSubpackage&&(t=(0,path_1.join)((0,path_1.dirname)(e.scriptDest),"game.js"),(0,fs_extra_1.existsSync)(e.scriptDest)?(0,fs_extra_1.renameSync)(e.scriptDest,t):(0,fs_extra_1.outputFileSync)(t,`console.log('${name}: no script in subPackage.')`,"utf8"),e.scriptDest=t,s.push({name:e.name,root:`subpackages/${e.name}/`}))}),s.length&&(e.packages["bytedance-mini-game"].subpackages=s)}async function onAfterBuild(e,t){await writePreloadJsFileList(this,e,t)}async function onBeforeCopyBuildTemplate(e,t,a,s){var i=e.engineInfo.typescript.path;for(const o of["web-adapter","engine-adapter"])await(0,fs_extra_1.copy)((0,path_1.join)(i,"bin/adapter/minigame/bytedance",`${o}.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,o+".js"));var n=(0,path_1.join)(t.paths.dir,"src/"+e.buildScriptParam.outputName),n=((0,fs_extra_1.existsSync)(n)||(0,fs_extra_1.outputFileSync)(n,"console.log('There is no script in project.')","utf-8"),e.packages["bytedance-mini-game"]),r=(Paths.internalTemplateDir=(0,path_1.join)(e.engineInfo.typescript.path,"templates/bytedance-mini-game"),e.buildEngineParam.engineName),p=this.buildTemplate.initUrl("game.ejs")||(0,path_1.join)(Paths.internalTemplateDir,"game.ejs"),r={engineName:r,polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),appid:n.appid,isUsePhysX:e.includeModules.includes("physics-physx")},n=await ejs_1.default.renderFile(p,r);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,"game.js"),n,"utf-8"),e.md5CacheOptions.replaceOnly.push((0,path_1.join)(t.paths.dir,"game.js"))}async function onAfterCopyBuildTemplate(e,t,a,s){buildGameJson(Paths.internalTemplateDir,t,e,this.buildTemplate.findFile("game.json")),buildProjectJson(Paths.internalTemplateDir,t.paths.dir,e,this.buildTemplate.findFile("project.config.json"))}function buildGameJson(e,t,a,s){var i=t.paths.dir,n=a.packages["bytedance-mini-game"],e=(0,fs_extra_1.readJSONSync)((0,path_1.join)(e,"game.json")),s=(s&&(s=(0,fs_extra_1.readJSONSync)(s),Object.assign(e,s)),"landscapeRight"!==n.orientation&&"landscapeLeft"!==n.orientation||(n.orientation="landscape"),e.deviceOrientation=n.orientation,n.buildOpenDataContextTemplate?e.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete e.openDataContext,n.wasmSubpackage&&(s=(0,path_1.join)(t.paths.engineDir,"./assets/"),t=(0,path_1.join)(t.paths.engineDir,"./chunks/"),(0,fs_extra_1.existsSync)(s)&&(null==n.subpackages&&(n.subpackages=[]),n.subpackages.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"})),(0,fs_extra_1.existsSync)(t))&&(null==n.subpackages&&(n.subpackages=[]),n.subpackages.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"})),n.subpackages&&(e.subpackages=n.subpackages),(0,path_1.join)(i,"game.json"));a.md5CacheOptions.excludes.push(s),(0,fs_extra_1.outputJSONSync)(s,e,{spaces:4})}function buildProjectJson(e,t,a,s){e=(0,fs_extra_1.readJSONSync)((0,path_1.join)(e,"project.config.json")),s&&(s=(0,fs_extra_1.readJSONSync)(s),Object.assign(e,s)),e.appid=a.packages["bytedance-mini-game"].appid||"testappid",e.projectname=a.name,s=(0,path_1.join)(t,"project.config.json");a.md5CacheOptions.excludes.push(s),(0,fs_extra_1.outputJSONSync)(s,e)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onAfterBuild=onAfterBuild,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterCopyBuildTemplate=onAfterCopyBuildTemplate;