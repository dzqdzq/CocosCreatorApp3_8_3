"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,a,t,i){void 0===i&&(i=t);var s=Object.getOwnPropertyDescriptor(a,t);s&&("get"in s?a.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return a[t]}}),Object.defineProperty(e,i,s)}:function(e,a,t,i){e[i=void 0===i?t:i]=a[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,a){Object.defineProperty(e,"default",{enumerable:!0,value:a})}:function(e,a){e.default=a}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var a={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(a,e,t);return __setModuleDefault(a,e),a};Object.defineProperty(exports,"__esModule",{value:!0}),exports.make=exports.onAfterCopyBuildTemplate=exports.onBeforeCopyBuildTemplate=exports.onAfterBundleBuildTask=exports.onAfterBundleDataTask=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=__importStar(require("path")),Ejs=__importStar(require("ejs")),ccbuild_1=require("@cocos/ccbuild"),separate_engine_1=require("./separate-engine"),share_1=require("./share");async function onAfterInit(e,a,t){e.generateCompileConfig=!0,e.server&&!e.server.endsWith("/")&&(e.server+="/"),a.staticsInfo.B100011=e.packages["oppo-mini-game"].deviceOrientation,a.staticsInfo.B100005=e.packages["oppo-mini-game"].package,e.useSplashScreen&&({logo:a,background:i}=await Editor.Profile.getProject("builder","splash-setting"),"custom"===a.type&&a.image&&!await validRatio(Editor.UI.__protected__.File.resolveToRaw(a.image))||"custom"===i.type&&i.image&&!await validRatio(Editor.UI.__protected__.File.resolveToRaw(i.image)))&&console.error("The width or height of the splash screen image cannot be larger than 4069 for oppo-mini-game!");var i,a=e.packages["oppo-mini-game"];e.buildScriptParam.flags.WASM_SUBPACKAGE=a.wasmSubpackage&&!a.separateEngine}function onBeforeBundleInit(e,a){e.polyfills&&(e.polyfills.asyncFunctions=!1),e.moveRemoteBundleScript=!0,e.assetSerializeOptions.exportCCON=!0,e.buildScriptParam.system={preset:"commonjs-like"},e.buildScriptParam.platform="OPPO"}function onAfterBundleDataTask(a,e){e.forEach(e=>{e.isSubpackage&&(e.dest=path_1.default.join((0,path_1.dirname)(a.dest),share_1.subpackagePrefix+e.name),e.scriptDest=path_1.default.join(e.dest,"main.js"))})}async function onAfterBundleBuildTask(e,a,t){const i=[];a.forEach(e=>{e.isSubpackage&&(e=""+share_1.subpackagePrefix+e.name,i.push({name:e,root:e+"/"}))}),i.length&&(e.packages["oppo-mini-game"].subpackages=i)}async function onBeforeCopyBuildTemplate(e,a,t){var i=e.packages["oppo-mini-game"],{icon:s,useDebugKey:n,privatePemPath:r,certificatePemPath:o}=i,p=(0,path_1.join)(a.paths.dir,`src/${e.buildScriptParam.outputName}.js`),p=((0,fs_extra_1.existsSync)(p)||(0,fs_extra_1.outputFileSync)(p,"console.log('There is no script in project.')","utf8"),this.buildTemplate.findFile("main.js")||await renderMainJs(this.buildTemplate.initUrl("main.ejs")||(0,path_1.join)(share_1.Paths.internalTemplateDir,"main.ejs"),e,a),await generateAdapter(e,a.paths.dir),(0,path_1.join)(a.paths.dir,share_1.ICON_NAME+(0,path_1.extname)(s)));(0,fs_extra_1.copyFileSync)(s,p),e.md5CacheOptions.excludes.push(p),handleSign(a.paths.dir,n,r,o),i.wasmSubpackage&&!i.separateEngine&&(s=(0,path_1.join)(a.paths.engineDir,"./assets/"),e=(0,path_1.join)(a.paths.engineDir,"./chunks/"),(0,fs_extra_1.existsSync)(s)&&(null==i.subpackages&&(i.subpackages=[]),i.subpackages.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"}),(0,fs_extra_1.renameSync)((0,path_1.join)(s,"game.js"),(0,path_1.join)(s,"main.js"))),(0,fs_extra_1.existsSync)(e))&&(null==i.subpackages&&(i.subpackages=[]),i.subpackages.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"}),(0,fs_extra_1.renameSync)((0,path_1.join)(e,"game.js"),(0,path_1.join)(e,"main.js")))}async function onAfterCopyBuildTemplate(e,a){e.packages["oppo-mini-game"].separateEngine&&(await buildSeparateEngine(e,a),await handleImportMap(e,a));var t=this.buildTemplate.findFile("manifest.json");e.packages["oppo-mini-game"].hasSubPackage=await writeConfigFile(a.paths.dir,e,t)}async function buildSeparateEngine(e,a){var t=e.engineInfo.typescript.builtin,i=await(0,separate_engine_1.buildCocos)(t),t=await ccbuild_1.StatsQuery.create(t),i=(0,path_1.join)(i,"cocos"),s=(0,path_1.join)(a.paths.dir,share_1.ENGINE_PLUGIN_NAME),i=((0,fs_extra_1.ensureDirSync)(s),Build.Utils.copyDirSync(i,s),t.getUnitsOfFeatures(e.includeModules)),e=(0,path_1.join)(a.paths.dir,"cocos-js/cc.js"),t=await ccbuild_1.buildEngine.transform(t.evaluateIndexModuleSource(i,e=>`plugin:cocos-library/${e}.js`),"system"),i=((0,fs_extra_1.emptyDirSync)((0,path_1.dirname)(e)),(0,fs_extra_1.outputFileSync)(e,t.code,"utf8"),(0,path_1.join)(s,"assets"));(0,fs_extra_1.existsSync)(i)&&(e=(0,path_1.join)(a.paths.dir,"cocos-js/assets"),(0,fs_extra_1.ensureDirSync)(e),(0,fs_extra_1.emptyDirSync)(e),Build.Utils.copyDirSync(i,e),(0,fs_extra_1.rmSync)(i,{force:!0,recursive:!0}))}async function handleImportMap(e,a){var t=(0,path_1.join)(a.paths.dir,"src/"+(0,path_1.basename)(a.paths.importMap)),i=await(0,fs_extra_1.readJson)(t);i.imports.cc="./../cocos-js/cc.js",null!=i&&i.imports["wait-for-ammo-instantiation"]&&(i.imports["wait-for-ammo-instantiation"]="plugin:cocos-library/wait-for-ammo-instantiation.js"),a.paths.importMap=t,(0,fs_extra_1.writeJson)(t,i,{spaces:2})}async function renderMainJs(e,a,t){var i={optionDebug:a.debug,polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},e=await Ejs.renderFile(e,i);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,"main.js"),e),a.md5CacheOptions.replaceOnly.push((0,path_1.join)(t.paths.dir,"main.js"))}async function make(e,a){var t={name:a.name,hasSubPackage:!!a.packages["oppo-mini-game"].hasSubPackage,useDebugKey:a.packages["oppo-mini-game"].useDebugKey};if(!await isInstallNodeJs())throw new Error("Please install node in global first!");(0,fs_extra_1.existsSync)(share_1.Paths.packPath)||(console.debug("start unzip pack tools"),i=require("v-unzip"),s=share_1.Paths.packPath+".zip",await i.unzip(s,share_1.Paths.packPath)),(0,fs_extra_1.emptyDirSync)(share_1.Paths.temp);var i=(0,path_1.join)(share_1.Paths.temp,"remote"),s=(0,path_1.join)(e,"remote");a.server&&(0,fs_extra_1.existsSync)(s)&&(0,fs_extra_1.moveSync)(s,i),t.hasSubPackage?(console.log(Editor.I18n.t("oppo-runtime.building_subpack_rpk")),await buildSubPackage(e,t)):await buildRpk(e,t),a.server&&(0,fs_extra_1.existsSync)(i)&&(0,fs_extra_1.moveSync)(i,s)}async function buildRpk(e,a){console.log(Editor.I18n.t("oppo-builder.rpk_installing"));var t=[""+(0,path_1.join)(share_1.Paths.packPath,"lib/bin/index"),"cocoscreator"],t=(a.useDebugKey||t.push("release"),await Build.Utils.quickSpawn("node",t,{env:process.env,cwd:e}));if(!0===t)return t=(0,path_1.join)(e,"dist",a.name+(a.useDebugKey?".":".signed.")+"rpk"),console.log(Editor.I18n.t("oppo-mini-game.tips.rpk_install_success")+`{link(${t})}`),t;throw new Error(Editor.I18n.t("oppo-mini-game.tips.rpk_install_fail"))}async function buildSubPackage(e,a){var t=[(0,path_1.join)(share_1.Paths.packPath,"lib/bin/index"),"subpack","--no-build-js"],t=(a.useDebugKey||t.push("release"),await Build.Utils.quickSpawn("node",t,{env:process.env,cwd:e}));if(t||1===t)return t=(0,path_1.join)(e,"dist",a.name+(a.useDebugKey?".":".signed.")+"rpk"),console.log(Editor.I18n.t("oppo-mini-game.tips.build_subpack_rpk_complet")+`{link(${t})}`),t;throw new Error(Editor.I18n.t("oppo-mini-game.tips.build_subpack_rpk_error"))}async function writeConfigFile(e,a,t){var i=(0,path_1.join)(e,"manifest.json"),s=a.packages["oppo-mini-game"],{versionName:n,versionCode:r,minPlatformVersion:o,deviceOrientation:p,icon:c}=s,l=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"manifest.json"));return t&&(t=(0,fs_extra_1.readJSONSync)(t),Object.assign(l,t)),Object.assign(l,{package:s.package,name:a.name,versionName:n,versionCode:r,minPlatformVersion:o,icon:"/"+share_1.ICON_NAME+(0,path_1.extname)(c),orientation:p}),s.subpackages&&0<s.subpackages.length?l.subpackages=s.subpackages:delete l.subpackages,s.separateEngine&&(l.plugins={},l.plugins[share_1.ENGINE_PLUGIN_NAME]={version:Editor.App.version,provider:"",path:share_1.ENGINE_PLUGIN_NAME},(0,fs_extra_1.writeJSONSync)((0,path_1.join)(e,share_1.ENGINE_PLUGIN_NAME+"/plugin.json"),{},{spaces:2})),(0,fs_extra_1.writeJSONSync)(i,l),a.md5CacheOptions.excludes.push(i),!!s.subpackages}function handleSign(e,a,t,i){e=(0,path_1.join)(e,"sign");(0,fs_extra_1.emptyDirSync)(e),a||(a=(0,path_1.join)(e,"release"),(0,fs_extra_1.ensureDirSync)(a),(0,fs_extra_1.existsSync)(t)&&(0,fs_extra_1.writeFileSync)((0,path_1.join)(a,"private.pem"),(0,fs_extra_1.readFileSync)(t)),(0,fs_extra_1.existsSync)(i)&&(0,fs_extra_1.writeFileSync)((0,path_1.join)(a,"certificate.pem"),(0,fs_extra_1.readFileSync)(i)))}async function generateAdapter(e,a){var t=(0,path_1.join)(a,"runtime-adapter"),a=e.engineInfo.typescript.path,i=e.platform,s=(0,path_1.join)(a,"bin/adapter/runtime"),a=(0,path_1.join)(s,`web-adapter${e.debug?"":".min"}.js`),n=(0,path_1.join)(t,"web-adapter.js");await(0,fs_extra_1.copy)(a,n);for(const r of["ral","engine-adapter"])await(0,fs_extra_1.copy)((0,path_1.join)(s,i,`${r}.${e.debug?"":"min."}js`),(0,path_1.join)(t,r+".js"));e.md5CacheOptions.includes.push((0,path_1.join)(t,"*.js"))}function isInstallNodeJs(){return new Promise((a,t)=>{(0,child_process_1.exec)("node -v",{env:process.env},e=>{e?("win32"===process.platform?console.error(new Error(Editor.I18n.t("builder.window_default_npm_path_error"))):console.error(new Error(Editor.I18n.t("builder.mac_default_npm_path_error"))),t(!1)):a(!0)})})}function compareBuildTemplateVersion(e,a){if(!a)return"1.0.0"!==e;var[t,i]=[e.split("."),a.split(".")],s=Math.max(t.length,i.length);for(let e=0;e<s;e++)if(parseInt(t[e])>parseInt(i[e]))return!0;return!1}function validRatio(i){return new Promise((e,a)=>{const t=new Image;t.src="data:image/png;base64,"+(0,fs_extra_1.readFileSync)(i).toString("base64"),t.onload=function(){(4096<t.width||4096<t.height)&&e(!1),e(!0)},t.onerror=function(e){a(e)}})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBundleDataTask=onAfterBundleDataTask,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterCopyBuildTemplate=onAfterCopyBuildTemplate,exports.make=make;