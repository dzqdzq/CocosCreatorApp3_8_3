"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onAfterBundleInit=exports.onAfterInit=exports.onBeforeBuild=exports.throwError=void 0;const ccbuild_1=require("@cocos/ccbuild"),fs_extra_1=require("fs-extra"),fs_extra_2=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),json5_1=__importDefault(require("json5"));async function generateOptions(e){var e=e.packages.openharmony,t=(e.orientation=e.orientation||{},await Editor.Message.request("program","query-program-info","OpenHarmonySDK")),a=await Editor.Message.request("program","query-program-info","OpenHarmonyNDK");return e.sdkPath=t?t.path:"",e.ndkPath=a?a.path:"",{packageName:e.packageName||"",orientation:e.orientation,apiLevel:Number(e.apiLevel)||9,appABIs:e.appABIs||[],sdkPath:e.sdkPath||"",ndkPath:e.ndkPath||"",renderBackEnd:{gles3:null==(a=null==(t=e.renderBackEnd)?void 0:t.gles3)||a},useAotOptimization:e.useAotOptimization,useV8:e.useV8}}async function onBeforeBuild(e,t,a){e.sourceMaps=!1}async function onAfterInit(e,t,a){var s=await generateOptions(e);const r=(e.packages.openharmony=s).renderBackEnd,n=(e.buildEngineParam.preserveType=s.useAotOptimization,t.staticsInfo.B100005=s.packageName,t.staticsInfo.B100011=s.orientation,t.compileOptions);Object.keys(r).forEach(e=>{n.cMakeConfig["CC_USE_"+e.toUpperCase()]=r[e]}),n.cMakeConfig.USE_SE_V8=`set(USE_SE_V8 ${s.useV8?"ON":"OFF"})`,n.cMakeConfig.USE_SE_NAPI=`set(USE_SE_NAPI ${s.useV8?"OFF":"ON"})`,Object.assign(n.platformParams,s),await(0,fs_extra_1.outputJSON)(t.paths.compileConfig,n),checkSDKEnv(e)}function onAfterBundleInit(e){e.packages.openharmony.useV8||(e.buildScriptParam.importMapFormat="esm");var t=e.packages.openharmony.renderBackEnd;e.assetSerializeOptions["cc.EffectAsset"].glsl3=null==(t=t.gles3)||t,e.buildScriptParam.platform="OPEN_HARMONY"}async function onAfterBuild(t,a,e){var{useAotOptimization:s,useV8:r}=t.packages.openharmony,n=(r||(o="export default "+(o=(0,fs_extra_1.readFileSync)(a.paths.settings,"utf8")),o=(await ccbuild_1.buildEngine.transform(o,"system"))["code"],(0,fs_extra_1.unlinkSync)(a.paths.settings),n=(0,path_1.join)((0,path_1.dirname)(a.paths.settings),"settings.js"),(0,fs_extra_1.outputFileSync)(n,o,"utf8")),(0,path_1.join)(a.paths.dir,"assets"));const i=(0,path_1.join)(Editor.Project.path,"native/engine",t.platform,"entry/src/main");var o=(0,path_1.join)(i,"ets/cocos/src/cocos-js/assets"),p=(0,path_1.join)(Editor.Project.path,"native/engine",t.platform,"entry"),c=(0,path_1.join)(p,"src/main/ets/cocos/src/effect.bin"),_=(0,path_1.join)(i,"resources/rawfile/Resources");const f=(0,path_1.join)(_,"assets");var u=(0,path_1.join)(_,"cocos-js/assets"),h=(0,path_1.join)(_,"src/effect.bin"),n=(await(0,fs_extra_2.emptyDir)(f),await(0,fs_extra_2.ensureDir)(f),await(0,fs_extra_2.copy)(n,f),(0,path_1.join)(a.paths.dir,"src"));if(await(0,fs_extra_2.emptyDir)((0,path_1.join)(i,"ets/cocos/src")),await(0,fs_extra_2.emptyDir)((0,path_1.join)(i,"ets/cocos/assets")),await(0,fs_extra_2.copy)(a.paths.applicationJS,(0,path_1.join)(i,"ets/cocos",(0,path_1.basename)(a.paths.applicationJS))),await(0,fs_extra_2.copy)(n,(0,path_1.join)(i,"ets/cocos/src")),r){var l=(0,path_1.join)(i,"ets/cocos");for(const w of["jsb-adapter","src"]){var d=(0,path_1.join)(l,w),m=(0,path_1.join)(_,w);await(0,fs_extra_2.ensureDir)(m),await(0,fs_extra_2.emptyDir)(m),await(0,fs_extra_2.copy)(d,m),await(0,fs_extra_1.rm)(d,{force:!0,recursive:!0})}var n=(0,path_1.join)(a.paths.dir,"main.js"),y=(0,path_1.join)(_,"main.js");await(0,fs_extra_2.copy)(n,y)}else this.bundleManager.bundles.forEach(e=>{e.isRemote||((0,fs_extra_2.moveSync)((0,path_1.join)(f,e.name,(0,path_1.basename)(e.scriptDest)),(0,path_1.join)(i,"ets/cocos/assets",e.name,(0,path_1.basename)(e.scriptDest))),t.sourceMaps&&(0,fs_extra_2.moveSync)((0,path_1.join)(f,e.name,"index.js.map"),(0,path_1.join)(i,"ets/cocos/assets",e.name,"index.js.map")))}),(0,fs_extra_1.existsSync)(o)&&(await(0,fs_extra_2.ensureDir)(u),await(0,fs_extra_2.emptyDir)(u),await(0,fs_extra_2.copy)(o,u),await(0,fs_extra_1.rm)(o,{force:!0,recursive:!0})),(0,fs_extra_1.existsSync)(c)&&await(0,fs_extra_2.copy)(c,h);const j=[];this.bundleManager.bundles.forEach(e=>{e.isRemote||j.push(e.name+"/"+(0,path_1.basename)(e.scriptDest))});var x=[];for(const k in a.paths.plugins){var g=a.paths.plugins[k],g=(0,path_1.relative)(a.paths.dir,g);x.push(g.split("\\").join("/"))}n=t.engineInfo,y=(0,path_1.join)(n.typescript.path,"templates/openharmony/entry/src/main/ets/cocos/game.ts"),u=(0,path_1.join)(i,"ets/cocos/game.ts");let S=(0,fs_extra_2.readdirSync)(a.paths.engineDir);S=S.filter(e=>!(0,fs_extra_1.statSync)((0,path_1.join)(a.paths.engineDir,e)).isDirectory());o=a.importMap.imports.cc.slice(2),c={importMapUrl:(0,path_1.basename)(a.paths.importMap),applicationUrl:(0,path_1.basename)(a.paths.applicationJS),systemBundleUrl:(0,path_1.basename)(a.paths.systemJs),ccUrls:S,systemCCUrl:o,bundleJsList:j,pluginsJsList:x,chunkBundleUrl:"",useAotOptimization:s},(0,fs_extra_1.existsSync)((0,path_1.join)(a.paths.dir,"src/chunks"))&&(h=(0,fs_extra_2.readdirSync)((0,path_1.join)(a.paths.dir,"src/chunks")).find(e=>e.startsWith("bundle")&&e.endsWith(".js")))&&(c.chunkBundleUrl=h),(0,fs_extra_2.writeFileSync)(u,await ejs_1.default.renderFile(y,c),"utf8"),o=(0,path_1.join)(n.typescript.path,"templates/openharmony/entry/src/main/ets/workers/cocos_worker.ts"),h=(0,path_1.join)(i,"ets/workers/cocos_worker.ts"),u={useV8:r},(0,fs_extra_2.writeFileSync)(h,await ejs_1.default.renderFile(o,u),"utf8"),y=(0,path_1.join)(p,"build-profile.json5"),c=json5_1.default.parse((0,fs_extra_1.readFileSync)(y,"utf8"));c.buildOption.compileMode=s?"esmodule":"jsbundle",(0,fs_extra_2.writeFileSync)(y,json5_1.default.stringify(c,null,2))}async function getBrowserslistQuery(e){e=(0,path_1.join)(e,".browserslistrc");let t;try{t=await(0,fs_extra_2.readFile)(e,"utf8")}catch(e){return}e=function(e){var t=[];for(const s of e.split("\n")){var a=s.indexOf("#"),a=(a<0?s:s.substr(0,a)).trim();0!==a.length&&t.push(a)}return t}(t);if(0!==e.length)return e.join(" or ")}function checkSDKEnv(e){e=e.packages.openharmony;if(!process.env.OHOS_SDK_HOME&&!e.sdkPath)throw new Error(Editor.I18n.t("openharmony.tips.ohos_sdk_error"));process.env.OHOS_SDK_HOME?e.sdkPath=process.env.OHOS_SDK_HOME:process.env.OHOS_SDK_HOME=e.sdkPath}exports.throwError=!0,exports.onBeforeBuild=onBeforeBuild,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onAfterBuild=onAfterBuild;