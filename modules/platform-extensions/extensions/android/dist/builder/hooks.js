"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),options_1=require("./options"),os_1=require("os");async function generateOptions(e){var e=e.packages.android,a=(e.orientation=e.orientation||{},await Editor.Message.request("program","query-program-info","androidSDK")),t=await Editor.Message.request("program","query-program-info","androidNDK"),r=await Editor.Message.request("program","query-program-info","javaHome");if(e.sdkPath=a?a.path:"",e.ndkPath=t?t.path:"",e.javaHome=r?r.path:"",e.javaPath="",e.javaHome)try{var o,n,s=(0,fs_extra_1.statSync)(e.javaHome);s.isFile()?(e.javaPath=e.javaHome,e.javaHome=(0,path_1.normalize)((0,path_1.join)((0,path_1.dirname)(e.javaPath),".."))):s.isDirectory()&&(o="win32"===(0,os_1.platform)()?"java.exe":"java",n=(0,path_1.join)(e.javaHome,"bin",o),(0,fs_extra_1.existsSync)(n)?e.javaPath=n:console.error(`Java executable not found at ${e.javaHome}/bin`))}catch(e){console.error(e)}if(e.sdkPath&&e.ndkPath)return{packageName:e.packageName||"",resizeableActivity:null==(a=e.resizeableActivity)||a,maxAspectRatio:null!=(t=e.maxAspectRatio)?t:"2.4",orientation:{landscapeRight:null==(r=e.orientation.landscapeRight)||r,landscapeLeft:null==(s=e.orientation.landscapeLeft)||s,portrait:null!=(o=e.orientation.portrait)&&o,upsideDown:null!=(n=e.orientation.upsideDown)&&n},apiLevel:e.apiLevel,appABIs:e.appABIs||[],useDebugKeystore:e.useDebugKeystore,keystorePath:e.keystorePath||"",keystorePassword:e.keystorePassword||"",keystoreAlias:e.keystoreAlias||"",keystoreAliasPassword:e.keystoreAliasPassword||"",appBundle:null!=(a=e.appBundle)&&a,androidInstant:null!=(t=e.androidInstant)&&t,inputSDK:null!=(r=e.inputSDK)&&r,remoteUrl:e.remoteUrl||"",sdkPath:e.sdkPath||"",ndkPath:e.ndkPath||"",javaHome:e.javaHome||"",javaPath:e.javaPath||"",swappy:e.swappy||!1,renderBackEnd:{vulkan:null==(o=null==(s=e.renderBackEnd)?void 0:s.vulkan)||o,gles3:null==(a=null==(n=e.renderBackEnd)?void 0:n.gles3)||a,gles2:null==(r=null==(t=e.renderBackEnd)?void 0:t.gles2)||r}};throw new Error(Editor.I18n.t("android.tips.android_sdk_error"))}async function onAfterInit(e,a,t){var r=await generateOptions(e);const o=(e.packages.android=r).renderBackEnd;a.staticsInfo.B100005=r.packageName,a.staticsInfo.B100011=r.orientation;var n=await(0,options_1.checkAndroidAPILevels)(r.apiLevel,e);n.error&&(console.error(n.error),n.newValue)&&(r.apiLevel=n.newValue),Editor.Metrics.trackEvent({category:"Project",action:"Rendering Backend",label:"Vulkan",value:e.packages.android.renderBackEnd.vulkan?100:0}),r.useDebugKeystore&&(r.keystorePath=(0,path_1.join)(Editor.App.path,"../tools/keystore/debug.keystore"),r.keystoreAlias="debug_keystore",r.keystorePassword="123456",r.keystoreAliasPassword="123456"),Object.assign(a.compileOptions.platformParams,r),o&&Object.keys(o).forEach(e=>{a.compileOptions.cMakeConfig["CC_USE_"+e.toUpperCase()]=o[e]}),a.compileOptions.cMakeConfig.CC_ENABLE_SWAPPY=!!r.swappy,await(0,fs_extra_1.outputJSON)(a.paths.compileConfig,a.compileOptions)}function onAfterBundleInit(e){var a,t=e.packages.android.renderBackEnd;e.assetSerializeOptions["cc.EffectAsset"].glsl1=null==(a=t.gles2)||a,e.assetSerializeOptions["cc.EffectAsset"].glsl3=null==(a=t.gles3)||a,e.assetSerializeOptions["cc.EffectAsset"].glsl4=null==(a=t.vulkan)||a,e.buildScriptParam.platform="ANDROID"}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit;