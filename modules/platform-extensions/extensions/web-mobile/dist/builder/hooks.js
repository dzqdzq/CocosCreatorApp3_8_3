"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onBeforeCopyBuildTemplate=exports.onBeforeCompressSettings=exports.onAfterBundleInit=exports.onAfterInit=exports.throwError=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path");async function onAfterInit(e,t,i){var s=e.packages["web-mobile"];t.staticsInfo.orientation=s.orientation,e.buildEngineParam.split=!1,e.buildEngineParam.assetURLFormat="runtime-resolved",e.server&&!e.server.endsWith("/")&&(e.server+="/")}function onAfterBundleInit(e){e.buildScriptParam.system={preset:"web"},e.buildScriptParam.platform="HTML5";var t=e.packages["web-mobile"].useWebGPU;(e.buildScriptParam.flags.WEBGPU=t)&&(e.assetSerializeOptions["cc.EffectAsset"].glsl4=!0)}async function onBeforeCompressSettings(e,i,t){i.paths.dir&&(e=e.packages["web-mobile"],i.settings.screen.orientation=e.orientation,i.settings.plugins.jsList.forEach((e,t)=>{i.settings.plugins.jsList[t]=e.split("/").map(encodeURIComponent).join("/")}))}async function onBeforeCopyBuildTemplate(e,t){var i=(0,path_1.join)(e.engineInfo.typescript.builtin,"templates/web-mobile"),s=e.packages["web-mobile"],n=(0,path_1.join)(t.paths.dir,"style.css");this.buildTemplate.findFile("style.css")||(0,fs_extra_1.copyFileSync)((0,path_1.join)(i,"style.css"),n);let r="";s.embedWebDebugger&&(s=(0,path_1.join)(t.paths.dir,"vconsole.min.js"),this.buildTemplate.findFile("vconsole.min.js")||((0,fs_extra_1.copyFileSync)((0,path_1.join)(i,"vconsole.min.js"),s),e.md5CacheOptions.excludes.push(s)),r="./vconsole.min.js");s=this.buildTemplate.initUrl("index.js.ejs","indexJs")||(0,path_1.join)(i,"index.js.ejs"),s=await ejs_1.default.renderFile(s,{applicationJS:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)}),s=await Build.Utils.transformCode(s,{importMapFormat:"systemjs"});if(!s)throw new Error("Cannot generate index.js");var a=(0,path_1.join)(t.paths.dir,"index.js"),s=(t.paths.indexJs=a,(0,fs_extra_1.outputFileSync)(a,s,"utf8"),this.buildTemplate.initUrl("index.ejs")||(0,path_1.join)(i,"index.ejs")),i={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),projectName:e.name,engineName:e.buildEngineParam.engineName,webDebuggerSrc:r,cocosTemplate:(0,path_1.join)(i,"index-plugin.ejs"),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),indexJsName:(0,path_1.basename)(a),cssUrl:(0,path_1.basename)(n)},a=await ejs_1.default.renderFile(s,i);t.paths.indexHTML=(0,path_1.join)(t.paths.dir,"index.html"),(0,fs_extra_1.outputFileSync)(t.paths.indexHTML,a,"utf8"),e.md5CacheOptions.replaceOnly.push(t.paths.indexHTML),Editor.Message.request("web-mobile","set-preview-path",t.paths.dir)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate;