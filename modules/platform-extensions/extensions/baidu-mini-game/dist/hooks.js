"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),globby=require("globby"),OPEN_DATA_CONTEXT_ROOT="openDataContext";async function onAfterInit(e,t,a){e.polyfills&&(e.polyfills.asyncFunctions=!1);var i=e.packages["baidu-mini-game"],s=(-1!==e.includeModules.indexOf("gfx-webgl2")&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.assetSerializeOptions.exportCCON=!0,e.moveRemoteBundleScript=!0,e.server&&!e.server.endsWith("/")&&(e.server+="/"),Object.assign(e.buildEngineParam,{platform:"BAIDU"}),e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},path_1.join(t.paths.dir,OPEN_DATA_CONTEXT_ROOT)),n=path_1.join(Editor.Project.tmpDir,"builder/baidu-mini-game",OPEN_DATA_CONTEXT_ROOT),e=(fs_extra_1.existsSync(s)&&(fs_extra_1.existsSync(n)&&fs_extra_1.removeSync(n),fs_extra_1.copySync(s,n)),{orientation:i.orientation,appid:i.appid,remoteServerAddress:e.server});a.__addStaticsInfo(e),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),fs_extra_1.existsSync(n)?fs_extra_1.moveSync(n,s):i.buildOpenDataContextTemplate&&(a=(await Editor.Message.request("engine","query-engine-info")).typescript.path,e=path_1.join(a,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT),fs_extra_1.copySync(e,s))}async function onBeforeCompressSettings(e,t,a){t.paths.dir&&(sortSubPackage(e,t,a),a=(await Editor.Message.request("engine","query-engine-info")).typescript.path,await fs_extra_1.copy(path_1.join(a,"bin/adapter/minigame/baidu",`web-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"web-adapter.js")),await fs_extra_1.copy(path_1.join(a,"bin/adapter/minigame/baidu",`engine-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"engine-adapter.js")))}async function onAfterBuild(e,t,a){var i=await Build.Utils.getModuleFiles(t);await Promise.all(i.map(attachSystemGlobal)),await copyResFiles(e,t)}function sortSubPackage(e,t,a){for(const i of t.bundles)fs_extra_1.existsSync(i.scriptDest)?attachSystemGlobal(i.scriptDest):fs_extra_1.outputFileSync(i.scriptDest,"")}async function copyResFiles(e,t){e.packages["baidu-mini-game"];var a=e.buildEngineParam.engineName,i=(await Editor.Message.request("engine","query-engine-info")).typescript.path,i=path_1.join(i,"templates/baidu-mini-game"),s=path_1.join(i,"game.ejs"),a={engineName:a,polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},s=await ejs_1.default.renderFile(s,a),a=(fs_extra_1.writeFileSync(path_1.join(t.paths.dir,"game.js"),s,"utf8"),path_1.join(Build.buildTemplateDir,e.platform));fs_extra_1.existsSync(a)&&(fs_extra_1.copySync(a,t.paths.dir),console.debug(`Use build-template {link(${a})}.`)),buildGameJson(i,t.paths.dir,e,t,a),buildProjectJson(i,t.paths.dir,e,a)}function buildGameJson(e,t,a,i,s){var a=a.packages["baidu-mini-game"],e=fs_extra_1.readJSONSync(path_1.join(e,"game.json")),n=(e.deviceOrientation=a.orientation,a.buildOpenDataContextTemplate?e.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete e.openDataContext,[]);for(const r of i.bundles)r.isSubpackage&&n.push({name:r.name,root:`subpackages/${r.name}/`});0<n.length&&(e.subpackages=n);a=path_1.join(s,"game.json"),fs_extra_1.existsSync(a)&&(i=fs_extra_1.readJSONSync(a),Object.assign(e,i)),s=path_1.join(t,"game.json");fs_extra_1.outputJSONSync(s,e,{spaces:4})}function buildProjectJson(e,t,a,i){e=fs_extra_1.readJSONSync(path_1.join(e,"project.swan.json")),e.appid=a.packages["baidu-mini-game"].appid||"testappid",e.projectname=a.name,a=path_1.join(t,"project.swan.json"),t=path_1.join(i,"project.swan.json");fs_extra_1.existsSync(t)&&(i=fs_extra_1.readJSONSync(t),Object.assign(e,i)),fs_extra_1.outputJSONSync(a,e)}function attachSystemGlobal(e){fs_extra_1.existsSync(e)&&!fs_extra_1.statSync(e).isDirectory()&&fs_extra_1.writeFileSync(e,"var System=window.System;"+fs_extra_1.readFileSync(e,"utf8"))}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;