"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.onAfterCopyBuildTemplate=exports.onBeforeCopyBuildTemplate=exports.onBeforeCompressSettings=exports.onAfterBundleBuildTask=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),child_process_1=require("child_process"),share_1=require("./share"),glob=require("globby"),globby=require("globby"),path=require("path"),iconv=require("iconv-lite");async function onAfterInit(e,t,a){var s,r=e.packages.wechatprogram;e.server&&!e.server.endsWith("/")&&(e.server+="/"),Object.assign(e.buildEngineParam,{platform:"WECHAT_MINI_PROGRAM",sourceMaps:e.sourceMaps,split:!0,skip:!1}),e.buildEngineParam.assetURLFormat="relative-from-out",e.useSplashScreen&&(s=await Editor.Profile.getProject("builder","splash-setting.logo.image"))&&!await validRatio(Editor.UI.__protected__.File.resolveToRaw(s))&&console.error("The splash screen image is too large for wechatprogram!"),t.staticsInfo.B100011=r.orientation,t.staticsInfo.B100013=r.appid,share_1.Paths.internalTemplateDir=(0,path_1.join)(e.engineInfo.typescript.path,"templates/wechatprogram")}function onBeforeBundleInit(e){e.moveRemoteBundleScript=!0,e.polyfills&&(e.polyfills.asyncFunctions=!1),e.buildScriptParam.platform="WECHAT_MINI_PROGRAM",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.assetSerializeOptions.exportCCON=!0}function validRatio(s){return new Promise((e,t)=>{const a=new Image;a.src="data:image/png;base64,"+(0,fs_extra_1.readFileSync)(s).toString("base64"),a.onload=function(){(2048<a.width||2048<a.height)&&e(!1),e(!0)},a.onerror=function(e){t(e)}})}async function onAfterBundleBuildTask(e,t,a){await sortSubPackage(t)}async function onBeforeCompressSettings(e,t,a){t.paths.dir&&(t.settings.scripting.scriptPackages=t.scriptPackages.map(e=>"project://"+(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/")))}async function onBeforeCopyBuildTemplate(e,t,a,s){var r=e.engineInfo.typescript.path;for(const i of["web-adapter","engine-adapter"])await(0,fs_extra_1.copy)((0,path_1.join)(r,"bin/adapter/minigame/wechat",`${i}.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,i+".js"));await _buildWeChatTemplate.call(this,e,t),await postHandleScript(e,t,a)}async function onAfterCopyBuildTemplate(e,t){await buildGameJson(t.paths.dir,e,this.bundleManager.bundles,this.buildTemplate.findFile("game.json")),buildProjectConfig(t.paths.dir,e,this.buildTemplate.findFile("project.config.json"))}async function postHandleScript(t,s,e){const r=t.debug?"\n":"";let i="var GameGlobal = getApp().GameGlobal, window = global = globalThis = getApp().GameGlobal, WebAssembly = WXWebAssembly;"+r;["__globalAdapter","cc","System","document","HTMLElement","HTMLImageElement","HTMLCanvasElement","performance","Image","ImageBitmap","fsUtils","XMLHttpRequest","WebSocket"].forEach(e=>{i+=`var ${e} = GameGlobal.${e};`+r}),i=(i=(i+="var DOMParser = globalThis.DOMParser = GameGlobal.DOMParser;"+r)+"var requestAnimationFrame = GameGlobal.canvas.requestAnimationFrame;"+r)+"var cancelAnimationFrame = GameGlobal.canvas.cancelAnimationFrame;"+r;t=t.packages.wechatprogram.globalVariable;t&&t.split(",").map(e=>e.trim()).forEach(e=>{i+=`var ${e} = globalThis.${e};`+r});const a=s.paths.dir;(await globby(["engine-adapter.js","web-adapter.js","assets/**/index.js","src/assets/**/*.js","src/chunks/*.js","src/bundle-scripts/**/index.js","!src/chunks/bundle.js"],{cwd:a})).map(e=>path.resolve(a,e)).forEach(e=>{var t=(0,fs_extra_1.readFileSync)(e,"utf8"),t=i+t;(0,fs_extra_1.writeFileSync)(e,t,"utf8")});var t="const global = getApp().GameGlobal;"+r,n=(0,path_1.join)(s.paths.dir,"src/system.bundle.js"),t=t+(0,fs_extra_1.readFileSync)(n,"utf8");(0,fs_extra_1.writeFileSync)(n,t,"utf8");n=(await globby(["cocos-js/*.js"],{cwd:a})).map(e=>path.resolve(a,e));const o=/System\.register\((\[.*?\].*?\{)/g;n.forEach(e=>{var t=(0,path_1.relative)(s.paths.dir,e).replace(/\\/g,"/");let a=(0,fs_extra_1.readFileSync)(e,"utf8");o.test(a)&&(console.log("register:"+t),a=a.replace(o,`getApp().GameGlobal.System.register('no-schema:/${t}', $1`+r+i),(0,fs_extra_1.writeFileSync)(e,a,"utf8"))});let p="";n.forEach(e=>{e=(0,path_1.relative)(s.paths.dir,e).replace(/\\/g,"/");p+=`    .then(()=>require.async('subpackages/cocos-js/${(0,path_1.basename)(e,".js")}/index.js'))
`});(await globby(["src/chunks/*.js"],{cwd:a})).map(e=>path.resolve(a,e)).forEach(e=>{e=(0,path_1.relative)(s.paths.dir,e).replace(/\\/g,"/");p+=`    .then(()=>require.async('./${e}'))
`});p="export function loadModules() {\n    return Promise.resolve()\n"+p+"}",(0,fs_extra_1.outputFileSync)((0,path_1.join)(s.paths.dir,"load-module.js"),p,{encoding:"utf8"});const l=(0,fs_extra_1.readJSONSync)((0,path_1.join)(s.paths.dir,"app.json"));n.forEach(e=>{e=(0,path_1.relative)(s.paths.dir,e).replace(/\\/g,"/");l.subPackages.push({root:"subpackages/cocos-js/"+(0,path_1.basename)(e,".js"),pages:["index"]})});t=(0,path_1.join)(s.paths.dir,"app.json"),(0,fs_extra_1.outputJSONSync)(t,l,{spaces:4}),n.forEach(e=>{var t=(0,path_1.relative)(s.paths.dir,e).replace(/\\/g,"/"),a=t.substring(0,t.indexOf(".")),a=((0,fs_extra_1.ensureDirSync)((0,path_1.join)(s.paths.dir,"subpackages/"+a)),(0,path_1.join)(s.paths.dir,`subpackages/${a}/index.js`));(0,fs_extra_1.moveSync)(e,a,{overwrite:!0});e=`console.log('加载 ${t} 分包');
`+(0,fs_extra_1.readFileSync)(a,"utf8");(0,fs_extra_1.writeFileSync)(a,e,"utf8")}),t=(0,path_1.join)(s.paths.dir,"application.js");if((0,fs_extra_1.existsSync)(t)){let e=(0,fs_extra_1.readFileSync)(t,"utf8");o.test(e)&&(e=e.replace(o,'getApp().GameGlobal.System.register("no-schema:/application.js", $1'+r+i)),(0,fs_extra_1.writeFileSync)(t,e,"utf8")}n=(0,path_1.join)(s.paths.dir,"src/chunks/bundle.js");if((0,fs_extra_1.existsSync)(n)){let e=(0,fs_extra_1.readFileSync)(n,"utf8");o.test(e)&&(e=e.replace(o,'getApp().GameGlobal.System.register("project://src/chunks/bundle.js", $1'+r+i)),(0,fs_extra_1.writeFileSync)(n,e,"utf8")}}function sortSubPackage(e){for(const a of e){var t;a.isSubpackage&&(t=(0,path_1.join)((0,path_1.dirname)(a.scriptDest),"game.js"),(0,fs_extra_1.existsSync)(a.scriptDest)?(0,fs_extra_1.renameSync)(a.scriptDest,t):(0,fs_extra_1.outputFileSync)(t,`console.log('${name}: no script in subPackage.')`,"utf8"),a.scriptDest=t)}}async function _buildWeChatTemplate(e,a){var t,s,r;this.buildTemplate.findFile("game.js")||(t=this.buildTemplate.initUrl("game.ejs")||(0,path_1.join)(share_1.Paths.internalTemplateDir,"game.ejs"),s=null==(s=a.settings.engine.macros)?void 0:s.ENABLE_TRANSPARENT_CANVAS,r=null==(r=a.settings.engine.macros)?void 0:r.ENABLE_WEBGL_ANTIALIAS,s={engineName:e.buildEngineParam.engineName,cocosTemplate:(0,path_1.join)(share_1.Paths.internalTemplateDir,"cocos-script.ejs"),polyfillsBundleFile:a.paths.polyfillsJs&&Build.Utils.relativeUrl(a.paths.dir,a.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(a.paths.dir,a.paths.systemJs),importMapFile:Build.Utils.relativeUrl(a.paths.dir,a.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(a.paths.dir,a.paths.applicationJS),engineDir:Build.Utils.relativeUrl(a.paths.dir,a.paths.engineDir),alpha:void 0===s?"default":s,antialias:void 0===r?"default":r,useWebgl2:e.buildEngineParam.includeModules.includes("gfx-webgl2")},r=await ejs_1.default.renderFile(t,s),(0,fs_extra_1.writeFileSync)((0,path_1.join)(a.paths.dir,"game.js"),r,"utf8"),e.md5CacheOptions.replaceOnly.push((0,path_1.join)(a.paths.dir,"game.js"))),glob.sync(["*","!splash.png","!first-screen.js"],{cwd:share_1.Paths.internalTemplateDir}).map(e=>path.resolve(share_1.Paths.internalTemplateDir,e)).forEach(e=>{var t;(0,fs_extra_1.statSync)(e).isFile()&&(t=(0,path_1.relative)(share_1.Paths.internalTemplateDir,e),e=(0,fs_extra_1.readFileSync)(e,"utf8"),(0,fs_extra_1.outputFileSync)((0,path_1.join)(a.paths.dir,t),e,{encoding:"utf8"}))}),this.buildTemplate.findFile("splash.png")||(0,fs_extra_1.copyFileSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"splash.png"),(0,path_1.join)(a.paths.dir,"splash.png")),this.buildTemplate.findFile("first-screen.js")&&(0,fs_extra_1.copyFileSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"first-screen.js"),(0,path_1.join)(a.paths.dir,"first-screen.js")),(0,fs_extra_1.copyFileSync)((0,path_1.join)(a.paths.dir,"game.js"),(0,path_1.join)(a.paths.dir,"index.js")),e.md5CacheOptions.replaceOnly.push((0,path_1.join)(a.paths.dir,"index.js"))}function buildProjectConfig(e,t,a){var s=t.packages.wechatprogram,r=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"project.config.json")),a=(a&&(a=(0,fs_extra_1.readJSONSync)(a),Object.assign(r,a)),r.appid=s.appid||"wx2c815291f1aa4d1c",r.projectname=t.name,t.server&&t.useBuiltinServer&&(r.packOptions={ignore:[{type:"folder",value:"remote"}]}),(0,path_1.join)(e,"project.config.json"));t.md5CacheOptions.excludes.push(a),(0,fs_extra_1.outputJSONSync)(a,r)}async function buildGameJson(e,t,a,s){var t=t.packages.wechatprogram,r=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"game.json")),i=(s&&(s=(0,fs_extra_1.readJSONSync)(s),Object.assign(r,s)),r.deviceOrientation=t.orientation,[]);for(const n of a)n.isSubpackage&&i.push({name:n.name,root:`subpackages/${n.name}/`});0<i.length&&(r.subpackages=i);s=(0,path_1.join)(e,"game.json"),(0,fs_extra_1.outputJSONSync)(s,r,{spaces:4}),a=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"app.json")),a.window.pageOrientation=t.orientation,s=(0,path_1.join)(e,"app.json");(0,fs_extra_1.outputJSONSync)(s,a,{spaces:4})}async function run(e,t){var a=e.match(/([`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、])/im),a=(a&&console.warn(Editor.I18n.t("wechatprogram.tips.build_path_contains_symbol",{symbol:a[1]})),await Editor.Message.request("program","query-program-info","wechatDevtools"));let s=a?a.path:"";if(!s||!(0,fs_extra_1.existsSync)(s))return console.warn(""+Editor.I18n.t("wechatprogram.tips.wechatprogram_app_path_empty",{wechatprogramPath:s})),1===(await Editor.Dialog.warn(Editor.I18n.t("wechatprogram.tips.wechatprogram_app_path_empty"),{buttons:["Cancel","Set Wechat DevTools"]})).response&&Editor.Message.send("preferences","open-settings","program"),!1;(0,fs_extra_1.statSync)(s).isDirectory()||"win32"!==process.platform||(s=(0,path_1.dirname)(s));let r;if("darwin"===process.platform?(r=(0,path_1.join)(s,"Contents/Resources/app.nw/bin/cli"),(0,fs_extra_1.existsSync)(r)||(r=(0,path_1.join)(s,"Contents/MacOS/cli"))):r=(0,path_1.join)(s,"cli.bat"),!(0,fs_extra_1.existsSync)(r))return await Editor.Dialog.error(Editor.I18n.t("wechatprogram.options.client_path_error")),!1;a=["-o",e,"-f","cocos"],console.log("Run command : "+a.join(" ")),e=(0,child_process_1.spawn)(r,a);e&&e.stdout&&e.stdout.on("data",function(e){console.log("[WeChat Dev Tool] "+iconv.decode(e,"utf8").toString())}),e&&e.stderr&&e.stderr.on("data",function(e){console.error("[WeChat Dev Tool]"+iconv.decode(e,"utf8").toString())})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterCopyBuildTemplate=onAfterCopyBuildTemplate,exports.run=run;