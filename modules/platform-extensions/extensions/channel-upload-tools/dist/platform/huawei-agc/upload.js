"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs_extra_1=require("fs-extra"),path_1=require("path"),Constant=require("./const"),Http=require("./lib/http");let comp;module.exports={platform:Constant.PLATFORM,name:Constant.PLATFORM+"-upload",template:(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../static",`platform/${Constant.PLATFORM}/upload.html`),"utf8"),props:["info","compName"],async created(){const e=this,n=(global.xxxx=this,(comp=e)._registerEvent(),await Editor.Profile.getConfig(Constant.PLATFORM,"config")||{});n&&Object.keys(e.config).forEach(t=>{var o=n[t];o&&(e.config[t]=o)}),e.config.loginType===Constant.LOGIN_TYPE.oauth&&await e.checkNeedLogin()},computed:{oAuth(){return this.config.loginType===Constant.LOGIN_TYPE.oauth},showLoginBtn(){return this.oAuth&&this.needLogin},isLogin(){return!this.needLogin&&this.oAuth}},data:function(){return{config:{loginType:Constant.LOGIN_TYPE.oauth,clientId:"",clientSecret:"",appid:"",version:"1.0",apkPath:"",description:""},page:this.compName,loginChecked:!1,loading:!1,needLogin:!0,accessToken:"",loginType:[{type:Constant.LOGIN_TYPE.oauth,name:this.t("oauth")},{type:Constant.LOGIN_TYPE.client,name:this.t("client")}]}},watch:{page:function(t){comp.$emit("update:compName",t)},info(t){comp.$emit("update:info",t)},async"config.loginType"(t){t!==Constant.LOGIN_TYPE.oauth||comp.loginChecked||await comp.checkNeedLogin()},config:{async handler(t){var o=await Editor.Profile.getConfig(Constant.PLATFORM,"config")||{},o=Object.assign(o,t);Editor.Profile.setConfig(Constant.PLATFORM,"config",o,"local")},deep:!0}},methods:{oauthTypeChange(t){this.config.loginType=t.target.value},async checkNeedLogin(){var t=this;await Editor.User.isLoggedIn()?(t.loading=!0,t.needLogin=await Http.needLogin(),t.loading=!1,t.loginChecked=!0):t.popupWarns(comp.t("need_login"))},_registerEvent(){var t=this;t.$root.$on("loginResult",t.updateLoginResult),t.$root.$on("oAuthWindowClose",t.oAuthWindowClose)},async updateLoginResult(t,o){var e=this;t===module.exports.platform&&"success"===o&&(e.needLogin=await Http.needLogin(),e.accessToken=await Http.getOAuthToken(),e.loading=!1)},async oAuthWindowClose(){comp.needLogin=await Http.needLogin(),comp.loading=!1},async onChooseDistPathClick(t){t.stopPropagation()},async onUpdateValue(t,o){t.stopPropagation(),comp.config[o]=t.target.value},cancelClick(){Editor.Panel.close("channel-upload-tools")},popupWarns(t){return Editor.Dialog.warn(t,{title:comp.t("notice_title"),buttons:[comp.t("confirm")],default:-1,cancel:-1})},async oauthClick(){if(comp.loading=!0,!await Editor.User.isLoggedIn())return comp.loading=!1,comp.popupWarns(comp.t("need_login"));var t=await Http.getOAuthUrl();t?Editor.Panel.open("channel-upload-tools.oauth",{platform:Constant.PLATFORM,url:t.url,redirect:t.redirect,method:"loginResult"}):console.error("Get OAuth url fail, please retry")},async uploadClick(){var t=this;t.oAuth||t.config.clientId?t.oAuth||t.config.clientSecret?t.config.appid?t.config.version?t.config.apkPath&&(0,fs_extra_1.existsSync)((0,path_1.normalize)(t.config.apkPath))?t.oAuth&&t.needLogin?0===(await t.popupWarns(t.t("need_huawei_login"))).response&&t.oauthClick():(t.info.config=t.config,t.page=Constant.PLATFORM+"-upload-list"):t.popupWarns(t.t("need_apk")):t.popupWarns(t.t("need_version")):t.popupWarns(t.t("need_appid")):t.popupWarns(t.t("need_client_secret")):t.popupWarns(t.t("need_clientid"))},async logoutClick(){comp.loading=!0;try{await Http.logout(),await comp.checkNeedLogin()}catch(t){}comp.loading=!1},t(t){return Editor.I18n.t("channel-upload-tools."+t)}}};