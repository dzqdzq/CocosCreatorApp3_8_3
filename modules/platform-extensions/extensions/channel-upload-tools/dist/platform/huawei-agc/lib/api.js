"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.API=void 0;const fs_extra_1=require("fs-extra"),Network=require("../../../utils/network"),Constant=require("../const"),MAX_APK_SIZE=4294967296,{AuditInfo,AppInfo,ErrorCode,AccessTokenRet,AppInfoRet,UploadUrlRet,UploadRet,UpdateAPKRet}=require("./entity");class API{constructor(e,r,t){this.loginType=e,this.accessToken=r,e===Constant.LOGIN_TYPE.client&&(this.clientID=t)}get oAuthLogin(){return this.loginType===Constant.LOGIN_TYPE.oauth}genHeader(){var e={};return this.oAuthLogin?e.oauth2Token=this.accessToken:(e.Authorization="Bearer "+this.accessToken,e.client_id=this.clientID),e}static async getAccessToken(e,r){var t=new AccessTokenRet,s=API.HOST+"/api/oauth2/v1/token",e={grant_type:"client_credentials",client_id:e,client_secret:r};try{var o=await Network.postAsync(s,JSON.stringify(e));(o=JSON.parse(o)).access_token&&(t.code=ErrorCode.success,t.accessToken=o.access_token)}catch(e){t.errorMessage=e}return t}async queryAppInfo(e){var r=new AppInfoRet,t=API.HOST+"/api/publish/v2/app-info",e={appId:e};try{var s=await Network.getAsync(t,e,this.genHeader());0===(s=JSON.parse(s)).ret.code&&(r.code=ErrorCode.success,s.appInfo=new AppInfo(s.appInfo),s.auditInfo=new AuditInfo(s.auditInfo))}catch(e){r.errorMessage=e}return r}async getUploadUrl(e,r){var t=new UploadUrlRet,s=API.HOST+"/api/publish/v2/upload-url",e={appId:e,suffix:r||"apk"};try{var o=await Network.getAsync(s,e,this.genHeader());(o=JSON.parse(o)).uploadUrl&&(t.code=ErrorCode.success,t.uploadUrl=o.uploadUrl,o.chunkUploadUrl&&(t.chunkUploadUrl=o.chunkUploadUrl),t.authCode=o.authCode)}catch(e){t.errorMessage=e}return t}async uploadFile(e,r,t){var s=new UploadRet;if((0,fs_extra_1.existsSync)(r))if((0,fs_extra_1.statSync)(r).size>MAX_APK_SIZE)s.code=ErrorCode.fileTooLarge;else try{var o=await Network.uploadFile(e,r,t);(o=(o=JSON.parse(o)).result).UploadFileRsp&&o.UploadFileRsp.ifSuccess&&(s.code=ErrorCode.success,s.files=o.UploadFileRsp.fileInfoList.map(e=>({fileDestUrl:e.fileDestUlr,size:e.size})))}catch(e){s.errorMessage=e}else s.code=ErrorCode.fileNotExists;return s}async updateApkInfo(e,r,t,s=1){var o=new UpdateAPKRet,a=API.HOST+"/api/publish/v2/app-file-info";try{var n={appId:e,releaseType:s},i={fileType:5,files:[{fileName:r,fileDestUrl:t}]},c=await Network.putAsync(a,n,this.genHeader(),JSON.stringify(i));0===(c=JSON.parse(c).ret).code?o.code=ErrorCode.success:o.errorMessage=c.msg}catch(e){o.errorMessage=e}return o}}(exports.API=API).HOST="https://connect-api.cloud.huawei.com";