"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.style=exports.template=void 0;const readFileSync=require("fs")["readFileSync"],join=require("path")["join"],Vue=require("vue/dist/vue.js");let panel=null,vm;Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.template=readFileSync(join(__dirname,"../static/index.html"),"utf8"),exports.style=readFileSync(join(__dirname,"../dist/index.css"),"utf8"),exports.$={certificate:"#certificate"},exports.methods={};const ready=async function(e){panel=this,vm=new Vue({el:panel.$.certificate,data:{platform:e,settings:{country:"CN",state:"福建省",locality:"厦门市",organization:"",organizationalUnit:"",commonName:"",email:"",certificatePath:""},saveBtnState:!1,saveBtnDisabled:!1,generateSuccess:!1,verifyResult:{country:void 0,state:void 0,locality:void 0,organization:void 0,organizationalUnit:void 0,commonName:void 0,email:void 0,certificatePath:void 0},verifyFuncMap:{certificatePath(e){let t="";return t=Editor.Utils.Path.contains(join(Editor.Project.path,"./build"),e)?"i18n:certificate.certificatePath_error":t},country(e){let t="";return t=/^[A-Z]{2}$/.test(e)?t:"i18n:certificate.country_error"},email(e){let t="";return t=/^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,})$/.test(e)?t:"i18n:certificate.email_error"}}},async mounted(){this.netStatus="success",await this.initData()},methods:{onChange(t){var i,t=t.target,s=t.getAttribute("name");if(s){var t=t.value,a=this;a.saveBtnState=!1;let e=a.judgeEmptyAndSpace(s,t);e=e||(null==(i=a.verifyFuncMap[s])?void 0:i.call(a,t)),a.verifyResult[s]=e,a.saveBtnDisabled=a.calcBtnState()}},onConfirm(e){var t,e=e.target,i=e.getAttribute("name");i&&(e=e.value,(t=this).settings[i]=e,t=t.platform||"settings",Editor.Profile.setConfig("certificate",t+"."+i,e,"global"))},judgeEmptyAndSpace(e,t){let i="";return!t||"string"==typeof t&&!t.trim().length?i="i18n:certificate.empty_error":t&&/^[^\s]*$/.test(t)||(i="i18n:certificate.space_error"),i},onGenerate(){const t=this,i=(process.env.PATH=process.env.PATH||"",-1===process.env.PATH.indexOf("/usr/bin/openssl")&&(process.env.PATH+=":/usr/bin/openssl"),t.settings.certificatePath);var{country:e,state:s,locality:a,organization:r,organizationalUnit:o,commonName:n,email:c}=t.settings,e=`/C=${e}/ST=${s}/L=${a}/O=${r}/OU=${o}/CN=${n}/emailAddress=`+c,s=join(Editor.App.path,"../tools/openSSLWin64/bin"),a=join(s,"openssl"),r=("win32"===process.platform?a:"openssl")+" req -newkey rsa:2048 -nodes -keyout private.pem -x509 -days 3650 -out certificate.pem -subj "+e,o=join(s,"openssl.cfg"),n="win32"===process.platform?{OPENSSL_CONF:o}:process.env;(0,require("child_process").exec)(r,{env:n,cwd:i},async e=>{e?(t.generateSuccess=!1,console.error(Editor.I18n.t("certificate.build_certificate_fail")+e),Editor.Task.addNotice({title:Editor.I18n.t("certificate.title"),message:Editor.I18n.t("certificate.build_certificate_fail")+e,type:"error"})):(console.log(Editor.I18n.t("certificate.build_certificate_complete")),Editor.Task.addNotice({title:Editor.I18n.t("certificate.title"),message:Editor.I18n.t("certificate.build_certificate_complete"),type:"success"}),t.generateSuccess=!0,Editor.Message.broadcast("certificate:generate-certificate-success",i),Editor.Panel.close("certificate"))})},calcBtnState(){var e=this;if(e.saveBtnState)return!0;for(const t of Object.keys(e.verifyResult))if(e.verifyResult[t])return!0;return!1},async initData(){var t,i=this;const s=i.platform||"settings";var e=await Editor.Profile.getConfig("certificate",s,"global");Object.assign(i.settings,e),i.platform&&"android"===i.platform&&(i.verifyResult=Object.assign({},{validity:void 0,password:void 0,confirmPassword:void 0,alias:void 0,aliasPassword:void 0,confirmAliasPassword:void 0},i.verifyResult),i.settings=Object.assign({},{validity:1,password:"",confirmPassword:"",alias:"",aliasPassword:"",confirmAliasPassword:""},i.settings));for(const s of Object.keys(i.settings)){let e=i.judgeEmptyAndSpace(s,i.settings[s]);e=e||(null==(t=i.verifyFuncMap[s])?void 0:t.call(i,i.settings[s])),(i.verifyResult[s]=e)&&(i.saveBtnState=!0,i.saveBtnDisabled=!0)}}}})},beforeClose=(exports.ready=ready,async function(){}),close=(exports.beforeClose=beforeClose,async function(){vm&&vm.$destroy()});exports.close=close;