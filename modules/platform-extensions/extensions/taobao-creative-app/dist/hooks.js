"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterCopyBuildTemplate=exports.onBeforeCopyBuildTemplate=exports.onBeforeCompressSettings=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),globby=require("globby"),path=require("path");async function onAfterInit(e,t,a){e.polyfills&&(e.polyfills.asyncFunctions=!1),Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"taobao-creative-app",value:{}}),e.server&&!e.server.endsWith("/")&&(e.server+="/");var r=e.includeModules.findIndex(e=>e.startsWith("physics-ammo"));-1!==r&&(e.includeModules[r]="physics-cannon"),e.buildEngineParam.split=!0,t.staticsInfo.B100012=e.server}function onBeforeBundleInit(e){e.moveRemoteBundleScript=!0,e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.buildScriptParam.platform="TAOBAO",e.assetSerializeOptions.exportCCON=!0}async function onBeforeCompressSettings(e,t,a){t.settings.orientation="portrait"}async function onBeforeCopyBuildTemplate(e,a,t){var r=e.engineInfo.typescript.path;const s=(0,path_1.join)(r,"templates/taobao-creative-app");for(const p of["web-adapter","engine-adapter"])await(0,fs_extra_1.copy)((0,path_1.join)(r,"bin/adapter/taobao",`${p}.${e.debug?"":"min."}js`),(0,path_1.join)(a.paths.dir,p+".js"));var o=this.buildTemplate.initUrl("app","app.ejs")||(0,path_1.join)(s,"app.ejs"),i={polyfillsBundleFile:a.paths.polyfillsJs&&Build.Utils.relativeUrl(a.paths.dir,a.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(a.paths.dir,a.paths.systemJs),importMapFile:Build.Utils.relativeUrl(a.paths.dir,a.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(a.paths.dir,a.paths.applicationJS)},o=await ejs_1.default.renderFile(o,i);(0,fs_extra_1.writeFileSync)((0,path_1.join)(a.paths.dir,"app.js"),o),e.md5CacheOptions.replaceOnly.push((0,path_1.join)(a.paths.dir,"app.js")),(await globby(["**/*","!mini.project.json","!app.json","!**/*.ejs"],{cwd:s})).map(e=>path.resolve(s,e)).forEach(e=>{var t;(0,fs_extra_1.statSync)(e).isFile()&&(t=(0,path_1.relative)(s,e),e=(0,fs_extra_1.readFileSync)(e,"utf8"),(0,fs_extra_1.outputFileSync)((0,path_1.join)(a.paths.dir,t),e,{encoding:"utf8"}))}),await postHandleScript(e,a,t)}async function onAfterCopyBuildTemplate(r,s,e){var t=r.engineInfo.typescript.path;const o=(0,path_1.join)(t,"templates/taobao-creative-app");["mini.project.json","app.json"].forEach(e=>{var t=(0,fs_extra_1.readJSONSync)((0,path_1.join)(o,e)),a=this.buildTemplate.findFile(e),a=(a&&(a=(0,fs_extra_1.readJSONSync)(a),Object.assign(t,a)),(0,path_1.join)(s.paths.dir,e));(0,fs_extra_1.writeJSONSync)(a,t),r.md5CacheOptions.excludes.push(a)})}async function postHandleScript(e,s,t){const o=e.debug?"\n":"";let i="var window = $global, global = $global, globalThis = $global;"+o;["__globalAdapter","cc","System","document","requestAnimationFrame","cancelAnimationFrame","XMLHttpRequest","performance","DOMParser","HTMLElement","HTMLImageElement","HTMLCanvasElement","Image","ImageBitmap","WebSocket","CANNON"].forEach(e=>{i+=`var ${e} = window.${e};`+o});e=e.packages["taobao-creative-app"].globalVariable,e&&e.split(",").map(e=>e.trim()).forEach(e=>{i+=`var ${e} = window.${e};`+o}),e=["app.js","pages/**/*.js","**/system.bundle*.js","**/polyfills.bundle*.js","**/import-map*.js","src/assets/**/*.js"];const a=s.paths.dir;var r=await globby(["**/*.js",...e.map(e=>"!"+e)],{cwd:a});const p=/System\.register\((\[.*?\].*?\{)/g,n=/System\.register\((.*?,\s*?\[.*?\].*?\{)/g;r=r.map(e=>path.resolve(s.paths.dir,e));r.forEach(e=>{var t=(0,path_1.relative)(s.paths.dir,e).replace(/\\/g,"/");let a=(0,fs_extra_1.readFileSync)(e,"utf8");var r=p.test(a);a=r?a.replace(p,`$global.System.register('no-schema:/${t}', $1`+o+i):n.test(a)?a.replace(n,"$global.System.register($1"+o+i):(r=`$global.System.register('no-schema:/${t}', [], (_export, _context) => { return { setters: [], execute () {`+o,t=o+"}}});",r+i+a+t),(0,fs_extra_1.writeFileSync)(e,a,"utf8")});(await globby(e,{cwd:a})).map(e=>path.resolve(a,e)).forEach(e=>{var t=(0,fs_extra_1.readFileSync)(e,"utf8"),t=i+t;(0,fs_extra_1.writeFileSync)(e,t,"utf8")});var e=["(function () {",'if (typeof $global !== "object") return;','const globalFuncMap = {"Int8Array": Int8Array, "Uint8Array": Uint8Array, "Int16Array": Int16Array, "Uint16Array": Uint16Array, "Int32Array": Int32Array, "Uint32Array": Uint32Array, "Float32Array": Float32Array, "Float64Array": Float64Array};',"Object.keys(globalFuncMap).forEach((funcName)=>{","$global[funcName] = globalFuncMap[funcName];","});","})();"].join(o),l=(0,path_1.join)(s.paths.dir,"app.js"),e=e+(0,fs_extra_1.readFileSync)(l,"utf8");(0,fs_extra_1.writeFileSync)(l,e,"utf8");let c="",f=(r.forEach(e=>{e=(0,path_1.relative)(s.paths.dir,e).replace(/\\/g,"/");c+=`require('./${e}');
`}),(await globby("assets/**/*.js",{cwd:a})).map(e=>path.resolve(a,e)).forEach(e=>{e=(0,path_1.relative)(s.paths.dir,e).replace(/\\/g,"/");c+=`require('./${e}');
`}),(0,fs_extra_1.outputFileSync)((0,path_1.join)(s.paths.dir,"load-module.js"),c,{encoding:"utf8"}),"");(await globby("src/assets/**/*.js",{cwd:a})).map(e=>path.resolve(a,e)).forEach(e=>{e=(0,path_1.relative)(s.paths.dir,e).replace(/\\/g,"/");f+=`require('./${e}');
`}),(0,fs_extra_1.outputFileSync)((0,path_1.join)(s.paths.dir,"load-module-plugin.js"),f,{encoding:"utf8"});const u=(await globby(["cocos-js/base*.js"],{cwd:a})).map(e=>path.resolve(a,e));l=(await globby(["cocos-js/physics-ammo*.js","cocos-js/physics-cannon*.js","cocos-js/physics-framework*.js","cocos-js/physics-builtin*.js"],{cwd:a})).map(e=>path.resolve(a,e));1===u.length&&l.forEach(t=>{var a=u[0].replace(/\\/g,"/").lastIndexOf("/");if(-1!==a){a=u[0].substring(a+1);let e=(0,fs_extra_1.readFileSync)(t,"utf8");e=e.replace(/base.js/,a),(0,fs_extra_1.writeFileSync)(t,e,"utf8")}})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterCopyBuildTemplate=onAfterCopyBuildTemplate;