"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compareVersion=exports.verificationFunc=exports.findSignIdentify=exports.renameXcodeResource=exports.updateXcodeproject=exports.modifyPackageName=exports.checkPackageNameValidity=exports.changePackageName=exports.updateOrientation=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),plist=require("plist"),child_process_1=require("child_process");async function updateOrientation(e,a){var t,r,i;a&&(e=(0,path_1.join)(e,"frameworks/runtime-src/proj.ios_mac/ios/Info.plist"),(0,fs_extra_1.existsSync)(e))&&(t=await(0,fs_extra_1.readFile)(e,"utf8"),r=plist.parse(t),i=[],a.landscapeRight&&i.push("UIInterfaceOrientationLandscapeRight"),a.landscapeLeft&&i.push("UIInterfaceOrientationLandscapeLeft"),a.portrait&&i.push("UIInterfaceOrientationPortrait"),a.upsideDown&&i.push("UIInterfaceOrientationPortraitUpsideDown"),r.UISupportedInterfaceOrientations=i,t=plist.build(r),await(0,fs_extra_1.writeFile)(e,t))}async function changePackageName(e,t){var r=(0,path_1.join)(e,".cocos-project.json");if((0,fs_extra_1.existsSync)(r)){var i=await(0,fs_extra_1.readJSON)(r);if(checkPackageNameValidity(t=t||i.packageName)){let a=i.packageName;var o=(a=i.mac&&i.mac.packageName?i.mac.packageName:a)!==t;if(o){var n=(0,path_1.join)(e,"cocos-project-template.json");if((0,fs_extra_1.existsSync)(n)){var s=(await(0,fs_extra_1.readJSON)(n)).do_add_native_support;if(o)for(const p of s.project_replace_ios_bundleid.files){var c=(0,path_1.join)(e,p);if((0,fs_extra_1.existsSync)(c)){let e=await(0,fs_extra_1.readFile)(c,"utf8");e=e.replace(new RegExp(a,"gm"),t),await(0,fs_extra_1.writeFile)(c,e)}else console.error(`Can't not find file [${p}], replace package name failed`)}i.ios||(i.ios={}),i.ios.packageName=t,await(0,fs_extra_1.writeFile)(r,JSON.stringify(i,null,2))}else console.error(`Can't find template json [${n}]`)}}else console.error("The package name is illegal(iOS). It can only contain these characters: [0-9], [a-z], [A-Z], [_].")}else console.error(`Can't find project json [${r}]`)}function checkPackageNameValidity(e){return/^[a-zA-Z]+([a-zA-Z0-9-.])+$/.test(e)}function modifyPackageName(e){return e}async function updateXcodeproject(a,t){var r=t.engineInfo.native.builtin,i=t.packages.native.template,a=(0,path_1.join)(a,"frameworks/runtime-src/proj.ios_mac",t.name+".xcodeproj");if("link"===i&&(0,fs_extra_1.existsSync)(a)){i=(0,path_1.join)(a,"project.pbxproj");let e=(await(0,fs_extra_1.readFile)(i)).toString();e=e.replace(/\/Applications\/CocosCreator.app\/Contents\/Resources\/cocos2d-x/g,(0,path_1.normalize)(r)),await(0,fs_extra_1.writeFile)(i,e)}r=(0,path_1.join)(a,"xcshareddata/xcschemes/HelloJavascript-clip.xcscheme");if((0,fs_extra_1.existsSync)(r)){let e=(await(0,fs_extra_1.readFile)(r)).toString();e=e.replace(/HelloJavascript/g,t.name),await(0,fs_extra_1.writeFile)(r,e)}}async function renameXcodeResource(e,a){var t=[(0,path_1.join)(e,"frameworks/runtime-src/proj.ios_mac",a.name+".xcodeproj/xcshareddata/xcschemes/HelloJavascript-clip.xcscheme"),(0,path_1.join)(e,"frameworks/runtime-src/proj.ios_mac",`${a.name}.xcodeproj/xcshareddata/xcschemes/${a.name}-clip.xcscheme`),(0,path_1.join)(e,"frameworks/runtime-src/proj.ios_mac","ios/HelloJavascript-mobileRelease.entitlements"),(0,path_1.join)(e,"frameworks/runtime-src/proj.ios_mac",`ios/${a.name}-mobileRelease.entitlements`),(0,path_1.join)(e,"frameworks/runtime-src/proj.ios_mac","ios_appclip/HelloJavascript.entitlements"),(0,path_1.join)(e,"frameworks/runtime-src/proj.ios_mac",`ios_appclip/${a.name}.entitlements`)];for(let e=0;e<t.length;e+=2)(0,fs_extra_1.existsSync)(t[e])?await(0,fs_extra_1.rename)(t[e],t[e+1]):console.log(`notice: file ${t[e]} not found!`)}function flatArray(e,a){if(e instanceof Array)for(var t of e)flatArray(t,a);else a.push(e)}function readOrganizationUnits(e){e=(0,child_process_1.execSync)(`xcrun security find-certificate -c "${e}" -p`),e=(0,child_process_1.execSync)("openssl x509 -inform PEM -noout -text",{input:e}).toString("utf8");const a=/OU\s*=\s*(\w+),/;e=e.split("\n").filter(e=>e.match(/^\s*Subject:/)).map(e=>e.match(a)).filter(e=>null!==e).map(e=>e[1]);return 0===e.length?[]:e}async function findSignIdentify(){try{var e=(0,child_process_1.execSync)("xcrun security find-identity -v -p codesigning").toString("utf8").split("\n");const r=/(\w+\)) ([0-9A-Z]+) "([^"]+)"\s*(\((\w+)\))?/;var a=e.map(e=>e.match(r)).filter(e=>null!==e).map(a=>{const t=a[3].split(":");return readOrganizationUnits(a[3]).map(e=>({idx:a[1].substr(0,a[1].length-1),hash:a[2],kind:t[0],displayValue:t[1].trim(),outputValue:e,fullValue:a[3].replace(/\(\w+\)/,`(TEAM:${e})`),errorState:a[5]}))}),t=[];return flatArray(a,t),t.filter(e=>0<e.outputValue.length)}catch(e){return console.warn("ios:"+Editor.I18n.t("ios.tips.developerTeamListError")),console.warn(e),[]}}function verificationFunc(e,a,t){var r={error:"",newValue:a,level:!0};switch(e){case"targetVersion":{let e="11.0";if(!/^([1-9]\d|[1-9])(\.([1-9]\d|\d)){1,2}$/.test(a))return r.error="i18n:ios.tips.version_style_error",r;"taskFlow"===t.packages.native.JobSystem&&(e="12.0",compareVersion(a,e)||(r.error="i18n:ios.tips.targetVersionErrorWithTaskFlow",r.newValue=e)),r.error||compareVersion(a,e)||(r.error="i18n:ios.tips.targetVersionError",r.newValue=e)}break;case"orientation":if(!a)return r.error="i18n:ios.tips.not_empty",r;if(Object.keys(a).every(e=>!a[e]))return r.error="i18n:ios.tips.at_least_one",r;break;case"osTarget":if(!a)return r.error="i18n:ios.tips.not_empty",r;if(Object.keys(a).every(e=>!a[e]))return r.error="i18n:ios.tips.at_least_one",r;break;case"packageName":if(a){if(checkPackageNameValidity(a))break;r.error="i18n:ios.tips.packageNameRuleMessage"}else r.error="i18n:ios.tips.not_empty";return r}return r}function compareVersion(e,a,t="."){var r;return"string"!=typeof e||"string"!=typeof a||(r=Math.max(e.length,a.length),e=e.replace(t,"").padStart(r,"0"),a=a.replace(t,"").padStart(r,"0"),Number(e)>Number(a))||Number(e)===Number(a)}exports.updateOrientation=updateOrientation,exports.changePackageName=changePackageName,exports.checkPackageNameValidity=checkPackageNameValidity,exports.modifyPackageName=modifyPackageName,exports.updateXcodeproject=updateXcodeproject,exports.renameXcodeResource=renameXcodeResource,exports.findSignIdentify=findSignIdentify,exports.verificationFunc=verificationFunc,exports.compareVersion=compareVersion;