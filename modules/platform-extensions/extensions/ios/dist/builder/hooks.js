"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterBuildAssets=exports.onAfterBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path");async function onAfterInit(e,t,a){const o=e.packages.ios.renderBackEnd={gles2:!1,gles3:!1,metal:!0},n=t.compileOptions;Object.keys(o).forEach(e=>{n.cMakeConfig["CC_USE_"+e.toUpperCase()]=o[e]});var r,s=e.packages.ios;n.platformParams.orientation=e.packages.ios.orientation,n.platformParams.bundleId=e.packages.ios.packageName,n.cMakeConfig.MACOSX_BUNDLE_GUI_IDENTIFIER=`set(MACOSX_BUNDLE_GUI_IDENTIFIER ${n.packageName})`,s.developerTeam&&(r=s.developerTeam.split("_")[0],n.cMakeConfig.DEVELOPMENT_TEAM=`set(DEVELOPMENT_TEAM ${r})`,n.platformParams.teamid=r),n.cMakeConfig.TARGET_IOS_VERSION=`set(TARGET_IOS_VERSION ${s.targetVersion||"12.0"})`,n.cMakeConfig.USE_PORTRAIT=!!s.orientation.portrait,n.cMakeConfig.CUSTOM_COPY_RESOURCE_HOOK=s.skipUpdateXcodeProject,n.platformParams.skipUpdateXcodeProject=s.skipUpdateXcodeProject,n.executableName=executableNameOrDefault(n.projectName,e.packages.ios.executableName),n.cMakeConfig.CC_EXECUTABLE_NAME=`set(CC_EXECUTABLE_NAME "${n.executableName}")`,s.osTarget&&(void 0!==s.osTarget.simulator&&(n.platformParams.simulator=s.osTarget.simulator),void 0!==s.osTarget.iphoneos)&&(n.platformParams.iphoneos=s.osTarget.iphoneos),await(0,fs_extra_1.outputJSON)(t.paths.compileConfig,n),t.staticsInfo.B100005=e.packages.ios.packageName,t.staticsInfo.B100011=e.packages.ios.orientation}async function onAfterBundleInit(e){var t,a=e.packages.ios.renderBackEnd={gles2:!1,gles3:!1,metal:!0};e.assetSerializeOptions["cc.EffectAsset"].glsl1=null==(t=a.gles2)||t,e.assetSerializeOptions["cc.EffectAsset"].glsl3=null==(t=a.gles3)||t,e.assetSerializeOptions["cc.EffectAsset"].glsl4=null==(t=a.metal)||t,e.buildScriptParam.platform="IOS"}async function onAfterBuildAssets(e,t,a){e.useSplashScreen||(e.useSplashScreen=!0)}async function onBeforeCompressSettings(e,t,a){t.settings.splashScreen&&(t.settings.splashScreen.totalTime=0)}async function onAfterBuild(e,t){await buildSplash(e,t)}async function buildSplash(e,t){var a=t.settings.splashScreen;if(a&&a.logo&&a.background){var t=(0,path_1.join)(Editor.Project.path,"native/engine/ios"),o=((0,fs_extra_1.ensureDirSync)(t),[{width:1242,height:2208,outputPath:(0,path_1.join)(t,"LaunchScreenBackgroundPortrait.png")},{width:2208,height:1242,outputPath:(0,path_1.join)(t,"LaunchScreenBackgroundLandscape.png")}]);try{for(const r of o)await generateSplashPicture(r,a);var n=e.packages.ios.orientation.portrait?(0,path_1.join)(t,"LaunchScreenBackgroundPortrait.png"):(0,path_1.join)(t,"LaunchScreenBackgroundLandscape.png");(0,fs_extra_1.copyFileSync)(n,(0,path_1.join)(t,"LaunchScreenBackground.png")),console.debug("Generate splash to:",(0,path_1.join)(t,"LaunchScreenBackgroundPortrait.png"))}catch(e){console.warn("Failed to generate splash:",e)}}}async function generateSplashPicture(e,t){var a=document.createElement("canvas"),o=(a.width=e.width,a.height=e.height,a.getContext("2d"));if("custom"===(null==(s=t.background)?void 0:s.type)&&t.background.base64?((s=new Image).src=t.background.base64,await c(s),i=Math.max(a.width/s.width,a.height/s.height),n=(a.width-s.width*i)/2,r=(a.height-s.height*i)/2,o.beginPath(),o.rect(n,r,s.width*i,s.height*i),o.closePath(),o.clip(),o.drawImage(s,n,r,s.width*i,s.height*i)):("color"===(null==(n=t.background)?void 0:n.type)&&t.background.color?(r=t.background.color,o.fillStyle=`rgba(${255*r.x}, ${255*r.y}, ${255*r.z}, ${255*r.w})`):o.fillStyle="rgba(4, 9, 10, 1)",o.fillRect(0,0,a.width,a.height)),("custom"===(null==(s=t.logo)?void 0:s.type)||"default"===(null==(i=t.logo)?void 0:i.type))&&t.logo.base64){var n=new Image,r=(n.src=t.logo.base64,await c(n),n.height/n.width),s=.185*a.height*t.displayRatio,i=s/r,r=(a.width-i)/2;let e=(a.height*(5/6)-s)/2;s>a.height*(5/6)&&(e=(a.height-s)/2),o.drawImage(n,r,e,i,s),"default"===t.logo.type&&(o.font="400 36px Arial",o.textBaseline="top",o.textAlign="center",o.fillStyle="rgba(250, 250, 250, 0.4)",o.lineWidth=2,o.strokeStyle="rgba(5, 5, 5, 0.3)",o.strokeText("Created with Cocos",a.width/2,e+s+48),o.fillText("Created with Cocos",a.width/2,e+s+48))}n=a.toDataURL("image/png"),r=atob(n.split(",")[1]);function c(a){return new Promise((e,t)=>{a.complete?e(a):(a.addEventListener("load",()=>{e(a)}),a.addEventListener("error",e=>{t(e)}))})}(0,fs_extra_1.writeFileSync)(e.outputPath,r,"binary"),console.log("Generate splash to:",e.outputPath)}function executableNameOrDefault(e,t){return t||(/^[0-9a-zA-Z_-]+$/.test(e)?e+"-mobile":(console.warn(`The provided project name "${e}" is not suitable for use as an executable name. 'CocosGame' is applied instead.`),"CocosGame"))}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onAfterBuildAssets=onAfterBuildAssets,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;