"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.make=exports.onAfterCopyBuildTemplate=exports.onBeforeCopyBuildTemplate=exports.onBeforeCompressSettings=exports.onAfterBundleBuildTask=exports.onAfterInit=exports.onBeforeBundleInit=exports.onBeforeBuild=exports.throwError=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path"),cli_1=require("./utils/cli"),share_1=require("./share");function getTemplatePath(e){return(0,path_1.join)(share_1.Paths.internalTemplateDir,e)}function onBeforeBuild(e){e=e.packages[share_1.PKG_NAME];e.certificatePemPath=Editor.UI.__protected__.File.resolveToRaw(e.certificatePemPath),e.privatePemPath=Editor.UI.__protected__.File.resolveToRaw(e.privatePemPath)}function onBeforeBundleInit(e){e.moveRemoteBundleScript=!0,e.assetSerializeOptions.exportCCON=!0,e.polyfills&&(e.polyfills.asyncFunctions=!1),e.buildScriptParam.platform="XIAOMI",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"}}async function onAfterInit(e,a,t){var s=e.packages[share_1.PKG_NAME],a=(Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"xiaomi-runtime"}),e.generateCompileConfig=!0,e.server&&!e.server.endsWith("/")&&(e.server+="/"),s.icon=Editor.UI.__protected__.File.resolveToRaw(e.packages["xiaomi-quick-game"].icon),Object.assign(e.buildEngineParam,{engineName:"src/cocos-js"}),a.paths.applicationJS=(0,path_1.join)(a.paths.dir,"src",(0,path_1.basename)(a.paths.applicationJS)),a.staticsInfo.B100011=s.deviceOrientation,a.staticsInfo.B100005=s.package,e.engineInfo.typescript.path);share_1.Paths.internalTemplateDir=(0,path_1.join)(a,"templates/xiaomi-quick-game"),e.buildScriptParam.flags.WASM_SUBPACKAGE=s.wasmSubpackage}async function onAfterBundleBuildTask(e,a,t){var s,i=[];for(const r of a)r.isSubpackage&&(s=(0,path_1.join)((0,path_1.dirname)(r.scriptDest),share_1.SUB_PACKAGE_JS_NAME),(0,fs_extra_1.existsSync)(r.scriptDest)&&(0,fs_extra_1.renameSync)(r.scriptDest,s),r.scriptDest=s,i.push({name:"usr_"+r.name,root:`subpackages/${r.name}/`})),await handleScript(r.scriptDest);e.packages["xiaomi-quick-game"].subpackages=i}async function handleScript(e){var a;(0,fs_extra_1.existsSync)(e)?(a=await(0,fs_extra_1.readFile)(e,"utf8"),(0,fs_extra_1.outputFileSync)(e,`(function() { 
${a}
 })()`)):(0,fs_extra_1.outputFileSync)(e,"(function() { \n \n })()")}async function onBeforeCompressSettings(e,a,t){a.settings.screen.orientation=e.packages[share_1.PKG_NAME].deviceOrientation}async function onBeforeCopyBuildTemplate(e,a,t,s){var i=e.engineInfo.typescript.path;for(const o of["web-adapter","engine-adapter"])await(0,fs_extra_1.copy)((0,path_1.join)(i,"bin/adapter/minigame/xiaomi",`${o}.${e.debug?"":"min."}js`),(0,path_1.join)(a.paths.dir,o+".js"));await copyResFiles.call(this,e,a);let r=(0,fs_extra_1.readFileSync)(a.paths.importMap,"utf-8");var n=(0,path_1.basename)(a.paths.engineDir);r=r.replace(new RegExp("./"+n,"g"),"no-schema:/src/"+(0,path_1.basename)(a.paths.engineDir)),(0,fs_extra_1.writeFileSync)(a.paths.importMap,r)}async function onAfterCopyBuildTemplate(e,a){writeConfigFile(e,a,this.buildTemplate.findFile("manifest.json"))}async function make(e,a){var t={name:a.name,tinyPackageServer:a.server||"",useDebugKey:a.packages[share_1.PKG_NAME].useDebugKey},s=((0,fs_extra_1.existsSync)(share_1.Paths.packPath)?await initPackFiles():(console.debug("start unzip pack tools"),s=require("v-unzip"),i=share_1.Paths.packPath+".zip",await s.unzip(i,share_1.Paths.packPath)),console.debug("Check is install nodejs"),await Build.Utils.isInstallNodeJs());if(s){console.debug("Check is install pack tools"),(0,fs_extra_1.copySync)(e,share_1.Paths.packPath),await buildRpk(t);var i=(0,path_1.join)(share_1.Paths.packPath,"dist");if(!(0,fs_extra_1.existsSync)(i))throw new Error("compile rpk failed!");(0,fs_extra_1.copySync)(i,(0,path_1.join)(e,"dist"));s=(0,path_1.join)(e,"dist",a.name+(t.useDebugKey?".debug.":".release.")+"rpk");console.debug(`compile rpk success {link(${s})}`)}else console.error("Please install nodejs in global first!")}async function copyResFiles(e,a){var t=e.packages[share_1.PKG_NAME],s=a.paths.systemJs,s=((0,fs_extra_1.writeFileSync)(s,"var self=window; var navigator=window.navigator;"+(0,fs_extra_1.readFileSync)(s,"utf8")),this.buildTemplate.initUrl("game.ejs")||(0,path_1.join)(share_1.Paths.internalTemplateDir,"game.ejs")),s=(await buildGameJs(s,e,a),(0,path_1.join)(a.paths.dir,share_1.ICON_NAME+(0,path_1.extname)(t.icon))),{useDebugKey:e,privatePemPath:s,certificatePemPath:t}=(e.md5CacheOptions.excludes.push(s),(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(s)),(0,fs_extra_1.existsSync)(t.icon)?(0,fs_extra_1.copyFileSync)(t.icon,s):console.warn("Icon is missing"),t);handleSign(a.paths.dir,e,s,t)}async function initPackFiles(){if((0,cli_1.isInit)(share_1.Paths.packPath))console.debug("use the cache xiaomi pack tools");else{if((0,fs_extra_1.existsSync)((0,path_1.join)(share_1.Paths.packPath,"package.json"))||((0,fs_extra_1.copySync)(getTemplatePath("package.json"),(0,path_1.join)(share_1.Paths.packPath,"package.json")),(0,fs_extra_1.copySync)(getTemplatePath("babel.config.js"),(0,path_1.join)(share_1.Paths.packPath,"babel.config.js"))),console.debug("start install xiaomi pack tools"),!0!==await(0,cli_1.install)(share_1.Paths.packPath))throw(0,fs_extra_1.removeSync)((0,path_1.join)(share_1.Paths.packPath,"node_modules")),new Error("init xiaomi pack tools failed!");console.log("init xiaomi pack tools success")}(0,fs_extra_1.removeSync)((0,path_1.join)(share_1.Paths.packPath,"src")),(0,fs_extra_1.removeSync)((0,path_1.join)(share_1.Paths.packPath,"libs")),(0,fs_extra_1.removeSync)((0,path_1.join)(share_1.Paths.packPath,"assets")),(0,fs_extra_1.removeSync)((0,path_1.join)(share_1.Paths.packPath,"remote")),(0,fs_extra_1.removeSync)((0,path_1.join)(share_1.Paths.packPath,"dist")),(0,fs_extra_1.removeSync)((0,path_1.join)(share_1.Paths.packPath,"image")),(0,fs_extra_1.existsSync)((0,path_1.join)(share_1.Paths.packPath,"subpackages"))&&(0,fs_extra_1.removeSync)((0,path_1.join)(share_1.Paths.packPath,"subpackages"))}async function buildRpk(e){let a=e.useDebugKey?"build":"release";e.tinyPackageServer&&(a+="-ignore-res");e=["run",a,"--cocos-wx-game"];if(!0!==await Build.Utils.quickSpawn("npm",e,{cwd:share_1.Paths.packPath}))throw new Error("Build rpk failed!")}async function buildGameJs(e,a,t){var s={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:t.paths.systemJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},e=await ejs_1.default.renderFile(e,s);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,share_1.SUB_PACKAGE_JS_NAME),e,"utf8"),a.md5CacheOptions.replaceOnly.push((0,path_1.join)(t.paths.dir,share_1.SUB_PACKAGE_JS_NAME))}function writeConfigFile(e,a,t){var s=e.packages[share_1.PKG_NAME],i=(0,path_1.join)(a.paths.dir,"manifest.json"),{versionName:r,versionCode:a,minPlatformVersion:n,logLevel:o,icon:p,deviceOrientation:c}=(e.md5CacheOptions.excludes.push(i),s.wasmSubpackage&&(r=(0,path_1.join)(a.paths.engineDir,"./assets/"),a=(0,path_1.join)(a.paths.engineDir,"./chunks/"),(0,fs_extra_1.existsSync)(r)&&(null==s.subpackages&&(s.subpackages=[]),s.subpackages.push({name:"__ccWasmAssetSubpkg__",root:"src/cocos-js/assets/"}),(0,fs_extra_1.renameSync)((0,path_1.join)(r,"game.js"),(0,path_1.join)(r,"main.js"))),(0,fs_extra_1.existsSync)(a))&&(null==s.subpackages&&(s.subpackages=[]),s.subpackages.push({name:"__ccWasmChunkSubpkg__",root:"src/cocos-js/chunks/"}),(0,fs_extra_1.renameSync)((0,path_1.join)(a,"game.js"),(0,path_1.join)(a,"main.js"))),s),_=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"manifest.json"));t&&(t=(0,fs_extra_1.readJSONSync)(t),Object.assign(_,t)),Object.assign(_,{package:s.package,name:e.name,versionName:r,versionCode:a,minPlatformVersion:n,icon:"/"+share_1.ICON_NAME+(0,path_1.extname)(p),orientation:c,config:{logLevel:o||"log"}}),s.subpackages&&(_.subpackages=s.subpackages),(0,fs_extra_1.outputJSONSync)(i,_)}function handleSign(e,a,t,s){e=(0,path_1.join)(e,"sign");(0,fs_extra_1.emptyDirSync)(e),a?(a=(0,path_1.join)(e,"debug"),(0,fs_extra_1.ensureDirSync)(a),(0,fs_extra_1.copySync)(getTemplatePath("certificate/certificate.pem"),(0,path_1.join)(a,"certificate.pem")),(0,fs_extra_1.copySync)(getTemplatePath("certificate/private.pem"),(0,path_1.join)(a,"private.pem"))):(a=(0,path_1.join)(e,"release"),(0,fs_extra_1.ensureDirSync)(a),(0,fs_extra_1.existsSync)(t)&&(0,fs_extra_1.copySync)(t,(0,path_1.join)(a,"private.pem")),(0,fs_extra_1.existsSync)(s)&&(0,fs_extra_1.copySync)(s,(0,path_1.join)(a,"certificate.pem")))}exports.throwError=!0,exports.onBeforeBuild=onBeforeBuild,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterInit=onAfterInit,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterCopyBuildTemplate=onAfterCopyBuildTemplate,exports.make=make;