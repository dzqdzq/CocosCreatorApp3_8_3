"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.previewManager=void 0;const child_process_1=require("child_process"),fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path"),killPort=require("./killPort");class PreviewManager{constructor(){this.lastPid=null,this.lastPreviewIp="",this.port=4e3,this.child=null}run(e,s){var r,t;isInstallNodeJs()?(0,fs_1.existsSync)(e)?(r=(0,path_1.join)(Editor.App.path,"../tools","xiaomi-pack-tools"),(0,fs_extra_1.copySync)((0,path_1.dirname)(e),(0,path_1.join)(r,"dist")),(0,fs_1.existsSync)((0,path_1.join)(r,"node_modules"))?(t="win32"===process.platform?"npm.cmd":"npm",t=(0,child_process_1.spawn)(t,["run","server","--","--port",String(this.port)],{cwd:r}),this.lastPid=t.pid||null,t.stdout.on("data",e=>{-1!==e.indexOf("生成HTTP服务器的二维码")&&(console.log(e),s(!0))}),t.stderr.on("data",function(e){var r=e.toString();let t="error";(/Cannot read property 'ws' of undefined/gi.test(r)||/Unhandled promise rejections are deprecated/gi.test(r))&&(t="warn"),console[t](r),s(!1,e)}),t.on("exit",(e,r)=>{console.log("=======child process exit ,exit:"+e),this.lastPid=null}),t.on("close",(e,r)=>{console.log("=======child process close ,exit:"+e),this.lastPid=null})):console.error(`Please install in (${r}) first!`)):console.error(`xiaomi rpk (${e}) does not exist, please build before preview!`):console.error("Please install nodeJs in global first!")}exist(){this.lastPid&&killPort(this.lastPid,this.port)}async getPreviewIp(){return`http://${await Editor.Message.request("preview","get-preview-ip")}:`+this.port}}function isInstallNodeJs(){return new Promise((r,t)=>{(0,child_process_1.exec)("node -v",{},e=>{e?("win32"===process.platform?console.error(new Error(Editor.I18n.t("builder.window_default_npm_path_error"))):console.error(new Error(Editor.I18n.t("builder.mac_default_npm_path_error"))),t(!1)):r(!0)})})}exports.previewManager=new PreviewManager;