"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),preview_cli_1=require("./preview-cli"),fixPath=require("fix-path");let panel=null,vm;const Vue=require("vue/dist/vue.js"),qrcode=(Vue.config.productionTip=!1,Vue.config.devtools=!1,require("qrcode"));async function ready(){panel=this,fixPath(),vm=new Vue({el:panel.$.preview,data:{previewIp:"",rpkPath:"",pid:null,error:""},computed:{tips(){var e=this;return e.error?Editor.I18n.t("xiaomi-quick-game.start_server_error")+":"+e.error:e.rpkPath?e.previewIp?"i18n:xiaomi-quick-game.debug_scan_qr_code":"i18n:xiaomi-quick-game.qr_code_generating":"i18n:xiaomi-quick-game.buildBeforePreview"}},methods:{async updateRpkPath(e){var r=this;e!==r.rpkPath&&(console.debug(`rpkPath({link(${e})}).`),preview_cli_1.previewManager.exist(),r.rpkPath=e,await r.getPreviewIp(e),await r.updateAddress())},async getPreviewIp(e){const a=this;a.error="",preview_cli_1.previewManager.port=await Editor.Network.getFreePort(preview_cli_1.previewManager.port),await new Promise((i,t)=>{preview_cli_1.previewManager.run(e,(e,r)=>{r?(a.error=r.message,t(r)):i(e)})})&&(a.previewIp=await preview_cli_1.previewManager.getPreviewIp()),a.pid=preview_cli_1.previewManager.lastPid,console.log(`xiaomi preview IP: {link(${a.previewIp})},pid:`+preview_cli_1.previewManager.lastPid)},async updateAddress(){qrcode.toCanvas(this.$refs.preview,this.previewIp,{errorCorrectionLevel:"H",maskPattern:2,margin:1})}}})}function beforeClose(){preview_cli_1.previewManager.exist()}async function close(){}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../dist/preview.css"),"utf8"),exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../static/preview.html"),"utf8"),exports.$={preview:".preview"},exports.methods={"update-rpk-path"(e){vm.updateRpkPath(e)}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;