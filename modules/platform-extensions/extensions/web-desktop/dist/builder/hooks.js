"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.onBeforeCopyBuildTemplate=exports.onBeforeCompressSettings=exports.onAfterBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs"));function onAfterInit(e,t,i){e.packages["web-desktop"];e.buildEngineParam.assetURLFormat="runtime-resolved",e.server&&!e.server.endsWith("/")&&(e.server+="/")}function onAfterBundleInit(e){e.buildScriptParam.system={preset:"web"};var t=e.packages["web-desktop"].useWebGPU;e.buildScriptParam.flags.WEBGPU=t,e.buildScriptParam.platform="HTML5",t&&(e.assetSerializeOptions["cc.EffectAsset"].glsl4=!0)}async function onBeforeCompressSettings(e,t,i){if(t.paths.dir){const s=t.settings;s.screen.exactFitScreen=!1,s.plugins.jsList.forEach((e,t)=>{s.plugins.jsList[t]=e.split("/").map(encodeURIComponent).join("/")})}}async function onBeforeCopyBuildTemplate(e,t){var i=(0,path_1.join)(e.engineInfo.typescript.builtin,"templates/web-desktop"),s=e.packages["web-desktop"],r=(0,path_1.join)(t.paths.dir,"style.css"),r=(this.buildTemplate.findFile("style.css")||(0,fs_extra_1.copyFileSync)((0,path_1.join)(i,"style.css"),r),this.buildTemplate.findFile("favicon.ico")||(0,fs_extra_1.copyFileSync)((0,path_1.join)(i,"favicon.ico"),(0,path_1.join)(t.paths.dir,"favicon.ico")),this.buildTemplate.initUrl("index.js.ejs","indexJs")||(0,path_1.join)(i,"index.js.ejs")),r=await ejs_1.default.renderFile(r,{applicationJS:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)}),r=await Build.Utils.transformCode(r,{importMapFormat:"systemjs"});if(!r)throw new Error("Cannot generate index.js");var n=(0,path_1.join)(t.paths.dir,"index.js"),n=(t.paths.indexJs=n,(0,fs_extra_1.outputFileSync)(n,r,"utf8"),this.buildTemplate.initUrl("index.ejs")||(0,path_1.join)(i,"index.ejs")),r={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),projectName:e.name,engineName:e.buildEngineParam.engineName,previewWidth:s.resolution.designWidth,previewHeight:s.resolution.designHeight,cocosTemplate:(0,path_1.join)(i,"index-plugin.ejs"),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),indexJsName:"./index.js",cssUrl:"./style.css"},s=await ejs_1.default.renderFile(n,r);t.paths.indexHTML=(0,path_1.join)(t.paths.dir,"index.html"),(0,fs_extra_1.outputFileSync)(t.paths.indexHTML,s,"utf8"),e.md5CacheOptions.replaceOnly.push(t.paths.indexHTML),Editor.Message.request("web-desktop","set-preview-path",t.paths.dir)}function run(e,t){Editor.Message.request("web-desktop","preview",e,t.packages["web-desktop"].useWebGPU)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.run=run;