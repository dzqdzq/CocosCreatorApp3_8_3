"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterCopyBuildTemplate=exports.onBeforeCopyBuildTemplate=exports.onBeforeCompressSettings=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),share_1=require("./share");async function onAfterInit(e,t,a){Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"alipay-minigame",value:{orientation:e.packages["alipay-mini-game"].deviceOrientation}});var i=e.packages["alipay-mini-game"];/\d*\.\d*\.\d*$/.test(Editor.App.version)||Editor.App.dev?(i.separateEngine&&e.debug&&console.warn(Editor.I18n.t("alipay-mini-game.tips.separate_engine_with_debug")),"builtin"===e.engineInfo.typescript.type?i.separateEngine=i.separateEngine&&!e.debug:console.warn(Editor.I18n.t("alipay-mini-game.tips.separate_engine_with_custom_engine"))):console.warn(Editor.I18n.t("alipay-mini-game.tips.separate_engine_only_in_normal_version")),Object.assign(e.buildEngineParam,{sourceMaps:!i.separateEngine&&e.sourceMaps,skip:i.separateEngine}),e.server&&!e.server.endsWith("/")&&(e.server+="/"),t.staticsInfo.B100011=e.packages["alipay-mini-game"].deviceOrientation,e.buildScriptParam.flags.WASM_SUBPACKAGE=i.wasmSubpackage}function onBeforeBundleInit(e){e.polyfills&&(e.polyfills.asyncFunctions=!1),e.moveRemoteBundleScript=!0,e.buildScriptParam.platform="ALIPAY",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.assetSerializeOptions.exportCCON=!0}async function onBeforeCompressSettings(e,t,a){t.settings.screen.orientation=e.packages["alipay-mini-game"].deviceOrientation}async function onBeforeCopyBuildTemplate(e,t,a){var i=e.engineInfo.typescript.path;share_1.Paths.internalTemplateDir=(0,path_1.join)(i,"templates/alipay-mini-game");for(const n of["web-adapter","engine-adapter"])await(0,fs_extra_1.copy)((0,path_1.join)(i,"bin/adapter/minigame/alipay",`${n}.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,n+".js"));var s={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},s=await ejs_1.default.renderFile((0,path_1.join)(share_1.Paths.internalTemplateDir,"game.ejs"),s);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,"game.js"),s),e.md5CacheOptions.replaceOnly.push((0,path_1.join)(t.paths.dir,"game.js"))}async function onAfterCopyBuildTemplate(e,t,a){var i=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"game.json")),s=this.buildTemplate.findFile("game.json"),s=(s&&(s=(0,fs_extra_1.readJSONSync)(s),Object.assign(i,s)),i.screenOrientation=e.packages["alipay-mini-game"].deviceOrientation,e.packages["alipay-mini-game"]);if(s.separateEngine){var n=(0,path_1.join)(Build.buildTemplateDir,"patch.json");let e=Editor.App.version;(0,fs_extra_1.existsSync)(n)&&(e=await Editor.Profile.getConfig("alipay-mini-game","plugin-version")||Editor.App.version),i.plugins={cocos:{version:e,pluginId:require((0,path_1.join)(__dirname,"../static/cocos/signature.json")).pluginId,path:"cocos"}}}var r,o=[];for(const p of this.bundleManager.bundles)p.isSubpackage&&(r=(0,path_1.join)((0,path_1.dirname)(p.scriptDest),"game.js"),(0,fs_extra_1.existsSync)(p.scriptDest)?(0,fs_extra_1.renameSync)(p.scriptDest,r):(0,fs_extra_1.outputFileSync)(r,`console.log('${p.name}: no script in subPackage.')`,"utf8"),p.scriptDest=r,o.push({name:p.name,root:`subpackages/${p.name}/`}));s.wasmSubpackage&&(n=(0,path_1.join)(t.paths.engineDir,"./assets/"),s=(0,path_1.join)(t.paths.engineDir,"./chunks/"),(0,fs_extra_1.existsSync)(n)&&o.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"}),(0,fs_extra_1.existsSync)(s))&&o.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"}),0<o.length&&(i.subpackages=o);n=(0,path_1.join)(t.paths.dir,"game.json");e.md5CacheOptions.excludes.push(n),(0,fs_extra_1.writeJSONSync)(n,i)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterCopyBuildTemplate=onAfterCopyBuildTemplate;