"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{existsSync,ensureDirSync,statSync}=require("fs-extra"),{join,basename}=require("path"),spawn=require("child_process")["spawn"],network=require("./network"),phone_1=require("../../../utils/phone"),log_1=require("../../../utils/log"),info_1=require("../../../utils/info"),base_1=require("../../../utils/base"),RUNTIME_DOWNLOAD_PATH=join(Editor.App.home,"download/runtime/huawei/"),RUNTIME_REQUEST_URL="https://deveco.huawei.com/FastIDE/update/api/update/engineVersion/",RUNTIME_RPK_PATH="/data/local/tmp/",RUNTIME_PACKAGE_NAME="com.huawei.fastapp.dev";var RUNTIME_STATE;function t(...e){return Editor.I18n.t(...e)}!function(e){e[e.free=0]="free",e[e.downloading=1]="downloading",e[e.installing=2]="installing",e[e.pushing=3]="pushing",e[e.launching=4]="launching"}(RUNTIME_STATE=RUNTIME_STATE||{});const _compareVersion=function(e,t){let s=!1;var r=e.split("."),a=t.split(".");for(let i=0;i<r.length;i++){let n=r[i],o=a[i];if(i===r.length-1){let e=!1,t=!1;if(1<r[i].split("_").length&&(n=r[i].split("_")[0],e=!0),a[i]&&1<a[i].split("_").length&&(o=a[i].split("_")[0],t=!0),n===o){s=!e&&t;break}}if(n>o){s=!0;break}if(n<o){s=!1;break}}return s};class huawei extends base_1.Base{constructor(){super(),this.RUNTIME_STATE=RUNTIME_STATE,this.state=RUNTIME_STATE.free,this.logList={},this.runtimeApkPath="",this.runtimeVersion=""}async getRpkPath(){return phone_1.phone.options&&phone_1.phone.options.rpkPath||""}requestRuntimeVersion(){return info_1.info.log(t("runtime-dev-tools.check_runtime_version")),network.get(RUNTIME_REQUEST_URL).then(e=>(e=e.toString(),JSON.parse(e))).catch(e=>{console.error("requestRuntimeVersion error",e)})}async checkRuntimeVersion(){var e=await this.requestRuntimeVersion(),n=e.url.split("/"),n=n[n.length-1],n=(this.runtimeVersion=e.version,log_1.log.debug(t("runtime-dev-tools.latest_runtime_version",{version:e.version})),join(RUNTIME_DOWNLOAD_PATH,n));existsSync(n)||(info_1.info.log(t("runtime-dev-tools.runtime_not_exists",{version:e})),ensureDirSync(RUNTIME_DOWNLOAD_PATH),this._downloadRuntimeApk(e.url,n)),this.runtimeApkPath=n}_downloadRuntimeApk(e,n){this.state=RUNTIME_STATE.downloading,network.download(e,n,e=>{info_1.info.log(t("runtime-dev-tools.runtime_downloading",{progress:100*e.toFixed(2)}))},e=>{this.state=RUNTIME_STATE.free,info_1.info.log(t("runtime-dev-tools.download_finish"))})}async checkPhoneRuntimeVersion(){if(this._checkPhoneConnect()){let e=await phone_1.phone.shell(phone_1.phone.currentPhone.id,`dumpsys package ${RUNTIME_PACKAGE_NAME} | grep versionName`);if(!((e=e.split("=")).length<=0))return e=e[1],log_1.log.debug(t("runtime-dev-tools.now_runtime_version",{version:e})),this.compareRuntime(e);info_1.info.warn(t("runtime-dev-tools.can_not_find_runtime"))}}compareRuntime(e){return _compareVersion(this.runtimeVersion,e)}async isRuntimeInstalled(){if(this._checkPhoneConnect())return phone_1.phone.isInstalled(phone_1.phone.currentPhone.id,RUNTIME_PACKAGE_NAME)}async installRuntime(){this.runtimeApkPath?(this.state=RUNTIME_STATE.installing,info_1.info.log(t("runtime-dev-tools.runtime_installing")),await phone_1.phone.install(phone_1.phone.currentPhone.id,this.runtimeApkPath),this.state=RUNTIME_STATE.free,info_1.info.log(t("runtime-dev-tools.runtime_installed"))):info_1.info.error(t("runtime-dev-tools.can_not_find_apk"))}async checkRuntime(){this._checkPhoneConnect()&&(await this.isRuntimeInstalled()?(info_1.info.log(t("runtime-dev-tools.check_installed_runtime_version")),await this.checkPhoneRuntimeVersion()?0==(await Editor.Dialog.info(t("runtime-dev-tools.dialog_msg"),{buttons:[t("runtime-dev-tools.confirm"),t("runtime-dev-tools.cancel")],title:t("runtime-dev-tools.runtime_update")})).response?await this.installRuntime():(log_1.log.warn(t("runtime-dev-tools.cancel_runtime_tips")),info_1.info.warn(t("runtime-dev-tools.cancel_runtime_tips"))):info_1.info.log(t("runtime-dev-tools.check_latest_runtime_version"))):await this.installRuntime())}_checkPhoneConnect(){return!!phone_1.phone.currentPhone||(info_1.info.warn(t("runtime-dev-tools.lose_phone_connect")),!1)}async pushRpkToPhone(s){const r=this;return this._checkPhoneConnect()?(this.state=RUNTIME_STATE.pushing,new Promise(async(e,n)=>{info_1.info.log(t("runtime-dev-tools.begin_push"));var o=RUNTIME_RPK_PATH+basename(s);const i=statSync(s).size;o=await phone_1.phone.push(phone_1.phone.currentPhone.id,s,o);o.on("progress",function(e){info_1.info.log(t("runtime-dev-tools.runtime_update",{progress:parseInt(100*e.bytesTransferred/i)}))}),o.on("end",function(){e(),r.state=RUNTIME_STATE.free,info_1.info.log(t("runtime-dev-tools.push_finish"))}),o.on("error",e=>{n(),this.state=RUNTIME_STATE.free,info_1.info.error(t("runtime-dev-tools.push_error"))})})):Promise.reject()}async startRuntimeWithRpk(e,n){this._checkPhoneConnect()&&(info_1.info.log(t("runtime-dev-tools.start_runtime")),this.state=RUNTIME_STATE.launching,e=`am start --es rpkpath ${"file://"+RUNTIME_RPK_PATH+e} ${n} --activity-clear-top com.huawei.fastapp.dev/com.huawei.fastapp.app.RpkRunnerActivity`,await phone_1.phone.shell(phone_1.phone.currentPhone.id,e),info_1.info.log(t("runtime-dev-tools.start_runtime_finish")),this.state=RUNTIME_STATE.free)}openLogcat(e){setTimeout(()=>{if(this._checkPhoneConnect()){const n=spawn(phone_1.phone.adbPath,["-s",e,"shell","logcat","-s","jsLog"]);(this.logList[phone_1.phone.currentPhone.id]=n).stdout.on("data",e=>{log_1.log.log(e.toString("utf-8"))}),n.on("close",e=>{log_1.log.log("logcat exit with code: "+e);for(const t in this.logList){this.logList[t];n&&delete this.logList[t]}})}},600)}needToCreatLogcat(e){return!this.logList[e]}async stopRuntime(){this._checkPhoneConnect()&&(info_1.info.log(t("runtime-dev-tools.stop_runtime")),await phone_1.phone.shell(phone_1.phone.currentPhone.id," am force-stop com.huawei.fastapp.dev"))}}module.exports=new huawei;