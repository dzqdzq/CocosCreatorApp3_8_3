"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){e[n=void 0===n?i:n]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCopyBuildTemplate=exports.onBeforeCompressSettings=exports.onAfterBundleInit=exports.onAfterInit=exports.throwError=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=__importStar(require("fs-extra")),path_1=require("path"),JsZip_1=require("./utils/JsZip"),electron_1=require("electron");async function onAfterInit(e,t,i){Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"fb-instant-games",value:{orientation:e.packages["fb-instant-games"].orientation}}),e.server&&!e.server.endsWith("/")&&(e.server+="/"),e.buildEngineParam.split=!1,e.buildEngineParam.assetURLFormat="runtime-resolved";e=e.packages["fb-instant-games"];t.staticsInfo.B100011=e.orientation}function onAfterBundleInit(e){e.buildScriptParam.system={preset:"web"},e.buildScriptParam.platform="HTML5"}async function onBeforeCompressSettings(e,i,t){i.paths.dir&&(e=e.packages["fb-instant-games"],i.settings.screen.orientation=e.orientation,i.settings.plugins.jsList.forEach((e,t)=>{i.settings.plugins.jsList[t]=e.split("/").map(encodeURIComponent).join("/")}))}async function onBeforeCopyBuildTemplate(e,t){var i=e.packages["fb-instant-games"],n=e.engineInfo.typescript.path,n=(0,path_1.join)(n,"templates/fb-instant-games"),s=this.buildTemplate.initUrl("index.js.ejs","indexEjs")||(0,path_1.join)(n,"index.js.ejs"),s=await ejs_1.default.renderFile(s,{applicationJS:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)}),s=await Build.Utils.transformCode(s,{importMapFormat:"systemjs"});if(!s)throw new Error("Unable to generate index.js");var r=(0,path_1.join)(t.paths.dir,"index.js"),s=((0,fs_extra_1.outputFileSync)(r,s,"utf-8"),(0,path_1.join)(t.paths.dir,"style.css"));this.buildTemplate.findFile("style.css")||(0,fs_extra_1.copyFileSync)((0,path_1.join)(n,"style.css"),s);let a="";i.embedWebDebugger&&(i=(0,path_1.join)(t.paths.dir,"vconsole.min.js"),e.md5CacheOptions.excludes.push(i),this.buildTemplate.findFile("vconsole.min.js")||(0,fs_extra_1.copyFileSync)((0,path_1.join)(n,"vconsole.min.js"),i),a="./vconsole.min.js");i=(0,fs_extra_1.readJSONSync)((0,path_1.join)(n,"fbapp-config.json")),i&&i.instant_games&&(i.instant_games.orientation=e.packages["fb-instant-games"].orientation.toUpperCase(),i.instant_games.override_web_orientation=e.packages["fb-instant-games"].orientation.toUpperCase(),(0,fs_extra_1.writeJsonSync)((0,path_1.join)(t.paths.dir,"fbapp-config.json"),i),e.md5CacheOptions.excludes.push((0,path_1.join)(t.paths.dir,"fbapp-config.json"))),i={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),projectName:e.name,engineName:e.buildEngineParam.engineName,webDebuggerSrc:a,cocosTemplate:(0,path_1.join)(n,"index-plugin.ejs"),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),indexJsName:(0,path_1.basename)(r),cssUrl:(0,path_1.basename)(s)},r=this.buildTemplate.initUrl("index.ejs","index")||(0,path_1.join)(n,"index.ejs"),s=await ejs_1.default.renderFile(r,i);(0,fs_extra_1.outputFileSync)((0,path_1.join)(t.paths.dir,"index.html"),s,"utf8"),e.md5CacheOptions.replaceOnly.push((0,path_1.join)(t.paths.dir,"index.html"))}async function onAfterBuild(e,t){const i=(0,path_1.join)(t.paths.dir,e.name.concat(".zip"));await _generate_zip(t.paths.dir,i).then(function(){electron_1.shell.showItemInFolder(i)}).catch(function(e){console.error(`Zip failed, error: ${e}.`)})}async function _generate_zip(e,t,i=[]){const n=new JsZip_1.JsZip;n.directory(e,(0,path_1.basename)(e));for(const r of i)n.remove(r);const s=fs_extra_1.default.createWriteStream(t);return new Promise(e=>{n.generateNodeStream({type:"nodebuffer",base64:!1,compression:"DEFLATE"}).pipe(s).on("finish",()=>{e()})})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterBuild=onAfterBuild;