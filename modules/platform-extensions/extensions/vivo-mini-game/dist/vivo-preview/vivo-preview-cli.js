"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.previewManager=void 0;const path_1=require("path"),fs_1=require("fs"),child_process_1=require("child_process"),cli_1=require("../utils/cli"),fs_extra_1=require("fs-extra"),killPort=require("./killPort");class PreviewManager{constructor(){this.lastPid=null,this.lastRpkPath="",this.lastPreviewIp="",this.port=null,this.packToolDir=(0,path_1.join)(Editor.App.path,"../tools","vivo-pack-tools")}run(e,s){var t;(0,cli_1.isInstallNodeJs)()?(0,fs_1.existsSync)(e)?(this.lastRpkPath=e,(0,fs_extra_1.copySync)((0,path_1.dirname)(e),(0,path_1.join)(this.packToolDir,"dist")),(0,fs_1.existsSync)((0,path_1.join)(this.packToolDir,"node_modules"))?(t="win32"===process.platform?"npm.cmd":"npm",t=(0,child_process_1.spawn)(t,["run","server"],{cwd:this.packToolDir}),this.lastPid=t.pid||null,(0,path_1.dirname)((0,path_1.dirname)(e)),t.stdout.on("data",e=>{var t,r;e&&-1!==e.indexOf("地址 http:")?(t=e.toString().replace(/[\n\r]/g,""),this.lastPreviewIp=t.match(r=/http:\/\/[^\s]*:(\d*)/)[0],this.port=Number(t.match(r)[1]),s(null,this.lastPreviewIp)):console.debug(e.toString())}),t.stderr.on("data",function(e){console.error(e.toString()),s(e)}),t.on("exit",(e,t)=>{console.debug("=======vivo preview process exit, exit:"+e)}),t.on("close",function(e,t){console.debug("=======vivo preview process close, exit:"+e)})):console.error("Please install in (vivo-pack-tools) first!")):console.error(`vivo rpk (${e}) does not exist, please build before preview!`):console.error("Please install nodeJs in global first!")}kill(e){killPort(e,this.port)}}exports.previewManager=new PreviewManager;