"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.install=exports.initVivoProject=exports.hasCliProject=exports.isInstallVivoMiniGameTool=exports.isInitVivo=exports.isInstallNodeJs=exports.initEnvironmentPath=void 0;const child_process_1=require("child_process"),fs_1=require("fs"),path_1=require("path"),fs_extra_1=require("fs-extra");let environmentPath=process.env;function initEnvironmentPath(e,n){e?(console.log(Editor.I18n.t("builder.custom_npm_path_config"),e),"win32"===process.platform?environmentPath.Path=e:(environmentPath.PATH=e,environmentPath.PATH+=":/usr/bin:/bin:/usr/sbin:/sbin")):(n&&console.log(Editor.I18n.t("builder.custom_npm_path_not_config")),environmentPath=process.env)}function isInstallNodeJs(){return new Promise((n,o)=>{(0,child_process_1.exec)("node -v",{env:environmentPath},e=>{e?(console.error(e),"win32"===process.platform?console.error(new Error(Editor.I18n.t("builder.window_default_npm_path_error"))):console.error(new Error(Editor.I18n.t("builder.mac_default_npm_path_error"))),o(!1)):n(!0)})})}function isInitVivo(e){return!(!(0,fs_1.existsSync)((0,path_1.join)(e,"node_modules"))||(0,fs_1.existsSync)((0,path_1.join)(e,"node_modules",".staging")))}function isInstallVivoMiniGameTool(){try{(0,child_process_1.execSync)("mg -v")}catch(e){return console.error(e),!1}return!0}function hasCliProject(e){return!!(0,fs_1.existsSync)((0,path_1.join)(e,"minigame.config.js"))}function initVivoProject(r){return(0,fs_extra_1.ensureDirSync)(r),new Promise((n,o)=>{(0,child_process_1.exec)(`mg init ${(0,path_1.basename)(r)} --force`,{cwd:(0,path_1.dirname)(r)},e=>{if(e)return console.error("init vivo project tools failed"),console.error(e),(0,fs_extra_1.removeSync)((0,path_1.join)(r,"node_modules")),o(e),!1;n(!0)})})}function install(r){const e="win32"===process.platform?"npm.cmd":"npm";return new Promise((n,o)=>{(0,child_process_1.exec)(e+" install",{cwd:r,env:environmentPath},e=>{if(!e)return console.log(Editor.I18n.t("builder.npm_installed_success")),n(!0),!0;console.error(e),console.error(new Error(Editor.I18n.t("builder.npm_install_fail"))),(0,fs_extra_1.removeSync)((0,path_1.join)(r,"node_modules")),o(e)})})}exports.initEnvironmentPath=initEnvironmentPath,exports.isInstallNodeJs=isInstallNodeJs,exports.isInitVivo=isInitVivo,exports.isInstallVivoMiniGameTool=isInstallVivoMiniGameTool,exports.hasCliProject=hasCliProject,exports.initVivoProject=initVivoProject,exports.install=install;