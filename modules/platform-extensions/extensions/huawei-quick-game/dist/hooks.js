"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,a,t,i){void 0===i&&(i=t);var r=Object.getOwnPropertyDescriptor(a,t);r&&("get"in r?a.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return a[t]}}),Object.defineProperty(e,i,r)}:function(e,a,t,i){e[i=void 0===i?t:i]=a[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,a){Object.defineProperty(e,"default",{enumerable:!0,value:a})}:function(e,a){e.default=a}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var a={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(a,e,t);return __setModuleDefault(a,e),a},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.debug=exports.make=exports.onBeforeCopyBuildTemplate=exports.onAfterBundleDataTask=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const path_1=__importStar(require("path")),fs_extra_1=require("fs-extra"),ejs_1=__importDefault(require("ejs")),ccbuild_1=require("@cocos/ccbuild"),separate_engine_1=require("./separate-engine"),crypto_1=require("crypto"),axios_1=__importDefault(require("axios")),verification_1=require("./utils/verification"),share_1=require("./share");function getResPath(e){return(0,path_1.join)(share_1.Paths.internalTemplateDir,"res",e)}async function onAfterInit(e,a,t){var i=e.packages["huawei-quick-game"],a=(e.generateCompileConfig=!0,e.server&&!e.server.endsWith("/")&&(e.server+="/"),a.staticsInfo.B100011=i.deviceOrientation,a.staticsInfo.B100005=i.package,(0,verification_1.verificationFunc)("minPlatformVersion",""+i.minPlatformVersion,e));if(a.error)throw new Error(a.error);if((0,fs_extra_1.existsSync)(share_1.Paths.packPath)||(console.debug("start unzip pack tools"),a=require("v-unzip"),r=share_1.Paths.packPath+".zip",await a.unzip(r,share_1.Paths.packPath)),i.separateEngine){a=(0,path_1.join)(Editor.App.path,".HEAD");if(!(0,fs_extra_1.existsSync)(a))throw new Error(Editor.I18n.t("huawei-quick-game.tips.get_package_date_fail"));var r=(0,fs_extra_1.readJSONSync)(a),i=new Date(r.time).toLocaleDateString().replace(/\//g,"."),a=share_1._ENGINE_PLUGIN_NAME+"-"+i+".rpk",r=share_1._ENGINE_PLUGIN_NAME+"-"+i+".sign";share_1.Paths.localPluginPath=(0,path_1.join)(Editor.App.path,"../resources/3d/engine","bin/.cache/editor-cache/huawei-quick-game"),share_1.Paths.localPluginLibraryPath=(0,path_1.join)(share_1.Paths.localPluginPath,a),share_1.Paths.localPluginSignPath=(0,path_1.join)(share_1.Paths.localPluginPath,r),(0,fs_extra_1.existsSync)(share_1.Paths.localPluginLibraryPath)&&(0,fs_extra_1.existsSync)(share_1.Paths.localPluginSignPath)||((0,fs_extra_1.ensureDirSync)(share_1.Paths.localPluginSignPath),(0,fs_extra_1.removeSync)(share_1.Paths.localPluginLibraryPath),(0,fs_extra_1.removeSync)(share_1.Paths.localPluginSignPath),await downloadFile(share_1._DOWNLOAD_URL_NOT_FILE_NAME+Editor.App.version+"/"+a,share_1.Paths.localPluginLibraryPath,a),await downloadFile(share_1._DOWNLOAD_URL_NOT_FILE_NAME+Editor.App.version+"/"+r,share_1.Paths.localPluginSignPath,r))}i=e.packages["huawei-quick-game"];e.buildScriptParam.flags.WASM_SUBPACKAGE=i.wasmSubpackage&&!i.separateEngine}function onBeforeBundleInit(e){e.polyfills&&(e.polyfills.asyncFunctions=!1),e.buildScriptParam.platform="HUAWEI",e.assetSerializeOptions.exportCCON=!0,e.moveRemoteBundleScript=!0,e.buildScriptParam.system={preset:"commonjs-like"}}async function downloadFile(e,a,t){try{await axios_1.default.get(e,{responseType:"arraybuffer"}).then(function(e){(0,fs_extra_1.writeFileSync)(a,new Int8Array(e.data))})}catch(e){console.warn(Editor.I18n.t("huawei-quick-game.tips.download_file_fail",{fileName:t}))}}async function onAfterBundleDataTask(e,a,t){const i=[];a.forEach(e=>{e.isSubpackage&&(e.scriptDest=path_1.default.join(e.dest,share_1.SUB_PACKAGE_JS_NAME),e=""+share_1.subpackagePrefix+e.name,i.push({name:e,resource:e+"/"}))}),i.length&&(e.packages["huawei-quick-game"].subpackages=i)}async function onBeforeCopyBuildTemplate(e,a,t,i){var r=e.packages["huawei-quick-game"],s=(await renderGameJs(this.buildTemplate.initUrl("game.ejs")||(0,path_1.join)(share_1.Paths.internalTemplateDir,"game.ejs"),e,a),await generateAdapter(e,a.paths.dir),r.separateEngine&&(await buildSeparateEngine(e,a),await handleImportMap(e,a)),writeConfigFile(a.paths.dir,e,a),handleSign(a.paths.dir,r.useDebugKey,r.privatePemPath,r.certificatePemPath),(0,path_1.join)(a.paths.dir,(0,path_1.basename)(r.icon)));(0,fs_extra_1.copySync)(r.icon,(0,path_1.join)(a.paths.dir,(0,path_1.basename)(r.icon))),e.md5CacheOptions.excludes.push(s)}async function buildSeparateEngine(e,a){var t=await(0,separate_engine_1.buildCocos)(),i=e.engineInfo.typescript.builtin,i=await ccbuild_1.StatsQuery.create(i),t=(0,path_1.join)(t,"cocos"),r=(0,path_1.join)(a.paths.dir,share_1._ENGINE_PLUGIN_NAME),t=((0,fs_extra_1.ensureDirSync)(r),Build.Utils.copyDirSync(t,r),i.getUnitsOfFeatures(e.includeModules)),e=(0,path_1.join)(a.paths.dir,"cocos-js/cc.js"),i=await ccbuild_1.buildEngine.transform(i.evaluateIndexModuleSource(t,e=>`plugin:cocos-library/${e}.js`),"system"),t=((0,fs_extra_1.emptyDirSync)((0,path_1.dirname)(e)),(0,fs_extra_1.outputFileSync)(e,i.code,"utf8"),(0,path_1.join)(r,"assets"));(0,fs_extra_1.existsSync)(t)&&(e=(0,path_1.join)(a.paths.dir,"cocos-js/assets"),(0,fs_extra_1.ensureDirSync)(e),(0,fs_extra_1.emptyDirSync)(e),Build.Utils.copyDirSync(t,e),(0,fs_extra_1.rmSync)(t,{force:!0,recursive:!0}))}async function handleImportMap(e,a){var a=(0,path_1.join)(a.paths.dir,"src/"+(0,path_1.basename)(a.paths.importMap)),t=await(0,fs_extra_1.readJson)(a);t.imports.cc="./../cocos-js/cc.js",null!=t&&t.imports["wait-for-ammo-instantiation"]&&(t.imports["wait-for-ammo-instantiation"]="plugin:cocos-library/wait-for-ammo-instantiation.js"),(0,fs_extra_1.writeJson)(a,t,{spaces:2})}async function make(e,a){var t={name:a.name,tinyPackageServer:a.server};if(!await Build.Utils.isInstallNodeJs())throw new Error("Please install nodejs in global first!");if(await copyFileFromOptionsDest(e,a),a.packages["huawei-quick-game"].separateEngine){a=(0,path_1.join)(e,"temp");if(await buildRpk(e,share_1.Paths.buildDir,a,t),!(0,fs_extra_1.existsSync)(share_1.Paths.localPluginLibraryPath))throw new Error(Editor.I18n.t("huawei-quick-game.tips.file_not_exist",{fileName:(0,path_1.basename)(share_1.Paths.localPluginLibraryPath)}));(0,fs_extra_1.copySync)(share_1.Paths.localPluginLibraryPath,(0,path_1.join)(a,share_1._ENGINE_PLUGIN_NAME+".rpk"));var i=await buildRpk(e,a,(0,path_1.join)(e,"dist"),t);(0,fs_extra_1.renameSync)(i,i+"s"),(0,fs_extra_1.removeSync)(a)}else await buildRpk(e,share_1.Paths.buildDir,(0,path_1.join)(e,"dist"),t)}async function debug(e,a){e=(0,path_1.join)(e,"dist",a.name+".rpk");Editor.Panel.open("runtime-dev-tools",{platform:"huawei-runtime",rpkPath:e})}async function generateAdapter(e,a){var t=(0,path_1.join)(a,"runtime-adapter"),a=e.engineInfo.typescript.path,i=(await(0,fs_extra_1.ensureDir)(t),e.platform),r=(0,path_1.join)(a,"bin/adapter/runtime"),a=(0,path_1.join)(r,`web-adapter${e.debug?"":".min"}.js`),s=(0,path_1.join)(t,"web-adapter.js");await(0,fs_extra_1.copy)(a,s);for(const n of["ral","engine-adapter"])await(0,fs_extra_1.copy)((0,path_1.join)(r,i,`${n}.${e.debug?"":"min."}js`),(0,path_1.join)(t,n+".js"))}async function copyFileFromOptionsDest(a,e){(0,fs_extra_1.emptyDirSync)(share_1.Paths.buildDir),(0,fs_extra_1.ensureDirSync)(share_1.Paths.buildDir);const t=[Build.SUBPACKAGES_HEADER,"cocos.compile.config.json","dist","sign","temp"],i=(e.server&&t.push("remote"),[]),r=((0,fs_extra_1.readdirSync)(a).forEach(e=>{t.includes(e)||i.push({src:(0,path_1.join)(a,e),dest:(0,path_1.join)(share_1.Paths.buildDir,e)})}),(0,path_1.join)(a,Build.SUBPACKAGES_HEADER));(0,fs_extra_1.existsSync)(r)&&(0,fs_extra_1.readdirSync)(r).forEach(e=>{i.push({src:(0,path_1.join)(r,e),dest:(0,path_1.join)(share_1.Paths.buildDir,""+share_1.subpackagePrefix+e)})}),await Promise.all(i.map(e=>{if((0,fs_extra_1.existsSync)(e.src))return(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(e.dest)),(0,fs_extra_1.copySync)(e.src,e.dest)}))}async function renderGameJs(e,a,t){var i={optionDebug:a.debug,polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:t.paths.systemJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},e=await ejs_1.default.renderFile(e,i);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,"game.js"),e,"utf8"),a.md5CacheOptions.replaceOnly.push((0,path_1.join)(t.paths.dir,"game.js"))}async function buildRpk(e,a,t,i){var r=(0,path_1.join)(e,"sign/release/private.pem"),s=(0,path_1.join)(e,"sign/release/certificate.pem"),n=(console.log(Editor.I18n.t("huawei-quick-game.tips.rpk_installing")),(0,path_1.join)(share_1.Paths.packPath,"lib","bin")),o=JSON.parse(JSON.stringify(process.env)),n=(o.PATH+=":"+n,[(0,path_1.join)(share_1.Paths.packPath,"index.js"),a,t,i.name,r,s]),a=await Build.Utils.quickSpawn("node",n,{cwd:e,env:o,downGradeError:!0});if(!0===a)return t=(0,path_1.join)(e,"dist",i.name+".rpk"),console.log(Editor.I18n.t("huawei-quick-game.tips.rpk_install_success")+`{link(${t})}`),t;throw new Error(Editor.I18n.t("huawei-quick-game.tips.rpk_install_fail")+a)}function writeConfigFile(t,e,a){var i,r=e.packages["huawei-quick-game"],s=(0,path_1.join)(t,"manifest.json");e.md5CacheOptions.excludes.push(s);const n={package:r.package,appType:"fastgame",name:e.name,versionName:r.versionName,versionCode:r.versionCode,minPlatformVersion:r.minPlatformVersion,icon:"/"+(0,path_1.basename)(r.icon),router:{},permissions:[{origin:"*"}]};let o;if(r.manifestPath&&(0,fs_extra_1.existsSync)(r.manifestPath))try{o=(0,fs_extra_1.readJSONSync)(r.manifestPath),console.debug("custom_manifest_data",JSON.stringify(o));const c=["package","appType","name","versionName","versionCode","icon","minPlatformVersion","permissions","plugins"];Object.keys(o).forEach(e=>{c.includes(e)||(n[e]=o[e])})}catch(e){console.log(Editor.I18n.t("builder.custom_manifest_data_error"))}if(e.packages["huawei-quick-game"]&&((e=e.packages["huawei-quick-game"]).wasmSubpackage&&!e.separateEngine&&(i=(0,path_1.join)(a.paths.engineDir,"./assets/"),a=(0,path_1.join)(a.paths.engineDir,"./chunks/"),(0,fs_extra_1.existsSync)(i)&&(null==e.subpackages&&(e.subpackages=[]),e.subpackages.push({name:"__ccWasmAssetSubpkg__",resource:"cocos-js/assets/"})),(0,fs_extra_1.existsSync)(a))&&(null==e.subpackages&&(e.subpackages=[]),e.subpackages.push({name:"__ccWasmChunkSubpkg__",resource:"cocos-js/chunks/"})),n.subpackages=e.subpackages),n.config||(n.config={}),n.display||(n.display={}),n.config.logLevel=r.logLevel,n.display.orientation=r.deviceOrientation,n.display.fullScreen=r.fullScreen,r.separateEngine){let e="";(0,fs_extra_1.existsSync)(share_1.Paths.localPluginLibraryPath)?((i=(0,crypto_1.createHash)("sha256")).update((0,fs_extra_1.readFileSync)(share_1.Paths.localPluginLibraryPath)),e=i.digest("hex")):console.warn(Editor.I18n.t("huawei-quick-game.tips.file_not_exist",{fileName:(0,path_1.basename)(share_1.Paths.localPluginLibraryPath)}));let a="";(0,fs_extra_1.existsSync)(share_1.Paths.localPluginSignPath)?a=(0,fs_extra_1.readFileSync)(share_1.Paths.localPluginSignPath,"utf8"):console.warn(Editor.I18n.t("huawei-quick-game.tips.file_not_exist",{fileName:(0,path_1.basename)(share_1.Paths.localPluginSignPath)})),n.plugins={},n.plugins[share_1._ENGINE_PLUGIN_NAME]={provider:e,signature:a,version:Editor.App.version,path:share_1._ENGINE_PLUGIN_NAME},(0,fs_extra_1.outputJSONSync)((0,path_1.join)(t,share_1._ENGINE_PLUGIN_NAME+"/plugin.json"),{},{spaces:2})}(0,fs_extra_1.writeJSONSync)(s,n)}function handleSign(e,a,t,i){e=(0,path_1.join)(e,"sign"),(0,fs_extra_1.emptyDirSync)(e),e=(0,path_1.join)(e,"release");(0,fs_extra_1.ensureDirSync)(e),a?((0,fs_extra_1.writeFileSync)((0,path_1.join)(e,"private.pem"),(0,fs_extra_1.readFileSync)(getResPath("private.pem"))),(0,fs_extra_1.writeFileSync)((0,path_1.join)(e,"certificate.pem"),(0,fs_extra_1.readFileSync)(getResPath("certificate.pem")))):((0,fs_extra_1.existsSync)(t)&&(0,fs_extra_1.writeFileSync)((0,path_1.join)(e,"private.pem"),(0,fs_extra_1.readFileSync)(t)),(0,fs_extra_1.existsSync)(i)&&(0,fs_extra_1.writeFileSync)((0,path_1.join)(e,"certificate.pem"),(0,fs_extra_1.readFileSync)(i)))}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBundleDataTask=onAfterBundleDataTask,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.make=make,exports.debug=debug;