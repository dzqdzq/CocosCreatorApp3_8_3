"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a);var n=Object.getOwnPropertyDescriptor(t,a);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,i,n)}:function(e,t,a,i){e[i=void 0===i?a:i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onAfterCopyBuildTemplate=exports.onBeforeCopyBuildTemplate=exports.onBeforeCompressSettings=exports.onAfterBuildAssets=exports.onAfterBundleBuildTask=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importStar(require("ejs")),separate_engine_1=require("./separate-engine"),ccbuild_1=require("@cocos/ccbuild"),fs_1=require("fs"),share_1=require("./share"),userTemplateDir=(0,path_1.join)(Build.buildTemplateDir,"wechatgame"),OPEN_DATA_CONTEXT_ROOT="openDataContext";async function onAfterInit(e,t,a){var i,n,s=e.packages.wechatgame,r=(share_1.Paths.internalTemplateDir=(0,path_1.join)(e.engineInfo.typescript.path,"templates/wechatgame"),e.server&&!e.server.endsWith("/")&&(e.server+="/"),/\d*\.\d*\.\d*$/.test(Editor.App.version)||Editor.App.dev),r=(r?(s.separateEngine&&e.debug&&console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_with_debug")),"builtin"===e.engineInfo.typescript.type?s.separateEngine=s.separateEngine&&!e.debug:console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_with_custom_engine"))):console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_only_in_normal_version")),Object.assign(e.buildEngineParam,{sourceMaps:!s.separateEngine&&e.sourceMaps,split:s.separateEngine,skip:s.separateEngine}),e.buildEngineParam.assetURLFormat="relative-from-out",(0,path_1.join)(t.paths.dir,OPEN_DATA_CONTEXT_ROOT)),o=(0,path_1.join)(Editor.Project.tmpDir,"builder/wechatagame",OPEN_DATA_CONTEXT_ROOT);(0,fs_extra_1.existsSync)(r)&&((0,fs_extra_1.existsSync)(o)&&(0,fs_extra_1.removeSync)(o),(0,fs_extra_1.copySync)(r,o)),e.useSplashScreen&&({logo:i,background:n}=await Editor.Profile.getProject("builder","splash-setting"),"custom"===i.type&&i.image&&!await validRatio(Editor.UI.__protected__.File.resolveToRaw(i.image))||"custom"===n.type&&n.image&&!await validRatio(Editor.UI.__protected__.File.resolveToRaw(n.image)))&&console.error("The width or height of the splash screen image cannot be larger than 2048 for wechatgame!"),t.staticsInfo.B100011=s.orientation,t.staticsInfo.B100013=s.appid,(0,fs_extra_1.existsSync)(o)?(0,fs_extra_1.moveSync)(o,r):s.buildOpenDataContextTemplate&&(i=e.engineInfo.typescript.path,n=(0,path_1.join)(i,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT),(0,fs_extra_1.copySync)(n,r)),e.buildScriptParam.flags.WASM_SUBPACKAGE=s.wasmSubpackage&&!s.separateEngine}function onBeforeBundleInit(e){e.moveRemoteBundleScript=!0,e.polyfills&&(e.polyfills.asyncFunctions=!1),e.buildScriptParam.platform="WECHAT",e.buildScriptParam.importMapFormat="commonjs",e.assetSerializeOptions.exportCCON=!0}async function onAfterBundleBuildTask(e,t,a){const i=[];t.forEach(e=>{var t;e.isSubpackage&&(t=(0,path_1.join)((0,path_1.dirname)(e.scriptDest),"game.js"),(0,fs_extra_1.existsSync)(e.scriptDest)?(0,fs_extra_1.renameSync)(e.scriptDest,t):(0,fs_extra_1.outputFileSync)(t,`console.log('${ejs_1.name}: no script in subPackage.')`,"utf8"),e.scriptDest=t,i.push({name:e.name,root:`subpackages/${e.name}/`}))}),i.length&&(e.packages.wechatgame.subpackages=i)}function validRatio(i){return new Promise((e,t)=>{const a=new Image;a.src="data:image/png;base64,"+(0,fs_extra_1.readFileSync)(i).toString("base64"),a.onload=function(){(2048<a.width||2048<a.height)&&e(!1),e(!0)},a.onerror=function(e){t(e)}})}async function onAfterBuildAssets(e,t,a){e.useSplashScreen||(e.useSplashScreen=!0)}async function onBeforeCompressSettings(e,t,a){t.paths.dir&&(t.settings.scripting.scriptPackages=t.scriptPackages.map(e=>"project://"+(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/")),t.settings.splashScreen)&&(t.settings.splashScreen.totalTime=0)}async function onBeforeCopyBuildTemplate(e,t,a){var i=e.engineInfo.typescript.path;for(const p of["web-adapter","engine-adapter"])await(0,fs_extra_1.copy)((0,path_1.join)(i,"bin/adapter/minigame/wechat",`${p}.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,p+".js"));var n,s,r,o=(0,path_1.join)(t.paths.dir,"game.js");e.md5CacheOptions.replaceOnly.push(o),this.buildTemplate.findFile("game.js")||(n=this.buildTemplate.initUrl("game.ejs")||(0,path_1.join)(share_1.Paths.internalTemplateDir,"game.ejs"),s=null==(s=t.settings.engine.macros)?void 0:s.ENABLE_TRANSPARENT_CANVAS,r=null==(r=t.settings.engine.macros)?void 0:r.ENABLE_WEBGL_ANTIALIAS,s={engineName:e.buildEngineParam.engineName,cocosTemplate:(0,path_1.join)(share_1.Paths.internalTemplateDir,"cocos-script.ejs"),polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),engineDir:Build.Utils.relativeUrl(t.paths.dir,t.paths.engineDir),alpha:void 0===s?"default":s,antialias:void 0===r?"default":r,useWebgl2:e.includeModules.includes("gfx-webgl2")},r=await ejs_1.default.renderFile(n,s),(0,fs_extra_1.writeFileSync)(o,r,"utf8"))}async function onAfterCopyBuildTemplate(e,t){var a=e.engineInfo.typescript.path;(0,path_1.join)(a,"templates/taobao-mini-game");await buildGameJson(t.paths.dir,e,t,this.buildTemplate.findFile("game.json")),buildProjectConfig(t.paths.dir,e,this.buildTemplate.findFile("project.config.json"))}async function onAfterBuild(e,t){e.packages.wechatgame.separateEngine&&(await buildSeparateEngine(e,t),Build.ScriptBuilder.outputImportMap(t.importMap,{dest:t.paths.importMap,importMapFormat:e.buildScriptParam.importMapFormat,debug:e.debug})),await buildWeChatSplash(t);var a,i,n,s,e=(0,path_1.join)(t.paths.dir,"first-screen.js");this.buildTemplate.findFile("first-screen.js")||(n=t.settings.splashScreen,a=(0,path_1.join)(share_1.Paths.internalTemplateDir,"first-screen.ejs"),i=null==(i=n.background)?void 0:i.color,s=n.logo,n=n.background,s={displayRatio:null!=(t=null==(t=t.settings.splashScreen)?void 0:t.displayRatio)?t:1,bgColor:i?[i.x,i.y,i.z,i.w]:[0,0,0,1],useCustomBg:"custom"===(null==n?void 0:n.type),useLogo:null===(t="none"!==(null==s?void 0:s.type))||t,useDefaultLogo:null===(i="default"===(null==s?void 0:s.type))||i,logoName:(0,path_1.basename)(null!=(t=null==s?void 0:s.image)?t:"logo.png"),bgName:(0,path_1.basename)(null!=(i=null==n?void 0:n.image)?i:"background.png")},t=await ejs_1.default.renderFile(a,s),(0,fs_extra_1.writeFileSync)(e,t,"utf8"))}async function buildSeparateEngine(e,i){(0,fs_extra_1.ensureDirSync)(i.paths.engineDir),await(0,separate_engine_1.buildCocos)(!Editor.App.dev);var e=e.buildEngineParam.includeModules,t=await ccbuild_1.StatsQuery.create(separate_engine_1.separateEnginPaths.internalEngine),a=t.getUnitsOfFeatures(e);const n=(0,separate_engine_1.getWechatPluginFeatures)(),s=t.getUnitsOfFeatures(n);var r=a.filter(e=>!n.includes(e));const o=(0,fs_extra_1.readJSONSync)((0,path_1.join)(separate_engine_1.separateEnginPaths.outDir,"meta.json"));var p=(0,path_1.join)(i.paths.engineDir,"cc.js"),t=await ccbuild_1.buildEngine.transform(t.evaluateIndexModuleSource(a,e=>s.includes(e)?`plugin:cocos/${e}.js`:`./${e}.js`),"system"),a=((0,fs_extra_1.writeFileSync)(p,t.code,"utf8"),ccbuild_1.buildEngine.enumerateDependentChunks(o,r));const l=ccbuild_1.buildEngine.enumerateDependentChunks(o,s);p=ccbuild_1.buildEngine.enumerateDependentAssets(o,r).concat(ccbuild_1.buildEngine.enumerateDependentAssets(o,s));const c=null!=(t=i.importMap.imports)?t:{},u=e=>e in o.chunkAliases,d=e=>{var t;return null!=(t=o.chunkAliases[e])?t:e},g=e=>{var t=d(e),a=(0,path_1.join)(i.paths.engineDir,t);(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(a)),(0,fs_extra_1.copyFileSync)((0,path_1.join)(separate_engine_1.separateEnginPaths.cacheCocos,t),a),u(e)&&(c[e]=`../${(0,path_1.basename)(i.paths.engineDir)}/`+t)};a.forEach(e=>{var t,a;l.includes(e)?(t=e,a=d(t),t=u(t)?t:`../${(0,path_1.basename)(i.paths.engineDir)}/`+a,a="plugin:cocos/"+a,c[t]=a):g(e)}),p.forEach(e=>{g(e)}),c.cc=`./${Build.Utils.relativeUrl((0,path_1.dirname)(i.paths.importMap),i.paths.engineDir)}/cc.js`,e.includes("physics-ammo")&&(c["wait-for-ammo-instantiation"]=`./${Build.Utils.relativeUrl((0,path_1.dirname)(i.paths.importMap),i.paths.engineDir)}/wait-for-ammo-instantiation.js`),i.importMap.imports=c;r=(0,path_1.join)(i.paths.dir,"cocos");await(0,separate_engine_1.generateCocos)(l,r)}function readAllFilesDeep(e){if(!(0,fs_extra_1.statSync)(e).isDirectory())return[e];var t=[];for(const n of(0,fs_1.readdirSync)(e)){var a=(0,path_1.join)(e,n),i=readAllFilesDeep(a);i.length?t.push(...i):t.push(a)}return t}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;var[a,i]=[e.split("."),t.split(".")],n=Math.max(a.length,i.length);for(let e=0;e<n;e++)if(parseInt(a[e])>parseInt(i[e]))return!0;return!1}async function _buildWeChatTemplate(e,t,a){}async function buildWeChatSplash(n){var e=await Editor.Message.request("information","query-information","customSplash"),t=await Editor.Profile.getProject("builder","splash-setting"),a={logo:"",background:"",slogan:""};e&&e.data&&e.data.enable&&!e.data[e.data.id].complete?(a.logo=(0,path_1.join)(share_1.Paths.internalTemplateDir,"logo.png"),a.slogan=(0,path_1.join)(share_1.Paths.internalTemplateDir,"slogan.png")):("default"===t.logo.type?(a.logo=(0,path_1.join)(share_1.Paths.internalTemplateDir,"logo.png"),a.slogan=(0,path_1.join)(share_1.Paths.internalTemplateDir,"slogan.png")):"custom"===t.logo.type&&t.logo.image&&(a.logo=Editor.UI.__protected__.File.resolveToRaw(t.logo.image)),"custom"===t.background.type&&t.background.image&&(a.background=Editor.UI.__protected__.File.resolveToRaw(t.background.image)));const s=n.settings.splashScreen,r=[];Object.entries(a).forEach(([e,t])=>{if(t)try{var a=(0,path_1.parse)(t)["ext"],i=(0,path_1.join)(n.paths.dir,""+e+a);r.push({source:t,target:i}),null!==s&&void 0!==s&&s.logo&&"logo"===e&&(s.logo.image=(0,path_1.relative)(n.paths.settings,i)),null!==s&&void 0!==s&&s.background&&"background"===e&&(s.background.image=(0,path_1.relative)(n.paths.settings,i))}catch(e){console.warn(e)}}),await Promise.all(r.map(({source:e,target:t})=>(0,fs_extra_1.copyFile)(e,t)));e=(0,fs_extra_1.readFileSync)(n.paths.settings,"utf8"),t=JSON.parse(e);t.splashScreen=s,(0,fs_extra_1.writeFileSync)(n.paths.settings,JSON.stringify(t,null,0),"utf8")}function buildProjectConfig(e,t,a){var i=t.packages.wechatgame,n=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"project.config.json")),a=(a&&(a=(0,fs_extra_1.readJSONSync)(a),Object.assign(n,a)),n.appid=i.appid||"wx6ac3f5090a6b99c5",n.projectname=t.name,t.server&&t.useBuiltinServer&&(n.packOptions={ignore:[{type:"folder",value:"remote"}]}),(0,path_1.join)(e,"project.config.json"));t.md5CacheOptions.excludes.push(a),(0,fs_extra_1.outputJSONSync)(a,n)}async function buildGameJson(e,t,a,i){var n=t.packages.wechatgame,s=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"game.json"));if(i&&(i=(0,fs_extra_1.readJSONSync)(i),Object.assign(s,i)),s.deviceOrientation=n.orientation,n.separateEngine){var i=(0,path_1.join)(share_1.Paths.internalTemplateDir,"patch.json");let e=Editor.App.version;(0,fs_extra_1.existsSync)(i)&&(e=await Editor.Profile.getConfig("utils",Editor.App.version.replace(".","_")+"_plugin_version.wechatgame")||Editor.App.version),s.plugins={cocos:{version:e,provider:require((0,path_1.join)(__dirname,"../static/cocos/signature.json")).provider}}}n.buildOpenDataContextTemplate?s.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete s.openDataContext,n.highPerformanceMode?s.iOSHighPerformance=!0:delete s.iOSHighPerformance,n.wasmSubpackage&&!n.separateEngine&&(i=(0,path_1.join)(a.paths.engineDir,"./assets/"),a=(0,path_1.join)(a.paths.engineDir,"./chunks/"),(0,fs_extra_1.existsSync)(i)&&(null==n.subpackages&&(n.subpackages=[]),n.subpackages.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"})),(0,fs_extra_1.existsSync)(a))&&(null==n.subpackages&&(n.subpackages=[]),n.subpackages.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"})),n.subpackages&&(s.subpackages=n.subpackages);i=(0,path_1.join)(e,"game.json");t.md5CacheOptions.excludes.push(i),(0,fs_extra_1.outputJSONSync)(i,s,{spaces:4})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onAfterBuildAssets=onAfterBuildAssets,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterCopyBuildTemplate=onAfterCopyBuildTemplate,exports.onAfterBuild=onAfterBuild;