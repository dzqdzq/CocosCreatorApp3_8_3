"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,a,t,r){void 0===r&&(r=t);var s=Object.getOwnPropertyDescriptor(a,t);s&&("get"in s?a.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return a[t]}}),Object.defineProperty(e,r,s)}:function(e,a,t,r){e[r=void 0===r?t:r]=a[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,a){Object.defineProperty(e,"default",{enumerable:!0,value:a})}:function(e,a){e.default=a}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var a={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(a,e,t);return __setModuleDefault(a,e),a};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.listeners=exports.methods=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),panel_menu_1=require("./components/panel-menu"),separate_box_1=require("./components/separate-box"),panelData=__importStar(require("./components/panel-data")),treeData=__importStar(require("./components/tree-data")),utils=__importStar(require("./components/utils")),util_1=require("./util"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel,vm;const vueTemplate=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../static/template/index.html"),"utf8"),AssetPanelVM=Vue.extend({name:"AssetPanelVM",components:{tree:require("./components/tree"),SeparateBox:separate_box_1.SeparateBox},data(){return{refocus:!1,dbReady:!1,warnCase:"",operateLock:!1,refreshLock:!1,isOperating:!1,refreshing:{type:"",name:""},droppableTypes:["file","cc.Node"],allExpand:null,viewWidth:0,viewHeight:0,treeHeight:0,dropBoxStyle:{},searchValue:"",searchInFolder:null,searchAssetTypes:[],searchType:"name",searchTypeLabel:"i18n:assets.menu.searchName",extendSearchFunc:{},sortType:"name",localFileExtend:[]}},computed:{searchPlaceholder(){var e;return this.searchTypeLabel||"i18n:assets.menu.search"+((e=this.searchType).toLocaleUpperCase().substr(0,1)+e.substr(1))},hasLocalFileExtend(){return!!this.localFileExtend.length}},watch:{searchValue(){panelData.$.searchInput.value=this.searchValue,panelData.$.tree.search()},searchAssetTypes(){panelData.$.searchInput.focus(),panelData.$.tree.search()},searchType(){"usages"===this.searchType?this.searchAssetTypes=["cc.SceneAsset","cc.Prefab","cc.Material","cc.AnimationClip"]:(panelData.$.searchInput.focus(),panelData.$.tree.search())},searchInFolder(){panelData.$.searchInput.focus(),panelData.$.tree.search()},sortType(){panelData.$.tree.sort()},async localFileExtend(){await panelData.$.panel.initLocalFileTree()}},async mounted(){panelData.$.panel=this,panelData.$.searchInput=this.$refs.searchInput,panelData.$.toggleExpandIcon=this.$refs.toggleExpandIcon,panelData.$.viewBox=this.$refs.viewBox,panelData.$.tree=this.$refs.tree,panelData.$.viewBox.addEventListener("scroll",e=>{this.treeHeight>this.viewHeight&&this.treeHeight<this.viewHeight+e.target.scrollTop?panelData.$.tree.scrollTop=this.treeHeight-this.viewHeight:panelData.$.tree.scrollTop=e.target.scrollTop},!1)},methods:{t(e){return Editor.I18n.t("assets."+e)},async refresh(){try{this.dbReady=!1,await panelData.config.update(),panelData.$.tree.update(),this.isOperating=!0,await treeData.reset(),this.isOperating=!1}catch(e){console.error(e)}finally{this.dbReady=!0}},async refreshDB(){await Editor.Profile.getConfig("asset-db","autoScan")?this.refresh():(this.refreshLock=!0,Editor.Message.send("asset-db","refresh-all-database"))},warnShow(e){this.warnCase=e,this.operateLock=!0},warnHide(){this.warnCase="",this.operateLock=!1,this.refresh()},clear(){this.dbReady=!1,panelData.$.tree.clear()},allToggle(){panelData.$.tree.allToggle()},searchChange(){this.searchValue=panelData.$.searchInput.value.trim()},searchArrowDown(e,a){e.target.blur(),this.searchValue?panelData.$.tree.ipcSelectFirstChild():panelData.$.tree.upDownLeftRight(a)},cancelSearchType(){this.searchType="name",this.searchTypeLabel=""},cancelSearchInFolder(){this.searchInFolder=null},cancelSearchAssetTypes(){this.searchAssetTypes=[]},clearSearch(){this.searchInFolder=null,this.searchValue="",this.searchAssetTypes=[],"fails"===this.searchType&&(this.searchType="name")},popupCreateMenu:panel_menu_1.popupCreateMenu,popupSearchMenu:panel_menu_1.popupSearchMenu,popupSortMenu:panel_menu_1.popupSortMenu,popupPanelMenu:panel_menu_1.popupPanelMenu,resize(){vm&&panelData.$.viewBox&&setTimeout(()=>{this.viewWidth=panel.clientWidth,this.viewHeight=parseInt(panelData.$.viewBox.style.height),panelData.$.tree.filterAssets()},0)},focusWindow(){require("@electron/remote").getCurrentWindow().focus()},isSearchingMode(){return utils.isSearchingMode()},async initLocalFileTree(){if(this.localFileExtend.length){var e=await Promise.all(this.localFileExtend.map(async e=>(0,util_1.getPackageFileExtend)(e.path)));const t=this.$refs.localFile;t&&(t.tree=e,t.setTemplate("text",'<span class="name"></span>'),t.setTemplateInit("text",e=>{e.$name=e.querySelector(".name")}),t.setRender("text",(e,a)=>{e.$name.innerHTML=a.detail.value}),t.setTemplateInit("item",a=>{a.addEventListener("dblclick",e=>{a.data.isDirectory||(0,util_1.openFile)(a.data.filePath,a.data.root),t.render()})}),t.setRender("item",(e,a)=>{a.detail.disabled?e.setAttribute("disabled",""):e.removeAttribute("disabled")}))}},async resetSearchParams(){this.searchValue&&(this.searchValue=""),this.searchInFolder&&(this.searchInFolder=null),this.searchAssetTypes.length&&(this.searchAssetTypes=[]),this.searchType="name",this.searchTypeLabel="i18n:assets.menu.searchName",await this.$nextTick()}},template:vueTemplate});async function ready(){panel=this,vm?.$destroy(),(vm=new AssetPanelVM).$mount(panel.$.container),panel.viewBoxObserver=new IntersectionObserver(e=>{e.forEach(e=>{0!==e.intersectionRatio&&vm&&vm.resize()})},{root:vm.$el,rootMargin:"0px",threshold:.1}),panel.viewBoxObserver.observe(panelData.$.viewBox);Editor.Package.getPackages({enable:!0}).forEach(panelData.extension.attach),Editor.Package.__protected__.on("enable",panelData.extension.attach),Editor.Package.__protected__.on("disable",panelData.extension.detach);var e=await Editor.Message.request("asset-db","query-ready");e&&await exports.methods.ready()}async function beforeClose(){vm&&await exports.methods.staging()}function close(){vm&&(vm.dbReady=!1,panelData.clear(),treeData.clear()),panel&&panel.viewBoxObserver.disconnect(),Editor.Package.__protected__.removeListener("enable",panelData.extension.attach),Editor.Package.__protected__.removeListener("disable",panelData.extension.detach),vm?.$destroy(),vm=null,panel=null}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../dist/index.css"),"utf8"),exports.template='<div class="container"></div>',exports.$={container:".container"},exports.methods={async staging(){var e=[];for(const a in treeData.uuidToExpand)treeData.uuidToAsset[a]&&!0===treeData.uuidToExpand[a]&&e.push(a);await Editor.Message.request("assets","staging",{expandUuids:e,sortType:vm.sortType})},async unstaging(){var e,a=await Editor.Message.request("assets","unstaging");vm&&a&&({expandUuids:a,sortType:e}=a,Array.isArray(a)&&a.forEach(e=>{treeData.uuidToExpand[e]=!0}),e)&&(vm.sortType=e)},find(){vm&&vm.dbReady&&panelData.$.searchInput.focus()},copy(){vm&&vm.dbReady&&panelData.$.tree.copy()},paste(){if(vm&&vm.dbReady&&!vm.isOperating)try{panelData.$.tree.paste(),vm.isOperating=!0}catch(e){console.error(e)}finally{setTimeout(()=>{vm.isOperating=!1},200)}},cut(){vm&&vm.dbReady&&panelData.$.tree.cut()},duplicate(){if(vm&&vm.dbReady&&!vm.isOperating)try{panelData.$.tree.duplicate(),vm.isOperating=!0}catch(e){console.error(e)}finally{setTimeout(()=>{vm.isOperating=!1},200)}},delete(){vm&&vm.dbReady&&panelData.$.tree.delete()},up(){vm&&vm.dbReady&&panelData.$.tree.upDownLeftRight("up")},down(){vm&&vm.dbReady&&panelData.$.tree.upDownLeftRight("down")},left(){vm&&vm.dbReady&&panelData.$.tree.upDownLeftRight("left")},right(){vm&&vm.dbReady&&panelData.$.tree.upDownLeftRight("right")},shiftUp(){vm&&vm.dbReady&&panelData.$.tree.shiftUpDown("up")},shiftDown(){vm&&vm.dbReady&&panelData.$.tree.shiftUpDown("down")},rename(){vm&&vm.dbReady&&panelData.$.tree.keyboardRename()},selectAll(){vm&&vm.dbReady&&panelData.$.tree.selectAll()},selectClear(){vm&&vm.dbReady&&panelData.$.tree.selectClear()},async ready(){vm&&(Editor.Metrics.trackTimeStart("assets:render-tree"),vm.dbReady=!0,await exports.methods.unstaging(),vm&&(await vm.refresh(),vm)&&panelData.$.tree.resetSelected(),Editor.Metrics.trackTimeEnd("assets:render-tree",{output:!0}))},refreshFinish(){vm&&(vm.refreshLock=!1)},close(){vm&&vm.clear()},dbReady(){vm&&vm.dbReady&&vm.refresh()},dbClose(){vm&&vm.dbReady&&vm.refresh()},dbPause(e){vm&&vm.dbReady&&vm.warnShow(e)},dbResume(){vm&&vm.warnHide()},async added(e,a){vm&&vm.dbReady&&await panelData.$.tree.added(e,a)},async deleted(e,a){vm&&vm.dbReady&&await panelData.$.tree.deleted(e,a)},async changed(e,a){vm&&vm.dbReady&&await panelData.$.tree.changed(e,a)},selected(e,a){vm&&vm.dbReady&&"asset"===e&&panelData.$.tree.selected(a)},unselected(e,a){vm&&vm.dbReady&&"asset"===e&&panelData.$.tree.unselected(a)},async twinkle(e,a="hint"){var t;e&&vm&&(await vm.resetSearchParams(),panelData.$.tree.clearSearchTimer(),(t=treeData.urlToUuid[e]||treeData.fileToUuid[e])&&(e=t),"cc.Texture2D"===treeData.uuidToAsset[e]?.type&&(e=e.split("@")[0]),utils.twinkle.add(e,a),await utils.scrollIntoView(e,!0))},async queryAsset(e,a){return utils.getAssetForPreview(e,a)},async queryChildren(e,a){return utils.getChildrenForPreview(e,a)}},exports.listeners={resize(){vm&&vm.resize()},show(){vm&&vm.resize()},focus(){vm&&(vm.refocus=!0,setTimeout(()=>{vm&&(vm.refocus=!1)},300))}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;