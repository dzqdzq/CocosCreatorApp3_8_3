"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,i)}:function(e,t,r,o){e[o=void 0===o?r:o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getChildrenInvalid=exports.pointExpand=exports.toggleExpand=exports.loopExpand=exports.outputDisplay=exports.resort=exports.renderImmediately=exports.render=exports.unFreeze=exports.deleted=exports.added=exports.changed=exports.clear=exports.reset=exports.uuidToExpand=exports.uuidToIndex=exports.uuidToDepth=exports.displayArray=exports.uuidToChildrenSorted=exports.uuidToChildren=exports.uuidToParentUuid=exports.uuidToState=exports.fileToUuid=exports.urlToUuid=exports.uuidToAsset=exports.dbInternal=exports.dbAssets=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),panelData=__importStar(require("./panel-data")),utils=__importStar(require("./utils")),util_1=require("../util");exports.dbAssets="db://assets",exports.dbInternal="db://internal",exports.uuidToAsset={},exports.urlToUuid={},exports.fileToUuid={},exports.uuidToState={},exports.uuidToParentUuid={},exports.uuidToChildren={},exports.uuidToChildrenSorted={},exports.displayArray=[],exports.uuidToDepth={},exports.uuidToIndex={},exports.uuidToExpand={};let refreshTime,renderAnimationId;async function reset(){var e=await Editor.Message.request("asset-db","query-assets");e?(clear(),e.sort((e,t)=>{var r=e.url.startsWith(exports.dbAssets),o=e.url.startsWith(exports.dbInternal),i=t.url.startsWith(exports.dbAssets),s=t.url.startsWith(exports.dbInternal);return!r&&!o||i||s?r||o||!i&&!s?util_1.collator.compare(e.url,t.url):1:-1}),exports.uuidToChildrenSorted[panelData.config.protocol]=!0,buildTree(e),initExpand(),render()):console.error("The data requested from asset-db is empty.")}function clear(){exports.uuidToAsset={},exports.urlToUuid={},exports.fileToUuid={},exports.uuidToChildren={},exports.uuidToChildrenSorted={},exports.uuidToDepth={},exports.uuidToIndex={},exports.uuidToParentUuid={},exports.uuidToState={},exports.displayArray=[],exports.uuidToIndex={length:0},refreshTime=Date.now()}function initExpand(){exports.uuidToExpand[panelData.config.protocol]||(exports.uuidToExpand[panelData.config.protocol]=!0,exports.uuidToExpand[exports.dbAssets]=!0)}function changed(e,t){if(e.includes("@")){const s=exports.uuidToParentUuid[e];if(!s)return;unFreeze(s)&&render()}refreshTime=Date.now();var r=exports.uuidToAsset[e],o=exports.uuidToParentUuid[e];if(r){if(delete exports.urlToUuid[r.url],delete exports.fileToUuid[r.file],"isParent"in r&&r.isParent&&!r.isDirectory){for(const u of exports.uuidToChildren[e])loopDeleteSelf(u);delete exports.uuidToChildren[e],delete exports.uuidToChildrenSorted[e];r=Object.keys(t.subAssets);if(r.length){var i={children:{},uuid:e};for(const d of r)i.children[d]={children:{}},buildTreeData(t.subAssets[d],i.children[d],i)}}exports.uuidToAsset[e]=t,exports.urlToUuid[t.url]=e,t.file&&(exports.fileToUuid[t.file]=e);var r=(exports.uuidToState[e]="",path_1.dirname)(t.url);const s=exports.urlToUuid[r];s&&(s&&s!==o&&((r=exports.uuidToChildren[o])&&-1!==r.indexOf(e)&&r.splice(r.indexOf(e),1),exports.uuidToChildren[s]||(exports.uuidToChildren[s]=[],unFreeze(s)),exports.uuidToChildren[s].includes(e)||exports.uuidToChildren[s].push(e),exports.uuidToParentUuid[e]=s,exports.uuidToChildrenSorted[s]=!1,exports.uuidToState[s]=""),unFreezeDirectory(e),render())}else console.error(`Can not change the asset "${t.url}", because the original asset is not exist. Maybe it is a new asset.`)}function added(e,t){var r=(0,path_1.dirname)(t.url),r=exports.urlToUuid[r];if(r){refreshTime=Date.now(),exports.uuidToAsset[e]=t,exports.urlToUuid[t.url]=e,t.file&&(exports.fileToUuid[t.file]=e);var o=Object.keys(t.subAssets);if(o.length){var i={children:{},uuid:e};for(const s of o)i.children[s]={children:{}},buildTreeData(t.subAssets[s],i.children[s],i)}exports.uuidToChildren[r]||(exports.uuidToChildren[r]=[],unFreeze(r)),exports.uuidToChildren[r].includes(e)||exports.uuidToChildren[r].push(e),exports.uuidToParentUuid[e]=r,exports.uuidToState[r]="",exports.uuidToChildrenSorted[r]=!1,updateRootAsset(r),unFreezeDirectory(r),render()}}function deleted(e,t){loopDeleteSelf(e);var r,o=exports.uuidToParentUuid[e];o&&(unFreeze(o),r=exports.uuidToChildren[o])&&r.length&&-1!==(e=r.indexOf(e))&&r.splice(e,1),updateRootAsset(o),render()}function loopDeleteSelf(e){var t=exports.uuidToChildren[e];if(t&&t.length)for(const r of t)loopDeleteSelf(r);t=exports.uuidToAsset[e];t&&(delete exports.urlToUuid[t.url],delete exports.fileToUuid[t.file]),delete exports.uuidToAsset[e],delete exports.uuidToChildren[e],delete exports.uuidToChildrenSorted[e],delete exports.uuidToExpand[e],delete exports.uuidToDepth[e],delete exports.uuidToIndex[e],delete exports.uuidToState[e]}function updateRootAsset(e){exports.uuidToParentUuid[e]===panelData.config.protocol&&unFreeze(e)}function unFreezeDirectory(e){var t=exports.uuidToAsset[e];if(t&&t.isDirectory){unFreeze(e);t=exports.uuidToChildren[e];if(Array.isArray(t))for(const r of t)unFreeze(r)}}function unFreeze(e){return void 0===exports.uuidToAsset[e]||!(!exports.uuidToAsset[e]||!Object.isFrozen(exports.uuidToAsset[e])||(exports.uuidToAsset[e]=JSON.parse(JSON.stringify(exports.uuidToAsset[e])),0))}function render(){cancelAnimationFrame(renderAnimationId),renderAnimationId=requestAnimationFrame(()=>{renderImmediately()})}async function renderImmediately(){exports.displayArray=[],exports.uuidToIndex={length:0},renderData(panelData.config.protocol,-1),utils.isSearchingMode()?await searchData(exports.displayArray):getAllExpands(panelData.config.protocol,exports.displayArray),panelData.$.tree.render()}function resort(){exports.uuidToChildrenSorted={},render()}function outputDisplay(t,r){var o=[];if(exports.displayArray.length){t=t<0?0:t,r=exports.displayArray.length<r?exports.displayArray.length:r;for(let e=t;e<r;e++){var i=displayData(exports.displayArray[e]);i&&o.push(i)}}return Object.freeze(o),o}function loopExpand(e,t){function s(e,t){var r=exports.uuidToChildren[e];if(r){var o=r.length;for(let e=0;e<o;e++){var i=r[e];s(i,exports.uuidToExpand[i]=t)}}}(t=void 0===t?!exports.uuidToExpand[e]:t)?(s(e,t),toggleExpand(e,t)):(toggleExpand(e,t),s(e,t),render())}function toggleExpand(e,t){void 0===t&&(t=!exports.uuidToExpand[e]),exports.uuidToExpand[e]!==t&&(exports.uuidToExpand[e]=t,render())}async function pointExpand(e){let t=e,r=exports.displayArray.includes(t);for(;t&&!r;)t=exports.uuidToParentUuid[t],exports.uuidToExpand[t]=!0,r=exports.displayArray.includes(t);await renderImmediately()}exports.reset=reset,exports.clear=clear,exports.changed=changed,exports.added=added,exports.deleted=deleted,exports.unFreeze=unFreeze,exports.render=render,exports.renderImmediately=renderImmediately,exports.resort=resort,exports.outputDisplay=outputDisplay,exports.loopExpand=loopExpand,exports.toggleExpand=toggleExpand,exports.pointExpand=pointExpand;const getChildrenInvalid=e=>{var t=exports.uuidToAsset[e];return!!t&&("isParent"in t&&!0===t.isParent?(e=exports.uuidToChildren[e],!!Array.isArray(e)&&e.some(e=>(0,exports.getChildrenInvalid)(e))):t.invalid)};function buildTree(e){var r={children:{},uuid:panelData.config.protocol},o=r.uuid.length;for(const i of e){if(!i.url)return;let e=r,t=r;for(const s of i.url.substring(o).split("/"))s&&(t.children[s]||(t.children[s]={children:{},uuid:""}),t=(e=t).children[s]);buildTreeData(i,t,e)}}function buildTreeData(e,t,r){if(e.uuid){t.uuid=e.uuid,e.isDirectory&&!exports.uuidToChildren[e.uuid]&&(exports.uuidToChildren[e.uuid]=[]),exports.uuidToAsset[e.uuid]=e,exports.urlToUuid[e.url]=e.uuid,e.file&&(exports.fileToUuid[e.file]=e.uuid),exports.uuidToChildren[r.uuid]||(exports.uuidToChildren[r.uuid]=[]),exports.uuidToChildren[r.uuid].includes(e.uuid)||exports.uuidToChildren[r.uuid].push(e.uuid),exports.uuidToParentUuid[e.uuid]=r.uuid;for(const o in e.subAssets)t.children[o]={children:{}},buildTreeData(e.subAssets[o],t.children[o],t)}}function renderData(e,t){exports.uuidToDepth[e]=t,exports.uuidToIndex[e]=exports.uuidToIndex.length,exports.uuidToIndex.length++;var r=exports.uuidToChildren[e];if(r&&r.length){var o=r.length;exports.uuidToChildrenSorted[e]||(sortTree(r),exports.uuidToChildrenSorted[e]=!0),t++;for(let e=0;e<o;e++)renderData(r[e],t)}}function displayData(e){const t=exports.uuidToAsset[e];if(t&&!Object.isFrozen(t)){var r=exports.uuidToDepth[e],o=0===r,i=(0,path_1.extname)(t.name),{iconWidth:o,nodeLeft:e}=(t.isDB=o,t.isDirectory=o||t.isDirectory,t.isParent=exports.uuidToChildren[e]&&exports.uuidToChildren[e].some(e=>exports.uuidToAsset[e]?.visible),t.isSubAsset=!!e.includes("@"),t.fileExt=t.isDirectory?"":i.toLocaleLowerCase(),t.fileName=t.isDirectory?t.name:t.name.substr(0,t.name.lastIndexOf(i)),t.depth=r,panelData.config);t.left=e+r*o/2+(t.isParent?0:o),t.refreshTime=refreshTime;const s=[];if(t.redirect){pushAdditional(s,{type:t.redirect.type,value:t.redirect.uuid,name:t.displayName||t.name});const u=exports.uuidToAsset[t.redirect.uuid];u&&u.extends&&0<u.extends.length&&u.extends.forEach(e=>{pushAdditional(s,{type:e,value:u.uuid,name:t.displayName||t.name})})}t.extends&&0<t.extends.length&&t.extends.forEach(e=>{pushAdditional(s,{type:e,value:t.uuid,name:t.displayName||t.name})});for(const d in t.subAssets){const n=t.subAssets[d];t.redirect&&t.redirect.uuid===n.uuid||(pushAdditional(s,{type:n.type,value:n.uuid,name:n.displayName||n.name}),n.extends&&0<n.extends.length&&n.extends.forEach(e=>{pushAdditional(s,{type:e,value:n.uuid,name:n.displayName||n.name})}))}t.additional=s,Object.freeze(t)}return t}function pushAdditional(e,t){e.some(e=>e.type===t.type&&e.value===t.value)||e.push(t)}async function searchData(y){let m=panelData.$.panel["searchValue"];const{searchType:g,searchAssetTypes:A,searchInFolder:D,extendSearchFunc:v}=panelData.$.panel;let b=m,C=("name"!==g&&"uuid"!==g||!Editor.Utils.UUID.isUUID(m)||(b=Editor.Utils.UUID.decompressUUID(m)),m);var e,t;"usages"===g&&(e=Editor.Utils.UUID.decompressUUID(m),(t=exports.uuidToAsset[e])&&"cc.Script"!==t.type?m=e:C=Editor.Utils.UUID.compressUUID(m,!1)),panelData.$.panel.refreshLock=!0;for(const o of exports.uuidToChildren[panelData.config.protocol]){var r=exports.uuidToChildren[o];if(r&&r.length)for(const i of r)await async function t(e){const r=exports.uuidToAsset[e];if(!r||!1===r.visible)return;const{name:o,displayName:i,uuid:s,url:u,type:d,file:n}=r;let a=!0;!D||u!==D.url&&u.startsWith(D.url+"/")||(a=!1);A.length&&!A.includes(d)&&(a=!1);"fails"===g&&r.imported&&(a=!1);if(a){let e=!0;if(m)if(e=!1,"name"===g||"fails"===g){const x=m.toLocaleLowerCase(),c=(""+o+i).toLocaleLowerCase(),f=c.includes(x);(f||s.includes(b))&&(e=!0)}else if("uuid"===g&&s.includes(b))e=!0;else if("url"===g&&u.includes(m))e=!0;else if("usages"===g&&(0,fs_extra_1.existsSync)(n)){const h=(0,fs_extra_1.statSync)(n);if(h.isFile()){const T=(0,fs_extra_1.readFileSync)(n);(T.includes(m)||m!==C&&T.includes(C))&&(e=!0)}}(e=v[g]?await v[g](m,r):e)&&(exports.uuidToIndex[s]=exports.uuidToIndex.length,exports.uuidToIndex.length++,y.push(s))}const l=exports.uuidToChildren[s];if(!l||!l.length)return;const p=l.length;for(let e=0;e<p;e++)await t(l[e])}(i)}sortTree(y,!0),panelData.$.panel.refreshLock=!1}function getAllExpands(e,t){var r=exports.uuidToChildren[e];if(r){var o=r.length;for(let e=0;e<o;e++){var i=r[e],s=exports.uuidToAsset[i];s&&!1!==s.visible&&(t.push(i),exports.uuidToExpand[i])&&getAllExpands(i,t)}}}function sortTree(e,r){e.sort((e,t)=>{e=exports.uuidToAsset[e],t=exports.uuidToAsset[t];return!0!==e.isDirectory||t.isDirectory?e.isDirectory||!0!==t.isDirectory?"type"===panelData.$.panel.sortType&&e.importer!==t.importer?util_1.collator.compare(e.importer,t.importer):r?util_1.collator.compare(""+e.displayName+e.name,""+t.displayName+t.name):util_1.collator.compare(e.path,t.path):1:-1})}exports.getChildrenInvalid=getChildrenInvalid;