"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var n=Object.getOwnPropertyDescriptor(t,a);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,n)}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.data=exports.methods=exports.watch=exports.computed=exports.props=exports.components=exports.template=exports.name=void 0;const fs_1=require("fs"),path_1=require("path"),panel_menu_1=require("./panel-menu"),panelData=__importStar(require("./panel-data")),treeData=__importStar(require("./tree-data")),utils=__importStar(require("./utils")),tree_node_icon_1=require("./tree-node-icon"),illegalFileName=/[\\/:*?"<>|]+/;let renameTimeId;function data(){return{renameUuid:"",renameValue:"",renameInputState:"",addInputState:{}}}exports.name="tree-node",exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../static/template/tree-node.html"),"utf8"),exports.components={"tree-node-icon":tree_node_icon_1.TreeNodeIcon},exports.props={asset:{type:Object},expand:Boolean,select:Boolean,renameUrl:String,addInfo:Object,twinkle:String},exports.computed={state(){var e=this,t=e.asset;return t?t.url&&e.renameUrl===t.url?"rename":t.url&&e.addInfo.parentDir===t.url?(e.addState(),"add"):treeData.uuidToState[t.uuid]||"":""},draggable(){var e=this.asset;return!e||treeData.uuidToState[e.uuid]||""!==this.state||utils.canNotDrag(e)?"false":"true"},style(){var e=this.asset["left"];return{paddingLeft:e+"px"}},addInputStyle(){var{left:e,isParent:t}=this.asset,a=panelData.config["iconWidth"];return{paddingLeft:e+a/2+(t?a:0)+"px"}},showInnerInvalid(){var e=this.asset;return!this.expand&&!0!==e.isDB&&!0===e.isParent&&treeData.getChildrenInvalid(e.uuid)},showInvalid(){return this.asset.invalid||this.showInnerInvalid}},exports.watch={state(){const e=this,t=e.asset;"rename"===e.state?(e.renameUuid=t.uuid,e.renameValue=t.fileName,e.renameInputState="",e.$nextTick(()=>{e.$refs.renameInput&&(e.$refs.renameInput.focus({preventScroll:!0}),e.$refs.renameInput.setSelectionRange(0,t.fileName.length))})):"add"===e.state&&e.addState()}},exports.methods={t(e){return panelData.$.panel.t(e)},async dblclick(e){clearTimeout(renameTimeId),e.isDirectory?utils.isSearchingMode()?(panelData.$.tree.toggle(e.uuid,!0),panelData.$.panel.clearSearch(),await utils.scrollIntoView(e.uuid,!0)):panelData.$.tree.toggle(e.uuid):await utils.openAsset(e)},popupMenu(e){(0,panel_menu_1.popupContextMenu)(e)},click(e,t){t.shiftKey?panelData.$.tree.shiftClick(e.uuid):t.ctrlKey||t.metaKey?panelData.$.tree.ctrlClick(e.uuid):panelData.$.tree.ipcSelect(e.uuid)},rename(e,t){var a;panelData.$.panel.refocus||(a=panelData.act.selects,utils.canNotRename(e))||t.ctrlKey||t.metaKey||1!==a.length||!a.includes(e.uuid)||(clearTimeout(renameTimeId),renameTimeId=setTimeout(()=>{panelData.$.tree.renameUrl=e.url},300),t.preventDefault(),t.stopPropagation())},toggle(e,t){const a=t.currentTarget;a.setAttribute("animate",""),setTimeout(()=>{a.removeAttribute("animate")},500),panelData.$.tree.toggle(e.uuid,void 0,t.altKey)},async renameChange(){var e=this;const{uuid:t,fileExt:a,fileName:r}=e.asset;var n=treeData.uuidToParentUuid[t],n=(treeData.uuidToChildren[n]||[]).map(e=>{e=utils.getAsset(e);return e&&e.fileExt===a&&e.fileName!==r?e.fileName:null}).filter(Boolean);e.renameValue=e.$refs.renameInput.value.trim();let i="";n.includes(e.renameValue)?i="errorNewnameDuplicate":""===e.renameValue?i="errorNewnameEmpty":illegalFileName.test(e.renameValue)&&(i="errorNewnameUnlegal"),e.renameInputState=i},renameSubmit(){var e=this;let t=e.$refs.renameInput.value.trim();""===e.renameInputState&&t||(t=""),panelData.$.tree.rename(e.renameUuid||e.asset.uuid,t)},renameCancel(){this.$refs.renameInput.value="",panelData.$.tree.rename(this.renameUuid||this.asset.uuid,"")},async addChange(){const{parentUuid:e,fileExt:t}=this.addInfo;var a=(treeData.uuidToChildren[e]||[]).map(e=>{e=utils.getAsset(e);return e&&e.fileExt===t?e.fileName:null}).filter(Boolean),r=this.$refs.addInput.value;let n=r.trim(),i=(n.endsWith(t)&&(n=n.substr(0,n.lastIndexOf(t))),{state:"",title:"",message:""});a.includes(n)?i.state="errorNewnameDuplicate":""===n?i.state="errorNewnameEmpty":illegalFileName.test(n)?i.state="errorNewnameUnlegal":[".ts",".js"].includes(t)&&(i=await utils.scriptName.isValid(n)),i.state&&(i.title=this.t("operate."+i.state),"message"in i)&&(i.title=i.title.replace("$$className",i.message)),this.addInputState=i,this.addInfo.fileName=r},addSubmit(){var e=this,t=Object.assign({},e.addInfo);let a=e.$refs.addInput.value.trim();a.endsWith(e.addInfo.fileExt)&&(a=a.substr(0,a.lastIndexOf(e.addInfo.fileExt))),e.addInputState.state||!a?panelData.$.tree.addConfirm(null):(t.fileName=a,panelData.$.tree.addConfirm(t))},addCancel(){this.$refs.addInput.value="",panelData.$.tree.addConfirm(null)},dragStart(e,t){const a=this;let r=[];panelData.act.selects.includes(e.uuid)?panelData.act.selects.forEach(e=>{e=utils.getAsset(e);e&&(r=a.mergeAdditional(r,e))}):r=a.mergeAdditional(r,e),t.dataTransfer.setData("name",e.name),t.dataTransfer.setData("value",e.uuid),t.dataTransfer.setData("additional",JSON.stringify(r));e=new Image;e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAEALAAAAAABAAEAAAICRAEAOw==",t.dataTransfer.setDragImage(e,0,0)},dragOver(e,t){t.preventDefault();t=t.currentTarget;t.setAttribute("drag","over"),t.setAttribute("insert","inside"),panelData.$.tree.dragOver(e.uuid)},dragLeave(e,t){t=t.currentTarget;t.removeAttribute("insert"),t.removeAttribute("drag"),panelData.$.tree.dragLeave(e.uuid)},drop(e,t){var a,r,n;utils.isSearchingMode()&&!e.isDirectory?t.preventDefault():(t.preventDefault(),a=(r=t.currentTarget).getAttribute("insert"),r.removeAttribute("insert"),r.removeAttribute("drag"),(r=panelData.$.tree.$el).hasAttribute("hoving")&&(t.stopPropagation(),r.removeAttribute("hoving"),utils.canNotDrop(e)||(r=JSON.parse(JSON.stringify(Editor.UI.__protected__.DragArea.currentDragInfo))||{},(n=Array.from(t.dataTransfer.files))&&0<n.length&&(r.type="osFile",r.insert="inside",r.files=n),r.to=e.uuid,r.insert=a,r.copy=t.ctrlKey||"darwin"===process.platform&&t.altKey,panelData.$.tree.ipcDrop(r))))},mergeAdditional(e,t){let a=[{type:t.type,value:t.uuid,name:t.name}];return(a=Array.isArray(t.additional)&&t.additional.length?a.concat(t.additional):a).forEach(t=>{e.some(e=>e.type===t.type&&e.value===t.value)||e.push(t)}),e},addState(){const e=this,t=e.addInfo["name"];e.addInputState={},e.$nextTick(()=>{e.$refs.addInput&&(e.$refs.addInput.focus({preventScroll:!0}),e.$refs.addInput.setSelectionRange(0,t.length))})}},exports.data=data;