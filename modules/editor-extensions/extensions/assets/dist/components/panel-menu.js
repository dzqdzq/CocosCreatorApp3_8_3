"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,a,t,n){void 0===n&&(n=t);var r=Object.getOwnPropertyDescriptor(a,t);r&&("get"in r?a.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return a[t]}}),Object.defineProperty(e,n,r)}:function(e,a,t,n){e[n=void 0===n?t:n]=a[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,a){Object.defineProperty(e,"default",{enumerable:!0,value:a})}:function(e,a){e.default=a}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var a={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(a,e,t);return __setModuleDefault(a,e),a};Object.defineProperty(exports,"__esModule",{value:!0}),exports.previewPopupContextMenu=exports.popupContextMenu=exports.popupSortMenu=exports.popupSearchMenu=exports.popupPanelMenu=exports.popupCreateMenu=void 0;const electron_1=require("electron"),path_1=require("path"),panelData=__importStar(require("./panel-data")),utils=__importStar(require("./utils"));function prependCancelSearchMenu(e){utils.isSearchingMode()&&e.unshift({label:Editor.I18n.t("assets.menu.cancelSearch"),click(){panelData.$.panel.clearSearch()}},{type:"separator"})}async function createMenu(n,e){return mergeMenu((await Editor.Message.request("asset-db","query-create-menu-list")).map(function e(a){return a.type?a:a.message?(a.click=()=>{Editor.Message.send(a.message.target,a.message.name,...a.message.params||[])},a):a.submenu?(a.submenu=a.submenu.map(e),a):{...a,click:(t=a,()=>{n({importer:t.handler,fileName:(0,path_1.basename)(t.fullFileName,(0,path_1.extname)(t.fullFileName)),fileExt:(0,path_1.extname)(t.fullFileName),name:t.fullFileName,template:t.template})})};var t}).concat([{type:"extend-menu"}]),"createMenu",e)}async function popupCreateMenu(){await panelData.config.update(),Editor.Menu.popup({menu:await createMenu(e=>{panelData.$.tree.addTo(e)})})}async function panelMenu(){return mergeMenu([{label:Editor.I18n.t("assets.menu.new"),submenu:await createMenu(e=>{panelData.$.tree.addTo(e)})},{label:Editor.I18n.t("assets.menu.paste"),accelerator:"CmdOrCtrl+V",enabled:!utils.isEmptyToPaste(),click(){panelData.$.tree.paste()}},{type:"extend-menu"}],"panelMenu")}async function popupPanelMenu(){await panelData.config.update();var e=await panelMenu();prependCancelSearchMenu(e),Editor.Menu.popup({menu:e})}function searchMenu(){const{searchAssetTypes:n,searchType:t}=panelData.$.panel,r=[{label:Editor.I18n.t("assets.menu.searchTypeAll"),type:"checkbox",checked:0===n.length,click(){panelData.$.panel.searchAssetTypes=[]}}];var e=panelData.config.assetTypes();e&&e.length&&e.forEach(a=>{const t=n.includes(a);var e={label:a,type:"checkbox",checked:t,click(){var e;t?(e=n.filter(e=>e!==a),panelData.$.panel.searchAssetTypes=e):panelData.$.panel.searchAssetTypes.push(a)}};r.push(e)});const l=[{label:Editor.I18n.t("assets.menu.searchType"),submenu:r},{label:Editor.I18n.t("assets.menu.searchName"),type:"radio",checked:"name"===t,click(){panelData.$.panel.searchType="name",panelData.$.panel.searchTypeLabel="i18n:assets.menu.searchName"}},{label:Editor.I18n.t("assets.menu.searchUuid"),type:"radio",checked:"uuid"===t,click(){panelData.$.panel.searchType="uuid",panelData.$.panel.searchTypeLabel="i18n:assets.menu.searchUuid"}},{label:Editor.I18n.t("assets.menu.searchUrl"),type:"radio",checked:"url"===t,click(){panelData.$.panel.searchType="url",panelData.$.panel.searchTypeLabel="i18n:assets.menu.searchUrl"}},{label:Editor.I18n.t("assets.menu.searchUsages"),type:"radio",checked:"usages"===t,click(){panelData.$.panel.searchType="usages",panelData.$.panel.searchTypeLabel="i18n:assets.menu.searchUsages"}},{label:Editor.I18n.t("assets.menu.searchFails"),type:"radio",checked:"fails"===t,click(){panelData.$.panel.searchType="fails",panelData.$.panel.searchTypeLabel="i18n:assets.menu.searchFails"}}];var a=panelData.config.extendSearch.show("searchMenu");for(const s in a)a[s].forEach(e=>{const a=s+"-"+e.key;l.push({label:e.label,type:"radio",checked:t===a,click(){panelData.$.panel.searchType=a,panelData.$.panel.searchTypeLabel=e.label,panelData.$.panel.extendSearchFunc[a]=e.handler}})});return l}async function popupSearchMenu(){await panelData.config.update(),Editor.Menu.popup({menu:searchMenu()})}function sortMenu(){var e=panelData.$.panel["sortType"];return[{label:Editor.I18n.t("assets.menu.sortName"),type:"radio",checked:"name"===e,click(){panelData.$.panel.sortType="name"}},{label:Editor.I18n.t("assets.menu.sortType"),type:"radio",checked:"type"===e,click(){panelData.$.panel.sortType="type"}}]}function popupSortMenu(){Editor.Menu.popup({menu:sortMenu()})}function consoleMenu(t){return[{type:"separator"},{label:Editor.I18n.t("assets.menu.showUuidTitle"),submenu:[{label:Editor.I18n.t("assets.menu.showUuid"),click(){Editor.Clipboard.write("text",t.uuid);var e,a=["UUID ",Editor.I18n.t("assets.menu.doneCopied"),"  ",t.uuid];t.isDB||(e=Editor.Utils.UUID.compressUUID(t.uuid,"cc.Script"!==t.type),a.push(" , ",Editor.I18n.t("assets.menu.compressedUuid"),"  ",e)),console.log(...a),!t.isDB&&t.redirect&&(e=Editor.Utils.UUID.compressUUID(t.uuid,"cc.Script"!==t.type),console.log(`${Editor.I18n.t("assets.menu.redirect")}: ${t.redirect.uuid} , ${Editor.I18n.t("assets.menu.compressedUuid")} `+e))}},{label:Editor.I18n.t("assets.menu.showURL"),click(){Editor.Clipboard.write("text",t.url),console.log("URL ",Editor.I18n.t("assets.menu.doneCopied"),"  ",t.url)}},{label:Editor.I18n.t("assets.menu.showPath"),enabled:!!t.file,click(){Editor.Clipboard.write("text",t.file),console.log("FilePath ",Editor.I18n.t("assets.menu.doneCopied"),"  ",t.file)}},{label:Editor.I18n.t("assets.menu.showName"),click(){Editor.Clipboard.write("text",t.name),console.log("Name ",Editor.I18n.t("assets.menu.doneCopied"),"  ",t.name)}}]}]}async function dbMenu(a){return mergeMenu([{label:Editor.I18n.t("assets.menu.new"),enabled:!utils.canNotCreate(a),submenu:await createMenu(e=>{e.folderUuid=a.uuid,panelData.$.tree.addTo(e)},a)},{type:"separator"},{label:Editor.I18n.t("assets.menu.paste"),accelerator:"CmdOrCtrl+V",enabled:!utils.canNotPaste(a),click(){panelData.$.tree.paste(a.uuid)}},{type:"separator"},{label:Editor.I18n.t("assets.menu.searchInFolder"),click(){panelData.$.panel.searchInFolder=utils.getDirectory(a.uuid)}},{type:"extend-menu"},{type:"separator"},{label:Editor.I18n.t("assets.menu."+("darwin"===process.platform?"revealInFinder":"revealInExplorer")),enabled:!utils.canNotRevealInExplorer(a),click(){electron_1.shell.showItemInFolder(a.file)}},...consoleMenu(a)],"dbMenu",a)}async function assetMenu(t){return mergeMenu([{label:Editor.I18n.t("assets.menu.new"),enabled:t&&!t.readonly,submenu:await createMenu(e=>{e.folderUuid=t.uuid,panelData.$.tree.addTo(e)},t)},{type:"separator"},{label:Editor.I18n.t("assets.menu.copy"),accelerator:"CmdOrCtrl+C",enabled:!utils.canNotCopy(t),click(){panelData.$.tree.copy(t.uuid)}},{label:Editor.I18n.t("assets.menu.duplicate"),accelerator:"CmdOrCtrl+D",enabled:!utils.canNotDuplicate(t),click(){var e=panelData.act["selects"];let a=[t.uuid];Array.isArray(e)&&e.includes(t.uuid)&&(a=e.slice()),panelData.$.tree.duplicate(a)}},{label:Editor.I18n.t("assets.menu.cut"),accelerator:"CmdOrCtrl+X",enabled:!utils.canNotCut(t),click(){panelData.$.tree.cut(t.uuid)}},{label:Editor.I18n.t("assets.menu.paste"),accelerator:"CmdOrCtrl+V",enabled:t&&!t.readonly&&!utils.isEmptyToPaste(),click(){panelData.$.tree.paste(t.uuid)}},{label:Editor.I18n.t("assets.menu.rename"),accelerator:"Enter",enabled:!utils.canNotRename(t),click(){panelData.$.tree.renameUrl=t.url}},{type:"separator"},{label:Editor.I18n.t("assets.menu.delete"),accelerator:"Delete",enabled:!utils.canNotDelete(t),click(){panelData.$.tree.delete(t.uuid)}},{type:"separator"},{label:Editor.I18n.t("assets.menu.selectAll"),accelerator:"CmdOrCtrl+A",click(){panelData.$.tree.selectAll(t.uuid)}},{label:Editor.I18n.t("assets.menu.searchInFolder"),click(){panelData.$.panel.searchInFolder=utils.getDirectory(t.uuid)}},{label:Editor.I18n.t("assets.menu.searchUsages"),click(){panelData.$.panel.searchType="usages",panelData.$.panel.searchTypeLabel="i18n:assets.menu.searchUsages",panelData.$.panel.searchValue=t.uuid}},{type:"extend-menu"},{type:"separator"},{label:Editor.I18n.t("assets.menu."+("darwin"===process.platform?"revealInFinder":"revealInExplorer")),enabled:!utils.canNotRevealInExplorer(t),click(){electron_1.shell.showItemInFolder(t.file)}},{type:"separator"},{label:Editor.I18n.t("assets.menu.reimport"),visible:!utils.canNotReimport(t),click(){panelData.$.tree.reimport(t.uuid)}},{label:Editor.I18n.t("assets.menu.revealInlibrary"),enabled:!utils.canNotRevealInLibrary(t),click(){var e=Object.keys(t.library);0!==e.length&&(e=t.library[e[0]])&&electron_1.shell.showItemInFolder(e)}},...consoleMenu(t)],"assetMenu",t)}function assetPreviewMenu(a){return mergeMenu([{label:Editor.I18n.t("assets.menu.delete"),accelerator:"Delete",enabled:!utils.canNotDelete(a),click(){panelData.$.tree.delete(a.uuid)}},{type:"separator"},{label:Editor.I18n.t("assets.menu."+("darwin"===process.platform?"revealInFinder":"revealInExplorer")),enabled:!utils.canNotRevealInExplorer(a),click(){electron_1.shell.showItemInFolder(a.file)}},{type:"extend-menu"},{type:"separator"},{label:Editor.I18n.t("assets.menu.reimport"),visible:!utils.canNotReimport(a),click(){panelData.$.tree.reimport(a.uuid)}},{label:Editor.I18n.t("assets.menu.revealInlibrary"),enabled:!utils.canNotRevealInLibrary(a),click(){var e=Object.keys(a.library);0!==e.length&&(e=a.library[e[0]])&&electron_1.shell.showItemInFolder(e)}},...consoleMenu(a)],"assetMenu",a)}async function popupContextMenu(e){await panelData.config.update();e=e.isDB?await dbMenu(e):await assetMenu(e);prependCancelSearchMenu(e),Editor.Menu.popup({menu:e})}async function previewPopupContextMenu(e){await panelData.config.update();e=assetPreviewMenu(e);Editor.Menu.popup({menu:e})}function mergeMenu(e,a,t){a=panelData.config.extendMenu.show(a,t),t=e.findIndex(e=>"extend-menu"===e.type),e=e.slice();return e.splice(t,1,...a),e}exports.popupCreateMenu=popupCreateMenu,exports.popupPanelMenu=popupPanelMenu,exports.popupSearchMenu=popupSearchMenu,exports.popupSortMenu=popupSortMenu,exports.popupContextMenu=popupContextMenu,exports.previewPopupContextMenu=previewPopupContextMenu;