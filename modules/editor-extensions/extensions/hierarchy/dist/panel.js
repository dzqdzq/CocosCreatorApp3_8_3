"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,a,t,n){void 0===n&&(n=t);var r=Object.getOwnPropertyDescriptor(a,t);r&&("get"in r?a.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return a[t]}}),Object.defineProperty(e,n,r)}:function(e,a,t,n){e[n=void 0===n?t:n]=a[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,a){Object.defineProperty(e,"default",{enumerable:!0,value:a})}:function(e,a){e.default=a}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var a={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(a,e,t);return __setModuleDefault(a,e),a};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.listeners=exports.methods=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),panel_menu_1=require("./components/panel-menu"),panelData=__importStar(require("./components/panel-data")),treeData=__importStar(require("./components/tree-data")),utils=__importStar(require("./components/utils")),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel,vm;const vueTemplate=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../static","/template/index.html"),"utf8"),HierarchyPanelVM=Vue.extend({name:"HierarchyPanelVM",components:{tree:require("./components/tree")},data(){return{refocus:!1,sceneReady:!1,isOperating:!1,isRefreshing:!1,droppableTypes:["cc.Node"],allExpand:null,viewWidth:0,viewHeight:0,treeHeight:0,dropBox:{},searchValue:"",searchType:"name"}},computed:{searchPlaceholder(){var e=this.searchType;return"i18n:hierarchy.menu.search"+(e.toLocaleUpperCase().substr(0,1)+e.substr(1))},searchTypeLabel(){var e=this.searchType.toLocaleUpperCase().substr(0,1)+this.searchType.substr(1);return this.t("menu.search"+e)}},watch:{searchValue(){panelData.$.tree.search()},searchType(){panelData.$.searchInput.focus(),panelData.$.tree.search()}},mounted(){panelData.$.panel=this,panelData.$.searchInput=this.$refs.searchInput,panelData.$.toggleExpandIcon=this.$refs.toggleExpandIcon,panelData.$.viewBox=this.$refs.viewBox,panelData.$.tree=this.$refs.tree,panelData.$.viewBox.addEventListener("scroll",e=>{this.treeHeight>this.viewHeight&&this.treeHeight<this.viewHeight+e.target.scrollTop?panelData.$.tree.scrollTop=this.treeHeight-this.viewHeight:panelData.$.tree.scrollTop=e.target.scrollTop},!1)},methods:{t(e){return Editor.I18n.t("hierarchy."+e)},async refresh(){if(this.sceneReady)try{this.isRefreshing=!0,panelData.$.tree.update(),await treeData.reset()}catch(e){console.error(e)}finally{this.isRefreshing=!1,this.isOperating=!1}},animationStart(e){treeData.animationStart(e)},animationEnd(){treeData.animationEnd()},allToggle(){panelData.$.tree.allToggle()},searchChange(){this.searchValue=panelData.$.searchInput.value.trim()},searchArrowDown(e,a){e.target.blur(),this.searchValue?panelData.$.tree.ipcSelectFirstChild():panelData.$.tree.upDownLeftRight(a)},clearSearch(){this.searchValue=panelData.$.searchInput.value=""},popupCreateMenu:panel_menu_1.popupCreateMenu,popupSearchMenu:panel_menu_1.popupSearchMenu,popupPanelMenu:panel_menu_1.popupPanelMenu,cancelSearchType(){this.searchType="name"},resize(){vm&&panelData.$.viewBox&&(this.viewWidth=panel.clientWidth,this.viewHeight=panelData.$.viewBox.offsetHeight,panelData.$.tree.filter())},focusWindow(){require("@electron/remote").getCurrentWindow().focus()}},template:vueTemplate});async function ready(){panel=this,vm?.$destroy(),(vm=new HierarchyPanelVM).$mount(panel.$.container),panel.viewBoxObserver=new IntersectionObserver(e=>{e.forEach(e=>{0!==e.intersectionRatio&&vm&&vm.resize()})},{root:vm.$el,rootMargin:"0px",threshold:.1}),panel.viewBoxObserver.observe(panelData.$.viewBox);Editor.Package.getPackages({enable:!0}).forEach(panelData.extension.attach),Editor.Package.__protected__.on("enable",panelData.extension.attach),Editor.Package.__protected__.on("disable",panelData.extension.detach);var e=await Editor.Message.request(panelData.act.messageProtocol.scene,"query-is-ready");e&&await exports.methods.ready()}async function beforeClose(){vm&&await exports.methods.staging()}function close(){vm&&(vm.sceneReady=!1),panel&&panel.viewBoxObserver.disconnect(),Editor.Package.__protected__.removeListener("enable",panelData.extension.attach),Editor.Package.__protected__.removeListener("disable",panelData.extension.detach),vm?.$destroy(),vm=null,panel=null}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../dist/index.css"),"utf8"),exports.template='<div class="container"></div>',exports.$={container:".container"},exports.methods={async staging(){vm&&vm.sceneReady&&(panelData.act.expandLevels=treeData.getExpandLevels(),await Editor.Message.request("hierarchy","staging",{assetUuid:panelData.act.assetUuid,animationUuid:panelData.act.animationUuid,expandLevels:panelData.act.expandLevels}))},async unstaging(){var e=await Editor.Message.request("hierarchy","unstaging");e.assetUuid&&vm&&await panelData.ready(e)},find(){vm&&vm.sceneReady&&panelData.$.searchInput.focus()},copy(){vm&&vm.sceneReady&&panelData.$.tree.copy()},paste(){vm&&vm.sceneReady&&panelData.$.tree.paste()},pasteAsChild(){vm&&vm.sceneReady&&panelData.$.tree.paste(null,!1,!0)},cut(){vm&&vm.sceneReady&&panelData.$.tree.cut()},duplicate(){vm&&vm.sceneReady&&panelData.$.tree.duplicate()},delete(){vm&&vm.sceneReady&&panelData.$.tree.delete()},up(){vm&&vm.sceneReady&&panelData.$.tree.upDownLeftRight("up")},down(){vm&&vm.sceneReady&&panelData.$.tree.upDownLeftRight("down")},left(){vm&&vm.sceneReady&&panelData.$.tree.upDownLeftRight("left")},right(){vm&&vm.sceneReady&&panelData.$.tree.upDownLeftRight("right")},shiftUp(){vm&&vm.sceneReady&&panelData.$.tree.shiftUpDown("up")},shiftDown(){vm&&vm.sceneReady&&panelData.$.tree.shiftUpDown("down")},rename(){vm&&vm.sceneReady&&panelData.$.tree.keyboardRename()},selectAll(){vm&&vm.sceneReady&&panelData.$.tree.selectAll()},selectClear(){vm&&vm.sceneReady&&panelData.$.tree.selectClear()},moveUp(){vm&&vm.sceneReady&&panelData.$.tree.moveNode("up")},moveDown(){vm&&vm.sceneReady&&panelData.$.tree.moveNode("down")},top(){vm&&vm.sceneReady&&panelData.$.tree.moveNode("top")},bottom(){vm&&vm.sceneReady&&panelData.$.tree.moveNode("bottom")},async ready(){vm&&(Editor.Metrics.trackTimeStart("hierarchy:render-tree"),vm.sceneReady=!0,await exports.methods.unstaging(),vm&&(await vm.refresh(),vm)&&panelData.$.tree.reselected(),Editor.Metrics.trackTimeEnd("hierarchy:render-tree",{output:!0}))},async close(){vm&&await exports.methods.staging()},async save(e){vm&&!panelData.act.assetInfo&&(e=e??await Editor.Message.request(panelData.act.messageProtocol.scene,"query-current-scene"))&&(panelData.act.assetInfo=await Editor.Message.request("asset-db","query-asset-info",e),panelData.act.assetUuid=e,await exports.methods.staging())},async animationStart(e){vm&&vm.sceneReady&&(await exports.methods.staging(),vm.animationStart(e))},animationEnd(){vm&&vm.sceneReady&&vm.animationEnd()},changed(e){vm&&vm.sceneReady&&panelData.$.tree.changed(e)},added(e){vm&&vm.sceneReady&&panelData.$.tree.added(e)},deleted(e){vm&&vm.sceneReady&&panelData.$.tree.deleted(e)},selected(e,a){vm&&vm.sceneReady&&"node"===e&&panelData.$.tree.selected(a)},unselected(e,a){vm&&vm.sceneReady&&"node"===e&&panelData.$.tree.unselected(a)},async twinkle(e){vm&&vm.sceneReady&&(await utils.scrollIntoView(e),utils.twinkle.add(e,"hint"))}},exports.listeners={resize(){vm&&vm.resize()},show(){vm&&vm.resize()},focus(){vm&&(vm.refocus=!0,setTimeout(()=>{vm&&(vm.refocus=!1)},300))}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;