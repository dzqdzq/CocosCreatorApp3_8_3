"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var s=Object.getOwnPropertyDescriptor(t,o);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,s)}:function(e,t,o,r){e[r=void 0===r?o:r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.deleteNode=exports.setParent=exports.moveNode=exports.pasteNode=exports.duplicateNode=exports.cutNode=exports.copyNode=exports.getDumpData=exports.animationEnd=exports.animationStart=exports.findNodesMissAsset=exports.findNodesUseAsset=exports.getExpandLevels=exports.getAllExpands=exports.pointExpand=exports.toggleExpand=exports.loopExpand=exports.outputDisplay=exports.renderImmediately=exports.render=exports.clear=exports.resetData=exports.reset=exports.uuidToAnimating=exports.uuidToExpand=exports.uuidToIndex=exports.uuidToDepth=exports.displayArray=exports.uuidToChildren=exports.uuidToParentUuid=exports.uuidToState=exports.uuidToNode=exports.nodeTree=void 0;const panelData=__importStar(require("./panel-data")),utils=__importStar(require("./utils"));exports.nodeTree="",exports.uuidToNode={},exports.uuidToState={},exports.uuidToParentUuid={},exports.uuidToChildren={},exports.displayArray=[],exports.uuidToDepth={},exports.uuidToIndex={},exports.uuidToExpand={},exports.uuidToAnimating={};let renderAnimationId;async function reset(){exports.nodeTree=await Editor.Message.request(panelData.act.messageProtocol.scene,"query-node-tree"),exports.nodeTree?(panelData.act.assetInfo&&"cc.Prefab"===panelData.act.assetInfo.type?(exports.nodeTree=exports.nodeTree.children[0],"should_hide_in_hierarchy"===exports.nodeTree.name&&(exports.nodeTree=exports.nodeTree.children[0]),exports.nodeTree.isPrefabRoot=!0):exports.nodeTree.isPrefabRoot=!1,resetData(),flatTree(exports.nodeTree,0,"0")):(clear(),console.error(panelData.$.panel.t("operate.refreshFail"))),render()}function resetData(){exports.uuidToNode={},exports.uuidToChildren={},exports.uuidToDepth={},exports.uuidToParentUuid={},exports.uuidToState={},exports.uuidToIndex={length:0}}function clear(){resetData(),exports.uuidToExpand={},exports.uuidToAnimating={}}function render(){cancelAnimationFrame(renderAnimationId),renderAnimationId=requestAnimationFrame(()=>{renderImmediately()})}function renderImmediately(){exports.displayArray=[],exports.nodeTree&&(utils.isSearching()?searchData(exports.displayArray):getAllExpands(exports.nodeTree.uuid,exports.displayArray)),panelData.$.tree.render()}function outputDisplay(t,o){var r=[];if(exports.displayArray.length)for(let e=t;e<o;e++){var s=displayData(exports.displayArray[e]);s&&r.push(s)}return Object.freeze(r),r}function loopExpand(e,t){function n(e,t){var o=exports.uuidToChildren[e];if(o){var r=o.length;for(let e=0;e<r;e++){var s=o[e];n(s,exports.uuidToExpand[s]=t)}}}(t=void 0===t?!exports.uuidToExpand[e]:t)?(n(e,t),toggleExpand(e,t)):(toggleExpand(e,t),n(e,t),render())}function toggleExpand(e,t){void 0===t&&(t=!exports.uuidToExpand[e]),exports.uuidToExpand[e]!==t&&(exports.uuidToExpand[e]=t,render())}function pointExpand(e){let t=e,o=exports.displayArray.includes(t);for(;t&&!o;)t=exports.uuidToParentUuid[t],exports.uuidToExpand[t]=!0,o=exports.displayArray.includes(t);renderImmediately()}function getAllExpands(e,t){t.push(e);var o=exports.uuidToChildren[e];if(exports.uuidToExpand[e]&&Array.isArray(o)){var r=o.length;for(let e=0;e<r;e++)getAllExpands(o[e],t)}}function getExpandLevels(){var e=[];for(const o in exports.uuidToExpand){var t=exports.uuidToNode[o];t&&!0===exports.uuidToExpand[o]&&e.push(t.level)}return e}exports.reset=reset,exports.resetData=resetData,exports.clear=clear,exports.render=render,exports.renderImmediately=renderImmediately,exports.outputDisplay=outputDisplay,exports.loopExpand=loopExpand,exports.toggleExpand=toggleExpand,exports.pointExpand=pointExpand,exports.getAllExpands=getAllExpands,exports.getExpandLevels=getExpandLevels;let nodesUseAsset=[];async function findNodesUseAsset(){nodesUseAsset.length=0;var e=await Editor.Message.request(panelData.act.messageProtocol.scene,"query-nodes-by-asset-uuid",panelData.$.panel.searchValue);Array.isArray(e)&&(nodesUseAsset=e)}exports.findNodesUseAsset=findNodesUseAsset;let nodesMissAsset=[];async function findNodesMissAsset(){nodesMissAsset.length=0;var e=await Editor.Message.request(panelData.act.messageProtocol.scene,"query-nodes-miss-assets");Array.isArray(e)&&(nodesMissAsset=e)}function flatTree(t,o,r){if(t&&t.uuid){var e,s=t.uuid;if(exports.uuidToNode[s])e=Editor.I18n.t("hierarchy.operate.duplicateUuid").replace("${uuid}",s),console.error(e);else if(exports.uuidToNode[s]=t,exports.uuidToDepth[s]=o,exports.uuidToIndex[s]=exports.uuidToIndex.length,exports.uuidToIndex.length++,exports.uuidToChildren[s]=[],exports.uuidToState[s]="",void 0===exports.uuidToExpand[s]&&(exports.uuidToExpand[s]=panelData.act.expandLevels.includes(r)),t.depth=o,t.level=r,t.additional=attrAdditional(t),t.isScene&&(t.path=""),Array.isArray(t.children)){o++;var n=t.children.length;for(let e=0;e<n;e++){var a=t.children[e];if(a&&a.uuid){var d=a.uuid;const r=t.level?t.level+"_"+e:""+e;a.path=t.path?t.path+"/"+a.name:a.name,flatTree(a,o,r),exports.uuidToChildren[s].includes(d)||exports.uuidToChildren[s].push(d),exports.uuidToParentUuid[d]=s}}t.children.length=0}}}function attrAdditional(e){const o=[];return e.components.forEach(t=>{o.push({type:t.type,value:t.value}),Array.isArray(t.extends)&&t.extends.forEach(e=>{o.push({type:e,value:t.value})})}),o}function animationStart(e){!function t(e){const o=exports.uuidToNode[e];if(!o)return;exports.uuidToAnimating[e]=!0;const r=exports.uuidToChildren[e];if(!Array.isArray(r))return;const s=r.length;for(let e=0;e<s;e++)t(r[e])}(panelData.act.animationUuid=e),render()}function animationEnd(){panelData.act.animationUuid="",exports.uuidToAnimating={},render()}async function getDumpData(e){return Editor.Message.request(panelData.act.messageProtocol.scene,"query-node",e)}async function copyNode(e){return Editor.Message.request(panelData.act.messageProtocol.scene,"copy-node",e)}async function cutNode(e){return Editor.Message.request(panelData.act.messageProtocol.scene,"cut-node",e)}async function duplicateNode(e){return Editor.Message.request(panelData.act.messageProtocol.scene,"duplicate-node",e)}async function pasteNode(e,t,o=!1,r){return Editor.Message.request(panelData.act.messageProtocol.scene,"paste-node",{target:e,uuids:t,keepWorldTransform:o,pasteAsChild:r})}async function moveNode(e,t,o){return Editor.Message.send(panelData.act.messageProtocol.scene,"move-array-element",{uuid:e,path:"children",target:t,offset:o})}async function setParent(e,t,o=!1){return Editor.Message.send(panelData.act.messageProtocol.scene,"set-parent",{parent:e,uuids:t,keepWorldTransform:o})}async function deleteNode(e,t){return Editor.Message.send(panelData.act.messageProtocol.scene,"remove-node",{uuid:e,keepWorldTransform:t})}function displayData(e){e=exports.uuidToNode[e];return e&&!Object.isFrozen(e)&&Object.freeze(e),e}function searchData(x){const{searchValue:f,searchType:T}=panelData.$.panel,y=f.toLocaleLowerCase();for(const e of exports.uuidToChildren[exports.nodeTree.uuid])!function t(e){const o=exports.uuidToNode[e];if(!o)return;const{name:r,path:s,uuid:n,components:a}=o;const d=r.toLocaleLowerCase();const i=s.toLocaleLowerCase();let u=!1;const p=d.includes(y)||o.uuid.includes(f);"name"===T&&p||"uuid"===T&&n.includes(f)||"path"===T&&i.includes(y)||"component"===T&&a.some(e=>e.type.toLocaleLowerCase().includes(y))||"asset"===T&&nodesUseAsset.includes(o.uuid)?u=!0:"missAsset"===T&&nodesMissAsset.includes(o.uuid)&&(u=!f||p);u&&x.push(n);const l=exports.uuidToChildren[n];if(!l||!l.length)return;const c=l.length;for(let e=0;e<c;e++)t(l[e])}(e)}exports.findNodesMissAsset=findNodesMissAsset,exports.animationStart=animationStart,exports.animationEnd=animationEnd,exports.getDumpData=getDumpData,exports.copyNode=copyNode,exports.cutNode=cutNode,exports.duplicateNode=duplicateNode,exports.pasteNode=pasteNode,exports.moveNode=moveNode,exports.setParent=setParent,exports.deleteNode=deleteNode;