"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.extension=exports.config=exports.ready=exports.act=exports.$=void 0;const path_1=require("path"),Profile=require("@base/electron-profile");async function queryMessageProtocolScene(){try{var e=await Editor.Profile.getConfig("hierarchy","message-protocol");e&&Object.assign(exports.act.messageProtocol,e)}catch(e){console.error(e),exports.act.messageProtocol.scene="scene"}}async function onMessageProtocolChange(e,t,o){"defaultPreferences"===e&&"packages/hierarchy.json"===t&&"message-protocol"===o&&(await queryMessageProtocolScene(),exports.$.panel.$el.isConnected?await exports.$.panel.refresh():Profile.removeListener("change",onMessageProtocolChange))}async function ready(e){if(Profile.removeListener("change",onMessageProtocolChange),Profile.on("change",onMessageProtocolChange),queryMessageProtocolScene(),await exports.config.update(),exports.act.assetUuid=e.assetUuid,exports.act.expandLevels=e.expandLevels,e.animationUuid){if("animation"===await Editor.Message.request(exports.act.messageProtocol.scene,"query-scene-mode"))return void(exports.act.animationUuid=e.animationUuid);exports.act.animationUuid=""}exports.act.assetInfo=await Editor.Message.request("asset-db","query-asset-info",exports.act.assetUuid),exports.act.selects.length=0,exports.$.tree.clear()}exports.$={panel:null,searchInput:null,toggleExpandIcon:null,viewBox:null,tree:null},exports.act={assetUuid:"",assetInfo:{},messageProtocol:{scene:"scene"},animationUuid:"",expandLevels:[],selects:[],twinkleQueues:[]},exports.ready=ready,exports.config={nodeHeight:20,iconWidth:16,padding:4,creatableTypes:[],extendMenu:{packages:{},async show(e,t){var o,a,s,r,n,c,i,p,l,d=[],u=this.packages;let h=void 0;t&&({active:t,isScene:o,name:a,parent:s,type:r,uuid:n,components:c,isPrefabRoot:i,readonly:p,prefab:l}=t,h={active:t,isScene:o,name:a,parent:s,type:r,uuid:n,components:c,isPrefabRoot:i,readonly:p,prefab:l});for(const y in u){var g,x=u[y];x&&(g=x[e])&&x.methods[g]&&(x=await x.methods[g](h),Array.isArray(x))&&x.length&&(d.push({type:"separator"}),d.push(...x))}return d},attach(e,t){exports.config.extendMenu.packages[e]=t},detach(e){delete exports.config.extendMenu.packages[e]}},extendDrop:{types:[],callbacks:{},attach(a,e){e.forEach(o=>{var e=o.type;e&&!this.types.includes(e)&&(this.types.push(e),this.callbacks[e]||(this.callbacks[e]={}),this.callbacks[e][a]=(e,t)=>{Editor.Message.send(a,o.message,e,t)})})},detach(o,e){e.forEach(e=>{const t=e.type;t&&this.types.includes(t)&&(this.types=this.types.filter(e=>e!==t),this.callbacks[t])&&delete this.callbacks[t][o]})}},async update(){this.creatableTypes=await Editor.Message.request(exports.act.messageProtocol.scene,"query-creatable-asset-types")}},exports.extension={attach(e){if(!e.invalid&&e.info.contributions&&e.info.contributions.hierarchy)try{var t,o,a=e.info.contributions.hierarchy;Array.isArray(a.drop)&&exports.config.extendDrop.attach(e.name,a.drop),a.menu&&"string"==typeof a.menu.methods&&(t=(0,path_1.join)(e.path,a.menu.methods),Editor.Module.__protected__.removeCache(t),o=t.replace(/^\w:/,e=>e.toLocaleUpperCase()),Editor.Module.__protected__.removeCache(o),a.menu.methods=Editor.Module.__protected__.requireFile(t),exports.config.extendMenu.attach(e.name,a.menu)),exports.$.tree.update()}catch(e){console.error(e)}},detach(e){if(!e.invalid&&e.info.contributions&&e.info.contributions.hierarchy)try{var t=e.info.contributions.hierarchy;Array.isArray(t.drop)&&exports.config.extendDrop.detach(e.name,t.drop),t.menu&&exports.config.extendMenu.detach(e.name),exports.$.tree.update()}catch(e){console.error(e)}}};