"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,a){void 0===a&&(a=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&("get"in r?t.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,a,r)}:function(e,t,n,a){e[a=void 0===a?n:a]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.twinkle=exports.calcScrollPosition=exports.scrollIntoView=exports.getChildrenUuids=exports.isAIncludeB=exports.filterChildren=exports.inDisplayArray=exports.getDisplayNodeTop=exports.getDisplayNodeLeft=exports.getParentWhenAddNode=exports.getLastExpandChildUuid=exports.getLastChildUuid=exports.getSibling=exports.getParent=exports.getNode=exports.isSelected=exports.isAnimating=exports.isParent=exports.isExpand=exports.isActive=exports.isAllExpand=exports.isSearching=exports.isExistedAsset=exports.isNoneCopyOrCut=exports.canNotPasteNode=exports.canNotDragNode=exports.canNotRename=exports.canNotCutNode=exports.canNotCopyNode=exports.canNotCreateNode=exports.canNotDeleteNode=exports.enableContextMenu=exports.forbidOperate=void 0;const panelData=__importStar(require("./panel-data")),treeData=__importStar(require("./tree-data"));function forbidOperate(){return panelData.act.animationUuid||panelData.$.panel.isOperating}function enableContextMenu(){return!forbidOperate()}function canNotDeleteNode(e){return!e||e.readonly||e.isScene||e.isPrefabRoot}function canNotCreateNode(e){return!e||e.readonly}function canNotCopyNode(e){return canNotDeleteNode(e)}function canNotCutNode(e){return canNotDeleteNode(e)}function canNotRename(e){return canNotDeleteNode(e)||forbidOperate()}function canNotDragNode(e){return canNotDeleteNode(e)}function canNotPasteNode(e){return!e||e.readonly||isNoneCopyOrCut()}function isNoneCopyOrCut(){var e=Editor.Clipboard.read("nodes-info");return!e||!e.uuids.length||e.projectPath!==Editor.Project.path}function isExistedAsset(){return!!panelData.act.assetUuid}function isSearching(){var e,t;return!!panelData.$.panel&&({searchValue:e,searchType:t}=panelData.$.panel,""!==e||"missAsset"===t)}function isAllExpand(){let n=!0;if(!treeData.nodeTree)return n;let a=treeData.uuidToChildren[treeData.nodeTree.uuid];var e=panelData.act.selects.length;if(!(a=e?panelData.act.selects:a)||!a.length)return n;var r=a.length;for(let t=0;t<r;t++){let e=a[t];treeData.uuidToNode[e];if(isParent(e)||(e=treeData.uuidToParentUuid[e]),treeData.uuidToExpand[e]){n=!1;break}}return!n}function isActive(e){let t=!0;var n=treeData.uuidToNode[e];return t=n&&(t=!!n.active)&&(n=treeData.uuidToParentUuid[e])?isActive(n):t}function isExpand(e){return!!treeData.uuidToExpand[e]}function isParent(e){return treeData.uuidToChildren[e]&&0<treeData.uuidToChildren[e].length}function isAnimating(e){return!!treeData.uuidToAnimating[e]}function isSelected(e){return-1!==panelData.act.selects.indexOf(e)}function getNode(e=""){return e?treeData.uuidToNode[e]:null}function getParent(e){return e?getNode(treeData.uuidToParentUuid[e]):null}function getSibling(e){var{displayArray:t,uuidToNode:n}=treeData,a=t.indexOf(e),r=t.length-1;let o=a-1,i=a+1;return 0===a&&(o=r),a===t.length-1&&(i=0),[n[e],n[t[o]],n[t[i]]]}function getLastChildUuid(e){var t;return treeData.uuidToExpand[e]&&0!==treeData.uuidToChildren[e].length&&(t=treeData.uuidToChildren[e].length-1,e=treeData.uuidToChildren[e][t]),e}function getLastExpandChildUuid(e){var t=getLastChildUuid(e);return e=t!==e?getLastExpandChildUuid(t):e}function getParentWhenAddNode(e){if(!e.parent)return null;var t=getNode(e.parent);if(!t)return null;if(canNotCreateNode(t))return null;if(e.canvasRequired){if(hasCanvasComponent(t))return t;for(let e=treeData.uuidToChildren[t.uuid].length-1;0<=e;e--){var n=getNode(treeData.uuidToChildren[t.uuid][e]);if(n&&n.active&&hasCanvasComponent(n))return n}}return t}function getDisplayNodeLeft(e){return e.depth*panelData.config.iconWidth+panelData.config.padding}function getDisplayNodeTop(e){return treeData.displayArray.indexOf(e.uuid)*panelData.config.nodeHeight}function inDisplayArray(e){return treeData.displayArray.includes(e)}function filterChildren(e){if(!e||!e.length)return[];let n=[];return e.forEach(t=>{(n=n.filter(e=>!isAIncludeB(t,e))).some(e=>isAIncludeB(e,t))||n.push(t)}),n}function isAIncludeB(e,t){if(e===t)return!0;e=treeData.uuidToChildren[e];if(Array.isArray(e))for(const n of e)if(isAIncludeB(n,t))return!0;return!1}function getChildrenUuids(e,t=!1){var n=[];for(const a of treeData.uuidToChildren[e])n.push(a),treeData.uuidToParentUuid[a]&&(t||treeData.uuidToExpand[a])&&n.push(...getChildrenUuids(a,t));return n}async function scrollIntoView(a){return new Promise(e=>{var t=getNode(a);if(t){inDisplayArray(a)||treeData.pointExpand(a);const n=calcScrollPosition(t);window.setTimeout(()=>{panelData.$.viewBox.scrollTo(n.left,n.top),e(!0)})}else e(!1)})}function calcScrollPosition(e){var t=panelData.$.viewBox.clientHeight,n=panelData.$.viewBox.offsetWidth,a=panelData.$.viewBox.scrollWidth;let r=panelData.$.viewBox.scrollLeft,o=panelData.$.viewBox.scrollTop;var i=panelData.config.nodeHeight,s=panelData.config.iconWidth,d=panelData.$.tree.scrollTop,l=d+t-i-4,u=getDisplayNodeLeft(e),e=getDisplayNodeTop(e);return(r>u||n<a&&.3*n<u)&&(r=u-2*s),e<=d?o=e:l<=e&&(o=e-t+2*i),{left:r,top:o}}function hasCanvasComponent(e){return e&&e.components.some(e=>"cc.Canvas"===e.type)}exports.forbidOperate=forbidOperate,exports.enableContextMenu=enableContextMenu,exports.canNotDeleteNode=canNotDeleteNode,exports.canNotCreateNode=canNotCreateNode,exports.canNotCopyNode=canNotCopyNode,exports.canNotCutNode=canNotCutNode,exports.canNotRename=canNotRename,exports.canNotDragNode=canNotDragNode,exports.canNotPasteNode=canNotPasteNode,exports.isNoneCopyOrCut=isNoneCopyOrCut,exports.isExistedAsset=isExistedAsset,exports.isSearching=isSearching,exports.isAllExpand=isAllExpand,exports.isActive=isActive,exports.isExpand=isExpand,exports.isParent=isParent,exports.isAnimating=isAnimating,exports.isSelected=isSelected,exports.getNode=getNode,exports.getParent=getParent,exports.getSibling=getSibling,exports.getLastChildUuid=getLastChildUuid,exports.getLastExpandChildUuid=getLastExpandChildUuid,exports.getParentWhenAddNode=getParentWhenAddNode,exports.getDisplayNodeLeft=getDisplayNodeLeft,exports.getDisplayNodeTop=getDisplayNodeTop,exports.inDisplayArray=inDisplayArray,exports.filterChildren=filterChildren,exports.isAIncludeB=isAIncludeB,exports.getChildrenUuids=getChildrenUuids,exports.scrollIntoView=scrollIntoView,exports.calcScrollPosition=calcScrollPosition,exports.twinkle={watch:!0,start(){this.watch=!0},stop(){this.watch=!1},add(e,t="hint"){this.watch&&(panelData.$.tree.$set(panelData.$.tree.twinkles,e,t),setTimeout(()=>{panelData.$.tree.twinkles[e]=void 0,delete panelData.$.tree.twinkles[e]},1e3))},asset(e){e.isScene?Editor.Message.send("assets","twinkle",panelData.act.assetUuid):e.prefab&&e.prefab.state&&Editor.Message.send("assets","twinkle",e.prefab.assetUuid)}};