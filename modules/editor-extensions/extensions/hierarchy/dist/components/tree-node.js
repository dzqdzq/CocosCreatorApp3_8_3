"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var n=Object.getOwnPropertyDescriptor(t,a);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,n)}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.data=exports.methods=exports.watch=exports.computed=exports.props=exports.template=exports.name=void 0;const path_1=require("path"),fs_1=require("fs"),treeData=__importStar(require("./tree-data")),panelData=__importStar(require("./panel-data")),panel_menu_1=require("./panel-menu"),utils=__importStar(require("./utils"));let renameTimeId;function data(){return{renameValue:"",renameInputState:"",addValue:"",addInputState:"",addInputStyle:{},editPrefabIconStyle:{left:0}}}exports.name="tree-node",exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../static/template/tree-node.html"),"utf8"),exports.props=["node","renameUuid","addNode"],exports.computed={state(){var e=this,t=e.node;return t?e.renameUuid===t.uuid?"rename":e.addNode.sibling===t.uuid?"add":e.addNode.parent===t.uuid?"creating":treeData.uuidToState[t.uuid]||"":""},draggable(){var e=this.node;return""!==this.state||utils.canNotDragNode(e)?"false":"true"},style(){return{paddingLeft:utils.getDisplayNodeLeft(this.node)+"px"}},showEditPrefabIcon(){var e=this.node,t=e.prefab&&e.prefab.state&&3!==e.prefab.state;if(t&&!e.prefab.assetUuid.includes("@"))return e.prefab.assetUuid!==panelData.act.assetUuid;return!1}},exports.watch={state:{handler(){const e=this,t=e.node;if("rename"===e.state)e.renameValue=t.name,e.renameInputState="",window.setTimeout(()=>{e.$refs.renameInput&&(e.$refs.renameInput.focus({preventScroll:!0}),e.$refs.renameInput.setSelectionRange(0,t.name.length))});else if("add"===e.state){const{name:i,parent:d}=e.addNode;var{iconWidth:a,padding:r}=panelData.config,n=(e.addValue=i,e.addInputState="",utils.getNode(d));e.addInputStyle={paddingLeft:(n.depth+2)*a+r+"px"},window.setTimeout(()=>{e.$refs.addInput&&(e.$refs.addInput.focus({preventScroll:!0}),e.$refs.addInput.setSelectionRange(0,i.length))})}},immediate:!0}},exports.methods={t(e){return panelData.$.panel.t(e)},popupMenu(e){(0,panel_menu_1.popupContextMenu)(e)},click(e,t){t.shiftKey?panelData.$.tree.shiftClick(e.uuid):t.ctrlKey||t.metaKey?panelData.$.tree.ctrlClick(e.uuid):panelData.$.tree.ipcSelect(e.uuid)},dblclick(e){clearTimeout(renameTimeId),Editor.Message.send(panelData.act.messageProtocol.scene,"focus-camera",[e.uuid])},rename(e,t){var a;panelData.$.panel.refocus||(a=panelData.act.selects,utils.canNotRename(e))||t.ctrlKey||t.metaKey||1!==a.length||!a.includes(e.uuid)||(clearTimeout(renameTimeId),renameTimeId=setTimeout(()=>{panelData.$.tree.renameUuid=e.uuid},300),t.preventDefault(),t.stopPropagation())},toggle(e,t){const a=t.currentTarget;a.setAttribute("animate",""),setTimeout(()=>{a.removeAttribute("animate")},500),panelData.$.tree.toggle(e.uuid,void 0,t.altKey)},renameChange(){var e=this;e.renameValue=e.$refs.renameInput.value.trim(),e.renameInputState=""},renameSubmit(){var e=this;let t=e.$refs.renameInput.value.trim();""!==e.renameInputState&&(t=null),panelData.$.tree.rename(e.renameUuid||e.node.uuid,t)},renameCancel(){var e=this;e.renameInputState="cancel",panelData.$.tree.rename(e.renameUuid||e.node.uuid,null)},addChange(){var e=this["addNode"];e.name=this.$refs.addInput.value.trim()},addSubmit(){var e,t=this;"add"===t.state&&(e=Object.assign({},t.addNode),t=t.$refs.addInput.value.trim(),e.name=t,panelData.$.tree.addConfirm(e))},addCancel(){this.$refs.addInput.value="",panelData.$.tree.addConfirm(null)},dragStart(e,t){const a=this;let r=[];panelData.act.selects.includes(e.uuid)?panelData.act.selects.forEach(e=>{e=utils.getNode(e);e&&(r=a.mergeAdditional(r,e))}):r=a.mergeAdditional(r,e),t.dataTransfer.setData("name",e.name),t.dataTransfer.setData("value",e.uuid),t.dataTransfer.setData("additional",JSON.stringify(r));e=new Image;e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAEALAAAAAABAAEAAAICRAEAOw==",t.dataTransfer.setDragImage(e,0,0)},dragOver(e,t){t.preventDefault();var a=t.currentTarget,r=a.getBoundingClientRect();let n="inside";t.clientY-r.top<=4?n="before":r.bottom-t.clientY<=4&&(n="after"),a.setAttribute("drag","over"),a.setAttribute("insert",n),panelData.$.tree.dragOver(e.uuid,n)},dragEnter(e){e.stopPropagation(),e.preventDefault()},dragLeave(e,t){t=t.currentTarget;t.removeAttribute("insert"),t.removeAttribute("drag")},drop(e,t){var a,r;t.preventDefault(),e.readonly||(a=(r=t.currentTarget).getAttribute("insert"),r.removeAttribute("insert"),r.removeAttribute("drag"),panelData.$.tree.$el.hasAttribute("hoving")&&(t.stopPropagation(),panelData.$.tree.$el.removeAttribute("hoving"),(r=JSON.parse(JSON.stringify(Editor.UI.__protected__.DragArea.currentDragInfo))||{}).to=e.uuid,r.insert=a,r.copy=t.ctrlKey||"darwin"===process.platform&&t.altKey,r.keepWorldTransform=!t.shiftKey,panelData.$.tree.ipcDrop(r)))},mergeAdditional(e,t){let a=[{type:t.type,value:t.uuid}];return(a=Array.isArray(t.additional)&&t.additional.length?a.concat(t.additional):a).forEach(t=>{e.some(e=>e.type===t.type&&e.value===t.value)||e.push(t)}),e},toggleLock(e,t){const a=!e.locked,r=!t.altKey;panelData.act.selects.includes(e.uuid)?panelData.act.selects.forEach(e=>{Editor.Message.send(panelData.act.messageProtocol.scene,"change-node-lock",e,a,r)}):Editor.Message.send(panelData.act.messageProtocol.scene,"change-node-lock",e.uuid,a,r)},showInsideLock(e){return function e(t){if(Array.isArray(treeData.uuidToChildren[t]))for(const r of treeData.uuidToChildren[t]){var a=utils.getNode(r);if(a){if(a.locked)return!0;if(e(r))return!0}}return!1}(e.uuid)},editPrefab(e){e.prefab&&e.prefab.assetUuid&&Editor.Message.request("asset-db","open-asset",e.prefab.assetUuid)},calcEditPrefabIconStyle(){var e=panelData.$.viewBox.clientWidth+panelData.$.viewBox.scrollLeft-26;this.editPrefabIconStyle.left=e+"px"},twinkle(e){utils.twinkle.asset(e)}},exports.data=data;