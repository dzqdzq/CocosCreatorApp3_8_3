"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a);var r=Object.getOwnPropertyDescriptor(t,a);r&&("get"in r?t.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,i,r)}:function(e,t,a,i){e[i=void 0===i?a:i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.data=exports.methods=exports.watch=exports.components=exports.template=exports.name=void 0;const path_1=require("path"),fs_1=require("fs"),panelData=__importStar(require("./panel-data")),treeData=__importStar(require("./tree-data")),utils=__importStar(require("./utils"));let vm=null,requestAnimationId,selectedTimeId,isRefreshing=!1,dragOverUuid,dragOverTime,lockMoveNode=!1;function data(){return{nodes:[],renameUuid:"",addNode:{name:"",parent:"",sibling:""},intoViewByUser:"",scrollTop:0,droppableTypes:[],twinkles:{},checkShiftUpDownMerge:{uuid:"",direction:""}}}function mounted(){vm=this}exports.name="tree",exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../static/template/tree.html"),"utf8"),exports.components={"tree-node":require("./tree-node")},exports.watch={scrollTop(){vm.filter()}},exports.methods={t(e){return panelData.$.panel.t(e)},update(){var e=vm.$parent.droppableTypes.concat(panelData.config.creatableTypes);vm.droppableTypes=e.concat(panelData.config.extendDrop.types)},clear(){treeData.clear(),vm.refresh()},async refresh(){if(!isRefreshing){isRefreshing=!0,await new Promise(e=>setTimeout(e,200));try{await treeData.reset()}catch(e){console.error(e)}isRefreshing=!1}},selectAll(e){if(utils.isSearching())Editor.Selection.clear("node"),Editor.Selection.select("node",treeData.displayArray);else if(e=e||vm.getFirstSelectSortByDisplay(),utils.getNode(e)){var a=treeData.uuidToParentUuid[e]||e;const n=utils.getChildrenUuids(a);var i=panelData.act.selects.slice(),r=i.includes(e);let t=!0;n.forEach(e=>{panelData.act.selects.includes(e)||(t=!1)}),t?Editor.Selection.select("node",a):r?(i.forEach(e=>{n.includes(e)||Editor.Selection.unselect("node",e)}),Editor.Selection.select("node",n)):(Editor.Selection.clear("node"),utils.isParent(e)?(a=treeData.uuidToChildren[e].slice(),Editor.Selection.select("node",a)):Editor.Selection.select("node",n))}},selectClear(){Editor.Selection.clear("node")},selected(e){(e=Array.isArray(e)?e:[e]).forEach(e=>{panelData.act.selects.includes(e)||(panelData.act.selects.push(e),(vm.intoViewByUser=e)===vm.checkShiftUpDownMerge.uuid&&vm.shiftUpDownMergeSelected())}),vm.filter()},unselected(e){vm.intoViewByUser===e&&(vm.intoViewByUser="");e=panelData.act.selects.indexOf(e);-1!==e&&panelData.act.selects.splice(e,1),vm.filter()},reselected(){var e=Editor.Selection.getSelected("node").filter(e=>!!treeData.uuidToNode[e]);e.length&&(vm.selected(e),window.clearTimeout(selectedTimeId),utils.scrollIntoView(vm.intoViewByUser))},shiftClick(e){if(0===panelData.act.selects.length)vm.ipcSelect(e);else{var t=[],a=treeData["displayArray"],i=a.indexOf(panelData.act.selects[0]),r=a.indexOf(e);if(-1!==i||-1!==r)if(i<=r)for(let e=i;e<=r;e++)t.push(a[e]);else for(let e=i;e>=r;e--)t.push(a[e]);vm.ipcSelect(t)}},ctrlClick(e){panelData.act.selects.includes(e)?Editor.Selection.unselect("node",e):Editor.Selection.select("node",e)},ipcSelect(e){if(Array.isArray(e)){const t=new Set,a=new Set,i=(e.forEach(e=>a.add(e)),[]),r=(panelData.act.selects.forEach(e=>{t.add(e),a.has(e)||i.push(e)}),i.length&&Editor.Selection.unselect("node",i),[]);e.forEach(e=>{t.has(e)||r.push(e)}),r.length?Editor.Selection.select("node",r):e.length&&Editor.Selection.select("node",e)}else Editor.Selection.clear("node"),Editor.Selection.select("node",e)},ipcSelectFirstChild(){Editor.Selection.clear("node");var e=this.getFirstChild();e&&Editor.Selection.select("node",e)},click(){utils.forbidOperate()||Editor.Selection.clear("node")},async addTo(e){utils.isSearching()&&panelData.$.panel.clearSearch(),e.parent||(e.parent=this.getFirstSelect());var t=await utils.getParentWhenAddNode(e);t&&(vm.toggle(e.parent,!0),e.parent=t.uuid,e.sibling=utils.getLastExpandChildUuid(t.uuid),await utils.scrollIntoView(e.sibling),e.name=await Editor.Message.request(panelData.act.messageProtocol.scene,"generate-available-name",e.name,e.parent),e.nameIncrease=!1,vm.addNode=e)},addConfirm(e){var t;vm.addNode.sibling="",!e||!e.parent||!(t=utils.getNode(e.parent))||utils.canNotCreateNode(t)?vm.addEnd():vm.add(e)},addEnd(){vm.addNode.parent=""},async add(e){if(!utils.forbidOperate())try{panelData.$.panel.isOperating=!0,await Editor.Message.request(panelData.act.messageProtocol.scene,"create-node",e)}catch(e){console.error(e)}finally{panelData.$.panel.isOperating=!1,vm.addEnd()}},added(e){vm.refresh(),panelData.act.twinkleQueues.push({uuid:e,animation:"shrink"})},changed(e){vm.refresh();e=utils.getNode(e);e&&e.isScene},async delete(e){if(!utils.forbidOperate())if(e&&!panelData.act.selects.includes(e)){var t=utils.getNode(e);!t||utils.canNotDeleteNode(t)||await treeData.deleteNode(e)}else{const a=[],i=[];panelData.act.selects.forEach(e=>{var t=utils.getNode(e);t&&!utils.canNotDeleteNode(t)&&(a.push(e),i.push(treeData.uuidToParentUuid[e]))}),a.length&&await treeData.deleteNode(a)}},deleted(){vm.refresh()},toggle(e,t,a){a?treeData.loopExpand(e,t):treeData.toggleExpand(e,t)},allToggle(){if(treeData.nodeTree){var a=utils.isAllExpand(),i=[],e=panelData.act.selects.length;if(e)for(let t=0;t<e;t++){let e=panelData.act.selects[t];utils.isParent(e)?i.push(e):(e=treeData.uuidToParentUuid[e],i.includes(e)||treeData.toggleExpand(e,!a))}else i.push(treeData.nodeTree.uuid);for(let e=0;e<i.length;e++)treeData.loopExpand(i[e],!a)}},upDownLeftRight(t){var e,a=vm.getLastSelect();if("right"===t)utils.isExpand(a)?(e=treeData.uuidToChildren[a],Array.isArray(e)&&e.length&&vm.ipcSelect(e[0])):vm.toggle(a,!0);else if("left"===t)utils.isExpand(a)?vm.toggle(a,!1):(e=treeData.uuidToParentUuid[a])&&vm.ipcSelect(e);else{var i=utils.getSibling(a);let e;switch(t){case"up":e=i[1];break;case"down":e=i[2]}e&&vm.ipcSelect(e.uuid)}},async shiftUpDown(e){var t=panelData.act.selects.length;if(0!==t){var[t,a,i]=utils.getSibling(panelData.act.selects[t-1]),r=panelData.act.selects.includes(a.uuid),n=panelData.act.selects.includes(i.uuid);if("up"===e){if(!r)return Editor.Selection.select("node",a.uuid),vm.checkShiftUpDownMerge.uuid=a.uuid,void(vm.checkShiftUpDownMerge.direction=e);n||Editor.Selection.unselect("node",t.uuid),await utils.scrollIntoView(a.uuid),panelData.act.selects.splice(panelData.act.selects.indexOf(a.uuid),1),panelData.act.selects.push(a.uuid)}"down"===e&&(n?(r||Editor.Selection.unselect("node",t.uuid),await utils.scrollIntoView(i.uuid),panelData.act.selects.splice(panelData.act.selects.indexOf(i.uuid),1),panelData.act.selects.push(i.uuid)):(Editor.Selection.select("node",i.uuid),vm.checkShiftUpDownMerge.uuid=i.uuid,vm.checkShiftUpDownMerge.direction=e))}},shiftUpDownMergeSelected(){if(vm.checkShiftUpDownMerge.uuid){let e=!0,t=vm.checkShiftUpDownMerge.uuid,a=(vm.checkShiftUpDownMerge.uuid="",panelData.act.selects.length);for(;e;){var i=utils.getSibling(t);if(!(i&&i[1]&&i[2]&&a))return;t=("down"===vm.checkShiftUpDownMerge.direction?i[2]:i[1]).uuid,a--,panelData.act.selects.includes(t)?(panelData.act.selects.splice(panelData.act.selects.indexOf(t),1),panelData.act.selects.push(t)):e=!1}}},async moveNode(r){if(!lockMoveNode){lockMoveNode=!0;var n={};const d=t(panelData.act.selects[0]);n[d.parent]=[d];for(let e=1;e<panelData.act.selects.length;e++){const a=t(panelData.act.selects[e]);n[a.parent]||(n[a.parent]=[]),d.parent===a.parent&&(n[a.parent].find(e=>e.node===d.node)||n[a.parent].push(d),n[a.parent].find(e=>e.node===a.node))||n[a.parent].push(a)}let i=!1;for(const e in n){var s=n[e],l=(s.sort((e,t)=>e.index>t.index?1:e.index<t.index?-1:0),[]);let t=[s[0]];for(let e=1;e<s.length;e++)s[e].index===s[e-1].index+1?t.push(s[e]):(l.push(t),t=[s[e]]);if(l.push(t),"down"===r||"bottom"===r){l.sort((e,t)=>e[0].index>t[0].index?-1:e[0].index<t[0].index?1:0);for(const c of l)c.sort((e,t)=>e.index>t.index?-1:e.index<t.index?1:0)}let a=0;for(const u of l){let e=0;const d=u[0];var o=d.parentChildren.length-1;switch(r){case"up":0<=d.index-1&&(e=-1);break;case"top":0<=d.index-1&&(e=a-d.index);break;case"down":d.index+1<=o&&(e=1);break;case"bottom":d.index+1<=o&&(e=o-(d.index+a));break;default:e=0}if(a=u.length,0!==e){i=!0;for(const p of u)await treeData.moveNode(p.parent,p.index,e)}}}function t(t){var e=treeData.uuidToParentUuid[t],a=treeData.uuidToChildren[e]||[],i=a.findIndex(e=>e===t)||0;return{node:t,parent:e,parentChildren:a,index:i}}i&&(Editor.Message.send(panelData.act.messageProtocol.scene,"snapshot"),"top"===r?vm.intoViewByUser=this.getFirstSelectSortByDisplay():"bottom"===r&&(vm.intoViewByUser=this.getLastSelectSortByDisplay())),setTimeout(()=>{lockMoveNode=!1},50)}},async keyboardRename(){var e,t;utils.forbidOperate()||vm.renameUuid||(e=vm.getFirstSelect(),(t=utils.getNode(e))&&!utils.canNotRename(t)&&(await utils.scrollIntoView(e),vm.renameUuid=e))},async rename(e,t){var a;utils.forbidOperate()||(vm.renameUuid="",(a=utils.getNode(e))&&"loading"!==treeData.uuidToState[e]&&(null===t||utils.canNotRename(a)||t===a.name||(treeData.uuidToState[e]="loading",a=await Editor.Message.request(panelData.act.messageProtocol.scene,"begin-recording",e,{auto:!1}),await Editor.Message.request(panelData.act.messageProtocol.scene,"set-property",{uuid:e,path:"name",dump:{type:"string",value:t}})?await Editor.Message.request(panelData.act.messageProtocol.scene,"end-recording",a):(await Editor.Message.request(panelData.act.messageProtocol.scene,"cancel-recording",a),vm.dialogError("renameFail"))),treeData.uuidToState[e]=""))},async search(){panelData.$.panel.searchValue?(panelData.$.viewBox.scrollTo(0,0),"asset"===panelData.$.panel.searchType&&await treeData.findNodesUseAsset()):vm.intoViewByUser=vm.getFirstSelect(),"missAsset"===panelData.$.panel.searchType&&(panelData.$.viewBox.scrollTo(0,0),await treeData.findNodesMissAsset()),treeData.render()},dragOver(f,h){window.cancelAnimationFrame(requestAnimationId),requestAnimationId=requestAnimationFrame(()=>{""===f&&(f=vm.getFirstChild());var r=utils.getNode(f);if(r){var n=Date.now();if(dragOverUuid!==f)dragOverUuid=f,dragOverTime=n;else if(800<n-dragOverTime&&!treeData.uuidToExpand[r.uuid])return"inside"===h&&vm.toggle(r.uuid,!0),void requestAnimationFrame(()=>{panelData.$.viewBox.scrollTop+=1});var{nodeHeight:s,iconWidth:n,padding:l}=panelData.config,{clientHeight:o,offsetHeight:d,scrollTop:c,scrollHeight:u}=panelData.$.viewBox,c=c&&o+c===u,p=panelData.$.viewBox.getBoundingClientRect(),g=vm.$el.getBoundingClientRect(),p=p.top-g.top,g=vm.scrollTop%s,d=d-o,o=r.depth*n;let e=treeData.displayArray.indexOf(f)*s-p+g+l,t=-13,a=(c&&(t-=2,e+=d),s),i=0;r=vm.$el.offsetWidth-o+3,n=o-3,p=treeData.displayArray.indexOf(treeData.uuidToParentUuid[f])*s;switch(h){case"before":a=2,i=10;break;case"after":a=2,i=10,e=(treeData.displayArray.indexOf(utils.getLastExpandChildUuid(f))+1)*s+l}e=Math.min(u-a,e),utils.isSearching()&&["before","after"].includes(h)||(panelData.$.panel.dropBox={style:{top:e+"px",left:n+"px",height:a+"px",width:r+"px",zIndex:i},position:h,vertical:{height:e-p+t+"px"}})}})},dragEnter(){utils.isSearching()?panelData.$.panel.dropBox.style={top:"-2px"}:(window.cancelAnimationFrame(requestAnimationId),requestAnimationId=requestAnimationFrame(()=>{vm.dragOver("","after")}))},drop(e){var t;e.target&&!e.target.hasAttribute("hoving")||((t=JSON.parse(JSON.stringify(Editor.UI.__protected__.DragArea.currentDragInfo))||{}).to=utils.getLastChildUuid(treeData.nodeTree?.uuid),t.insert="after",t.copy=e.ctrlKey,t.keepWorldTransform=!e.shiftKey,vm.ipcDrop(t))},async ipcDrop(t){if(panelData.$.panel.focusWindow(),!utils.forbidOperate()){utils.isSearching()&&panelData.$.panel.clearSearch();const u=[],p=[];var{value:a,type:i,name:r,insert:n}=t;let e=t["additional"];if("inside"===n&&vm.toggle(t.to,!0),e){Array.isArray(e)||(e=[e]);const g=["cc.Prefab","cc.LabelAtlas"],f=new Map;e.filter(e=>vm.droppableTypes.includes(e.type)).forEach(e=>{var[t]=e.value.split("@"),a=f.get(t)||[];a.push(e),f.set(t,a)}),f.forEach((e,t)=>{e=e.some(e=>g.includes(e.type))?e.filter(e=>g.includes(e.type)):e;0<e.length&&(u.push(...e.map(e=>e.value)),p.push(...e))})}else if(!vm.droppableTypes.includes(i))return;if(a&&!u.includes(a)&&(u.push(a),p.push({type:i,value:a,name:r})),t.additional=p,"cc.Node"===t.type)u.length&&(t.copy?(await vm.copy(u),await vm.paste(t.to,t.keepWorldTransform)):vm.move(t));else if(panelData.config.extendDrop.types&&panelData.config.extendDrop.types.includes(t.type)){n=Object.values(panelData.config.extendDrop.callbacks[t.type]);if(n&&Array.isArray(n)){const h=utils.getNode(t.to);if(h){const D=treeData.uuidToParentUuid[t.to],m=treeData.uuidToChildren[D].indexOf(t.to);n.forEach(e=>{e({node:h.uuid,parent:D,index:m,position:t.insert},t.additional)})}}}else{i=utils.getNode(t.to);if(i){var s=treeData.uuidToParentUuid[t.to]??i.uuid;i.isPrefabRoot&&"inside"!==t.insert&&(t.insert="inside");let e="inside"===t.insert?[t.to]:[s];"inside"===t.insert&&panelData.act.selects.includes(t.to)&&(e=[...panelData.act.selects]);var a=await Editor.Message.request(panelData.act.messageProtocol.scene,"begin-recording",e),l=[];for(const v of p)if(panelData.config.creatableTypes.includes(v.type)){var o,d=v.value;for(const y of e)utils.getNode(y)&&(vm.addNode.parent=y,o=await Editor.Message.request(panelData.act.messageProtocol.scene,"create-node",{parent:y,assetUuid:d,name:v.name,type:v.type,unlinkPrefab:v.unlinkPrefab,canvasRequired:v.canvasRequired}),vm.addNode.parent="",l.push(o));if("inside"!==t.insert){var c=treeData.uuidToChildren[s];let e=c.indexOf(t.to)-c.length;e<0&&"after"===t.insert?e+=1:0<e&&"before"===t.insert&&--e,treeData.moveNode(s,c.length,e)}}l.length?await Editor.Message.request(panelData.act.messageProtocol.scene,"end-recording",a):await Editor.Message.request(panelData.act.messageProtocol.scene,"cancel-recording",a),vm.ipcSelect(l)}}}},async copy(t){if(!utils.forbidOperate()){let e=[];t=(e=Array.isArray(t)?t:t&&!panelData.act.selects.includes(t)?[t]:panelData.act.selects.slice()).filter(e=>{e=utils.getNode(e);return e&&!utils.canNotCopyNode(e)}),t=utils.filterChildren(t);await treeData.copyNode(t),t.forEach(e=>{utils.twinkle.add(e,"light")})}},async paste(e,t=!1,a){if(!utils.forbidOperate()){e=e||this.getFirstSelect();var i=Editor.Clipboard.read("nodes-info");if(i&&"cut"===i.type&&i.uuids.length&&Editor.Project.path===i.projectPath)return r=i.uuids,(r=utils.filterChildren(r)).includes(e)?void 0:(r={type:"cc.Node",to:e,insert:"inside",additional:r.map(e=>({value:e,type:"cc.Node"})),keepWorldTransform:t,copy:!1},await vm.move(r),void Editor.Clipboard.clear());if(i&&"copy"===i.type&&i.uuids.length&&Editor.Project.path===i.projectPath){var r=i.uuids;try{panelData.$.panel.isOperating=!0;var n=utils.filterChildren(r);await treeData.pasteNode(e,n,t,a)}catch(e){console.error(e)}finally{panelData.$.panel.isOperating=!1}}}},async cut(t){if(!utils.forbidOperate()){let e=[];t=(e=Array.isArray(t)?t:t&&!panelData.act.selects.includes(t)?[t]:panelData.act.selects.slice()).filter(e=>{e=utils.getNode(e);return e&&!utils.canNotCutNode(e)});0!==t.length&&(t.forEach(e=>{utils.twinkle.add(e,"light")}),await treeData.cutNode(t))}},async duplicate(t){if(!utils.forbidOperate()){let e=[];e=Array.isArray(t)?t:t&&!panelData.act.selects.includes(t)?[t]:panelData.act.selects.slice();t=utils.filterChildren(e).filter(e=>{e=utils.getNode(e);return e&&!utils.canNotCopyNode(e)});if(t.length)try{panelData.$.panel.isOperating=!0,await treeData.duplicateNode(t)}catch(e){console.error(e)}finally{panelData.$.panel.isOperating=!1}}},async move(r){if(!utils.forbidOperate()&&r&&r.to&&Array.isArray(r.additional)){var e=r.additional.map(e=>e.value);if(!e.includes(r.to)){const c=utils.getNode(r.to);var a=utils.getParent(r.to);if(c&&(!c.isPrefabRoot||"inside"===r.insert))if(c.isScene&&"inside"!==r.insert)r.insert="inside",await vm.move(r);else{let i=c;var n=(i=a&&["before","after"].includes(r.insert)?a:i).uuid,a=e.map(e=>{var t,a;return utils.isAIncludeB(e,r.to)||(t=utils.getNode(e),a=utils.getParent(e),!t)||"inside"===r.insert&&i===a?"":e}).filter(Boolean).sort((e,t)=>treeData.uuidToIndex[e]-treeData.uuidToIndex[t]);if(a.length){var s,l={};l[n]=!0;for(const u of a)utils.getNode(u)&&n!==(s=treeData.uuidToParentUuid[u])&&(l[s]=!0);e=await Editor.Message.request(panelData.act.messageProtocol.scene,"begin-recording",Object.keys(l));let t=0;for(const p of a){const g=utils.getNode(p);if(g)if(vm.intoViewByUser=p,n!==treeData.uuidToParentUuid[p]&&await treeData.setParent(n,[p],r.keepWorldTransform),["before","after"].includes(r.insert)){var o=await treeData.getDumpData(i.uuid),d=o.children.findIndex(e=>e.value.uuid===c.uuid),o=o.children.findIndex(e=>e.value.uuid===g.uuid);let e=d-o;"after"===r.insert&&(e<0&&(e+=1),e+=t),"before"===r.insert&&0<e&&--e,await treeData.moveNode(i.uuid,o,e),t++}}await Editor.Message.request(panelData.act.messageProtocol.scene,"end-recording",e)}}}}},render(){for(panelData.$.panel.treeHeight=treeData.displayArray.length*panelData.config.nodeHeight+2*panelData.config.padding,panelData.$.panel.allExpand=utils.isAllExpand();panelData.act.twinkleQueues.length;){var e=panelData.act.twinkleQueues.shift();utils.twinkle.add(e.uuid,e.animation)}vm.filter()},filter(){var e,t,a,i;panelData.$.panel.viewHeight&&(vm.nodes=[],e=panelData.config.nodeHeight,t=(i=(a=vm.scrollTop)-(a=a%e))+panelData.$.panel.viewHeight,vm.$el.style.top=`-${a}px`,a=Math.round(i/e),i=Math.ceil(t/e)+1,vm.nodes=treeData.outputDisplay(a,i),clearTimeout(vm.scrollIntoViewTimeId),vm.scrollIntoViewTimeId=setTimeout(async()=>{vm.intoViewByUser&&await utils.scrollIntoView(vm.intoViewByUser)&&(vm.intoViewByUser="")},50))},getFirstSelect(){var e=panelData.act.selects[0];return e||vm.getFirstChild()},getLastSelect(){var e=panelData.act.selects.length;return e?panelData.act.selects[e-1]:vm.getFirstChild()},getFirstSelectSortByDisplay(){let t="",a=1/0;return panelData.act.selects.forEach(e=>{treeData.uuidToIndex[e]<a&&(a=treeData.uuidToIndex[e],t=e)}),t||treeData.nodeTree?.uuid},getLastSelectSortByDisplay(){let t="",a=0;return panelData.act.selects.forEach(e=>{treeData.uuidToIndex[e]>a&&(a=treeData.uuidToIndex[e],t=e)}),t||treeData.nodeTree?.uuid},getFirstChild(){return utils.isSearching()?treeData.nodeTree?.uuid:treeData.displayArray[0]},isActive(e){return utils.isActive(e)},isExpand(e){return utils.isExpand(e)},isParent(e){return utils.isParent(e)},isSelected(e){return utils.isSelected(e)},isAnimating(e){return utils.isAnimating(e||panelData.act.animationUuid)},isSearching(){return utils.isSearching()},async dialogError(e){await Editor.Dialog.error(Editor.I18n.t("hierarchy.operate."+e),{title:Editor.I18n.t("hierarchy.operate.dialogError")})}},exports.data=data,exports.mounted=mounted;