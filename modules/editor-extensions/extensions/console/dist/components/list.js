"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.methods=exports.watch=exports.computed=exports.data=exports.props=exports.name=exports.template=void 0;const fs_1=require("fs"),path_1=require("path"),utils_1=require("../utils"),manager=require("../manager"),outputList=manager.outputList;let isOperating=!1,renderListTimer=null,scrollTopcache=0;function data(){return{timer:null,cacheListLength:0,showList:[],wrapperStyle:{height:0},isRending:!1,listTransformY:0,replaceTextTimer:null}}exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../static","/template/list.html"),"utf8"),exports.name="console-list",exports.props={fontSize:{type:Number},lineHeight:{type:Number}},exports.data=data,exports.computed={listStyle(){var{listTransformY:t,fontSize:e,lineHeight:i}=this;return{transform:`translateY(${t}px)`,"--font-size":e+"px","--line-height":i+"px"}}},exports.watch={lineHeight(t){t&&this.renderList()}},exports.methods={toggleContent(e){var t=outputList.find(t=>t.translateY===e);t&&(t.fold=!t.fold,manager.update(!0))},createItem(){return{content:[],rows:0,message:"",type:"log",title:"",texture:"",count:1,fold:!0,show:!1,stack:[],translateY:-1e3}},getHeight(){let e=0;return outputList.forEach(t=>{t.fold?e+=this.lineHeight:e+=t.rows*this.lineHeight}),e},getScrollPosition(i,s){let r=0,o=0;return outputList.some((t,e)=>(t.fold?r+=s:r+=t.rows*s,r>i&&(o=e-1,!0))),Math.max(o,0)},renderList(t=!1){if(this.isRending)renderListTimer&&(window.clearTimeout(renderListTimer),renderListTimer=null),renderListTimer=window.setTimeout(()=>{this.renderList(t)},200);else{this.isRending=!0;const l=this.getHeight();this.wrapperStyle.height=l+"px";var e=this.lineHeight,i=this.$el.clientHeight,s=Math.ceil(i/e)+3,r=(this.showList.splice(s),this.$el.scrollTop),o=outputList.length-this.cacheListLength,i=l-i-r<=o*e;this.cacheListLength=outputList.length;for(let t=0;t<s;t++){var n=this.showList[t];n?(n.show=!1,n.translateY=-1e3):this.showList.push(this.createItem())}!i||isOperating||t||requestAnimationFrame(()=>{this.$el.scrollTop=l-this.$el.clientHeight+8}),this.onScroll(),this.isRending=!1}},onScroll(t){if(!isOperating){isOperating=!0;var e=this.$el.scrollTop,i=2<Math.abs(e-scrollTopcache),t=(t&&t.target&&i&&"Range"===(i=t.target.getRootNode().getSelection()).type&&i.removeAllRanges(),scrollTopcache=e,this.lineHeight);const s=this.getScrollPosition(e,t);this.listTransformY=outputList[s]?.translateY??0,this.showList.forEach((t,e)=>{var i=outputList[s+e];i?(t.date=i.date,t.type=i.type,t.rows=i.rows,t.title=i.title,t.content=i.content,t.count=i.count,t.fold=i.fold,t.translateY=i.translateY,t.texture=(s+e)%2==0?"dark":"light",t.stack=i.stack,t.show=!0):(t.translateY=-1e3,t.show=!1)}),isOperating=!1}},showMenuPast(t,e){t.preventDefault();let i="";t=document.getSelection();"Range"===t?.type?i=t.toString():(i+=e.title+` 
`,1<e.rows&&(e.content.forEach(t=>{i+=t+` 
`}),e.stack?.forEach?.(t=>{i+=t+` 
`}))),Editor.Menu.popup({menu:[{label:Editor.I18n.t("console.copy"),click(){Editor.Clipboard.write("text",i)}}]})},renderText(t){return t&&(t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;"),t=(0,utils_1.replaceHttpAndLocalPath2UILink)(t),t=(0,utils_1.transformText)(t)),t},onTextClick(t){var e;t.target&&(null===t.target.getAttribute("bubble")&&this.$el!==t.target&&(t.stopPropagation(),t.preventDefault()),e=t.target.getRootNode().getSelection())&&e.baseOffset!==e.focusOffset&&(t.stopPropagation(),t.preventDefault())}};