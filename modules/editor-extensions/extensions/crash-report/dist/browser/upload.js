"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.uploadMgr=exports.UploadMgr=exports.UploadFileInfo=void 0;const axios_1=__importDefault(require("axios")),fs_extra_1=require("fs-extra"),utils_1=require("../utils"),stream_1=require("stream"),path_1=require("path"),{FormData,Blob,File}=require("formdata-node"),FormDataEncoder=require("form-data-encoder")["FormDataEncoder"],hmacSHA256=require("crypto-js/hmac-sha256");class UploadFileInfo{constructor(){this.file=Buffer.from(""),this.fileMd5="",this.partMd5="",this.name="unknow",this.size=0,this.index=1,this.total=1,this.action="upload",this.projectId="CreatorAnalytics",this.serviceId="crash-report",this.cuser="sys",this.tags="",this.isFuzzy=!1,this.uploadFlag=0}toFormData(){var e=new FormData;for(const a in this){var t=this[a];Buffer.isBuffer(t)?e.append(a,new Blob([t.buffer])):e.append(a,String(t))}return e}}function sortObjectKey(t){const a={};return Object.keys(t).sort().map(e=>{a[e]=t[e]}),a}function getReqSignature(e,t,a,r,s){var i=(new Date).getTime();const o={};e.forEach((e,t)=>{var a=e.toString();"[object File]"!==a&&"[object Blob]"!==a&&(o[t]=e)});var l=sortObjectKey(o);let n="";for(const c in l)!{}.hasOwnProperty.call(l,c)||(n+=`${c}=${l[c]}&`);return{grantType:"aksk",accessKey:a,projectId:s,timestamp:i,signature:hmacSHA256(`${s}&${n}${t}&`+i,r).toString()}}exports.UploadFileInfo=UploadFileInfo;class UploadMgr{constructor(){this.serviceId="crash-report",this.baseURL="https://gateway.cocos.com",this.projectId="CreatorAnalytics",this.ak="107c2c83ea164b5682f9ffc8eede42ab",this.sk="1131702614884bafba5a4fddaa73a8ed",this.apiURL="/cdn/uploadFileByCache",this.allowCrashReportAPIURL="/A018/v1/A018AP001",this.client=axios_1.default.create({timeout:12e4}),this.client.interceptors.request.use(e=>{var t,a,r;return e.data instanceof FormData&&(t=e.data.get("__apiURL__")||this.apiURL,e.data.delete("__apiURL__"),e.maxContentLength=1/0,a=new FormDataEncoder(e.data),r=e.headers,e.headers={...r,...a.headers,...getReqSignature(e.data,t,this.ak,this.sk,this.projectId)},e.data=stream_1.Readable.from(a.encode())),e})}async check(){try{var e=(await Editor.User.getUserToken())["access_token"],t=new FormData,a=(t.append("__apiURL__",this.allowCrashReportAPIURL),t.append("access_token",String(e)),await this.client.post(this.baseURL+this.allowCrashReportAPIURL,t))["data"];return a.data}catch(e){return console.error(e),!1}}async packMultipleZipAndUpload(t,a){for(let e=0;e<a.length;e++)await this.packZipAndUpload(t,a[e])}packZipAndUpload(e,s){const t=new(require("jszip"));t.file("问题描述.txt",e||"未描述");try{t.file("编辑器日志.log",(0,fs_extra_1.readFileSync)(s.editorLog))}catch(e){t.file("未找到编辑器日志.log",String(e))}try{var a=(0,utils_1.getLatestFilePath)(s.dbLog,".log");t.file("AssetDB日志.log",(0,fs_extra_1.readFileSync)(a))}catch(e){t.file("未找到AssetDB日志.log",String(e))}try{var r=(0,utils_1.getLatestFilePath)(s.buildLog,".log");t.file("构建日志.log",(0,fs_extra_1.readFileSync)(r))}catch(e){t.file("未找到构建日志.log",String(e))}try{var i=(0,utils_1.getLatestFilePath)(s.crashLog,".dmp");t.file((0,path_1.basename)(i),(0,fs_extra_1.readFileSync)(i))}catch(e){t.file("未找到 Crash 文件.log",String(e))}try{t.file("项目信息.json",(0,fs_extra_1.readFileSync)(s.projectJSON))}catch(e){t.file("未找到项目信息.json",String(e))}return t.file("崩溃详细信息.json",Buffer.from(JSON.stringify(s,null,4))),new Promise((a,r)=>{t.generateAsync({type:"nodebuffer",compression:"DEFLATE",compressionOptions:{level:9}}).then(async e=>{try{var t={["Crash_"+s.process]:"Crash_"+s.process,app_version:Editor.App.version};await this.upload(s,e,JSON.stringify(t)),a(null)}catch(e){r(e)}})})}async upload(e,t,a){var r=10485760,s=t.length;let i=1;for(var o,l,n=Math.ceil(s/r),c=(0,utils_1.calcMd5)(t),d=e.zipName;i<=n;)o=(i-1)*r,l=Math.min(s,o+r),await this.uploadSlice({name:d,file:Buffer.from(t.slice(o,l)),size:s,index:i,total:n,tags:a,fileMd5:c,cuser:e.uid}),i++}async uploadSlice(e){try{var t=new UploadFileInfo,a=(t.file=e.file,t.size=e.size,t.index=e.index,t.total=e.total,t.partMd5=(0,utils_1.calcMd5)(e.file),t.fileMd5=e.fileMd5,t.name=e.name,t.serviceId="crash-report",t.projectId="CreatorAnalytics",t.cuser=e.cuser,t.tags=e.tags,console.debug(">>> upload data：",t),await this.client.post(this.baseURL+this.apiURL,t.toFormData()));console.debug(`>>> upload data${200!==a?.data?.code?"failed":"successful"}，info：`,a)}catch(e){console.error(">>> upload failed",e)}}}exports.UploadMgr=UploadMgr,exports.uploadMgr=new UploadMgr;