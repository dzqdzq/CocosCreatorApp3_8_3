"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.windowProcess=exports.WinProcessManage=void 0;const path_1=require("path"),electron_1=require("electron"),MOD_PATH=(0,path_1.join)(Editor.App.path,"../tools/windows-process-tree"),UTILITY_NETWORK_HINT_REG=/--utility-sub-type=network/,TYPE_REG=/--type=([a-zA-Z-]+)/,JS_REG=/[a-zA-Z-]+\.js/g;class WinProcessManage{constructor(){this.windowProcessInstance=null,this.windowPanelCollect={}}async init(){try{this.windowProcessInstance=await require(MOD_PATH)}catch(e){console.error(e)}}cleanUNCPrefix(e){switch(!0){case e.startsWith("\\\\?\\"):case e.startsWith("\\??\\"):return e.slice(4);case e.startsWith('"\\\\?\\'):case e.startsWith('"\\??\\'):return e.slice(5);default:return e}}parseWindowInfo(){var e=electron_1.webContents.getAllWebContents(),s=electron_1.BrowserWindow.getAllWindows();const t=e.reduce((e,s)=>(e[s.getOSProcessId()]=[s.getTitle(),!1],e),{});return s.forEach(e=>{e=e.webContents.getOSProcessId();t[e]&&(t[e][1]=!0)}),t}getProcessName(e,s){if(this.windowPanelCollect[e])return this.windowPanelCollect[e][0];let t=TYPE_REG.exec(s);if(t&&2===t.length)return"renderer"===(e=t[1])?"window":"utility"===e&&UTILITY_NETWORK_HINT_REG.exec(s)?"utility-network-service":e;let n="";for(;(t=JS_REG.exec(s))&&(n+=t+" "),t;);return n&&s.indexOf("node ")<0&&s.indexOf("node.exe")<0?"electron_node "+n:s}getProcessList(e){return new Promise(async s=>{this.windowProcessInstance||await this.init(),this.windowPanelCollect=this.parseWindowInfo(),this.windowProcessInstance.getProcessList(e,e=>{this.windowProcessInstance.getProcessCpuUsage(e,e=>{e=e.reduce((e,s)=>{var t=this.cleanUNCPrefix(s.commandLine||"");return e.push({name:this.getProcessName(s.pid,t),pid:s.pid,ppid:s.ppid,cmd:t,cpu:Number(s.cpu.toFixed(2))||0,memory:Math.ceil(s.memory/1024/1024)||0,panel:!!this.windowPanelCollect[s.pid]&&this.windowPanelCollect[s.pid][1]}),e},[]);s(e)})},this.windowProcessInstance.ProcessDataFlag.CommandLine|this.windowProcessInstance.ProcessDataFlag.Memory)})}}exports.WinProcessManage=WinProcessManage,exports.windowProcess=new WinProcessManage;