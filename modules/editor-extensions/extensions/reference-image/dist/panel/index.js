"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const package_json_1=__importDefault(require("../../package.json")),path_1=require("path"),fs_1=require("fs"),{I18n,Message,Dialog,Profile}=Editor;let currentImageData;const shortcutsMoveDistance=2;let onPositionChangeFunc,onScaleChangeFunc,onOpacityChangeFunc,onAddImageFunc,onDelImageFunc,onSwitchImagesFunc;module.exports=Editor.Panel.define({style:(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../dist/index.css"),"utf8"),template:(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../statics/index.html"),"utf8"),$:{ui_images:".images",btnAdd:".add-image",btnAddLabel:"#add-btn-label",btnDel:".del-image",x:".x",y:".y",sx:".sx",sy:".sy",opacity:".opacity"},methods:{set$(e,t){e&&(e.value=t)},getCurrent(){return currentImageData},async renderUI(t,e){for(var a;null!=(a=this.$.ui_images)&&a.firstChild;)null!=(a=this.$.ui_images)&&a.removeChild(null==(a=this.$.ui_images)?void 0:a.firstChild);for(let e=0;e<t.length;++e){0===e&&((n=document.createElement("option")).setAttribute("value",""),n.text=I18n.t("reference-image.none"),null!=(s=this.$.ui_images))&&s.appendChild(n);var n,s=document.createElement("option"),i=(s.setAttribute("value",t[e].path),null!=(n=this.$.ui_images)&&n.appendChild(s),t[e].path);s.text=(0,path_1.basename)(i,(0,path_1.extname)(i))}null!=(r=this.$.ui_images)&&r.removeAttribute("placeholder"),0===t.length?(null!=(r=this.$.ui_images)&&r.setAttribute("style","display: none"),null!=(r=this.$.ui_images)&&r.setAttribute("value",""),null!=(r=this.$.btnDel)&&r.setAttribute("style","display: none"),null!=(r=this.$.btnAdd)&&r.setAttribute("style","width: 100%"),null!=(r=this.$.btnAddLabel)&&r.setAttribute("value",I18n.t("reference-image.none_tips")),null!=(r=this.$.x)&&r.setAttribute("disabled",""),null!=(r=this.$.y)&&r.setAttribute("disabled",""),null!=(r=this.$.sx)&&r.setAttribute("disabled",""),null!=(r=this.$.sy)&&r.setAttribute("disabled",""),null!=(r=this.$.opacity)&&r.setAttribute("disabled","")):(null!=(r=this.$.ui_images)&&r.removeAttribute("style"),null!=(r=this.$.ui_images)&&r.setAttribute("value",e.path),null!=(r=this.$.btnDel)&&r.setAttribute("style","width: 100px"),null!=(e=this.$.btnAdd)&&e.setAttribute("style","width: 100px"),null!=(r=this.$.btnAddLabel)&&r.setAttribute("value",I18n.t("reference-image.add_image")),null!=(e=this.$.x)&&e.removeAttribute("disabled"),null!=(r=this.$.y)&&r.removeAttribute("disabled"),null!=(e=this.$.sx)&&e.removeAttribute("disabled"),null!=(r=this.$.sy)&&r.removeAttribute("disabled"),null!=(e=this.$.opacity)&&e.removeAttribute("disabled"));var{x:r,y:e,sx:l,sy:u,opacity:o}=this.getCurrent();this.set$(this.$.x,r),this.set$(this.$.y,e),this.set$(this.$.sx,l),this.set$(this.$.sy,u),this.set$(this.$.opacity,o)},async onAddImage(){var e=await Dialog.select({title:I18n.t("reference-image.dialog.add-image-title"),path:await Profile.getConfig("reference-image","root-path")||"",filters:[{name:"image",extensions:["png","jpg"]}]});e&&e.filePaths[0]&&(await Editor.Message.request(package_json_1.default.name,"add-image",e.filePaths),e=(0,path_1.dirname)(e.filePaths[0]),await Profile.setConfig("reference-image","root-path",e))},async onDelImage(){var e=this.getCurrent()["path"];0===(await Dialog.info(I18n.t("reference-image.dialog.del_image_message",{path:e}),{buttons:[I18n.t("reference-image.dialog.yes"),I18n.t("reference-image.dialog.cancel")],default:0,cancel:1})).response&&await Editor.Message.request(package_json_1.default.name,"remove-image")},async onSwitchImages(e){await Editor.Message.request(package_json_1.default.name,"switch-image",e.target.value)},async onOpacityChange(e){await Editor.Message.request(package_json_1.default.name,"set-image-data","opacity",e.target.value)},async onPositionChange(e){e.currentTarget===this.$.x?await Editor.Message.request(package_json_1.default.name,"set-image-data","x",e.target.value):await Editor.Message.request(package_json_1.default.name,"set-image-data","y",e.target.value)},async onScaleChange(e){e.currentTarget===this.$.sx?await Editor.Message.request(package_json_1.default.name,"set-image-data","sx",e.target.value):await Editor.Message.request(package_json_1.default.name,"set-image-data","sy",e.target.value)},async shortcutsMoveRight(){var e=this.getCurrent();e.x+=shortcutsMoveDistance,await Editor.Message.request(package_json_1.default.name,"set-image-data","x",e.x)},async shortcutsMoveLeft(){var e=this.getCurrent();e.x-=shortcutsMoveDistance,await Editor.Message.request(package_json_1.default.name,"set-image-data","x",e.x)},async shortcutsMoveUp(){var e=this.getCurrent();e.y+=shortcutsMoveDistance,await Editor.Message.request(package_json_1.default.name,"set-image-data","y",e.y)},async shortcutsMoveDown(){var e=this.getCurrent();e.y-=shortcutsMoveDistance,await Editor.Message.request(package_json_1.default.name,"set-image-data","y",e.y)},registerEventListeners(){var e;onPositionChangeFunc=this.onPositionChange.bind(this),onOpacityChangeFunc=this.onOpacityChange.bind(this),onScaleChangeFunc=this.onScaleChange.bind(this),onSwitchImagesFunc=this.onSwitchImages.bind(this),onAddImageFunc=this.onAddImage.bind(this),onDelImageFunc=this.onDelImage.bind(this),null!=(e=this.$.x)&&e.addEventListener("change",onPositionChangeFunc),null!=(e=this.$.y)&&e.addEventListener("change",onPositionChangeFunc),null!=(e=this.$.sx)&&e.addEventListener("change",onScaleChangeFunc),null!=(e=this.$.sy)&&e.addEventListener("change",onScaleChangeFunc),null!=(e=this.$.opacity)&&e.addEventListener("change",onOpacityChangeFunc),null!=(e=this.$.ui_images)&&e.addEventListener("confirm",onSwitchImagesFunc),null!=(e=this.$.btnAdd)&&e.addEventListener("click",onAddImageFunc),null!=(e=this.$.btnDel)&&e.addEventListener("click",onDelImageFunc)},unregisterEventListeners(){var e;null!=(e=this.$.x)&&e.removeEventListener("change",onPositionChangeFunc),null!=(e=this.$.y)&&e.removeEventListener("change",onPositionChangeFunc),null!=(e=this.$.sx)&&e.removeEventListener("change",onScaleChangeFunc),null!=(e=this.$.sy)&&e.removeEventListener("change",onScaleChangeFunc),null!=(e=this.$.opacity)&&e.removeEventListener("change",onOpacityChangeFunc),null!=(e=this.$.ui_images)&&e.removeEventListener("confirm",onSwitchImagesFunc),null!=(e=this.$.btnAdd)&&e.removeEventListener("click",onAddImageFunc),null!=(e=this.$.btnDel)&&e.removeEventListener("click",onDelImageFunc)},async onDataChangeByRefresh(e,t){currentImageData=t,await this.renderUI(e.images,t)}},async ready(){this.registerEventListeners(),Editor.Message.send(package_json_1.default.name,"refresh")},async close(){this.unregisterEventListeners()}});