"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.isPath=exports.trimDependUuid=exports.doImportAssets=exports.writeAssets=exports.checkMetaUUid=exports.analyticalContent=exports.initScript=exports.sameScriptList=exports.getImportAssets=exports.getDependScriptUuid=exports.readWriteFileByLineWithProcess=exports.initTemplate=exports.close=exports.beforeClose=exports.isRefresh=exports.STATE=exports.PATH_REGEXP=exports.importOverrideTipMarker=void 0;const path_1=require("path"),fs_1=require("fs"),resolve_1=(module.paths.push((0,path_1.join)(Editor.App.path,"node_modules")),__importDefault(require("resolve"))),fs_extra_1=require("fs-extra"),readline_1=require("readline"),node_uuid_1=require("node-uuid"),crypto_1=require("crypto"),JSZip=require("../../lib/jszip.min"),JSZipUtils=require("../../lib/jszip-utils.min");function onRefresh(e){exports.isRefresh=(e.metaKey||e.ctrlKey)&&"r"===e.key}function beforeClose(){return!exports.isRefresh||(exports.isRefresh=!1)}function close(){window.removeEventListener("keydown",onRefresh)}function initTemplate(t){window.addEventListener("keydown",onRefresh);const e=(0,path_1.join)(__dirname,"../../icon/new.png");t.$.tree.css=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../css/tree.css"),"utf8"),t.$.tree.$content.style.overflowX="auto",t.$.tree.setTemplate("text",`
        <ui-checkbox></ui-checkbox>
        <ui-icon color ></ui-icon>
        <span class="name"></span>
        <image class="new" ></image>
        <ui-icon color class="conflict" value="warn-triangle"
            tooltip="i18n:package-asset.import.conflict_text"
        ></ui-icon>
        <ui-icon color class="select" value="select"></ui-icon>
        
    `),t.$.tree.setTemplateInit("text",s=>{s.$checkbox=s.querySelector("ui-checkbox"),s.$icon=s.querySelector("ui-icon"),s.$name=s.querySelector(".name"),s.$new=s.querySelector(".new"),s.$new.style.display="none",s.$new.src=e.replace("#","%23"),s.$conflict=s.querySelector(".conflict"),s.$conflict.style.display="none",s.$select=s.querySelector(".select"),s.$select.style.display="none",s.$select.addEventListener("click",async()=>{var e=s.data.detail;let t=e.asset.uuid;t||(e="db://"+(0,path_1.join)("assets",e.url),t=await Editor.Message.request("asset-db","query-uuid",e)),Editor.Message.request("assets","twinkle",t)}),s.$checkbox.addEventListener("confirm",()=>{var e=s.data;e.detail.checked=!e.detail.checked,function t(e,s){e.detail.checked=s,e.children&&e.children.forEach(e=>{t(e,s)})}(e,e.detail.checked),function e(t){var s;t&&(s=t.children.some(e=>e.detail.checked))!==t.detail.checked&&(t.detail.checked=s,e(t.parent))}(e.parent),t.$.tree.render(!0),t.updateTotal()})}),t.$.tree.setRender("text",(e,t)=>{t=t.detail;e.$checkbox.value=t.checked,e.$name.innerHTML=t.value,e.$icon.setAttribute("value",t.icon),e.$new.style.display=t.isNew?"":"none",e.$conflict.style.display=t.isConflict?"":"none",e.$select.style.display=!t.isNew||t.isConflict?"":"none"}),t.$.tree.setRender("item",e=>{e.data.detail.legal?e.removeAttribute("disabled"):e.setAttribute("disabled","")})}async function readWriteFileByLineWithProcess(s,i){await new Promise(e=>{var t=(0,fs_1.createReadStream)(s),t=(0,readline_1.createInterface)({input:t});t.on("line",e=>{i(e)}),t.on("close",()=>{e()})})}async function getDependScriptUuid(t){let s="";await readWriteFileByLineWithProcess(t.file,e=>{!e.startsWith("import")||e.includes("./")||e.includes("../")?s+=e+"\n":s+="//"+e+"\n"});var e=require("@babel/core"),i=await e.parseAsync(s,{parserOpts:{plugins:["typescript","classProperties","decorators-legacy","dynamicImport","importMeta","logicalAssignment","nullishCoalescingOperator","optionalChaining"]}});const r=[],a=(e.traverse(i,{ImportDeclaration:({node:e})=>{r.push(e.source.value)}}),[]);return await Promise.all(r.map(e=>new Promise((s,i)=>{(0,resolve_1.default)(e,{basedir:(0,path_1.dirname)(t.file),extensions:[".ts",".js",".mjs",".cjs"]},async(e,t)=>{e?i(e):(t&&(e=await Editor.Message.request("asset-db","query-uuid",t))&&a.push(e),s())})}))),a}async function getImportAssets(e){return new Promise((s,i)=>{JSZipUtils.getBinaryContent(e,(e,t)=>{e?i(e):JSZip.loadAsync(t).then(async e=>{await initScript(e.files),s(e.files)}).catch(e=>{i(e)})})})}async function initScript(t){exports.sameScriptList.length=0;var e=Object.keys(t).map(e=>{if(t[e].name.includes(".ts")&&!t[e].name.endsWith(".meta"))return t[e]}).filter(Boolean);if(0<e.length){var s=[];for(const a of await Editor.Message.request("asset-db","query-assets",{ccType:"cc.Script"})){var i=(0,fs_1.readFileSync)(a.file,"utf8").match(/@ccclass\(['|"](.*)['|"]\)/);let e;e=i?i&&i[1]:(0,path_1.basename)(a.file,(0,path_1.extname)(a.file)),s.includes(e)||s.push(e)}for(const n of e)if(n.name.includes(".ts")){var r=(await getContentByFile(n)).match(/@ccclass\(['|"](.*)['|"]\)/);let e;(e=r?r&&r[1]:(0,path_1.basename)(n.name,(0,path_1.extname)(n.name)))&&s.includes(e)&&(exports.sameScriptList.includes(n.name)||exports.sameScriptList.push(n.name))}}}function checkIsNew(e){try{return!(0,fs_1.existsSync)(e)}catch(e){return!0}}function checkIsConflict(e,t){try{var s,i;return(0,fs_1.statSync)(e).isFile()?(s=(0,fs_1.readFileSync)(e,"utf8"),(i=(0,crypto_1.createHash)("md5").update(s).digest("hex")!==(0,crypto_1.createHash)("md5").update(t).digest("hex"))&&exports.importOverrideTipMarker.push(e),i):!1}catch(e){return!1}}function getIcon(e){try{return _metas.get(e+".meta").importer}catch(e){return"unknow"}}async function createItem(e,t){let s=t||e.name;s=s.endsWith("/")?s.substring(e.name.length-1,0):s;var t=!exports.sameScriptList.includes(s),i=(0,path_1.join)(Editor.Project.path,"assets",s);return{detail:{value:(0,path_1.basename)(s),url:s,file:s,checked:!0,extname:(0,path_1.extname)(s),isDirectory:e.dir,legal:t,asset:e,icon:getIcon(s),isConflict:checkIsConflict(i,await getContentByFile(e)),isNew:checkIsNew(i)&&t},showArrow:e.dir,children:[]}}exports.importOverrideTipMarker=[],exports.PATH_REGEXP=/([`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、])/im,exports.STATE={WAIT:0,IDLE:1,LOADING:2,COMPLETED:3},exports.isRefresh=!1,exports.beforeClose=beforeClose,exports.close=close,exports.initTemplate=initTemplate,exports.readWriteFileByLineWithProcess=readWriteFileByLineWithProcess,exports.getDependScriptUuid=getDependScriptUuid,exports.getImportAssets=getImportAssets,exports.sameScriptList=[],exports.initScript=initScript;const _tree=[],_flattenedTree=[],_metas=new Map;async function addAssetToTree(t){var s,i=t.name.split("/").filter(Boolean);let r="";for(let e=0;e<i.length;++e)if(0<e&&(r+="/"),r+=i[e],!_flattenedTree.find(e=>e.detail.url===r)){s=await createItem(t,r);const n=(0,path_1.dirname)(r);var a=_flattenedTree.find(e=>e.detail.url===n);(a?a.children:_tree).push(s),_flattenedTree.push(s)}}async function analyticalContent(e){exports.importOverrideTipMarker.length=0,_tree.length=0,_flattenedTree.length=0,_metas.clear();var t=[];for(const r in e){var s,i=e[r];i.name.endsWith(".meta")?(s=await getContentByFile(i),s=JSON.parse(s),_metas.set(i.name,s)):t.push(i)}for(let e=0;e<t.length;e++)await addAssetToTree(t[e]);return 0<exports.sameScriptList.length&&await Editor.Dialog.warn(Editor.I18n.t("package-asset.script.message"),{title:Editor.I18n.t("package-asset.script.title"),buttons:[Editor.I18n.t("package-asset.script.confirm")],default:0}),_tree}exports.analyticalContent=analyticalContent;const uuidsMap=new Map;async function checkMetaUUid(e){let t=_metas.get(e.name);t=t||JSON.parse(await getContentByFile(e));var s=await Editor.Message.request("asset-db","query-path",t.uuid);s&&(0,path_1.join)(Editor.Project.path,"assets",(0,path_1.basename)(e.name,(0,path_1.extname)(e.name)))!==s&&uuidsMap.set(t.uuid,(0,node_uuid_1.v4)())}async function getContentByFile(e){return new Promise(t=>{e.async("string").then(e=>{t(e)}).catch(()=>{t("")})})}async function writeAssets(t,s){return new Promise(e=>{s.nodeStream().pipe((0,fs_1.createWriteStream)(t)).on("finish",()=>{e()})})}exports.checkMetaUUid=checkMetaUUid,exports.writeAssets=writeAssets;const skipExtname=[".jpg",".png",".jpeg",".webp",".tga",".effect",".dbbin",".bin",".atlas",".glb",".terrain",".mp3",".wav",".ogg",".aac",".pcm","m4a",".mp4",".labelatlas",".js",".ts",".tmx",".tsx",".fbx"],assetList=[];async function doImportAssets(t,s){uuidsMap.clear(),assetList.length=0;for(const c of t){var e=c.name,i=(0,path_1.join)(Editor.Project.path,"assets",e);(0,fs_1.existsSync)(i)||e.endsWith(".meta")&&await checkMetaUUid(c)}let r=1;for(let e=0;e<t.length;++e){var a=t[e],n=a.name,o=(0,path_1.join)(Editor.Project.path,"assets",n);if(e%2==0&&s((0,path_1.basename)(n),r++),a.dir)(0,fs_1.existsSync)(o)||(0,fs_extra_1.ensureDirSync)(o);else{if(!skipExtname.includes((0,path_1.extname)(a.name))){let s=!1,i=await getContentByFile(a);if(!checkIsNew(o)&&!checkIsConflict(o,i))continue;if(uuidsMap.forEach((e,t)=>{t=new RegExp(t,"g");i.match(t)&&(i=i.replace(t,e),s=!0)}),s){(0,fs_1.writeFileSync)(o,i);continue}}await writeAssets(o,a)}}}function trimDependUuid(e){return e.split("@")[0]}function isPath(t,s=!1){let i;if(t){t=t.match(exports.PATH_REGEXP);if(t){let e;e=s?"package-asset.export.message.name_contains_symbol":"package-asset.import.message.path_contains_symbol",i=Editor.I18n.t(e,{symbol:t[1]})}}else i=Editor.I18n.t("package-asset.path_empty");return!i||(Editor.Dialog.error(i,{buttons:[Editor.I18n.t("package-asset.script.confirm")]}),!1)}exports.doImportAssets=doImportAssets,exports.trimDependUuid=trimDependUuid,exports.isPath=isPath;