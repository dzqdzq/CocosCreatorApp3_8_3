"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs_1=require("fs"),path_1=require("path"),utlis_1=require("./common/utlis"),fs_extra_1=(module.paths.push((0,path_1.join)(Editor.App.path,"node_modules")),require("fs-extra")),collator=new Intl.Collator("en",{numeric:!0,sensitivity:"base"});exports.methods={_dependMap:[],_assetsMap:[],_depends:[],_tree:[],_flattenedTree:[],_databaseAssets:[],_includeDepend:!1,getUuid(e){var t=e.split("@");return e=1<t.length?t[0]:e},async getExportAssets(e){this._includeDepend=e.includeDepend;e=e.uuids;await this._reset();for(const i of e)await this._step(i);e=await Editor.Message.request("assets","unstaging");let t="type";e&&(t=e.sortType);for(let e=0;e<this._tree.length;++e){var s=this._tree[e];await this.pruningTree(e,s,this._tree)}return await this.sortTree(this._tree,t),this._tree},async pruningTree(e,t,s){if(t.detail.isDirectory){var i=[];for(let e=0;e<t.children.length;++e){var r=t.children[e];r.detail.isDirectory&&(0===r.children.length?i.push(e):this.pruningTree(e,r,t))}for(const a of i)t.children.splice(a,1);0===t.children.length&&(Array.isArray(s)?s:s.children).splice(e,1)}},async sortTree(e,s){e.sort((e,t)=>{e=e.detail.asset,t=t.detail.asset;return!0!==e.isDirectory||t.isDirectory?e.isDirectory||!0!==t.isDirectory?"type"===s&&e.importer!==t.importer?collator.compare(e.importer,t.importer):collator.compare(e.path,t.path):1:-1});for(const t of e)this.sortTree(t.children,s)},async _reset(){this._tree.length=0,this._flattenedTree.length=0,this._assetsMap.length=0,this._dependMap=await this._getDependMap(),this._depends.length=0,this._databaseAssets.length=0},async createItem(e){var t,s,i,r=await Editor.Message.request("asset-db","query-asset-info",e);return r?(t=r.isDirectory||"database"===r.importer,s=this._depends.includes(r.uuid),i=!r.url.startsWith("db://internal"),{detail:{value:r.name,url:r.url,file:r.file,checked:!0,extname:(0,path_1.extname)(r.file),isDirectory:t,legal:i,asset:r,depend:s,icon:r.importer},showArrow:t,children:[]}):(console.log("can not found asset info by url: "+e),null)},async _getDependMap(){return Editor.Message.request("asset-db","execute-script",{name:"package-asset",method:"getDependMap"})},async _addAssetTree(r){this._assetsMap.push(r.uuid);var e=this._flattenedTree.find(e=>e.detail.url===r.url);if(!e){var a=r.url.slice("db://".length).split("/");let t,e,s=r.url,i="";for(;0!==a.length;){if(a.pop(),"db://assets"===s&&i){t=this._flattenedTree.find(e=>e.detail.url===i),this._tree.find(e=>e.detail.url===t.detail.url)||this._tree.push(t);break}if(t=this._flattenedTree.find(e=>e.detail.url===s)){var d=t.children.find(e=>e.detail.url===i);if(!d&&e&&(t.children.push(e),t.detail.isDirectory))break}else{if(!(t=await this.createItem(s)))continue;if(!this._includeDepend&&t.detail.depend)break;this._flattenedTree.push(t),e&&t.children.push(e)}e=t,i=s,s=(0,path_1.dirname)(s)}}},hasNeedToDepend(e){for(const t of this._databaseAssets)if(e.includes(t.file))return!1;return!0},_addDepend(e){var t,s=[];for(t of e)t=(0,utlis_1.trimDependUuid)(t),s.includes(t)||s.push(t),this._depends.includes(t)||this._depends.push(t);return s},async _depend(t){if(this.hasNeedToDepend(t)){let e=[];for(const i of(this._dependMap.path||[])[t]||[]){var s=await Editor.Message.request("asset-db","query-uuid",i);s&&e.push(s)}t=(this._dependMap.uuid||[])[t]||[];e=e.concat(t);for(const r of e=this._addDepend(e))await this._step(r)}},async getSourceAsset(e){return e=this.getUuid(e),Editor.Message.request("asset-db","query-asset-info",e)},async _step(e){try{var t=await this.getSourceAsset(e);if(t&&!t.url.startsWith("db://internal")&&!this._assetsMap.includes(e))if("database"===t.importer&&this._databaseAssets.push(t),await this._addAssetTree(t),t.isDirectory||"database"===t.importer){for(const i of(0,fs_1.readdirSync)(t.file))if(!i.endsWith(".meta")&&!i.endsWith(".DS_Store")){var s=t.path+"/"+i;const e=await Editor.Message.request("asset-db","query-uuid",s);await this._depend(t.file),e&&await this._step(e)}}else"cc.Script"===t.type?await this._dependTypescript(t):await this._dependUuid(t),await this._depend(t.file)}catch(e){console.log(e)}},async _dependUuid(e){let t="",s=[];switch(e.importer){case"terrain":t=(0,fs_1.readFileSync)(e.library[".json"],"utf8");break;case"fbx":case"gltf":var i=await this._dependGltfUuid(e);s=s.concat(i);break;default:t=(0,fs_1.readFileSync)(e.file,"utf-8")}s=(s=s.concat(t.match(/(?<=__uuid__": ")(.*)(?=")/g)||[])).concat(t.match(/(?<=uuid": ")(.*)(?=")/g)||[]);let r=[];for(const d of r=r.concat(t.match(/(?<=__type__": ")(.*)(?=")/g)||[])){var a=Editor.Utils.UUID.decompressUUID(d);a.startsWith("cc.")||s.push(a)}for(const n of s=this._addDepend(s))await this._step(n)},async _dependGltfUuid(e){var t=[],e=e.file+".meta",e=(0,fs_extra_1.readJSONSync)(e).userData;if(!e)return[];for(const s of e.assetFinder&&e.assetFinder.materials||[])t.includes(s)||t.push(s);for(const i of e.imageMetas||[]){let e;(e=i.uri.includes("/")?await Editor.Message.request("asset-db","query-uuid",i.uri):i.uri.split("@")[0])?t.includes(e)||t.push(e):console.log(`can not find uuid: ${e} by image uri: `+i.uri)}return t},async _dependTypescript(e){e=await(0,utlis_1.getDependScriptUuid)(e);for(const t of this._addDepend(e))await this._step(t)}};