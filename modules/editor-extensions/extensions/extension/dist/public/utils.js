"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.CancelError=exports.hasOwn=exports.isOnlineExtension=exports.sleep=exports.checkPackagePathType=exports.throttle=exports.formatDate=exports.recursive=exports.getPackageType=exports.handleUnexpectedImportError=exports.handleManualInstall=exports.handleInvalidPath=exports.handleCancelImport=exports.handleDecompressFail=exports.matchInternalName=exports.FAKE_AUTHOR_ID=exports.INTERNAL_EXTENSION_NAME=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),packageJson=require("../../package.json");function matchInternalName(e){return e===exports.INTERNAL_EXTENSION_NAME}async function handleDecompressFail(e,t,n){if((await Editor.Dialog.info(Editor.I18n.t("extension.menu.decompressFail"),{cancel:0,buttons:[Editor.I18n.t("extension.store.cancel"),Editor.I18n.t("extension.store.confirm")]})).response){var r=await Editor.Dialog.select({title:Editor.I18n.t("extension.menu.copyPackageTitle",{extensionName:t+".zip"}),type:"directory"});if(r.canceled){if(!n)throw new Error("cancel");handleCancelImport()}else if(r.filePaths[0]){r=(0,path_1.join)(r.filePaths[0],t+".zip");if(await Editor.Utils.File.copy(e,r),console.log(`[extension] copy ${t}.zip to `+r),!n)throw new Error("manual install");handleManualInstall()}}else{if(!n)throw new Error("cancel");handleCancelImport()}}function handleCancelImport(){Editor.Task.addNotice({title:Editor.I18n.t("extension.store.install_cancel"),type:"log",source:"extension",timeout:8e3})}function handleInvalidPath(e){Editor.Task.addNotice({title:Editor.I18n.t("extension.menu.invalidPath",{path:e}),type:"error",source:"extension",timeout:8e3})}function handleManualInstall(){console.log(Editor.I18n.t("extension.store.install_manual_guide",{url:Editor.App.urls.manual})),Editor.Task.addNotice({title:Editor.I18n.t("extension.store.install_manual_title"),message:Editor.I18n.t("extension.store.install_manual_content"),source:"extension",type:"warn"})}function handleUnexpectedImportError(e){Editor.Task.addNotice({title:Editor.I18n.t("extension.store.install_fail"),message:e?.message,type:"error",source:"extension",timeout:1e4})}function getPackageType(e){let t;return t=Editor.Utils.Path.contains(Editor.App.path,e)?"internal":Editor.Utils.Path.contains(Editor.Project.path,e)?"project":Editor.Utils.Path.contains(Editor.App.home,e)?"global":"develop"}function recursive(e,r){!function t(n){(0,fs_extra_1.existsSync)(n)&&((0,fs_extra_1.statSync)(n).isDirectory()?(0,fs_extra_1.readdirSync)(n).forEach(e=>{t((0,path_1.join)(n,e))}):r(n))}(e)}function formatDate(e,t){if(e){switch(t=t||"yyyy-MM-dd",typeof e){case"string":e=new Date(e.replace(/-/g,"/"));break;case"number":e=new Date(e)}if(e instanceof Date){const n={yyyy:e.getFullYear(),M:e.getMonth()+1,d:e.getDate(),H:e.getHours,m:e.getMinutes(),s:e.getSeconds(),MM:(""+(e.getMonth()+101)).substr(1),dd:(""+(e.getDate()+100)).substr(1),HH:(""+(e.getHours()+100)).substr(1),mm:(""+(e.getMinutes()+100)).substr(1),ss:(""+(e.getSeconds()+100)).substr(1)};return t.replace(/(yyyy|MM?|dd?|HH?|ss?|mm?)/g,function(...e){return n[e[0]]})}}}exports.INTERNAL_EXTENSION_NAME=packageJson.name,exports.FAKE_AUTHOR_ID=-1,exports.matchInternalName=matchInternalName,exports.handleDecompressFail=handleDecompressFail,exports.handleCancelImport=handleCancelImport,exports.handleInvalidPath=handleInvalidPath,exports.handleManualInstall=handleManualInstall,exports.handleUnexpectedImportError=handleUnexpectedImportError,exports.getPackageType=getPackageType,exports.recursive=recursive,exports.formatDate=formatDate;const throttle=(r,o,e=!1)=>{if(e){let n=0;return(...e)=>{var t=Date.now();t-n>=o&&(r.apply(this,e),n=t)}}{let t=null;return(...e)=>{t||(r.apply(this,e),t=window.setTimeout(()=>{t&&clearTimeout(t),t=null},o))}}};function checkPackagePathType(e){return Editor.Package.__protected__.checkType(e)}exports.throttle=throttle,exports.checkPackagePathType=checkPackagePathType;const sleep=(r=100)=>{let o=()=>{};var e=new Promise((e,t)=>{const n=window.setTimeout(()=>{e()},r);o=()=>{window.clearTimeout(n),t(new Error("cancel"))}});return e.abort=o,e};function isOnlineExtension(e){return"latest_version"in e}function hasOwn(e,t){return Object.prototype.hasOwnProperty.call(e,t)}exports.sleep=sleep,exports.isOnlineExtension=isOnlineExtension,exports.hasOwn=hasOwn;const cancelSymbol=Symbol.for("cancel");class CancelError extends Error{constructor(){super(...arguments),this[_a]=!0}static isCancel(e){return e instanceof Error&&!0===e[cancelSymbol]}}exports.CancelError=CancelError,_a=cancelSymbol;