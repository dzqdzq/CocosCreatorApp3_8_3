"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=exports.contributions=void 0;const requestProgress=require("request-progress"),request=require("request"),electron_1=require("electron"),fs_extra_1=require("fs-extra"),path_1=require("path"),semver_1=require("semver"),utils_1=require("../public/utils"),import_1=require("../public/import"),template_builder_1=require("./template-builder"),contribution_1=require("./contribution"),downloader_1=require("./downloader"),vscode_workflow_1=require("./vscode-workflow"),force_update_1=require("./force-update"),config_1=require("../shared/config");async function enable(e,t,o){var a;return o=o||{},!0===t?(a=await Editor.Package.enable(e),o.showInExtensionManager&&exports.methods.showInManager(e),o.addNotification&&await Editor.Task.addNotice({type:"log",message:e,title:Editor.I18n.t("extension.extension.enable")}),a):!1===t?(a=await Editor.Package.disable(e,o),o.showInExtensionManager&&exports.methods.showInManager(e),o.addNotification&&await Editor.Task.addNotice({type:"log",message:e,title:Editor.I18n.t("extension.extension.disable")}),a):void 0}async function load(){await(0,downloader_1.init)();var e=async()=>{await Editor.Network.testConnectServer()&&(0,force_update_1.forceUpdate)({selfUpdate:exports.methods.selfUpdate}).catch(e=>{console.error(e)})};Editor.Startup.__protected__.ready.package?e():Editor.Startup.__protected__.once("package-ready",e)}function unload(){}exports.contributions={enable(e,t){(0,contribution_1.register)(e.name,e.path,t)},disable(e,t){(0,contribution_1.unregister)(e.name)}},exports.methods={importPackage:import_1.importPackage,async importPackageByPath(o){for(let e=0,t=o.length;e<t;e++)await(0,import_1.importPackageByFolderPath)(o[e])},async showInManager(e){await Editor.Panel.has("extension.manager")?(await Editor.Message.request("extension","refresh-package",e),Editor.Message.send("extension","select-package",e)):Editor.Panel.open("extension.manager",e)},openManager(){Editor.Panel.open("extension.manager")},async openStore(){(0,semver_1.satisfies)((0,semver_1.valid)((0,semver_1.coerce)(process.env.COCOS_DASHBOARD_VERSION))||"",">= 1.1.0")?Editor.Message.send("program","open-url","cocos-dashboard://plugin/store/index"):-1!==(await Editor.Dialog.error(Editor.I18n.t("extension.store.dashboard_not_found"),{buttons:[Editor.I18n.t("extension.store.download_dashboard")],cancel:-1})).response&&Editor.Message.send("program","open-url","https://www.cocos.com/creator")},openCreate(){Editor.Panel.open("extension.create")},async addChromeDebugSetting(){(0,vscode_workflow_1.addChromeDebugSetting)()},async addCompileTask(){(0,vscode_workflow_1.addCompileTask)()},enable:enable,async remove(t){try{await Editor.Package.unregister(t),"develop"!==(0,utils_1.getPackageType)(t)&&await electron_1.shell.trashItem(t)}catch(e){Editor.Dialog.error(e+"",{title:Editor.I18n.t("extension.dialog.remove_failed")});try{await Editor.Package.register(t)}catch(e){console.error(e)}return console.error(e),!1}return!0},async reload(e){var t=Editor.Package.getPackages({path:e});t&&t[0]&&(t=t[0].enable,await enable(e,!1,{replacement:!1}),await Editor.Package.unregister(e),await Editor.Package.register(e),t)&&await enable(e,!0)},async scanning(e){var t=(0,config_1.getPathConfig)();let o="";if("project"===e?o=t.project:"global"===e&&(o=t.global),""!==o){await(0,fs_extra_1.ensureDir)(o);e=(await(0,fs_extra_1.readdir)(o)).map(e=>(0,path_1.join)(o,e));for(const a of(await Editor.Package.getPackages()).filter(e=>Editor.Utils.Path.contains(o,e.path)))(0,fs_extra_1.existsSync)(a.path)||(a.enable&&await enable(a.path,!1),await Editor.Package.unregister(a.path));for(const r of e)(await(0,fs_extra_1.stat)(r)).isDirectory()&&await Editor.Package.register(r);return!0}},async downloadItem(e){var t=(0,contribution_1.getInfoFromTypeID)(e.type_id);if((0,downloader_1.getDownloadInfo)(e.version_id,e.production_id))Editor.Dialog.warn(Editor.I18n.t("extension.store.download_exists_error"));else if(e.version_id&&e.production_id){const r=(0,downloader_1.generateDownloadItem)(e);(r.downloadProgress=0,downloader_1.pushDownloadList)(r),(0,downloader_1.onItemUpdate)(r);try{for(let e=0;e<t.length;e++){var o=t[e];if(o.module){var a=require(o.module);if(o.check)if(!1===await a.methods[o.check](r))continue;return a.methods[o.download]?await a.methods[o.download](r,()=>{(0,downloader_1.onItemUpdate)(r)}).catch(e=>{throw e}):await require(contribution_1.defaultDownloadTypeInfoMap.module).methods[contribution_1.defaultDownloadTypeInfoMap.download](r,()=>{(0,downloader_1.onItemUpdate)(r)}).catch(e=>{throw e}),r.downloadProgress=1,(0,downloader_1.onItemUpdate)(r),Editor.Task.addNotice({title:Editor.I18n.t("extension.store.download_successful"),type:"success",source:"extension",timeout:5e3}),r}}}catch(e){return"cancel"===e.message?Editor.Task.addNotice({title:Editor.I18n.t("extension.store.download_cancel"),message:e.message||e,type:"log",source:"extension",timeout:5e3}):Editor.Task.addNotice({title:Editor.I18n.t("extension.store.download_failed"),message:e.message||e,type:"error",source:"extension",timeout:5e3}),null}Editor.Task.addNotice({title:Editor.I18n.t("extension.store.download_failed"),type:"error",source:"extension",timeout:5e3})}else Editor.Dialog.warn("empty version id or prodduction id");return null},async installItem(e,t){const o=(0,downloader_1.getDownloadInfo)(e,t);if(o){var a=(0,contribution_1.getInfoFromTypeID)(o.type);(o.installProgress=0,downloader_1.onItemUpdate)(o);try{for(let e=0;e<a.length;e++){var r=a[e];if(r.module){var n=require(r.module);if(!r.check||!1!==await n.methods[r.check](o))return n.methods[r.install]?await n.methods[r.install](o,()=>{(0,downloader_1.onItemUpdate)(o)}).catch(e=>{throw e}):await require(contribution_1.defaultDownloadTypeInfoMap.module).methods[contribution_1.defaultDownloadTypeInfoMap.install](o,()=>{(0,downloader_1.onItemUpdate)(o)}).catch(e=>{throw e}),o.installProgress=1,(0,downloader_1.onItemUpdate)(o),Editor.Task.addNotice({title:Editor.I18n.t("extension.store.install_successful"),type:"success",source:"extension",timeout:8e3}),Editor.Dialog.info(Editor.I18n.t("extension.store.install_successful"),{buttons:[Editor.I18n.t("extension.store.confirm")]}),o}}}catch(e){return"cancel"===e.message?(0,utils_1.handleCancelImport)():"manual install"===e.message?(0,utils_1.handleManualInstall)():(0,utils_1.handleUnexpectedImportError)(e),null}(0,utils_1.handleUnexpectedImportError)()}return null},async removeItem(e,t){return(0,downloader_1.removeDownloadItem)(e,t)},async removeAllItem(){return(0,downloader_1.removeDownloadList)()},async queryDownloaderList(){return downloader_1.downloadList},async updateExtension(e,t,o="local"){e=encodeURI(e);const a=(0,path_1.join)(Editor.Project.tmpDir,"extension/download",t+".zip");await(0,fs_extra_1.ensureDir)((0,path_1.dirname)(a)),await new Promise((o,t)=>{requestProgress(request(e),{delay:300}).on("progreass",function(e){}).on("error",function(e){t(e)}).on("end",function(e,t){o(null)}).pipe((0,fs_extra_1.createWriteStream)(a))});let r="",n="";r="local"===o?(n="project",(0,path_1.join)(Editor.Project.path,"extensions",t)):(n="global",(0,path_1.join)(Editor.App.home,"extensions",t));var i=(0,path_1.basename)(r,".zip");try{await(0,import_1.importPackage)(n,a,{forceImport:!0}),await enable(r,!0)}catch(e){switch(e.message){case import_1.ImportPackageErrorMessage.cancel:(0,utils_1.handleCancelImport)();break;case import_1.ImportPackageErrorMessage.decompressFail:(0,utils_1.handleDecompressFail)(r,i,!0);break;case import_1.ImportPackageErrorMessage.invalidPath:(0,utils_1.handleInvalidPath)(r);break;default:(0,utils_1.handleUnexpectedImportError)(e)}}await(0,fs_extra_1.remove)(a)},getExtensionInfoMap(){return(0,contribution_1.getExtensionInfoMap)()},createExtensionTemplate(e,t=!0){return(0,template_builder_1.createExtensionTemplate)(e,t)},trashItem(e){return electron_1.shell.trashItem(e)},async selfUpdate(e){const{builtInPath:t,currentPath:o,newInstallPath:a}=e;var{sdk:r,extensionPaths:n}=await(0,force_update_1.setupContext)();if(await enable(o,!1),o!==t&&await Editor.Package.unregister(o),a!==t&&await Editor.Package.register(a),""!==t&&a===t)try{await r.uninstall(utils_1.INTERNAL_EXTENSION_NAME,n.global)}catch(e){console.error(e)}await enable(a,!0),await(!1===e.reopenPanel||!setTimeout(()=>{Editor.Panel.open("extension.manager")},500))}},exports.load=load,exports.unload=unload;