"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createExtensionTemplate=void 0;const electron_1=require("electron"),contribution_1=require("./contribution"),utils_build_1=require("../public/utils-build"),path_1=require("path"),fs_extra_1=require("fs-extra"),createExtensionTemplate=async(e,t)=>{const{type:s,templateId:i}=e;var r=(0,contribution_1.getExtensionInfoMap)(),a={success:!1,msg:"",stack:""};if(!Reflect.has(r,s)||!r[s]?.templates)return a.success=!1,a.msg=`template type ${s} is not found`,a;r=r[s].templates?.find(e=>e.id===i);if(!r||!r.creator)return a.success=!1,a.msg=`template ${i} is not valid`,a;var o=e.author||await(0,utils_build_1.getAuthor)(),n=e.name||(0,utils_build_1.getFallbackExtensionName)();if((0,utils_build_1.isExtensionNameError)(n))return a.success=!1,a.msg=`name ${n} is not valid`,a;var c=e.editorVersion||(0,utils_build_1.getEditorVersion)();if((0,utils_build_1.isEditorVersionError)(c))return a.success=!1,a.msg=`editor version limit ${c} is not valid`,a;try{var l=(0,path_1.normalize)(r.creator),d=!!require.cache[l],p=require(l),u=(!d&&p.load&&p.load(),{baseTemplate:(0,path_1.join)(__dirname,"../../static/extension-template/template"),dist:e.dist||(0,utils_build_1.getExtensionDist)(n)});await Editor.Utils.File.copy(u.baseTemplate,u.dist),await Editor.Utils.File.copy(r.path,u.dist);try{var m,_=(0,path_1.join)(u.dist,"package.json"),g=await(0,fs_extra_1.readJSON)(_);const f={$schema:"./@types/schema/package/index.json",package_version:2,name:n,version:"1.0.0",author:o||"Cocos Creator Developer",editor:c,scripts:{preinstall:"node ./scripts/preinstall.js",build:"tsc"}};for(const E in g)f[E]=f[E]||g[E];if(g.scripts)for(const v in g.scripts)f.scripts[v]=g.scripts[v];if(!r.path)throw m=Editor.I18n.t("extension.create_package.no_path_warning",{template:r.name}),new Error(m);await p.methods.create({author:o,name:n,dist:u.dist,editorVersion:c,template:r},f);const x=f.devDependencies||{};x["@cocos/creator-types"]="^"+Editor.App.version,x["@types/node"]="^18.17.1",f.devDependencies={},Object.keys(x).sort().forEach(e=>{f.devDependencies[e]=x[e]}),await(0,fs_extra_1.outputJSON)(_,f,{spaces:4});var h=(0,path_1.join)(u.dist,"node_modules");await(0,fs_extra_1.ensureDir)(h),await Editor.Message.request("utils","export-dts",h,!1),a.success=!0}catch(e){return a.success=!1,e instanceof Error?(a.msg=e.message,a.stack=e.stack||""):a.msg="create extension template fail",a}return a.success?(t&&await Editor.Package.register(u.dist),e.showInFolder&&e.dist&&electron_1.shell.showItemInFolder(e.dist)):a.msg="create extension template fail",a}catch(e){return e instanceof Error?(a.msg=e.message,a.stack=e.stack||""):a.msg="create extension template fail",a.success=!1,a}};exports.createExtensionTemplate=createExtensionTemplate;