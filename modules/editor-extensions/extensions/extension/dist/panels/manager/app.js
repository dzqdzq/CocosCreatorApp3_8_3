"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a);var n=Object.getOwnPropertyDescriptor(t,a);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,i,n)}:function(e,t,a,i){e[i=void 0===i?a:i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PanelApp=exports.updateExtensionOption=void 0;const fs_1=require("fs"),path_1=__importStar(require("path")),vue_js_1=require("vue/dist/vue.js"),semver_1=__importDefault(require("semver")),lodash_1=require("lodash"),pkg_node_1=__importDefault(require("./pkg-node")),detail_1=__importDefault(require("./detail")),pkg_list_1=__importDefault(require("./pkg-list")),pkg_search_list_1=require("./pkg-search-list"),components_1=require("../components"),sdk_1=require("./sdk"),store_1=require("./store"),event_bus_1=require("./event-bus"),utils_1=require("../../public/utils"),utils_dom_1=require("../../public/utils-dom"),import_1=require("../../public/import"),interface_1=require("../../public/interface"),profile_1=require("../../shared/profile"),template=(exports.updateExtensionOption={isReRegister:!1,path:""},`
    <div
        ref="containerEl"
        class="extension"
        @dragover="onAppDragover"
        @dragleave="onAppDragleave"
        @dragend="onAppDragend"
        @drop="onAppDrop"
    >
        <!-- <div class="extension-layout"> -->
        <div class="list-layout">
            <header class="header" v-show="!isShowSearching">
                <div class="entry-tabs">
                    <tab-dropdown
                        v-for="(tab, index) in tabs"
                        :key="tab.id"
                        :active-label="active"
                        :label="tab.label"
                        :children="tab.children"
                        @select="onTabSelect"
                    ></tab-dropdown>
                </div>
                <div class="feature">
                    <ui-button
                        class="transparent feature-col feature-btn"
                        tooltip="i18n:extension.manager.search_extensions"
                        @click="switchSearchStatus()"
                    >
                        <ui-icon value="search"></ui-icon>
                    </ui-button>

                    <CustomDropdown class="button-group feature-col" size="mini">
                        <ui-button
                            class="transparent feature-btn"
                            tooltip="i18n:extension.manager.import_extensions_zip"
                            @click.stop="install()"
                        >
                            <ui-icon value="import"></ui-icon>
                        </ui-button>

                        <template #overlay>
                            <CustomDropdownItem @click="installPkgFolder()">
                                {{ t('import_extensions_folder') }}
                            </CustomDropdownItem>

                            <CustomDropdownItem @click="installPkgDev()">
                                {{ t('import_extensions_dev') }}
                            </CustomDropdownItem>
                        </template>
                    </CustomDropdown>

                    <ui-button
                        class="transparent feature-col feature-btn"
                        tooltip="i18n:extension.manager.refresh_extensions"
                        @click.stop="refreshList()"
                    >
                        <ui-icon value="refresh"></ui-icon>
                    </ui-button>
                </div>
            </header>
            <header class="header" v-show="isShowSearching">
                <div class="search">
                    <ui-input
                        show-clear
                        ref="search"
                        placeholder="i18n:extension.manager.search"
                        @change="doSearch($event)"
                        @blur="onSearchBlur"
                        :value="searchKey"
                    >
                    </ui-input>
                    <ui-button
                        class="transparent"
                        tooltip="i18n:extension.manager.exit_search"
                        @click.stop="switchSearchStatus()"
                    >
                        <ui-label value="i18n:extension.manager.cancel"></ui-label>
                    </ui-button>
                </div>
            </header>
            <div
                v-show="!isShowSearching && active === item.label"
                v-for="item of flatTabs"
                :key="item.label"
                class="list"
            >
                <pkg-list
                    :ref="item.label"
                    :label="item.label"
                    :active="!isShowSearching && active === item.label"
                    @refresh="refreshList"
                    :page-size="pageSize"
                    :choosed="currentPackage ? currentPackage.name : ''"
                    @update-list="updateList"
                    @choose="choose"
                    @update-package="updatePackage"
                    @remove-package="removePackage"
                    @uninstall-package="uninstallPackage"
                    @set-enable="setEnable"
                >
                </pkg-list>
            </div>
            <div class="list" v-show="isShowSearching">
                <pkg-search-list
                    ref="search_list"
                    label="search_list"
                    :is-search="true"
                    :active="isShowSearching"
                    @refresh="refreshList"
                    :search-key="searchKey"
                    :page-size="pageSize"
                    :choosed="currentPackage ? currentPackage.name : ''"
                    @update-list="updateList"
                    @choose="choose"
                    @update-package="updatePackage"
                    @remove-package="removePackage"
                    @uninstall-package="uninstallPackage"
                    @set-enable="setEnable"
                >
                </pkg-search-list>
            </div>
        </div>
        <div class="detail-layout">
            <pkg-detail
                :detail="currentPackageDetail"
                :info="currentPackage"
                :loading="getDetailLoading"
                :error-message="detailErrorMessage"
                @refresh="refreshDetail"
            ></pkg-detail>
        </div>
        <!-- </div> -->
        <div class="import-loading-layout" v-if="importLoading">
            <ui-loading></ui-loading>
            <ui-label v-if="importErrorMessage" value="i18n:extension.manager.import_error_tip"> </ui-label>
            <div v-if="importErrorMessage">
                <ui-button class="transparent" @click="cancelRetryImport">
                    <ui-label value="i18n:extension.manager.cancel"></ui-label>
                </ui-button>
                <ui-button @click="retryImport">
                    <ui-label value="i18n:extension.manager.retry"></ui-label>
                </ui-button>
            </div>
        </div>

        <div v-show="zipDraggingOver" class="file-drop-layer">
            <div class="file-drop-layer__tip">
                <ui-icon value="extension"></ui-icon>
                <ui-label value="i18n:extension.manager.drop_to_import_tip" class=""></ui-label>
            </div>
        </div>
        <!-- <custom-dialog v-if="extensionDependencies" :info="extensionDependencies" @cancel="dialogCancel"
        @confirm="dialogConfirm"></custom-dialog> -->
    </div>
`);function useFileDrop(a,i){const n=(0,vue_js_1.ref)(!1);return{draggingOver:n,onAppDragenter:function(e){n.value=!1},onAppDragend:function(e){n.value=!1},onAppDragleave:function(e){var t=a.value&&(0,utils_dom_1.containsEventTarget)(a.value,e),e=null==e.relatedTarget;t&&e&&(n.value=!1)},onAppDragover:function(e){e.dataTransfer&&(n.value=!0,e.preventDefault(),0<Array.from(e.dataTransfer.items??[]).filter(e=>"file"===e.kind).length?e.dataTransfer.dropEffect="copy":e.dataTransfer.dropEffect="none")},onAppDrop:function(e){n.value=!1;var t=Array.from(e.dataTransfer?.items??[]);if(e.dataTransfer&&!(t.length<1)){e=t[0];if("file"===e.kind){t=e.getAsFile();if(null!=t&&t.path.endsWith(".zip")){if(!(0,fs_1.existsSync)(t.path))throw e=Editor.I18n.t("extension.manager.drop_to_import_file_not_exists",{path:t.path}),Editor.Dialog.info(e,{title:Editor.I18n.t("extension.title"),buttons:[Editor.I18n.t("extension.manager.confirm")]}),new Error(e);try{i(t.path)}catch(e){console.error(e)}}else Editor.Dialog.info(Editor.I18n.t("extension.manager.drop_to_import_requires_zip"),{title:Editor.I18n.t("extension.title"),buttons:[Editor.I18n.t("extension.manager.confirm")]})}}}}}exports.PanelApp=(0,vue_js_1.defineComponent)({name:"ExtensionManager",components:{"pkg-node":pkg_node_1.default,"pkg-detail":detail_1.default,"pkg-list":pkg_list_1.default,PkgSearchList:pkg_search_list_1.PackageSearchList,"custom-dialog":components_1.CustomDialog,TabDropdown:components_1.TabDropdown,CustomDropdown:components_1.CustomDropdown,CustomDropdownItem:components_1.CustomDropdownItem},setup(e,t){var a=(0,vue_js_1.getCurrentInstance)(),i=(0,vue_js_1.ref)(),{extensionPaths:n,sdk:s}=(0,sdk_1.useInjectSdk)(),r=(0,store_1.useInjectStore)(),{draggingOver:a,onAppDragend:o,onAppDragleave:l,onAppDragover:c,onAppDrop:h}=useFileDrop(i,(a?.proxy).install);return{containerEl:i,extensionPaths:n,sdk:s,store:r,zipDraggingOver:a,onAppDragend:o,onAppDragleave:l,onAppDragover:c,onAppDrop:h}},data(){return{tabs:[{label:interface_1.ExtensionManagerTab.Cocos,id:1,children:[{label:interface_1.ExtensionManagerTab.Cocos},{label:interface_1.ExtensionManagerTab.BuiltIn}]},{label:interface_1.ExtensionManagerTab.Installed,id:3}],flatTabs:[],active:interface_1.ExtensionManagerTab.BuiltIn,currentPackage:null,currentPackageDetail:null,detailErrorMessage:"",isShowSearching:!1,page:1,pageSize:99999,sourceList:[],getDetailLoading:!1,searchKey:"",searchTimestamp:-1,searchThrottle:null,installedList:[],allPackages:[],extensionDependenciesList:[],extensionDependencies:null,importErrorMessage:"",importLoading:!1,importPathCache:""}},watch:{extensionDependencies(e){!e&&0<this.extensionDependenciesList.length&&(this.extensionDependencies=this.extensionDependenciesList.shift())}},created(){Editor.Package.__protected__.on("enable",this.toggleEnableHandle),Editor.Package.__protected__.on("disable",this.toggleEnableHandle),Editor.Message.__protected__.addBroadcastListener("i18n:change",this.onI18nChange)},mounted(){this.handleFlatTabs(),this.init();var e=this.store.startupParams.value;"string"==typeof e.search&&this.onSearchEvent(e.search),this.$root.$on(event_bus_1.INTERNAL_EVENTS.search,this.onSearchEvent)},beforeDestroy(){Editor.Package.__protected__.removeListener("enable",this.toggleEnableHandle),Editor.Package.__protected__.removeListener("disable",this.toggleEnableHandle),this.$root.$off(event_bus_1.INTERNAL_EVENTS.search,this.onSearchEvent),Editor.Message.__protected__.removeBroadcastListener("i18n:change",this.onI18nChange)},methods:{t(e,t){return Editor.I18n.getLanguage,Editor.I18n.t("extension.manager."+e,t)},curLanguage(){return Editor.I18n.getLanguage()},onI18nChange(){this.refreshList()},async init(){this.installedList=await this.scanLocal(),this.active=this.tabs[0].label,this.searchThrottle=(0,lodash_1.throttle)(this.handleSearch,300,{leading:!0,trailing:!0})},handleFlatTabs(){const a=new Map,e=[];this.tabs.forEach(t=>{e.push({label:t.label}),t.children&&t.children.forEach(e=>{e.label!==t.label&&a.set(e.label,{label:e.label})})}),a.forEach(t=>{e.find(e=>e.label===t.label)||e.push({label:t.label})}),this.flatTabs=e},async choose(e){null==e?this.clearCurrentDetail():(!e||this.currentPackage)&&this.currentPackageDetail&&e.name===this.currentPackage?.name&&e.version===this.currentPackage.version&&e.version===this.currentPackageDetail.version||this.getPackageDetail(e)},clearCurrentDetail(){this.currentPackage=null,this.currentPackageDetail=null,this.detailErrorMessage="",this.getDetailLoading=!1},getPackageDetail(e){this.getDetailLoading=!0,this.currentPackage={...e},this.currentPackageDetail=null,this.detailErrorMessage="";var t={name:e.name,version:e.version,lang:this.curLanguage()};return this.sdk.getExtensionDetail(t).then(t=>{if(t&&"string"==typeof t.name)this.currentPackage&&(this.currentPackageDetail={name:t.name,version:t.version,publish_at:t.publish_at,version_limit:t.editor_limit,detail:t.detail,size:t.size,icon_url:t.icon_url});else{if(""!==e.path)return this.sdk.queryLocalExtensionDetail(e.path,this.curLanguage()).then(e=>{e&&"string"==typeof e.name?this.currentPackage&&(this.currentPackageDetail={author:{id:utils_1.FAKE_AUTHOR_ID,name:e.author},name:e.name,version:e.version,publish_at:0,version_limit:e.editor_limit,detail:e.detail,size:t.size,icon_url:t.icon_url},this.currentPackage.version=e.version):(this.clearCurrentDetail(),this.detailErrorMessage=this.t("detail_error_tip"))}).catch(e=>{throw this.clearCurrentDetail(),this.detailErrorMessage=this.t("network_error_tip"),e});this.currentPackage&&(this.currentPackageDetail={name:e.name,version:e.version,publish_at:0,version_limit:"",detail:"",size:0,icon_url:e.icon_url},this.currentPackage.version=e.version)}}).catch(e=>{throw this.detailErrorMessage=this.t("network_error_tip"),e}).finally(()=>{this.getDetailLoading=!1})},async setEnable(e,t,a){try{return t?await Editor.Package.enable(a):await Editor.Package.disable(a,{}),!0}catch(e){return console.error(e),Editor.Dialog.error(this.t(t?"disable_error_tip":"enable_error_tip")),!1}},toggleEnableHandle(t){[...this.flatTabs,{label:interface_1.ExtensionManagerTab.Search}].forEach(e=>{e=this.$refs[e.label];e&&(e.length?e[0]:e).toggleEnableHandle(t)})},refreshDetail(){this.currentPackage&&this.getPackageDetail(this.currentPackage)},onTabSelect(e){this.active=e},switchSearchStatus(e){this.isShowSearching="boolean"==typeof e?e:!this.isShowSearching,this.searchKey="",this.isShowSearching?(this.clearCurrentDetail(),this.$nextTick(()=>{this.$refs.search.focus()})):((e=this.$refs[interface_1.ExtensionManagerTab.Search]).length?e[0]:e).reset()},formatInstalledExtension(t){var e=this.allPackages.find(e=>e.name===t.name&&"local"===this.checkPathType(e.path)),a={name:t.name,version:t.version,icon_url:t.icon_url,description:t.description,enable:!!e&&e.enable,isInstalled:!0,state:"none",progress:0,path:t.extension_path,isBuiltIn:!1,isCocosSource:!1};e?.info.author&&(a.author={id:utils_1.FAKE_AUTHOR_ID,name:e.info.author});try{var i=(0,fs_1.statSync)(t.extension_path);i&&"number"==typeof i.mtimeMs&&(a.mtime=i.mtimeMs)}catch(e){}return a},formatNetExtension(e){var t=!(!e.label||!e.label.length)&&-1<e.label.findIndex(e=>e===interface_1.ExtensionManagerTab.BuiltIn);let a=void 0,i=void 0,n=void 0,s=void 0;for(const r of this.allPackages)if(r.name===e.name){switch(this.checkPathType(r.path)){case"builtin":null==a&&(a=r);break;case"cover":null==i&&(i=r),r.enable&&null==n&&(n=r);break;case"local":null==s&&(s=r)}if(null!=a&&null!=i&&null!=s&&null!=n)break}const r=(t=t||null!=a||null!=i)?a:s;t={name:e.name,version:r?r.version:e.latest_version,icon_url:e.icon_url,description:e.description,enable:r?.enable??!1,isInstalled:!!r,latest_version:e.latest_version,latest_description:e.latest_description,update_at:e.update_at,state:"none",progress:0,path:r?r.path:"",isBuiltIn:t,isCocosSource:!0};return t.isBuiltIn&&(t.builtInPath=t.path,t.builtInVersion=t.version,null!=n?(t.version=n.version,t.path=n.path,t.enable=n.enable):null!=i&&!0!==t.enable&&(t.version=i.version,t.path=i.path,t.enable=i.enable)),t},mergeBuiltInExtension(e){const a=e.map(e=>this.formatNetExtension(e));var e=this.allPackages.filter(t=>!a.find(e=>e.name===t.name)&&"builtin"===this.checkPathType(t.path)),t=this.allPackages.filter(t=>!a.find(e=>e.name===t.name)&&"cover"===this.checkPathType(t.path));return e.forEach(e=>{a.push({name:e.name,version:e.version,icon_url:"",description:e.info.description??"",enable:e.enable,isInstalled:!0,state:"none",progress:0,path:e.path,isBuiltIn:!0,isCocosSource:!0})}),t.forEach(t=>{var e=a.findIndex(e=>e.name===t.name);e<0?a.push({name:t.name,version:t.version,icon_url:"",description:t.info.description??"",enable:t.enable,isInstalled:!0,state:"none",progress:0,path:t.path,isBuiltIn:!0,isCocosSource:!1}):!0===t.enable&&(a[e].builtInPath=a[e].path,a[e].builtInVersion=a[e].version,a[e].version=t.version,a[e].path=t.path,a[e].enable=t.enable)}),a},doSearch(e){e=e?.target?.value??"";e!==this.searchKey&&this.searchThrottle&&this.searchThrottle(e)},onSearchBlur(e){""===this.searchKey&&this.switchSearchStatus(!1)},handleSearch(e){var t=this.$refs[interface_1.ExtensionManagerTab.Search];(t.length?t[0]:t).reset(),this.clearCurrentDetail(),(this.searchKey=e)&&(this.page=1,this.updateSearchExtensions(this.searchKey,this.page,this.pageSize))},onSearchEvent(e){!1===e?this.switchSearchStatus(!1):!0!==e&&"string"!=typeof e||(this.switchSearchStatus(!0),this.handleSearch(!0===e?"":e))},async updateSearchExtensions(e,t,a){const i=Date.now(),n=(this.searchTimestamp=i,new RegExp((0,lodash_1.escapeRegExp)(e)));var s=this.$refs[interface_1.ExtensionManagerTab.Search];const r={e:Editor.App.version,q:e,lang:this.curLanguage(),page:t,pageSize:a,label:[interface_1.ExtensionManagerTab.Cocos,interface_1.ExtensionManagerTab.BuiltIn].join(",")};s.loading=!0;let o=[];try{o=await Promise.all([...[interface_1.ExtensionManagerTab.BuiltIn,interface_1.ExtensionManagerTab.Cocos].map(async t=>{try{var e=await this.sdk.getExtensionList({...r,label:t});if(this.searchTimestamp!==i)throw new utils_1.CancelError("timestamp cancel");return{key:t,label:t,list:t===interface_1.ExtensionManagerTab.BuiltIn?this.mergeBuiltInExtension(e.packages).filter(e=>n.test(e.name)):e.packages.map(this.formatNetExtension),total:e.count}}catch(e){if(utils_1.CancelError.isCancel(e))throw e;return console.error(e),{key:t,label:t,list:[],total:0}}})])}catch(e){if(utils_1.CancelError.isCancel(e))return;console.error(e)}try{var l=this.installedList.filter(e=>n.test(e.name));o.push({key:interface_1.ExtensionManagerTab.Installed,label:interface_1.ExtensionManagerTab.Installed,list:l,total:l.length}),s.batchUpdateList(o.reduce((e,t)=>(e[t.key]=t,e),{}))}finally{s.loading=!1}},async updateList(e,t,a){var i=this.isShowSearching?interface_1.ExtensionManagerTab.Search:e;i===interface_1.ExtensionManagerTab.Installed?this.updateLocationExtensions():i===interface_1.ExtensionManagerTab.Search?(await this.refreshAllPackages(),await this.updateSearchExtensions(this.searchKey,1,this.pageSize)):(await this.refreshAllPackages(),this.updateExtensions(e,this.searchKey,t,a))},async refreshList(){var e=this.isShowSearching?interface_1.ExtensionManagerTab.Search:this.active,t=this.$refs[e];function a(e){return Editor.Message.request("extension","scanning",e)}t&&(await a("global"),await a("project"),t=t.length?t[0]:t,e===interface_1.ExtensionManagerTab.Installed?await this.updateLocationExtensions():e===interface_1.ExtensionManagerTab.Search?(t.reset(),await this.refreshAllPackages(),await this.updateSearchExtensions(this.searchKey,1,this.pageSize)):(t.reset(),await this.refreshAllPackages(),await this.updateExtensions(e,this.searchKey,1,this.pageSize)))},async updateExtensions(a,e,t,i){var n=this.$refs[a];if(n&&a!==interface_1.ExtensionManagerTab.Search){const r=n.length?n[0]:n;r.loading=!0,1===t&&this.clearCurrentDetail();var s={e:Editor.App.version,q:e,lang:this.curLanguage(),page:t,pageSize:i,label:""};switch(a){case interface_1.ExtensionManagerTab.Installed:case interface_1.ExtensionManagerTab.Purchased:case interface_1.ExtensionManagerTab.Search:break;default:s.label=a}return this.sdk.getExtensionList(s).then(e=>{var t=a===interface_1.ExtensionManagerTab.BuiltIn?this.mergeBuiltInExtension(e.packages):e.packages.map(e=>this.formatNetExtension(e));r.updateList(t,e.count)}).catch(e=>{throw this.clearCurrentDetail(),this.isShowSearching||a===interface_1.ExtensionManagerTab.Purchased||a===interface_1.ExtensionManagerTab.Cocos?r.setError(this.t("network_error_tip")):r.setError(this.t("local_error_tip")),e}).finally(()=>{r.loading=!1})}},async updateLocationExtensions(){var e,t=this.$refs[interface_1.ExtensionManagerTab.Installed];t&&((t=t.length?t[0]:t).reset(),t.loading=!0,this.clearCurrentDetail(),e=await this.scanLocal(),this.installedList=e,t.updateList(e,e.length),this.handleListUpdate(e,interface_1.ExtensionManagerTab.Installed),t.loading=!1)},handleListUpdate(t,a){[...this.flatTabs,{label:interface_1.ExtensionManagerTab.Search}].filter(e=>e.label!==a).forEach(e=>{e=this.$refs[e.label];e&&(e.length?e[0]:e).handleListUpdate(t)})},async refreshAllPackages(){this.allPackages=Editor.Package.getPackages()},async scanLocal(){var e=await this.sdk.scanLocalExtensions();await(0,utils_1.sleep)(100),await this.refreshAllPackages();const a=[];return e.forEach(t=>{0<this.allPackages.filter(e=>e.name===t.name&&"string"==typeof e.path&&"local"===this.checkPathType(e.path)).length&&a.push(this.formatInstalledExtension(t))}),a.sort((e,t)=>("number"==typeof t.mtime?t.mtime:0)-("number"==typeof e.mtime?e.mtime:0)),a},checkPathType(e){return Editor.Package.__protected__.checkType(e)},updatePackage(e,t,a){a.isInstalled&&semver_1.default.eq(t,a.version)||(a.isBuiltIn&&"string"==typeof a.builtInVersion&&semver_1.default.eq(t,a.builtInVersion)?this.resetBuiltInVersion(a):this.download(e,t,a))},addInstalledPackage(e){var t=this.$refs[interface_1.ExtensionManagerTab.Installed];t&&(t.length?t[0]:t).addPackage(e)},async resetBuiltInVersion(e){if(e&&e.builtInPath&&e.builtInVersion){var t=async()=>{try{await this.sdk.uninstall(e.name,this.extensionPaths.global)}catch(e){console.error(e)}};if((0,utils_1.matchInternalName)(e.name)){if(0===(await Editor.Dialog.warn(this.t("update_extension_tip"),{buttons:[this.t("confirm"),this.t("cancel")],default:0,cancel:1,title:Editor.I18n.t("assets.operate.dialogQuestion")})).response)return void Editor.Message.send("extension","self-update",{currentPath:e.path,newInstallPath:e.builtInPath,builtInPath:e.builtInPath});exports.updateExtensionOption.isReRegister=!0,exports.updateExtensionOption.path=e.builtInPath,this.updateDownloadStatus(e.name,null,{version:e.version,path:e.path},null)}else await this.setEnable(e.name,!1,e.path),await Editor.Package.unregister(e.path),await t(),await this.setEnable(e.name,!0,e.builtInPath),this.updateDownloadStatus(e.name,null,{version:e.builtInVersion,path:e.builtInPath},null),e.path=e.builtInPath,e.version=e.builtInVersion,this.choose(e);this.installedList=await this.scanLocal()}},download(a,i,n){var e=this.extensionPaths,e=n.isBuiltIn?e.global:e.project;return this.sdk.getDownloader({name:a,version:i,installPath:e},{downloadProgress:e=>{e=Math.floor(100*e),this.updateDownloadStatus(a,null,null,e)},perDownloaded:async e=>{if(n.isBuiltIn)if((0,utils_1.matchInternalName)(n.name)){const t=e.installPkgPath??path_1.default.resolve(e.installPath,e.name);(0,fs_1.existsSync)(t)&&this.allPackages.find(e=>e.path===t)&&(await this.setEnable(n.name,!1,t),await Editor.Package.unregister(t))}else await this.setEnable(n.name,!1,n.path),n.path!==n.builtInPath&&await Editor.Package.unregister(n.path);else n.isInstalled&&""!==n.path&&(await this.setEnable(n.name,!1,n.path),await Editor.Package.unregister(n.path))},perInstalled:async e=>{var t={...n};try{if("string"!=typeof e.tempPath||""===e.tempPath)throw new Error(`invalid info.tempPath: "${e.tempPath}"`);if((0,utils_1.matchInternalName)(a)){if(0===(await Editor.Dialog.warn(this.t("update_extension_tip"),{buttons:[this.t("confirm"),this.t("cancel")],default:0,cancel:1,title:Editor.I18n.t("assets.operate.dialogQuestion")})).response)return void Editor.Message.send("extension","self-update",{currentPath:n.path,newInstallPath:e.tempPath,builtInPath:n.builtInPath});exports.updateExtensionOption.isReRegister=!0,exports.updateExtensionOption.path=e.tempPath,this.updateDownloadStatus(a,null,{version:n.version,path:n.path},null)}else n.isBuiltIn||!n.isCocosSource||n.path||(t.isInstalled=!0,t.enable=!0),await Editor.Package.register(e.tempPath),await this.setEnable(a,!0,e.tempPath),t.version=i,t.path=e.tempPath,this.updateDownloadStatus(a,null,{version:i,path:e.tempPath},null);this.choose(t),this.updateLocationExtensions()}catch(e){console.error(e),this.updateDownloadStatus(a,this.t("install_error_tip"),null,null),Editor.Dialog.error(this.t("install_error_tip"))}},downloaded:async e=>{const t={name:a,dependencies:[]};e.forEach(e=>{t.dependencies.push({name:e.name,desc:"",checked:!1,disable:!1,version:e.version})}),this.openDialog(t)}}).download().catch(e=>{throw Editor.Dialog.error(this.t("install_error_tip")),this.updateDownloadStatus(a,this.t("install_error_tip"),null,null),e})},updateDownloadStatus(t,a,i,n){[...this.flatTabs,{label:interface_1.ExtensionManagerTab.Search}].forEach(e=>{e=this.$refs[e.label];e&&(e.length?e[0]:e).updateDownloadStatus(t,a,i,n)})},updateUninstallStatus(s,i,r,o){[...this.flatTabs,{label:interface_1.ExtensionManagerTab.Search}].forEach(e=>{var t=this.$refs[e.label];if(t){var a=t.length?t[0]:t;if(r){const n=this.allPackages.find(e=>{var t=this.checkPathType(e.path);return e.name===s.name&&("builtin"===t||"cover"===t)});switch(e.label){case interface_1.ExtensionManagerTab.Cocos:s.isBuiltIn&&n?a.updateUninstallStatus(s.name,null,{path:n?.path,version:n.version},null):a.updateUninstallStatus(s.name,null,e=>{var t=s.path===e.path;return{path:t?"":e.path,version:t&&(0,utils_1.isOnlineExtension)(e)?e.latest_version:e.version}},null);break;case interface_1.ExtensionManagerTab.BuiltIn:a.updateUninstallStatus(s.name,null,e=>{var t=s.path===e.path;let a=e.path,i=e.version;return t&&(a=n?.path??"",i=n?.version??""),{path:a,version:i}},null);break;case interface_1.ExtensionManagerTab.Search:s.isCocosSource?a.updateUninstallStatus(s.name,null,e=>({path:"",version:(0,utils_1.isOnlineExtension)(e)?e.latest_version:e.version}),null):a.remove(s.name);break;case interface_1.ExtensionManagerTab.Installed:a.remove(s.name)}}else i?(a.updateUninstallStatus(s.name,i,r,o),Editor.Dialog.error(i)):a.updateDownloadStatus(s.name,i,r,o)}})},updateUninstallLoading(t,a){[...this.flatTabs,{label:interface_1.ExtensionManagerTab.Search}].forEach(e=>{e=this.$refs[e.label];e&&(e.length?e[0]:e).updateUninstallLoading(t,a)})},async uninstallPackage(t,e,a){var i=this.$refs[a];if(i){const n=i.length?i[0]:i;if(e.enable&&a!==interface_1.ExtensionManagerTab.BuiltIn){if(1===(await Editor.Dialog.warn(this.t("close_extensions_tip"),{buttons:[this.t("confirm"),this.t("cancel")],default:0,cancel:1,title:Editor.I18n.t("assets.operate.dialogQuestion")})).response)return void n.updateUninstallStatus(t,null,{path:e.path,version:e.version},null);await this.setEnable(t,!e.enable,e.path)}return this.clearCurrentDetail(),this.updateUninstallLoading(t,!0),await Editor.Package.unregister(e.path),this.sdk.uninstall(t,{uninstallProgress:e=>{e=Math.floor(100*e),n.updateUninstallStatus(t,null,null,e)},uninstalled:async()=>{(0,utils_1.matchInternalName)(t)&&"string"==typeof e.builtInPath&&""!==e.builtInPath&&await this.setEnable(t,!0,e.builtInPath),this.updateUninstallStatus(e,null,{path:"",version:""},null),this.installedList=await this.scanLocal()}}).catch(e=>{throw Editor.Dialog.error(this.t("uninstall_error_tip")),n.updateUninstallStatus(t,this.t("uninstall_error_tip"),null,null),e})}},removePackage(e){var t=this.isShowSearching?interface_1.ExtensionManagerTab.Search:this.active,t=this.$refs[t];if(t){const a=t.length?t[0]:t;return this.sdk.uninstall(e,{uninstalled:async()=>{a.remove(e)}}).catch(e=>{throw Editor.Dialog.error(this.t("remove_error_tip")),e})}},openDialog(e){if(!(e.dependencies.length<1)){let a="";e.dependencies.forEach((e,t)=>{a+=0<t?`、${e.name}@`+e.version:e.name}),Editor.Task.addNotice({title:e.name+" "+this.t("install_dependence_tip"),message:a,type:"warn",source:"extension",timeout:5e3})}},dialogCancel(){this.extensionDependencies=null},dialogConfirm(e){e.callback&&e.callback(),this.extensionDependencies=null},retryImport(){this.importErrorMessage="",this.install(this.importPathCache)},cancelRetryImport(){this.importErrorMessage="",this.importPathCache="",this.importLoading=!1},onPopupImportMore(){Editor.Menu.popup({menu:[{label:this.t("import_extensions_folder"),click:()=>{this.installPkgFolder()}},{label:this.t("import_extensions_dev"),click:()=>{this.installPkgDev()}}]})},async selectDirectoryFromDialog(e={}){var t,a=await profile_1.LastImportFolderPath.tryGet(),e=await Editor.Dialog.select({title:Editor.I18n.t("extension.menu.selectDirectory"),type:"directory",multi:!1,path:a??void 0,...e});return!Array.isArray(e.filePaths)||e.filePaths.length<1?"":(e=e.filePaths[0],(t=path_1.default.dirname(e))!==a&&await profile_1.LastImportFolderPath.trySet(t),e)},async install(t=""){if(!t){var a=await profile_1.LastImportFolderPath.tryGet(),a=await Editor.Dialog.select({title:Editor.I18n.t("extension.menu.selectZip"),filters:[{name:"ZIP",extensions:["zip"]}],path:a??void 0});if(!a||!a.filePaths[0])return;t=a.filePaths[0];a=path_1.default.dirname(t);await profile_1.LastImportFolderPath.trySet(a)}const i=(0,path_1.basename)(t,".zip");try{await this.installPkgTemplate({selectedPath:t,importHandler:async()=>(0,import_1.importPackage)("project",t,{extensionDisplayName:i})})}catch(e){if(!(e instanceof Error))throw e;a=e.message;if(a!==import_1.ImportPackageErrorMessage.decompressFail)throw e;(0,utils_1.handleDecompressFail)(t,i,!0)}},async installPkgTemplate(e){this.importLoading=!0,this.importErrorMessage="";var t=e["selectedPath"];try{const n=await e.importHandler();if(!n)throw new Error(`invalid imported package path: "${n}"`);this.importLoading=!1,this.importPathCache="",this.active=interface_1.ExtensionManagerTab.Installed,this.installedList=await this.scanLocal();var a=this.installedList.find(e=>e.path===n);if(!a)throw new Error("unexpted package import: cannot find in installed list");await this.setEnable(a.name,!0,n),this.refreshList(),this.choose(a)}catch(e){if(this.importLoading=!1,this.importErrorMessage=this.t("import_error_tip"),this.importPathCache=t,!(e instanceof Error))throw e;switch(e.message){case import_1.ImportPackageErrorMessage.cancel:this.cancelRetryImport(),(0,utils_1.handleCancelImport)();break;case import_1.ImportPackageErrorMessage.invalidPath:(0,utils_1.handleInvalidPath)(t);break;case import_1.ImportPackageErrorMessage.cannotFindPackageJson:var i=e.path;Editor.Task.addNotice({title:Editor.I18n.t("extension.menu.importError"),message:Editor.I18n.t("extension.menu.cannotFindPackageJson",{path:i}),type:"error",source:"extension",timeout:1e4});break;case import_1.ImportPackageErrorMessage.decompressFail:throw e;default:console.error(e),(0,utils_1.handleUnexpectedImportError)(e)}}},async installPkgFolder(e=""){!e&&""===(e=await this.selectDirectoryFromDialog())||await this.installPkgTemplate({selectedPath:e,importHandler:async()=>{return await(0,import_1.importPackageFolder)("project",e)}})},async installPkgDev(e=""){if(!e&&""===(e=await this.selectDirectoryFromDialog()))return"";await this.installPkgTemplate({importHandler:async()=>(0,import_1.importPackageSymlink)("project",e),selectedPath:e})}},template:template});