"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const events_1=require("events"),hermite_1=__importDefault(require("./hermite")),PIXEL_RANGE=20,UINT8_COLOR_DEFAULT=Array(4*PIXEL_RANGE*PIXEL_RANGE).fill(0).toString(),DEFAULT_CTRL_COLOR="rgba(255, 0, 0, 0.1)",CLICK_RANGE=5,Point=require("./utils")["Point"],mouseDownPoint={startX:0,startY:0};class CurveControl extends events_1.EventEmitter{get ctrlKey(){return this.hermite.ctrlKey}constructor(t){super(),this.changeType="",this.isShowCtrl=!1,this.isShowPoint=!1,this.isShowAuxin=!1,this.isBindHandle=!1,this.negative=!1,this.flags={flag:!1,tanDrag:!1,curveDrag:!1,keyDrag:!1},this.grid=t.grid,this.ctrlConfig=t.ctrlConfig,this.cxt2D=t.context,this.canvas=t.context.canvas,this.hermite=new hermite_1.default({context:t.mainCtx,ctrlConfig:t.ctrlConfig,grid:t.grid,curveConfig:t.curveConfig,range:t.range});var{top:t,left:i}=this.canvas.getBoundingClientRect();this.position={top:t,left:i}}rePaint(){this.clear(),this.grid.rePaint(),this.hermite.rePaint(),this.initControl()}update(t,i){this.negative=i,this.hermite.negative=i,this.grid.negative=i,this.clear(),this.hermite.clear();for(const e of t)e.inTangent="number"==typeof e.inTangent?e.inTangent:Number.POSITIVE_INFINITY,e.outTangent="number"==typeof e.outTangent?e.outTangent:Number.POSITIVE_INFINITY;this.draw(t)}draw(t){this.cxt2D.strokeStyle=DEFAULT_CTRL_COLOR,this.hermite.draw(t),this.hermite.update(this.cxt2D),this.initControl()}initControl(){var{radius:t,fillColor:i,strokeStyle:e}=this.ctrlConfig;this.cxt2D.fillStyle=i,this.cxt2D.strokeStyle=e;for(const r of this.ctrlKey){var s=this.grid.axisToCanvas(r.point);this.cxt2D.beginPath(),this.cxt2D.arc(s.x,s.y,t,0,2*Math.PI),this.cxt2D.closePath(),this.cxt2D.stroke(),this.cxt2D.fill()}this.isBindHandle||this.bindHandler()}resetCtrl(t){(this.isShowCtrl||this.isShowAuxin)&&(this.isShowAuxin=!1,this.isShowCtrl=!1,this.cxt2D.clearRect(0,0,this.canvas.width,this.canvas.height),this.cxt2D.strokeStyle=DEFAULT_CTRL_COLOR,this.hermite.update(this.cxt2D),this.initControl(),t)&&(this.ctrlPoints=null)}bindHandler(){this.isBindHandle=!0,this.canvas.addEventListener("mousedown",t=>this.onMouseDown(t)),this.canvas.addEventListener("mousemove",t=>this.onMouseMove(t)),document.addEventListener("mouseup",t=>this.onMouseUp(t))}onMouseDown(t){this.flags.flag=!1;var i=this.ctrlConfig["radius"];const{offsetX:e,offsetY:s}=t;var r=this.cxt2D.getImageData(e-PIXEL_RANGE/2,s-PIXEL_RANGE/2,PIXEL_RANGE,PIXEL_RANGE);mouseDownPoint.startX=t.x,mouseDownPoint.startY=t.y;for(const l of this.ctrlKey){var{x:h,y:a}=l.point.canvas;if(Math.abs(e-h)<2*CLICK_RANGE+i&&Math.abs(s-a)<2*CLICK_RANGE+i){if(2!==t.button)return this.flags.flag=!0,this.flags.keyDrag=!0,this.canvas.style.cursor="move",this.showCtrl(l),void this.showPoint(this.hermite.keyFrames[l.index],l.point.canvas);{const c=this;return void Editor.Menu.popup({x:t.pageX,y:t.pageY,menu:[{label:"Delete Key",click(){c.delKeyFrame(l.index)}}]})}}}if(this.isShowCtrl&&this.ctrlPoints)for(const g of Object.keys(this.ctrlPoints)){var n=this.ctrlPoints[g];if(n.canvas&&"point"!==g){var{x:n,y:o}=n.canvas;if(Math.abs(e-n)<CLICK_RANGE+i&&Math.abs(s-o)<CLICK_RANGE+i)return this.flags.tanDrag=!0,this.flags.flag=!0,void(this.ctrlPoints.type=g)}}if(r.data.toString()!==UINT8_COLOR_DEFAULT)if(this.flags.flag=!0,2===t.button){const u=this;Editor.Menu.popup({x:t.pageX,y:t.pageY,menu:[{label:"Add Key",click(){u.addKeyFrame(e)}}]})}else this.lightCurve(),this.canvas.style.cursor="ns-resize",this.flags.tanDrag||this.flags.keyDrag||(this.flags.curveDrag=!0);this.flags.flag||this.resetCtrl("hideCtrl")}onMouseMove(t){var i,e,s,r,{curveDrag:h,tanDrag:a,keyDrag:n}=this.flags;(a||h||n)&&({offsetX:t,offsetY:i,movementY:e,x:s,y:r}=t,Math.abs(s-mouseDownPoint.startX)<.5||Math.abs(r-mouseDownPoint.startY)<.5||(a?(this.changeType="tangent",this.updateTan(t,i),this.emitChange()):n?(this.moveKey(t,i),this.emitChange()):h&&0!==e&&this.hermite.moveY(-e)&&(this.changeType="curve",this.emitChange(),this.hermite.clear(),this.hermite.update(),this.resetCtrl(),this.lightCurve())))}onMouseUp(t){this.flags.tanDrag=!1,this.flags.curveDrag=!1,this.flags.keyDrag=!1,this.isShowPoint=!1,this.canvas.style.cursor="default",this.changeType&&(this.emitChange(),this.emitConfirm(),this.changeType="")}moveKey(t,i){t-=this.position.left,this.changeType="keyframe";t=this.hermite.moveKey(t,i,this.ctrlPoints.index);this.ctrlPoints.index=t,this.refreshRender()}delKeyFrame(t){this.hermite.delKeyFrame(t),this.ctrlPoints=null,this.refreshRender(),this.clear(),this.initControl()}addKeyFrame(t){var i=this.hermite.addKeyFrame(t);null===i?console.warn("添加点无效",t):(this.emitChange(),this.emitConfirm(),t=this.ctrlKey[i],this.initControl(),this.drawCtrl(t))}updateTan(t,i){var{index:e,type:s}=this.ctrlPoints,{point:r,isBroken:h}=this.ctrlKey[e];let a=0;(a=Math.abs(t-r.canvas.x)-10<0?Number.POSITIVE_INFINITY:-(i-r.canvas.y)/(t-r.canvas.x))!==Number.NEGATIVE_INFINITY&&a!==Number.POSITIVE_INFINITY&&(h?this.hermite.updateTan(e,a,s):(this.hermite.updateTan(e,a,"inTangent"),this.hermite.updateTan(e,a,"outTangent")),this.refreshRender(),this.drawCtrl(this.ctrlKey[e]))}refreshRender(){var t;this.hermite.clear(),this.hermite.update(),this.resetCtrl(),this.lightCurve(),this.ctrlPoints&&(t=this.ctrlPoints["index"],this.ctrlPoints=this.ctrlKey[t],this.drawCtrl(this.ctrlPoints),this.isShowPoint)&&this.showPoint(this.hermite.keyFrames[t],this.ctrlPoints.point.canvas)}clear(){var{x:t,y:i,w:e,h:s}=this.grid.location;this.cxt2D.clearRect(0,0,e+2*t,s+2*i)}lightCurve(){var t=this.ctrlConfig["focusColor"];this.cxt2D.strokeStyle=t,this.hermite.update(this.cxt2D),this.isShowAuxin=!0}showCtrl(t){this.ctrlPoints&&this.ctrlPoints.index===t.index||(this.ctrlPoints&&(this.resetCtrl(),this.lightCurve()),this.drawCtrl(t))}showPoint(t,i){var e;t&&(this.isShowPoint=!0,{x:i,y:e}=i,this.cxt2D.save(),this.cxt2D.fillStyle="black",this.cxt2D.fillRect(i-30,e-28,50,18),this.cxt2D.fillStyle="white",this.cxt2D.fillText(t.time+","+t.value,i-25,e-15),this.cxt2D.restore())}drawCtrl(t,i=this.cxt2D){this.isShowCtrl=!0;var{point:t,inPoint:e,outPoint:s}=this.ctrlPoints=t,{radius:r,fillColor:h}=this.ctrlConfig;i.save(),i.fillColor=h,i.strokeStyle="white",e&&(e.type="outTangent",this.drawLine(t.canvas,e.canvas),this.drawArc(e.canvas,r),this.ctrlPoints.inPoint=e),s&&(s.type="inTangent",this.drawLine(t.canvas,s.canvas),this.drawArc(s.canvas,r),this.ctrlPoints.outPoint=s),i.restore()}drawLine(t,i,e=this.cxt2D){e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(i.x,i.y),e.closePath(),e.stroke()}drawArc(t,i,e=this.cxt2D){e.beginPath(),e.moveTo(t.x,t.y),e.arc(t.x,t.y,i,0,2*Math.PI),e.closePath(),e.stroke(),e.fill()}emitConfirm(){this.emit("confirm",{keyFrames:Array.from(this.hermite.keyFrames),multiplier:this.grid.multiplier})}emitChange(){this.emit("change",{keyFrames:Array.from(this.hermite.keyFrames),multiplier:this.grid.multiplier})}}exports.default=CurveControl;