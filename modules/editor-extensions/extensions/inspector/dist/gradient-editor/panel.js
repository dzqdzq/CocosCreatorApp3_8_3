"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.ready=exports.methods=exports.$=exports.fonts=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),d3=require("d3"),cloneDeep=require("lodash")["cloneDeep"],Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm=null,cache;function windowResize(){vm&&vm.resize()}function mergeStops(i,o,t){var e,r,a=i.concat(o).map(t=>t.time).sort((t,e)=>t-e),s=[...new Set(a)].reduce((t,e)=>{var r=i.find(t=>!t.hide&&t.time===e)||{},a=o.find(t=>!t.hide&&t.time===e)||{};return void 0===r.time&&void 0===a.time||t.push({...r,...a}),t},[]);cache.colorKeys=i,cache.alphaKeys=o.map(t=>{var e=Object.assign(t);return e.alpha=Number((255*t.alpha).toFixed()),e}),cache.mode=t,Editor.Message.send("inspector","gradient-change",cache);for([e,r]of s.entries()){var{time:n,color:d,alpha:h}=r;void 0===d&&(r.color=getValByType(e,n,s,"color",t)),void 0===h&&(r.alpha=getValByType(e,n,s,"alpha",t))}if(1!==t)return s;var l,c,p=[];for([l,c]of s.entries()){var m,g=c["time"];p.push(c),l<s.length-1&&(m=s[l+1],p.push({...m,time:g}))}return p}function getValByType(e,t,r,a,i){let o,s;for(let t=e+1;t<r.length;t++){var n=r[t];if(void 0!==n[a]){o=n;break}}for(let t=e-1;0<=t;t--){var d=r[t];if(void 0!==d[a]){s=d;break}}if(s=s||o,o=o||s,1===i)return o[a];s=s||{color:[255,255,255],time:0},o=o||{color:[255,255,255],time:1};let h=s[a];return h=s!==o?interpolateStopProperty(s,o,t,a):h}function interpolateStopProperty(e,r,t,a){var i=e["time"],o=r["time"];const s=(t-i)/(o-i),n=1-s;return"color"===a?[0,1,2].map(t=>Math.round(e.color[t]*n+r.color[t]*s)):Math.round(100*e.alpha*n+100*r.alpha*s)/100}function ready(){panel=this,vm?.$destroy(),vm=new Vue({el:panel.$.container,data:{enumList:[{name:"Blend",value:0},{name:"Fixed",value:1}],gradient:{mode:0,alphaKeys:[{time:0,alpha:0,hide:!1},{time:1,alpha:1,hide:!1}],colorKeys:[{time:.5,color:[249,49,83],hide:!1},{time:1,color:[255,255,255],hide:!1}]},margin:{top:15,bottom:15,left:5,right:5},config:{anchorWidth:10,anchorHeight:15,width:0,height:75,defaultColor:[255,255,255],defaultAlpha:1,colorLength:8,alphaLength:8},selectedItem:null},methods:{init(t){t.colorKeys.map(t=>t.type="color"),t.alphaKeys.map(t=>{t.type="alpha",t.alpha=t.alpha/255}),this.gradient=t,this.selectedItem=null,this.resize()},getVal(t){if(this.selectedItem)switch(t){case"color":return JSON.stringify([...this.selectedItem.color,255]);case"time":return""+(100*this.selectedItem.time).toFixed();case"alpha":return""+(255*this.selectedItem.alpha).toFixed();default:return this.selectedItem[t]}},confirm(t,e){e=e.target.value;this.update({operation:"assign",data:{value:e,type:t}})},getAnchors(){var{alphaKeys:t,colorKeys:e}=this["gradient"],e=e.map((t,e)=>({...t,index:e})),t=t.map((t,e)=>({...t,index:e}));return e.concat(t).sort((t,e)=>{if(t.time===e.time){if(t.active)return!0;if(e.active)return!1}return t.time-e.time})},getStops(){var{alphaKeys:t,colorKeys:e,mode:r}=this["gradient"];return mergeStops(cloneDeep(e).sort((t,e)=>{if(t.time===e.time){if(t.active)return!1;if(e.active)return!0}return t.time-e.time}),cloneDeep(t).sort((t,e)=>{if(t.time===e.time){if(t.active)return!1;if(e.active)return!0}return t.time-e.time}),r)},drawStops(t,e){t=this.getStops(t,e),e=this._grad.selectAll("stop").data(t,(t,e)=>{var{color:t,alpha:r,time:a}=t;return""+a+r+t+e});e.exit().remove(),e.enter().append("stop").merge(e).attr("offset",t=>100*t.time+"%").style("stop-color",t=>d3.rgb(...t.color)).style("stop-opacity",t=>void 0!==t.alpha?t.alpha:1)},drawAnchors(t){var e=this.getAnchors(),{config:{width:r},margin:a}=this;const i=r-a.left-a.right,o=this;r=this._svg.selectAll("path").data(e,(t,e)=>{var{color:t,alpha:r,time:a,type:i}=t;return""+i+a+r+t+e});r.exit().remove();let s=!1;r.enter().append("path").merge(r).attr("class",e=>["hide","add","active"].filter(t=>e[t]).concat(["anchor"]).join(" ")).attr("index",t=>t.index).attr("type",t=>t.type).attr("d",t=>this.drawAnchor(t)).attr("transform",t=>`translate(${t.time*i}, 0)`).attr("fill",t=>"color"===t.type?d3.rgb(...t.color):d3.rgb(...Array.from({length:3},()=>255*t.alpha))).order().call(d3.drag().filter(["dragstart","drag"]).on("start",function(){var t=d3.select(this).datum();o.update({data:t,operation:"active"})}).on("drag",function(){(d3.event.dx||d3.event.dy)&&(s=!0,o.update({operation:"move"}))}).on("end",function(){s&&(s=!1,o.update({operation:"drop"}))}))},update(t){var{config:{width:e,height:r},margin:a}=this;const{data:i,operation:o}=t;switch(o){case"active":this.gradient.colorKeys.map(t=>{t.active=!1}),this.gradient.alphaKeys.map(t=>{t.active=!1});var{type:s,index:n}=i,s=this.gradient[s+"Keys"][n];s.active=!0,this.selectedItem=s,this.drawAnchors();break;case"move":var{type:n,index:s}=this._svg.select(".anchor.active").datum(),d=this.gradient[n+"Keys"],s=d[s],[h,l]=d3.mouse(this._svg.node()),n="color"===n?l<r-a.bottom||r<l:l>a.top||l<0,l=Math.round((h-a.left)/(e-a.left-a.right)*100)/100,h=Math.max(Math.min(l,1),0);if(s.time=h,s.hide&&n)return;s.hide=1<d.length&&n,this.drawAnchors(),this.drawStops();break;case"drop":var{type:l,index:c}=this._svg.select(".anchor.active").datum(),h=this.gradient[l+"Keys"],s=h[c],[d,n]=d3.mouse(this._svg.node()),l="color"===l?n<r-a.bottom||r<n:n>a.top||n<0,n=Math.round((d-a.left)/(e-a.left-a.right)*100)/100,p=Math.max(Math.min(n,1),0);if(s.time=p,s.hide=1<h.length&&l,s.hide)h.splice(c,1),this.selectedItem=null;else{d=[...new Set(h.map(t=>t.time))];if(h.length>d.length){let t;for(var[m,g]of h.entries())if(g.time===p&&m!==c){t=m;break}h.splice(t,1)}}this.drawAnchors(),this.drawStops();break;case"create":{var[n,l]=d3.mouse(this._svg.node());if(l>a.top&&l<r-a.bottom)return!1;s=l>a.top?"color":"alpha",d=this.gradient[s+"Keys"],h=d.length;if(h>=this.config[s+"Length"])return!1;l=Math.round((n-a.left)/(e-a.left-a.right)*100)/100;const i={time:Math.max(Math.min(l,1),0),type:s,[s]:"color"==s?[...this.config.defaultColor]:this.config.defaultAlpha,index:h};return d.push(i),this.drawStops(),this.update({data:i,operation:"active"}),!0}case"assign":var{type:n,value:u}=i;if("mode"===n)return this.gradient.mode=parseInt(u,10),this.drawStops();if(this.selectedItem){switch(n){case"time":this.selectedItem.time=u/100;break;case"alpha":this.selectedItem.alpha=Math.floor(100*u/255)/100;break;case"color":this.selectedItem.color=u.slice(0,-1)}this.drawAnchors(),this.drawStops()}}},resize(){const t=this;var e=this.$el.querySelector(".gradient"),{config:{width:r,height:a},margin:i}=(this.config.width=e.clientWidth,this),o=r-i.left-i.right,s=a-i.top-i.bottom;this._svg?(this._svg.attr("width",r),this._rect.attr("width",o).attr("height",s).attr("fill","url(#grad)")):(this._svg=d3.select(e).append("svg").attr("width",r).attr("height",a),this._grad=this._svg.append("defs").append("linearGradient").attr("id","grad").attr("x1","0").attr("x2","100%").attr("y1","0").attr("y2",0),this._rect=this._svg.append("rect").attr("class","canvas").attr("x",i.left).attr("y",i.top).attr("width",o).attr("height",s).attr("fill","url(#grad)"));let n=!1;this._svg.call(d3.drag().on("start",function(){n=t.update({operation:"create"})}).on("drag",function(){n&&t.update({operation:"move"})}).on("end",function(){n&&(n=!1,t.update({operation:"drop"}))})),this.drawStops(),this.drawAnchors()},drawAnchor(t){var{margin:e,config:{height:r,anchorWidth:a,anchorHeight:i}}=this,t=t["type"],t="color"===t,o=e.left,r=t?r-e.bottom:e.top,e=t?1:-1;return`M${o} ${r}
                    L${o-a/2} ${r+i/3*e}
                    ${o-a/2} ${r+i*e}
                    ${o+a/2} ${r+i*e}
                    ${o+a/2} ${r+i/3*e}z`}}}),window.addEventListener("resize",windowResize),Editor.Message.send("inspector","gradient-state",!0)}function close(){window.removeEventListener("resize",windowResize),vm?.$destroy(),vm=null,panel=null,Editor.Message.send("inspector","gradient-state",!1)}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../index.css"),"utf8"),exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../static","/template/gradient-editor.html"),"utf8"),exports.fonts=[{name:"inspector"}],exports.$={container:".gradient-editor"},exports.methods={data(t){vm&&t&&(cache=t,vm.init({colorKeys:t.colorKeys,alphaKeys:t.alphaKeys,mode:t.mode}))}},exports.ready=ready,exports.close=close;