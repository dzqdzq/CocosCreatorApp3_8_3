"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.ready=exports.listeners=exports.methods=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),lodash_1=require("lodash"),SVG=require("svg.js"),Vue=require("vue/dist/vue.js");function roundDouble(t){return(0,lodash_1.round)(t,2)}Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm=null;async function ready(t){panel=this,vm?.$destroy(),vm=new Vue({el:panel.$.container,data:{uuid:null,userData:null,svg:null,image:null,svgColor:"#5c5",svgColorBright:"#8fef8f",dotSize:6,borderLeft:0,borderRight:0,borderBottom:0,borderTop:0,width:0,height:0,leftPos:0,rightPos:0,topPos:0,bottomPos:0,startLeftPos:0,startRightPos:0,startTopPos:0,startBottomPos:0,scale:100,minScale:5,maxScale:500,horizontal:"center",changed:!1},computed:{topPosMax(){var t=this.height-this.bottomPos;return!!t&&roundDouble(t)},bottomPosMax(){var t=this.height-this.topPos;return!!t&&roundDouble(t)},leftPosMax(){var t=this.width-this.rightPos;return!!t&&roundDouble(t)},rightPosMax(){var t=this.width-this.leftPos;return!!t&&roundDouble(t)}},watch:{async userData(){var t,e,s,o;this.userData.imageUuidOrDatabaseUri&&(await this.openSprite(),t=this.userData.rawWidth||this.userData.width,e=this.userData.rawHeight||this.userData.height,s=window.screen.width*window.devicePixelRatio*2,o=window.screen.height*window.devicePixelRatio*2,(s<t||o<e)&&(this.minScale=1,this.maxScale=200,s=parseInt(this.$refs.canvas.parentNode.clientWidth/t*100,10),o=parseInt(this.$refs.canvas.parentNode.clientHeight/e*100,10),this.scale=Math.min(s,o)||this.minScale),this.refreshScaleSlider())},scale(){this.resize()},leftPos(){this.leftPosChanged()},rightPos(){this.rightPosChanged()},topPos(){this.topPosChanged()},bottomPos(){this.bottomPosChanged()}},mounted(){this.svg=SVG(this.$refs.svg),this.svg.spof(),this.refreshScaleSlider()},methods:{t(t){return Editor.I18n.t("inspector.sprite_editor."+t)},resize(){var t,e;(this.image||this.userData)&&(t=this.userData.width*this.scale/100,e=this.userData.height*this.scale/100,this.userData.rotated&&(this._scalingSize={width:Math.ceil(e),height:Math.ceil(t)}),this.$refs.canvas.width=t,this.$refs.canvas.height=e,e=this.$refs.canvas.parentNode.clientWidth,this.horizontal=t<e?"center":"left",this.repaint())},refreshScaleSlider(){const s=this.$refs.scale;s.min=this.minScale,s.max=this.maxScale,s.value=this.scale,this.$refs.content.onmousewheel=t=>{let e=1;t.deltaY<0&&(e=-1),s.value-=e,this.scale=s.value,t.preventDefault()}},scaleChange(){this.image&&this.userData&&(this.scale=this.$refs.scale.value)},async openSprite(){this.width=this.userData.width,this.height=this.userData.height,this.leftPos=this.userData.borderLeft,this.rightPos=this.userData.borderRight,this.topPos=this.userData.borderTop,this.bottomPos=this.userData.borderBottom;var t,e=await Editor.Message.request("asset-db","query-asset-info",this.userData.imageUuidOrDatabaseUri.split("@")[0]);e&&(t=Object.keys(e.library).find(t=>".json"!==t))&&(this.image=new Image,this.image.src=e.library[t].replace("#","%23"),this.image.onload=()=>{this.resize()})},repaint(){var t,e,s=this.$refs.canvas.getContext("2d"),o=this.$refs.canvas.width,i=this.$refs.canvas.height;let r,h,a,d,l,n;n=this.userData.rotated?(s.translate(t=o/2,e=i/2),s.rotate(-90*Math.PI/180),s.translate(-t,-e),a=t-this._scalingSize.width/2,d=e-this._scalingSize.height/2,r=this.userData.height,h=this.userData.width,l=i,o):(a=0,d=0,r=this.userData.width,h=this.userData.height,l=o,i),s.drawImage(this.image,this.userData.trimX,this.userData.trimY,r,h,a,d,l,n),this.$nextTick(()=>{this.drawEditElements()})},drawEditElements(){var t;this.image&&(this.svg.clear(),t=this.getCanvasRect(),this.updateBorderPos(t),this.lineLeft=this.drawLine(this.borderLeft,t.bottom,this.borderLeft,t.top,"l"),this.lineRight=this.drawLine(this.borderRight,t.bottom,this.borderRight,t.top,"r"),this.lineTop=this.drawLine(t.left,this.borderTop,t.right,this.borderTop,"t"),this.lineBottom=this.drawLine(t.left,this.borderBottom,t.right,this.borderBottom,"b"),this.dotLB=this.drawDot(this.borderLeft,this.borderBottom,"lb"),this.dotLT=this.drawDot(this.borderLeft,this.borderTop,"lt"),this.dotRB=this.drawDot(this.borderRight,this.borderBottom,"rb"),this.dotRT=this.drawDot(this.borderRight,this.borderTop,"rt"),this.dotL=this.drawDot(this.borderLeft,t.bottom-t.height/2,"l"),this.dotR=this.drawDot(this.borderRight,t.bottom-t.height/2,"r"),this.dotB=this.drawDot(t.left+t.width/2,this.borderBottom,"b"),this.dotT=this.drawDot(t.left+t.width/2,this.borderTop,"t"))},getCanvasRect(){var t={};return t.top=this.$refs.canvas.offsetTop,t.left=this.$refs.canvas.offsetLeft,t.bottom=this.$refs.canvas.offsetTop+this.$refs.canvas.height,t.right=this.$refs.canvas.offsetLeft+this.$refs.canvas.width,t.width=this.$refs.canvas.width,t.height=this.$refs.canvas.height,t},updateBorderPos(t){this.borderLeft=t.left+this.leftPos*(this.scale/100),this.borderRight=t.right-this.rightPos*(this.scale/100),this.borderTop=t.top+this.topPos*(this.scale/100),this.borderBottom=t.bottom-this.bottomPos*(this.scale/100)},drawLine(t,e,s,o,i){t=lineTool(this.svg,{x:t,y:e},{x:s,y:o},this.svgColor,"default",this.svgCallbacks(i));return"l"===i||"r"===i?t.style("cursor","col-resize"):"t"!==i&&"b"!==i||t.style("cursor","row-resize"),t},drawDot(t,e,s){var o={color:this.svgColor},o=circleTool(this.svg,this.dotSize,o,o,this.svgCallbacks(s));return"l"===s||"r"===s||"t"===s||"b"===s?o.style("cursor","pointer"):"lb"===s||"rt"===s?o.style("cursor","nesw-resize"):"rb"!==s&&"lt"!==s||o.style("cursor","nwse-resize"),this.moveDotTo(o,t,e),o},moveDotTo(t,e,s){t&&t.move(e,s)},svgCallbacks(s){var t={};return t.start=()=>{this.startLeftPos=this.leftPos,this.startRightPos=this.rightPos,this.startTopPos=this.topPos,this.startBottomPos=this.bottomPos},t.update=(t,e)=>{this.svgElementMoved(s,t,e)},t},svgElementMoved(t,e,s){let o=e/(this.scale/100),i=s/(this.scale/100);o=0<o?Math.floor(o):Math.ceil(o),i=0<i?Math.floor(i):Math.ceil(i),0<Math.abs(o)&&(0<=t.indexOf("l")&&(e=roundDouble(this.startLeftPos+o),s=this.userData.width||this.image.width,this.leftPos=this.correctPosValue(e,0,roundDouble(s-this.rightPos))),0<=t.indexOf("r"))&&(e=roundDouble(this.startRightPos-o),s=this.userData.width||this.image.width,this.rightPos=this.correctPosValue(e,0,roundDouble(s-this.leftPos))),0<Math.abs(i)&&(0<=t.indexOf("t")&&(e=roundDouble(this.startTopPos+i),s=this.userData.height||this.image.height,this.topPos=this.correctPosValue(e,0,roundDouble(s-this.bottomPos))),0<=t.indexOf("b"))&&(e=roundDouble(this.startBottomPos-i),s=this.userData.height||this.image.height,this.bottomPos=this.correctPosValue(e,0,roundDouble(s-this.topPos)))},correctPosValue(t,e,s){return t<e?e:s<t?s:t},checkState(){var t=this.leftPos!==this.userData.borderLeft,e=this.rightPos!==this.userData.borderRight,s=this.topPos!==this.userData.borderTop,o=this.bottomPos!==this.userData.borderBottom;this.changed=t||e||s||o,this.save()},leftPosChanged(){var t;this.image&&(t=this.getCanvasRect(),this.updateBorderPos(t),this.moveDotTo(this.dotL,this.borderLeft,t.bottom-t.height/2),this.moveDotTo(this.dotLB,this.borderLeft,this.borderBottom),this.moveDotTo(this.dotLT,this.borderLeft,this.borderTop),this.lineLeft&&this.lineLeft.plot(this.borderLeft,t.bottom,this.borderLeft,t.top),this.checkState())},rightPosChanged(){var t;this.image&&(t=this.getCanvasRect(),this.updateBorderPos(t),this.moveDotTo(this.dotR,this.borderRight,t.bottom-t.height/2),this.moveDotTo(this.dotRB,this.borderRight,this.borderBottom),this.moveDotTo(this.dotRT,this.borderRight,this.borderTop),this.lineRight&&this.lineRight.plot(this.borderRight,t.bottom,this.borderRight,t.top),this.checkState())},topPosChanged(){var t;this.image&&(t=this.getCanvasRect(),this.updateBorderPos(t),this.moveDotTo(this.dotT,t.left+t.width/2,this.borderTop),this.moveDotTo(this.dotLT,this.borderLeft,this.borderTop),this.moveDotTo(this.dotRT,this.borderRight,this.borderTop),this.lineTop&&this.lineTop.plot(t.left,this.borderTop,t.right,this.borderTop),this.checkState())},bottomPosChanged(){var t;this.image&&(t=this.getCanvasRect(),this.updateBorderPos(t),this.moveDotTo(this.dotB,t.left+t.width/2,this.borderBottom),this.moveDotTo(this.dotLB,this.borderLeft,this.borderBottom),this.moveDotTo(this.dotRB,this.borderRight,this.borderBottom),this.lineBottom&&this.lineBottom.plot(t.left,this.borderBottom,t.right,this.borderBottom),this.checkState())},positionChange(t,e){this[e]=t.target.value},save(){Editor.Message.send("inspector","sprite-change",{borderTop:this.topPos,borderBottom:this.bottomPos,borderLeft:this.leftPos,borderRight:this.rightPos}),Editor.Message.broadcast("sprite-editor:changed",{uuid:this.uuid,userData:{borderTop:this.topPos,borderBottom:this.bottomPos,borderLeft:this.leftPos,borderRight:this.rightPos}})}}}),t&&panel.currentKeys(t.meta),Editor.Message.send("inspector","sprite-state",!0)}function close(){Editor.Message.send("inspector","sprite-state",!1),vm?.$destroy(),vm=null,panel=null}function circleTool(t,e,o,i,s,r){"string"!=typeof s&&(r=s,s="default");const h=t.group().style("cursor",s).fill(o||"none").stroke(i||"none"),a=h.circle().radius(e/2);let d,l=(i&&(d=h.circle().stroke({width:8}).fill("none").style("stroke-opacity",0).radius(e/2)),!1);return h.style("pointer-events","bounding-box"),h.on("mouseover",()=>{vm&&o&&h.fill({color:vm.svgColorBright}),vm&&i&&h.stroke({color:vm.svgColorBright})}),h.on("mouseout",t=>{t.stopPropagation(),l||(o&&h.fill(o),i&&h.stroke(i))}),addMoveHandles(h,{cursor:s},{start(t,e,s){l=!0,vm&&o&&h.fill({color:vm.svgColorBright}),vm&&i&&h.stroke({color:vm.svgColorBright}),r.start&&r.start(t,e,s)},update(t,e,s){r.update&&r.update(t,e,s)},end(t){l=!1,o&&h.fill(o),i&&h.stroke(i),r.end&&r.end(t)}}),h.radius=function(t){return a.radius(t),d&&d.radius(t),this},h.cx=function(t){return this.x(t)},h.cy=function(t){return this.y(t)},h}function lineTool(t,e,s,o,i,r){const h=t.group().style("cursor",i).stroke({color:o}),a=h.line(e.x,e.y,s.x,s.y).style("stroke-width",1),d=h.line(e.x,e.y,s.x,s.y).style("stroke-width",8).style("stroke-opacity",0);let l=!1;return h.on("mouseover",()=>{vm&&h.stroke({color:vm.svgColorBright})}),h.on("mouseout",t=>{t.stopPropagation(),l||h.stroke({color:o})}),addMoveHandles(h,{cursor:i},{start(t,e,s){l=!0,vm&&h.stroke({color:vm.svgColorBright}),r.start&&r.start(t,e,s)},update(t,e,s){r.update&&r.update(t,e,s)},end(t){l=!1,h.stroke({color:o}),r.end&&r.end(t)}}),h.plot=function(...t){return a.plot(...t),d.plot(...t),this},h}function addMoveHandles(o,t,i){let r,h;function e(t){t.stopPropagation();var e=t.clientX-r,s=t.clientY-h;i.update&&i.update.call(o,e,s,t)}function s(t){document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",s),i.end&&i.end.call(o,t),t.stopPropagation()}2===arguments.length&&(i=t,t={}),o.on("mousedown",t=>{1===t.which&&(r=t.clientX,h=t.clientY,document.addEventListener("mousemove",e),document.addEventListener("mouseup",s),i.start)&&i.start.call(o,t.offsetX,t.offsetY,t),t.stopPropagation()})}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../index.css"),"utf8"),exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../static","/template/sprite-editor.html"),"utf8"),exports.$={container:".sprite-editor"},exports.methods={currentKeys(t){vm&&t&&(vm.uuid!==t.uuid&&(vm.uuid=t.uuid,vm.scale=100),vm.userData=t.userData)}},exports.listeners={resize(){vm&&(vm.resize(),vm.refreshScaleSlider())}},exports.ready=ready,exports.close=close;