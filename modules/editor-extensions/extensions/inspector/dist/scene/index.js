"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.methods=exports.unload=exports.load=void 0;const electron_1=require("electron"),child_process_1=require("child_process"),path_1=require("path"),fs_extra_1=require("fs-extra"),cc_1=require("cc"),scene_1=require("../extension/scene");function load(){}function unload(){}function broadcastSceneChange(){var e=cc.director.getScene();Editor.Message.broadcast("scene:change-node",e.uuid),cce.SceneFacadeManager.recordNode(e),cce.SceneFacadeManager.snapshot(),cce.Engine.repaintInEditMode()}async function findGenerationPath(e,t,a){let r=await Editor.Message.request("asset-db","query-url",t);return e=r&&r.includes("db://internal")?(r=(r=(r=(0,path_1.dirname)(r)).replace("db://internal/",Editor.Project.path+"/assets/internal/")).replace(/\\/g,"/"),a&&(0,fs_extra_1.ensureDirSync)(r),r):(0,path_1.dirname)(e)}exports.load=load,exports.unload=unload,exports.methods={queryComponentRender(e){e=e[0],e=cce.Component.query(e);return(0,scene_1.queryVirtualElement)(e)},emitComponentRenderEvent(e,t,a,r){e=e[0],e=cce.Component.query(e);(0,scene_1.emitVirtualEvent)(e,t,a,r)},queryNodeWorldTransform(e){e=cce.Node.query(e);return e?{worldPosition:[e.worldPosition.x,e.worldPosition.y,e.worldPosition.z],worldRotation:[e.worldRotation.x,e.worldRotation.y,e.worldRotation.z,e.worldRotation.w],worldScale:[e.worldScale.x,e.worldScale.y,e.worldScale.z]}:null},setNodeWorldTransform(e,t){e=cce.Node.query(e);e&&(e.setWorldPosition(...t.worldPosition),e.setWorldRotation(...t.worldRotation),e.setWorldScale(...t.worldScale))},async generateVector(t){var r=await Editor.Message.request("asset-db","query-path",t.replace(/@[^@]+$/,""));if(r){var t=await Editor.Message.request("asset-db","query-asset-meta",t),s=t.userData.isRGBE?"rgbm":"bgra8",o=(0,path_1.extname)(r),n=(0,path_1.basename)(r,o),n=(0,path_1.join)(Editor.Project.tmpDir,"inspector",n+"_diffusion"),c=n+".txt";if((0,fs_extra_1.existsSync)(c))try{await electron_1.shell.trashItem(c)}catch(e){}if((0,fs_extra_1.existsSync)(c))try{await(0,fs_extra_1.remove)(c)}catch(e){console.error(e)}try{let a;var i=["--hemispherelightingcoef","--filter","irradiance","--dstFaceSize","32","--output0params","png,"+s+",latlong","--input",r,"--output0",n];t.userData.isRGBE&&".hdr"!==o&&i.splice(0,0,"--rgbm"),(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(n)),a="darwin"===process.platform?(0,child_process_1.spawn)((0,path_1.join)(Editor.App.path,"../tools/cmft/cmftRelease64"),i):(0,child_process_1.spawn)((0,path_1.join)(Editor.App.path,"../tools/cmft/cmftRelease64.exe"),i),await new Promise((e,t)=>{a.on("close",()=>{e(void 0)})});let e=["",""];if((0,fs_extra_1.existsSync)(c))e=(0,fs_extra_1.readFileSync)(c,"utf8").split(/\n/).map(e=>e.trim());else if("texture-cube"===t.importer)return void console.warn(Editor.I18n.t("inspector.scene.recommendErpTextureCube"));e[0]||(e[0]=""),e[1]||(e[1]="");var l=e[0].split(",").map(e=>parseFloat(e.trim())),d=e[1].split(",").map(e=>parseFloat(e.trim()));cc.director._scene._globals.ambient.skyColor=new cc_1.Vec4(l[0],l[1],l[2],0),cc.director._scene._globals.ambient.groundAlbedo=new cc_1.Vec4(d[0],d[1],d[2],0),broadcastSceneChange()}catch(e){console.error(e)}}},async generateDiffuseMap(e){var t=await Editor.Message.request("asset-db","query-path",e.replace(/@[^@]+$/,""));if(!t)return null;const r=await Editor.Message.request("asset-db","query-asset-meta",e);var s=r.userData.isRGBE?"rgbm":"bgra8",o=(0,path_1.extname)(t),n=(0,path_1.basename)(t,o),e=await findGenerationPath(t,e,!0),e=(0,path_1.join)(e,n+"_diffusion"),n=e+".png";if((0,fs_extra_1.existsSync)(n))try{await electron_1.shell.trashItem(n)}catch(e){}if((0,fs_extra_1.existsSync)(n))try{await(0,fs_extra_1.remove)(n)}catch(e){console.error(e)}try{let a;var c,i=["--filter","irradiance","--dstFaceSize","32","--output0params","png,"+s+",latlong","--input",t,"--output0",e],l=(r.userData.isRGBE&&".hdr"!==o&&i.splice(0,0,"--rgbm"),a="darwin"===process.platform?(0,child_process_1.spawn)((0,path_1.join)(Editor.App.path,"../tools/cmft/cmftRelease64"),i):(0,child_process_1.spawn)((0,path_1.join)(Editor.App.path,"../tools/cmft/cmftRelease64.exe"),i),await new Promise((e,t)=>{a.on("close",()=>{e(void 0)})}),n+".meta");if((0,fs_extra_1.existsSync)(l)){const r=(0,fs_extra_1.readJSONSync)(l);r.userData.type="texture cube",(0,fs_extra_1.outputJSONSync)(l,r,{spaces:2})}else(0,fs_extra_1.outputJSONSync)(l,{ver:"0.0.0",importer:"*",userData:{type:"texture cube",isRGBE:r.userData.isRGBE}},{spaces:2});if(await Editor.Message.request("asset-db","refresh-asset",n),n){const d=await Editor.Message.request("asset-db","query-uuid",n);d&&(c=await new Promise(a=>{cc.assetManager.loadAny(d+"@b47c0",(e,t)=>{e?(console.error("asset can't be load:"+d),a(null)):a(t)})}))&&(cc.director._scene._globals.skybox.diffuseMap=c,broadcastSceneChange())}}catch(e){console.error(e)}},async bakeReflectionConvolution(e){var t=await Editor.Message.request("asset-db","query-path",e.replace(/@[^@]+$/,""));if(!t)return null;const r=await Editor.Message.request("asset-db","query-asset-meta",e);var s=r.userData.isRGBE?"rgbm":"bgra8",o=(0,path_1.extname)(t),n=(0,path_1.basename)(t,o),e=await findGenerationPath(t,e,!0),c=(0,path_1.join)(e,n+"_reflection"),i=c+".png";if((0,fs_extra_1.existsSync)(i))try{await electron_1.shell.trashItem(i)}catch(e){}if((0,fs_extra_1.existsSync)(i))try{await(0,fs_extra_1.remove)(i)}catch(e){console.error(e)}try{let a;var l=["--srcFaceSize","1536","--bypassoutputtype","--output0params","png,"+s+",latlong","--input",t,"--output0",c],d=(r.userData.isRGBE&&".hdr"!==o&&l.splice(0,0,"--rgbm"),a="darwin"===process.platform?(0,child_process_1.spawn)((0,path_1.join)(Editor.App.path,"../tools/cmft/cmftRelease64"),l):(0,child_process_1.spawn)((0,path_1.join)(Editor.App.path,"../tools/cmft/cmftRelease64.exe"),l),await new Promise((e,t)=>{a.on("close",()=>{e(void 0)})}),(0,path_1.join)((0,path_1.dirname)(e),n+"_reflection_convolution"));for(let e=0;e<6;e++){var p=(0,path_1.join)(d,"mipmap_"+e.toString()+".png");(0,fs_extra_1.existsSync)(p)&&(0,fs_extra_1.removeSync)(p)}var u,_=i+".meta";if((0,fs_extra_1.existsSync)(_)){const r=(0,fs_extra_1.readJSONSync)(_);r.userData.type="texture cube",(0,fs_extra_1.outputJSONSync)(_,r,{spaces:2})}else(0,fs_extra_1.outputJSONSync)(_,{ver:"0.0.0",importer:"*",userData:{type:"texture cube",isRGBE:r.userData.isRGBE}},{spaces:2});if(await Editor.Message.request("asset-db","refresh-asset",i),(0,fs_extra_1.existsSync)(_)){const r=(0,fs_extra_1.readJSONSync)(_);r.subMetas?.b47c0&&(r.subMetas.b47c0.userData.mipBakeMode=2,(0,fs_extra_1.outputJSONSync)(_,r,{spaces:2}),await Editor.Message.request("asset-db","refresh-asset",i))}if(i){const f=await Editor.Message.request("asset-db","query-uuid",i);f&&(u=await new Promise(a=>{cc.assetManager.loadAny(f+"@b47c0",(e,t)=>{e?(console.error("asset can't be load:"+f),a(null)):a(t)})}))&&(cc.director._scene._globals.skybox.reflectionMap=u,broadcastSceneChange())}}catch(e){console.error(e)}},async setReflectionConvolutionMap(e){var t=await Editor.Message.request("asset-db","query-path",e.replace(/@[^@]+$/,""));if(!t)return null;var a=(0,path_1.extname)(t),a=(0,path_1.basename)(t,a),t=await findGenerationPath(t,e,!1),e=(0,path_1.join)(t,a+"_reflection")+".png";if((0,fs_extra_1.existsSync)(e)){const r=await Editor.Message.request("asset-db","query-uuid",e);r&&(t=await new Promise(a=>{cc.assetManager.loadAny(r+"@b47c0",(e,t)=>{e?(console.error("asset can't be load:"+r),a(null)):a(t)})}))&&(cc.director._scene._globals.skybox.reflectionMap=t,broadcastSceneChange())}else cc.director._scene._globals.skybox.reflectionMap&&(cc.director._scene._globals.skybox.reflectionMap=null,broadcastSceneChange())},async setSkyboxEnvMap(r){var e;r?(e=await new Promise(a=>{cc.assetManager.loadAny(r,(e,t)=>{e?(console.error("asset can't be load:"+r),a(null)):a(t)})}))&&cc.director._scene._globals.skybox.updateEnvMap(e):(cc.director._scene._globals.skybox.updateEnvMap(null),broadcastSceneChange())}};