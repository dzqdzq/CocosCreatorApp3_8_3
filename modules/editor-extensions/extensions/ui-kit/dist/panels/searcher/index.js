"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var s=Object.getOwnPropertyDescriptor(t,a);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,s)}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.ready=exports.methods=exports.$=exports.style=exports.template=void 0;const fs_1=require("fs"),path_1=require("path"),section=__importStar(require("./comps/section")),Vue=require("vue/dist/vue.js"),minimatch=(Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../static","/template/panels/searcher.html"),"utf8"),exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../dist/searcher.css"),"utf8"),require("minimatch"));let vm=null,panel=null;function dispatchEvent(e,t,a){t=new CustomEvent(t,{detail:a});e.parentNode?.dispatchEvent(t)}const allowCreateAssetTypes=["cc.Script","cc.RenderPipeline","cc.AnimationClip","cc.EffectAsset","cc.Material","cc.PhysicsMaterial","cc.RenderTexture","cc.SceneAsset","cc.SpriteAtlas","cc.TerrainAsset","cc.TextureCube"];let DataDumpCache=[];const maxLinesNumber=50,recordPreview=(exports.$={container:".searcher"},{method:"",id:"",info:{}});function ready(){panel=this,vm?.$destroy(),vm=new Vue({el:panel.$.container,components:{"comps-section":section},data:{loading:!0,search:"",selected:null,type:"",ccType:"",assetFilter:null,dataDump:null,dataDumpShowNumber:maxLinesNumber,isKitClosed:!1},computed:{expand(){return!!vm.search}},watch:{selected(){var t=vm.$refs.main.querySelector(".line[selected]");if(t&&t.removeAttribute("selected"),vm.selected){t=vm.$refs.main.querySelector('.line[value="'+vm.selected+'"]');if(t){t.setAttribute("selected",!0);let e=t.parentNode;for(;e&&"UI-SECTION"===e.tagName&&!e.expand;)e.expand=!0,e=e.parentNode;t.scrollIntoViewIfNeeded()}}}},mounted(){this.$refs.container.addEventListener("scroll",()=>{var{scrollHeight:e,clientHeight:t,scrollTop:a}=this.$refs.container;e-t-a<100&&this.dataDump&&this.dataDumpShowNumber<this.dataDump.length&&(this.dataDumpShowNumber+=maxLinesNumber)})},methods:{t(e){return Editor.I18n.t("ui-kit.searcher."+e)},async updateData(e,t,a){switch(vm.$refs.searchInput.value="",vm.type!==e&&(vm.dataDump=null,vm.dataDumpShowNumber=maxLinesNumber),vm.type=e,vm.ccType=t,vm.type){case"add-component":await vm.addComponentsInit();break;case"node":await vm.searchNodeInit(a.filterOptions);break;case"component":vm.ccType=await getExtendsClass(t),await vm.searchComponentsInit();break;case"asset":vm.ccType=await getExtendsClass(t),vm.assetFilter=a.assetFilter,await vm.searchAssetsInit(a.data);break;case"script":await vm.searchScriptInit()}},async addComponentsInit(){DataDumpCache=await Editor.Message.request("scene","query-components"),vm&&(DataDumpCache.sort((e,t)=>{var a=e.path.match(/\//g),r=t.path.match(/\//g),a=a?a.length:0,r=r?r.length:0;return a===r?e.path.localeCompare(t.path):a-r}),vm.dataDump=sortCompDump(DataDumpCache))},async searchComponentsInit(){var e=await Editor.Message.request("scene","query-node-tree");vm&&((DataDumpCache=sortNodeCompDump(e,vm.ccType.split(","))).sort((e,t)=>e.name.localeCompare(t.name)),vm.dataDump=DataDumpCache,vm.selected=null)},async searchAssetsInit(e){var t,a,r=this;e||(t={pattern:"!db://internal/default_file_content/**/*"},r.assetFilter&&Object.assign(t,r.assetFilter),r.ccType&&(a=r.ccType.split(",").map(e=>e.trim()),t.ccType=a),e=await Editor.Message.request("asset-db","query-assets",t)),DataDumpCache=[];for(const n of e){var s=n.displayName||n.name,s={type:n.type,importer:n.importer,name:s,uuid:n.uuid,path:n.url,sort:s+n.url};DataDumpCache.push(s)}DataDumpCache.sort((e,t)=>e.sort.localeCompare(t.sort)),r&&(r.dataDump=DataDumpCache,r.dataDumpShowNumber=maxLinesNumber)},async searchNodeInit(e){var t=await Editor.Message.request("scene","query-node-tree");DataDumpCache=sortNodeDump(t,e),vm&&(vm.dataDump=DataDumpCache,vm.dataDumpShowNumber=maxLinesNumber)},async searchScriptInit(){var e={excludeSelf:!0,extends:vm.ccType};vm.ccType&&"string"==typeof vm.ccType&&(e.extends=[vm.ccType]),(DataDumpCache=await Editor.Message.request("scene","query-classes",e)).sort((e,t)=>e.name.localeCompare(t.name)),vm&&(vm.dataDump=sortScriptDump(DataDumpCache))},onSearch(t){t=t.target.value.trim();if(vm.search!==t){vm.search=t;let e=DataDumpCache;try{if(vm.search){const a=new RegExp(vm.search,"i");e=DataDumpCache.filter(e=>{let t=!1;return t=!(t=e.name?-1!==e.name.search(a):t)&&e.path?-1!==e.path.search(a):t})}}catch(e){}"add-component"===vm.type?vm.dataDump=sortCompDump(e):("script"===vm.type?vm.dataDump=sortScriptDump(e):vm.dataDump=e,vm.dataDumpShowNumber=maxLinesNumber,vm.$refs.container.scrollTop=0),window.requestIdleCallback(()=>{vm&&(e&&e.length&&vm.search?vm.selected=e[0].name:vm.selected=null)})}},searchKeydown(e){e.target.blur();e=this.getValues();e.length&&(vm.selected=e[0])},getValues(){const t=[];return vm.$refs.main.querySelectorAll(".line").forEach(e=>{e=e.getAttribute("value");e&&t.push(e)}),t},upDownSelect(e){var t=vm.getValues();let a=t.indexOf(vm.selected)+e;(a=a===t.length?0:a)<=-1&&(a=t.length-1),vm.selected=t[a]},enterSelect(){var e=vm.$refs.main.querySelector('.line[value="'+vm.selected+'"]');e&&e.click()},onSelect(e,t){var a;"string"==typeof e&&(vm.selected=e,vm.search="",recordPreview.method="",dispatchEvent(a=this.$el,"change",{value:e,info:t}),dispatchEvent(a,"confirm",{value:e,info:t}),vm.closeKit())},twinkle(e){"asset"===vm.type?Editor.Message.send("assets","twinkle",e.uuid):"node"===vm.type?Editor.Message.send("hierarchy","twinkle",e.uuid):"component"===vm.type&&Editor.Message.send("hierarchy","twinkle",e.nodeUuid)},checkAllowCreate(e){return allowCreateAssetTypes.includes(e)},async createAsset(){Editor.Panel.__protected__.holdKit();var e=await Editor.Message.request("asset-db","create-asset-dialog",{ccType:vm.ccType});e?vm&&vm.onSelect(e.uuid,e):vm&&vm.closeKit()},closeKit(){vm.isKitClosed=!0,Editor.Panel.__protected__.closeKit()},preview(e,t,a){vm&&!vm.isKitClosed&&(recordPreview.method=e,recordPreview.id=t,recordPreview.info=a,dispatchEvent(vm.$el,"preview",{method:e,value:t,info:a}))}}})}function close(){panel=null,vm?.$destroy(),vm=null}function sortNodeDump(e,t,a=[]){return e&&0!==e.children.length&&e.children.forEach(e=>{(!t||t.pathPattern&&minimatch(e.path,t.pathPattern))&&a.push({name:e.name,type:e.type,uuid:e.uuid,path:e.path}),0<e.children.length&&sortNodeDump(e,t,a)}),a}function sortNodeCompDump(e,t,r=[],s){if(e&&0!==e.children.length)for(const n of t)e.children.forEach(e=>{var t=s||"",a=(t+=" / "+e.name,e.components.find(e=>e.type===n));a&&r.push({name:e.name,uuid:a.value,path:t,nodeUuid:e.uuid,iconName:n,ccType:n}),0<e.children.length&&sortNodeCompDump(e,[n],r,t)});return r}function sortCompDump(e){var t={};for(const r of e)if(!r.path.startsWith("hidden:")){const s=r.path.split("/");let a=t;s.forEach((e,t)=>{e.startsWith("i18n:")&&(e=Editor.I18n.t("ENGINE."+e.substr(5))||e),t===s.length-1?(r.cid&&(e=r.cid),a[e]={iconName:r.name||"component",...r}):a[e]||(a[e]={}),a=a[e]})}return t}function sortScriptDump(e){var t={};for(const a of e)t[a.name]={iconName:"component",...a};return t}async function getExtendsClass(e){if(!e)return"";var t=[];for(const r of e.split(","))if(r){var a=await Editor.Message.request("scene","query-classes",{extends:r});if(Array.isArray(a)&&a.length)for(const s of a)t.includes(s.name)||t.push(s.name)}return t.join(",")}exports.methods={async clear(){return"confirm"===recordPreview.method&&(recordPreview.method="",dispatchEvent(this.$.content,"preview",{method:"cancel",value:recordPreview.id,info:recordPreview.info})),vm&&(vm.loading=!0),new Promise(e=>{setTimeout(()=>{e(void 0)},0)})},async reset(e){vm&&(await vm.updateData(e.type,e.droppable,e),vm.selected=e.value,vm.loading=!1,vm.isKitClosed=!1,vm.search="",requestAnimationFrame(()=>{vm&&!vm.$refs.searchInput.focused&&vm.$refs.searchInput.focus()}))},up(){vm&&vm.upDownSelect(-1)},down(){vm&&vm.upDownSelect(1)},enter(){vm&&vm.enterSelect()},esc(){vm&&vm.$refs.searchInput.focus()}},exports.ready=ready,exports.close=close;