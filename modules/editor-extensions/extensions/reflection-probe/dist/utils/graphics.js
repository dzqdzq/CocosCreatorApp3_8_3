"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.saveDataToImage=exports.flipImage=exports.readPixels=void 0;const cc_1=require("cc"),fs_extra_1=require("fs-extra"),sharp_1=__importDefault(require("sharp")),path_1=require("path");function readPixels(e){var t,a,r,s,i=e.width,n=e.height,i=new Uint8Array(4*i*n),n=e.getGFXTexture();return n?(t=cc_1.gfx.deviceManager.gfxDevice,a=[],r=[],(s=new cc_1.gfx.BufferTextureCopy).texOffset.x=0,s.texOffset.y=0,s.texExtent.width=e.width,s.texExtent.height=e.height,r.push(s),a.push(i),t?.copyTextureToBuffers(n,a,r),i):null}function flipImage(a,r,s){if(!a)return null;var i=new Uint8Array(a.length);for(let t=0;t<s;t++)for(let e=0;e<r;e++){var n=4*(r*t+e),o=4*(r*(s-t-1)+e);i[o]=a[n],i[1+o]=a[1+n],i[2+o]=a[2+n],i[3+o]=a[3+n]}return i}async function saveDataToImage(r,s,i,n,o){let u;await new Promise(async(e,t)=>{var a=await Editor.Message.request("asset-db","query-path","db://assets");null!==a&&(a=(0,path_1.join)(a,n),(0,fs_extra_1.existsSync)(a)||(0,fs_extra_1.mkdirSync)(a),u=(0,path_1.join)(a,o),(0,sharp_1.default)(r,{raw:{width:s,height:i,channels:4}}).toFile(u).then(async()=>{e()}).catch(e=>{t(e)}))})}exports.readPixels=readPixels,exports.flipImage=flipImage,exports.saveDataToImage=saveDataToImage;