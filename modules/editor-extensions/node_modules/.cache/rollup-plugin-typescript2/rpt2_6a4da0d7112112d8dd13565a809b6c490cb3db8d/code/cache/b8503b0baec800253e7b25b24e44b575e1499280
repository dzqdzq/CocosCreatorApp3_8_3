{"code":"'use strict';\r\nconst Chroma = require('chroma-js');\r\nlet isStart = false;\r\nlet isFinish = false;\r\nlet isEnd = false;\r\nlet currProgress = 0;\r\nlet bakerSum = 20;\r\nlet progress = 0;\r\nlet logInfos = [];\r\nlet currPath;\r\nfunction initVal() {\r\n    currProgress = 0;\r\n    bakerSum = 20;\r\n    progress = 0;\r\n}\r\nfunction changeProgress(prog = null, halfPart = true) {\r\n    if (!prog) {\r\n        currProgress += 10;\r\n        if (currProgress >= (bakerSum - 10)) {\r\n            bakerSum += 10;\r\n        }\r\n        prog = currProgress / bakerSum * 100;\r\n        if (halfPart) {\r\n            prog /= 2;\r\n        }\r\n    }\r\n    progress = prog;\r\n}\r\nexport const methods = {\r\n    /**\r\n     * 打开偏好设置面板\r\n     */\r\n    async open() {\r\n        const bake_feature = await Editor.Profile.getConfig('lightmap', 'laboratory.bake_feature');\r\n        if (bake_feature) {\r\n            isStart = false;\r\n            logInfos = [];\r\n            Editor.Panel.open('lightmap.panel');\r\n        }\r\n        else {\r\n            Editor.Dialog.warn(Editor.I18n.t('lightmap.openWarn'));\r\n        }\r\n    },\r\n    async start() {\r\n        console.debug('Light map panel output info: start.');\r\n        isStart = true;\r\n        isFinish = false;\r\n        isEnd = false;\r\n        logInfos = [];\r\n        logInfos.push('Baking started');\r\n    },\r\n    cancel() {\r\n        isEnd = true;\r\n        initVal();\r\n    },\r\n    log(data) {\r\n        console.debug('Light map panel output info: log.', data);\r\n        logInfos.push(data);\r\n        if (isFinish) {\r\n            changeProgress(null, false);\r\n        }\r\n    },\r\n    progress(data) {\r\n        console.debug('Light map panel output info: progress.', data);\r\n        logInfos.push(data);\r\n        if (!isFinish) {\r\n            changeProgress();\r\n        }\r\n    },\r\n    // 烘焙库的任务结束,此时还未输出图片\r\n    finished() {\r\n        console.debug('Light map panel output info: finished.');\r\n        isFinish = true;\r\n        isEnd = false;\r\n        logInfos.push('The baking is ready to complete and begin generating images.');\r\n        changeProgress(50);\r\n    },\r\n    // 烘焙全部结束,此时已输出图片\r\n    async end() {\r\n        console.debug('light map panel output info: end.');\r\n        isEnd = true;\r\n        logInfos.push('End of the baking.');\r\n        logInfos.push(Editor.I18n.t('lightmap.end'));\r\n        initVal();\r\n    },\r\n    async clear() {\r\n        console.debug('Light map panel output info: clear.');\r\n        logInfos = [];\r\n        isStart = false;\r\n        isFinish = false;\r\n        isEnd = false;\r\n        initVal();\r\n        currPath = '';\r\n    },\r\n    async unstaging() {\r\n        return {\r\n            progress,\r\n            logInfos,\r\n            currPath,\r\n            isStart,\r\n            isFinish,\r\n            isEnd,\r\n        };\r\n    },\r\n    async savePicPath(path) {\r\n        currPath = Editor.Utils.Path.normalize(path);\r\n    },\r\n    async getConfig() {\r\n        let lightMapData = await Editor.Profile.getConfig('lightmap', 'lightmap');\r\n        if (!lightMapData) {\r\n            lightMapData = {\r\n                msaa: 4,\r\n                path: '',\r\n                size: 1024,\r\n                highp: false,\r\n                giScale: 1,\r\n                giSamples: 25,\r\n                giPathLength: 4,\r\n                aoLevel: 0,\r\n                aoStrength: 0.5,\r\n                aoRadius: 1.0,\r\n                aoColor: [136, 136, 136, 255],\r\n                tab: 0,\r\n                r: true,\r\n                g: true,\r\n                b: true,\r\n                a: false,\r\n                filter: true,\r\n            };\r\n        }\r\n        // 兼容 v3.7 以下版本用户数据 aoColor 可能是字符串\r\n        if (typeof lightMapData.aoColor === 'string') {\r\n            lightMapData.aoColor = Chroma(lightMapData.aoColor).rgb();\r\n        }\r\n        return lightMapData;\r\n    },\r\n    bakeLightProbe(lightMapData) {\r\n        Editor.Message.send('scene', 'execute-scene-script', {\r\n            name: 'lightmap',\r\n            method: 'bakeLightProbe',\r\n            args: [lightMapData, Editor.App.path],\r\n        });\r\n    },\r\n    cancelLightProbe() {\r\n        Editor.Message.send('scene', 'execute-scene-script', {\r\n            name: 'lightmap',\r\n            method: 'cancelLightProbe',\r\n            args: [],\r\n        });\r\n    },\r\n};\r\nexport async function load() { }\r\nexport function unload() { }\r\n","references":["/Users/mac/Documents/editor_3d/v3.8.3/app/node_modules/chroma-js/chroma.js"]}
