const fs=require("fs-extra"),ps=require("path"),wget=require("wget-improved"),cliProgress=require("cli-progress"),AdmZip=require("adm-zip"),Octokit=require("@octokit/rest")["Octokit"],HttpsProxyAgent=require("https-proxy-agent");(async()=>{var e=(await fs.readJson(ps.join(__dirname,"package.json"))).version,r=/-editor\.\d+/.exec(e);const s=r?e.substr(0,r.index)+e.substr(r.index+r[0].length):e,i=process.env.HTTP_PROXY||process.env.HTTPS_PROXY||void 0,t=ps.join(__dirname,"bin"),n=(await fs.ensureDir(t),await fs.emptyDir(t),ps.join(__dirname,"types")),o=(await fs.ensureDir(n),await fs.emptyDir(n),await async function(){var e=new Octokit({agent:HttpsProxyAgent({proxy:i})}),e=await e.repos.listReleases({owner:"cocos-creator",repo:"FBX-glTF-conv"}),e=e.data.find(e=>e.tag_name==="release-v"+s);if(!e)throw new Error(`Release ${s} is not found!`);var r=e.assets.find(e=>e.name.includes("win32"));if(!r)throw new Error("Windows asset is not found!");var t=e.assets.find(e=>e.name.includes("darwin"));if(!t)throw new Error("macOS asset is not found!");e=e.assets.find(e=>e.name.includes("types"));if(e)return{win32:r.browser_download_url,darwin:t.browser_download_url,types:e.browser_download_url};throw new Error("types asset is not found!")}()),a=ps.join(__dirname,".tmp");await fs.ensureDir(a),await fs.emptyDir(a);{const d=new cliProgress.MultiBar({clearOnComplete:!1,hideCursor:!0,format:"{platform} | {bar} | {percentage}%",noTTYOutput:!0},cliProgress.Presets.shades_classic);await Promise.all(Object.entries(o).map(async([e,r])=>{const t=e.padEnd(6," ");e=ps.join(a,e+".zip");const s=d.create(1,0,{platform:t}),n=(await fs.ensureDir(ps.dirname(e)),wget.download(r,e,{proxy:i}));await new Promise((e,r)=>{n.on("error",function(e){s.stop(),r(e)}),n.on("start",function(e){}),n.on("end",function(){s.stop(),e()}),n.on("progress",function(e){s.update(Math.round(100*(e+Number.EPSILON))/100,{platform:t})})})})),d.stop()}await 0,await w("win32"),await w("darwin"),console.log("Installing types"),r=ps.join(a,"types.zip"),e=n,await fs.ensureDir(e);var c=e,p=new AdmZip(r);for(const l of r=p.getEntries().filter(e=>!e.isDirectory))console.log("Extract "+l.entryName),p.extractEntryTo(l,c,!1);async function w(e){console.log("Installing "+e);var r=ps.join(a,e+".zip"),e=ps.join(t,e);await fs.ensureDir(e),async function(e,r){const t=new AdmZip(e),s=t.getEntries().filter(e=>!e.isDirectory&&e.entryName.split(/[\\/]/g).join("/").startsWith("Release/bin"));for(const n of s)console.log("Extract "+n.entryName),t.extractEntryTo(n,r,!1)}(r,e)}await 0,await fs.writeFile(ps.join(__dirname,"VERSION"),s)})();