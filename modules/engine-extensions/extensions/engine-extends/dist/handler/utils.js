"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MigrateStep=exports.openCode=exports.removeNull=exports.getTrimRect=exports.getPixiel=exports.clamp=exports.linkToAssetTarget=exports.i18nTranslate=exports.getDeserializeResult=exports.deserialize=exports.getDependList=exports.getDependUUIDList=void 0;const electron_i18n_1=__importDefault(require("@base/electron-i18n")),electron_1=require("electron");function getDependUUIDList(t,r){if("string"!=typeof t)return getDeserializeResult(t).uuids;{let e=t.match(/[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}(@[a-z0-9]+){0,}/g);return(e=e&&JSON.parse(JSON.stringify(Array.from(new Set(e)).filter(e=>e!==r))))||[]}}function getDependList(e){var t,r;return"string"==typeof e?(r=getDependUUIDList(e),t=(t=e.match(/"__type__":\s*"([0-9a-zA-Z+/]{22,23})"/g))&&t.toString().match(/[0-9a-zA-Z+/]{22,23}/g)||[],{uuids:r,dependScriptUuids:Array.from(new Set(t.map(e=>Editor.Utils.UUID.decompressUUID(e))))}):{uuids:(r=getDeserializeResult(e)).uuids,dependScriptUuids:r.dependScriptUuids}}function deserialize(e){return getDeserializeResult(e).instance}function getDeserializeResult(e){var t=new cc.deserialize.Details;t.reset();const r=EditorExtends.MissingReporter.classInstance,s=(r.reset(),r.hasMissingClass=!1,new Set);e=cc.deserialize(e,t,{classFinder:function(e){return Editor.Utils.UUID.isUUID(e)&&s.add(Editor.Utils.UUID.decompressUUID(e)),r.classFinder(e)}});return t.assignAssetsBy(function(e,t){return EditorExtends.serialize.asAsset(e)}),{instance:e,uuids:t.uuidList,dependScriptUuids:Array.from(s),classFinder:r.classFinder}}function i18nTranslate(e,...t){let r=electron_i18n_1.default.translation(e);if("object"==typeof t[0]){var s=t[0],e=r.match(/{(\w+)}/g);if(e)for(const n of e){var i=n.substr(1,n.length-2);r=r.replace(n,s[i])}}return r}function linkToAssetTarget(e){return`{asset(${e})}`}function clamp(e,t,r){return e<t?t:r<e?r:e}function getPixiel(e,t,r,s){t=4*t+r*s*4;return{r:e[t],g:e[1+t],b:e[2+t],a:e[3+t]}}function getTrimRect(e,t,r,s){var i=s;let n=t,o=r,a=0,l=0,p,c;for(c=0;c<r;c++)for(p=0;p<t;p++)if(getPixiel(e,p,c,t).a>=i){o=c,c=r;break}for(c=r-1;c>=o;c--)for(p=0;p<t;p++)if(getPixiel(e,p,c,t).a>=i){l=c-o+1,c=0;break}for(p=0;p<t;p++)for(c=o;c<o+l;c++)if(getPixiel(e,p,c,t).a>=i){n=p,p=t;break}for(p=t-1;p>=n;p--)for(c=o;c<o+l;c++)if(getPixiel(e,p,c,t).a>=i){a=p-n+1,p=0;break}return[n,o,a,l]}function removeNull(e,t){let r=!1;for(const n of e){if(n._children&&n._children.length)for(let e=0;e<n._children.length;e++){var s=n._children[e];s||(n._children.splice(e,1),r=!0,console.warn(Editor.I18n.t("engine-extends.importers.invalidNodeData",{assetUuid:t,type:Editor.I18n.t("engine-extends.importers.node"),value:String(s)})),e--)}if(n._components)for(let e=0;e<n._components.length;e++){var i=n._components[e];i||(n._components.splice(e,1),console.warn(Editor.I18n.t("engine-extends.importers.invalidNodeData",{assetUuid:t,type:Editor.I18n.t("engine-extends.importers.component"),value:String(i)})),r=!0,e--)}}return r}async function openCode(e){if(!await Editor.Message.request("program","open-program","scriptEditor",[Editor.Project.path,e.source])){var t=await findVsCode();if(t)await Editor.Message.request("program"," execute-program",t,[Editor.Project.path,e.source]);else try{electron_1.shell.openExternal(e.source)}catch(e){console.warn(e)}}}async function findVsCode(){let e="";try{console.warn(Editor.I18n.t("asset-db.openAsset.preferenceProgramWarning"));var t=await electron_1.app.getApplicationInfoForProtocol("vscode://");"Visual Studio Code"===t.name&&(e=t.path)}catch(e){}return e}exports.getDependUUIDList=getDependUUIDList,exports.getDependList=getDependList,exports.deserialize=deserialize,exports.getDeserializeResult=getDeserializeResult,exports.i18nTranslate=i18nTranslate,exports.linkToAssetTarget=linkToAssetTarget,exports.clamp=clamp,exports.getPixiel=getPixiel,exports.getTrimRect=getTrimRect,exports.removeNull=removeNull,exports.openCode=openCode;class MigrateStep{constructor(){this.resolveQueue=[]}hold(){return new Promise(e=>{this.resolveQueue.push(e),1===this.resolveQueue.length&&(e(),e.hasResolve=!0)})}step(){var e=this.resolveQueue.shift();e&&e(),e&&e.hasResolve&&this.step()}}exports.MigrateStep=MigrateStep;