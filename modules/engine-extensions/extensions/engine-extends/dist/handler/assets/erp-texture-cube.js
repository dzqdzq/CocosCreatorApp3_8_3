"use strict";var MipmapMode,__createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var i=Object.getOwnPropertyDescriptor(t,a);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,i)}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkSize=exports.ERPTextureCubeHandler=exports.MipmapMode=void 0;const asset_db_1=require("@editor/asset-db"),texture_base_1=require("./texture-base"),equirect_cubemap_faces_1=require("./utils/equirect-cubemap-faces"),cc=__importStar(require("cc")),cube_map_simple_layout_1=require("./utils/cube-map-simple-layout"),migratesNameToId=__importStar(require("./migrates/name2id")),sharp_1=__importDefault(require("sharp")),fs_extra_1=require("fs-extra"),path_1=require("path"),fs_extra_2=require("fs-extra"),utils_1=require("../utils"),utils_2=require("./image/utils"),verticalCount=2;async function _getFacesInSimpleLayout(a,r){const i={};var e=Object.getOwnPropertyNames(r);for(const t of e)i[t]=void 0;return await Promise.all(e.map(async e=>{var t=r[e],t=await(0,sharp_1.default)(a).extract({left:t.x,top:t.y,width:t.width,height:t.height}).toFormat(sharp_1.default.format.png).toBuffer();i[e]=t})),i}async function _getFacesInEquirectangularProjected(e,t,a){var e=await(0,fs_extra_1.readFile)(e),e=await(0,sharp_1.default)(e),r=await e.metadata(),e=(t=t||0|(0,equirect_cubemap_faces_1.nearestPowerOfTwo)((r.width||0)/4),await(0,equirect_cubemap_faces_1.equirectToCubemapFaces)(e,t,{isRGBE:a}));if(6!==e.length)throw new Error("Failed to resolve equirectangular projection image.");return{right:await(0,sharp_1.default)(Buffer.from(e[0].data),{raw:{width:t,height:t,channels:4}}).toFormat(r.format||"png").toBuffer(),left:await(0,sharp_1.default)(Buffer.from(e[1].data),{raw:{width:t,height:t,channels:4}}).toFormat(r.format||"png").toBuffer(),top:await(0,sharp_1.default)(Buffer.from(e[2].data),{raw:{width:t,height:t,channels:4}}).toFormat(r.format||"png").toBuffer(),bottom:await(0,sharp_1.default)(Buffer.from(e[3].data),{raw:{width:t,height:t,channels:4}}).toFormat(r.format||"png").toBuffer(),front:await(0,sharp_1.default)(Buffer.from(e[4].data),{raw:{width:t,height:t,channels:4}}).toFormat(r.format||"png").toBuffer(),back:await(0,sharp_1.default)(Buffer.from(e[5].data),{raw:{width:t,height:t,channels:4}}).toFormat(r.format||"png").toBuffer()}}function getTop(e,t){return 0!=e&&0<t.length?t[0].height:0}function getLeft(t,a){if(t<verticalCount)return 0;let r=0;for(let e=verticalCount-1;e<a.length&&!(e>=t);e++)r+=a[e].width;return r}function getMipmapLayout(e){var t=[];let a=0;for(;e;)t.push({left:getLeft(a,t),top:getTop(a,t),width:e,height:e,level:a++}),e>>=1;return t}function getDirOfMipmaps(e,t){var a=(0,path_1.dirname)(e),e=(0,path_1.basename)(e,t);return(0,path_1.join)(a,e+"_convolution")}function isNeedConvolution(t){if(!(0,fs_extra_1.existsSync)(t))return!0;for(let e=0;e<6;e++){var a=(0,path_1.join)(t,"mipmap_"+e.toString()+".png");if(!(0,fs_extra_1.existsSync)(a))return!0}return!1}function saveMipmaps(e,t){(0,fs_extra_1.existsSync)(t)||(0,fs_extra_2.ensureDirSync)(t),(0,fs_extra_1.copyFileSync)(e,(0,path_1.join)(t,(0,path_1.basename)(e)))}function checkSize(e,t){return 4*e==3*t||3*e==4*t||6*e===t||e===6*t||e===2*t}!function(e){e[e.NONE=0]="NONE",e[e.AUTO=1]="AUTO",e[e.BAKED_CONVOLUTION_MAP=2]="BAKED_CONVOLUTION_MAP"}(MipmapMode=exports.MipmapMode||(exports.MipmapMode={})),exports.ERPTextureCubeHandler={name:"erp-texture-cube",assetType:"cc.TextureCube",importer:{version:"1.0.10",migrations:[{version:"1.0.9",migrate:migratesNameToId.migrate}],async import(a){0===Object.getOwnPropertyNames(a.userData).length&&a.assignUserData((0,utils_2.makeDefaultTextureCubeAssetUserData)(),!0);var r=a.userData,e=(0,asset_db_1.queryAsset)(r.imageDatabaseUri);if(!e)return!1;let t;var i=a.parent.extname?.toLowerCase();t=[".tga",".hdr",".bmp",".psd",".tif",".tiff",".exr"].includes(i)||!i?e.library+".png":e.source;var s=await(0,sharp_1.default)(t).metadata();const o=s.width;s=s.height;if(a.userData.mipBakeMode===MipmapMode.BAKED_CONVOLUTION_MAP){var u=a.parent.source;let t=(0,path_1.join)(a.temp,"mipmap");var n=getDirOfMipmaps(e.source,i),p=(isNeedConvolution(n)?(e=["--srcFaceSize","768","--mipatlas","--filter","radiance","--lightingModel","ggx","--excludeBase","true","--output0params",r.isRGBE?"png,rgbm,facelist":"png,bgra8,facelist","--input",u,"--output0",t],r.isRGBE&&![".hdr",".exr"].includes(i)&&e.splice(0,0,"--rgbm"),(0,fs_extra_2.ensureDirSync)(a.temp),console.log(`Start to bake asset {asset[${a.uuid}](${a.uuid})}`),u=(0,path_1.join)(Editor.App.path,"../tools/cmft/cmftRelease64")+("win32"===process.platform?".exe":""),await Editor.Utils.Process.quickSpawn(u,e,{stdio:"inherit"})):t=(0,path_1.join)(n,"mipmap"),["right","left","top","bottom","front","back"]),c={},f=[],l=a.getSwapSpace();for(let e=0;e<p.length;e++){var _=`${t}_${e}.png`,_=(saveMipmaps(_,n),(0,sharp_1.default)(_));const o=(await _.metadata()).width;f[e]=getMipmapLayout(o);var m=p[e],_=await _.toFormat(sharp_1.default.format.png).toBuffer(),_=(l[m]=_,await a.createSubAsset(m,"texture-cube-face"));c[m]=EditorExtends.serialize.asAsset(_.uuid,cc.ImageAsset)}const w=new cc.TextureCube,b=((0,texture_base_1.applyTextureBaseAssetUserData)(r,w),w.isRGBE=r.isRGBE,w._mipmapMode=MipmapMode.BAKED_CONVOLUTION_MAP,w._mipmapAtlas={atlas:c,layout:f[0]},EditorExtends.serialize(w)),x=(await a.saveToLibrary(".json",b),(0,utils_1.getDependUUIDList)(b));a.setData("depends",x)}else{let e;var i=(0,cube_map_simple_layout_1.matchSimpleLayout)(o,s),d=(e=i?await _getFacesInSimpleLayout(t,i):await _getFacesInEquirectangularProjected(t,0===r.faceSize?void 0:r.faceSize,r.isRGBE),{}),h=a.getSwapSpace();for(const v of Object.getOwnPropertyNames(e)){var g=e[v],g=(h[v]=g,await a.createSubAsset(v,"texture-cube-face"));d[v]=EditorExtends.serialize.asAsset(g.uuid,cc.ImageAsset)}const w=new cc.TextureCube,b=((0,texture_base_1.applyTextureBaseAssetUserData)(r,w),w.isRGBE=r.isRGBE,w._mipmaps=[d],EditorExtends.serialize(w)),x=(await a.saveToLibrary(".json",b),(0,utils_1.getDependUUIDList)(b));a.setData("depends",x)}return!0}}},exports.default=exports.ERPTextureCubeHandler,exports.checkSize=checkSize;