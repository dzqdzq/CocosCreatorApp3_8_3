"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrateChunkFolders=exports.migrateMacroUseBatching=exports.migrateCSMInclude=exports.migrateMacroUseLightMap=exports.migrateIncludeDecodeBase=exports.migrateDefines=exports.migrateEnableDirShadow=exports.recompileAllEffects=exports.afterImport=exports.EffectHandler=exports.autoGenEffectBinInfo=void 0;const asset_db_1=require("@editor/asset-db"),cc_1=require("cc"),custom_pipeline_1=require("cc/editor/custom-pipeline"),fs_extra_1=require("fs-extra"),path_1=require("path"),effect_compiler_1=require("../../../static/effect-compiler"),utils_1=require("../utils"),closure={root:"",dir:""},migrations=(effect_compiler_1.options.throwOnWarning=!0,effect_compiler_1.options.skipParserTest=!0,effect_compiler_1.options.getAlternativeChunkPaths=e=>[(0,path_1.relative)(closure.root,(0,path_1.resolve)(closure.dir,e)).replace(/\\/g,"/")],effect_compiler_1.options.chunkSearchFn=c=>{const n={name:void 0,content:void 0};return(0,asset_db_1.forEach)(a=>{if(void 0===n.content)for(let e=0;e<c.length;e++){var t=c[e],r=(0,path_1.resolve)(a.options.target,"chunks",t+".chunk");if((0,fs_extra_1.existsSync)(r)){n.name=t,n.content=(0,fs_extra_1.readFileSync)(r,{encoding:"utf-8"});break}}}),n},[{version:"1.3.7",migrate:migrateEditorProps},{version:"1.4.2",migrate:migrateUVAttribute},{version:"1.4.7",migrate:migrateStandardTransparent},{version:"1.4.8",migrate:migrateApplyFog},{version:"1.4.9",migrate:e=>{migrateMacroToFunction(e),migrateEnableDirShadow(e)}},{version:"1.5.0",migrate:migrateMacroToFunction},{version:"1.5.1",migrate:migrateShadowFactorParameter},{version:"1.5.2",migrate:migrateDefines},{version:"1.5.3",migrate:migrateIncludeDecodeBase},{version:"1.5.4",migrate:migrateSpecularIntensity},{version:"1.5.5",migrate:migrateUnpackLightingMap},{version:"1.5.6",migrate:migrateMacroUseLightMap},{version:"1.5.7",migrate:migrateChunkFolders},{version:"1.5.8",migrate:migrateCSMInclude},{version:"1.6.0",migrate:migrateMacroUseBatching},{version:"1.6.1",migrate:migrateGetLightingMapAlpha},{version:"1.7.1",migrate:migrateCalculatePlanarShadowClipPos}]);async function generateEffectAsset(t,e,a){var r=t._assetDB.options.target,e=(closure.root=(0,path_1.join)(r,"chunks"),closure.dir=(0,path_1.dirname)(e),(0,path_1.relative)((0,path_1.join)(r,"effects"),closure.dir).replace(/\\/g,"/")),r=e+(e.length?"/":"")+(0,path_1.basename)(a,(0,path_1.extname)(a)),e=(0,fs_extra_1.readFileSync)(a,{encoding:"utf-8"});const c=(0,effect_compiler_1.buildEffect)(r,e);(0,asset_db_1.forEach)(e=>{for(const a of c.dependencies)t.depend((0,path_1.resolve)(e.options.target,"chunks",a+".chunk"))});a=new cc_1.EffectAsset,Object.assign(a,c),c.editor&&c.editor.hide&&(a.hideInEditor=!0),t.userData&&(t.userData.combinations&&(a.combinations=t.userData.combinations),c.editor?t.userData.editor=c.editor:t.userData.editor=void 0),r=EditorExtends.serialize(a),await t.saveToLibrary(".json",r),e=(0,utils_1.getDependUUIDList)(r);t.setData("depends",e),exports.autoGenEffectBinInfo.waitingGenEffectBin=!0,t._assetDB.flag.started&&exports.autoGenEffectBinInfo.autoGenEffectBin&&(exports.autoGenEffectBinInfo.waitingGenEffectBinTimmer&&clearTimeout(exports.autoGenEffectBinInfo.waitingGenEffectBinTimmer),exports.autoGenEffectBinInfo.waitingGenEffectBinTimmer=setTimeout(()=>{afterImport()},500))}function _rebuildDescriptorHierarchy(e){var a=[];for(const r of e){var t=(0,path_1.join)(r.temp,"materialxxx.json");(0,fs_extra_1.existsSync)(t)||a.push(r)}return a}async function buildCustomLayout(e,a){var t=new custom_pipeline_1.VisibilityGraph;for(const o of e){var r=o.library+".json",r=await(0,fs_extra_1.readJSON)(r),r=cc.deserialize(r);t.mergeEffect(r)}var c=new custom_pipeline_1.LayoutGraphInfo(t);for(const i of e){var n=i.library+".json",n=await(0,fs_extra_1.readJSON)(n),n=cc.deserialize(n);c.addEffect(n)}c.build()&&console.error("build failed"),(0,custom_pipeline_1.buildLayoutGraphData)(c.lg,a)}async function afterImport(e){const a=[];(0,asset_db_1.forEach)(e=>{e.path2asset.forEach(e=>{"effect"===e.meta.importer&&a.push(e)})}),await recompileAllEffects(a,e)}async function recompileAllEffects(e,a){var t=(0,path_1.join)(Editor.Project.tmpDir,"asset-db/effect/effect.bin");!a&&!exports.autoGenEffectBinInfo.waitingGenEffectBin&&(0,fs_extra_1.existsSync)(t)||(e=e.filter(e=>e.imported),exports.autoGenEffectBinInfo.waitingGenEffectBin=!1,exports.autoGenEffectBinInfo.waitingGenEffectBinTimmer&&clearTimeout(exports.autoGenEffectBinInfo.waitingGenEffectBinTimmer),await buildCustomLayout(e,a=new custom_pipeline_1.LayoutGraphData),await(0,fs_extra_1.ensureDir)((0,path_1.dirname)(t)),e=new custom_pipeline_1.BinaryOutputArchive,(0,custom_pipeline_1.saveLayoutGraphData)(e,a),await(0,fs_extra_1.writeFile)(t,e.buffer),console.debug("recompile effect.bin success"))}exports.autoGenEffectBinInfo={autoGenEffectBin:!1,waitingGenEffectBin:!1,waitingGenEffectBinTimmer:null},exports.EffectHandler={name:"effect",assetType:"cc.EffectAsset",createInfo:{generateMenuInfo(){return[{label:"i18n:ENGINE.assets.newEffect",fullFileName:"effect.effect",template:`db://internal/default_file_content/${exports.EffectHandler.name}/default.effect`,group:"effect"},{label:"i18n:ENGINE.assets.newSurfaceEffect",fullFileName:"surface-effect.effect",template:`db://internal/default_file_content/${exports.EffectHandler.name}/effect-surface.effect`,group:"effect"}]}},open:utils_1.openCode,customOperationMap:{"build-effect":{async operator(e,a){try{return(0,effect_compiler_1.buildEffect)(e,a)}catch(e){return console.error(e),null}}},"add-chunk":{async operator(e,a){(0,effect_compiler_1.addChunk)(e,a)}}},importer:{version:"1.7.1",migrations:migrations,async import(e){try{return e instanceof asset_db_1.Asset?await generateEffectAsset(e,e.source,e.source):await generateEffectAsset(e,e.parent.source,e.parent.getFilePath(".effect")),!0}catch(e){return console.error(e),!1}}}},exports.default=exports.EffectHandler,exports.afterImport=afterImport,exports.recompileAllEffects=recompileAllEffects;const inspectorRE=/inspector\s*:/g;function migrateEditorProps(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});a=a.replace(inspectorRE,"editor:"),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}const UVAttribute=/in\s*vec2\s*a_texCoord\s*;/,inputIncludeRE=/include.*input/;function migrateUVAttribute(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});a.match(inputIncludeRE)&&(a=a.replace(UVAttribute,"")),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}const MacroStandardTransparent=/CC_STANDARD_TRANSPARENT/g,ReplaceTransparentWithForward="CC_FORCE_FORWARD_SHADING";function migrateStandardTransparent(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});a.match(MacroStandardTransparent)&&(a=a.replace(MacroStandardTransparent,ReplaceTransparentWithForward)),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}const MacroApplyFog=/[a-zA-Z_][a-zA-Z_0-9]*\s*=\s*CC_APPLY_FOG/g,ReplaceApplyFog="CC_APPLY_FOG",MacroTransferFog=/[a-zA-Z_][a-zA-Z_0-9]*\s*=\s*CC_TRANSFER_FOG/g,ReplaceTransferFog="CC_TRANSFER_FOG";function migrateApplyFog(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});(a=a.match(MacroApplyFog)?a.replace(MacroApplyFog,ReplaceApplyFog):a).match(MacroTransferFog)&&(a=a.replace(MacroTransferFog,ReplaceTransferFog)),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}const MacroEnableDirShadow=/&&\s*CC_ENABLE_DIR_SHADOW/g,ReplaceEnableDirShadow="";function migrateEnableDirShadow(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});a.match(MacroEnableDirShadow)&&(a=a.replace(MacroEnableDirShadow,ReplaceEnableDirShadow)),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}exports.migrateEnableDirShadow=migrateEnableDirShadow;const MacroShadowFactor=/CC_SHADOW_FACTOR\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceShadowFactor="$1 = CCShadowFactorBase(CC_SHADOW_POSITION, $2)",MacroShadowFactorBase=/CC_SHADOW_FACTOR_BASE\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceShadowFactorBase="$1 = CCShadowFactorBase($2, $3)",MacroSpotShadowFactor=/CC_SPOT_SHADOW_FACTOR\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceSpotShadowFactor="$1 = CCSpotShadowFactorBase(CC_SHADOW_POSITION, $2)",MacroSpotShadowFactorBase=/CC_SPOT_SHADOW_FACTOR_BASE\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceSpotShadowFactorBase="$1 = CCSpotShadowFactorBase($2, $3)";function migrateMacroToFunction(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});(a=(a=(a=a.match(MacroShadowFactorBase)?a.replace(MacroShadowFactorBase,ReplaceShadowFactorBase):a).match(MacroShadowFactor)?a.replace(MacroShadowFactor,ReplaceShadowFactor):a).match(MacroSpotShadowFactorBase)?a.replace(MacroSpotShadowFactorBase,ReplaceSpotShadowFactorBase):a).match(MacroSpotShadowFactor)&&(a=a.replace(MacroSpotShadowFactor,ReplaceSpotShadowFactor)),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}const ShadowFactorBaseParameter=/CCShadowFactorBase\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceShadowFactorBaseParameter="CCShadowFactorBase($1, $2, vec2(0.0, 0.0))",SpotShadowFactorBaseParameter=/CCSpotShadowFactorBase\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceSpotShadowFactorBaseParameter="CCSpotShadowFactorBase($1, $2, vec2(0.0, 0.0))";function migrateShadowFactorParameter(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});(a=a.match(ShadowFactorBaseParameter)?a.replace(ShadowFactorBaseParameter,ReplaceShadowFactorBaseParameter):a).match(SpotShadowFactorBaseParameter)&&(a=a.replace(SpotShadowFactorBaseParameter,ReplaceSpotShadowFactorBaseParameter)),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}const DefineMetaRE=/#pragma\s+define\s+/g,DefineRE=/#define/g;function migrateDefines(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});a=(a=a.replace(DefineMetaRE,"#pragma define-meta ")).replace(DefineRE,"#pragma define"),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}exports.migrateDefines=migrateDefines;const IncludeLocalBatch1=/(\s*)#include\s*<cc-local-batch>/g,IncludeLocalBatch2=/(\s*)#include\s*"cc-local-batch"/g,ReplaceIncludeLocalBatch="$1#include <decode-base>$1#include <cc-local-batch>";function migrateIncludeDecodeBase(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});(a=a.match(IncludeLocalBatch1)?a.replace(IncludeLocalBatch1,ReplaceIncludeLocalBatch):a).match(IncludeLocalBatch2)&&(a=a.replace(IncludeLocalBatch2,ReplaceIncludeLocalBatch)),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}exports.migrateIncludeDecodeBase=migrateIncludeDecodeBase;const MetallicParam=/(\s*)s.metallic\s*=/g,ReplaceMetallicParam="$1s.specularIntensity = 0.5;$1s.metallic =";function migrateSpecularIntensity(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});a.match(MetallicParam)&&(a=a.replace(MetallicParam,ReplaceMetallicParam)),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}const UnpackLightingMap=/UnpackLightingmap\s*\(\s*([\w.\[\]]+)\s*\)/g,ReplaceUnpackLightingMap="$1.rgb";function migrateUnpackLightingMap(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});a.match(UnpackLightingMap)&&(a=a.replace(UnpackLightingMap,ReplaceUnpackLightingMap)),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}const UseLightMap=/(\s+)USE_LIGHTMAP/g,ReplaceUseLightMap="$1CC_USE_LIGHTMAP";function migrateMacroUseLightMap(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});a.match(UseLightMap)&&(a=a.replace(UseLightMap,ReplaceUseLightMap)),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}exports.migrateMacroUseLightMap=migrateMacroUseLightMap;const CCShadow=/(\s*)#include\s*<builtin\/uniforms\/cc-shadow>/g,ReplaceCCShadow="$1#include <builtin/uniforms/cc-shadow>\n#if CC_SUPPORT_CASCADED_SHADOW_MAP\n  #include <builtin/uniforms/cc-csm>\n#endif";function migrateCSMInclude(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});a.match(CCShadow)&&(a=a.replace(CCShadow,ReplaceCCShadow)),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}exports.migrateCSMInclude=migrateCSMInclude;const CCBatching=/&&\s+!USE_BATCHING\s*/g;function migrateMacroUseBatching(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});a.match(CCBatching)&&(a=a.replace(CCBatching,"")),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}exports.migrateMacroUseBatching=migrateMacroUseBatching;const UseShadingStandBaseInclude=/#include.*standard-surface-entry/g,GetLightingMapAlpha1=/(\s*)s.lightmap.rgb\s*=\s*([a-zA-Z]+)/g,GetLightingMapAlpha2=/(\s*)s.lightmap\s*=\s*([a-zA-Z]+)/g,ReplaceGetLightingMapAlpha="$1s.lightmap.a = $2.a;$1s.lightmap.rgb = $2";function migrateGetLightingMapAlpha(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});a.match(UseShadingStandBaseInclude)&&(a=a.match(GetLightingMapAlpha1)?a.replace(GetLightingMapAlpha1,ReplaceGetLightingMapAlpha):a).match(GetLightingMapAlpha2)&&(a=a.replace(GetLightingMapAlpha2,ReplaceGetLightingMapAlpha)),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}function migrateChunkFolders(e){var a,t,r,c,n=new Map([["cc-fog-base","legacy/fog-base"],["cc-shadow-map-base","legacy/shadow-map-base"],["morph","legacy/morph"],["cc-skinning","legacy/skinning"],["cc-local-batch","legacy/local-batch"],["lighting","legacy/lighting"],["lightingmap-fs","legacy/lightingmap-fs"],["cc-shadow-map-vs","legacy/shadow-map-vs"],["cc-shadow-map-fs","legacy/shadow-map-fs"],["cc-fog-vs","legacy/fog-vs"],["cc-fog-fs","legacy/fog-fs"],["lightingmap-vs","legacy/lightingmap-vs"],["decode","legacy/decode"],["decode-base","legacy/decode-base"],["decode-standard","legacy/decode-standard"],["input","legacy/input"],["input-standard","legacy/input-standard"],["output","legacy/output"],["output-standard","legacy/output-standard"],["shading-standard","legacy/shading-standard"],["shading-standard-base","legacy/shading-standard-base"],["shading-standard-additive","legacy/shading-standard-additive"],["shading-cluster-additive","legacy/shading-cluster-additive"],["shading-toon","legacy/shading-toon"],["standard-surface-entry","legacy/standard-surface-entry"],["alpha-test","builtin/internal/alpha-test"],["cc-sprite-common","builtin/internal/sprite-common"],["cc-sprite-texture","builtin/internal/sprite-texture"],["embedded-alpha","builtin/internal/embedded-alpha"],["particle-common","builtin/internal/particle-common"],["cc-global","builtin/uniforms/cc-global"],["cc-local","builtin/uniforms/cc-local"],["cc-forward-light","builtin/uniforms/cc-forward-light"],["cc-environment","builtin/uniforms/cc-environment"],["cc-diffusemap","builtin/uniforms/cc-diffusemap"],["cc-shadow","builtin/uniforms/cc-shadow"],["cc-csm","builtin/uniforms/cc-csm"],["cc-world-bound","builtin/uniforms/cc-world-bound"],["builtin/uniforms/cc-skinning-uniforms","builtin/uniforms/cc-skinning"],["common","common/common-define"],["texture-lod","common/texture/texture-lod"],["packing","common/data/packing"],["unpack","common/data/unpack"],["aces","common/color/aces"],["gamma","common/color/gamma"],["octahedron-transform","common/math/octahedron-transform"],["transform","common/math/transform"],["rect-area-light","common/lighting/rect-area-light"],["fxaa","post-process/fxaa"],["anti-aliasing","post-process/anti-aliasing"]]),o=new Map([["vert:\\s+particle-vs-gpu","vert: builtin/internal/particle-vs-gpu"],["vert:\\s+particle-vs-legacy","vert: builtin/internal/particle-vs-legacy"],["vert:\\s+particle-trail","vert: builtin/internal/particle-trail"],["vert:\\s+outline-vs","vert: legacy/main-functions/outline-vs"],["frag:\\s+outline-fs","frag: legacy/main-functions/outline-fs"],["vert:\\s+general-vs","vert: legacy/main-functions/general-vs"],["CCGetShadowFactorSoft2X","CCGetDirLightShadowFactorSoft3X"],["CCGetShadowFactorSoft","CCGetDirLightShadowFactorSoft"],["CCGetShadowFactorHard","CCGetDirLightShadowFactorHard"],["CCGetSpotLightShadowFactorSoft2X","CCGetSpotLightShadowFactorSoft3X"]]);let i=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"}),s=!1;for([a,t]of n){var l=new RegExp("#include\\s+<"+a+">","g"),f=new RegExp('#include\\s+"'+a+'"',"g"),d="#include <"+t+">";i.match(l)&&(i=i.replace(l,d),s=!0),i.match(f)&&(i=i.replace(f,d),s=!0)}for([r,c]of o){var p=new RegExp(r,"g"),g=c;i.match(p)&&(i=i.replace(p,g),s=!0)}s&&(0,fs_extra_1.writeFileSync)(e.source,i,{encoding:"utf8"})}exports.migrateChunkFolders=migrateChunkFolders;const FindCalculatePlanarShadowClipPos=/(.*)\s*=\s*cc_matProj\s*\*\s*cc_matView\s*\*\s*vec4\((.*).xyz,\s*1.0\);/g,ReplaceCalculatePlanarShadowClipPos="$1 = CalculatePlanarShadowClipPos($2, cc_cameraPos.xyz, cc_matView, cc_matProj, cc_nearFar);";function migrateCalculatePlanarShadowClipPos(e){let a=(0,fs_extra_1.readFileSync)(e.source,{encoding:"utf8"});a.match(FindCalculatePlanarShadowClipPos)&&(a=a.replace(FindCalculatePlanarShadowClipPos,ReplaceCalculatePlanarShadowClipPos)),(0,fs_extra_1.writeFileSync)(e.source,a,{encoding:"utf8"})}