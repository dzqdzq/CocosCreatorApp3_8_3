"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,i)}:function(e,t,r,a){e[a=void 0===a?r:a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports._parseRect=exports._parseFloat2=exports.TexturePackerHandler=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),migratesNameToId=__importStar(require("./migrates/name2id")),cc_1=require("cc"),utils_1=require("../utils"),utils_2=require("./image/utils"),plist=require("plist");function fillFrameData(e,t){var r=t.format,t=(0,utils_2.makeDefaultSpriteFrameAssetUserDataFromImageUuid)(t.textureUuid,t.uuid);let a=!1,i="",s="",o="";1===r||2===r?(a=e.rotated,i=e.sourceSize,s=e.offset,o=e.frame):3===r&&(a=e.textureRotated,i=e.spriteSourceSize,s=e.spriteOffset,o=e.textureRect),t.rotated=a;r=_parseFloat2(i,cc_1.Size),t.rawWidth=r.width,t.rawHeight=r.height,e=_parseRect(o),t.trimX=e.x,t.trimY=e.y,t.width=e.width,t.height=e.height,r=_parseFloat2(s,cc_1.Vec2);return t.offsetX=r.x,t.offsetY=r.y,t}exports.TexturePackerHandler={name:"sprite-atlas",assetType:"cc.SpriteAtlas",importer:{version:"1.0.8",migrations:[{version:"1.0.4",migrate:migratesNameToId.migrate}],async import(e){var t=e.userData,r=await(0,fs_extra_1.readFile)(e.source,"utf8"),a=plist.parse(r),r=a.metadata;if(t.atlasTextureName=r.realTextureFileName||r.textureFileName,t.format=r.format,t.uuid=e.uuid,e._assetDB){r=(0,path_1.basename)(t.atlasTextureName),r=(0,path_1.join)((0,path_1.dirname)(e.source),r),r=((0,fs_extra_1.existsSync)(r)||console.warn("Parse Error: Unable to find file Texture, the path: "+r),e.depend(r),e._assetDB.pathToUuid(r));if(!r)return!1;t.textureUuid=r+"@"+require("@editor/asset-db/libs/utils").nameToId("texture")}if(e.userData.textureUuid&&e._assetDB){var i=/\.[^.]+$/,r=Object.keys(a.frames),s=new cc.SpriteAtlas;s.name=e.basename||"";for(const n of r){var o=n.replace(i,""),u=a.frames[n],l=await e.createSubAsset(o,"sprite-frame"),u=fillFrameData(u,t);u.borderBottom=u.borderBottom|l.userData.borderBottom,u.borderTop=u.borderTop|l.userData.borderTop,u.borderLeft=u.borderLeft|l.userData.borderLeft,u.borderRight=u.borderRight|l.userData.borderRight,"packable"in l.userData&&(u.packable=l.userData.packable),l.assignUserData(u,!0),l.userData.imageUuidOrDatabaseUri=u.imageUuidOrDatabaseUri,s.spriteFrames[o]=EditorExtends.serialize.asAsset(l.uuid,cc_1.SpriteFrame)}r=EditorExtends.serialize(s),r=(await e.saveToLibrary(".json",r),(0,utils_1.getDependUUIDList)(r));e.setData("depends",r)}return!0}},async validate(e){try{var t=plist.parse(await(0,fs_extra_1.readFile)(e.source,"utf8"));return void 0!==t.frames&&void 0!==t.metadata}catch(e){return!1}}},exports.default=exports.TexturePackerHandler;const BRACE_REGEX=/[\{\}]/g;function _parseFloat2(e,t){e=e.slice(1,-1).split(",");return new t(parseFloat(e[0]),parseFloat(e[1]))}function _parseRect(e){e=(e=e.replace(BRACE_REGEX,"")).split(",");return new cc_1.Rect(parseFloat(e[0]||"0"),parseFloat(e[1]||"0"),parseFloat(e[2]||"0"),parseFloat(e[3]||"0"))}exports._parseFloat2=_parseFloat2,exports._parseRect=_parseRect;