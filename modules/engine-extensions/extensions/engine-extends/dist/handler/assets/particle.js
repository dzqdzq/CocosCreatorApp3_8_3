"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ParticleHandler=void 0;const image_utils_1=require("./utils/image-utils"),fs_extra_1=require("fs-extra"),path_1=require("path"),cc_1=require("cc"),utils_1=require("../utils"),BlendFactor=cc_1.gfx.BlendFactor,{PositionType,EmitterMode}=cc_1.ParticleSystem2D,plist=require("plist"),defaultParticlesUseData={totalParticles:150,life:1,lifeVar:0,emissionRate:10,duration:-1,srcBlendFactor:BlendFactor.SRC_ALPHA,dstBlendFactor:BlendFactor.ONE_MINUS_CONSTANT_ALPHA,startColor:new cc_1.Color(255,255,255,255),startColorVar:new cc_1.Color(0,0,0,0),endColor:new cc_1.Color(255,255,255,0),endColorVar:new cc_1.Color(0,0,0,0),startSize:50,startSizeVar:0,endSize:0,endSizeVar:0,positionType:PositionType.FREE,sourcePos:new cc_1.Vec2(0,0),posVar:new cc_1.Vec2(0,0),angle:90,angleVar:20,startSpin:0,startSpinVar:0,endSpin:0,endSpinVar:0,emitterMode:EmitterMode.GRAVITY,gravity:new cc_1.Vec2(0,0),speed:180,speedVar:50,radialAccel:80,radialAccelVar:0,tangentialAccel:0,tangentialAccelVar:0,rotationIsDir:!1,startRadius:0,startRadiusVar:0,endRadius:0,endRadiusVar:0,rotatePerS:0,rotatePerSVar:0,spriteFrameUuid:""};function getBlendFactor2DTo3D(e){switch(e){case 0:return BlendFactor.ZERO;case 1:return BlendFactor.ONE;case 770:return BlendFactor.SRC_ALPHA;case 772:return BlendFactor.DST_ALPHA;case 771:return BlendFactor.ONE_MINUS_SRC_ALPHA;case 773:return BlendFactor.ONE_MINUS_DST_ALPHA;case 768:return BlendFactor.SRC_COLOR;case 774:return BlendFactor.DST_COLOR;case 769:return BlendFactor.ONE_MINUS_SRC_COLOR;case 775:return BlendFactor.ONE_MINUS_DST_COLOR}return e}function createParticle(e){var a=new cc.ParticleAsset;return a.name=e.basename,a._setRawAsset(e.extname),a}async function syncParticleData(a){var r=a.userData,a=plist.parse(await(0,fs_extra_1.readFile)(a.source,"utf8")),t=(r.totalParticles=parseInt(a.maxParticles||0),r.life=parseFloat(a.particleLifespan||0),r.lifeVar=parseFloat(a.particleLifespanVariance||0),r.emissionRate=a.emissionRate||Math.min(r.totalParticles/r.life,Number.MAX_VALUE),r.duration=parseFloat(a.duration||0),r.srcBlendFactor=parseInt(a.blendFuncSource||BlendFactor.SRC_ALPHA),r.dstBlendFactor=parseInt(a.blendFuncDestination||BlendFactor.ONE_MINUS_SRC_ALPHA),r.startColor),t=(t.r=255*parseFloat(a.startColorRed||0),t.g=255*parseFloat(a.startColorGreen||0),t.b=255*parseFloat(a.startColorBlue||0),t.a=255*parseFloat(a.startColorAlpha||0),r.startColorVar),t=(t.r=255*parseFloat(a.startColorVarianceRed||0),t.g=255*parseFloat(a.startColorVarianceGreen||0),t.b=255*parseFloat(a.startColorVarianceBlue||0),t.a=255*parseFloat(a.startColorVarianceAlpha||0),r.endColor),t=(t.r=255*parseFloat(a.finishColorRed||0),t.g=255*parseFloat(a.finishColorGreen||0),t.b=255*parseFloat(a.finishColorBlue||0),t.a=255*parseFloat(a.finishColorAlpha||0),r.endColorVar),t=(t.r=255*parseFloat(a.finishColorVarianceRed||0),t.g=255*parseFloat(a.finishColorVarianceGreen||0),t.b=255*parseFloat(a.finishColorVarianceBlue||0),t.a=255*parseFloat(a.finishColorVarianceAlpha||0),r.startSize=parseFloat(a.startParticleSize||0),r.startSizeVar=parseFloat(a.startParticleSizeVariance||0),r.endSize=parseFloat(a.finishParticleSize||0),r.endSizeVar=parseFloat(a.finishParticleSizeVariance||0),r.positionType=parseFloat(void 0!==a.positionType?a.positionType:0),r.sourcePos=new cc_1.Vec2(0,0),parseFloat(a.sourcePositionVariancex||0)),i=parseFloat(a.sourcePositionVariancey||0);if(r.posVar=new cc_1.Vec2(t,i),r.angle=parseFloat(a.angle||0),r.angleVar=parseFloat(a.angleVariance||0),r.startSpin=parseFloat(a.rotationStart||0),r.startSpinVar=parseFloat(a.rotationStartVariance||0),r.endSpin=parseFloat(a.rotationEnd||0),r.endSpinVar=parseFloat(a.rotationEndVariance||0),r.emitterMode=parseInt(a.emitterType||0),r.emitterMode===EmitterMode.GRAVITY){t=parseFloat(a.gravityx||0),i=parseFloat(a.gravityy||0);r.gravity=new cc_1.Vec2(t,i),r.speed=parseFloat(a.speed||0),r.speedVar=parseFloat(a.speedVariance||0),r.radialAccel=parseFloat(a.radialAcceleration||0),r.radialAccelVar=parseFloat(a.radialAccelVariance||0),r.tangentialAccel=parseFloat(a.tangentialAcceleration||0),r.tangentialAccelVar=parseFloat(a.tangentialAccelVariance||0);let e=a.rotationIsDir||"";null!==e?(e=e.toString().toLowerCase(),r.rotationIsDir="true"===e||"1"===e):r.rotationIsDir=!1}else r.emitterMode===EmitterMode.RADIUS&&(r.startRadius=parseFloat(a.maxRadius||0),r.startRadiusVar=parseFloat(a.maxRadiusVariance||0),r.endRadius=parseFloat(a.minRadius||0),r.endRadiusVar=parseFloat(a.minRadiusVariance||0),r.rotatePerS=parseFloat(a.rotatePerSecond||0),r.rotatePerSVar=parseFloat(a.rotatePerSecondVariance||0))}exports.ParticleHandler={name:"particle",assetType:"cc.ParticleAsset",async validate(e){try{return void 0!==plist.parse(await(0,fs_extra_1.readFile)(e.source,"utf8")).maxParticles}catch(e){return!1}},importer:{version:"1.0.2",async import(e){const a=e.userData;Object.keys(defaultParticlesUseData).forEach(e=>{e in a||(a[e]=defaultParticlesUseData[e])});var r=(0,path_1.extname)(e.source);if(!await e.existsInLibrary(".json")&&e._assetDB){var t=plist.parse(await(0,fs_extra_1.readFile)(e.source,"utf8")),i=(await syncParticleData(e),createParticle(e));if(t.blendFuncSource&&(t.blendFuncSource=getBlendFactor2DTo3D(t.blendFuncSource)),t.blendFuncDestination&&(t.blendFuncDestination=getBlendFactor2DTo3D(t.blendFuncDestination)),t.textureImageData)delete t.textureFileName,delete t.spriteFrameUuid;else if(t.spriteFrameUuid)t.spriteFrameUuid.endsWith("@f9941")||(t.spriteFrameUuid=t.spriteFrameUuid+"@f9941"),e.depend(t.spriteFrameUuid),a.spriteFrameUuid=t.spriteFrameUuid,i.spriteFrame=EditorExtends.serialize.asAsset(t.spriteFrameUuid,cc_1.SpriteFrame),delete t.textureFileName,delete t.textureImageData;else if(t.textureFileName){var s=(0,path_1.basename)(t.textureFileName),s=(0,path_1.join)((0,path_1.dirname)(e.source),s),o=(e.depend(s),e._assetDB.pathToUuid(s));if(!(0,fs_extra_1.existsSync)(s))return console.error("Particle import failed: Unable to find file Texture, the path: "+s),!1;if(!o)return!1;s=e._assetDB.getAsset(o),s=(await(0,image_utils_1.changeImageDefaultType)(s,"sprite-frame"),o+"@f9941");i.spriteFrame=EditorExtends.serialize.asAsset(s,cc_1.SpriteFrame),a.spriteFrameUuid=s,t.spriteFrameUuid=s,delete t.textureFileName,delete t.textureImageData}o=plist.build(t),s=(await e.saveToLibrary(r,o),EditorExtends.serialize(i)),t=(await e.saveToLibrary(".json",s),(0,utils_1.getDependUUIDList)(s));e.setData("depends",t)}return!0}}},exports.default=exports.ParticleHandler;