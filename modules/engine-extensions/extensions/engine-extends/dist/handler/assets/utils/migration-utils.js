"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrationHook=exports.Archive=void 0;const fs_extra_1=__importDefault(require("fs-extra")),archiveProxyWatchedTag=Symbol("ArchiveProxyWatched");class Archive{constructor(e=null){deIndex(e,e),this._originalData=e,this._root=Array.isArray(e)?e[0]:e;const o={get(e,r,t){return r===archiveProxyWatchedTag||null==(e=Reflect.get(e,r,t))||"object"!=typeof e?e:(r=void 0!==e[refTag]?e[refTag]:e,new Proxy(r,o))},set(e,r,t,o){var a="object"==typeof t&&t?t[archiveProxyWatchedTag]??t:t,t=!Array.isArray(t)&&"object"==typeof t&&t?{[refTag]:a}:a;return Reflect.set(e,r,t,o)}};this._proxyHandler=o}get root(){return new Proxy(this._root,this._proxyHandler)}get(e){var e="object"==typeof e&&e?e[archiveProxyWatchedTag]??e:this._root,r=[e];return reIndex(e,r),1===r.length?r[0]:r}addObject(){return new Proxy({},this._proxyHandler)}addTypedObject(e){return new Proxy({__type__:e},this._proxyHandler)}visitTypedObject(e,r){var t=new Set;this._visitTypedObject(e,r,this._root,t)}clearObject(e){for(const r of Object.keys(e))"__type__"!==r&&delete e[r]}_visitTypedObject(r,t,e,o){if(Array.isArray(e))e.forEach(e=>{this._visitTypedObject(r,t,e,o)});else if(e&&"object"==typeof e)if(e[refTag])this._visitTypedObject(r,t,e[refTag],o);else if(!o.has(e)){o.add(e),e.__type__===r&&t(new Proxy(e,this._proxyHandler));for(const a of Object.values(e))this._visitTypedObject(r,t,a,o)}}}exports.Archive=Archive;const refTag=Symbol("Ref");function deIndex(e,r){var t;Array.isArray(e)?e.forEach(e=>{deIndex(e,r)}):e&&"object"==typeof e&&("number"==typeof e.__id__?(t=e.__id__,e[refTag]=r[t]):Object.values(e).forEach(e=>deIndex(e,r)))}function reIndex(e,r){var t,o,a;Array.isArray(e)?e.forEach(e=>{reIndex(e,r)}):e&&"object"==typeof e&&((o=(t=e)[refTag])?0<=(a=r.indexOf(o))?t.__id__=a:(t.__id__=r.length,r.push(o),reIndex(o,r)):Object.values(e).forEach(e=>reIndex(e,r)))}exports.migrationHook={async pre(e){e.getSwapSpace().json=await fs_extra_1.default.readJSON(e.source)},async post(e,r){var t=e.getSwapSpace();0<r&&(r=JSON.stringify(t.json,null,2),await fs_extra_1.default.writeFile(e.source,r)),delete t.json}};