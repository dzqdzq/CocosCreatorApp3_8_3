"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.convert=void 0;const child_process_1=__importDefault(require("child_process")),fs_extra_1=__importDefault(require("fs-extra")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),rimraf_1=__importDefault(require("rimraf")),utils_1=require("../../utils");function convert(c,h,x=[]){return new Promise((s,o)=>{try{var r=path_1.default.dirname(require.resolve("@cocos/fbx2gltf")),i="Windows_NT"===os_1.default.type()?".exe":"";let e=path_1.default.join(r,"bin",os_1.default.type(),"FBX2glTF"+i);var n=e.replace("app.asar","app.asar.unpacked");if(fs_extra_1.default.existsSync(n)&&(e=n),!fs_extra_1.default.existsSync(e))throw new Error("Unsupported OS: "+os_1.default.type());let t="";if(h.endsWith(".glb"))t=".glb",x.includes("--binary")||x.push("--binary");else{if(!h.endsWith(".gltf"))throw new Error("Unsupported file extension: "+h);t=".gltf"}0!==t.length&&fs_extra_1.default.ensureDirSync(path_1.default.dirname(h));const d=fs_extra_1.default.realpathSync(c);var l=path_1.default.dirname(d);const p=h;var u=path_1.default.basename(d),_=x.slice(0),f=(_.push("--input",u,"--output",p),child_process_1.default.spawn(e,_,{cwd:l}));let a="";f.stdout&&f.stdout.on("data",e=>a+=e),f.stderr&&f.stderr.on("data",e=>a+=e),f.on("error",o),f.on("close",e=>{const t=d.replace(/.fbx$/i,".fbm");var r=e=>e&&console.warn(`Failed to delete ${t}: `+e);try{fs_extra_1.default.existsSync(t)&&(0,rimraf_1.default)(t,{},r)}catch(e){r(e)}0!==e?o(new Error((0,utils_1.i18nTranslate)("asset-db.importers.fbx.fbx2glTF_exists_with_non_zero_code",{code:e,output:a.length?a:"<none>"}))):s(p)})}catch(e){o(e)}})}exports.convert=convert;