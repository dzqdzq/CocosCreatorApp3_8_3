"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,a,n){void 0===n&&(n=a);var r=Object.getOwnPropertyDescriptor(e,a);r&&("get"in r?e.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return e[a]}}),Object.defineProperty(t,n,r)}:function(t,e,a,n){t[n=void 0===n?a:n]=e[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var a in t)"default"!==a&&Object.prototype.hasOwnProperty.call(t,a)&&__createBinding(e,t,a);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GlTFTrsTrackData=exports.GlTFTrsAnimationData=void 0;const glTF_constants_1=require("./glTF.constants"),cc=__importStar(require("cc")),exotic_animation_1=require("cc/editor/exotic-animation");class GlTFTrsAnimationData{constructor(){this.nodes={},this.inputs=[]}addNodeAnimation(t){return this.nodes[t]??=new GlTFNodeTrsAnimationData}createExotic(){var t,e,a=new exotic_animation_1.ExoticAnimation;for([t,e]of Object.entries(this.nodes))e.emitExotic(a,t);return a}}exports.GlTFTrsAnimationData=GlTFTrsAnimationData;const INPUT_0=new Float32Array([0]);class GlTFNodeTrsAnimationData{constructor(){this.position=null,this.rotation=null,this.scale=null}setConstantPosition(t){this.position=new GlTFTrsTrackData(glTF_constants_1.GlTfAnimationInterpolation.STEP,INPUT_0,cc.Vec3.toArray(new Float32Array(3),t))}setConstantRotation(t){this.rotation=new GlTFTrsTrackData(glTF_constants_1.GlTfAnimationInterpolation.STEP,INPUT_0,cc.Quat.toArray(new Float32Array(4),t))}setConstantScale(t){this.scale=new GlTFTrsTrackData(glTF_constants_1.GlTfAnimationInterpolation.STEP,INPUT_0,cc.Vec3.toArray(new Float32Array(3),t))}emitExotic(t,e){var{position:a,rotation:n,scale:r}=this;(a||n||r)&&(t=t.addNodeAnimation(e),a&&({input:e,output:a}=a.toLinearVec3Curve(30),t.createPosition(e,a)),n&&({input:e,output:a}=n.toLinearQuatCurveNormalized(30),t.createRotation(e,a)),r)&&({input:n,output:e}=r.toLinearVec3Curve(30),t.createScale(n,e))}}class GlTFTrsTrackData{constructor(t,e,a){this.interpolation=t,this.input=e,this.output=a}toLinearVec3Curve(t){switch(this.interpolation){case glTF_constants_1.GlTfAnimationInterpolation.CUBIC_SPLINE:return cubicSplineToLinearCurveData(this.input,this.output,3,t);case glTF_constants_1.GlTfAnimationInterpolation.STEP:return constantToLinearCurveData(this.input,this.output,3,t);default:return{input:this.input,output:this.output}}}toLinearQuatCurveNormalized(t){var t=this.toLinearQuatCurve(t),e=t["output"],a=new cc.Quat;for(let t=0;t<e.length/4;++t)cc.Quat.fromArray(a,e,4*t),cc.Quat.normalize(a,a),cc.Quat.toArray(e,a,4*t);return t}toLinearQuatCurve(t){switch(this.interpolation){case glTF_constants_1.GlTfAnimationInterpolation.CUBIC_SPLINE:return cubicSplineToLinearCurveData(this.input,this.output,4,t);case glTF_constants_1.GlTfAnimationInterpolation.STEP:return constantToLinearCurveData(this.input,this.output,4,t);default:return{input:this.input,output:this.output}}}}function calculateBakeParams(t,e){var a=t[0],t=t[t.length-1],e=1/e;return{startTime:a,endTime:t,interval:e,count:(t-a)/e}}function createTimesFromBakeParams(t,e){const{startTime:a,endTime:n,interval:r,count:o}=t;return e.from({length:o},(t,e)=>e===o-1?n:a+r*e)}function constantToLinearCurveData(t,n,r,e){if(t.length<2)return{input:t,output:n};var o=n.length/r,i=calculateBakeParams(t,e),u=new Float32Array(r*i.count);for(let a=0;a<r;++a){var s=new cc.RealCurve;s.assignSorted(Array.from(t),Array.from({length:o},(t,e)=>({value:n[r*e+a],interpolationMode:cc.RealInterpolationMode.CONSTANT}))),bake(s,i,u,r,a)}return{input:createTimesFromBakeParams(i,Float32Array),output:u}}function cubicSplineToLinearCurveData(t,r,o,e){if(t.length<2)return{input:t,output:r};var a=r.length/(3*o),i=calculateBakeParams(t,e),u=new Float32Array(o*i.count);for(let n=0;n<o;++n){var s=new cc.RealCurve;s.assignSorted(Array.from(t),Array.from({length:a},(t,e)=>{var e=3*o*e+n,a=r[e+0*o];return{value:r[e+ +o],leftTangent:a,rightTangent:r[e+2*o],interpolationMode:cc.RealInterpolationMode.CUBIC}})),bake(s,i,u,o,n)}return{input:createTimesFromBakeParams(i,Float32Array),output:u}}function bake(e,t,a,n,r){var{startTime:t,endTime:o,interval:i,count:u}=t;let s=t;for(let t=0;t<u;++t,s+=i){var c=e.evaluate(t===u-1?o:s);a[n*t+r]=c}}exports.GlTFTrsTrackData=GlTFTrsTrackData;