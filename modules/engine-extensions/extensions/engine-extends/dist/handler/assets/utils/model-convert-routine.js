"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.modelConvertRoutine=void 0;const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path"));async function modelConvertRoutine(t,e,a,i,r){var a=path_1.default.join(a.options.temp,t,e.uuid),t=(await fs_extra_1.default.ensureDir(a),(await fs_extra_1.default.stat(e.source)).mtimeMs),u=path_1.default.join(a,"status.json");let s;try{s=await fs_extra_1.default.readJson(u)}catch(t){console.debug(`Status file ${u}: `+t)}var a=path_1.default.join(a,"output"),o=(await fs_extra_1.default.ensureDir(a),r.options);if(!(void 0!==s&&s.version===i&&s.sourceTimeStamp===t&&validateOptions(o,s.options)&&await isOutputTimeStampsAvailable(a,s.outputTimeStamps))){if(await fs_extra_1.default.emptyDir(a),!await r.convert(e,a))return;var n={},i=(await getMtimeTree(a,n),{version:i,sourceTimeStamp:t,outputTimeStamps:n,options:o});await fs_extra_1.default.ensureDir(path_1.default.dirname(u)),await fs_extra_1.default.writeJson(u,i,{spaces:2})}return await r.printLogs?.(e,a),r.get(e,a)}async function getMtimeTree(i,r,u=void 0){var t=await fs_extra_1.default.readdir(i);await Promise.all(t.map(async t=>{var e=path_1.default.join(i,t),a=await fs_extra_1.default.stat(e),t=u?u+"/"+t:t;a.isFile()?r[t]=a.mtimeMs:a.isDirectory()&&await getMtimeTree(e,r,t)}))}async function isOutputTimeStampsAvailable(a,t){return(await Promise.all(Object.entries(t).map(async([t,e])=>{t=path_1.default.join(a,path_1.default.join(...t.split("/")));try{return(await fs_extra_1.default.stat(t)).mtimeMs===e}catch{return!1}}))).every(t=>t)}function validateOptions(t,e){return matchObject(t,e)}function matchObject(t,e){return function a(e,i){return Array.isArray(e)?Array.isArray(i)&&e.length===i.length&&e.every((t,e)=>a(t,i[e])):"object"==typeof e&&null!==e?"object"==typeof i&&null!==i&&Object.keys(e).every(t=>a(e[t],i[t])):null===e?null===i:e===i}(t,e)}exports.modelConvertRoutine=modelConvertRoutine;