"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var i=Object.getOwnPropertyDescriptor(t,a);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,i)}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrateMeshSimplifyOption=exports.migrateFbxMatchMeshNames=exports.migrateMeshOptimizerOption=exports.getOptimizerPath=exports.getGltfFilePath=exports.GltfHandler=void 0;const asset_db_1=require("@editor/asset-db"),ajv_1=__importDefault(require("ajv")),assert_1=require("assert"),fs=__importStar(require("fs-extra")),path=__importStar(require("path")),urijs_1=__importDefault(require("urijs")),url_1=__importDefault(require("url")),asset_finder_1=require("./gltf/asset-finder"),material_1=require("./gltf/material"),reader_manager_1=require("./gltf/reader-manager"),migratesNameToId=__importStar(require("./migrates/name2id")),uri_utils_1=require("./utils/uri-utils"),cc_1=require("cc"),fs_extra_1=require("fs-extra"),resolve_glTF_image_path_1=require("./utils/resolve-glTF-image-path"),serialize_library_1=require("./utils/serialize-library"),original_animation_1=require("./gltf/original-animation"),path_1=require("path"),utils_1=require("../utils"),meshSimplify_1=require("./gltf/meshSimplify"),child_process_1=require("child_process"),utils_2=require("./image/utils"),lodash=require("lodash"),ajv=new ajv_1.default({errorDataPath:""}),schemaFile=path.join(__dirname,"..","..","..","dist","meta-schemas","glTF.meta.json"),schema=fs.readJSONSync(schemaFile),metaValidator=ajv.compile(schema);async function getGltfFilePath(e){var t=e.userData;return t.meshSimplify&&t.meshSimplify.enable?getOptimizerPath(e,e.source,t.meshSimplify):e.source}function getOptimizerPath(e,t,a){return"gltfpack"===a.algorithm&&a.gltfpackOptions?_getOptimizerPath(e,t,a.gltfpackOptions):t}async function _getOptimizerPath(e,i,s={}){var t=e._assetDB.options.temp,t=path.join(t,"gltfpack-"+e.uuid);fs.ensureDirSync(t);const n=path.join(t,"out.gltf"),o=path.join(t,"status.json"),m={mtimeMs:(await(0,fs_extra_1.stat)(e.source)).mtimeMs,version:exports.GltfHandler.importer.version,options:JSON.stringify(s)};if((0,fs_extra_1.existsSync)(n)&&(0,fs_extra_1.existsSync)(o))try{var a=await(0,fs_extra_1.readJSON)(o);if(a.mtimeMs===m.mtimeMs&&a.version===m.version&&a.options===m.options)return n}catch(e){}return new Promise(t=>{try{var e=path.join(Editor.App.path,"./nodemodules/gltfpack/bin/gltfpack.js"),a=["-i",i,"-o",n],r=s.c;"1"===r?a.push("-c"):"2"===r&&a.push("-cc"),s.te&&a.push("-te"),s.tb&&a.push("-tb"),s.tc&&a.push("-tc"),50!==s.tq&&void 0!==s.tq&&(a.push("-tq"),a.push(s.tq)),s.tu&&a.push("-tu"),1!==s.si&&void 0!==s.si&&(a.push("-si"),a.push(s.si)),s.sa&&a.push("-sa"),14!==s.vp&&void 0!==s.vp&&(a.push("-vp"),a.push(s.vp)),12!==s.vt&&void 0!==s.vt&&(a.push("-vt"),a.push(s.vt)),8!==s.vn&&void 0!==s.vn&&(a.push("-vn"),a.push(s.vn)),16!==s.at&&void 0!==s.at&&(a.push("-at"),a.push(s.at)),12!==s.ar&&void 0!==s.ar&&(a.push("-ar"),a.push(s.ar)),16!==s.as&&void 0!==s.as&&(a.push("-as"),a.push(s.as)),30!==s.af&&void 0!==s.af&&(a.push("-af"),a.push(s.af)),s.ac&&a.push("-ac"),s.kn&&a.push("-kn"),s.ke&&a.push("-ke"),s.cf&&a.push("-cf"),!s.noq&&void 0!==s.noq||a.push("-noq"),!s.v&&void 0!==s.v||a.push("-v"),(0,child_process_1.fork)(e,a).on("exit",async e=>{await fs.writeFile(o,JSON.stringify(m,void 0,2)),t(n)})}catch(e){console.error(e),t(i)}})}async function validateMeta(e){var t;e.meta.userData.imageMetas??=[],await metaValidator(e.meta.userData)||(0!==Object.keys(e.meta.userData).length&&console.debug("Meta file of asset "+e.source+" is damaged: \n"+(metaValidator.errors||[]).map(e=>e.message)+"\nA default meta file is patched."),t={imageMetas:[],legacyFbxImporter:!1,allowMeshDataAccess:!0,addVertexColor:!1,generateLightmapUVNode:!1,meshOptimizer:{enable:!1,algorithm:"simplify",simplifyOptions:(0,meshSimplify_1.getDefaultSimplifyOptions)()},lods:{enable:!1,hasBuiltinLOD:!1,options:[]}},e.meta.userData=lodash.defaultsDeep(e.meta.userData,t))}async function importSubAssets(e){reader_manager_1.glTfReaderManager.delete(e);var t=await reader_manager_1.glTfReaderManager.getOrCreate(e,!0),a=(await adjustMeta(e,t),e.userData),r=new asset_finder_1.DefaultGltfAssetFinder(a.assetFinder),i=await importMeshes(e,t),s=(r.set("meshes",i),await saveOriginalAnimations(e,t,!0),a)["animationImportSettings"];if(s)for(const m of s)for(const l of m.splits){const{previousId:u,name:p,from:f,to:c,fps:g,...d}=l;var n=await e.createSubAsset(p+".animation","gltf-animation",{id:u}),n=(l.previousId=n._id,n.userData);n.gltfIndex=s.indexOf(m),Object.assign(n,d),n.sample=g??m.fps,n.span={from:f,to:c}}var i=await importSkins(e,t),i=(r.set("skeletons",i),await importImages(e,t),await importTextures(e,t)),i=(r.set("textures",i),await importMaterials(e,t,r)),o=(r.set("materials",i),await importScenes(e,t));return r.set("scenes",o),!o.length||a.lods&&a.lods.options&&a.lods.options.length||(o=await Manager.assetManager.queryAssetMeta(o[t.gltf.scene||0]))&&(t=0<(o=await loadLODs(a,t.createScene(o.userData.gltfIndex||0,r),t)).length,a.lods={enable:t,hasBuiltinLOD:t,options:t?o:await generateDefaultLODsOption()}),a.dumpMaterials&&!i.every(e=>null!==e)?(console.debug("Waiting for dependency materials..."),!1):(a.assetFinder=r.serialize(),!0)}async function adjustMeta(l,u){var e=l.userData;const r=u.gltf.images;if(r){const i=e.imageMetas;var t=r.map((e,t)=>{const a={};return e.name?(a.name=e.name,i&&(e=i.find(e=>e.remap&&e.name&&e.name===a.name))&&(a.remap=e.remap)):i&&r.length===i.length&&!i[t].name&&i[t].remap&&(a.remap=i[t].remap),a});e.imageMetas=t}else e.imageMetas=[];const p=u.gltf.animations;if(p){const f=e.animationImportSettings||[],c=makeUniqueSubAssetNames(l.basename,p,"animations","");t=p.map((e,t)=>{const a=u.getAnimationDuration(t);var r,i=e.name||c[t];let s=i;1===p.length&&1<(r=path.basename(l.basename,path.extname(l.basename)).split("@")).length&&(s=r[r.length-1]);const n={name:i,duration:a,fps:30,splits:[{name:s,from:0,to:a,wrapMode:cc_1.AnimationClip.WrapMode.Loop}]};let o=f.find(e=>e.name===n.name);if(o=o||f.length!==e.length?o:f[t]){n.fps=o.fps;const m=e=>e===o.duration?a:Math.min(e,a);n.splits=o.splits.map(e=>({...e,from:m(e.from),to:m(e.to),wrapMode:e.wrapMode??cc_1.AnimationClip.WrapMode.Loop}))}return n});e.animationImportSettings=t}else delete e.animationImportSettings}async function importMeshes(a,e){var t=e.gltf.meshes;if(void 0===t)return[];var r=makeUniqueSubAssetNames(a.basename,t,"meshes",".mesh"),i=[];for(let e=0;e<t.length;e++){t[e];var s=await a.createSubAsset(r[e],"gltf-mesh");s.userData.gltfIndex=e,i.push(s.uuid)}var n=a.userData;if(n.lods&&!n.lods.hasBuiltinLOD&&n.lods.enable)for(let t=0;t<r.length;t++){var o=n.lods.options;for(let e=1;e<o.length;e++){var m=r[t].split(".mesh")[0]+`LOD${e}.mesh`,m=await a.createSubAsset(m,"gltf-mesh");m.userData.gltfIndex=t,m.userData.lodLevel=e,m.userData.lodOptions={faceCount:o[e].faceCount},i.push(m.uuid)}}return i}async function importSkins(t,e){var a=e.gltf.skins;if(void 0===a)return[];var r=makeUniqueSubAssetNames(t.basename,a,"skeletons",".skeleton"),i=new Array(a.length);for(let e=0;e<a.length;e++){a[e];var s=await t.createSubAsset(r[e],"gltf-skeleton");i[s.userData.gltfIndex=e]=s.uuid}return i}async function importImages(i,s){var n=s.gltf.images;if(void 0!==n){var o=i.userData;const d="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==";var m=e=>s.gltf.asset.generator?.includes("FBX2glTF")&&e===d;var l=e=>s.gltf.asset.generator?.includes("FBX-glTF-conv")&&e===d,u=makeUniqueSubAssetNames(i.basename,n,"images",".image");for(let r=0;r<n.length;++r){var p=n[r],f=o.imageMetas[r],c=p.uri;let t=!1,a;if(c&&(m(c)||l(c)))t=!0;else if(c&&!c.startsWith("data:")){var g=s.path,g=url_1.default.pathToFileURL(g).toString();try{let e=new urijs_1.default(c);e=e.absoluteTo(g),(0,uri_utils_1.convertsEncodedSeparatorsInURI)(e),"file"===e.scheme()&&(a=url_1.default.fileURLToPath(e.toString()),t=!0)}catch{}}let e="";t&&(c=i._assetDB.options.target,g=await(0,resolve_glTF_image_path_1.resolveGlTfImagePath)(p.name,a,path.dirname(i.source),p.extras,c))&&((c=(0,asset_db_1.queryUrl)(g))?f.uri=c:(c=(0,path_1.relative)(Editor.Project.tmpDir,g),(0,path_1.isAbsolute)(c)||c.startsWith(".."+path_1.sep)?console.warn(`In model file ${i.source},`+`the image ${p.name} is resolved to ${g},`+"which is a location out of asset directory.This can cause problem as your project migrated."):e=g)),f.uri||((c=await i.createSubAsset(u[r],"gltf-embeded-image")).userData.gltfIndex=r,f.uri=c.uuid,e?c.getSwapSpace().resolved=e:p.uri===d&&s.fbxMissingImagesId.push(r))}}}async function importTextures(t,a){var r=a.gltf.textures;if(void 0===r)return[];var i=makeUniqueSubAssetNames(t.basename,r,"textures",".texture"),s=new Array(r.length);for(let e=0;e<r.length;e++){var n=r[e],o=i[e],o=await t.createSubAsset(o,"texture"),m=(0,utils_2.makeDefaultTexture2DAssetUserData)(),l=(a.getTextureParameters(n,m),o.userData);if(o.assignUserData(m),void 0!==n.source){m=t.userData.imageMetas[n.source],n=m.remap||m.uri;if(n){m=!n.startsWith("db://");if(l.isUuid=m,l.imageUuidOrDatabaseUri=n,!m){n=(0,asset_db_1.queryPath)(l.imageUuidOrDatabaseUri);if(!n)throw new assert_1.AssertionError({message:l.imageUuidOrDatabaseUri+" is not found in asset-db."});o.depend(n)}}else delete l.imageUuidOrDatabaseUri,delete l.isUuid}s[e]=o.uuid}return s}async function importMaterials(t,a,r){var i=a.gltf.materials;if(void 0===i)return[];var s,n=t.userData["dumpMaterials"],o=makeUniqueSubAssetNames(t.basename,i,"materials",n?".mtl":".material"),m=new Array(i.length);for(let e=0;e<i.length;e++)n?m[e]=await(0,material_1.dumpMaterial)(t,r,a,e,o[e]):m[(s=await t.createSubAsset(o[e],"gltf-material")).userData.gltfIndex=e]=s.uuid;return m}async function importScenes(t,e){var a=e.gltf.scenes;if(void 0===a)return[];let r="";if(t.uuid2recycle)for(const m in t.uuid2recycle){var i=t.uuid2recycle[m];"gltf-scene"===i.importer&&"id"in i&&(r=m)}var s=makeUniqueSubAssetNames(t.basename,a,"scenes",".prefab"),n=new Array(a.length);for(let e=0;e<a.length;e++){var o=await t.createSubAsset(s[e],"gltf-scene",{id:r});n[o.userData.gltfIndex=e]=o.uuid}return n}async function saveOriginalAnimations(r,i,e){var t=i.gltf.animations;t&&await Promise.all(t.map(async(e,t)=>{var a=i.createAnimation(t),a=(0,serialize_library_1.serializeForLibrary)(a)["data"],t=(0,original_animation_1.getOriginalAnimationLibraryPath)(r,t),t=(await r.saveToLibrary(t,a),(0,utils_1.getDependUUIDList)(a));r.setData("depends",t)}))}exports.GltfHandler={name:"gltf",importer:{version:"2.3.13",versionCode:1,migrations:[{version:"1.1.21",migrate(e){delete e.meta.userData.assetFinder}},{version:"1.1.23",migrate:migratesNameToId.migrate},{version:"1.3.0",migrate:migrateImageLocations},{version:"1.3.21",migrate:migrateDumpMaterial},{version:"2.0.0",migrate:migrateFbxConverterSelector},{version:"2.0.8",migrate:migrateFbxConverterUnitConversion},{version:"2.1.9",migrate:migrateFbxConverterPreferLocalTimeSpan},{version:"2.2.0",migrate:migrateSmartMaterialEnabled},{version:"2.3.0",migrate:migrateFBXPromoteSingleRootNode},{version:"2.3.2",migrate:migrateMeshOptimizerOption},{version:"2.3.5",migrate:migrateImageRemap},{version:"2.3.7",migrate:migrateFbxMatchMeshNames},{version:"2.3.12",migrate:migrateMeshSimplifyOption},{version:"2.3.13",migrate(e){delete e.meta.userData.redirect}}],async import(e){return await validateMeta(e),importSubAssets(e)},async afterSubAssetsImport(e){await reader_manager_1.glTfReaderManager.delete(e)}}},exports.default=exports.GltfHandler,exports.getGltfFilePath=getGltfFilePath,exports.getOptimizerPath=getOptimizerPath;const maxLodLevel=7,defaultLODsOptions={screenRatio:0,faceCount:0};async function deepFindMeshRenderer(e,a,r,i){var t=e.getComponents(cc_1.MeshRenderer);let s=0;if(t&&0<t.length)for(const m of t)if(m.mesh&&m.mesh.uuid){let t=0;var n=await Manager.assetManager.queryAssetMeta(m.mesh.uuid);n.userData.lodLevel=r,a.createMesh(n.userData.gltfIndex,i).struct.primitives?.forEach(e=>{e&&e.indexView&&(t+=e.indexView.count)}),s+=t/3}if(e.children&&0<e.children.length)for(const l of e.children){var o=await deepFindMeshRenderer(l,a,r,i);return s+o}return s}async function loadLODs(e,t,a){var r=[],i=[];for(const o of t.children){var s=/LOD(\d+)$/i.exec(o.name);s&&1<s.length&&(s=parseInt(s[1],10))<=maxLodLevel&&(r[s]=r[s]||Object.assign({},defaultLODsOptions),i[s]=(i[s]||0)+await deepFindMeshRenderer(o,a,s,e.generateLightmapUVNode))}if(0<r.length){var n=Math.max(...Object.keys(r).map(e=>+e));let t=.25;for(let e=0;e<n;e++)r[e]||(console.debug("No mesh name are ending with LOD"+e),r[e]=Object.assign({},defaultLODsOptions)),r[e].screenRatio=t,t/=2,0!==i[0]&&(r[e].faceCount=i[e]/i[0]);r[n].screenRatio=t<.01?t:.01,r[n].faceCount=i[0]?i[n]/i[0]:0}return r}async function generateDefaultLODsOption(){var t=[],a=[.25,.125,.01],r=[1,.25,.1];for(let e=0;e<3;e++)t[e]={screenRatio:a[e],faceCount:r[e]};return t}function makeUniqueSubAssetNames(a,e,r,t){let i=e.map(e=>{let t;return t="scenes"===r?a:"string"==typeof e.name?e.name:(()=>{switch(r){case"animations":return"UnnamedAnimation";case"images":return"UnnamedImage";case"meshes":return"UnnamedMesh";case"materials":return"UnnamedMaterial";case"skeletons":return"UnnamedSkeleton";case"textures":return"UnnamedTexture";default:return"Unnamed"}})()});if(!isDifferWithEachOther(i)){let a="-";for(;;){if(i.every(e=>!e.endsWith(a)))break;a+="-"}i=i.map((e,t)=>e+(""+a)+t)}return i.map(e=>e+t)}function isDifferWithEachOther(e){if(2<=e.length){var t=e.slice().sort();for(let e=0;e<t.length-1;++e)if(t[e]===t[e+1])return!1}return!0}async function migrateImageLocations(e){var t=e.meta.userData,a=[];if(t.imageLocations){var r=t["imageLocations"];for(const s of Object.keys(r)){var i=r[s];i.targetDatabaseUrl&&a.push({name:s,remap:i.targetDatabaseUrl})}delete t.imageLocations}e.meta.userData.imageMetas=a,t.assetFinder&&t.assetFinder.images&&delete t.assetFinder.images}async function migrateImageRemap(e){e=e.meta.userData;if(e.imageMetas)for(const a of e.imageMetas){var t=a["remap"];t&&(t=(0,asset_db_1.queryUUID)(t))&&(a.remap=t)}}async function migrateDumpMaterial(e){var t,a,r,i;e.userData.dumpMaterials&&!e.userData.materialDumpDir&&(t=path.join(e.source,`../Materials${e.basename}.FBX`),a=path.join(e.source,`../Materials${e.basename}.FBX.meta`),r=path.join(e.source,"../Materials"+e.basename),i=path.join(e.source,`../Materials${e.basename}.meta`),fs.existsSync(t))&&!fs.existsSync(r)&&(fs.renameSync(t,r),fs.existsSync(a)&&fs.renameSync(a,i),e._assetDB.refresh(r))}async function migrateFbxConverterSelector(e){".fbx"===e.extname&&(e.userData.legacyFbxImporter=!0)}async function migrateFbxConverterUnitConversion(e){".fbx"!==e.extname||(e=e.userData).legacyFbxImporter||((e.fbx??={}).unitConversion="hierarchy-level")}async function migrateFbxConverterPreferLocalTimeSpan(e){".fbx"!==e.extname||(e=e.userData).legacyFbxImporter||((e.fbx??={}).preferLocalTimeSpan=!1)}async function migrateSmartMaterialEnabled(e){".fbx"===e.extname&&((e.userData.fbx??={}).smartMaterialEnabled=!1)}async function migrateFBXPromoteSingleRootNode(e){".fbx"===e.extname&&(e=e.userData).fbx?.promoteSingleRootNode&&(e.promoteSingleRootNode=e.fbx.promoteSingleRootNode,delete e.fbx.promoteSingleRootNode)}function migrateMeshOptimizerOption(e){e=e.userData;e.meshOptimizer&&(e.meshOptimizer={algorithm:"gltfpack",enable:!0,gltfpackOptions:e.meshOptimizerOptions||{}},delete e.meshOptimizerOptions)}function migrateFbxMatchMeshNames(e){".fbx"===e.extname&&((e.userData.fbx??={}).matchMeshNames=!1)}function migrateMeshSimplifyOption(e){var t,a,e=e.userData;e.meshOptimizer&&(a=(t=e.meshOptimizer).simplifyOptions,e.meshSimplify={enable:t.enable,targetRatio:a?.targetRatio||1},delete e.meshOptimizer)}exports.migrateMeshOptimizerOption=migrateMeshOptimizerOption,exports.migrateFbxMatchMeshNames=migrateFbxMatchMeshNames,exports.migrateMeshSimplifyOption=migrateMeshSimplifyOption;