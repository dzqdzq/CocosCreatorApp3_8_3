"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.glTfReaderManager=void 0;const utils_1=require("../../utils"),gltf_converter_1=require("../utils/gltf-converter"),validation_1=require("./validation"),fs_extra_1=__importDefault(require("fs-extra")),gltf_1=require("../gltf"),fbx_1=require("../fbx");class GlTfReaderManager{constructor(){this._map=new Map}async getOrCreate(e,r=!1){let t=this._map.get(e.uuid);if(!t){var{converter:a,referencedBufferFiles:s}=await createGlTfReader(e);if(t=a,this._map.set(e.uuid,t),r)for(const n of s)e.depend(n)}return t}delete(e){this._map.delete(e.uuid)}}async function createGlTfReader(l){let e;var r=await(e=("fbx"===l.meta.importer?fbx_1:gltf_1).getGltfFilePath)(l);const t=r!==l.source;var a=l.userData;void 0===a.skipValidation||a.skipValidation||await(0,validation_1.validateGlTf)(r,l.source);const{glTF:s,buffers:n}=await(0,gltf_converter_1.readGltf)(r),o=[];a=await Promise.all(n.map(async e=>Buffer.isBuffer(e)?e:(t||o.push(e),fs_extra_1.default.readFile(e))));function i(r,t){if(Array.isArray(s[r])){let e;switch(r){case"meshes":e="asset-db.importers.glTF.glTF_asset_group_mesh";break;case"animations":e="asset-db.importers.glTF.glTF_asset_group_animation";break;case"nodes":e="asset-db.importers.glTF.glTF_asset_group_node";break;case"skins":e="asset-db.importers.glTF.glTF_asset_group_skin";break;case"samplers":e="asset-db.importers.glTF.glTF_asset_group_sampler";break;default:e=r}var a=s[r][t];return"string"==typeof a.name&&a.name?(0,utils_1.i18nTranslate)("asset-db.importers.glTF.glTF_asset",{group:(0,utils_1.i18nTranslate)(e),name:a.name,index:t}):(0,utils_1.i18nTranslate)("asset-db.importers.glTF.glTF_asset_no_name",{group:(0,utils_1.i18nTranslate)(e),index:t})}return""}return{converter:new gltf_converter_1.GltfConverter(s,a,r,{logger:(e,r,t)=>{let a;switch(r){case gltf_converter_1.GltfConverter.ConverterError.UnsupportedAlphaMode:var s=t;a=(0,utils_1.i18nTranslate)("asset-db.importers.glTF.unsupported_alpha_mode",{material:i("materials",s.material),mode:s.mode});break;case gltf_converter_1.GltfConverter.ConverterError.UnsupportedTextureParameter:s=t;a=(0,utils_1.i18nTranslate)("asset-db.importers.glTF.unsupported_texture_parameter",{sampler:"",texture:i("textures",s.texture),type:(0,utils_1.i18nTranslate)("minFilter"===s.type?"asset-db.importers.glTF.min_filter":"magFilter"===s.type?"asset-db.importers.glTF.mag_filter":"asset-db.importers.glTF.wrapMode"),value:""});break;case gltf_converter_1.GltfConverter.ConverterError.UnsupportedChannelPath:s=t;a=(0,utils_1.i18nTranslate)("asset-db.importers.glTF.unsupported_channel_path",{animation:i("animations",s.animation),channel:s.channel,path:s.path});break;case gltf_converter_1.GltfConverter.ConverterError.ReferenceSkinInDifferentScene:s=t;a=(0,utils_1.i18nTranslate)("asset-db.importers.glTF.reference_skin_in_different_scene",{node:i("nodes",s.node),skin:i("skins",s.skin)});break;case gltf_converter_1.GltfConverter.ConverterError.DisallowCubicSplineChannelSplit:s=t;a=(0,utils_1.i18nTranslate)("asset-db.importers.glTF.disallow_cubic_spline_channel_split",{animation:i("animations",s.animation),channel:s.channel});break;case gltf_converter_1.GltfConverter.ConverterError.FailedToCalculateTangents:s=t;a=(0,utils_1.i18nTranslate)("normal"===s.reason?"asset-db.importers.glTF.failed_to_calculate_tangents_due_to_lack_of_normals":"asset-db.importers.glTF.failed_to_calculate_tangents_due_to_lack_of_uvs",{mesh:i("meshes",s.mesh),primitive:s.primitive});break;case gltf_converter_1.GltfConverter.ConverterError.EmptyMorph:s=t;a=(0,utils_1.i18nTranslate)("asset-db.importers.glTF.empty_morph",{mesh:i("meshes",s.mesh),primitive:s.primitive});break;case gltf_converter_1.GltfConverter.ConverterError.UnsupportedExtension:s=t;a=(0,utils_1.i18nTranslate)("asset-db.importers.glTF.unsupported_extension",{name:s.name})}var n=(0,utils_1.linkToAssetTarget)(l.uuid);switch(e){case gltf_converter_1.GltfConverter.LogLevel.Info:default:console.log(a,n);break;case gltf_converter_1.GltfConverter.LogLevel.Warning:console.warn(a,n);break;case gltf_converter_1.GltfConverter.LogLevel.Error:console.error(a,n);break;case gltf_converter_1.GltfConverter.LogLevel.Debug:console.debug(a,n)}},userData:l.userData,promoteSingleRootNode:l.userData?.promoteSingleRootNode??!1,generateLightmapUVNode:l.userData?.generateLightmapUVNode??!1}),referencedBufferFiles:o}}exports.glTfReaderManager=new GlTfReaderManager;