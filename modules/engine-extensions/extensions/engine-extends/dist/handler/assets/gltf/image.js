"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var i=Object.getOwnPropertyDescriptor(t,a);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,i)}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfImageHandler=void 0;const DataURI=__importStar(require("@cocos/data-uri")),fs_extra_1=__importStar(require("fs-extra")),path_1=__importStar(require("path")),urijs_1=__importDefault(require("urijs")),url_1=__importDefault(require("url")),image_mics_1=require("../image/image-mics"),uri_utils_1=require("../utils/uri-utils"),reader_manager_1=require("./reader-manager"),utils_1=require("../../utils"),match_image_type_pattern_1=require("../utils/match-image-type-pattern"),image_mime_type_to_ext_1=require("../utils/image-mime-type-to-ext"),base64_1=require("../utils/base64"),cc_1=require("cc"),utils_2=require("../../utils"),utils_3=require("../image/utils");function resolveImageDataURI(e){var t;if(e.base64&&e.mediaType&&"image"===e.mediaType.type)return t=(0,base64_1.decodeBase64ToArrayBuffer)(e.data),{data:Buffer.from(t),mimeType:e.mediaType.value};throw new Error(`Cannot understand data uri(base64: ${e.base64}, mediaType: ${e.mediaType}) for image.`)}exports.GltfImageHandler={name:"gltf-embeded-image",assetType:"cc.ImageAsset",iconInfo:{default:utils_3.defaultIconConfig,generateThumbnail(e){return{type:"image",value:e.library+e.getData("imageExtName")}}},importer:{version:"1.0.3",async import(i){if(!i.parent)return!1;var a=i.userData.gltfIndex,r=await reader_manager_1.glTfReaderManager.getOrCreate(i.parent);const s=r.gltf.images[a];let u;var a=async t=>{try{var e=url_1.default.fileURLToPath(t),a=await fs_extra_1.default.readFile(e),r=(0,match_image_type_pattern_1.matchImageTypePattern)(a);u={data:a,mimeType:r,extName:path_1.default.extname(e)}}catch(e){console.error((0,utils_1.i18nTranslate)("asset-db.importers.glTF.failed_to_load_image",{url:t,reason:e}),(0,utils_1.linkToAssetTarget)(i.uuid))}},o=i.getSwapSpace().resolved;if(o)await a(url_1.default.pathToFileURL(o).href);else if(void 0!==s.bufferView)u={data:r.readImageInBufferView(r.gltf.bufferViews[s.bufferView])};else if(void 0!==s.uri){const t=r.path;o=e=>{console.error(`The uri "${s.uri}" provided by model file${t} is not correct: `+e)};if(s.uri.startsWith("data:"))try{var l=DataURI.parse(s.uri);if(!l)throw new Error(`Unable to parse data uri "${s.uri}"`);u=resolveImageDataURI(l)}catch(e){o(e)}else{l=r.path;let t;try{var n=url_1.default.pathToFileURL(l).toString();let e=new urijs_1.default(s.uri);e=e.absoluteTo(n),(0,uri_utils_1.convertsEncodedSeparatorsInURI)(e),t=e.toString()}catch(e){o(e)}t&&(t.startsWith("file://")?await a(t):console.error((0,utils_1.i18nTranslate)("asset-db.importers.glTF.image_uri_should_be_file_url"),(0,utils_1.linkToAssetTarget)(i.uuid)))}}r=new cc_1.ImageAsset;if(u){let e;l=s.mimeType??u.mimeType;if(!(e=(e=l?(0,image_mime_type_to_ext_1.imageMimeTypeToExt)(l):e)||u.extName))throw new Error("Unknown image type");let t=u.data;if(".tga"===e.toLowerCase()){n=await(0,image_mics_1.convertTGA)(t);if(n instanceof Error||!n)return console.error((0,utils_1.i18nTranslate)("asset-db.importers.glTF.failed_to_convert_tga"),(0,utils_1.linkToAssetTarget)(i.uuid)),!1;e=n.extName,t=n.data}else if(".psd"===e.toLowerCase()){o=await(0,image_mics_1.convertPSD)(t);({extName:e,data:t}=o)}else if(".exr"===e.toLowerCase()){a=(0,path_1.join)(i.temp,"image"+e),l=(await(0,fs_extra_1.outputFile)(a,t),await(0,image_mics_1.convertHDROrEXR)(a,i.uuid,i.temp));if(l instanceof Error||!l)return console.error((0,utils_1.i18nTranslate)("asset-db.importers.glTF.failed_to_convert_tga"),(0,utils_1.linkToAssetTarget)(i.uuid)),!1;e=l.extName,t=l.source}r._setRawAsset(e),i.userData.fixAlphaTransparencyArtifacts=!0,t=await(0,utils_3.handleImageUserData)(i,t,e),await i.saveToLibrary(e,t),i.setData("imageExtName",e)}n=EditorExtends.serialize(r),await i.saveToLibrary(".json",n),o=(0,utils_2.getDependUUIDList)(n);return i.setData("depends",o),!0}}},exports.default=exports.GltfImageHandler;