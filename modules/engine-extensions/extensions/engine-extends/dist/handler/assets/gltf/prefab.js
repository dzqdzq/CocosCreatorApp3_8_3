"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,a)}:function(e,t,r,n){e[n=void 0===n?r:n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfPrefabHandler=void 0;const cc=__importStar(require("cc")),path_1=__importDefault(require("path")),asset_finder_1=require("./asset-finder"),load_asset_sync_1=require("../utils/load-asset-sync"),reader_manager_1=require("./reader-manager"),uuidV5=require("uuid")["v5"],utils_1=require("../../utils"),nodePathMap=new Map,GLTF_PREFAB_NAMESPACE="8fa06a75-f07a-44d4-82cf-d08c3c986599";function changeMaterialsInJSON(e,t){var r,n=t.find(e=>"cc.SkinnedMeshRenderer"===e.__type__||"cc.MeshRenderer"===e.__type__);for(const a of Object.keys(e))n._materials[a]&&((r=e[a])?n._materials[a].__uuid__=r:console.error("overwriteMaterial uuid is empty, index: "+a))}function getCompressedUuid(e){e=uuidV5(e,GLTF_PREFAB_NAMESPACE);return EditorExtends.UuidUtils.compressUuid(e,!0)}function getNodePath(e){if(nodePathMap.has(e))return nodePathMap.get(e);var t,r=[];let n=e;for(;n;){var a=n.getSiblingIndex();r.push(n.name+a),n=n.parent}return t=r.reverse().join("/"),nodePathMap.set(e,t),t}function nodeFileIdGenerator(e){return getCompressedUuid(getNodePath(e))}function compFileIdGenerator(e,t){return getCompressedUuid(getNodePath(e.node)+"/comp"+t)}function getDumpableNode(e,t){return nodePathMap.clear(),EditorExtends.PrefabUtils.addPrefabInfo(e,e,t,{nodeFileIdGenerator:nodeFileIdGenerator,compFileIdGenerator:compFileIdGenerator}),EditorExtends.PrefabUtils.checkAndStripNode(e),e}function generatePrefab(e){var t=new cc.Prefab,e=getDumpableNode(e,t);return t.data=e,t}exports.GltfPrefabHandler={name:"gltf-scene",assetType:"cc.Prefab",importer:{version:"1.0.14",async import(t){if(!t.parent)return!1;var e=await reader_manager_1.glTfReaderManager.getOrCreate(t.parent),r=t.parent.userData,n=new asset_finder_1.DefaultGltfAssetFinder(r.assetFinder);const a=e.createScene(t.userData.gltfIndex,n);var o=[];for(const v of Object.keys(t.parent.subAssets)){var i=t.parent.subAssets[v];"gltf-animation"===i.meta.importer&&o.push(i.uuid)}var s=r.mountAllAnimationsOnPrefab??!0;let d=null;if(a.getComponentInChildren(cc.SkinnedMeshRenderer)?(d=a.addComponent(cc.SkeletalAnimation))._sockets=e.createSockets(a):0!==o.length&&(d=a.addComponent(cc.Animation)),s&&d){var s=o.map(e=>(0,load_asset_sync_1.loadAssetSync)(e,cc.AnimationClip)||null);for(const D of d._clips=s)if(D){d._defaultClip=D;break}}if(r.lods&&!r.lods.hasBuiltinLOD&&r.lods.enable){var c=t.parent.subAssets;const M={},P={};for(const A in c){var l=c[A];"gltf-mesh"===l.meta.importer&&(l.userData.lodOptions?M[l.uuid]=l.userData:P[l.uuid]=l.userData)}const y=new Array(Object.keys(P).length);a.children.forEach(e=>{var t=e.getComponentsInChildren(cc.MeshRenderer);for(const r in P)t.forEach(e=>{e?.mesh?.uuid&&r===e.mesh.uuid&&(e.node.name=e.node.name+"_LOD0",y[P[r].gltfIndex]=e.node)})});for(const C in M){var u,f,p,_=r.assetFinder?.meshes?.indexOf(C)||-1;-1!==_&&(_=n.find("meshes",_,cc.Mesh))&&(p=M[C],p=(u=y[p.gltfIndex]).name.replace(/(_LOD0)+$/,"_LOD"+p.lodLevel),(f=cc.instantiate(u)).name=p,(p=f.getComponent(cc.MeshRenderer))&&(p.mesh=_),u.parent.addChild(f))}}const h=[];let m=a.getComponent(cc.LODGroup);if(a.children.forEach(e=>{var t=/_LOD(\d+)$/i.exec(e.name);if(t&&1<t.length){if(!m)try{m=a.addComponent(cc.LODGroup)}catch(e){console.error("Add LODGroup component failed!")}t=parseInt(t[1],10);let r=m?.LODs[t];(r=void 0!==r?r:h[t])||(r=new cc.LOD,h[t]=r);const n=e=>{var t=e.getComponents(cc.MeshRenderer);t&&0<t.length&&t.forEach(e=>{r?.insertRenderer(-1,e)}),e.children&&0<e.children.length&&e.children.forEach(e=>{n(e)})};n(e)}}),m){let t=.25;var g=h.length;for(let e=0;e<g-1;e++){var b=h[e];t=r.lods?.options[e]?.screenRatio||t,m.insertLOD(e,t,b),t/=2}r.lods?.options[g-1]?.screenRatio?m.insertLOD(g-1,r.lods.options[g-1].screenRatio,h[g-1]):t<.01?m.insertLOD(g-1,t,h[g-1]):m.insertLOD(g-1,.01,h[g-1])}1===e.gltf.scenes.length&&(s=t.parent.basename,a.name=path_1.default.basename(s,path_1.default.extname(s)));e=generatePrefab(a);let O=EditorExtends.serialize(e);if(r.redirectMaterialMap){s=JSON.parse(O);try{await changeMaterialsInJSON(r.redirectMaterialMap,s)}catch(e){console.error(e),console.error(`changeMaterialsInJSON in asset ${t.url} failed!`)}O=JSON.stringify(s,void 0,2)}await t.saveToLibrary(".json",O);e=(0,utils_1.getDependUUIDList)(O);return t.setData("depends",e),nodePathMap.clear(),!0}}},exports.default=exports.GltfPrefabHandler;