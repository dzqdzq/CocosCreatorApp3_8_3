"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImageHandler=void 0;const fs_extra_1=require("fs-extra"),erp_texture_cube_1=require("../erp-texture-cube"),image_mics_1=require("./image-mics"),migrations_1=require("./migrations"),sharp_1=__importDefault(require("sharp")),path_1=require("path"),utils_1=require("./utils");exports.ImageHandler={displayName:"i18n:ENGINE.assets.image.label",description:"i18n:ENGINE.assets.image.description",name:"image",assetType:"cc.ImageAsset",open:utils_1.openImageAsset,iconInfo:{default:utils_1.defaultIconConfig,generateThumbnail(e){var a=e.meta.files.find(e=>".json"!==e)||".png";return{type:"image",value:e.library+a}}},importer:{version:"1.0.27",migrations:migrations_1.migrations,async force(e){return!1},async import(e){let a=e.extname.toLocaleLowerCase(),t=e.source;var r=e.meta.userData;if(".bmp"===a){var i=await(0,image_mics_1.convertHDR)(e.source,e.uuid,e.temp);if(i instanceof Error||!i)return console.error("Failed to convert bmp image."),!1;a=i.extName,t=i.source,r.isRGBE=!0,r.fixAlphaTransparencyArtifacts||=!1}else if(".znt"===a){i=e.source,i=await(0,image_mics_1.convertHDR)(i,e.uuid,e.temp);if(i instanceof Error||!i)return console.error(`Failed to convert asset {asset(${e.uuid})}.`),!1;a=i.extName,t=i.source,r.fixAlphaTransparencyArtifacts=!1,r.isRGBE=!0}else if(".hdr"===a||".exr"===a){i=e.source,i=await(0,image_mics_1.convertHDROrEXR)(i,e.uuid,e.temp);if(i instanceof Error||!i)return console.error(`Failed to convert asset {asset(${e.uuid})}.`),!1;a=i.extName,t=i.source,r.fixAlphaTransparencyArtifacts=!1,r.isRGBE=!0;var s=await(await(0,sharp_1.default)(t)).metadata(),s=(!r.type&&(0,erp_texture_cube_1.checkSize)(s.width,s.height)&&(r.type="texture cube"),(0,path_1.join)(i.source.replace(".png","_sign.png"))),s=((0,fs_extra_1.existsSync)(s)&&(r.sign=Editor.UI.__protected__.File.resolveToUrl(s,"project")),(0,path_1.join)(i.source.replace(".png","_alpha.png")));(0,fs_extra_1.existsSync)(s)&&(r.alpha=Editor.UI.__protected__.File.resolveToUrl(s,"project"))}else if(".tga"===a){i=await(0,image_mics_1.convertTGA)(await(0,fs_extra_1.readFile)(e.source));if(i instanceof Error||!i)return console.error("Failed to convert tga image."),!1;a=i.extName,t=i.data}else if(".psd"===a){s=await(0,image_mics_1.convertPSD)(await(0,fs_extra_1.readFile)(e.source));a=s.extName,t=s.data}else if(".tif"===a||".tiff"===a){i=await(0,image_mics_1.convertTIFF)(e.source);if(i instanceof Error||!i)return console.error(`Failed to convert ${a} image.`),!1;a=i.extName,t=i.data}return t=await(0,utils_1.handleImageUserData)(e,t,a),void 0===r.fixAlphaTransparencyArtifacts&&(r.fixAlphaTransparencyArtifacts=(0,utils_1.isCapableToFixAlphaTransparencyArtifacts)(e,r.type,e.extname)),await(0,utils_1.saveImageAsset)(e,t,a,e.basename),await(0,utils_1.importWithType)(e,r.type,e.basename,e.extname),r.sign&&await e.createSubAsset("sign","sign-image",{displayName:"sign"}),r.alpha&&await e.createSubAsset("alpha","alpha-image",{displayName:"alpha"}),!0}},userDataConfig:{default:{type:{label:"i18n:ENGINE.assets.image.type",default:"texture",render:{ui:"ui-select",items:[{label:"raw",value:"raw"},{label:"texture",value:"texture"},{label:"normal map",value:"normal map"},{label:"sprite-frame",value:"sprite-frame"},{label:"texture cube",value:"texture cube"}]}},flipVertical:{default:!1,label:"i18n:ENGINE.assets.image.flipVertical",render:{ui:"ui-checkbox"}}}},async validate(e){return!await e.isDirectory()}},exports.default=exports.ImageHandler;