"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TypeScriptHandler=exports.ScriptNameCheckerManager=exports.ScriptNameChecker=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("../utils"),javascript_1=__importDefault(require("./javascript"));class ScriptNameChecker{constructor(e,t){this.requiredCamelCaseClassName=e,this.classNameStringFormat=t}async isValid(e){let t="";var a;return(t=this.requiredCamelCaseClassName?(a=this.getValidCamelCaseClassName(e),this.classNameStringFormat.replace("<%CamelCaseClassName%>",a).trim()||a):(a=this.getValidClassName(e),this.classNameStringFormat.replace("<%UnderscoreCaseClassName%>",a).trim()||a))?{state:""}:{state:"i18n:assets.operate.errorScriptClassName"}}async getValidFileName(e){var t=e=(e=e.trim().replace(/[^a-zA-Z0-9_-]/g,""))&&!isFinite(e)?e:"NewComponent";let a=0;for(;(await this.isValid(e)).state;){if(1e3<a)return e;e=t+("-"+(++a).toString().padStart(3,"0"))}return e}getValidClassName(e){e=(e=e.trim().replace(/^[^a-zA-Z_]+/g,"")).match(/[a-zA-Z0-9_]+/g);return e?e.join("_"):""}getValidCamelCaseClassName(e){e=(e=e.trim().replace(/^[^a-zA-Z]+/g,"")).match(/[a-zA-Z0-9]+/g);return e?e.filter(Boolean).map(e=>e[0].toLocaleUpperCase()+e.substr(1)).join(""):""}}(exports.ScriptNameChecker=ScriptNameChecker).camelFormatReg=/@ccclass([^<]*)(<%CamelCaseClassName%>)/,ScriptNameChecker.classNameFormatReg=/@ccclass\(['"]([^'"]*)['"]\)/,ScriptNameChecker.commentsReg=/(\n[^\n]*\/\*[\s\S]*?\*\/)|(\n[^\n]*\/\/(?:[^\r\n]|\r(?!\n))*)/g;class ScriptNameCheckerManager{static async getScriptChecker(e){var t=e.match(ScriptNameChecker.classNameFormatReg),t=t&&t[1]?t[1]:"";return new ScriptNameChecker(ScriptNameChecker.camelFormatReg.test(e),t)}}async function getTypeCheckLevel(){return await Editor.Profile.getProject("project","general.type_check_level")}exports.ScriptNameCheckerManager=ScriptNameCheckerManager,exports.TypeScriptHandler={name:"typescript",assetType:"cc.Script",open:utils_1.openCode,createInfo:{async generateMenuInfo(){var e=[{label:"i18n:ENGINE.assets.newTypeScript",fullFileName:"NewComponent.ts",template:`db://internal/default_file_content/${exports.TypeScriptHandler.name}/ts`,group:"script"}],t=(0,path_1.join)(Editor.Project.path,".creator/asset-template/typescript"),t=(0,path_1.join)(t,"Custom Script Template Help Documentation.url");return(0,fs_extra_1.existsSync)(t)||(0,fs_extra_1.outputFileSync)(t,"[InternetShortcut]\nURL=https://docs.cocos.com/creator/manual/en/scripting/setup.html#custom-script-template"),e},async create(e){var t=Manager.Utils.url2path(e.template||"db://internal/default_file_content/ts");let a=await(0,fs_extra_1.readFile)(t,"utf-8");a=a.replace(ScriptNameChecker.commentsReg,e=>e.includes("COMMENTS_GENERATE_IGNORE")?"":e);var t=(0,path_1.basename)(e.target,(0,path_1.extname)(e.target)),r=await ScriptNameCheckerManager.getScriptChecker(a),s=await Editor.User.getData();const i={Name:r.getValidClassName(t),UnderscoreCaseClassName:r.getValidClassName(t),CamelCaseClassName:r.getValidCamelCaseClassName(t),DateTime:new Date,Author:s.nickname,FileBasename:(0,path_1.basename)(e.target),FileBasenameNoExtension:t,EditorVersion:Editor.App.version,ManualUrl:Editor.App.urls.manual};return Object.keys(i).forEach(e=>{a=a.replace(new RegExp(`<%${e}%>`,"g"),i[e])}),(0,fs_extra_1.outputFileSync)(e.target,a,"utf-8"),e.target}},importer:{...javascript_1.default.importer,async import(e){if(e.source.endsWith(".d.ts"))return!0;let t=!1,a=!1;switch(await getTypeCheckLevel()){case"checkOnly":t=!0,a=!1;break;case"fatalOnError":t=!0,a=!0;break;default:t=!1}return javascript_1.default.importer.import(e)}}},exports.default=exports.TypeScriptHandler;