"use strict";var Helper_1,__createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){e[i=void 0===i?r:i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__decorate=this&&this.__decorate||function(e,t,r,i){var a,o=arguments.length,c=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(e,t,r,i);else for(var n=e.length-1;0<=n;n--)(a=e[n])&&(c=(o<3?a(c):3<o?a(t,r,c):a(t,r))||c);return 3<o&&c&&Object.defineProperty(t,r,c),c},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrateAnimationClip330=void 0;const migration_utils_1=require("../utils/migration-utils"),cc=__importStar(require("cc")),archive_space_1=require("./archive-space"),animation_clip_migration_1=require("cc/editor/animation-clip-migration");let Helper=Helper_1=class{constructor(){this.duration=0,this._keys=[],this._curves=[],this._commonTargets=[]}static createFromSerializedLegacyClip(e){const t=new ArrayBuffer(0);var r=e.duration??0,i=(e._keys??[]).map(e=>decodeMaybeCompactValueTypeArray(e,t)),a=e._curves??[],e=(a.forEach(e=>{decodeMaybeCompactValueTypeArray(e.data.values,t)}),e._commonTargets??[]),o=new migration_utils_1.Archive,c=o.addTypedObject(cc.js.getClassName(Helper_1)),n=(c.duration=r,c._keys=i,c._curves=a,c._commonTargets=e,cc.deserialize.Details.pool.get()),r=o.get(c),i=cc.deserialize(r,n,void 0),s=n.uuidList.length;for(let e=0;e<s;++e){var _=n.uuidList[e],l=n.uuidObjList[e],d=n.uuidPropList[e],p=n.uuidTypeList[e],p=new(cc.js.getClassById(p)??cc.Asset);p._uuid=_+"",l[d]=p}return i}toLegacyData(){var e=new animation_clip_migration_1.AnimationClipLegacyData(this.duration);return e.keys=this._keys,e.curves=this._curves,e.commonTargets=this._commonTargets,e}};async function migrateAnimationClip330(e){e.visitTypedObject(archive_space_1.ArchiveSpace.ANIMATION_CLIP_TYPE_NAME,e=>{var t=Helper.createFromSerializedLegacyClip(e).toLegacyData(),r=e.events,t=(delete e._keys,delete e._curves,delete e._commonTargets,delete e._stepness,delete e.events,t.toTracks()),t=new migration_utils_1.Archive(EditorExtends.serialize(t,{stringify:!1}));e._tracks=t.root,e._events=r,e._exoticAnimation=null})}function decodeMaybeCompactValueTypeArray(e,t){return Array.isArray(e)?e:cc.deserialize(e,void 0,void 0).decompress(t)}__decorate([cc._decorator.property],Helper.prototype,"duration",void 0),__decorate([cc._decorator.property],Helper.prototype,"_keys",void 0),__decorate([cc._decorator.property],Helper.prototype,"_curves",void 0),__decorate([cc._decorator.property],Helper.prototype,"_commonTargets",void 0),Helper=Helper_1=__decorate([cc._decorator.ccclass("cc._internal.migrate-animation_clip-3-3-0.Helper")],Helper),exports.migrateAnimationClip330=migrateAnimationClip330;