"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.migratePrefab=exports.beforeMigratePrefab=void 0;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),PrefabInfo={__type__:"cc.PrefabInfo",targetOverrides:[]},addPrefabInfo=function(e,_){let r,n;var t=_[0];if(!(t=t&&(t.data||t.scene))||(n=_[t.__id__]))return(t=n._prefab&&n._prefab.__id__)?r=_[t]:(r=JSON.parse(JSON.stringify(PrefabInfo)),_.push(r),n._prefab={__id__:_.length-1}),r.targetOverrides=e,r;console.warn("Can not find root node, root info: "+_[0])},TargetOverrideInfo={__type__:"cc.TargetOverrideInfo",source:null,sourceInfo:null,propertyPath:[],target:null,targetInfo:null},createTargetOverrideInfo=function(){return JSON.parse(JSON.stringify(TargetOverrideInfo))},PrefabLink={__type__:"cc.PrefabLink",_name:"",_objFlags:0,node:{__id__:2},_enabled:!0,__prefab:null,prefab:null,_id:"a6NH7Dj9tMVbatCdgoxYyz"},addPrefabLink=function(e,_,r){var n,r=e[r];return r&&r.asset?((n=JSON.parse(JSON.stringify(PrefabLink))).node={__id__:_},n.prefab={__uuid__:r.asset.__uuid__},e.push(n),e.length-1):-1},PrefabInstance={__type__:"cc.PrefabInstance",fileId:"",prefabRootNode:null,mountedChildren:[],propertyOverrides:[],removedComponents:[]},addPrefabInstance=function(e,_,r){var n=JSON.parse(JSON.stringify(PrefabInstance));return r&&(n.prefabRootNode={__id__:1}),n.fileId=Editor.Utils.UUID.generate(),_.push(n),_[e].instance={__id__:_.length-1},n},CCPropertyOverrideInfo={__type__:"CCPropertyOverrideInfo",targetInfo:null,propertyPath:[],value:null},createPropertyOverrideInfo=function(e,_){var r=JSON.parse(JSON.stringify(CCPropertyOverrideInfo)),n=[];return n.push("_lpos"===e?"position":"_lrot"===e?"rotation":"_lscale"===e?"scale":e),r.propertyPath=n,r.value=_,r},TargetInfo={__type__:"cc.TargetInfo",localID:[]},createTargetInfo=function(e){var _=JSON.parse(JSON.stringify(TargetInfo));return _.localID=e,_},CompPrefabInfo={__type__:"cc.CompPrefabInfo",fileId:""},addCompPrefabInfo=function(e,_){var r,e=_[e];"cc.Node"!==e.__type__&&e.node&&_[e.node.__id__]._prefab&&!e.__prefab&&((r=JSON.parse(JSON.stringify(CompPrefabInfo))).fileId=Editor.Utils.UUID.generate(),_.push(r),e.__prefab={__id__:_.length-1})},MountedChildrenInfo={__type__:"cc.MountedChildrenInfo",targetInfo:null,nodes:[]},addMountedChildrenInfo=function(e,_,r,n){var t=JSON.parse(JSON.stringify(MountedChildrenInfo)),n=(t.nodes=n,createTargetInfo(r));return{prefabInstanceID:e,mountedChildrenInfo:t,targetInfo:n}},INSTANCE_RESERVED_KEYWORDS=["__type__","_objFlags","_parent","_prefab","_id"];function compareBaseProp(e,_,r,n,t){var a=[];for(const f of["_lpos","_lrot","_lscale","_active","_name","_layer"]){var o=_[f],i=r[f];JSON.stringify(o)!==JSON.stringify(i)&&(i=createPropertyOverrideInfo(f,o),o=createTargetInfo(n),a.push({prefabInstanceID:e,propertyOverrideInfo:i,targetInfo:o}))}return a}function compareComponentIDProp(e,_,r,n,t,a,o,i){var f=t[_];if(!f)return null;var s="cc.Node"!==f.__type__;let d,c;if(s){if(!(c=f.node&&f.node.__id__))return null;d=t[c]}else d=f,c=_;var p=d&&d._prefab&&d._prefab.__id__,l=p&&t[p],u=l&&l.root&&l.root.__id__;if(!l||!l.asset||a.has(u)||0===l.asset.__id__)return null;t=t[u];if(!t)return null;var b=createTargetOverrideInfo();b.propertyPath=e;let I=[];e=totalPrefab.get(l.asset.__uuid__);if(!e)return console.warn(`Cannot get Base Prefab by UUID: ${l.asset.__uuid__}, PrefabInfo ID: ${c} name: ${d._name}.`),null;var h=e[0]&&e[0].data&&e[0].data.__id__,g=e&&e[h];let v,m;if(u===c?(v=g,m=h):(h=t._children.findIndex(e=>e.__id__===c),m=g._children[h]&&g._children[h].__id__,v=e[m]),s){t=d._components.findIndex(e=>e.__id__===_),g=v&&v._components[t]&&v._components[t].__id__,h=g&&e[g];if(!h||f.__type__!==h.__type__)return void a.set(u,p);I=getLocalID(g,e,s)}else{if(!v)return void a.set(u,p);I=getLocalID(m,e,s)}b.source={__id__:r};t=createTargetInfo(I);return b.target={__id__:l.root.__id__},{emptyProp:i,targetOverrideInfo:b,sourceInfo:n,targetInfo:t}}const SKIP_COMPONENT_KEY=["_name","_objFlags","node","__prefab","_id"];function compareComponentProp(_,r,e,n,t,a){var o=[],i=r.__id__,f=n[i],r=e&&e.__id__,s=t[r];if(s){let e=[];e=f.__prefab?getLocalID(r,t,!0):getLocalID(i,n,!0);for(const p in f)if(!SKIP_COMPONENT_KEY.includes(p)){var d=f[p];if(d)if(a[i]===p)continue;var c=s[p];JSON.stringify(d)!==JSON.stringify(c)&&(c=createPropertyOverrideInfo(p,d),d=createTargetInfo(e),o.push({prefabInstanceID:_,propertyOverrideInfo:c,targetInfo:d}))}}return o}function isEqual(e,_,r,n){if(!e._prefab||!_._prefab)return!1;var t=n[e._prefab.__id__],a=r[_._prefab.__id__];if(!t||!a)return!1;if("__uuid__"in a.asset&&t.asset.__uuid__!==a.asset.__uuid__)return!1;a=!!t.sync;if(!a){if(e.__type__!==_.__type__)return!1;if(e._children&&!_._children||!e._children&&_._children||!e._children&&!_._children)return!1;if(e._children.length<_._children.length)return!1;var o=e._children.map(e=>n[e.__id__]),i=_._children.map(e=>r[e.__id__]);for(let e=0;e<o.length;++e){var f=i[e];if(f&&!isEqual(o[e],i[e],r,n))return!1}if(e._components&&!_._components||!e._components&&_._components||!e._components&&!_._components)return!1;if(e._components.length!==_._components.length)return!1;var s=e._components.map(e=>n[e.__id__]),d=_._components.map(e=>r[e.__id__]);for(let e=0;e<s.length;++e){var c=s[e],p=d[e];if(!c||!p)return!1;if("cc.SkeletalAnimation"===c.__type__&&0<c._sockets.length)return!1;if(c.__type__!==p.__type__)return!1}}return!0}function isDiff(e,_){var r,n,t;return!e.asset||(r=e.root&&e.root.__id__,e=e.asset&&e.asset.__uuid__,(n=totalPrefab.get(e))?!isEqual(_[r],(t=n[0]&&n[0].data&&n[0].data.__id__)&&n[t],n,_):(console.warn(`Cannot get Prefab by UUID: ${e}
 PrefabInfo ID: ${r} name: ${_[r]._name} 
`),!0))}function addInstanceFileID(e,_,r){e.instance&&(_=_[e.instance.__id__])&&r.push(_.fileId)}function getLocalID(e,_,r=!1){var n,t=[];return r?(r=_[e])&&((n=r.node&&_[r.node.__id__])._prefab&&addInstanceFileID(n._prefab&&_[n._prefab.__id__],_,t),n=r.__prefab&&r.__prefab.__id__)&&(r=_[n],t.push(r.fileId)):(r=(n=_[e])._prefab&&_[n._prefab.__id__])&&(addInstanceFileID(r,_,t),t.push(r.fileId)),t}function isMountedChild(e,_,r,n){var t=e._prefab&&e._prefab.__id__;if(t&&r[t].sync)return!1;return e.__type__!==_.__type__}function compareChildren(_,r,n,t,a,o){let i=[],f=[],s=[];if(r._children)for(let e=0;e<r._children.length;++e){var d,c,p=r._children[e],p=p&&p.__id__,l=p&&a[p];l&&(!(c=n._children[e])||isMountedChild(l,d=t[c=c.__id__],a,t)?s.push({__id__:p}):(l._prefab?(i=getLocalID(c,t),(c=compareChildren(_,l,d,t,a,o))&&(f=f.concat(c.childPropertyOverrides),s=s.concat(c.childMountedNodes))):i=getLocalID(p,a),c=compareBaseProp(_,l,d,i,a),f=f.concat(c)))}if(r._components)for(let e=0;e<r._components.length;++e){var u=compareComponentProp(_,r._components[e],n._components[e],a,t,o);f=f.concat(u)}return{childPropertyOverrides:f,childMountedNodes:s}}function comparePrefab(e,_,r,n){let t=null,a=[];var o=e.root&&e.root.__id__,i=o&&_[o],e=e.asset.__uuid__,f=totalPrefab.get(e);if(f){var s=f[f[0]&&f[0].data&&f[0].data.__id__];if(s){var d=(s._prefab&&f[s._prefab.__id__]).fileId;let e=i._prefab&&_[i._prefab.__id__];e&&!e.instance&&(addPrefabInstance(i._prefab.__id__,_,r),e=_[i._prefab.__id__]);var r=e&&e.instance&&e.instance.__id__,c=compareBaseProp(r,i,s,[d],_),c=(a=a.concat(c),compareChildren(r,i,s,f,_,n)),{childPropertyOverrides:s,childMountedNodes:f}=c;return a=a.concat(s),0<f.length&&(n=[d],t=addMountedChildrenInfo(r,_,n,f)),{propertyOverrides:a,mountedChildrenInfo:t,childMountedNodes:f}}}else console.warn(`Cannot get Base Prefab by UUID: ${e}, PrefabInfo ID: ${o} name: ${i._name}.`)}function updateReplaceIDs(e,_,r){var n=(JSON.stringify(_).match(/(?<="__id__":)([0-9]+)/g)||[]).map(e=>Number(e));for(const a of e)for(let _=0;_<n.length;++_){var t=n[_];let e=r[_];e||(e={baseID:t,newID:t},r.push(e)),t>a&&e.newID--}}function addRemoveID(e,_){_.includes(e)||_.push(e)}function addRemove(e,_,r,n=!0){_=_[e];_._prefab&&(addRemoveID(_._prefab.__id__,r),_._prefab=null),_.__prefab&&(addRemoveID(_.__prefab.__id__,r),_.__prefab=null),_.instance&&(addRemoveID(_.instance.__id__,r),_.instance=null),n&&addRemoveID(e,r)}function restoreNormalNodes(_,r,e){var n=_._prefab&&_._prefab.__id__;if(!n||!r[n].instance){if(_._children){var t=_._children.map(e=>r[e.__id__]);for(const _ of t)restoreNormalNodes(_,r,e)}if(_._components)for(let e=0;e<_._components.length;++e){var a=r[_._components[e].__id__];a&&a.__prefab&&(a.__prefab=null)}n&&(_._prefab=null)}}const totalPrefab=new Map;async function beforeMigratePrefab(e){var _=e.getSwapSpace().json;if(0===totalPrefab.size)for(const t of await Editor.Message.request("asset-db","query-assets",{ccType:"cc.Prefab"}))!totalPrefab.has(t.uuid)&&t.file&&totalPrefab.set(t.uuid,(0,fs_extra_1.readJSONSync)(t.file));var r=_[0]&&"cc.Prefab"===_[0].__type__;for(let e=0;e<_.length;++e){var n=_[e];addCompPrefabInfo(e,_),"cc.PrefabInfo"===n.__type__&&(n.fileId||(n.fileId=Editor.Utils.UUID.generate()),n.sync)&&addPrefabInstance(e,_,r)}r&&totalPrefab.set(e.uuid,_)}function removeAllChild(e,_,r,n=!0,t){var a=_[e];for(const i of a._children){var o=Number(i.__id__);t&&t.includes(o)||(addRemove(o,_,r,n),removeAllChild(o,_,r,n,t))}_[e]._children.length=[];for(const f of a._components)addRemove(Number(f.__id__),_,r,n);_[e]._components.legnth=[]}function getTargetOverrideInfoForComponents(r,e,_,n,t,a,o){var i=[],f=n[r],s=n[f.node&&f.node.__id__];let d=r,c=null;var p,l=!t,s=s&&s._prefab&&n[s._prefab.__id__];s&&!l&&(p=s.asset&&0===s.asset.__id__,s.root&&a.has(s.root.__id__)||p||(p=getLocalID(e,t,!0),c=createTargetInfo(p),d=s.root.__id__));for(const m of _){let _;var u,b,I=f[m];if(I&&Array.isArray(I)&&I[0]&&I[0].__id__)for(let e=0;e<I.length;++e){var h,g,v=I[e];v&&(h=[m,e.toString()],g={componentID:r,key:m,idx:e},_=compareComponentIDProp(h,v.__id__,d,c,n,a,l,g))&&(o[r]=g.key,i.push(_))}else I&&I.__id__&&(u=[m],b={componentID:r,key:m,idx:-1},_=compareComponentIDProp(u,I.__id__,d,c,n,a,l,b))&&(o[r]=b.key,i.push(_))}return i}async function migratePrefab(_){var e=_.getSwapSpace();const s=e.json;var r=[];for(const M of e.json)if("cc.PrefabInfo"===M.__type__&&M.asset&&M.asset.__uuid__&&M.asset.__uuid__!==_.uuid){var n=M.asset.__uuid__;if(!r.includes(n)){r.push(n);var t=(0,asset_db_1.queryAsset)(n);if(t){t._init||(_._assetDB.taskManager.pause(_.task),await t.waitInit(),_._assetDB.taskManager.resume(_.task));try{const s=(0,fs_extra_1.readJSONSync)(t.library+".json");totalPrefab.has(n)||totalPrefab.set(n,s)}catch(e){console.error(e)}}else console.warn(`depends aseet uuid: ${n} missing in the scene: `+_.basename)}}const d=s[0]&&"cc.Prefab"===s[0].__type__;var a=d?"prefab":"scene",o=new Map;const f=[];const c=new Map;let p=[],l=[],u=[],i=[];const b=[];for(let e=0;e<s.length;++e){var I=s[e];if("cc.Node"===I.__type__&&I._prefab){var h=I._prefab.__id__,g=s[h];if(g&&g.root&&g.asset){let e=o.get(g.root.__id__);e?e.push(h):e=[h],o.set(g.root.__id__,e)}else c.get(e)||c.set(e,h),console.warn(`Prefab asset missing, name: ${I._name} in the ${a} : ${_.basename}.`)}}o.forEach((e,_,r)=>{var n=s[_];if(n){var n=n._prefab&&n._prefab.__id__,t=s[n];let e=!0;!(e=d?!!t.instance&&!t.sync:e)||isDiff(t,s)&&!c.get(_)&&c.set(_,n)}else console.warn("The prefab is bad. id: "+_)});for(const J of s)if("cc.Node"===J.__type__&&J._components){const T=J._components.map((e,_)=>{var r=s[e.__id__],n=[];for(const a in r){var t=r[a];!SKIP_COMPONENT_KEY.includes(a)&&t&&(Array.isArray(t)?t[0]&&t[0].__id__:t&&t.__id__)&&n.push(a)}if(0<n.length)return{index:_,__id__:e.__id__,keys:n}}).filter(Boolean);if(0!==T.length){let e;var v,m=J._prefab&&J._prefab.__id__,y=(J._prefab&&(v=(m=s[m])&&m.asset&&m.asset.__uuid__,0===(m.asset&&m.asset.__id__)?e=s:v&&!(e=totalPrefab.get(v))&&console.warn(`Cannot get Prefab by UUID: ${v}, the node name: ${J._name} in the ${a} : `+_.basename)),e&&e[1]);for(const k of T){var P=k.index,O=k.__id__,U=k.keys,O=getTargetOverrideInfoForComponents(O,y&&y._components[P]&&y._components[P].__id__,U,s,e,c,b);i=i.concat(O)}}}o.forEach((e,r,_)=>{var n=s[r];if(n){var n=n._prefab.__id__,t=s[n];let e=!0,_=!0;if(d&&(_=!!t.instance&&!t.sync,e=!!t.instance),(!_||!c.has(r))&&e)try{var a,o,i,f=comparePrefab(t,s,d,b);f&&({propertyOverrides:a,mountedChildrenInfo:o,childMountedNodes:i}=f,o&&(l=l.concat(o),p=p.concat(i)),u=u.concat(a))}catch(e){n&&!c.has(r)&&c.set(r,n),console.error(e)}}}),o.forEach((e,_,r)=>{if(!c.has(_)){var n=s[_],t=n._prefab&&n._prefab.__id__;t&&t.instance&&removeAllChild(_,s,f,!0,p);for(const o of e){var a=s[o];if(a.instance)for(const i in n)INSTANCE_RESERVED_KEYWORDS.includes(i)||delete n[i];delete a.sync,delete a._synced}}});for(const w of u){s.push(w.targetInfo);var N=s.length-1,N=(w.propertyOverrideInfo.targetInfo={__id__:N},s.push(w.propertyOverrideInfo),s.length-1);s[w.prefabInstanceID].propertyOverrides.push({__id__:N})}for(const R of l){s.push(R.targetInfo);var $=s.length-1,$=(R.mountedChildrenInfo.targetInfo={__id__:$},s.push(R.mountedChildrenInfo),s.length-1);s[R.prefabInstanceID].mountedChildren.push({__id__:$})}if(0<i.length){var A=[];for(const x of i){var D=x.emptyProp&&x.emptyProp.componentID;if(D){var D=s[D],D=D&&D.node&&D.node.__id__,D=s[D],D=D._prefab&&D._prefab.__id__,D=s[D],D=D&&D.root&&D.root.__id__;if(D&&c.has(D))continue}x.sourceInfo&&(s.push(x.sourceInfo),D=s.length-1,x.targetOverrideInfo.sourceInfo={__id__:D}),x.targetInfo&&(s.push(x.targetInfo),D=s.length-1,s.length,x.targetOverrideInfo.targetInfo={__id__:D}),s.push(x.targetOverrideInfo);D=s.length-1,D=(A.push({__id__:D}),x.emptyProp);if(D){var L=s[D.componentID];let e=L[D.key];Array.isArray(e)?e[D.idx]=null:e=null,L[D.key]=e}}addPrefabInfo(A,s)}for(const q of p){var C,S=q.__id__,j=s[S],E=s[j._prefab.__id__];E.instance||(C=E.root&&E.root.__id__)&&c.has(C)||(C=!E,addRemove(S,s,f,C),removeAllChild(S,s,f,C),j._prefab=null)}c.forEach((e,_,r)=>{var n=s[_];s[e].instance||(restoreNormalNodes(n,s,f),-1!==(_=addPrefabLink(s,_,e))&&n._components.push({__id__:_}))}),e.json=s}exports.beforeMigratePrefab=beforeMigratePrefab,exports.migratePrefab=migratePrefab;