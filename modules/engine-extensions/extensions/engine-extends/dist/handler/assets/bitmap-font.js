"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BitmapHandler=void 0;const asset_db_1=require("@editor/asset-db"),cc_1=require("cc"),fs_extra_1=require("fs-extra"),path_1=require("path"),image_utils_1=require("./utils/image-utils"),utils_1=require("../utils"),fntParser=require("../../../static/utils/fnt-parser");function getRealFntTexturePath(e,t){e=(0,path_1.basename)(e),t=(0,path_1.join)((0,path_1.dirname)(t.source),e);return(0,fs_extra_1.existsSync)(t)||console.warn("Parse Error: Unable to find file Texture, the path: "+t),t}const UserFlags={DoNotNotify:!1};function createBitmapFnt(e){var t=new cc.BitmapFont;return t.name=(0,path_1.basename)(e.source,e.extname),t.name=e.basename||"",t.fontSize=e.userData.fontSize,t.fntConfig=e.userData._fntConfig,t}exports.BitmapHandler={name:"bitmap-font",assetType:"cc.BitmapFont",importer:{version:"1.0.6",async import(t){var e=await(0,fs_extra_1.readFile)(t.source,"utf8");let r;try{r=fntParser.parseFnt(e)}catch(e){throw console.error(e),new Error(`BitmapFont import failed: ${t.uuid} file parsing failed`)}if(!(t.userData._fntConfig=r).fontSize)return console.error(`BitmapFont import failed: ${t.uuid} file parsing failed, There is no 'fontSize' in the configuration.`),!1;t.userData.fontSize=r.fontSize;e=getRealFntTexturePath(r.atlasName,t),t.depend(e),e=t._assetDB.pathToUuid(e);if(!e)return!1;if(t.userData.textureUuid=e,t.userData.textureUuid){e=(0,asset_db_1.queryAsset)(t.userData.textureUuid);if(!e)return!1;(0,image_utils_1.changeImageDefaultType)(e,"sprite-frame");var a=createBitmapFnt(t),e=(a.spriteFrame=EditorExtends.serialize.asAsset(e.uuid+"@f9941",cc_1.SpriteFrame),EditorExtends.serialize(a)),a=(await t.saveToLibrary(".json",e),(0,utils_1.getDependUUIDList)(e));t.setData("depends",a)}return!0}},async validate(e){return!0}},exports.default=exports.BitmapHandler;