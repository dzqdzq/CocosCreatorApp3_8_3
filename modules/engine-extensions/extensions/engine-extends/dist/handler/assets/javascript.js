"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.JavascriptHandler=void 0;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),script_compiler_1=require("./utils/script-compiler"),utils_1=require("../utils"),migrateStep=new utils_1.MigrateStep;async function _importPluginScript(e){var i=await(0,fs_extra_1.readFile)(e.source,"utf-8"),{executionScope:r="enclosed",experimentalHideCommonJs:t,experimentalHideAmd:s,simulateGlobals:a}=e.userData;return e.assignUserData({isPlugin:!0,loadPluginInEditor:!1,loadPluginInWeb:!0,loadPluginInMiniGame:!0,loadPluginInNative:!0},!1),"global"===r?await e.saveToLibrary(".js",i):(r=void 0===a?["self","window","global","globalThis"]:a,a=await(0,script_compiler_1.transformPluginScript)(i,{simulateGlobals:r,hideCommonJs:t??!0,hideAmd:s??!0}),await e.saveToLibrary(".js",a.code)),!0}exports.JavascriptHandler={name:"javascript",assetType:"cc.Script",open:utils_1.openCode,importer:{version:"4.0.24",migrations:[{version:"4.0.22",migrate(e){var i=e.userData,e=e.userData;!0===i.simulateGlobals?e.simulateGlobals=void 0:!1!==i.simulateGlobals&&void 0!==i.simulateGlobals||(e.simulateGlobals=[])}},{version:"4.0.23",migrate(e){e=e.userData;void 0!==e.importAsPlugin&&delete e.importAsPlugin}},{version:"4.0.24",async migrate(i){var e=i.userData;if(e.isPlugin&&Array.isArray(e.dependencies)&&e.dependencies.length){await migrateStep.hold();var r=await Editor.Profile.getProject("project","script.sortingPlugin");if(Array.isArray(r)&&r.length&&r.includes(i.uuid)){var t=r.findIndex(e=>e===i.uuid);for(const a of e.dependencies){var s=r.findIndex(e=>e===a);-1===s?r.splice(t,0,a):t<s&&(r.splice(s,1),r.splice(t,0,a))}}else{for(const o of e.dependencies)r.includes(o)||r.push(o);r.push(i.uuid)}await Editor.Profile.setProject("project","script.sortingPlugin",r),delete i.userData.dependencies,migrateStep.step()}}}],async import(i){if(!(i instanceof asset_db_1.Asset))return console.error("Expect non-virtual asset"),!1;var e=i.userData;try{return!e.isPlugin||await _importPluginScript(i)}catch(e){return console.error((0,utils_1.i18nTranslate)("asset-db.importers.javascript.transform_failure",{path:i.source,reason:e}),(0,utils_1.linkToAssetTarget)(i.uuid)),!1}}}},exports.default=exports.JavascriptHandler;