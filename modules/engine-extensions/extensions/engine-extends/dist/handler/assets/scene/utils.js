"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.walkPrefabInstances=exports.isNestedPrefab=exports.getPrefabOfNode=exports.walkNodeAsync=exports.walkNode=exports.getComponent=exports.walkAsync=exports.walk=void 0;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),fs_1=require("fs");function walk(e,_){if(Array.isArray(e))for(const t of e)walk(t,_);else if(e&&"object"==typeof e)if("__uuid__"in e)_(e);else for(const n of Object.values(e))walk(n,_)}async function walkAsync(e,_){if(Array.isArray(e))for(const t of e)await walk(t,_);else if(e&&"object"==typeof e)if("__uuid__"in e)await _(e);else for(const n of Object.values(e))await walk(n,_)}function getComponent(e,_,t){if(!("number"!=typeof _||_<0))for(const a of e[_]._components){var n=e[a.__id__];if(t.test(n.__type__))return n}return null}function walkNode(_,e,t){var n;!e||"number"!=typeof e.__id__||e.__id__<0||(n=_[e.__id__],t(n,e),n._children&&n._children.forEach(e=>{walkNode(_,e,t)}))}async function walkNodeAsync(_,e,t){if(e&&"number"==typeof e.__id__&&!(e.__id__<0)){var n=_[e.__id__];if(await t(n,e),n._children)for(let e=0;e<n._children.length;e++)await walkNodeAsync(_,n._children[e],t)}}function getPrefabOfNode(e,_){if(e&&_[e]){e=_[e];if(e&&"cc.Node"===e.__type__){e=e._prefab?.__id__;if(e&&_[e])return _[e]}}}function isNestedPrefab(e,_,t){return!(!e?._prefab?.__id__||!_[e._prefab.__id__]?.asset?.__uuid__)&&_[e._prefab.__id__]?.asset?.__uuid__!==t}exports.walk=walk,exports.walkAsync=walkAsync,exports.getComponent=getComponent,exports.walkNode=walkNode,exports.walkNodeAsync=walkNodeAsync,exports.getPrefabOfNode=getPrefabOfNode,exports.isNestedPrefab=isNestedPrefab;const walkPrefabInstanceChildren=async function(_,t,n,a,s){for(let e=0;e<_.length;e++){var o=_[e];await walkNodeAsync(t,o,async(e,_)=>{isNestedPrefab(e,t,s)?await walkPrefabInstances(e,t,n,a):(a(e),e._components&&e._components.forEach(e=>{e=t[e.__id__];e&&a(e)}))})}};async function walkPrefabInstances(e,t,n,a){if(e?._prefab?.__id__){a(e,t);var e=t[e._prefab.__id__],s=e?.asset?.__uuid__;if(s){var o=(0,asset_db_1.queryAsset)(s);if(o&&o.source){let _=[],e;if(e=o.source.includes("@")?(o.init||(o._assetDB.taskManager.pause(n.task),await o.waitInit(),o._assetDB.taskManager.resume(n.task)),o.library+".json"):o.source,(0,fs_1.existsSync)(e))try{_=(0,fs_extra_1.readJSONSync)(e)}catch(e){console.warn(e)}if(!_[0]||!_[0]?.data?.__id__)return;o=_[_[0].data.__id__];o?._children&&await walkPrefabInstanceChildren(o._children,_,n,a,s),o?._components&&o._components.forEach(e=>{e=_[e.__id__];e&&a(e)})}o=e?.instance?.__id__;if(o&&t[o]){e=t[o];if(e.mountedChildren&&0<e.mountedChildren.length){const r=[];e.mountedChildren.forEach(e=>{e=t[e.__id__];if(e&&e.nodes)for(const _ of e.nodes)r.push(_)}),await walkPrefabInstanceChildren(r,t,n,a,s)}e.mountedComponents&&0<e.mountedComponents.length&&e.mountedComponents.forEach(e=>{e=t[e.__id__];if(e&&e.components)for(const _ of e.components)_.__id__&&t[_.__id__]&&a(t[_.__id__])})}}}}exports.walkPrefabInstances=walkPrefabInstances;