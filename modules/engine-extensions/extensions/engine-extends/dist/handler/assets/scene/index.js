"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SceneHandler=exports.versionCode=exports.version=void 0;const migrates_1=require("./migrates"),fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("../../utils"),migration_utils_1=require("../utils/migration-utils");function changeSceneUuid(e,t){return e[1]._id!==t&&(e[1]._id=t,!0)}async function queryDefaultTemplateURL(){var e="db://internal/default_file_content/scene";let t=e+"/default.scene";var r=await Editor.Profile.getProject("engine","modules.includeModules");return r&&!r.includes("3d")?t=e+"/scene-2d.scene":await Editor.Profile.getProject("project","general.highQuality")&&(t=e+"/scene-quality.scene"),t}exports.version="1.1.50",exports.versionCode=1,exports.SceneHandler={name:"scene",assetType:"cc.SceneAsset",open(e){e._assetDB.options.readonly||Editor.Message.send("scene","open-scene",e.uuid)},createInfo:{async generateMenuInfo(){var e=await queryDefaultTemplateURL();return[{label:"i18n:ENGINE.assets.newScene",fullFileName:e.endsWith("default.scene")?"scene.scene":(0,path_1.basename)(e),template:e,group:"scene"}]}},customOperationMap:{queryDefaultContent:{async operator(){var e=await queryDefaultTemplateURL(),e=await(0,fs_extra_1.readJSON)(Manager.Utils.url2path(e));return await changeSceneUuid(e,Editor.Utils.UUID.generate(!1)),e}}},importer:{version:exports.version,versionCode:exports.versionCode,migrations:migrates_1.migrations,migrationHook:migration_utils_1.migrationHook,async import(e){var t=await(0,fs_extra_1.readJSON)(e.source),r=(0,path_1.basename)(e.source,(0,path_1.extname)(e.source));let a=t[0]._name!==r;a&&(t[0]._name=r);try{a=a||(0,utils_1.removeNull)(t,e.uuid)}catch(e){console.debug(e)}(a=changeSceneUuid(t,e.uuid)||a)&&(r=JSON.stringify(t,void 0,2),await(0,fs_extra_1.writeFile)(e.source,r));r=JSON.stringify(t,void 0,2),await e.saveToLibrary(".json",r),t=(0,utils_1.getDependList)(r);return e.setData("depends",t.uuids),e.setData("dependScripts",t.dependScriptUuids),!0}}},exports.default=exports.SceneHandler;