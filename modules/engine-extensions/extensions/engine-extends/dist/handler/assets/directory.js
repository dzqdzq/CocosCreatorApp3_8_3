"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),path_1=require("path"),migrate_bundle_config_1=require("./migrates/migrate-bundle-config"),InternalBundleName=["internal","resources","main"],DirectoryHandler={name:"directory",importer:{version:"1.2.0",migrations:[{version:"1.1.0",migrate:migrateSubpackageSettings},{version:"1.2.0",migrate:migrateBundleConfig}],async import(e){return"db://assets/resources"===(0,asset_db_1.queryUrl)(e.uuid)&&(e.userData.isBundle=!0,e.userData.bundleConfigID=e.userData.bundleConfigID??"default",e.userData.bundleName="resources",e.userData.priority=8),!0}},iconInfo:{default:{value:"directory",type:"icon"},generateThumbnail(e){return e.userData.isBundle?{value:"bundle-folder",type:"icon"}:{value:"directory",type:"icon"}}},createInfo:{generateMenuInfo(){return[{label:"i18n:ENGINE.assets.newFolder",fullFileName:"folder"}]},async create(e){return(0,fs_extra_1.ensureDirSync)(e.target),e.target}},async validate(e){return e.isDirectory()}};function migrateSubpackageSettings(e){e.userData.isBundle=!1,e.userData.priority=1,e.userData.bundleName="",e.userData.compressionType={},e.userData.isRemoteBundle={},e.userData.isSubpackage&&(e.userData.isBundle=e.userData.isSubpackage,e.userData.bundleName=e.userData.subpackageName||"",e.userData.priority=5),e.userData.isSubpackage=void 0,e.userData.subpackageName=void 0}async function migrateBundleConfig(a){if(a.userData.isBundle&&!a.userData.bundleConfigID){console.debug("migrateBundleConfig for asset with config "+a.userData);var{compressionType:r,isRemoteBundle:t,bundleName:s}=a.userData,u="auto_"+Editor.Utils.UUID.generate();let e=s||(0,path_1.basename)(a.source).replace(/[^a-zA-Z0-9_-]/g,"_");InternalBundleName.includes(e)&&"db://assets/resources"!==a.url&&(e=e+"_"+u,console.warn(`Bundle {asset(${a.url})} `+Editor.I18n.t("builder.asset_bundle.duplicate_reserved_keyword_message",{name:e})));s=(0,migrate_bundle_config_1.mergeBundleConfig)(r,t,e);Editor.Profile.setProject("builder","bundleConfig.custom."+u,s),a.userData.bundleConfigID=u,delete a.userData.compressionType,delete a.userData.isRemoteBundle}}exports.default=DirectoryHandler;