"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,a){e[a=void 0===a?r:a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TexturePackerImporter=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),migratesNameToId=__importStar(require("./migrates/name2id")),sprite_frame_1=require("./sprite-frame"),sprite_atlas_1=__importStar(require("./sprite-atlas")),cc_1=require("cc"),utils_1=require("../utils"),plist=require("plist");class TexturePackerImporter extends sprite_atlas_1.default{get version(){return"1.0.8"}get migrations(){return[{version:"1.0.4",migrate:migratesNameToId.migrate}]}async validate(e){try{var t=plist.parse(await fs_extra_1.readFile(e.source,"utf8"));return void 0!==t.frames&&void 0!==t.metadata}catch(e){return!1}}async import(e){path_1.extname(e.source);var t=e.userData,r=await fs_extra_1.readFile(e.source,"utf8"),a=plist.parse(r),r=a.metadata;if(t.atlasTextureName=r.realTextureFileName||r.textureFileName,t.format=r.format,t.uuid=e.uuid,this.assetDB){r=path_1.basename(t.atlasTextureName),r=path_1.join(path_1.dirname(e.source),r),r=(fs_extra_1.existsSync(r)||console.warn("Parse Error: Unable to find file Texture, the path: "+r),e.depend(r),this.assetDB.pathToUuid(r));if(!r)return!1;t.textureUuid=r+"@"+require("@editor/asset-db/libs/utils").nameToId("texture")}if(e.userData.textureUuid&&this.assetDB){var i=/\.[^.]+$/,r=Object.keys(a.frames),s=new cc.SpriteAtlas;s.name=e.basename||"";for(const n of r){var u=n.replace(i,""),o=a.frames[n],d=await e.createSubAsset(u,"sprite-frame"),o=this.fillFrameData(o,t);o.borderBottom=o.borderBottom|d.userData.borderBottom,o.borderTop=o.borderTop|d.userData.borderTop,o.borderLeft=o.borderLeft|d.userData.borderLeft,o.borderRight=o.borderRight|d.userData.borderRight,"packable"in d.userData&&(o.packable=d.userData.packable),d.assignUserData(o,!0),d.userData.imageUuidOrDatabaseUri=o.imageUuidOrDatabaseUri,s.spriteFrames[u]=EditorExtends.serialize.asAsset(d.uuid,cc_1.SpriteFrame)}r=EditorExtends.serialize(s),r=(await e.saveToLibrary(".json",r),utils_1.getDependUUIDList(r));e.setData("depends",r)}return!0}fillFrameData(e,t){var r=t.format,t=sprite_frame_1.makeDefaultSpriteFrameAssetUserDataFromImageUuid(t.textureUuid,t.uuid);let a=!1,i="",s="",u="";1===r||2===r?(a=e.rotated,i=e.sourceSize,s=e.offset,u=e.frame):3===r&&(a=e.textureRotated,i=e.spriteSourceSize,s=e.spriteOffset,u=e.textureRect),t.rotated=a;r=sprite_atlas_1._parseFloat2(i,cc_1.Size),t.rawWidth=r.width,t.rawHeight=r.height,e=sprite_atlas_1._parseRect(u),t.trimX=e.x,t.trimY=e.y,t.width=e.width,t.height=e.height,r=sprite_atlas_1._parseFloat2(s,cc_1.Vec2);return t.offsetX=r.x,t.offsetY=r.y,t}}exports.TexturePackerImporter=TexturePackerImporter;