"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrateChunkFolders=exports.migrateMacroUseBatching=exports.migrateCSMInclude=exports.migrateMacroUseLightMap=exports.migrateIncludeDecodeBase=exports.migrateDefines=exports.migrateEnableDirShadow=exports.EffectImporter=void 0;const asset_db_1=require("@editor/asset-db"),cc_1=require("cc"),custom_pipeline_1=require("cc/editor/custom-pipeline"),fs_extra_1=require("fs-extra"),path_1=require("path"),effect_compiler_1=require("../../../static/effect-compiler"),utils_1=require("../utils"),closure={root:"",dir:""};effect_compiler_1.options.throwOnWarning=!0,effect_compiler_1.options.skipParserTest=!0,effect_compiler_1.options.getAlternativeChunkPaths=e=>[path_1.relative(closure.root,path_1.resolve(closure.dir,e)).replace(/\\/g,"/")],effect_compiler_1.options.chunkSearchFn=c=>{const i={name:void 0,content:void 0};return asset_db_1.forEach(a=>{if(void 0===i.content)for(let e=0;e<c.length;e++){var t=c[e],r=path_1.resolve(a.options.target,"chunks",t+".chunk");if(fs_extra_1.existsSync(r)){i.name=t,i.content=fs_extra_1.readFileSync(r,{encoding:"utf-8"});break}}}),i};class EffectImporter extends asset_db_1.Importer{constructor(){super(...arguments),this.waitingGenEffectBin=!1,this.waitingGenEffectBinTimmer=null}get version(){return"1.7.0"}get name(){return"effect"}get assetType(){return"cc.EffectAsset"}get migrations(){return migrations}_rebuildDescriptorHierarchy(e){var a=[];for(const r of e){var t=path_1.join(r.temp,"materialxxx.json");fs_extra_1.existsSync(t)||a.push(r)}return a}async buildCustomLayout(e,a){var t=new custom_pipeline_1.VisibilityGraph;for(const o of e){var r=o.library+".json",r=await fs_extra_1.readJSON(r),r=cc.deserialize(r);t.mergeEffect(r)}var c=new custom_pipeline_1.LayoutGraphInfo(t);for(const n of e){var i=n.library+".json",i=await fs_extra_1.readJSON(i),i=cc.deserialize(i);c.addEffect(i)}c.build()&&console.error("build failed"),custom_pipeline_1.buildLayoutGraphData(c.lg,a)}async afterImport(e){const a=[];asset_db_1.forEach(e=>{e.path2asset.forEach(e=>{"effect"===e.meta.importer&&a.push(e)})}),await this.recompileAllEffects(a,e)}async recompileAllEffects(e,a){var t=path_1.join(Editor.Project.tmpDir,"asset-db/effect/effect.bin");!a&&!this.waitingGenEffectBin&&fs_extra_1.existsSync(t)||(e=e.filter(e=>e.imported),this.waitingGenEffectBin=!1,this.waitingGenEffectBinTimmer&&clearTimeout(this.waitingGenEffectBinTimmer),a=new custom_pipeline_1.LayoutGraphData,await this.buildCustomLayout(e,a),await fs_extra_1.ensureDir(path_1.dirname(t)),e=new custom_pipeline_1.BinaryOutputArchive,custom_pipeline_1.saveLayoutGraphData(e,a),await fs_extra_1.writeFile(t,e.buffer),console.debug("recompile effect.bin success"))}async import(t){try{var e=this.assetDB.options.target,a=(closure.root=path_1.join(e,"chunks"),closure.dir=path_1.dirname(t.source),path_1.relative(path_1.join(e,"effects"),closure.dir).replace(/\\/g,"/")),r=a+(a.length?"/":"")+path_1.basename(t.source,path_1.extname(t.source)),c=fs_extra_1.readFileSync(t.source,{encoding:"utf-8"});const s=effect_compiler_1.buildEffect(r,c);asset_db_1.forEach(e=>{for(const a of s.dependencies)t.depend(path_1.resolve(e.options.target,"chunks",a+".chunk"))});var i=new cc_1.EffectAsset,o=(Object.assign(i,s),s.editor&&s.editor.hide&&(i.hideInEditor=!0),t.userData&&(t.userData.combinations&&(i.combinations=t.userData.combinations),s.editor?t.userData.editor=s.editor:t.userData.editor=void 0),EditorExtends.serialize(i)),n=(await t.saveToLibrary(".json",o),utils_1.getDependUUIDList(o));return t.setData("depends",n),this.waitingGenEffectBin=!0,t._assetDB.flag.started&&EffectImporter.autoGenEffectBin&&(this.waitingGenEffectBinTimmer&&clearTimeout(this.waitingGenEffectBinTimmer),this.waitingGenEffectBinTimmer=setTimeout(()=>{this.afterImport()},500)),!0}catch(e){return console.error(e),!1}}}(exports.EffectImporter=EffectImporter).autoGenEffectBin=!1;const migrations=[{version:"1.3.7",migrate:migrateEditorProps},{version:"1.4.2",migrate:migrateUVAttribute},{version:"1.4.7",migrate:migrateStandardTransparent},{version:"1.4.8",migrate:migrateApplyFog},{version:"1.4.9",migrate:e=>{migrateMacroToFunction(e),migrateEnableDirShadow(e)}},{version:"1.5.0",migrate:migrateMacroToFunction},{version:"1.5.1",migrate:migrateShadowFactorParameter},{version:"1.5.2",migrate:migrateDefines},{version:"1.5.3",migrate:migrateIncludeDecodeBase},{version:"1.5.4",migrate:migrateSpecularIntensity},{version:"1.5.5",migrate:migrateUnpackLightingMap},{version:"1.5.6",migrate:migrateMacroUseLightMap},{version:"1.5.7",migrate:migrateChunkFolders},{version:"1.5.8",migrate:migrateCSMInclude},{version:"1.6.0",migrate:migrateMacroUseBatching},{version:"1.6.1",migrate:migrateGetLightingMapAlpha}],inspectorRE=/inspector\s*:/g;function migrateEditorProps(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a=a.replace(inspectorRE,"editor:"),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const UVAttribute=/in\s*vec2\s*a_texCoord\s*;/,inputIncludeRE=/include.*input/;function migrateUVAttribute(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(inputIncludeRE)&&(a=a.replace(UVAttribute,"")),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const MacroStandardTransparent=/CC_STANDARD_TRANSPARENT/g,ReplaceTransparentWithForward="CC_FORCE_FORWARD_SHADING";function migrateStandardTransparent(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(MacroStandardTransparent)&&(a=a.replace(MacroStandardTransparent,ReplaceTransparentWithForward)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const MacroApplyFog=/[a-zA-Z_][a-zA-Z_0-9]*\s*=\s*CC_APPLY_FOG/g,ReplaceApplyFog="CC_APPLY_FOG",MacroTransferFog=/[a-zA-Z_][a-zA-Z_0-9]*\s*=\s*CC_TRANSFER_FOG/g,ReplaceTransferFog="CC_TRANSFER_FOG";function migrateApplyFog(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});(a=a.match(MacroApplyFog)?a.replace(MacroApplyFog,ReplaceApplyFog):a).match(MacroTransferFog)&&(a=a.replace(MacroTransferFog,ReplaceTransferFog)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const MacroEnableDirShadow=/&&\s*CC_ENABLE_DIR_SHADOW/g,ReplaceEnableDirShadow="";function migrateEnableDirShadow(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(MacroEnableDirShadow)&&(a=a.replace(MacroEnableDirShadow,ReplaceEnableDirShadow)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}exports.migrateEnableDirShadow=migrateEnableDirShadow;const MacroShadowFactor=/CC_SHADOW_FACTOR\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceShadowFactor="$1 = CCShadowFactorBase(CC_SHADOW_POSITION, $2)",MacroShadowFactorBase=/CC_SHADOW_FACTOR_BASE\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceShadowFactorBase="$1 = CCShadowFactorBase($2, $3)",MacroSpotShadowFactor=/CC_SPOT_SHADOW_FACTOR\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceSpotShadowFactor="$1 = CCSpotShadowFactorBase(CC_SHADOW_POSITION, $2)",MacroSpotShadowFactorBase=/CC_SPOT_SHADOW_FACTOR_BASE\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceSpotShadowFactorBase="$1 = CCSpotShadowFactorBase($2, $3)";function migrateMacroToFunction(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});(a=(a=(a=a.match(MacroShadowFactorBase)?a.replace(MacroShadowFactorBase,ReplaceShadowFactorBase):a).match(MacroShadowFactor)?a.replace(MacroShadowFactor,ReplaceShadowFactor):a).match(MacroSpotShadowFactorBase)?a.replace(MacroSpotShadowFactorBase,ReplaceSpotShadowFactorBase):a).match(MacroSpotShadowFactor)&&(a=a.replace(MacroSpotShadowFactor,ReplaceSpotShadowFactor)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const ShadowFactorBaseParameter=/CCShadowFactorBase\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceShadowFactorBaseParameter="CCShadowFactorBase($1, $2, vec2(0.0, 0.0))",SpotShadowFactorBaseParameter=/CCSpotShadowFactorBase\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceSpotShadowFactorBaseParameter="CCSpotShadowFactorBase($1, $2, vec2(0.0, 0.0))";function migrateShadowFactorParameter(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});(a=a.match(ShadowFactorBaseParameter)?a.replace(ShadowFactorBaseParameter,ReplaceShadowFactorBaseParameter):a).match(SpotShadowFactorBaseParameter)&&(a=a.replace(SpotShadowFactorBaseParameter,ReplaceSpotShadowFactorBaseParameter)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const DefineMetaRE=/#pragma\s+define\s+/g,DefineRE=/#define/g;function migrateDefines(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a=(a=a.replace(DefineMetaRE,"#pragma define-meta ")).replace(DefineRE,"#pragma define"),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}exports.migrateDefines=migrateDefines;const IncludeLocalBatch1=/(\s*)#include\s*<cc-local-batch>/g,IncludeLocalBatch2=/(\s*)#include\s*"cc-local-batch"/g,ReplaceIncludeLocalBatch="$1#include <decode-base>$1#include <cc-local-batch>";function migrateIncludeDecodeBase(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});(a=a.match(IncludeLocalBatch1)?a.replace(IncludeLocalBatch1,ReplaceIncludeLocalBatch):a).match(IncludeLocalBatch2)&&(a=a.replace(IncludeLocalBatch2,ReplaceIncludeLocalBatch)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}exports.migrateIncludeDecodeBase=migrateIncludeDecodeBase;const MetallicParam=/(\s*)s.metallic\s*=/g,ReplaceMetallicParam="$1s.specularIntensity = 0.5;$1s.metallic =";function migrateSpecularIntensity(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(MetallicParam)&&(a=a.replace(MetallicParam,ReplaceMetallicParam)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const UnpackLightingMap=/UnpackLightingmap\s*\(\s*([\w.\[\]]+)\s*\)/g,ReplaceUnpackLightingMap="$1.rgb";function migrateUnpackLightingMap(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(UnpackLightingMap)&&(a=a.replace(UnpackLightingMap,ReplaceUnpackLightingMap)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const UseLightMap=/(\s+)USE_LIGHTMAP/g,ReplaceUseLightMap="$1CC_USE_LIGHTMAP";function migrateMacroUseLightMap(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(UseLightMap)&&(a=a.replace(UseLightMap,ReplaceUseLightMap)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}exports.migrateMacroUseLightMap=migrateMacroUseLightMap;const CCShadow=/(\s*)#include\s*<builtin\/uniforms\/cc-shadow>/g,ReplaceCCShadow="$1#include <builtin/uniforms/cc-shadow>\n#if CC_SUPPORT_CASCADED_SHADOW_MAP\n  #include <builtin/uniforms/cc-csm>\n#endif";function migrateCSMInclude(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(CCShadow)&&(a=a.replace(CCShadow,ReplaceCCShadow)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}exports.migrateCSMInclude=migrateCSMInclude;const CCBatching=/&&\s+!USE_BATCHING\s*/g;function migrateMacroUseBatching(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(CCBatching)&&(a=a.replace(CCBatching,"")),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}exports.migrateMacroUseBatching=migrateMacroUseBatching;const UseShadingStandBaseInclude=/#include.*standard-surface-entry/g,GetLightingMapAlpha1=/(\s*)s.lightmap.rgb\s*=\s*([a-zA-Z]+)/g,GetLightingMapAlpha2=/(\s*)s.lightmap\s*=\s*([a-zA-Z]+)/g,ReplaceGetLightingMapAlpha="$1s.lightmap.a = $2.a;$1s.lightmap.rgb = $2";function migrateGetLightingMapAlpha(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(UseShadingStandBaseInclude)&&(a=a.match(GetLightingMapAlpha1)?a.replace(GetLightingMapAlpha1,ReplaceGetLightingMapAlpha):a).match(GetLightingMapAlpha2)&&(a=a.replace(GetLightingMapAlpha2,ReplaceGetLightingMapAlpha)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}function migrateChunkFolders(e){var a,t,r,c,i=new Map([["cc-fog-base","legacy/fog-base"],["cc-shadow-map-base","legacy/shadow-map-base"],["morph","legacy/morph"],["cc-skinning","legacy/skinning"],["cc-local-batch","legacy/local-batch"],["lighting","legacy/lighting"],["lightingmap-fs","legacy/lightingmap-fs"],["cc-shadow-map-vs","legacy/shadow-map-vs"],["cc-shadow-map-fs","legacy/shadow-map-fs"],["cc-fog-vs","legacy/fog-vs"],["cc-fog-fs","legacy/fog-fs"],["lightingmap-vs","legacy/lightingmap-vs"],["decode","legacy/decode"],["decode-base","legacy/decode-base"],["decode-standard","legacy/decode-standard"],["input","legacy/input"],["input-standard","legacy/input-standard"],["output","legacy/output"],["output-standard","legacy/output-standard"],["shading-standard","legacy/shading-standard"],["shading-standard-base","legacy/shading-standard-base"],["shading-standard-additive","legacy/shading-standard-additive"],["shading-cluster-additive","legacy/shading-cluster-additive"],["shading-toon","legacy/shading-toon"],["standard-surface-entry","legacy/standard-surface-entry"],["alpha-test","builtin/internal/alpha-test"],["cc-sprite-common","builtin/internal/sprite-common"],["cc-sprite-texture","builtin/internal/sprite-texture"],["embedded-alpha","builtin/internal/embedded-alpha"],["particle-common","builtin/internal/particle-common"],["cc-global","builtin/uniforms/cc-global"],["cc-local","builtin/uniforms/cc-local"],["cc-forward-light","builtin/uniforms/cc-forward-light"],["cc-environment","builtin/uniforms/cc-environment"],["cc-diffusemap","builtin/uniforms/cc-diffusemap"],["cc-shadow","builtin/uniforms/cc-shadow"],["cc-csm","builtin/uniforms/cc-csm"],["cc-world-bound","builtin/uniforms/cc-world-bound"],["builtin/uniforms/cc-skinning-uniforms","builtin/uniforms/cc-skinning"],["common","common/common-define"],["texture-lod","common/texture/texture-lod"],["packing","common/data/packing"],["unpack","common/data/unpack"],["aces","common/color/aces"],["gamma","common/color/gamma"],["octahedron-transform","common/math/octahedron-transform"],["transform","common/math/transform"],["rect-area-light","common/lighting/rect-area-light"],["fxaa","post-process/fxaa"],["anti-aliasing","post-process/anti-aliasing"]]),o=new Map([["vert:\\s+particle-vs-gpu","vert: builtin/internal/particle-vs-gpu"],["vert:\\s+particle-vs-legacy","vert: builtin/internal/particle-vs-legacy"],["vert:\\s+particle-trail","vert: builtin/internal/particle-trail"],["vert:\\s+outline-vs","vert: legacy/main-functions/outline-vs"],["frag:\\s+outline-fs","frag: legacy/main-functions/outline-fs"],["vert:\\s+general-vs","vert: legacy/main-functions/general-vs"],["CCGetShadowFactorSoft2X","CCGetDirLightShadowFactorSoft3X"],["CCGetShadowFactorSoft","CCGetDirLightShadowFactorSoft"],["CCGetShadowFactorHard","CCGetDirLightShadowFactorHard"],["CCGetSpotLightShadowFactorSoft2X","CCGetSpotLightShadowFactorSoft3X"]]);let n=fs_extra_1.readFileSync(e.source,{encoding:"utf8"}),s=!1;for([a,t]of i){var l=new RegExp("#include\\s+<"+a+">","g"),d=new RegExp('#include\\s+"'+a+'"',"g"),g="#include <"+t+">";n.match(l)&&(n=n.replace(l,g),s=!0),n.match(d)&&(n=n.replace(d,g),s=!0)}for([r,c]of o){var p=new RegExp(r,"g"),u=c;n.match(p)&&(n=n.replace(p,u),s=!0)}s&&fs_extra_1.writeFileSync(e.source,n,{encoding:"utf8"})}exports.migrateChunkFolders=migrateChunkFolders;