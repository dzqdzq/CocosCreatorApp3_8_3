"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.upgradeProperties=void 0;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),auxMap={x:"r",y:"g",z:"b",w:"a",r:"x",g:"y",b:"z",a:"w"};function getVectorComponent(e,r){var t=e[r],e=e[auxMap[r]];return void 0!==t?t:void 0!==e?e:0}const idxMap=["x","y","z","w"];function serializeAsVector(e){const t={__type__:"cc.Vec"+e.length};return e.forEach((e,r)=>t[idxMap[r]]=e),t}const defineRE=/<\s*(\w+)\s*(?:\|\s*(\w+))?\s*>/g,targetRE=/(\w+)\s*(?:\.\s*([xyzw]+|[rgba]+))?/i;function handleFormerlySerializedAs(e,r,t,s,a){let o=defineRE.exec(s),i=!1;for(o&&o[0].length>=s.length-1&&(i=!0);o;){var n=r[o[1]]||o[2]||"",d=o.index,l=o.index+o[0].length;s=s.substring(0,d)+n+s.substring(l),defineRE.lastIndex=0,o=defineRE.exec(s)}var c,p=targetRE.exec(s);if(!p)return console.warn(`formerlySerializedAs: illegal target '${s}', upgrade skipped`),!1;if(!s.endsWith("!")&&void 0!==e[t])return!1;if(i)return e[t]!==s&&(e[t]=s,!0);const f=e[p[1]];return void 0!==f&&((c=p[2]&&p[2].toLowerCase()||"")&&"object"!=typeof f?(console.warn(`formerlySerializedAs: '${s}' expected an object, get ${typeof f} in ${a}, upgrade skipped`),!1):4<c.length?(console.warn(`formerlySerializedAs: illegal target '${s}', upgrade skipped`),!1):(0===c.length?(e[t]=f,delete e[p[1]]):1===c.length?e[t]=getVectorComponent(f,c):(a=c.split("").map(e=>getVectorComponent(f,e)),e[t]=serializeAsVector(a)),!0))}async function upgradeProperties(r,e){var t=e.uuid,s=r._effectAsset&&r._effectAsset.__uuid__;let a=!1;if(!s)return!1;s=asset_db_1.queryAsset(s);if(!s)return!1;e._assetDB.taskManager.pause(e.task),await s.waitInit(),e._assetDB.taskManager.resume(e.task);var o=fs_extra_1.readJSONSync(s.library+".json").techniques[r._techIdx].passes;for(let e=0;e<o.length;e++){var i=o[e].migrations;if(i){var n=r._props[e],d=r._defines[e];if(i.properties&&n&&d){for(const p of Object.keys(i.properties)){var l=i.properties[p].formerlySerializedAs;l&&(a=handleFormerlySerializedAs(n,d,p,l,t)||a)}for(const f of Object.keys(i.properties))i.properties[f].removeImmediately&&(delete n[f],a=!0)}if(i.macros&&d){for(const u of Object.keys(i.macros)){var c=i.macros[u].formerlySerializedAs;c&&(a=handleFormerlySerializedAs(d,d,u,c,t)||a)}for(const g of Object.keys(i.macros))i.macros[g].removeImmediately&&(delete d[g],a=!0)}}}return a}exports.upgradeProperties=upgradeProperties;