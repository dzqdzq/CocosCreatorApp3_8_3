"use strict";var GltfAssetKind,__createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){e[s=void 0===s?r:s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GlTfConformanceError=exports.isDataUri=exports.readGltf=exports.GltfConverter=exports.doCreateSocket=exports.getWorldTransformUntilRoot=exports.getPathFromRoot=exports.isFilesystemPath=void 0;const DataURI=__importStar(require("@cocos/data-uri")),cc=__importStar(require("cc")),cc_1=require("cc"),fs=__importStar(require("fs-extra")),path=__importStar(require("path")),glTF_meta_1=require("../../meta-schemas/glTF.meta"),texture_base_1=require("../texture-base"),base64_1=require("./base64"),glTF_constants_1=require("./glTF.constants"),khr_draco_mesh_compression_1=require("./khr-draco-mesh-compression"),pp_geometry_1=require("./pp-geometry"),extras_1=require("@editor/fbx-gltf-conv/lib/extras"),exotic_animation_1=require("cc/editor/exotic-animation"),glTF_animation_utils_1=require("./glTF-animation-utils"),color_utils_1=require("cc/editor/color-utils");function isFilesystemPath(e){return!e.isDataUri}function getPathFromRoot(e,t){let r=e,s="";for(;null!==r&&r!==t;)s=r.name+"/"+s,r=r.parent;return s.slice(0,-1)}function getWorldTransformUntilRoot(e,t,r,s,n){for(cc_1.Vec3.set(r,0,0,0),cc_1.Quat.set(s,0,0,0,1),cc_1.Vec3.set(n,1,1,1);e!==t;)cc_1.Vec3.multiply(r,r,e.scale),cc_1.Vec3.transformQuat(r,r,e.rotation),cc_1.Vec3.add(r,r,e.position),cc_1.Quat.multiply(s,e.rotation,s),cc_1.Vec3.multiply(n,e.scale,n),e=e.parent}exports.isFilesystemPath=isFilesystemPath,exports.getPathFromRoot=getPathFromRoot,exports.getWorldTransformUntilRoot=getWorldTransformUntilRoot,function(e){e[e.Node=0]="Node",e[e.Mesh=1]="Mesh",e[e.Texture=2]="Texture",e[e.Skin=3]="Skin",e[e.Animation=4]="Animation",e[e.Image=5]="Image",e[e.Material=6]="Material",e[e.Scene=7]="Scene"}(GltfAssetKind=GltfAssetKind||{});const qt=new cc_1.Quat,v3a=new cc_1.Vec3,v3b=new cc_1.Vec3,v3Min=new cc_1.Vec3,v3Max=new cc_1.Vec3;function doCreateSocket(t,r,s){const n=getPathFromRoot(s.parent,t);if(s.parent!==t){let e=r.find(e=>e.path===n);var a;e||((a=new cc.Node).name=s.parent.name+" Socket",a.parent=t,getWorldTransformUntilRoot(s.parent,t,v3a,qt,v3b),a.setPosition(v3a),a.setRotation(qt),a.setScale(v3b),e=new cc.SkeletalAnimation.Socket(n,a),r.push(e)),s.parent=e.target}}exports.doCreateSocket=doCreateSocket;const skinRootNotCalculated=-2,skinRootAbsent=-1,supportedExtensions=new Set(["KHR_draco_mesh_compression","KHR_materials_pbrSpecularGlossiness","KHR_materials_unlit","KHR_texture_transform"]);class GltfConverter{constructor(e,t,r,s){this._gltf=e,this._buffers=t,this._gltfFilePath=r,this._promotedRootNodes=[],this._parents=[],this._skinRoots=[],this._processedMeshes=[],this._socketMappings=new Map,this._fbxMissingImagesId=[],this._logger=(s=s||{}).logger||GltfConverter._defaultLogger,null!=(e=this._gltf.extensionsRequired)&&e.forEach(e=>this._warnIfExtensionNotSupported(e,!0)),null!=(t=this._gltf.extensionsUsed)&&t.forEach(e=>{var t;null!=(t=this._gltf.extensionsRequired)&&t.includes(e)||this._warnIfExtensionNotSupported(e,!1)}),s.promoteSingleRootNode&&this._promoteSingleRootNodes(),void 0!==this._gltf.nodes&&(this._parents=new Array(this._gltf.nodes.length).fill(-1),this._gltf.nodes.forEach((e,t)=>{if(void 0!==e.children)for(const r of e.children)this._parents[r]=t})),this._gltf.skins&&(this._skinRoots=new Array(this._gltf.skins.length).fill(skinRootNotCalculated)),this._nodePathTable=this._createNodePathTable();var n=s.userData||{};if(this._gltf.meshes){const f=null!=(r=n.normals)?r:glTF_meta_1.NormalImportSetting.require,m=null!=(e=n.tangents)?e:glTF_meta_1.TangentImportSetting.require,p=null!=(t=n.morphNormals)?t:glTF_meta_1.NormalImportSetting.exclude;for(let s=0;s<this._gltf.meshes.length;s++){var a=this._gltf.meshes[s];const g=new cc_1.Vec3(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),h=new cc_1.Vec3(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);var{geometries:a,materialIndices:i,jointMaps:o}=pp_geometry_1.PPGeometry.skinningProcess(a.primitives.map((e,t)=>{var r=this._readPrimitive(e,s,t);return r.reduceJointInfluences(),this._applySettings(r,f,m,p,t,s),this._readBounds(e,v3Min,v3Max),cc_1.Vec3.min(g,g,v3Min),cc_1.Vec3.max(h,h,v3Max),r.sanityCheck(),r}),!1!==n.disableMeshSplit);this._processedMeshes.push({geometries:a,materialIndices:i,jointMaps:o,minPosition:g,maxPosition:h})}}if(this._gltf.nodes&&this._gltf.skins){var l=this._gltf.nodes,c=[];for(let e=0;e<l.length;e++){var u=l[e];void 0!==u.mesh&&void 0===u.skin&&c.push(e)}for(let e=0;e<c.length;e++){const x=c[e];c.some(e=>this._isAncestorOf(e,x))&&(c[e]=c[c.length-1],c.length--,e--)}for(let e=0;e<c.length;e++){var _=c[e],d=l[this._getParent(_)];d&&this._socketMappings.set(this._getNodePath(_),d.name+" Socket/"+l[_].name)}}}get gltf(){return this._gltf}get path(){return this._gltfFilePath}get processedMeshes(){return this._processedMeshes}get fbxMissingImagesId(){return this._fbxMissingImagesId}createMesh(e,i=!1,o=!1){var t=this._processedMeshes[e],r=this._gltf.meshes[e];const l=new BufferBlob,c=new Array;var s={primitives:t.geometries.map((e,t)=>{var{vertexCount:r,vertexStride:s,formats:n,vertexBuffer:a}=interleaveVertices(e,i,o),r=(l.setNextAlignment(0),c.push({view:{offset:l.getLength(),length:a.byteLength,count:r,stride:s},attributes:n}),l.addBuffer(a),{primitiveMode:e.primitiveMode,jointMapIndex:e.jointMapIndex,vertexBundelIndices:[t]});return void 0!==e.indices&&(s=e.indices,l.setNextAlignment(s.BYTES_PER_ELEMENT),r.indexView={offset:l.getLength(),length:s.byteLength,count:s.length,stride:s.BYTES_PER_ELEMENT},l.addBuffer(s.buffer)),r}),vertexBundles:c,minPosition:t.minPosition,maxPosition:t.maxPosition,jointMaps:t.jointMaps};{var t=t.geometries.map(e=>{let t=0;const s=[];if(e.forEachAttribute(e=>{if(e.morphs){if(0===t)t=e.morphs.length;else if(t!==e.morphs.length)throw new Error("Bad morph...");s.push(e)}}),0===t)return null;var n=new Array(t);for(let r=0;r<t;++r)n[r]={displacements:s.map(e=>{var e=e.morphs[r],t=(l.setNextAlignment(e.BYTES_PER_ELEMENT),l.getLength());return l.addBuffer(e.buffer),{offset:t,length:e.byteLength,stride:e.BYTES_PER_ELEMENT,count:e.length}})};return{attributes:s.map(e=>pp_geometry_1.getGfxAttributeName(e)),targets:n}});const n=t.find(e=>null!==e);n&&(assertGlTFConformance(t.every(e=>!e||e.targets.length===n.targets.length),"glTF expects that every primitive has same number of targets"),0!==t.length&&assertGlTFConformance(void 0===r.weights||r.weights.length===n.targets.length,'Number of "weights" mismatch number of morph targets'),s.morph={subMeshMorphs:t,weights:r.weights},"object"==typeof r.extras)&&Array.isArray(r.extras.targetNames)&&(t=r.extras.targetNames).length===n.targets.length&&t.every(e=>"string"==typeof e)&&(s.morph.targetNames=t.slice())}r=new cc.Mesh;return r.name=this._getGltfXXName(GltfAssetKind.Mesh,e),r.assign(s,l.getCombined()),r.hash,r}createSkeleton(e,t){var r=this._gltf.skins[e],s=new cc.Skeleton;if(s.name=this._getGltfXXName(GltfAssetKind.Skin,e),s._joints=r.joints.map(e=>this._mapToSocketPath(this._getNodePath(e))),void 0!==r.inverseBindMatrices){e=this._gltf.accessors[r.inverseBindMatrices];if(e.componentType!==WebGLRenderingContext.FLOAT||"MAT4"!==e.type)throw new Error("The inverse bind matrix should be floating-point 4x4 matrix.");var n=new Array(r.joints.length),a=new Float32Array(16*n.length);this._readAccessor(e,createDataViewFromTypedArray(a)),assertGlTFConformance(a.length===16*n.length,"Wrong data in bind-poses accessor.");for(let e=0;e<n.length;++e)n[e]=new cc_1.Mat4(a[16*e+0],a[16*e+1],a[16*e+2],a[16*e+3],a[16*e+4],a[16*e+5],a[16*e+6],a[16*e+7],a[16*e+8],a[16*e+9],a[16*e+10],a[16*e+11],a[16*e+12],a[16*e+13],a[16*e+14],a[16*e+15]);s._bindposes=n}return s.hash,s}getAnimationDuration(e){const t=this._gltf.animations[e];let r=0;return t.channels.forEach(e=>{void 0!==e.target.node&&(e=t.samplers[e.sampler],e=void 0!==(e=this._gltf.accessors[e.input]).max&&1===e.max.length?Math.fround(e.max[0]):0,r=Math.max(e,r))}),r}createAnimation(e){const n=this._gltf.animations[e],t=new glTF_animation_utils_1.GlTFTrsAnimationData,a=e=>{e=this._mapToSocketPath(this._getNodePath(e));return t.addNodeAnimation(e)};let i=0;const o=new Array,s=new Map,l=e=>{let t=s.get(e);var r;return void 0===t&&(r=this._gltf.accessors[e],r=this._readAccessorIntoArray(r),t=o.length,o.push(r),s.set(e,t)),t},c=[];if(n.channels.forEach(e=>{var t,r,s=e.target.node;void 0!==s&&(s=a(s),t=n.samplers[e.sampler],r=l(t.input),"weights"===e.target.path?c.push(...this._glTFWeightChannelToTracks(n,e,o[r])):this._gltfChannelToCurveData(n,e,s,o[r]),s=void 0!==(e=this._gltf.accessors[t.input]).max&&1===e.max.length?Math.fround(e.max[0]):0,i=Math.max(s,i))}),this._gltf.nodes){new Float32Array([0]);const _=new cc_1.Quat,d=new cc_1.Vec3,f=new cc_1.Vec3;this._gltf.nodes.forEach((t,r)=>{if(!this._promotedRootNodes.includes(r)){var s,r=a(r);let e;t.matrix&&(e=this._readNodeMatrix(t.matrix),cc_1.Mat4.toRTS(e,_,d,f)),r.position||(s=new cc_1.Vec3,t.translation?cc_1.Vec3.set(s,t.translation[0],t.translation[1],t.translation[2]):e&&cc_1.Vec3.copy(s,d),r.setConstantPosition(s)),r.scale||(s=new cc_1.Vec3(1,1,1),t.scale?cc_1.Vec3.set(s,t.scale[0],t.scale[1],t.scale[2]):e&&cc_1.Vec3.copy(s,f),r.setConstantScale(s)),r.rotation||(s=new cc_1.Quat,t.rotation?this._getNodeRotation(t.rotation,s):e&&cc_1.Quat.copy(s,_),r.setConstantRotation(s))}})}var r=t.createExotic();const u=new cc.AnimationClip;return u.name=this._getGltfXXName(GltfAssetKind.Animation,e),u.wrapMode=cc.AnimationClip.WrapMode.Loop,u.duration=i,u.sample=30,u.hash,u.enableTrsBlending=!0,c.forEach(e=>u.addTrack(e)),u[exotic_animation_1.exoticAnimationTag]=r,u}createMaterial(t,r,s,n){var a=null==(o=n.useVertexColors)||o,e=null!=(o=n.depthWriteInAlphaModeBlend)&&o,n=null!=(o=n.smartMaterialEnabled)&&o;const i=this._gltf.materials[t];var o=void 0!==(i.extensions&&i.extensions.KHR_materials_unlit),l=this._gltf.extras;if(n){let e="";if("object"==typeof l&&l&&"FBX-glTF-conv"in l){n=l["FBX-glTF-conv"];if(void 0!==n.fbxFileHeaderInfo){void 0!==n.fbxFileHeaderInfo.sceneInfo&&(e=n.fbxFileHeaderInfo.sceneInfo.original.applicationName);var l=/Blender/g,n=/Maya/g,c=/Max/g,u=/Cinema/g,_=/mixamo/g,d=i.extras["FBX-glTF-conv"].raw;if(l.test(e)||_.test(e)){if("phong"===d.type)return this._convertBlenderPBRMaterial(i,t,r,s)}else if(n.test(e)){if("phong"===d.type||"lambert"===d.type)return this._convertPhongMaterial(t,r,s,5,d.properties);if(d.properties.Maya&&1398031443===d.properties.Maya.value.TypeId.value)return this._convertMayaStandardSurface(t,r,s,d.properties.Maya.value)}else if(c.test(e)){if("phong"===d.type||"lambert"===d.type)return this._convertPhongMaterial(t,r,s,1,d.properties);if(d.properties["3dsMax"].value.ORIGINAL_MTL&&"PHYSICAL_MTL"===d.properties["3dsMax"].value.ORIGINAL_MTL.value)return this._convertMaxPhysicalMaterial(t,r,s,d.properties["3dsMax"].value.Parameters.value)}else if(u.test(e)){if("phong"===d.type||"lambert"===d.type)return this._convertPhongMaterial(t,r,s,3,d.properties)}else if("phong"===d.type||"lambert"===d.type)return this._convertPhongMaterial(t,r,s,0,d.properties)}else console.debug("Failed to read fbx header info, default material was used")}else console.debug("Failed to read fbx info.")}else{_=extras_1.hasOriginalMaterialExtras(i.extras)&&(l=i.extras["FBX-glTF-conv"].originalMaterial,extras_1.isAdsk3dsMaxPhysicalMaterial(l))?this._convertAdskPhysicalMaterial(i,t,r,s,l):null;if(_)return _}var n=new cc.Material,f=(n.name=this._getGltfXXName(GltfAssetKind.Material,t),n._effectAsset=s(`db://internal/effects/${o?"builtin-unlit":"builtin-standard"}.effect`),{}),m={},p={rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}};if(this._gltf.meshes)for(let e=0;e<this._gltf.meshes.length;e++){var g=this._gltf.meshes[e];for(let e=0;e<g.primitives.length;e++){var h=g.primitives[e];h.material===t&&(h.attributes.COLOR_0&&a&&(f.USE_VERTEX_COLOR=!0),h.attributes.TEXCOORD_1)&&(f.HAS_SECOND_UV=!0)}}let x=!1;if(i.pbrMetallicRoughness&&(void 0!==(c=i.pbrMetallicRoughness).baseColorTexture&&(x=!0,u=r.find("textures",c.baseColorTexture.index,cc.Texture2D),f[o?"USE_TEXTURE":"USE_ALBEDO_MAP"]=!!u,m.mainTexture=u,c.baseColorTexture.texCoord&&(f.ALBEDO_UV="v_uv1"),void 0!==c.baseColorTexture.extensions)&&c.baseColorTexture.extensions.KHR_texture_transform&&(m.tilingOffset=this._khrTextureTransformToTiling(c.baseColorTexture.extensions.KHR_texture_transform)),c.baseColorFactor&&(x=!0,d=c.baseColorFactor,o?m.mainColor=new cc_1.Vec4(d[0],d[1],d[2],1):m.albedoScale=new cc_1.Vec3(d[0],d[1],d[2])),void 0!==c.metallicRoughnessTexture&&(x=!0,f.USE_PBR_MAP=!0,m.pbrMap=r.find("textures",c.metallicRoughnessTexture.index,cc.Texture2D),m.metallic=1,m.roughness=1),void 0!==c.metallicFactor&&(x=!0,m.metallic=c.metallicFactor),void 0!==c.roughnessFactor)&&(x=!0,m.roughness=c.roughnessFactor),!x&&null!=(l=i.extensions)&&l.KHR_materials_pbrSpecularGlossiness)return this._convertGltfPbrSpecularGlossiness(i,t,r,s,e);switch(void 0!==i.normalTexture&&void 0!==(_=i.normalTexture).index&&(f.USE_NORMAL_MAP=!0,m.normalMap=r.find("textures",_.index,cc.Texture2D),void 0!==_.scale)&&(m.normalStrenth=_.scale),m.occlusion=0,i.occlusionTexture&&void 0!==(u=i.occlusionTexture).index&&(f.USE_OCCLUSION_MAP=!0,m.occlusionMap=r.find("textures",u.index,cc.Texture2D),void 0!==u.strength)&&(m.occlusion=u.strength),void 0!==i.emissiveTexture&&(f.USE_EMISSIVE_MAP=!0,i.emissiveTexture.texCoord&&(f.EMISSIVE_UV="v_uv1"),m.emissiveMap=r.find("textures",i.emissiveTexture.index,cc.Texture2D)),void 0!==i.emissiveFactor&&(o=i.emissiveFactor,m.emissive=this._normalizeArrayToCocosColor(o)[1]),i.doubleSided&&(p.rasterizerState.cullMode=cc_1.gfx.CullMode.NONE),i.alphaMode){case"BLEND":var v=p.blendState.targets[0];v.blend=!0,v.blendSrc=cc_1.gfx.BlendFactor.SRC_ALPHA,v.blendDst=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,v.blendDstAlpha=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,p.depthStencilState.depthWrite=e;break;case"MASK":v=void 0===i.alphaCutoff?.5:i.alphaCutoff;f.USE_ALPHA_TEST=!0,m.alphaThreshold=v;break;case"OPAQUE":case void 0:break;default:this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedAlphaMode,{mode:i.alphaMode,material:t})}return n._defines=[f],n._props=[m],n._states=[p],n}getTextureParameters(t,e){var r,s=e=>{switch(e=void 0===e?glTF_constants_1.GltfWrapMode.__DEFAULT:e){case glTF_constants_1.GltfWrapMode.CLAMP_TO_EDGE:return"clamp-to-edge";case glTF_constants_1.GltfWrapMode.MIRRORED_REPEAT:return"mirrored-repeat";case glTF_constants_1.GltfWrapMode.REPEAT:return"repeat";default:return this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedTextureParameter,{type:"wrapMode",value:e,fallback:glTF_constants_1.GltfWrapMode.REPEAT,sampler:t.sampler,texture:this._gltf.textures.indexOf(t)}),"repeat"}},n=e=>{switch(e){case glTF_constants_1.GltfTextureMagFilter.NEAREST:return"nearest";case glTF_constants_1.GltfTextureMagFilter.LINEAR:return"linear";default:return this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedTextureParameter,{type:"magFilter",value:e,fallback:glTF_constants_1.GltfTextureMagFilter.LINEAR,sampler:t.sampler,texture:this._gltf.textures.indexOf(t)}),"linear"}},a=e=>{switch(e){case glTF_constants_1.GltfTextureMinFilter.NEAREST:return["nearest","none"];case glTF_constants_1.GltfTextureMinFilter.LINEAR:return["linear","none"];case glTF_constants_1.GltfTextureMinFilter.NEAREST_MIPMAP_NEAREST:return["nearest","nearest"];case glTF_constants_1.GltfTextureMinFilter.LINEAR_MIPMAP_NEAREST:return["linear","nearest"];case glTF_constants_1.GltfTextureMinFilter.NEAREST_MIPMAP_LINEAR:return["nearest","linear"];case glTF_constants_1.GltfTextureMinFilter.LINEAR_MIPMAP_LINEAR:return["linear","linear"];default:return this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedTextureParameter,{type:"minFilter",value:e,fallback:glTF_constants_1.GltfTextureMinFilter.LINEAR,sampler:t.sampler,texture:this._gltf.textures.indexOf(t)}),["linear","none"]}};void 0===t.sampler?(e.wrapModeS="repeat",e.wrapModeT="repeat"):(r=this._gltf.samplers[t.sampler],e.wrapModeS=s(r.wrapS),e.wrapModeT=s(r.wrapT),e.magfilter=void 0===r.magFilter?texture_base_1.defaultMagFilter:n(r.magFilter),e.minfilter=texture_base_1.defaultMinFilter,void 0!==r.minFilter&&([s,n]=a(r.minFilter),e.minfilter=s,e.mipfilter=n))}createScene(e,t,r=!0){const s=this._getSceneNode(e,t,r);return s.getComponentsInChildren(cc.SkinnedMeshRenderer).forEach(e=>e.skinningRoot=s),s}createSockets(e){var t=[];for(const s of this._socketMappings){var r=e.getChildByPath(s[0]);doCreateSocket(e,t,r)}return t}readImageInBufferView(e){return this._readBufferView(e)}_warnIfExtensionNotSupported(e,t){supportedExtensions.has(e)||this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedExtension,{name:e,required:t})}_promoteSingleRootNodes(){if(void 0!==this._gltf.nodes&&void 0!==this._gltf.scenes)for(const e of this._gltf.scenes)if(void 0!==e.nodes&&1===e.nodes.length){const t=e.nodes[0];this._gltf.skins&&this._gltf.skins.some(e=>e.joints.includes(t))||this._gltf.animations&&this._gltf.animations.some(e=>e.channels.some(e=>e.target.node===t))||this._promotedRootNodes.push(t)}}_getNodeRotation(e,t){return cc_1.Quat.set(t,e[0],e[1],e[2],e[3]),cc_1.Quat.normalize(t,t),t}_gltfChannelToCurveData(e,t,r,s){let n;if(t.target.path===glTF_constants_1.GltfAnimationChannelTargetPath.translation)n="position";else if(t.target.path===glTF_constants_1.GltfAnimationChannelTargetPath.rotation)n="rotation";else{if(t.target.path!==glTF_constants_1.GltfAnimationChannelTargetPath.scale)return void this._logger(GltfConverter.LogLevel.Error,GltfConverter.ConverterError.UnsupportedChannelPath,{channel:e.channels.indexOf(t),animation:this._gltf.animations.indexOf(e),path:t.target.path});n="scale"}e=e.samplers[t.sampler],t=null!=(t=e.interpolation)?t:glTF_constants_1.GlTfAnimationInterpolation.LINEAR;switch(t){case glTF_constants_1.GlTfAnimationInterpolation.STEP:case glTF_constants_1.GlTfAnimationInterpolation.LINEAR:case glTF_constants_1.GlTfAnimationInterpolation.CUBIC_SPLINE:break;default:return}e=this._readAccessorIntoArrayAndNormalizeAsFloat(this._gltf.accessors[e.output]);r[n]=new glTF_animation_utils_1.GlTFTrsTrackData(t,s,e)}_glTFWeightChannelToTracks(e,t,s){var r=e.samplers[t.sampler];const n=this._readAccessorIntoArrayAndNormalizeAsFloat(this._gltf.accessors[r.output]);var r=this._gltf.nodes[t.target.node],a=this._processedMeshes[r.mesh],r=new Array,i=a.geometries.length;let o=0;for(let e=0;e<i;++e){var l=a.geometries[e];if(l.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.position)){l=l.getAttribute(pp_geometry_1.PPGeometry.StdSemantics.position)["morphs"];if(l){o=l.length;break}}}if(0===o)return console.debug(`Morph animation in ${e.name} on node `+this._gltf.nodes[t.target.node]+"is going to be ignored due to lack of morph information in mesh."),[];var c=new exotic_animation_1.RealArrayTrack;r.push(c),c.path=(new cc.animation.TrackPath).toHierarchy(this._mapToSocketPath(this._getNodePath(t.target.node))).toComponent(cc.js.getClassName(cc.MeshRenderer)),c.proxy=new cc.animation.MorphWeightsAllValueProxy,c.elementCount=o;for(let r=0;r<o;++r){var u=c.channels()[r]["curve"],_=Array.from({length:s.length},(e,t)=>{return{value:n[o*t+r],interpolationMode:cc.RealInterpolationMode.LINEAR}});u.assignSorted(Array.from(s),_)}return r}_getParent(e){return this._parents[e]}_getRootParent(t){for(let e=t;0<=e;e=this._getParent(t))t=e;return t}_commonRoot(e){let s=1/0;var r=e.map(e=>{var t=[];let r=e;for(;0<=r;)t.unshift(r),r=this._getParent(r);return s=Math.min(s,t.length),t});if(0===r.length)return-1;var n=[];for(let t=0;t<s;++t){const a=r[0][t];if(!r.every(e=>e[t]===a))break;n.push(a)}return 0===n.length?-1:n[n.length-1]}_getSkinRoot(e){let t=this._skinRoots[e];return t===skinRootNotCalculated&&(t=this._commonRoot(this._gltf.skins[e].joints),this._skinRoots[e]=t),t}_readPrimitive(r,e,s){let t=null;if(r.extensions)for(const m of Object.keys(r.extensions)){var n=r.extensions[m];"KHR_draco_mesh_compression"===m&&(t=this._decodeDracoGeometry(r,n))}var a=this._getPrimitiveMode(void 0===r.mode?glTF_constants_1.GltfPrimitiveMode.__DEFAULT:r.mode);let i;if(void 0!==r.indices){let e;e=t&&t.indices?t.indices:(o=this._gltf.accessors[r.indices],this._readAccessorIntoArray(o)),i=e}if(!("POSITION"in r.attributes))throw new Error("The primitive doesn't contains positions.");var o=t?t.vertices.POSITION.length/3:this._gltf.accessors[r.attributes.POSITION].count,l=new pp_geometry_1.PPGeometry(o,a,i);for(const p of Object.getOwnPropertyNames(r.attributes)){var c=this._gltf.accessors[r.attributes[p]];let e;e=t&&p in t.vertices?t.vertices[p]:this._readAccessorIntoArray(c);var u=glTFAttributeNameToPP(p),c=this._getComponentsPerAttribute(c.type);l.setAttribute(u,e,c)}if(r.targets){for(const g of Object.getOwnPropertyNames(r.targets[0])){var _=glTFAttributeNameToPP(g);if(!pp_geometry_1.PPGeometry.isStdSemantic(_)||![pp_geometry_1.PPGeometry.StdSemantics.position,pp_geometry_1.PPGeometry.StdSemantics.normal,pp_geometry_1.PPGeometry.StdSemantics.tangent].includes(_))throw new Error("Only position, normal, tangent attribute are morph-able, but provide "+g);assertGlTFConformance(l.hasAttribute(_),`Primitive do not have attribute ${g} for morph.`);var d=l.getAttribute(_);d.morphs=new Array(r.targets.length);for(let e=0;e<r.targets.length;++e){var f=r.targets[e],f=(assertGlTFConformance(g in f,"Morph attributes in all target must be same."),this._gltf.accessors[f[g]]),f=this._readAccessorIntoArray(f);d.morphs[e]=f}}let t=!1;l.forEachAttribute(e=>{!t&&e.morphs&&e.morphs.some(e=>e.some(e=>0!==e))&&(t=!0)}),t||this._logger(GltfConverter.LogLevel.Debug,GltfConverter.ConverterError.EmptyMorph,{mesh:e,primitive:s})}return l}_decodeDracoGeometry(e,t){var r,s=this._gltf.bufferViews[t.bufferView],n=this._buffers[s.buffer],a=void 0===s.byteOffset?0:s.byteOffset,n=n.slice(a,a+s.byteLength),i={buffer:new Int8Array(n),attributes:{}};void 0!==e.indices&&(i.indices=this._getAttributeBaseTypeStorage(this._gltf.accessors[e.indices].componentType));for(const o of Object.keys(t.attributes))o in e.attributes&&(r=this._gltf.accessors[e.attributes[o]],i.attributes[o]={uniqueId:t.attributes[o],storageConstructor:this._getAttributeBaseTypeStorage(r.componentType),components:this._getComponentsPerAttribute(r.type)});return khr_draco_mesh_compression_1.decodeDracoGeometry(i)}_readBounds(e,t,r){var e=e.attributes.POSITION;void 0!==e&&((e=this._gltf.accessors[e]).min&&(e.componentType===glTF_constants_1.GltfAccessorComponentType.FLOAT?(t.x=Math.fround(e.min[0]),t.y=Math.fround(e.min[1]),t.z=Math.fround(e.min[2])):(t.x=e.min[0],t.y=e.min[1],t.z=e.min[2])),e.max)&&(e.componentType===glTF_constants_1.GltfAccessorComponentType.FLOAT?(r.x=Math.fround(e.max[0]),r.y=Math.fround(e.max[1]),r.z=Math.fround(e.max[2])):(r.x=e.max[0],r.y=e.max[1],r.z=e.max[2]))}_applySettings(e,t,r,s,n,a){var i;t===glTF_meta_1.NormalImportSetting.recalculate||t===glTF_meta_1.NormalImportSetting.require&&!e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal)?(i=e.calculateNormals(),e.setAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal,i,3)):t===glTF_meta_1.NormalImportSetting.exclude&&e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal)&&e.deleteAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal),r===glTF_meta_1.TangentImportSetting.recalculate||r===glTF_meta_1.TangentImportSetting.require&&!e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent)?e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal)?e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.texcoord)?(i=e.calculateTangents(),e.setAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent,i,4)):this._logger(GltfConverter.LogLevel.Debug,GltfConverter.ConverterError.FailedToCalculateTangents,{reason:"uv",primitive:n,mesh:a}):this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.FailedToCalculateTangents,{reason:"normal",primitive:n,mesh:a}):r===glTF_meta_1.TangentImportSetting.exclude&&e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent)&&e.deleteAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent),s===glTF_meta_1.NormalImportSetting.exclude&&e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal)&&(e.getAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal).morphs=null)}_readBufferView(e){var t=this._buffers[e.buffer];return Buffer.from(t.buffer,t.byteOffset+(e.byteOffset||0),e.byteLength)}_readAccessorIntoArray(e){var t=new(this._getAttributeBaseTypeStorage(e.componentType))(e.count*this._getComponentsPerAttribute(e.type));return this._readAccessor(e,createDataViewFromTypedArray(t)),void 0!==e.sparse&&this._applyDeviation(e,t),t}_readAccessorIntoArrayAndNormalizeAsFloat(e){let t=this._readAccessorIntoArray(e);if(!(t instanceof Float32Array)){var r=new Float32Array(t.length),s=t instanceof Int8Array?e=>Math.max(e/127,-1):t instanceof Uint8Array?e=>e/255:t instanceof Int16Array?e=>Math.max(e/32767,-1):t instanceof Uint16Array?e=>e/65535:e=>e;for(let e=0;e<t.length;++e)r[e]=s(t[e]);t=r}return t}_getSceneNode(e,r,t=!0){var s=this._getGltfXXName(GltfAssetKind.Scene,e),e=this._gltf.scenes[e];let n;if(e.nodes&&0!==e.nodes.length){const i=e.nodes,o=new Array(this._gltf.nodes.length).fill(null);if(1===e.nodes.length&&this._promotedRootNodes.includes(e.nodes[0])){var a=e.nodes[0];n=this._createEmptyNodeRecursive(a,o,t)}else{n=new cc.Node(s);for(const l of e.nodes)this._createEmptyNodeRecursive(l,o,t).parent=n}o.forEach((e,t)=>{this._setupNode(t,o,r,n,i)})}else n=new cc.Node(s);return n}_createEmptyNodeRecursive(e,t,r=!0){var s=this._gltf.nodes[e],n=this._createEmptyNode(e,r);if(void 0!==s.children)for(const a of s.children)this._createEmptyNodeRecursive(a,t,r).parent=n;return t[e]=n}_setupNode(t,r,s,n,a){var i=r[t];if(null!==i){var o=this._gltf.nodes[t];if(void 0!==o.mesh){let e=null;e=void 0===o.skin?i.addComponent(cc.MeshRenderer):(i=i.addComponent(cc.SkinnedMeshRenderer),(l=s.find("skeletons",o.skin,cc.Skeleton))&&(i.skeleton=l),null===(l=r[this._getSkinRoot(o.skin)])?this.gltf.skins[o.skin].joints.every(e=>a.includes(this._getRootParent(e)))?i.skinningRoot=n:this._logger(GltfConverter.LogLevel.Error,GltfConverter.ConverterError.ReferenceSkinInDifferentScene,{node:t,skin:o.skin}):i.skinningRoot=l,i);var l,r=s.find("meshes",o.mesh,cc.Mesh);r&&(e._mesh=r);const c=this.gltf.meshes[o.mesh];n=this._processedMeshes[o.mesh].materialIndices.map(e=>{e=c.primitives[e];return void 0!==e.material&&s.find("materials",e.material,cc.Material)||null});e._materials=n}}}_createEmptyNode(e,t=!0){var r,s,n=this._gltf.nodes[e],e=this._getGltfXXName(GltfAssetKind.Node,e),e=new cc.Node(e);return t&&(n.translation&&e.setPosition(n.translation[0],n.translation[1],n.translation[2]),n.rotation&&e.setRotation(this._getNodeRotation(n.rotation,new cc_1.Quat)),n.scale&&e.setScale(n.scale[0],n.scale[1],n.scale[2]),n.matrix)&&(t=n.matrix,n=this._readNodeMatrix(t),t=new cc_1.Vec3,r=new cc_1.Quat,s=new cc_1.Vec3,cc_1.Mat4.toRTS(n,r,t,s),e.setPosition(t),e.setRotation(r),e.setScale(s)),e}_readNodeMatrix(e){return new cc_1.Mat4(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}_getNodePath(e){return this._nodePathTable[e]}_isAncestorOf(e,t){if(e!==t)for(;0<=t;){if(t===e)return!0;t=this._getParent(t)}return!1}_mapToSocketPath(e){for(const t of this._socketMappings)if(e===t[0]||e.startsWith(t[0]+"/"))return t[1]+e.slice(t[0].length);return e}_createNodePathTable(){if(void 0===this._gltf.nodes)return[];const s=new Array(this._gltf.nodes.length).fill(-1),n=(this._gltf.nodes.forEach((r,t)=>{r.children&&(r.children.forEach(e=>{s[e]=t}),makeUniqueNames(r.children.map(e=>{let t=this._gltf.nodes[e].name;return t="string"==typeof t&&0!==t.length?t:null}),uniqueChildNodeNameGenerator).forEach((e,t)=>{this._gltf.nodes[r.children[t]].name=e}))}),new Array(this._gltf.nodes.length).fill(""));for(let e=0;e<n.length;++e)n[e]=this._getGltfXXName(GltfAssetKind.Node,e);const a=new Array(this._gltf.nodes.length).fill("");return this._gltf.nodes.forEach((e,t)=>{var r=[];for(let e=t;0<=e;e=s[e])this._promotedRootNodes.includes(e)||r.unshift(n[e]);a[t]=r.join("/")}),a}_readAccessor(t,r,s=0){if(void 0!==t.bufferView){var e=this._gltf.bufferViews[t.bufferView],n=this._getComponentsPerAttribute(t.type),a=this._getBytesPerComponent(t.componentType),i=(0===s&&(s=n*a),(void 0!==t.byteOffset?t.byteOffset:0)+(void 0!==e.byteOffset?e.byteOffset:0)),o=createDataViewFromBuffer(this._buffers[e.buffer],i),l=void 0!==e.byteStride?e.byteStride:n*a,c=this._getComponentReader(t.componentType),u=this._getComponentWriter(t.componentType);for(let e=0;e<t.count;++e){var _=createDataViewFromTypedArray(o,l*e),d=createDataViewFromTypedArray(r,s*e);for(let e=0;e<n;++e){var f=a*e;u(d,f,c(_,f))}}}}_applyDeviation(e,r){var t=e["sparse"],s=this._gltf.bufferViews[t.indices.bufferView],n=this._buffers[s.buffer],a=new(this._getAttributeBaseTypeStorage(t.indices.componentType))(n.buffer,n.byteOffset+(s.byteOffset||0)+(t.indices.byteOffset||0),t.count),n=this._gltf.bufferViews[t.values.bufferView],s=this._buffers[n.buffer],i=new(this._getAttributeBaseTypeStorage(e.componentType))(s.buffer,s.byteOffset+(n.byteOffset||0)+(t.values.byteOffset||0)),o=this._getComponentsPerAttribute(e.type);for(let t=0;t<o;++t)for(let e=0;e<a.length;++e)r[o*a[e]+t]=i[o*e+t]}_getPrimitiveMode(e){switch(e=void 0===e?glTF_constants_1.GltfPrimitiveMode.__DEFAULT:e){case glTF_constants_1.GltfPrimitiveMode.POINTS:return cc_1.gfx.PrimitiveMode.POINT_LIST;case glTF_constants_1.GltfPrimitiveMode.LINES:return cc_1.gfx.PrimitiveMode.LINE_LIST;case glTF_constants_1.GltfPrimitiveMode.LINE_LOOP:return cc_1.gfx.PrimitiveMode.LINE_LOOP;case glTF_constants_1.GltfPrimitiveMode.LINE_STRIP:return cc_1.gfx.PrimitiveMode.LINE_STRIP;case glTF_constants_1.GltfPrimitiveMode.TRIANGLES:return cc_1.gfx.PrimitiveMode.TRIANGLE_LIST;case glTF_constants_1.GltfPrimitiveMode.TRIANGLE_STRIP:return cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP;case glTF_constants_1.GltfPrimitiveMode.TRIANGLE_FAN:return cc_1.gfx.PrimitiveMode.TRIANGLE_FAN;default:throw new Error(`Unrecognized primitive mode: ${e}.`)}}_getAttributeBaseTypeStorage(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:return Int8Array;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return Uint8Array;case glTF_constants_1.GltfAccessorComponentType.SHORT:return Int16Array;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return Uint16Array;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:return Uint32Array;case glTF_constants_1.GltfAccessorComponentType.FLOAT:return Float32Array;default:throw new Error("Unrecognized component type: "+e)}}_getComponentsPerAttribute(e){return glTF_constants_1.getGltfAccessorTypeComponents(e)}_getBytesPerComponent(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return 1;case glTF_constants_1.GltfAccessorComponentType.SHORT:case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return 2;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:case glTF_constants_1.GltfAccessorComponentType.FLOAT:return 4;default:throw new Error("Unrecognized component type: "+e)}}_getComponentReader(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:return(e,t)=>e.getInt8(t);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return(e,t)=>e.getUint8(t);case glTF_constants_1.GltfAccessorComponentType.SHORT:return(e,t)=>e.getInt16(t,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return(e,t)=>e.getUint16(t,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:return(e,t)=>e.getUint32(t,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.FLOAT:return(e,t)=>e.getFloat32(t,DataViewUseLittleEndian);default:throw new Error("Unrecognized component type: "+e)}}_getComponentWriter(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:return(e,t,r)=>e.setInt8(t,r);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return(e,t,r)=>e.setUint8(t,r);case glTF_constants_1.GltfAccessorComponentType.SHORT:return(e,t,r)=>e.setInt16(t,r,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return(e,t,r)=>e.setUint16(t,r,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:return(e,t,r)=>e.setUint32(t,r,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.FLOAT:return(e,t,r)=>e.setFloat32(t,r,DataViewUseLittleEndian);default:throw new Error("Unrecognized component type: "+e)}}_getGltfXXName(e,t){var r={[GltfAssetKind.Animation]:"animations",[GltfAssetKind.Image]:"images",[GltfAssetKind.Material]:"materials",[GltfAssetKind.Node]:"nodes",[GltfAssetKind.Skin]:"skins",[GltfAssetKind.Texture]:"textures",[GltfAssetKind.Scene]:"scenes"},r=this._gltf[r[e]];return r?"string"==typeof(r=r[t]).name?r.name:GltfAssetKind[e]+"-"+t:""}_normalizeArrayToCocosColor(e){let t=1;1<Math.max(...e)&&(t=Math.max(...e));e=e.map(e=>color_utils_1.linearToSrgb8Bit(e/t)),3===e.length&&e.push(255),e=new cc.Color(e[0],e[1],e[2],e[3]);return[t,e]}_convertAdskPhysicalMaterial(e,t,r,s,n){var a={},i={},n=n.properties["3dsMax"]["Parameters"],o=null!=(o=n.base_color)?o:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.base_color,o=(i.mainColor=cc.Vec4.set(new cc.Color,o[0],o[1],o[2],o[3]),null!=(o=n.basic_weight)?o:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.basic_weight),o=(i.albedoScale=new cc.Vec3(o,o,o),null!=(o=n.base_color_map_on)?o:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.base_color_map_on),l=n.base_color_map,l=(o&&l&&(a.USE_ALBEDO_MAP=!0,i.mainTexture=null!=(o=r.find("textures",l.index,cc.Texture2D))?o:void 0,1===l.texCoord&&(a.ALBEDO_UV="v_uv1"),hasKHRTextureTransformExtension(l))&&(i.tilingOffset=this._khrTextureTransformToTiling(l.extensions.KHR_texture_transform)),null!=(o=n.metalness)?o:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.metalness),l=(i.metallic=l,null!=(o=n.roughness)?o:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.roughness),o=null!=(o=n.roughness_inv)?o:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.roughness_inv,l=(i.roughness=o?1-l:l,null!=n.metalness_map_on||extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.metalness_map_on,n.metalness_map,null!=n.roughness_map_on||extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.roughness_map_on,n.roughness_map,null!=(o=n.emission)?o:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.emission),o=null!=(o=n.emit_color)?o:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.emit_color,l=(i.emissive=new cc_1.Vec4(o[0]*l,o[1]*l,o[2]*l,o[3]*l),null!=(o=n.emit_color_map_on)?o:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.emit_color_map_on),o=n.emit_color_map,l=(l&&o&&(a.USE_EMISSIVE_MAP=!0,i.emissiveMap=null!=(n=r.find("textures",o.index,cc.Texture2D))?n:void 0,1===o.texCoord)&&(a.EMISSIVE_UV="v_uv1"),new cc.Material);return l.name=this._getGltfXXName(GltfAssetKind.Material,t),l._effectAsset=s("db://internal/effects/builtin-standard.effect"),l._defines=[a],l._props=[i],l._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],l}_convertMaxPhysicalMaterial(e,t,r,s){var n,a={},i={};s.base_color_map&&!this.fbxMissingImagesId.includes(s.base_color_map.value.index)&&(a.USE_ALBEDO_MAP=!0,i.mainTexture=null!=(n=t.find("textures",s.base_color_map.value.index,cc.Texture2D))?n:void 0),i.mainColor=this._normalizeArrayToCocosColor(s.base_color.value)[1],s.base_weight_map&&!this.fbxMissingImagesId.includes(s.base_weight_map.value.index)&&(a.USE_WEIGHT_MAP=!0,i.baseWeightMap=null!=(n=t.find("textures",s.base_weight_map.value.index,cc.Texture2D))?n:void 0),i.albedoScale=s.base_weight.value,s.metalness_map&&!this.fbxMissingImagesId.includes(s.metalness_map.value.index)&&(a.USE_METALLIC_MAP=!0,i.metallicMap=null!=(n=t.find("textures",s.metalness_map.value.index,cc.Texture2D))?n:void 0),i.metallic=s.metalness.value,s.roughness_map&&!this.fbxMissingImagesId.includes(s.roughness_map.value.index)&&(a.USE_ROUGHNESS_MAP=!0,i.roughnessMap=null!=(n=t.find("textures",s.roughness_map.value.index,cc.Texture2D))?n:void 0),i.roughness=s.roughness.value,s.bump_map&&!this.fbxMissingImagesId.includes(s.bump_map.value.index)&&(a.USE_NORMAL_MAP=!0,i.normalMap=null!=(n=t.find("textures",s.bump_map.value.index,cc.Texture2D))?n:void 0),s.emission_map&&!this.fbxMissingImagesId.includes(s.emission_map.value.index)&&(a.USE_EMISSIVESCALE_MAP=!0,i.emissiveScaleMap=null!=(n=t.find("textures",s.emission_map.value.index,cc.Texture2D))?n:void 0),i.emissiveScale=s.emission.value,s.emit_color_map&&!this.fbxMissingImagesId.includes(s.emit_color_map.value.index)&&(a.USE_EMISSIVE_MAP=!0,i.emissiveMap=null!=(n=t.find("textures",s.emit_color_map.value.index,cc.Texture2D))?n:void 0),i.emissive=this._normalizeArrayToCocosColor(s.emit_color.value)[1],i.alphaSource=1;let o=0;s.cutout_map&&(o=1,a.USE_ALPHA_TEST=!1,a.USE_OPACITY_MAP=!0,i.alphaSourceMap=null!=(n=t.find("textures",s.cutout_map.value.index,cc.Texture2D))?n:void 0);t=new cc.Material;return t.name=this._getGltfXXName(GltfAssetKind.Material,e),t._effectAsset=r("db://internal/effects/util/dcc/imported-metallic-roughness.effect"),t._defines=[a],t._props=[i],t._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],setTechniqueIndex(t,o),t}_convertMayaStandardSurface(e,t,r,s){var n,a={},i={},t=(s.base.texture&&!this.fbxMissingImagesId.includes(s.base.texture.index)&&(a.USE_WEIGHT_MAP=!0,i.baseWeightMap=null!=(n=t.find("textures",s.base.texture.index,cc.Texture2D))?n:void 0),i.albedoScale=s.base.value,s.baseColor.texture&&!this.fbxMissingImagesId.includes(s.baseColor.texture.index)&&(a.USE_ALBEDO_MAP=!0,i.mainTexture=null!=(n=t.find("textures",s.baseColor.texture.index,cc.Texture2D))?n:void 0),i.mainColor=this._normalizeArrayToCocosColor(s.baseColor.value)[1],s.metalness.texture&&!this.fbxMissingImagesId.includes(s.metalness.texture.index)&&(a.USE_METALLIC_MAP=!0,i.metallicMap=null!=(n=t.find("textures",s.metalness.texture.index,cc.Texture2D))?n:void 0),i.metallic=s.metalness.value,s.specularRoughness.texture&&!this.fbxMissingImagesId.includes(s.specularRoughness.texture.index)&&(a.USE_ROUGHNESS_MAP=!0,i.roughnessMap=null!=(n=t.find("textures",s.specularRoughness.texture.index,cc.Texture2D))?n:void 0),i.roughness=s.specularRoughness.value,i.specularIntensity=.5*Math.max(...s.specularColor.value),void 0===s.normalCamera.texture||this.fbxMissingImagesId.includes(s.normalCamera.texture.index)||(a.USE_NORMAL_MAP=!0,i.normalMap=null!=(n=t.find("textures",s.normalCamera.texture.index,cc.Texture2D))?n:void 0),void 0===s.emission.texture||this.fbxMissingImagesId.includes(s.emission.texture.index)||(a.USE_EMISSIVESCALE_MAP=!0,i.emissiveScaleMap=null!=(n=t.find("textures",s.emission.texture.index,cc.Texture2D))?n:void 0),i.emissiveScale=s.emission.value,void 0===s.emissionColor.texture||this.fbxMissingImagesId.includes(s.emissionColor.texture.index)||(a.USE_EMISSIVE_MAP=!0,i.emissiveMap=null!=(n=t.find("textures",s.emissionColor.texture.index,cc.Texture2D))?n:void 0),i.emissive=this._normalizeArrayToCocosColor(s.emissionColor.value)[1],s.opacity.texture&&!this.fbxMissingImagesId.includes(s.opacity.texture.index)?(a.USE_ALPHA_TEST=!1,a.USE_OPACITY_MAP=!0,i.alphaSourceMap=null!=(n=t.find("textures",s.opacity.texture.index,cc.Texture2D))?n:void 0):Math.max(...s.opacity.value)<.99&&(i.alphaSource=Math.max(...s.opacity.value)),new cc.Material);return t.name=this._getGltfXXName(GltfAssetKind.Material,e),t._effectAsset=r("db://internal/effects/util/dcc/imported-metallic-roughness.effect"),t._defines=[a],t._props=[i],t._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],t}_convertPhongMaterial(e,t,r,s,n){var a,i={},o={};let l=0,c=255;void 0===n.transparentColor.texture||this.fbxMissingImagesId.includes(n.transparentColor.texture.index)?n.transparencyFactor&&(a=(n.transparentColor.value[0]+n.transparentColor.value[1]+n.transparentColor.value[2])/3,n.transparentColor.value[0]===n.transparentColor.value[1]&&n.transparentColor.value[0]===n.transparentColor.value[2]||console.warn(`Material ${this._getGltfXXName(GltfAssetKind.Material,e)} : Transparent color property is not supported, average value would be used.`),0!=n.transparencyFactor.value*a)&&(l=1,c=color_utils_1.linearToSrgb8Bit(1-n.transparencyFactor.value*a)):(i.USE_ALPHA_TEST=!1,i.USE_TRANSPARENCY_MAP=!0,o.transparencyMap=null!=(a=t.find("textures",n.transparentColor.texture.index,cc.Texture2D))?a:void 0,l=1),n.diffuse&&(a=this._normalizeArrayToCocosColor(n.diffuse.value),o.albedoScale=n.diffuseFactor.value*a[0],a[1].a=c,o.mainColor=a[1],void 0===n.diffuse.texture||this.fbxMissingImagesId.includes(n.diffuse.texture.index)||(i.USE_ALBEDO_MAP=!0,o.mainTexture=null!=(a=t.find("textures",n.diffuse.texture.index,cc.Texture2D))?a:void 0)),n.specular&&(a=this._normalizeArrayToCocosColor(n.specular.value),o.specularFactor=n.specularFactor.value*a[0],o.specularColor=a[1],void 0===n.specular.texture||this.fbxMissingImagesId.includes(n.specular.texture.index)||(i.USE_SPECULAR_MAP=!0,o.specularMap=null!=(a=t.find("textures",n.specular.texture.index,cc.Texture2D))?a:void 0)),void 0===(null==(a=n.normalMap)?void 0:a.texture)||this.fbxMissingImagesId.includes(n.normalMap.texture.index)?void 0!==(null==(a=n.bump)?void 0:a.texture)&&(i.USE_NORMAL_MAP=!0,o.normalMap=null!=(a=t.find("textures",n.bump.texture.index,cc.Texture2D))?a:void 0):(i.USE_NORMAL_MAP=!0,o.normalMap=null!=(a=t.find("textures",n.normalMap.texture.index,cc.Texture2D))?a:void 0),n.shininess&&(o.shininessExponent=n.shininess.value,void 0===n.shininess.texture||this.fbxMissingImagesId.includes(n.shininess.texture.index)||(i.USE_SHININESS_MAP=!0,o.shininessExponentMap=null!=(a=t.find("textures",n.shininess.texture.index,cc.Texture2D))?a:void 0)),n.emissive&&(a=this._normalizeArrayToCocosColor(n.emissive.value),o.emissiveScale=n.emissiveFactor.value*a[0],o.emissive=a[1],void 0===n.emissive.texture||this.fbxMissingImagesId.includes(n.emissive.texture.index)||(i.USE_EMISSIVE_MAP=!0,o.emissiveMap=null!=(a=t.find("textures",n.emissive.texture.index,cc.Texture2D))?a:void 0),void 0===n.emissiveFactor.texture||this.fbxMissingImagesId.includes(n.emissiveFactor.texture.index)||(i.USE_EMISSIVESCALE_MAP=!0,o.emissiveScaleMap=null!=(a=t.find("textures",n.emissiveFactor.texture.index,cc.Texture2D))?a:void 0)),i.DCC_APP_NAME=s;t=new cc.Material;return t.name=this._getGltfXXName(GltfAssetKind.Material,e),setTechniqueIndex(t,l),t._effectAsset=r("db://internal/effects/util/dcc/imported-specular-glossiness.effect"),t._defines=[i],t._props=[o],t._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],t}_convertBlenderPBRMaterial(e,t,r,s){var n,a={},i={},e=e.extras["FBX-glTF-conv"].raw.properties,r=(a.DCC_APP_NAME=2,a.HAS_EXPORTED_METALLIC=!0,e.diffuse&&(n=this._normalizeArrayToCocosColor(e.diffuse.value),i.mainColor=n[1],void 0===e.diffuse.texture||this.fbxMissingImagesId.includes(e.diffuse.texture.index)||(a.USE_ALBEDO_MAP=!0,i.mainTexture=null!=(n=r.find("textures",e.diffuse.texture.index,cc.Texture2D))?n:void 0)),void 0===(null==(n=e.bump)?void 0:n.texture)||this.fbxMissingImagesId.includes(e.bump.texture.index)||(a.USE_NORMAL_MAP=!0,i.normalMap=null!=(n=r.find("textures",e.bump.texture.index,cc.Texture2D))?n:void 0),e.shininess&&(i.shininessExponent=e.shininess.value,void 0===e.shininess.texture||this.fbxMissingImagesId.includes(e.shininess.texture.index)||(a.USE_SHININESS_MAP=!0,i.shininessExponentMap=null!=(n=r.find("textures",e.shininess.texture.index,cc.Texture2D))?n:void 0)),e.emissive&&(n=this._normalizeArrayToCocosColor(e.emissive.value),i.emissiveScale=e.emissiveFactor.value*n[0],i.emissive=n[1],void 0===e.emissive.texture||this.fbxMissingImagesId.includes(e.emissive.texture.index)||(a.USE_EMISSIVE_MAP=!0,i.emissiveMap=null!=(n=r.find("textures",e.emissive.texture.index,cc.Texture2D))?n:void 0),void 0===e.emissiveFactor.texture||this.fbxMissingImagesId.includes(e.emissiveFactor.texture.index)||(a.USE_EMISSIVESCALE_MAP=!0,i.emissiveScaleMap=null!=(n=r.find("textures",e.emissiveFactor.texture.index,cc.Texture2D))?n:void 0)),e.reflectionFactor&&(i.metallic=e.reflectionFactor.value,void 0===e.reflectionFactor.texture||this.fbxMissingImagesId.includes(e.reflectionFactor.texture.index)||(a.USE_METALLIC_MAP=!0,i.metallicMap=null!=(n=r.find("textures",e.reflectionFactor.texture.index,cc.Texture2D))?n:void 0)),e.specularFactor&&(void 0===e.specularFactor.texture||this.fbxMissingImagesId.includes(e.specularFactor.texture.index)?i.specularFactor=e.specularFactor.value:(a.USE_SPECULAR_MAP=!0,i.specularMap=null!=(n=r.find("textures",e.specularFactor.texture.index,cc.Texture2D))?n:void 0)),e.transparencyFactor&&(void 0===e.transparencyFactor.texture||this.fbxMissingImagesId.includes(e.transparencyFactor.texture.index)?i.transparencyFactor=e.transparencyFactor.value:(a.USE_ALPHA_TEST=!1,a.USE_TRANSPARENCY_MAP=!0,i.transparencyMap=null!=(n=r.find("textures",e.transparencyFactor.texture.index,cc.Texture2D))?n:void 0)),new cc.Material);return r.name=this._getGltfXXName(GltfAssetKind.Material,t),r._effectAsset=s("db://internal/effects/util/dcc/imported-specular-glossiness.effect"),r._defines=[a],r._props=[i],r._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],r}_convertGltfPbrSpecularGlossiness(e,t,r,s,n){var a,i={},o={},l={rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}},c=e.extensions.KHR_materials_pbrSpecularGlossiness;switch(i.DCC_APP_NAME=4,c.diffuseFactor&&(a=this._normalizeArrayToCocosColor(c.diffuseFactor),o.mainColor=a[1]),void 0!==c.diffuseTexture&&(i.USE_ALBEDO_MAP=!0,o.mainTexture=null!=(a=r.find("textures",c.diffuseTexture.index,cc.Texture2D))?a:void 0),c.specularFactor&&(a=this._normalizeArrayToCocosColor(c.specularFactor),o.specularColor=a[1]),c.glossinessFactor&&(i.HAS_EXPORTED_GLOSSINESS=!0,o.glossiness=c.glossinessFactor),void 0!==c.specularGlossinessTexture&&(i.HAS_EXPORTED_GLOSSINESS=!0,i.USE_SPECULAR_GLOSSINESS_MAP=!0,o.specularGlossinessMap=null!=(a=r.find("textures",c.specularGlossinessTexture.index,cc.Texture2D))?a:void 0),void 0!==e.normalTexture&&void 0!==(c=e.normalTexture).index&&(i.USE_NORMAL_MAP=!0,o.normalMap=r.find("textures",c.index,cc.Texture2D)),void 0!==e.emissiveTexture&&(i.USE_EMISSIVE_MAP=!0,e.emissiveTexture.texCoord&&(i.EMISSIVE_UV="v_uv1"),o.emissiveMap=r.find("textures",e.emissiveTexture.index,cc.Texture2D)),void 0!==e.emissiveFactor&&(a=e.emissiveFactor,o.emissive=this._normalizeArrayToCocosColor(a)[1]),e.doubleSided&&(l.rasterizerState.cullMode=cc_1.gfx.CullMode.NONE),e.alphaMode){case"BLEND":var u=l.blendState.targets[0];u.blend=!0,u.blendSrc=cc_1.gfx.BlendFactor.SRC_ALPHA,u.blendDst=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,u.blendDstAlpha=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,l.depthStencilState.depthWrite=n;break;case"MASK":u=void 0===e.alphaCutoff?.5:e.alphaCutoff;i.USE_ALPHA_TEST=!0,o.alphaThreshold=u;break;case"OPAQUE":case void 0:break;default:this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedAlphaMode,{mode:e.alphaMode,material:t})}c=new cc.Material;return c.name=this._getGltfXXName(GltfAssetKind.Material,t),c._effectAsset=s("db://internal/effects/util/dcc/imported-specular-glossiness.effect"),c._defines=[i],c._props=[o],c._states=[l],c}_khrTextureTransformToTiling(e){var t=new cc_1.Vec4(1,1,0,0);return e.scale&&(t.x=e.scale[0],t.y=e.scale[1]),e.offset&&(t.z=e.offset[0],t.w=e.offset[1]),t}}function hasKHRTextureTransformExtension(e){e=e.extensions;return"object"==typeof e&&null!==e&&"object"==typeof e.KHR_texture_transform}function setTechniqueIndex(e,t){e._techIdx=t}async function readGltf(e){return".glb"===path.extname(e)?await readGlb(e):await readGltfJson(e)}async function readGltfJson(t){var e=await fs.readJSON(t),r=e.buffers?e.buffers.map(e=>e.uri?resolveBufferUri(t,e.uri):Buffer.alloc(0)):[];return{glTF:e,buffers:r}}async function readGlb(r){var s=()=>{throw new Error("Bad glb format.")},n=await fs.readFile(r);if(n.length<12)return s();if(1179937895!==n.readUInt32LE(0))return s();var e;n.readUInt32LE(4),n.readUInt32LE(8);let a,i;for(let e=0,t=12;t+8<=n.length;++e){var o=n.readUInt32LE(t),l=(t+=4,n.readUInt32LE(t));if((t+=4)+o>n.length)return s();var c=Buffer.from(n.buffer,t,o);if(t+=o,0===e){if(1313821514!==l)return s();o=new TextDecoder("utf-8").decode(c);a=JSON.parse(o)}else 5130562===l&&(i=c)}return a?(e=a.buffers?a.buffers.map((e,t)=>e.uri?resolveBufferUri(r,e.uri):0===t&&i?i:Buffer.alloc(0)):[],{glTF:a,buffers:e}):s()}function resolveBufferUri(e,t){var r=DataURI.parse(t);return r?Buffer.from(resolveBufferDataURI(r)):path.resolve(path.dirname(e),t)}function isDataUri(e){return e.startsWith("data:")}(exports.GltfConverter=GltfConverter)._defaultLogger=(e,t,r)=>{var s=JSON.stringify({error:t,arguments:r},void 0,4);switch(e){case GltfConverter.LogLevel.Info:console.log(s);break;case GltfConverter.LogLevel.Warning:console.warn(s);break;case GltfConverter.LogLevel.Error:console.error(s);break;case GltfConverter.LogLevel.Debug:console.debug(s)}},function(e){var t;(t=e.LogLevel||(e.LogLevel={}))[t.Info=0]="Info",t[t.Warning=1]="Warning",t[t.Error=2]="Error",t[t.Debug=3]="Debug",(t=e.ConverterError||(e.ConverterError={}))[t.ReferenceSkinInDifferentScene=0]="ReferenceSkinInDifferentScene",t[t.UnsupportedAlphaMode=1]="UnsupportedAlphaMode",t[t.UnsupportedTextureParameter=2]="UnsupportedTextureParameter",t[t.UnsupportedChannelPath=3]="UnsupportedChannelPath",t[t.DisallowCubicSplineChannelSplit=4]="DisallowCubicSplineChannelSplit",t[t.FailedToCalculateTangents=5]="FailedToCalculateTangents",t[t.EmptyMorph=6]="EmptyMorph",t[t.UnsupportedExtension=7]="UnsupportedExtension"}(GltfConverter=exports.GltfConverter||(exports.GltfConverter={})),exports.readGltf=readGltf,exports.isDataUri=isDataUri;class BufferBlob{constructor(){this._arrayBufferOrPaddings=[],this._length=0}setNextAlignment(e){var t;0!==e&&0!=(t=this._length%e)&&(this._arrayBufferOrPaddings.push(e=e-t),this._length+=e)}addBuffer(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}getLength(){return this._length}getCombined(){const t=new Uint8Array(this._length);let r=0;return this._arrayBufferOrPaddings.forEach(e=>{"number"==typeof e?r+=e:(t.set(new Uint8Array(e),r),r+=e.byteLength)}),t}}function createDataViewFromBuffer(e,t=0){return new DataView(e.buffer,e.byteOffset+t)}function createDataViewFromTypedArray(e,t=0){return new DataView(e.buffer,e.byteOffset+t)}const DataViewUseLittleEndian=!0;function uniqueChildNodeNameGenerator(e,t,r,s){return`${e||""}(__autogen ${r}${0===s?"":"-"+s})`}function makeUniqueNames(t,n){const a=new Array(t.length).fill("");for(let s=0;s<t.length;++s){let r=t[s],e=0;for(;;){if(null!==r&&a.every((e,t)=>t===s||r!==e)){a[s]=r;break}r=n(t[s],r,s,e++)}}return a}function resolveBufferDataURI(e){if(!e.base64||!e.mediaType||"application/octet-stream"!==e.mediaType.value&&"application/gltf-buffer"!==e.mediaType.value)throw new Error(`Cannot understand data uri(base64: ${e.base64}, mediaType: ${e.mediaType}) for buffer.`);return base64_1.decodeBase64ToArrayBuffer(e.data)}class DynamicArrayBuffer{constructor(e){this._size=0,this._arrayBuffer=new ArrayBuffer(Math.max(e||0,4))}get arrayBuffer(){return this._arrayBuffer}grow(e){var t,r,s=this._size;return e&&((r=(t=this._arrayBuffer.byteLength)-s-e)<0&&(r=new ArrayBuffer(1.5*(t+-r)),new Uint8Array(r,0,t).set(new Uint8Array(this._arrayBuffer)),this._arrayBuffer=r),this._size+=e),s}shrink(){return this._arrayBuffer.slice(0,this._size)}}function getDataviewWritterOfTypedArray(e,s){switch(e.constructor){case Int8Array:return(e,t,r)=>e.setInt8(t,r);case Uint8Array:return(e,t,r)=>e.setUint8(t,r);case Int16Array:return(e,t,r)=>e.setInt16(t,r,s);case Uint16Array:return(e,t,r)=>e.setUint16(t,r,s);case Int32Array:return(e,t,r)=>e.setInt32(t,r,s);case Uint32Array:return(e,t,r)=>e.setUint32(t,r,s);case Float32Array:return(e,t,r)=>e.setFloat32(t,r,s);default:throw new Error("Bad storage constructor.")}}function interleaveVertices(e,t=!1,r=!1){var s=e.vertexCount;let n=!1,a=!1;var i,o,l=[];for(const A of e.attributes()){let e;try{(e=pp_geometry_1.getGfxAttributeName(A))===cc_1.gfx.AttributeName.ATTR_TEX_COORD1&&(n=!0),e===cc_1.gfx.AttributeName.ATTR_COLOR&&(a=!0)}catch(e){console.error(e);continue}l.push([e,A])}if(r&&!a){var c=new cc_1.Vec4(1,1,1,1),u=new Float32Array(4*s);for(let e=0;e<s;++e)u[4*e+0]=c.x,u[4*e+1]=c.y,u[4*e+2]=c.z,u[4*e+3]=c.w;l.push(["a_color",new pp_geometry_1.PPGeometry.Attribute(pp_geometry_1.PPGeometry.StdSemantics.color,u,4)])}t&&!n&&l.push(["a_texCoord1",new pp_geometry_1.PPGeometry.Attribute(pp_geometry_1.PPGeometry.StdSemantics.texcoord,new Float32Array(2*s),2)]);let _=0;for([i,o]of l)_+=o.data.BYTES_PER_ELEMENT*o.components;var e=new ArrayBuffer(s*_),d=new DataView(e);let f=0;var m,p,g=[];for([m,p]of l){var h=p.data,x=getDataviewWritterOfTypedArray(h,DataViewUseLittleEndian);for(let t=0;t<s;++t){var v=f+_*t;for(let e=0;e<p.components;++e){var T=h[p.components*t+e];x(d,v+h.BYTES_PER_ELEMENT*e,T)}}f+=p.data.BYTES_PER_ELEMENT*p.components,g.push({name:m,format:p.getGFXFormat(),isNormalized:p.isNormalized})}return{vertexCount:s,vertexStride:_,formats:g,vertexBuffer:e}}const glTFAttributeNameToPP=e=>{if(e.startsWith("_"))return e;var t=/([a-zA-Z]+)(?:_(\d+))?/g.exec(e);if(!t)return e;var r=t[1];let s;t=parseInt(t[2]||"0");switch(r){case"POSITION":s=pp_geometry_1.PPGeometry.StdSemantics.position;break;case"NORMAL":s=pp_geometry_1.PPGeometry.StdSemantics.normal;break;case"TANGENT":s=pp_geometry_1.PPGeometry.StdSemantics.tangent;break;case"COLOR":s=pp_geometry_1.PPGeometry.StdSemantics.color;break;case"TEXCOORD":s=pp_geometry_1.PPGeometry.StdSemantics.texcoord;break;case"JOINTS":s=pp_geometry_1.PPGeometry.StdSemantics.joints;break;case"WEIGHTS":s=pp_geometry_1.PPGeometry.StdSemantics.weights}return void 0===s?e:pp_geometry_1.PPGeometry.StdSemantics.set(s,t)};class GlTfConformanceError extends Error{}function assertGlTFConformance(e,t){if(!e)throw new GlTfConformanceError("glTF non-conformance error: "+t)}exports.GlTfConformanceError=GlTfConformanceError;