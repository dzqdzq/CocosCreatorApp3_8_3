"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.resolveGlTfImagePath=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra"));async function resolveGlTfImagePath(e,t,a,r,s){if(t&&await fs_extra_1.default.pathExists(t))return t;let i="",o="";if("object"==typeof r&&keyFbxGlTfConvImageExtras in r&&(console.debug("Found FBX-glTF-conv specified extras: "+JSON.stringify(r[keyFbxGlTfConvImageExtras],void 0,2)),{fileName:r,relativeFileName:n}=r[keyFbxGlTfConvImageExtras],n&&(o=normalizePathInFbx(n)),r)&&(i=normalizePathInFbx(r)),o){var n=path_1.default.join(a,o);if(await fs_extra_1.default.pathExists(n))return n}if(i&&await fs_extra_1.default.pathExists(i))return i;console.debug("Image"+`(Name: ${e}, Expected path: ${t})`+" is not found, fuzzy search starts.");var r=t?path_1.default.extname(t):"",n=r.toLowerCase(),t=t?path_1.default.basename(t,r):"",f=new Set;if(0!==t.length&&f.add(t),e&&f.add(e),i&&f.add(path_1.default.basename(i,path_1.default.extname(i))),o&&f.add(path_1.default.basename(o,path_1.default.extname(o))),0!==f.size){var l=[".jpg",".jpeg",".png",".tga",".webp"],u=(0===r.length||l.includes(n)||l.unshift(n),["textures","materials"]);const x=toNormalizedAbsolute(s);var d=Array.from(f);let t=toNormalizedAbsolute(a);for(let e=0;e<2&&t.startsWith(x);++e){var _=await fuzzySearchTexture(t,d,l);if(_)return console.debug(`Found ${_}, use it.`),_;for(const m of await fs_extra_1.default.readdir(t))if(u.some(e=>caseInsensitiveStringEqual(m,e))){var c=path_1.default.join(t,m);try{if(!(await fs_extra_1.default.stat(c)).isDirectory())continue}catch(e){}c=await fuzzySearchTexture(c,d,l);if(c)return console.debug(`Found ${c}, use it.`),c}t=path_1.default.dirname(t)}var h=[];for(const g of l)for(const v of d)h.push((""+v+g).toLowerCase());for(const b of listFile(a)){var p=path_1.default.basename(b).toLowerCase();if(h.includes(p))return b}console.debug("Fuzzy search failed.")}return null}function*listFile(e){for(const r of fs_extra_1.default.readdirSync(e)){var t=path_1.default.join(e,r),a=fs_extra_1.default.statSync(t);a.isFile()?yield t:a.isDirectory()&&(yield*listFile(t))}}function toNormalizedAbsolute(e){e=path_1.default.isAbsolute(e)?e:path_1.default.join(process.cwd(),e);return path_1.default.normalize(e)}async function fuzzySearchTexture(e,t,a){if(await fs_extra_1.default.pathExists(e))for(const o of await fs_extra_1.default.readdir(e)){var r=path_1.default.extname(o);const n=path_1.default.basename(o,r);if(t.some(e=>caseInsensitiveStringEqual(n,e))){var s=path_1.default.join(e,o),i=await fs_extra_1.default.stat(s);if(i.isFile()&&0<=a.indexOf(r.toLowerCase()))return s}}return null}function caseInsensitiveStringEqual(e,t){return e.length===t.length&&e.toLowerCase()===t.toLowerCase()}exports.resolveGlTfImagePath=resolveGlTfImagePath;const keyFbxGlTfConvImageExtras="FBX-glTF-conv";function normalizePathInFbx(e){return e.split(/[\\/]/g).join(path_1.default.sep)}