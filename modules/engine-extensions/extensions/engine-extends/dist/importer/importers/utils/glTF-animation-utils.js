"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,a,e,n){void 0===n&&(n=e),Object.defineProperty(t,n,{enumerable:!0,get:function(){return a[e]}})}:function(t,a,e,n){t[n=void 0===n?e:n]=a[e]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,a){Object.defineProperty(t,"default",{enumerable:!0,value:a})}:function(t,a){t.default=a}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var a={};if(null!=t)for(var e in t)"default"!==e&&Object.prototype.hasOwnProperty.call(t,e)&&__createBinding(a,t,e);return __setModuleDefault(a,t),a};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GlTFTrsTrackData=exports.GlTFTrsAnimationData=void 0;const glTF_constants_1=require("./glTF.constants"),cc=__importStar(require("cc")),exotic_animation_1=require("cc/editor/exotic-animation");class GlTFTrsAnimationData{constructor(){this.nodes={},this.inputs=[]}addNodeAnimation(t){var a,e;return null!=(a=(e=this.nodes)[t])?a:e[t]=new GlTFNodeTrsAnimationData}createExotic(){var t,a,e=new exotic_animation_1.ExoticAnimation;for([t,a]of Object.entries(this.nodes))a.emitExotic(e,t);return e}}exports.GlTFTrsAnimationData=GlTFTrsAnimationData;const INPUT_0=new Float32Array([0]);class GlTFNodeTrsAnimationData{constructor(){this.position=null,this.rotation=null,this.scale=null}setConstantPosition(t){this.position=new GlTFTrsTrackData(glTF_constants_1.GlTfAnimationInterpolation.STEP,INPUT_0,cc.Vec3.toArray(new Float32Array(3),t))}setConstantRotation(t){this.rotation=new GlTFTrsTrackData(glTF_constants_1.GlTfAnimationInterpolation.STEP,INPUT_0,cc.Quat.toArray(new Float32Array(4),t))}setConstantScale(t){this.scale=new GlTFTrsTrackData(glTF_constants_1.GlTfAnimationInterpolation.STEP,INPUT_0,cc.Vec3.toArray(new Float32Array(3),t))}emitExotic(t,a){var{position:e,rotation:n,scale:r}=this;(e||n||r)&&(t=t.addNodeAnimation(a),e&&({input:a,output:e}=e.toLinearVec3Curve(30),t.createPosition(a,e)),n&&({input:a,output:e}=n.toLinearQuatCurveNormalized(30),t.createRotation(a,e)),r)&&({input:n,output:a}=r.toLinearVec3Curve(30),t.createScale(n,a))}}class GlTFTrsTrackData{constructor(t,a,e){this.interpolation=t,this.input=a,this.output=e}toLinearVec3Curve(t){switch(this.interpolation){case glTF_constants_1.GlTfAnimationInterpolation.CUBIC_SPLINE:return cubicSplineToLinearCurveData(this.input,this.output,3,t);case glTF_constants_1.GlTfAnimationInterpolation.STEP:return constantToLinearCurveData(this.input,this.output,3,t);default:return{input:this.input,output:this.output}}}toLinearQuatCurveNormalized(t){var t=this.toLinearQuatCurve(t),a=t["output"],e=new cc.Quat;for(let t=0;t<a.length/4;++t)cc.Quat.fromArray(e,a,4*t),cc.Quat.normalize(e,e),cc.Quat.toArray(a,e,4*t);return t}toLinearQuatCurve(t){switch(this.interpolation){case glTF_constants_1.GlTfAnimationInterpolation.CUBIC_SPLINE:return cubicSplineToLinearCurveData(this.input,this.output,4,t);case glTF_constants_1.GlTfAnimationInterpolation.STEP:return constantToLinearCurveData(this.input,this.output,4,t);default:return{input:this.input,output:this.output}}}}function calculateBakeParams(t,a){var e=t[0],t=t[t.length-1],a=1/a;return{startTime:e,endTime:t,interval:a,count:(t-e)/a}}function createTimesFromBakeParams(t,a){const{startTime:e,endTime:n,interval:r,count:o}=t;return a.from({length:o},(t,a)=>a===o-1?n:e+r*a)}function constantToLinearCurveData(t,n,r,a){if(t.length<2)return{input:t,output:n};var o=n.length/r,i=calculateBakeParams(t,a),u=new Float32Array(r*i.count);for(let e=0;e<r;++e){var s=new cc.RealCurve;s.assignSorted(Array.from(t),Array.from({length:o},(t,a)=>({value:n[r*a+e],interpolationMode:cc.RealInterpolationMode.CONSTANT}))),bake(s,i,u,r,e)}return{input:createTimesFromBakeParams(i,Float32Array),output:u}}function cubicSplineToLinearCurveData(t,r,o,a){if(t.length<2)return{input:t,output:r};var e=r.length/(3*o),i=calculateBakeParams(t,a),u=new Float32Array(o*i.count);for(let n=0;n<o;++n){var s=new cc.RealCurve;s.assignSorted(Array.from(t),Array.from({length:e},(t,a)=>{var a=3*o*a+n,e=r[a+0*o];return{value:r[a+ +o],leftTangent:e,rightTangent:r[a+2*o],interpolationMode:cc.RealInterpolationMode.CUBIC}})),bake(s,i,u,o,n)}return{input:createTimesFromBakeParams(i,Float32Array),output:u}}function bake(a,t,e,n,r){var{startTime:t,endTime:o,interval:i,count:u}=t;let s=t;for(let t=0;t<u;++t,s+=i){var c=a.evaluate(t===u-1?o:s);e[n*t+r]=c}}exports.GlTFTrsTrackData=GlTFTrsTrackData;