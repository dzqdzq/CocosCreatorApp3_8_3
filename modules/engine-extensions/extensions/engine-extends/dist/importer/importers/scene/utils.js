"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.walkPrefabInstances=exports.isNestedPrefab=exports.getPrefabOfNode=exports.walkNodeAsync=exports.walkNode=exports.getComponent=exports.walkAsync=exports.walk=void 0;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),fs_1=require("fs");function walk(e,n){if(Array.isArray(e))for(const _ of e)walk(_,n);else if(e&&"object"==typeof e)if("__uuid__"in e)n(e);else for(const t of Object.values(e))walk(t,n)}async function walkAsync(e,n){if(Array.isArray(e))for(const _ of e)await walk(_,n);else if(e&&"object"==typeof e)if("__uuid__"in e)await n(e);else for(const t of Object.values(e))await walk(t,n)}function getComponent(e,n,_){if(!("number"!=typeof n||n<0))for(const a of e[n]._components){var t=e[a.__id__];if(_.test(t.__type__))return t}return null}function walkNode(n,e,_){var t;!e||"number"!=typeof e.__id__||e.__id__<0||(t=n[e.__id__],_(t,e),t._children&&t._children.forEach(e=>{walkNode(n,e,_)}))}async function walkNodeAsync(n,e,_){if(e&&"number"==typeof e.__id__&&!(e.__id__<0)){var t=n[e.__id__];if(await _(t,e),t._children)for(let e=0;e<t._children.length;e++)await walkNodeAsync(n,t._children[e],_)}}function getPrefabOfNode(e,n){if(e&&n[e]){var e=n[e];if(e&&"cc.Node"===e.__type__){e=null==(e=e._prefab)?void 0:e.__id__;if(e&&n[e])return n[e]}}}function isNestedPrefab(e,n,_){var t;return!(null==(t=null==e?void 0:e._prefab)||!t.__id__||null==(t=null==(t=n[e._prefab.__id__])?void 0:t.asset)||!t.__uuid__)&&(null==(n=null==(t=n[e._prefab.__id__])?void 0:t.asset)?void 0:n.__uuid__)!==_}exports.walk=walk,exports.walkAsync=walkAsync,exports.getComponent=getComponent,exports.walkNode=walkNode,exports.walkNodeAsync=walkNodeAsync,exports.getPrefabOfNode=getPrefabOfNode,exports.isNestedPrefab=isNestedPrefab;const walkPrefabInstanceChildren=async function(n,_,t,a,o){for(let e=0;e<n.length;e++){var s=n[e];await walkNodeAsync(_,s,async(e,n)=>{isNestedPrefab(e,_,o)?await walkPrefabInstances(e,_,t,a):(a(e),e._components&&e._components.forEach(e=>{e=_[e.__id__];e&&a(e)}))})}};async function walkPrefabInstances(_,t,a,o){if(null!=(e=null==_?void 0:_._prefab)&&e.__id__){o(_,t);var e=t[_._prefab.__id__],_=null==(_=null==e?void 0:e.asset)?void 0:_.__uuid__;if(_){var s=asset_db_1.queryAsset(_);if(s&&s.source){let n=[],e;if(e=s.source.includes("@")?(s.init||(s._assetDB.taskManager.pause(a.task),await s.waitInit(),s._assetDB.taskManager.resume(a.task)),s.library+".json"):s.source,fs_1.existsSync(e))try{n=fs_extra_1.readJSONSync(e)}catch(e){console.warn(e)}if(!n[0]||null==(s=null==(s=n[0])?void 0:s.data)||!s.__id__)return;var s=n[n[0].data.__id__];null!=s&&s._children&&await walkPrefabInstanceChildren(s._children,n,a,o,_),null!=s&&s._components&&s._components.forEach(e=>{e=n[e.__id__];e&&o(e)})}e=null==(s=null==e?void 0:e.instance)?void 0:s.__id__;if(e&&t[e]){s=t[e];if(s.mountedChildren&&0<s.mountedChildren.length){const r=[];s.mountedChildren.forEach(e=>{e=t[e.__id__];if(e&&e.nodes)for(const n of e.nodes)r.push(n)}),await walkPrefabInstanceChildren(r,t,a,o,_)}s.mountedComponents&&0<s.mountedComponents.length&&s.mountedComponents.forEach(e=>{e=t[e.__id__];if(e&&e.components)for(const n of e.components)n.__id__&&t[n.__id__]&&o(t[n.__id__])})}}}}exports.walkPrefabInstances=walkPrefabInstances;