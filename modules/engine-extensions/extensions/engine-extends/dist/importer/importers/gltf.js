"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__rest=this&&this.__rest||function(e,t){var a={};for(s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(a[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,s=Object.getOwnPropertySymbols(e);r<s.length;r++)t.indexOf(s[r])<0&&Object.prototype.propertyIsEnumerable.call(e,s[r])&&(a[s[r]]=e[s[r]]);return a},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrateFbxMatchMeshNames=exports.migrateMeshOptimizerOption=exports.GltfImporter=void 0;const asset_db_1=require("@editor/asset-db"),ajv_1=__importDefault(require("ajv")),assert_1=require("assert"),fs=__importStar(require("fs-extra")),path=__importStar(require("path")),urijs_1=__importDefault(require("urijs")),url_1=__importDefault(require("url")),asset_finder_1=require("./gltf/asset-finder"),material_1=require("./gltf/material"),reader_manager_1=require("./gltf/reader-manager"),texture_1=require("./texture"),migratesNameToId=__importStar(require("./migrates/name2id")),uri_utils_1=require("./utils/uri-utils"),cc_1=require("cc"),child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),resolve_glTF_image_path_1=require("./utils/resolve-glTF-image-path"),serialize_library_1=require("./utils/serialize-library"),original_animation_1=require("./gltf/original-animation"),path_1=require("path"),utils_1=require("../utils"),meshSimplify_1=require("./gltf/meshSimplify"),lodash=require("lodash"),ajv=new ajv_1.default({errorDataPath:""});class GltfImporter extends asset_db_1.Importer{constructor(e){super(e);e=path.join(__dirname,"..","..","..","static","meta-schemas","glTF.meta.json"),e=fs.readJSONSync(e);this._metaValidator=ajv.compile(e)}get version(){return"2.3.8"}get name(){return"gltf"}get migrations(){return[{version:"1.1.21",migrate(e){delete e.meta.userData.assetFinder}},{version:"1.1.23",migrate:migratesNameToId.migrate},{version:"1.3.0",migrate:migrateImageLocations},{version:"1.3.21",migrate:migrateDumpMaterial},{version:"2.0.0",migrate:migrateFbxConverterSelector},{version:"2.0.8",migrate:migrateFbxConverterUnitConversion},{version:"2.1.9",migrate:migrateFbxConverterPreferLocalTimeSpan},{version:"2.2.0",migrate:migrateSmartMaterialEnabled},{version:"2.3.0",migrate:migrateFBXPromoteSingleRootNode},{version:"2.3.2",migrate:migrateMeshOptimizerOption},{version:"2.3.5",migrate:migrateImageRemap},{version:"2.3.7",migrate:migrateFbxMatchMeshNames}]}async import(e){return await this._validateMeta(e),this._importSubAssets(e)}async afterSubAssetsImport(e){await reader_manager_1.glTfReaderManager.delete(e)}async getGltfFilePath(e){var t=e.userData;return t.meshOptimizer&&t.meshOptimizer.enable?this.getOptimizerPath(e,e.source,t.meshOptimizer):e.source}async getOptimizerPath(e,t,a){return"gltfpack"===a.algorithm?this._getOptimizerPath(e,t,a.gltfpackOptions):t}async _getOptimizerPath(e,s,i={}){var t=e._assetDB.options.temp,t=path.join(t,"gltfpack-"+e.uuid);fs.ensureDirSync(t);const n=path.join(t,"out.gltf"),o=path.join(t,"status.json"),m={mtimeMs:(await fs_extra_1.stat(e.source)).mtimeMs,version:this.version,options:JSON.stringify(i)};if(fs_extra_1.existsSync(n)&&fs_extra_1.existsSync(o))try{var a=await fs_extra_1.readJSON(o);if(a.mtimeMs===m.mtimeMs&&a.version===m.version&&a.options===m.options)return n}catch(e){}return new Promise(t=>{try{var e=path.join(Editor.App.path,"./node_modules/gltfpack/bin/gltfpack.js"),a=["-i",s,"-o",n],r=i.c;"1"===r?a.push("-c"):"2"===r&&a.push("-cc"),i.te&&a.push("-te"),i.tb&&a.push("-tb"),i.tc&&a.push("-tc"),50!==i.tq&&void 0!==i.tq&&(a.push("-tq"),a.push(i.tq)),i.tu&&a.push("-tu"),1!==i.si&&void 0!==i.si&&(a.push("-si"),a.push(i.si)),i.sa&&a.push("-sa"),14!==i.vp&&void 0!==i.vp&&(a.push("-vp"),a.push(i.vp)),12!==i.vt&&void 0!==i.vt&&(a.push("-vt"),a.push(i.vt)),8!==i.vn&&void 0!==i.vn&&(a.push("-vn"),a.push(i.vn)),16!==i.at&&void 0!==i.at&&(a.push("-at"),a.push(i.at)),12!==i.ar&&void 0!==i.ar&&(a.push("-ar"),a.push(i.ar)),16!==i.as&&void 0!==i.as&&(a.push("-as"),a.push(i.as)),30!==i.af&&void 0!==i.af&&(a.push("-af"),a.push(i.af)),i.ac&&a.push("-ac"),i.kn&&a.push("-kn"),i.ke&&a.push("-ke"),i.cf&&a.push("-cf"),!i.noq&&void 0!==i.noq||a.push("-noq"),!i.v&&void 0!==i.v||a.push("-v"),child_process_1.fork(e,a).on("exit",async e=>{await fs.writeFile(o,JSON.stringify(m,void 0,2)),t(n)})}catch(e){console.error(e),t(s)}})}async _validateMeta(e){null==(t=e.meta.userData).imageMetas&&(t.imageMetas=[]);var t=await this._metaValidator(e.meta.userData);t||(0!==Object.keys(e.meta.userData).length&&console.debug("Meta file of asset "+e.source+" is damaged: \n"+(this._metaValidator.errors||[]).map(e=>e.message)+"\nA default meta file is patched."),t={imageMetas:[],legacyFbxImporter:!1,allowMeshDataAccess:!0,addVertexColor:!1,generateLightmapUVNode:!1,meshOptimizer:{enable:!1,algorithm:"simplify",simplifyOptions:meshSimplify_1.getDefautOptions()},lods:{enable:!1,hasBuiltinLOD:!1,options:[]}},e.meta.userData=lodash.defaultsDeep(e.meta.userData,t))}async _importSubAssets(e){reader_manager_1.glTfReaderManager.delete(e);var t=await reader_manager_1.glTfReaderManager.getOrCreate(e,!0),a=(await this._adjustMeta(e,t),e.userData),r=new asset_finder_1.DefaultGltfAssetFinder(a.assetFinder),s=await this._importMeshes(e,t),i=(r.set("meshes",s),await this._saveOriginalAnimations(e,t,!0),a)["animationImportSettings"];if(i)for(const c of i)for(const g of c.splits){var{previousId:n,name:o,from:m,to:l,fps:u}=g,p=__rest(g,["previousId","name","from","to","fps"]),o=await e.createSubAsset(o+".animation","gltf-animation",{id:n}),n=(g.previousId=o._id,o.userData);n.gltfIndex=i.indexOf(c),Object.assign(n,p),n.sample=null!=u?u:c.fps,n.span={from:m,to:l}}var s=await this._importSkins(e,t),s=(r.set("skeletons",s),await this._importImages(e,t),await this._importTextures(e,t)),s=(r.set("textures",s),await this._importMaterials(e,t,r)),f=(r.set("materials",s),await this._importScenes(e,t));return r.set("scenes",f),a.lods&&a.lods.options&&a.lods.options.length||(f=await Manager.Utils.queryAssetMeta(e.userData.redirect))&&(t=0<(f=await loadLODs(a,t.createScene(f.userData.gltfIndex||0,r),t)).length,a.lods={enable:t,hasBuiltinLOD:t,options:t?f:await generateDefaultLODsOption()}),a.dumpMaterials&&!s.every(e=>null!==e)?(console.debug("Waiting for dependency materials..."),!1):(a.assetFinder=r.serialize(),!0)}async _adjustMeta(l,u){var e=l.userData;const r=u.gltf.images;if(r){const s=e.imageMetas;var t=r.map((e,t)=>{const a={};return e.name?(a.name=e.name,s&&(e=s.find(e=>e.remap&&e.name&&e.name===a.name))&&(a.remap=e.remap)):s&&r.length===s.length&&!s[t].name&&s[t].remap&&(a.remap=s[t].remap),a});e.imageMetas=t}else e.imageMetas=[];const p=u.gltf.animations;if(p){const f=e.animationImportSettings||[],c=makeUniqueSubAssetNames(l.basename,p,"animations","");t=p.map((e,t)=>{const a=u.getAnimationDuration(t);var r,s=e.name||c[t];let i=s;1===p.length&&1<(r=path.basename(l.basename,path.extname(l.basename)).split("@")).length&&(i=r[r.length-1]);const n={name:s,duration:a,fps:30,splits:[{name:i,from:0,to:a,wrapMode:cc_1.AnimationClip.WrapMode.Loop}]};let o=f.find(e=>e.name===n.name);if(o=o||f.length!==e.length?o:f[t]){n.fps=o.fps;const m=e=>e===o.duration?a:Math.min(e,a);n.splits=o.splits.map(e=>{return Object.assign(Object.assign({},e),{from:m(e.from),to:m(e.to),wrapMode:null!=(e=e.wrapMode)?e:cc_1.AnimationClip.WrapMode.Loop})})}return n});e.animationImportSettings=t}else delete e.animationImportSettings}async _importMeshes(a,e){var t=e.gltf.meshes;if(void 0===t)return[];var r=makeUniqueSubAssetNames(a.basename,t,"meshes",".mesh"),s=[];for(let e=0;e<t.length;e++){t[e];var i=await a.createSubAsset(r[e],"gltf-mesh");i.userData.gltfIndex=e,s.push(i.uuid)}var n=a.userData;if(n.lods&&!n.lods.hasBuiltinLOD&&n.lods.enable)for(let t=0;t<r.length;t++){var o=n.lods.options;for(let e=1;e<o.length;e++){var m=r[t].split(".mesh")[0]+`_LOD${e}.mesh`,m=await a.createSubAsset(m,"gltf-mesh");m.userData.gltfIndex=t,m.userData.lodLevel=e,m.userData.lodOptions={faceCount:o[e].faceCount},s.push(m.uuid)}}return s}async _importSkins(t,e){var a=e.gltf.skins;if(void 0===a)return[];var r=makeUniqueSubAssetNames(t.basename,a,"skeletons",".skeleton"),s=new Array(a.length);for(let e=0;e<a.length;e++){a[e];var i=await t.createSubAsset(r[e],"gltf-skeleton");s[i.userData.gltfIndex=e]=i.uuid}return s}async _importImages(s,i){var n=i.gltf.images;if(void 0!==n){var o=s.userData;const d="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==";var m=e=>{return(null==(t=i.gltf.asset.generator)?void 0:t.includes("FBX2glTF"))&&e===d;var t};var l=e=>{return(null==(t=i.gltf.asset.generator)?void 0:t.includes("FBX-glTF-conv"))&&e===d;var t},u=makeUniqueSubAssetNames(s.basename,n,"images",".image");for(let r=0;r<n.length;++r){var p=n[r],f=o.imageMetas[r],c=p.uri;let t=!1,a;if(c&&(m(c)||l(c)))t=!0;else if(c&&!c.startsWith("data:")){var g=i.path,g=url_1.default.pathToFileURL(g).toString();try{let e=new urijs_1.default(c);e=e.absoluteTo(g),uri_utils_1.convertsEncodedSeparatorsInURI(e),"file"===e.scheme()&&(a=url_1.default.fileURLToPath(e.toString()),t=!0)}catch(e){}}let e="";t&&(c=s._assetDB.options.target,g=await resolve_glTF_image_path_1.resolveGlTfImagePath(p.name,a,path.dirname(s.source),p.extras,c))&&((c=asset_db_1.queryUrl(g))?f.uri=c:(c=path_1.relative(Editor.Project.tmpDir,g),path_1.isAbsolute(c)||c.startsWith(".."+path_1.sep)?console.warn(`In model file ${s.source},`+`the image ${p.name} is resolved to ${g},`+"which is a location out of asset directory.This can cause problem as your project migrated."):e=g)),f.uri||((c=await s.createSubAsset(u[r],"gltf-embeded-image")).userData.gltfIndex=r,f.uri=c.uuid,e?c.getSwapSpace().resolved=e:p.uri===d&&i.fbxMissingImagesId.push(r))}}}async _importTextures(t,a){var r=a.gltf.textures;if(void 0===r)return[];var s=makeUniqueSubAssetNames(t.basename,r,"textures",".texture"),i=new Array(r.length);for(let e=0;e<r.length;e++){var n=r[e],o=s[e],o=await t.createSubAsset(o,"texture"),m=texture_1.makeDefaultTexture2DAssetUserData(),l=(a.getTextureParameters(n,m),o.userData);if(o.assignUserData(m),void 0!==n.source){m=t.userData.imageMetas[n.source],n=m.remap||m.uri;if(n){m=!n.startsWith("db://");if(l.isUuid=m,l.imageUuidOrDatabaseUri=n,!m){n=asset_db_1.queryPath(l.imageUuidOrDatabaseUri);if(!n)throw new assert_1.AssertionError({message:l.imageUuidOrDatabaseUri+" is not found in asset-db."});o.depend(n)}}else delete l.imageUuidOrDatabaseUri,delete l.isUuid}i[e]=o.uuid}return i}async _importMaterials(t,a,r){var s=a.gltf.materials;if(void 0===s)return[];var i,n=t.userData["dumpMaterials"],o=makeUniqueSubAssetNames(t.basename,s,"materials",n?".mtl":".material"),m=new Array(s.length);for(let e=0;e<s.length;e++)n?m[e]=await material_1.dumpMaterial(t,r,a,e,o[e]):m[(i=await t.createSubAsset(o[e],"gltf-material")).userData.gltfIndex=e]=i.uuid;return m}async _importScenes(t,a){var r=a.gltf.scenes;if(void 0===r)return[];let s="";if(t.uuid2recycle)for(const m in t.uuid2recycle){var e=t.uuid2recycle[m];"gltf-scene"===e.importer&&"id"in e&&(s=m)}var i=makeUniqueSubAssetNames(t.basename,r,"scenes",".prefab"),n=new Array(r.length);for(let e=0;e<r.length;e++){r[e];var o=await t.createSubAsset(i[e],"gltf-scene",{id:s});o.userData.gltfIndex=e,(a.gltf.scene||0)===e&&(t.userData.redirect=o.uuid),n[e]=o.uuid}return n}async _saveOriginalAnimations(r,s,e){var t=s.gltf.animations;t&&await Promise.all(t.map(async(e,t)=>{var a=s.createAnimation(t),a=serialize_library_1.serializeForLibrary(a)["data"],t=original_animation_1.getOriginalAnimationLibraryPath(r,t),t=(await r.saveToLibrary(t,a),utils_1.getDependUUIDList(a));r.setData("depends",t)}))}}exports.GltfImporter=GltfImporter;const maxLodLevel=7,defaultLODsOptions={screenRatio:0,faceCount:0};async function deepFindMeshRenderer(e,a,r,s){var t=e.getComponents(cc_1.MeshRenderer);let i=0;if(t&&0<t.length)for(const m of t)if(m.mesh&&m.mesh.uuid){let t=0;var n=await Manager.Utils.queryAssetMeta(m.mesh.uuid),n=(n.userData.lodLevel=r,a.createMesh(n.userData.gltfIndex,s));null!=(n=n.struct.primitives)&&n.forEach(e=>{e&&e.indexView&&(t+=e.indexView.count)}),i+=t/3}if(e.children&&0<e.children.length)for(const l of e.children){var o=await deepFindMeshRenderer(l,a,r,s);return i+o}return i}async function loadLODs(e,t,a){var r=[],s=[];for(const o of t.children){var i=/_LOD(\d+)$/i.exec(o.name);i&&1<i.length&&(i=parseInt(i[1],10))<=maxLodLevel&&(r[i]=r[i]||Object.assign({},defaultLODsOptions),s[i]=(s[i]||0)+await deepFindMeshRenderer(o,a,i,e.generateLightmapUVNode))}if(0<r.length){var n=Math.max(...Object.keys(r).map(e=>+e));let t=.25;for(let e=0;e<n;e++)r[e]||(console.debug("No mesh name are ending with _LOD"+e),r[e]=Object.assign({},defaultLODsOptions)),r[e].screenRatio=t,t/=2,0!==s[0]&&(r[e].faceCount=s[e]/s[0]);r[n].screenRatio=t<.01?t:.01,r[n].faceCount=s[0]?s[n]/s[0]:0}return r}async function generateDefaultLODsOption(){var t=[],a=[.25,.125,.01],r=[1,.25,.1];for(let e=0;e<3;e++)t[e]={screenRatio:a[e],faceCount:r[e]};return t}function makeUniqueSubAssetNames(a,e,r,t){let s=e.map(e=>{let t;return t="scenes"===r?a:"string"==typeof e.name?e.name:(()=>{switch(r){case"animations":return"UnnamedAnimation";case"images":return"UnnamedImage";case"meshes":return"UnnamedMesh";case"materials":return"UnnamedMaterial";case"skeletons":return"UnnamedSkeleton";case"textures":return"UnnamedTexture";default:return"Unnamed"}})()});if(!isDifferWithEachOther(s)){let a="-";for(;;){if(s.every(e=>!e.endsWith(a)))break;a+="-"}s=s.map((e,t)=>e+(""+a)+t)}return s.map(e=>e+t)}function isDifferWithEachOther(e){if(2<=e.length){var t=e.slice().sort();for(let e=0;e<t.length-1;++e)if(t[e]===t[e+1])return!1}return!0}async function migrateImageLocations(e){var t=e.meta.userData,a=[];if(t.imageLocations){var r=t["imageLocations"];for(const i of Object.keys(r)){var s=r[i];s.targetDatabaseUrl&&a.push({name:i,remap:s.targetDatabaseUrl})}delete t.imageLocations}e.meta.userData.imageMetas=a,t.assetFinder&&t.assetFinder.images&&delete t.assetFinder.images}async function migrateImageRemap(e){e=e.meta.userData;if(e.imageMetas)for(const a of e.imageMetas){var t=a["remap"];t&&(t=asset_db_1.queryUUID(t))&&(a.remap=t)}}async function migrateDumpMaterial(e){var t,a,r,s;e.userData.dumpMaterials&&!e.userData.materialDumpDir&&(t=path.join(e.source,`../Materials_${e.basename}.FBX`),a=path.join(e.source,`../Materials_${e.basename}.FBX.meta`),r=path.join(e.source,"../Materials_"+e.basename),s=path.join(e.source,`../Materials_${e.basename}.meta`),fs.existsSync(t))&&!fs.existsSync(r)&&(fs.renameSync(t,r),fs.existsSync(a)&&fs.renameSync(a,s),e._assetDB.refresh(r))}async function migrateFbxConverterSelector(e){".fbx"===e.extname&&(e.userData.legacyFbxImporter=!0)}async function migrateFbxConverterUnitConversion(e){var t;".fbx"!==e.extname||(e=e.userData).legacyFbxImporter||((null!=(t=e.fbx)?t:e.fbx={}).unitConversion="hierarchy-level")}async function migrateFbxConverterPreferLocalTimeSpan(e){var t;".fbx"!==e.extname||(e=e.userData).legacyFbxImporter||((null!=(t=e.fbx)?t:e.fbx={}).preferLocalTimeSpan=!1)}async function migrateSmartMaterialEnabled(e){var t;".fbx"===e.extname&&((null!=(t=(e=e.userData).fbx)?t:e.fbx={}).smartMaterialEnabled=!1)}async function migrateFBXPromoteSingleRootNode(e){var t;".fbx"===e.extname&&null!=(t=(e=e.userData).fbx)&&t.promoteSingleRootNode&&(e.promoteSingleRootNode=e.fbx.promoteSingleRootNode,delete e.fbx.promoteSingleRootNode)}function migrateMeshOptimizerOption(e){e=e.userData;e.meshOptimizer&&(e.meshOptimizer={algorithm:"gltfpack",enable:!0,gltfpackOptions:e.meshOptimizerOptions||{}},delete e.meshOptimizerOptions)}function migrateFbxMatchMeshNames(e){var t;".fbx"===e.extname&&((null!=(t=(e=e.userData).fbx)?t:e.fbx={}).matchMeshNames=!1)}exports.migrateMeshOptimizerOption=migrateMeshOptimizerOption,exports.migrateFbxMatchMeshNames=migrateFbxMatchMeshNames,exports.default=GltfImporter;