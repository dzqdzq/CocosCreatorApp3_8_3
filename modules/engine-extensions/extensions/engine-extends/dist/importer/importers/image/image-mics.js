"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.convertWithCmft=exports.convertHDR=exports.convertHDROrEXR=exports.convertTIFF=exports.convertPSD=exports.convertImageToHDR=exports.convertTGA=void 0;const path_1=require("path"),pngjs_1=require("pngjs"),tga_js_1=__importDefault(require("tga-js")),fs_extra_1=require("fs-extra"),psd_js_1=__importDefault(require("psd.js")),sharp_1=__importDefault(require("sharp"));async function convertTGA(t){var e=new tga_js_1.default,t=(e.load(t),e.getImageData()),e=new pngjs_1.PNG({width:t.width,height:t.height});return e.data=Buffer.from(t.data),savePNGObject(e)}async function convertImageToHDR(t,e,r){r=path_1.join(r,e+".hdr");fs_extra_1.ensureDirSync(path_1.dirname(r));let o=path_1.join(Editor.App.path,"../tools/mali_darwin/convert");"win32"===process.platform&&(o=path_1.join(Editor.App.path,"../tools/mali_win32/convert.exe"));var e=path_1.dirname(o),n=(o="."+path_1.sep+path_1.basename(o),Object.assign({},process.env));return n.PATH=e+":"+n.PATH,await Editor.Utils.Process.quickSpawn(o,[path_1.normalize(t),path_1.normalize(r)],{cwd:e,env:n}),{extName:".hdr",source:r}}async function convertPSD(t){t=new psd_js_1.default(t),t.parse(),t=t.image.toPng();return savePNGObject(t)}async function convertTIFF(t){return new Promise((e,r)=>{sharp_1.default(t).png().toBuffer().then(t=>{e({extName:".png",data:t})}).catch(t=>r(t))})}async function savePNGObject(o){return new Promise((t,e)=>{const r=[];o.on("data",t=>{r.push(t)}),o.on("end",()=>{t({extName:".png",data:Buffer.concat(r)})}),o.on("error",t=>{e(t)}),o.pack()})}async function convertHDROrEXR(e,r,o){console.debug(`Start to conver asset {asset[${r}](${r})}`);var n=path_1.join(o,r),t=(fs_extra_1.ensureDirSync(o),path_1.extname(e));if(".hdr"===t)return convertWithCmft(e,n);if(".exr"===t)try{return await convertWithCmft(e,n,"_withexr")}catch(t){return convertWithCmft((await convertImageToHDR(e,r,o)).source,n)}}async function convertHDR(t,e,r){console.debug(`Start to conver asset {asset[${e}](${e})}`);e=path_1.join(r,e);return fs_extra_1.ensureDirSync(r),convertWithCmft(t,e)}async function convertWithCmft(t,e,r=""){let o=path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64"+r+("win32"===process.platform?".exe":""));return fs_extra_1.existsSync(o)||(o=path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64"+("win32"===process.platform?".exe":""))),await Editor.Utils.Process.quickSpawn(o,["--bypassoutputtype","--output0params","png,rgbm,latlong","--input",t,"--output0",e]),console.debug(`Conver asset${t} -> PNG success.`),{extName:".png",source:e+".png"}}exports.convertTGA=convertTGA,exports.convertImageToHDR=convertImageToHDR,exports.convertPSD=convertPSD,exports.convertTIFF=convertTIFF,exports.convertHDROrEXR=convertHDROrEXR,exports.convertHDR=convertHDR,exports.convertWithCmft=convertWithCmft;