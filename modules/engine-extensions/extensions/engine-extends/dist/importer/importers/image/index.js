"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImageImporter=void 0;const fs_extra_1=require("fs-extra"),erp_texture_cube_1=require("../erp-texture-cube"),image_mics_1=require("./image-mics"),migrations_1=require("./migrations"),sharp_1=__importDefault(require("sharp")),path_1=require("path"),image_base_1=require("./image-base"),utils_1=require("./utils");class ImageImporter extends image_base_1.ImageBaseImporter{get version(){return"1.0.26"}get name(){return"image"}get assetType(){return"cc.ImageAsset"}get migrations(){return migrations_1.migrations}async force(e){return!1}async validate(e){return!await e.isDirectory()}async import(e){let a=e.extname.toLocaleLowerCase(),r=e.source;var t=e.meta.userData;if(".bmp"===a){var i=await image_mics_1.convertHDR(e.source,e.uuid,e.temp);if(i instanceof Error||!i)return console.error("Failed to convert bmp image."),!1;a=i.extName,r=i.source,t.isRGBE=!0,t.fixAlphaTransparencyArtifacts||(t.fixAlphaTransparencyArtifacts=!1)}else if(".znt"===a){i=e.source,i=await image_mics_1.convertHDR(i,e.uuid,e.temp);if(i instanceof Error||!i)return console.error(`Failed to convert asset {asset(${e.uuid})}.`),!1;a=i.extName,r=i.source,t.fixAlphaTransparencyArtifacts=!1,t.isRGBE=!0}else if(".hdr"===a||".exr"===a){i=e.source,i=await image_mics_1.convertHDROrEXR(i,e.uuid,e.temp);if(i instanceof Error||!i)return console.error(`Failed to convert asset {asset(${e.uuid})}.`),!1;a=i.extName,r=i.source,t.fixAlphaTransparencyArtifacts=!1,t.isRGBE=!0;var s=await(await sharp_1.default(r)).metadata(),s=(!t.type&&erp_texture_cube_1.checkSize(s.width,s.height)&&(t.type="texture cube"),path_1.join(i.source.replace(".png","_sign.png"))),s=(fs_extra_1.existsSync(s)&&(t.sign=Editor.UI.File.resolveToUrl(s,"project")),path_1.join(i.source.replace(".png","_alpha.png")));fs_extra_1.existsSync(s)&&(t.alpha=Editor.UI.File.resolveToUrl(s,"project"))}else if(".tga"===a){i=await image_mics_1.convertTGA(await fs_extra_1.readFile(e.source));if(i instanceof Error||!i)return console.error("Failed to convert tga image."),!1;a=i.extName,r=i.data}else if(".psd"===a){s=await image_mics_1.convertPSD(await fs_extra_1.readFile(e.source));a=s.extName,r=s.data}else if(".tif"===a||".tiff"===a){i=await image_mics_1.convertTIFF(e.source);if(i instanceof Error||!i)return console.error(`Failed to convert ${a} image.`),!1;a=i.extName,r=i.data}return void 0===t.fixAlphaTransparencyArtifacts&&(t.fixAlphaTransparencyArtifacts=utils_1.isCapableToFixAlphaTransparencyArtifacts(e,t.type,e.extname)),r=await utils_1.handleImageUserData(e,r,a),await utils_1.saveImageAsset(e,r,a,e.basename),await utils_1.importWithType(e,t.type,e.basename,e.extname),t.sign&&await e.createSubAsset("sign","sign-image",{displayName:"sign"}),t.alpha&&await e.createSubAsset("alpha","alpha-image",{displayName:"alpha"}),!0}}exports.ImageImporter=ImageImporter;