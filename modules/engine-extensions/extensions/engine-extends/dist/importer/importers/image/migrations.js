"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,a){e[a=void 0===a?r:a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.migratePlatformSettings=exports.migrateFixAlphaTransparencyArtifacts=exports.migrations=void 0;const migratesNameToId=__importStar(require("../migrates/name2id")),lodash=require("lodash"),resolveQueue=[];function checkQueue(){return new Promise(e=>{resolveQueue.push(e),1===resolveQueue.length&&(e(),e.hasResolve=!0)})}function migrateStep(){var e=resolveQueue.shift();e&&e(),e&&e.hasResolve&&migrateStep()}function migrateFixAlphaTransparencyArtifacts(e){e.userData.fixAlphaTransparencyArtifacts=!1}async function migratePlatformSettings(e){const r=e.userData.platformSettings;var t;r&&0!==Object.keys(r).length&&(await checkQueue(),t={useCompressTexture:!0,presetId:""},r.default&&1===Object.keys(r).length?["miniGame","web","android","ios","pc"].forEach(e=>{r[e]=r.default}):Object.keys(r).forEach(e=>{var t;"default"!==e&&("default"!==e&&r.default&&(t=JSON.parse(JSON.stringify(r.default)),r[e]=Object.assign(t,r[e])),migrateCompressTextureType(r[e]),"wechat"===e?(r.miniGame=r.wechat,delete r.wechat):"html5"===e&&(r.web=r.html5,delete r.html5))}),delete r.default,0!==Object.keys(r).length&&(t.presetId=await getPresetId(r),delete e.userData.platformSettings,e.userData.compressSettings=t),migrateStep())}function migrateCompressTextureType(t){if(t){const r={pvrtc_4bits:"pvrtc_4bits_rgba",pvrtc_2bits:"pvrtc_2bits_rgba",etc1:"etc1_rgb"};Object.keys(t).forEach(e=>{r[e]&&(t[r[e]]=t[e],delete t[e])})}}async function getPresetId(e){var t="presetId"+Date.now();let r=await Editor.Profile.getProject("builder","textureCompressConfig.userPreset");if(r){for(const a of Object.keys(r))if(lodash.isEqual(r[a].options,e))return a;await Editor.Profile.setProject("builder","textureCompressConfig.userPreset."+t,{name:t,options:e})}else r={[t]:{name:t,options:e}},await Editor.Profile.setProject("builder","textureCompressConfig.userPreset",r);return t}exports.migrations=[{version:"1.0.13",async migrate(t){var r,a,s=Object.keys(t.meta.subMetas);if(1===s.length){let e;switch(t.meta.userData.type){case"raw":break;case"texture":e="texture";break;case"normal map":e="normalMap";break;case"texture cube":e="textureCube";break;case"sprite-frame":e="spriteFrame"}e&&s[0]!==e&&(r=t.meta.subMetas[e]=t.meta.subMetas[s[0]],a=t.subAssets[e]=t.subAssets[s[0]],r.uuid=r.uuid.replace("@"+s[0],"@"+e),a.meta.uuid=a.uuid.replace("@"+s[0],"@"+e),delete t.meta.subMetas[s[0]],delete t.subAssets[s[0]])}}},{version:"1.0.15",migrate:migratesNameToId.migrate},{version:"1.0.21",migrate:migratePlatformSettings},{version:"1.0.23",migrate:migrateFixAlphaTransparencyArtifacts}],exports.migrateFixAlphaTransparencyArtifacts=migrateFixAlphaTransparencyArtifacts,exports.migratePlatformSettings=migratePlatformSettings;