"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.importWithType=exports.handleImageUserData=exports.isCapableToFixAlphaTransparencyArtifacts=exports.saveImageAsset=void 0;const cc_1=require("cc"),fs_extra_1=require("fs-extra"),sharp_1=__importDefault(require("sharp")),utils_1=require("../../utils"),erp_texture_cube_1=require("../erp-texture-cube"),sprite_frame_1=require("../sprite-frame"),texture_1=require("../texture"),bleeding_1=require("../utils/algorithm/bleeding"),RGBChannels=3,RGBAChannels=4;async function saveImageAsset(e,a,t,r){"string"==typeof a?await e.copyToLibrary(t,a):await e.saveToLibrary(t,a);a=new cc_1.ImageAsset,a.name=r,a._setRawAsset(t),r=EditorExtends.serialize(a),await e.saveToLibrary(".json",r),t=utils_1.getDependUUIDList(r);e.setData("depends",t)}function isCapableToFixAlphaTransparencyArtifacts(e,a,t){t=t.toLocaleLowerCase().replace(".",""),e=e.userData;return!(["hdr","exr"].includes(t)||["normal map"].includes(e.type)||e.isRGBE||["normal map","texture cube"].includes(a))}async function handleImageUserData(e,t,a){"string"==typeof t&&(t=await fs_extra_1.readFile(t));e=e.userData;const r=sharp_1.default(t);var s=await r.metadata(),i=(e.hasAlpha=s.hasAlpha,e.type||(e.type="texture"),!!e.flipVertical);if(i&&(t=await r.flip().toBuffer()),!1!==e.fixAlphaTransparencyArtifacts&&s.hasAlpha){var u=await sharp_1.default(t).raw().toBuffer();let a=!1;for(let e=0;e<u.length;e+=RGBAChannels)if(0===u[e+3]){a=!0;break}if(a){var i=Buffer.from(u),p=[-1,0,1,-1,1,-1,0,1],l=[-1,-1,-1,0,0,1,1,1],n=[],d=s.width*RGBAChannels;for(let e=0;e<p.length;e++)n[e]=p[e]*RGBAChannels+l[e]*d;bleeding_1.applyContourBleed(i,u,s.width,new cc_1.Rect(0,0,s.width,s.height),p,l,n),t=await sharp_1.default(i,{raw:{channels:RGBAChannels,height:s.height,width:s.width}}).toFormat("png").toBuffer()}}if(e.flipGreenChannel){const r=await sharp_1.default(t);var{width:i,height:s}=await r.metadata(),o=await r.raw().toBuffer(),c=o.length/i/s;for(let e=1;e<o.length;e=c+e)o[e]=255-o[e];e={raw:{width:i,height:s,channels:c}};t=await sharp_1.default(o,e).toFormat("png").toBuffer()}return t}async function importWithType(e,a,t,r){var s=e.userData;switch(a){case"raw":delete s.redirect;break;case"texture":var i=await e.createSubAsset("texture","texture",{displayName:t});s.redirect=i.uuid,i.assignUserData(texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid,r)),i.userData.imageUuidOrDatabaseUri=e.uuid,i.userData.visible=!1;break;case"normal map":i=await e.createSubAsset("normalMap","texture",{displayName:t});s.redirect=i.uuid,i.assignUserData(texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid));break;case"texture cube":i=await e.createSubAsset("textureCube","erp-texture-cube",{displayName:t});s.redirect=i.uuid,i.assignUserData(erp_texture_cube_1.makeDefaultTextureCubeAssetUserData()),i.userData.imageDatabaseUri=e.uuid,i.userData.isRGBE=!!s.isRGBE;break;case"sprite-frame":var i=await e.createSubAsset("texture","texture",{displayName:t}),u=(i.userData.wrapModeS=i.userData.wrapModeS||"clamp-to-edge",i.userData.wrapModeT=i.userData.wrapModeT||"clamp-to-edge",s.redirect=i.uuid,i.userData.imageUuidOrDatabaseUri=e.uuid,i.userData.isUuid=!0,i.userData.visible=!1,await e.createSubAsset("spriteFrame","sprite-frame",{displayName:t}));s.redirect=u.uuid,u.assignUserData(sprite_frame_1.makeDefaultSpriteFrameAssetUserDataFromImageUuid(i.uuid,"")),u.userData.imageUuidOrDatabaseUri=i.uuid}}exports.saveImageAsset=saveImageAsset,exports.isCapableToFixAlphaTransparencyArtifacts=isCapableToFixAlphaTransparencyArtifacts,exports.handleImageUserData=handleImageUserData,exports.importWithType=importWithType;