"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BitmapImporter=void 0;const asset_db_1=require("@editor/asset-db"),cc_1=require("cc"),fs_extra_1=require("fs-extra"),path_1=require("path"),image_utils_1=require("./utils/image-utils"),utils_1=require("../utils"),fntParser=require("../../../static/utils/fnt-parser");function getRealFntTexturePath(e,t){e=path_1.basename(e),t=path_1.join(path_1.dirname(t.source),e);return fs_extra_1.existsSync(t)||console.warn("Parse Error: Unable to find file Texture, the path: "+t),t}const UserFlags={DoNotNotify:!1};class BitmapImporter extends asset_db_1.Importer{get version(){return"1.0.6"}get name(){return"bitmap-font"}get assetType(){return"cc.BitmapFont"}async validate(e){return!0}async import(t){var e=await fs_extra_1.readFile(t.source,"utf8");let r;try{r=fntParser.parseFnt(e)}catch(e){throw console.error(e),new Error(`BitmapFont import failed: ${t.uuid} file parsing failed`)}if(!(t.userData._fntConfig=r).fontSize)return console.error(`BitmapFont import failed: ${t.uuid} file parsing failed, There is no 'fontSize' in the configuration.`),!1;t.userData.fontSize=r.fontSize;var e=getRealFntTexturePath(r.atlasName,t),a=(t.depend(e),this.assetDB.pathToUuid(e));if(!a)return!1;if(t.userData.textureUuid=this.assetDB.pathToUuid(e),t.userData.textureUuid){a=asset_db_1.queryAsset(t.userData.textureUuid);if(!a)return!1;image_utils_1.changeImageDefaultType(a,"sprite-frame");e=this.createBitmapFnt(t),a=(e.spriteFrame=EditorExtends.serialize.asAsset(a.uuid+"@f9941",cc_1.SpriteFrame),EditorExtends.serialize(e)),e=(await t.saveToLibrary(".json",a),utils_1.getDependUUIDList(a));t.setData("depends",e)}return!0}createBitmapFnt(e){var t=new cc.BitmapFont;return t.name=path_1.basename(e.source,e.extname),t.name=e.basename||"",t.fontSize=e.userData.fontSize,t.fntConfig=e.userData._fntConfig,t}}exports.BitmapImporter=BitmapImporter;