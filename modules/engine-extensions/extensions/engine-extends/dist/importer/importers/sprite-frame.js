"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,i){e[i=void 0===i?r:i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SpriteFrameImporter=exports.makeDefaultSpriteFrameAssetUserDataFromImageUuid=exports.makeDefaultSpriteFrameAssetUserData=void 0;const asset_db_1=require("@editor/asset-db"),utils_1=require("../utils"),texture_base_1=require("./texture-base"),cc=__importStar(require("cc")),utils_2=require("../utils");try{require("sharp")}catch(e){console.error(e),console.error(Editor.I18n.t("engine-extends.importers.sharpError"))}const Sharp=require("sharp");function makeDefaultSpriteFrameAssetUserData(){return texture_base_1.makeDefaultSpriteFrameBaseAssetUserData()}function makeDefaultSpriteFrameAssetUserDataFromImageUuid(e,t){return Object.assign(texture_base_1.makeDefaultSpriteFrameBaseAssetUserData(),{isUuid:!0,imageUuidOrDatabaseUri:e,atlasUuid:t})}Sharp.cache(!1),exports.makeDefaultSpriteFrameAssetUserData=makeDefaultSpriteFrameAssetUserData,exports.makeDefaultSpriteFrameAssetUserDataFromImageUuid=makeDefaultSpriteFrameAssetUserDataFromImageUuid;class SpriteFrameImporter extends asset_db_1.Importer{get version(){return"1.0.12"}get name(){return"sprite-frame"}get assetType(){return"cc.SpriteFrame"}async import(t){if(!t.parent)return!1;if("image"===t.parent.meta.importer){var r=t.userData;let e;e=[".tga",".hdr",".bmp",".exr",".znt",".psd"].includes(t.parent.extname.toLowerCase())?t.parent.library+".png":t.parent.source;var i=await Sharp(e).raw().toBuffer({resolveWithObject:!0});if(!i)return!1;void 0===r.trimThreshold&&(r.trimThreshold=1),r.rotated=!!r.rotated,r.packable=void 0===r.packable||r.packable,r.rawHeight=i.info.height,r.rawWidth=i.info.width,"auto"===r.trimType?4!==i.info.channels?(r.width=i.info.width,r.height=i.info.height,r.trimX=0,r.trimY=0):(a=utils_1.getTrimRect(Buffer.from(i.data),r.rawWidth,r.rawHeight,r.trimThreshold),r.width=Math.max(a[2],1),r.height=Math.max(a[3],1),r.trimX=utils_1.clamp(a[0],0,r.rawWidth-r.width),r.trimY=utils_1.clamp(a[1],0,r.rawHeight-r.height)):"none"===r.trimType?(r.trimX=0,r.trimY=0,r.width=i.info.width,r.height=i.info.height):(r.trimX=utils_1.clamp(r.trimX,0,r.rawWidth-1),r.trimY=utils_1.clamp(r.trimY,0,r.rawHeight-1),r.width=utils_1.clamp(-1===r.width?r.rawWidth:r.width,1,r.rawWidth-r.trimX),r.height=utils_1.clamp(-1===r.height?r.rawHeight:r.height,1,r.rawHeight-r.trimY)),r.offsetX=r.trimX+r.width/2-r.rawWidth/2,r.offsetY=-(r.trimY+r.height/2-r.rawHeight/2),r.borderLeft=utils_1.clamp(r.borderLeft,0,r.width),r.borderRight=utils_1.clamp(r.borderRight,0,r.width-r.borderLeft),r.borderTop=utils_1.clamp(r.borderTop,0,r.height),r.borderBottom=utils_1.clamp(r.borderBottom,0,r.height-r.borderTop),this.initVerticesData(r)}var a=this.createSpriteFrame(t),i=(t.parent instanceof asset_db_1.Asset&&(a.name=a.name||t.parent.basename||""),this.getTexture(t,a),EditorExtends.serialize(a)),r=(await t.saveToLibrary(".json",i),utils_2.getDependUUIDList(JSON.parse(i)));return t.setData("depends",r),!0}createSpriteFrame(e){var t=e.userData,r=new cc.SpriteFrame;return r.name=e.displayName||e._name,r.atlasUuid=t.atlasUuid,r._rect=cc.rect(t.trimX,t.trimY,t.width,t.height),r._originalSize=cc.size(t.rawWidth,t.rawHeight),r._offset=cc.v2(t.offsetX,t.offsetY),r._capInsets=[t.borderLeft,t.borderTop,t.borderRight,t.borderBottom],r._rotated=t.rotated,r._packable=t.packable,r._pixelsToUnit=t.pixelsToUnit,r._pivot=cc.v2(t.pivotX,t.pivotY),r._meshType=t.meshType,this.initVertices(r,t),r}getTexture(t,r){var t=t.userData,i=t.imageUuidOrDatabaseUri;if(i){let e=null;t.isUuid?e=i:(e=asset_db_1.queryUUID(i))||console.warn(`Cannot find image ${asset_db_1.queryPath(i)||""}.`),null!==e&&(r._texture=EditorExtends.serialize.asAsset(e,cc.Texture2D))}}initVerticesData(e){void 0===e.vertices&&(e.vertices={rawPosition:[],indexes:[],uv:[],nuv:[],minPos:[],maxPos:[]});var t,r,i,a,s,o,n,m,u,h=e.vertices;h.rawPosition.length=0,e.meshType!==cc.SpriteFrame.MeshType.POLYGON&&(t=e.width,r=e.height,n=e.rawWidth,u=e.rawHeight,s=e.trimX,e=u-e.trimY-r,o=0===n?0:s/n,n=0===n?1:(s+t)/n,m=0===u?1:(e+r)/u,u=0===u?0:e/u,h.rawPosition=[-(i=t/2),-(a=r/2),0,i,-a,0,-i,a,0,i,a,0],h.uv=[s,e+r,s+t,e+r,s,e,s+t,e],h.nuv=[o,u,n,u,o,m,n,m],h.indexes=[0,1,2,2,1,3],h.minPos=[-i,-a,0],h.maxPos=[i,a,0])}initVertices(e,t){var t=t.vertices,r=(e.vertices={rawPosition:[],positions:[],indexes:t.indexes,uv:t.uv,nuv:t.nuv,minPos:cc.v3(t.minPos[0],t.minPos[1],t.minPos[2]),maxPos:cc.v3(t.maxPos[0],t.maxPos[1],t.maxPos[2])},e.vertices),i=t.rawPosition,a=cc.v3();for(let e=0;e<i.length;e+=3)a.set(i[e],i[e+1],i[e+2]),r.rawPosition.push(a.clone())}}exports.SpriteFrameImporter=SpriteFrameImporter;