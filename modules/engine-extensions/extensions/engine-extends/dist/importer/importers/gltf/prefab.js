"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){e[n=void 0===n?r:n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfPrefabImporter=void 0;const asset_db_1=require("@editor/asset-db"),cc=__importStar(require("cc")),path_1=__importDefault(require("path")),asset_finder_1=require("./asset-finder"),load_asset_sync_1=require("./load-asset-sync"),reader_manager_1=require("./reader-manager"),uuidV5=require("uuid")["v5"],utils_1=require("../../utils"),nodePathMap=new Map,GLTF_PREFAB_NAMESPACE="8fa06a75-f07a-44d4-82cf-d08c3c986599";class GltfPrefabImporter extends asset_db_1.Importer{get version(){return"1.0.14"}get name(){return"gltf-scene"}get assetType(){return"cc.Prefab"}async import(e){var r;if(!e.parent)return!1;var t=await reader_manager_1.glTfReaderManager.getOrCreate(e.parent),n=e.parent.userData,a=new asset_finder_1.DefaultGltfAssetFinder(n.assetFinder);const o=t.createScene(e.userData.gltfIndex,a);var i=[];for(const D of Object.keys(e.parent.subAssets)){var s=e.parent.subAssets[D];"gltf-animation"===s.meta.importer&&i.push(s.uuid)}var d=null==(d=n.mountAllAnimationsOnPrefab)||d;let l=null;if(o.getComponentInChildren(cc.SkinnedMeshRenderer)?(l=o.addComponent(cc.SkeletalAnimation))._sockets=t.createSockets(o):0!==i.length&&(l=o.addComponent(cc.Animation)),d&&l){var d=i.map(e=>load_asset_sync_1.loadAssetSync(e,cc.AnimationClip)||null);for(const P of l._clips=d)if(P){l._defaultClip=P;break}}if(n.lods&&!n.lods.hasBuiltinLOD&&n.lods.enable){var u=e.parent.subAssets;const O={},M={};for(const A in u){var c=u[A];"gltf-mesh"===c.meta.importer&&(c.userData.lodOptions?O[c.uuid]=c.userData:M[c.uuid]=c.userData)}const I=new Array(M.length);o.children.forEach(e=>{var t=e.getComponentsInChildren(cc.MeshRenderer);for(const r in M)t.forEach(e=>{var t;null!=(t=null==e?void 0:e.mesh)&&t.uuid&&r===e.mesh.uuid&&(e.node.name=e.node.name+"_LOD0",I[M[r].gltfIndex]=e.node)})});for(const C in O){var f,p,m,_=(null==(_=null==(_=n.assetFinder)?void 0:_.meshes)?void 0:_.indexOf(C))||-1;-1!==_&&(_=a.find("meshes",_,cc.Mesh))&&(m=O[C],m=(f=I[m.gltfIndex]).name.replace(/(_LOD0)+$/,"_LOD"+m.lodLevel),(p=cc.instantiate(f)).name=m,(m=p.getComponent(cc.MeshRenderer))&&(m.mesh=_),f.parent.addChild(p))}}const h=[];let g=o.getComponent(cc.LODGroup);if(o.children.forEach(e=>{var t=/_LOD(\d+)$/i.exec(e.name);if(t&&1<t.length){if(!g)try{g=o.addComponent(cc.LODGroup)}catch(e){console.error("Add LODGroup component failed!")}t=parseInt(t[1],10);let r=null===g||void 0===g?void 0:g.LODs[t];(r=void 0!==r?r:h[t])||(r=new cc.LOD,h[t]=r);const n=e=>{var t=e.getComponents(cc.MeshRenderer);t&&0<t.length&&t.forEach(e=>{null!==r&&void 0!==r&&r.insertRenderer(-1,e)}),e.children&&0<e.children.length&&e.children.forEach(e=>{n(e)})};n(e)}}),g){let t=.25;var v=h.length;for(let e=0;e<v-1;e++){var b=h[e];t=(null==(r=null==(r=n.lods)?void 0:r.options[e])?void 0:r.screenRatio)||t,g.insertLOD(e,t,b),t/=2}null!=(d=null==(d=n.lods)?void 0:d.options[v-1])&&d.screenRatio?g.insertLOD(v-1,n.lods.options[v-1].screenRatio,h[v-1]):t<.01?g.insertLOD(v-1,t,h[v-1]):g.insertLOD(v-1,.01,h[v-1])}1===t.gltf.scenes.length&&(d=e.parent.basename,o.name=path_1.default.basename(d,path_1.default.extname(d)));t=generatePrefab(o),d=EditorExtends.serialize(t),await e.saveToLibrary(".json",d),t=utils_1.getDependUUIDList(d);return e.setData("depends",t),nodePathMap.clear(),!0}}function getCompressedUuid(e){e=uuidV5(e,GLTF_PREFAB_NAMESPACE);return EditorExtends.UuidUtils.compressUuid(e,!0)}function getNodePath(e){if(nodePathMap.has(e))return nodePathMap.get(e);var t,r=[];let n=e;for(;n;){var a=n.getSiblingIndex();r.push(n.name+a),n=n.parent}return t=r.reverse().join("/"),nodePathMap.set(e,t),t}function nodeFileIdGenerator(e){return getCompressedUuid(getNodePath(e))}function compFileIdGenerator(e,t){return getCompressedUuid(getNodePath(e.node)+"/comp"+t)}function getDumpableNode(e,t){return nodePathMap.clear(),EditorExtends.PrefabUtils.addPrefabInfo(e,e,t,{nodeFileIdGenerator:nodeFileIdGenerator,compFileIdGenerator:compFileIdGenerator}),EditorExtends.PrefabUtils.checkAndStripNode(e),e}function generatePrefab(e){var t=new cc.Prefab,e=getDumpableNode(e,t);return t.data=e,t}exports.GltfPrefabImporter=GltfPrefabImporter;