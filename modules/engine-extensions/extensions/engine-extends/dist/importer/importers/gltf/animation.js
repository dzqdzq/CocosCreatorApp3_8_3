"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,i){e[i=void 0===i?a:i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfAnimationImporter=void 0;const asset_db_1=require("@editor/asset-db"),cc=__importStar(require("cc")),embedded_player_1=require("cc/editor/embedded-player"),exotic_animation_1=require("cc/editor/exotic-animation"),url_1=require("url"),serialize_library_1=require("../utils/serialize-library"),split_animation_1=require("../utils/split-animation"),load_asset_sync_1=require("./load-asset-sync"),original_animation_1=require("./original-animation"),utils_1=require("../../utils"),assert_1=__importDefault(require("assert"));class GltfAnimationImporter extends asset_db_1.Importer{get version(){return"1.0.17"}get name(){return"gltf-animation"}get assetType(){return"cc.AnimationClip"}get instantiation(){return".animation"}get migrations(){return[{version:"1.0.16",migrate:migrateEvents_3_3_0}]}async import(e){if(!e.parent)return!1;var t=e.userData,a=(null!=t.events||(t.events=[]),e.parent.getFilePath(original_animation_1.getOriginalAnimationLibraryPath(e.parent,t.gltfIndex)));const r=url_1.pathToFileURL(a).href;var a=await new Promise((a,i)=>{cc.assetManager.loadAny({url:r},{preset:"remote"},null,(e,t)=>{e?i(e):a(t)})});let i=t.span;var n=(i=i&&0===i.from&&i.to===e.parent.userData.duration?void 0:i)?split_animation_1.splitAnimation(a,i.from,i.to):a;if(n.name=e._name,n.name.endsWith(".animation")&&(n.name=n.name.substr(0,n.name.length-".animation".length)),n.events=t.events.map(e=>({frame:e.frame,func:e.func,params:e.params.slice()})),n.wrapMode=null!=(a=t.wrapMode)?a:cc.AnimationClip.WrapMode.Loop,void 0!==t.speed&&(n.speed=t.speed),void 0!==t.sample&&(n.sample=t.sample),void 0!==t.editorExtras&&(n[cc.editorExtrasTag]=JSON.parse(JSON.stringify(t.editorExtras))),t.embeddedPlayers){var l,o,s,d,p,a=t["embeddedPlayers"];for({begin:l,end:o,reconciledSpeed:s,editorExtras:d,playable:p}of a){var u,m,_=new embedded_player_1.EmbeddedPlayer;void 0!==d&&(_[cc.editorExtrasTag]=JSON.parse(JSON.stringify(d))),_.begin=l,_.end=o,_.reconciledSpeed=s,"animation-clip"===p.type?((u=new embedded_player_1.EmbeddedAnimationClipPlayable).path=p.path,p.clip&&(u.clip=null!=(m=load_asset_sync_1.loadAssetSync(p.clip,cc.AnimationClip))?m:null),_.playable=u):"particle-system"===p.type&&((m=new embedded_player_1.EmbeddedParticleSystemPlayable).path=p.path,_.playable=m),n[embedded_player_1.addEmbeddedPlayerTag](_)}}const c=n[exotic_animation_1.additiveSettingsTag];c.enabled=!1,c.refClip=null;a=[];if(void 0!==t.additive){const c=n[exotic_animation_1.additiveSettingsTag];t.additive.enabled&&(c.enabled=!0,t.additive.refClip)&&(a.push(t.additive.refClip),c.refClip=null!=(y=load_asset_sync_1.loadAssetSync(t.additive.refClip,cc.AnimationClip))?y:null)}if(void 0!==t.auxiliaryCurves)for(var[f,{curve:v}]of Object.entries(t.auxiliaryCurves)){v=cc.deserialize(v,void 0,void 0),f=(assert_1.default(v instanceof cc.RealCurve),n.addAuxiliaryCurve_experimental(f));f.preExtrapolation=v.preExtrapolation,f.postExtrapolation=v.postExtrapolation,f.assignSorted(v.keyframes())}n.hash;var{extension:y,data:t}=serialize_library_1.serializeForLibrary(n),y=(await e.saveToLibrary(y,t),utils_1.getDependUUIDList(t));return e.setData("depends",Array.from(new Set([...y,...a]))),!0}}function migrateEvents_3_3_0(e){var t=e.meta.userData.events;t&&(t=t.map(e=>({frame:e.frame,func:e.functionName,params:e.parameters.slice()})),e.meta.userData.events=t)}exports.GltfAnimationImporter=GltfAnimationImporter;