"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,a){e[a=void 0===a?r:a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfImageImporter=void 0;const DataURI=__importStar(require("@cocos/data-uri")),asset_db_1=require("@editor/asset-db"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),urijs_1=__importDefault(require("urijs")),url_1=__importDefault(require("url")),image_mics_1=require("../image/image-mics"),uri_utils_1=require("../utils/uri-utils"),reader_manager_1=require("./reader-manager"),utils_1=require("../../utils"),match_image_type_pattern_1=require("../utils/match-image-type-pattern"),image_mime_type_to_ext_1=require("../utils/image-mime-type-to-ext"),base64_1=require("../utils/base64"),cc_1=require("cc"),utils_2=require("../../utils"),utils_3=require("../image/utils");class GltfImageImporter extends asset_db_1.Importer{get version(){return"1.0.3"}get name(){return"gltf-embeded-image"}get assetType(){return"cc.ImageAsset"}async import(i){if(!i.parent)return!1;var r=i.userData.gltfIndex,a=await reader_manager_1.glTfReaderManager.getOrCreate(i.parent);const s=a.gltf.images[r];let u;var r=async t=>{try{var e=url_1.default.fileURLToPath(t),r=await fs_extra_1.default.readFile(e),a=match_image_type_pattern_1.matchImageTypePattern(r);u={data:r,mimeType:a,extName:path_1.default.extname(e)}}catch(e){console.error(utils_1.i18nTranslate("asset-db.importers.glTF.failed_to_load_image",{url:t,reason:e}),utils_1.linkToAssetTarget(i.uuid))}},o=i.getSwapSpace().resolved;if(o)await r(url_1.default.pathToFileURL(o).href);else if(void 0!==s.bufferView)u={data:a.readImageInBufferView(a.gltf.bufferViews[s.bufferView])};else if(void 0!==s.uri){const t=a.path;o=e=>{console.error(`The uri "${s.uri}" provided by model file${t} is not correct: `+e)};if(s.uri.startsWith("data:"))try{var l=DataURI.parse(s.uri);if(!l)throw new Error(`Unable to parse data uri "${s.uri}"`);u=resolveImageDataURI(l)}catch(e){o(e)}else{var l=a.path;let t;try{var _=url_1.default.pathToFileURL(l).toString();let e=new urijs_1.default(s.uri);e=e.absoluteTo(_),uri_utils_1.convertsEncodedSeparatorsInURI(e),t=e.toString()}catch(e){o(e)}t&&(t.startsWith("file://")?await r(t):console.error(utils_1.i18nTranslate("asset-db.importers.glTF.image_uri_should_be_file_url"),utils_1.linkToAssetTarget(i.uuid)))}}a=new cc_1.ImageAsset;if(u){let e;_=null!=(l=s.mimeType)?l:u.mimeType;if(!(e=(e=_?image_mime_type_to_ext_1.imageMimeTypeToExt(_):e)||u.extName))throw new Error("Unknown image type");let t=u.data;if(".tga"===e.toLowerCase()){o=await image_mics_1.convertTGA(t);if(o instanceof Error||!o)return console.error(utils_1.i18nTranslate("asset-db.importers.glTF.failed_to_convert_tga"),utils_1.linkToAssetTarget(i.uuid)),!1;e=o.extName,t=o.data}else".psd"===e.toLowerCase()&&(r=await image_mics_1.convertPSD(t),{extName:e,data:t}=r);a._setRawAsset(e),i.userData.fixAlphaTransparencyArtifacts=!0,t=await utils_3.handleImageUserData(i,t,e),await i.saveToLibrary(e,t)}l=EditorExtends.serialize(a),await i.saveToLibrary(".json",l),_=utils_2.getDependUUIDList(l);return i.setData("depends",_),!0}}function resolveImageDataURI(e){var t;if(e.base64&&e.mediaType&&"image"===e.mediaType.type)return t=base64_1.decodeBase64ToArrayBuffer(e.data),{data:Buffer.from(t),mimeType:e.mediaType.value};throw new Error(`Cannot understand data uri(base64: ${e.base64}, mediaType: ${e.mediaType}) for image.`)}exports.GltfImageImporter=GltfImageImporter;