"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MaterialImporter=void 0;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),migrates_1=require("./scene/migrates"),material_upgrader_1=require("./utils/material-upgrader"),utils_1=require("../utils");class MaterialImporter extends asset_db_1.Importer{get version(){return"1.0.20"}get name(){return"material"}get assetType(){return"cc.Material"}async validate(e){try{return"cc.Material"===fs_extra_1.readJSONSync(e.source).__type__}catch(e){return!1}}get migrations(){return migrations}get migrationHook(){return migrates_1.migrationHook}async import(e){try{var a=fs_extra_1.readJSONSync(e.source),r=a._effectAsset&&a._effectAsset.__uuid__,o=(e.depend(r),await material_upgrader_1.upgradeProperties(a,e)&&fs_extra_1.writeJSONSync(e.source,a,{spaces:2}),a._name=e.basename||"",JSON.stringify(a,void 0,2)),t=(await e.saveToLibrary(".json",o),utils_1.getDependUUIDList(o));return e.setData("depends",t),!0}catch(e){return console.error(e),!1}}}exports.MaterialImporter=MaterialImporter;const migrations=[{version:"1.0.5",migrate:migrates_1.migrateImageUuid},{version:"1.0.6",migrate:migrates_1.migrateAnimationName},{version:"1.0.7",async migrate(e){await migrates_1.migrateNameToId(e,!0)}},{version:"1.0.9",migrate:migrateStandardEffect},{version:"1.0.10",migrate:migrateLinearColor},{version:"1.0.11",migrate:migrateBlendColor},{version:"1.0.12",migrate:migrateLinearColorFixUnlitShader},{version:"1.0.13",migrate:migrateNormalStrength},{version:"1.0.14",migrate:migrateOcclusion},{version:"1.0.15",migrate:migrateMacroUseBatching},{version:"1.0.16",migrate:migrateRoughnessAndMetallic},{version:"1.0.17",migrate:migrateEmissiveColor},{version:"1.0.19",migrate:migrateAlbedoScaleType},{version:"1.0.20",migrate:migrateEmissiveScaleType}],componentMap={r:"x",g:"y",b:"z",a:"w"};async function migrateStandardEffect(r){r=r.getSwapSpace().json||await fs_extra_1.readJSON(r.source);if("1baf0fc9-befa-459c-8bdd-af1a450a0319"===r._effectAsset.__uuid__){let e=r._defines[0],a=((e=e||(r._defines[0]={})).OCCLUSION_CHANNEL||(e.OCCLUSION_CHANNEL="b"),e.ROUGHNESS_CHANNEL||(e.ROUGHNESS_CHANNEL="r"),e.METALLIC_CHANNEL||(e.METALLIC_CHANNEL="g"),r._props[0]);(a=a||(r._props[0]={})).occlusion=(a.pbrParams&&a.pbrParams[componentMap[e.OCCLUSION_CHANNEL]]||1)*(a.pbrScale&&a.pbrScale[componentMap[e.OCCLUSION_CHANNEL]]||1),a.roughness=(a.pbrParams&&a.pbrParams[componentMap[e.ROUGHNESS_CHANNEL]]||1)*(a.pbrScale&&a.pbrScale[componentMap[e.ROUGHNESS_CHANNEL]]||.8),a.metallic=(a.pbrParams&&a.pbrParams[componentMap[e.METALLIC_CHANNEL]]||1)*(a.pbrScale&&a.pbrScale[componentMap[e.METALLIC_CHANNEL]]||.6),e.USE_PBR_MAP?(a.occlusion=a.pbrScale&&a.pbrScale[componentMap[e.OCCLUSION_CHANNEL]],"number"!=typeof a.occlusion&&(a.occlusion=1),a.roughness=a.pbrScale&&a.pbrScale[componentMap[e.ROUGHNESS_CHANNEL]],"number"!=typeof a.roughness&&(a.roughness=1),a.metallic=a.pbrScale&&a.pbrScale[componentMap[e.METALLIC_CHANNEL]],"number"!=typeof a.metallic&&(a.metallic=1)):e.USE_METALLIC_ROUGHNESS_MAP?(a.roughness=a.pbrScale&&a.pbrScale[componentMap[e.ROUGHNESS_CHANNEL]],"number"!=typeof a.roughness&&(a.roughness=1),a.metallic=a.pbrScale&&a.pbrScale[componentMap[e.METALLIC_CHANNEL]],"number"!=typeof a.metallic&&(a.metallic=1)):e.USE_OCCLUSION_MAP&&(a.occlusion=a.pbrScale&&a.pbrScale[componentMap[e.OCCLUSION_CHANNEL]],"number"!=typeof a.occlusion)&&(a.occlusion=1)}}async function migrateLinearColor(a){var a=a.getSwapSpace().json||await fs_extra_1.readJSON(a.source),e="1baf0fc9-befa-459c-8bdd-af1a450a0319"===a._effectAsset.__uuid__,r="a7612b54-35e3-4238-a1a9-4a7b54635839"===a._effectAsset.__uuid__,o="a3cd009f-0ab0-420d-9278-b9fdab939bbc"===a._effectAsset.__uuid__,t="99498f84-efe6-43a6-a9a7-e6e93eb845c1"===a._effectAsset.__uuid__;if(e||r||t){let e=r?a._props[1]:a._props[0];(e=e||(a._props[0]={})).mainColor&&(e.mainColor.r=Math.floor(255*Math.sqrt(e.mainColor.r/255)),e.mainColor.g=Math.floor(255*Math.sqrt(e.mainColor.g/255)),e.mainColor.b=Math.floor(255*Math.sqrt(e.mainColor.b/255))),e.emissive&&(e.emissive.r=Math.floor(255*Math.sqrt(e.emissive.r/255)),e.emissive.g=Math.floor(255*Math.sqrt(e.emissive.g/255)),e.emissive.b=Math.floor(255*Math.sqrt(e.emissive.b/255))),r&&(e.shadeColor1&&(e.shadeColor1.r=Math.floor(255*Math.sqrt(e.shadeColor1.r/255)),e.shadeColor1.g=Math.floor(255*Math.sqrt(e.shadeColor1.g/255)),e.shadeColor1.b=Math.floor(255*Math.sqrt(e.shadeColor1.b/255))),e.shadeColor2&&(e.shadeColor2.r=Math.floor(255*Math.sqrt(e.shadeColor2.r/255)),e.shadeColor2.g=Math.floor(255*Math.sqrt(e.shadeColor2.g/255)),e.shadeColor2.b=Math.floor(255*Math.sqrt(e.shadeColor2.b/255))),e.specular)&&(e.specular.r=Math.floor(255*Math.sqrt(e.specular.r/255)),e.specular.g=Math.floor(255*Math.sqrt(e.specular.g/255)),e.specular.b=Math.floor(255*Math.sqrt(e.specular.b/255)))}if(o){let e=a._props[0];(e=e||(a._props[0]={})).mainColor&&(e.mainColor.r=Math.floor(255*Math.sqrt(e.mainColor.r/255)),e.mainColor.g=Math.floor(255*Math.sqrt(e.mainColor.g/255)),e.mainColor.b=Math.floor(255*Math.sqrt(e.mainColor.b/255)))}}async function migrateLinearColorFixUnlitShader(a){a=a.getSwapSpace().json||await fs_extra_1.readJSON(a.source);if("a3cd009f-0ab0-420d-9278-b9fdab939bbc"===a._effectAsset.__uuid__){let e=a._props[0];(e=e||(a._props[0]={})).mainColor&&(e.mainColor.r=Math.floor(e.mainColor.r*e.mainColor.r/65535*255),e.mainColor.g=Math.floor(e.mainColor.g*e.mainColor.g/65535*255),e.mainColor.b=Math.floor(e.mainColor.b*e.mainColor.b/65535*255))}}async function migrateBlendColor(e){e=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);e._states&&Array.isArray(e._states)&&e._states.forEach(e=>{var a,e=e.blendState;e&&e.blendColor&&(a=e.blendColor,Array.isArray(a))&&(e.blendColor={__type__:"cc.Color",r:null!=(e=a[0])?e:0,g:null!=(e=a[1])?e:0,b:null!=(e=a[2])?e:0,a:null!=(e=a[3])?e:0})})}async function migrateNormalStrength(a){var a=a.getSwapSpace().json||await fs_extra_1.readJSON(a.source),e="1baf0fc9-befa-459c-8bdd-af1a450a0319"===a._effectAsset.__uuid__,r="a7612b54-35e3-4238-a1a9-4a7b54635839"===a._effectAsset.__uuid__;if(e||r){let e=r?a._props[1]:a._props[0];void 0!==(e=e||(a._props[0]={})).normalStrenth&&(e.normalStrength=e.normalStrenth)}}async function migrateOcclusion(e){e=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);let a=e._props[0];void 0!==(a=a||(e._props[0]={})).occlusion&&(a.occlusion=1-a.occlusion)}async function migrateMacroUseBatching(e){e=(e.getSwapSpace().json||await fs_extra_1.readJSON(e.source))._defines[0];e&&e.USE_BATCHING&&(e.USE_BATCHING=void 0)}async function migrateRoughnessAndMetallic(a){var a=a.getSwapSpace().json||await fs_extra_1.readJSON(a.source),e="1baf0fc9-befa-459c-8bdd-af1a450a0319"===a._effectAsset.__uuid__,r="c8f66d17-351a-48da-a12c-0212d28575c4"===a._effectAsset.__uuid__;if(e||r){let e=a._props[0];void 0===(e=e||(a._props[0]={})).roughness&&(e.roughness=.8),void 0===e.metallic&&(e.metallic=.6)}}async function migrateEmissiveColor(a){var a=a.getSwapSpace().json||await fs_extra_1.readJSON(a.source),e="1baf0fc9-befa-459c-8bdd-af1a450a0319"===a._effectAsset.__uuid__,r="c8f66d17-351a-48da-a12c-0212d28575c4"===a._effectAsset.__uuid__;if(e||r){let e=a._props[0];(e=e||(a._props[0]={})).emissiveMap&&e.emissive&&(e.emissiveScale||(e.emissiveScale={__type__:"cc.Vec3",x:1,y:1,z:1}),e.emissiveScale.x*=e.emissive.r/255,e.emissiveScale.y*=e.emissive.g/255,e.emissiveScale.z*=e.emissive.b/255)}}async function migrateAlbedoScaleType(e){var a=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(let e=0;e<a._props.length;e++){var r=a._props[e].albedoScale;r&&"cc.Vec4"===r.__type__&&(delete r.w,r.__type__="cc.Vec3")}}async function migrateEmissiveScaleType(e){var a=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source),e="1baf0fc9-befa-459c-8bdd-af1a450a0319"===a._effectAsset.__uuid__,r="c8f66d17-351a-48da-a12c-0212d28575c4"===a._effectAsset.__uuid__;if(e||r)for(let e=0;e<a._props.length;e++){var o=a._props[e].emissiveScale;o&&"cc.Vec4"===o.__type__&&(delete o.w,o.__type__="cc.Vec3")}}